<!DOCTYPE html>
  <html lang="vi">
  <head>
    <meta charset="UTF-8">
    <title>C·ªïng T√°c V·ª• DQA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
      // ƒê·∫£m b·∫£o Tailwind ƒë√£ load tr∆∞·ªõc khi config
      if (typeof tailwind !== 'undefined') {
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                "primary": "#4A90E2",
                "accent": "#9013FE",
                "background-light": "#f7f8fc",
                "surface-light": "#ffffff",
                "card-light": "#ffffff",
                "text-light-primary": "#111827",
                "text-light-secondary": "#6b7280",
                "border-light": "#e5e7eb",
                "danger": "#ef4444",
                'primary-blue': '#5aa9ff',
                'sidebar': '#f0f7ff',
                'sidebar-hover': '#e0f0ff',
                'muted': '#f7f8fc'
              },
              fontFamily: {
                "display": ["Inter", "sans-serif"]
              },
              borderRadius: {
                "DEFAULT": "0.75rem",
                "lg": "1rem",
                "xl": "1.5rem",
                "full": "9999px"
              },
              boxShadow: {
                'soft': '0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05)',
              }
            },
          },
        };
      } else {
        // N·∫øu Tailwind ch∆∞a load, th·ª≠ l·∫°i sau khi DOM ready
        document.addEventListener('DOMContentLoaded', function() {
          if (typeof tailwind !== 'undefined') {
            tailwind.config = {
              darkMode: "class",
              theme: {
                extend: {
                  colors: {
                    "primary": "#4A90E2",
                    "accent": "#9013FE",
                    "background-light": "#f7f8fc",
                    "surface-light": "#ffffff",
                    "card-light": "#ffffff",
                    "text-light-primary": "#111827",
                    "text-light-secondary": "#6b7280",
                    "border-light": "#e5e7eb",
                    "danger": "#ef4444",
                    'primary-blue': '#5aa9ff',
                    'sidebar': '#ffffff',
                    'sidebar-hover': '#f3f4f6',
                    'muted': '#f7f8fc'
                  },
                  fontFamily: {
                    "display": ["Inter", "sans-serif"]
                  },
                  borderRadius: {
                    "DEFAULT": "0.75rem",
                    "lg": "1rem",
                    "xl": "1.5rem",
                    "full": "9999px"
                  },
                  boxShadow: {
                    'soft': '0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05)',
                  }
                },
              },
            };
          }
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.3/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style type="text/tailwindcss">
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24;
            font-size: inherit;
        }
      .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      /* T·∫øt Nguy√™n ƒê√°n decorations */
      .christmas-tree{display:inline-block;animation:sway 2s ease-in-out infinite;transform-origin:center bottom}
      .christmas-star{display:inline-block;animation:twinkle 1.5s ease-in-out infinite}
      .snowflake{display:inline-block;animation:float 3s ease-in-out infinite;opacity:0.8}
      .peach-blossom{display:inline-block;animation:bloom 2.5s ease-in-out infinite;transform-origin:center}
      .apricot-blossom{display:inline-block;animation:bloom 2.8s ease-in-out infinite;transform-origin:center;animation-delay:0.3s}
      @keyframes sway{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
      @keyframes twinkle{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(1.2)}}
      @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
      @keyframes bloom{0%,100%{opacity:0.8;transform:scale(1) rotate(0deg)}25%{opacity:1;transform:scale(1.1) rotate(2deg)}50%{opacity:0.9;transform:scale(1.05) rotate(-1deg)}75%{opacity:1;transform:scale(1.08) rotate(1deg)}}
      .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
      .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
      .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
      .modal.open{display:flex}
      .section-title{display:flex;align-items:center;gap:8px}
      .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
      .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
      .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
      .submit-btn:active{transform:translateY(0);opacity:.95}
      .modal.open{display:flex}
      .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
      .toast.show{opacity:1;transform:translateY(0)}
      /* Form 5: zebra rows & vertical dividers */
      .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
      .cell-div{ border-left:1px solid #e5e7eb; }
      .table-vdiv{ border-collapse: separate; border-spacing: 0; }
      .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
      /* Form 5: ·∫©n c·ªôt S·ªë DONE (c√≥ th·ªÉ b·∫≠t l·∫°i sau) */
      .f5a-col-done{ display:table-cell; }
      /* Drag row highlight */
      .drag-over{ background-color:#e0f2fe !important; }
      /* Create Task Modal scrollable content */
      #create-task-modal .overflow-y-auto {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }
      #create-task-modal .overflow-y-auto::-webkit-scrollbar {
        width: 8px;
      }
      #create-task-modal .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      #create-task-modal .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      #create-task-modal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      /* Responsive modal on mobile */
      @media (max-height: 600px) {
        #create-task-modal .max-h-\[90vh\] {
          max-height: 95vh;
        }
      }
      /* Highlight effect for Form 1 upload sections */
      .highlight-section{
        animation: highlightPulse 2s ease-in-out;
        border: 2px solid #5aa9ff;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(90, 169, 255, 0.3);
        background: linear-gradient(135deg, rgba(90, 169, 255, 0.1), rgba(255, 255, 255, 0.1));
      }
      @keyframes highlightPulse {
        0% { 
          border-color: #5aa9ff;
          box-shadow: 0 0 20px rgba(90, 169, 255, 0.3);
          background: linear-gradient(135deg, rgba(90, 169, 255, 0.1), rgba(255, 255, 255, 0.1));
        }
        50% { 
          border-color: #3b82f6;
          box-shadow: 0 0 30px rgba(90, 169, 255, 0.5);
          background: linear-gradient(135deg, rgba(90, 169, 255, 0.15), rgba(255, 255, 255, 0.15));
        }
        100% { 
          border-color: #5aa9ff;
          box-shadow: 0 0 20px rgba(90, 169, 255, 0.3);
          background: linear-gradient(135deg, rgba(90, 169, 255, 0.1), rgba(255, 255, 255, 0.1));
        }
      }
      /* Sidebar effects for groups */
      .group-btn{ 
        position:relative; 
        transition: all 0.2s ease;
      }
      .group-btn.active{ 
        background:rgba(74,144,226,.1); 
        color:#4A90E2; 
      }
      .group-btn.active .material-symbols-outlined{ 
        font-variation-settings: 'FILL' 1; 
      }
      .group-items{ 
        transition: all .2s ease; 
      }
      .group-items .nav-btn{ 
        background: transparent; 
        transition: all 0.2s ease;
        border-radius: 0.5rem;
      }
      .group-items .nav-btn:hover{ 
        background: rgba(90,169,255,0.08); 
        transform: translateX(2px);
      }
      .group-items .nav-btn.active{ 
        background:rgba(74,144,226,.1); 
        color:#4A90E2; 
        font-weight: 600;
      }
      /* Sidebar styles */
      #sidebar-nav {
        position: sticky;
        top: 0;
        align-self: flex-start;
        max-height: 100vh;
        overflow-y: auto;
        background: linear-gradient(180deg, #f0f7ff 0%, #e8f4ff 100%);
        box-shadow: 2px 0 8px rgba(90,169,255,0.08), 4px 0 16px rgba(90,169,255,0.04);
        border-right: 1px solid rgba(90,169,255,0.2);
      }
      /* C·∫£i thi·ªán c√°c m·ª•c trong sidebar */
      #sidebar-nav .group-btn {
        margin-bottom: 0.25rem;
        border-radius: 0.5rem;
      }
      #sidebar-nav .group-btn:hover {
        background: rgba(90,169,255,0.15);
        transform: translateX(1px);
      }
      #sidebar-nav .nav-btn {
        margin-bottom: 0.125rem;
        padding: 0.625rem 0.75rem;
        transition: all 0.2s ease;
        background: transparent;
      }
      #sidebar-nav .nav-btn:hover {
        background: rgba(90,169,255,0.12);
        color: #2563eb;
      }
      #sidebar-nav nav {
        gap: 0.375rem;
      }
      /* Fallback CSS ƒë·ªÉ ƒë·∫£m b·∫£o layout ho·∫°t ƒë·ªông khi Tailwind kh√¥ng load */
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .flex {
        display: flex;
      }
      .h-screen {
        height: 100vh;
      }
      .w-full {
        width: 100%;
      }
      .overflow-hidden {
        overflow: hidden;
      }
      .flex-1 {
        flex: 1 1 0%;
      }
      .flex-col {
        flex-direction: column;
      }
      .overflow-y-auto {
        overflow-y: auto;
      }
      .overflow-x-auto {
        overflow-x: auto;
      }
      .h-full {
        height: 100%;
      }
      .w-64 {
        width: 16rem;
      }
      .flex-shrink-0 {
        flex-shrink: 0;
      }
      .justify-between {
        justify-content: space-between;
      }
      .items-center {
        align-items: center;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      .gap-3 {
        gap: 0.75rem;
      }
      .gap-4 {
        gap: 1rem;
      }
      .gap-6 {
        gap: 1.5rem;
      }
      .p-4 {
        padding: 1rem;
      }
      .p-6 {
        padding: 1.5rem;
      }
      .px-2 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .px-3 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .px-4 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .py-2\.5 {
        padding-top: 0.625rem;
        padding-bottom: 0.625rem;
      }
      .py-3 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      .border-r {
        border-right-width: 1px;
      }
      .border {
        border-width: 1px;
      }
      .bg-white {
        background-color: #ffffff;
      }
      .bg-surface-light {
        background-color: #ffffff;
      }
      .bg-background-light {
        background-color: #f7f8fc;
      }
      .text-text-light-primary {
        color: #111827;
      }
      .text-text-light-secondary {
        color: #6b7280;
      }
      .border-border-light {
        border-color: #e5e7eb;
      }
      .text-base {
        font-size: 1rem;
        line-height: 1.5rem;
      }
      .text-sm {
        font-size: 0.875rem;
        line-height: 1.25rem;
      }
      .font-bold {
        font-weight: 700;
      }
      .font-semibold {
        font-weight: 600;
      }
      .font-normal {
        font-weight: 400;
      }
      .leading-normal {
        line-height: 1.5;
      }
      .rounded-lg {
        border-radius: 0.5rem;
      }
      .rounded-full {
        border-radius: 9999px;
      }
      .text-left {
        text-align: left;
      }
      .w-full {
        width: 100%;
      }
      .hidden {
        display: none;
      }
      @media (min-width: 1024px) {
        .lg\:p-8 {
          padding: 2rem;
        }
      }
    </style>
  </head>
  <body class="bg-background-light font-display text-text-light-primary antialiased">
    <div class="flex h-screen w-full overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar-nav" class="flex h-full w-64 flex-shrink-0 flex-col justify-between p-4 border-r border-border-light">
      <div class="flex flex-col gap-6">
        <div class="flex items-center gap-3 px-2">
          <img src="https://cdn-icons-png.flaticon.com/512/13374/13374464.png" alt="üßß" class="christmas-tree w-16 h-16 object-contain" />
          <div class="flex flex-col relative">
            <h1 class="text-text-light-primary text-base font-bold leading-normal">
              C·ªïng T√°c V·ª• DQA
            </h1>
          </div>
        </div>
        <nav class="flex flex-col gap-2">
          <div class="rounded-md">
            <button class="group-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-light-secondary w-full text-left">
              <span class="text-lg">üßß</span>
              <p class="text-sm font-bold leading-normal">Khai b√°o t√°c v·ª•</p>
            </button>
            <div class="group-items hidden mt-1 pl-11 flex flex-col gap-1">
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form1">
                <span class="text-base">üèÆ</span>
                <p class="text-sm font-semibold">Form 1: Tr·∫£ b√°o c√°o & form</p>
              </button>
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form11">
                <span class="text-base">üìã</span>
                <p class="text-sm font-semibold">Form 11 - Ki·ªÉm tra tr∆∞·ªõc khi g·ª≠i b√°o c√°o</p>
              </button>
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form12">
                <span class="text-base">üìë</span>
                <p class="text-sm font-semibold">Form 12 - M√£ danh m·ª•c</p>
              </button>
            </div>
          </div>
          <div class="rounded-md">
            <button class="group-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-light-secondary w-full text-left">
              <span class="text-lg">üêâ</span>
              <p class="text-sm font-bold leading-normal">KPI nh√≥m c·∫£i ti·∫øn</p>
            </button>
            <div class="group-items hidden mt-1 pl-11 flex flex-col gap-1">
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form4">
                <span class="text-base">üìÖ</span>
                <p class="text-sm font-semibold">Form 4 ¬∑ K·∫ø ho·∫°ch c√¥ng vi·ªác</p>
              </button>
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form5">
                <span class="text-base">üåº</span>
                <p class="text-sm font-semibold">Form 5: KPI th√°ng</p>
              </button>
              <button class="nav-btn hidden flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form6">
                <span class="text-base">üå∏</span>
                <p class="text-sm font-semibold">Form 6 ¬∑ √ù t∆∞·ªüng c·∫£i ti·∫øn</p>
              </button>
            </div>
          </div>
          <div class="rounded-md">
            <button class="group-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-light-secondary w-full text-left">
              <span class="text-lg">üîî</span>
              <p class="text-sm font-bold leading-normal">Khai b√°o</p>
            </button>
            <div class="group-items hidden mt-1 pl-11 flex flex-col gap-1">
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form7">
                <span class="text-base">üèÆ</span>
                <p class="text-sm font-semibold">Form 7 ¬∑ Tri·ªÉn khai CE</p>
              </button>
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form8">
                <span class="text-base">üßß</span>
                <p class="text-sm font-semibold">Form 8 ¬∑ Tri·ªÉn khai 4M</p>
              </button>
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form9">
                <span class="text-base">üéä</span>
                <p class="text-sm font-semibold">Form 9 ¬∑ Th·ªëng k√™ test b·ªÅn</p>
              </button>
              <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form13">
                <span class="text-base">üî¨</span>
                <p class="text-sm font-semibold">Form 13 ¬∑ H·ªá th·ªëng test b·ªÅn m·ªõi(ƒëang th·ª≠ nghi·ªám)</p>
              </button>
            </div>
          </div>
        </nav>
      </div>
      <div class="flex flex-col gap-1">
        <a href="https://siberbk585-coder.github.io/PhongDQA-noibo2/" target="_blank" class="nav-btn flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-light-secondary">
          <span class="text-lg">üîó</span>
          <p class="text-sm font-semibold leading-normal">C·ªïng t√°c v·ª• 2 - SPM</p>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-y-auto">
      <header class="flex-shrink-0 flex items-center justify-between gap-4 p-4 border-b border-border-light bg-surface-light/80 backdrop-blur-sm sticky top-0 z-10">
        <div class="flex-1 flex items-center gap-6 min-w-0">
          <div class="flex flex-wrap items-center gap-2">
            <a class="text-text-light-secondary text-sm font-medium hover:text-primary" href="#">Projects</a>
            <span class="text-text-light-secondary text-sm font-medium">/</span>
            <span class="text-text-light-primary text-sm font-medium truncate">C·ªïng T√°c V·ª• DQA</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="create-task-btn" class="px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition">+ T·∫°o t√°c v·ª•</button>
          <button class="p-2.5 rounded-lg text-text-light-secondary hover:bg-gray-100 transition-colors border border-border-light bg-white">
            <span class="material-symbols-outlined text-xl">tune</span>
          </button>
          <button class="p-2.5 rounded-lg text-text-light-secondary hover:bg-gray-100 transition-colors border border-border-light bg-white">
            <span class="material-symbols-outlined text-xl">filter_list</span>
          </button>
        </div>
      </header>
      <div class="flex-1 p-6 lg:p-8 overflow-x-auto">
      <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8" style="display:none;">
        <div class="relative z-10 p-8 md:p-10">
          <div class="flex items-center space-x-2 mb-3">
            <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Ph√≤ng DQA</div>
          </div>
          <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">C·ªïng t√°c v·ª• DQA - N·ªôi b·ªô</h2>
          <p class="text-blue-100 text-sm md:text-base">Vui l√≤ng kh√¥ng chia s·∫ª link c·ªïng t√°c v·ª• v·ªõi ng∆∞·ªùi ngo√†i b·ªô ph·∫≠n.</p>
        </div>
      </div>

      <!-- Form 1 -->
      <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 1: Tr·∫£ b√°o c√°o</h2>
          <div class="flex items-center gap-2">
            <button id="f1-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xu·∫•t XLSX</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
            <div class="flex gap-2">
              <select id="f1-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
              </select>
              <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
            </div>
            <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ g·ª≠i y√™u c·∫ßu v√† hi·ªÉn th·ªã t√°c v·ª•</p>
          </div>
        </div>
        <div class="mt-2 flex items-center gap-3 flex-wrap">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-700">Th√°ng</label>
            <input id="f1-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
        </div>
        <div class="mt-4 space-y-6 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
          <table class="min-w-[1600px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Tr·∫£ b√°o c√°o</th>
                <th class="px-3 py-2 min-w-[120px] border border-gray-500">N√∫t Tr·∫£ form</th>
                <th class="px-3 py-2 min-w-[120px] border border-gray-500">T·∫£i form</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">T√¨nh tr·∫°ng</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">M√£ t√°c v·ª•</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">M√£</th>
                <th class="px-3 py-2 min-w-[390px] border border-gray-500">T√™n t√°c v·ª•</th>
                <th class="px-3 py-2 min-w-[180px] border border-gray-500">Tgian n·ªôp form</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Ng√†y c·∫ßn tr·∫£ BC</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Ng∆∞·ªùi y√™u c·∫ßu</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Ng∆∞·ªùi nh·∫≠n m·∫´u</th>
                <th class="px-3 py-2 min-w-[120px] border border-gray-500">C√¥ng chu·∫©n</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">Ng√†y y√™u c·∫ßu</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">H·∫°n mong mu·ªën</th>
                <th class="px-3 py-2 min-w-[260px] border border-gray-500">M·ª•c ƒë√≠ch ƒë√°nh gi√°</th>
                <th class="px-3 py-2 min-w-[360px] border border-gray-500">Note</th>
                <th class="px-3 py-2 min-w-[240px] border border-gray-500">Y√™u c·∫ßu test ƒë·∫∑c bi·ªát</th>
                <th class="px-3 py-2 min-w-[260px] border border-gray-500">Form b√°o c√°o ƒë√°nh gi√°</th>
                <th class="px-3 py-2 min-w-[220px] border border-gray-500">T√™n file ƒë√≠nh k√®m</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">T·∫£i ƒë√≠nh k√®m</th>
              </tr>
            </thead>
            <tbody id="f1-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="20">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
        <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
          <div class="text-sm text-gray-600">
            <span id="f1-page-info">Trang 1/1 (0 d√≤ng)</span>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
            <select id="f1-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
            <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Tr∆∞·ªõc</button>
            <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
          </div>
        </div>

        <!-- ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m -->
        <div class="mt-4">
          <a id="f1-storage-link" href="https://drive.google.com/drive/folders/1hFChHMjIC4ajY4GNX3dLoczWcZ3B9zzg?usp=sharing" target="_blank" rel="noopener" title="Nh·∫•n ƒë·ªÉ m·ªü v√† t·ª± ƒë·ªông copy li√™n k·∫øt"
            class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">
            ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m
          </a>
          <p class="text-xs text-gray-500 mt-1">Nh·∫•n ƒë·ªÉ m·ªü v√† copy li√™n k·∫øt.</p>
        </div>
      </section>

      <!-- Form 4: K·∫ø ho·∫°ch c√¥ng vi·ªác -->
      <section id="form4" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 4 ¬∑ K·∫ø ho·∫°ch c√¥ng vi·ªác</h2>
          <div class="flex items-center gap-3">
            <select
              id="f4-assigneeFilter"
              class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-blue-200"
            >
              <option value="all">T·∫•t c·∫£ nh√¢n s·ª±</option>
            </select>
            <button
              id="f4-reloadButton"
              class="inline-flex items-center gap-2 rounded-lg bg-primary-blue px-4 py-1.5 text-sm font-medium text-white hover:bg-blue-600 transition"
              type="button"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              T·∫£i l·∫°i
            </button>
            <p id="f4-statusText" class="text-xs text-gray-500"></p>
          </div>
        </div>

        <!-- Main Content: 2 Column Layout -->
        <div class="flex h-[calc(100vh-200px)] overflow-hidden border border-gray-200 rounded-lg">
          <!-- Left Sidebar: Task List -->
          <aside class="w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
              <div class="flex items-center justify-between mb-2">
                <h2 class="text-sm font-semibold text-gray-700 uppercase">Danh s√°ch c√¥ng vi·ªác</h2>
                <span id="f4-recordCounter" class="text-xs text-gray-500"></span>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto">
              <div id="f4-taskList" class="p-2">
                <!-- Task list s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
              </div>
            </div>
          </aside>

          <!-- Right Panel: Gantt Chart -->
          <section class="flex-1 flex flex-col overflow-hidden bg-white">
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
              <h2 class="text-sm font-semibold text-gray-700 uppercase">Timeline (Gantt Chart)</h2>
              <div id="f4-legend" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="flex-1 overflow-hidden">
              <div
                id="f4-chartWrapper"
                class="relative w-full h-full p-4 overflow-auto"
              >
                <!-- Chart s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
              </div>
            </div>
          </section>
        </div>

        <!-- Detail Table Modal (Optional) -->
        <section id="f4-detailSection" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg max-h-96 overflow-auto">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
            <h2 class="text-sm font-semibold text-gray-700 uppercase">Chi ti·∫øt ph√¢n b·ªï c√¥ng vi·ªác</h2>
            <button id="f4-closeDetailBtn" class="text-gray-400 hover:text-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wider text-gray-700">
                  <th class="px-4 py-3">STT</th>
                  <th class="px-4 py-3">Ng∆∞·ªùi ph·ª• tr√°ch</th>
                  <th class="px-4 py-3">B·∫Øt ƒë·∫ßu</th>
                  <th class="px-4 py-3">Ho√†n th√†nh</th>
                  <th class="px-4 py-3 text-right">Gi·ªù c√¥ng</th>
                </tr>
              </thead>
              <tbody id="f4-scheduleTable" class="divide-y divide-gray-100 bg-white text-sm"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- Form 5: KPI th√°ng -->
      <section id="form5" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 5: KPI th√°ng</h2>
          <div class="flex items-center gap-2">
            <button id="f5a-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xu·∫•t XLSX</button>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex items-center gap-2 p-2">
            <label class="text-sm text-gray-700 font-semibold">Th√°ng</label>
            <button id="f5a-month-prev" class="px-3 py-1.5 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 transition-colors" title="Th√°ng tr∆∞·ªõc">
              ‚Üê
            </button>
            <input id="f5a-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <button id="f5a-month-next" class="px-3 py-1.5 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 transition-colors" title="Th√°ng sau">
              ‚Üí
            </button>
            <button id="f5a-month-current" class="px-3 py-1.5 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 transition-colors text-sm" title="Th√°ng n√†y">
              Th√°ng n√†y
            </button>
          </div>
          <!-- Tab Navigation -->
          <div class="mt-2 flex items-center gap-2 border-b border-gray-200">
            <button id="f5a-tab-p1" class="px-4 py-2 font-semibold text-white bg-primary-blue rounded-t-lg border-b-2 border-primary-blue">P1</button>
            <button id="f5a-tab-p2" class="px-4 py-2 font-semibold text-gray-600 hover:text-primary-blue hover:bg-blue-50 rounded-t-lg">P2</button>
            <button id="f5a-tab-p3" class="px-4 py-2 font-semibold text-gray-600 hover:text-primary-blue hover:bg-blue-50 rounded-t-lg">P3</button>
            <button id="f5a-tab-p4" class="px-4 py-2 font-semibold text-gray-600 hover:text-primary-blue hover:bg-blue-50 rounded-t-lg">P4</button>
          </div>
          <!-- Th·∫ª P1: c·ªôt 1,5,6,7,8,9 (+ % nh∆∞ c≈©) -->
          <div id="f5a-panel-p1" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2">
            <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
              <span class="font-semibold text-blue-800 mr-4">Th·∫ª P1</span>
              <button id="f5a-search-p1" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra c·ª©u P1</button>
            </div>
            <div class="overflow-auto max-h-[60vh] p-2">
            <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Nh√¢n vi√™n</th>
                <th class="px-3 py-2 f5a-col-done">S·ªë DONE</th>
                <th class="px-3 py-2">V∆∞·ª£t ti·∫øn ƒë·ªô</th>
                <th class="px-3 py-2">ƒê√∫ng ti·∫øn ƒë·ªô</th>
                <th class="px-3 py-2">Ch·∫≠m ti·∫øn ƒë·ªô</th>
                <th class="px-3 py-2">S·ªë N/A</th>
                <th class="px-3 py-2">T·ª∑ l·ªá v∆∞·ª£t (%)</th>
                <th class="px-3 py-2">T·ª∑ l·ªá ƒë√∫ng (%)</th>
                <th class="px-3 py-2">T·ª∑ l·ªá ch·∫≠m (%)</th>
                <th class="px-3 py-2">%N/A</th>
              </tr>
            </thead>
              <tbody id="f5a-body-p1" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
            </div>
            <!-- Dashboard P1 -->
            <div id="f5a-dashboard-p1" class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-white rounded-lg border border-blue-200 hidden">
              <h3 class="text-lg font-semibold text-blue-800 mb-3">üìä Dashboard P1</h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">T·ª∑ l·ªá tr·∫°ng th√°i</div>
                  <div class="h-64">
                    <canvas id="f5a-chart-p1-status"></canvas>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">T·ªïng c√¥ng chu·∫©n</div>
                  <div class="h-64">
                    <canvas id="f5a-chart-p1-manhour"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Th·∫ª P2: c·ªôt 1,2,3,4 (ƒë√£ ƒë·ªïi c·ªôt 4 -> T·ªïng gi·ªù c√¥ng ƒëi l√†m) -->
          <div id="f5a-panel-p2" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2 hidden">
            <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
              <span class="font-semibold text-blue-800 mr-4">Th·∫ª P2</span>
              <button id="f5a-search-p2" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra c·ª©u P2</button>
            </div>
            <div class="overflow-auto max-h-[60vh] p-2">
            <table class="min-w-[900px] w-full text-sm table-zebra table-vdiv">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-gray-700">
                  <th class="px-3 py-2 text-center">STT</th>
                  <th class="px-3 py-2 text-center">Nh√¢n vi√™n</th>
                  <th class="px-3 py-2 text-center">S·ªë t√°c v·ª• trong th√°ng</th>
                  <th class="px-3 py-2 text-center">T·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø</th>
                  <th class="px-3 py-2 text-center">C√¥ng chu·∫©n ƒë√£ nh·∫≠n</th>
                  <th class="px-3 py-2 text-center cell-div">T·ªïng gi·ªù c√¥ng ƒëi l√†m</th>
                  <th class="px-3 py-2 text-center">H·ªá s·ªë</th>
                </tr>
              </thead>
              <tbody id="f5a-body-p2" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
            </div>
            <!-- Dashboard P2 -->
            <div id="f5a-dashboard-p2" class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-white rounded-lg border border-blue-200 hidden">
              <h3 class="text-lg font-semibold text-blue-800 mb-3">üìä Dashboard P2</h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">H·ªá s·ªë theo nh√¢n vi√™n</div>
                  <div class="h-64">
                    <canvas id="f5a-chart-p2-coefficient"></canvas>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">So s√°nh gi·ªù c√¥ng</div>
                  <div class="h-64">
                    <canvas id="f5a-chart-p2-hours"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Th·∫ª P3: R√† so√°t CE -->
          <div id="f5a-panel-p3" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2 hidden">
            <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
              <span class="font-semibold text-blue-800 mr-4">Th·∫ª P3 - R√† so√°t CE</span>
              <button id="f5a-search-p3" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra c·ª©u P3</button>
            </div>
            <div class="overflow-auto max-h-[60vh] p-2">
              <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
                <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                  <tr class="text-left text-gray-700">
                    <th class="px-3 py-2">T√™n nh√¢n vi√™n</th>
                    <th class="px-3 py-2">S·ªë t√°c v·ª• ho√†n th√†nh th√°ng</th>
                    <th class="px-3 py-2">T√°c v·ª• ƒë√£ ho√†n thi·ªán CE</th>
                    <th class="px-3 py-2">T√°c v·ª• kh√¥ng c·∫ßn l√†m CE</th>
                    <th class="px-3 py-2">Ch∆∞a ho√†n th√†nh</th>
                    <th class="px-3 py-2">Th·∫ª P3/R√† so√°t CE (%)</th>
                  </tr>
                </thead>
                <tbody id="f5a-body-p3" class="divide-y divide-gray-100">
                  <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                </tbody>
              </table>
            </div>
            <!-- Dashboard P3 -->
            <div id="f5a-dashboard-p3" class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-white rounded-lg border border-blue-200 hidden">
              <h3 class="text-lg font-semibold text-blue-800 mb-3">üìä Dashboard P3 - R√† so√°t CE</h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">T·ª∑ l·ªá ho√†n th√†nh CE</div>
                  <div class="h-64">
                    <canvas id="f5a-chart-p3-ce"></canvas>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">Ph√¢n b·ªï tr·∫°ng th√°i CE</div>
                  <div class="h-64">
                    <canvas id="f5a-chart-p3-status"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Th·∫ª P4: Ph√¢n t√≠ch chi ti·∫øt -->
          <div id="f5a-panel-p4" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2 hidden">
            <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
              <span class="font-semibold text-blue-800 mr-4">Th·∫ª P4 - Ph√¢n t√≠ch chi ti·∫øt</span>
              <button id="f5a-search-p4" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra c·ª©u P4</button>
            </div>
            <div class="overflow-auto max-h-[60vh] p-2">
              <table class="min-w-[1400px] w-full text-sm table-zebra table-vdiv">
                <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                  <tr class="text-left text-gray-700">
                    <th class="px-3 py-2">T√™n nh√¢n vi√™n</th>
                    <th class="px-3 py-2">T·ªïng t√°c v·ª• m√°y</th>
                    <th class="px-3 py-2">T√°c v·ª• kh√¥ng c·∫ßn khai b√°o</th>
                    <th class="px-3 py-2">TCKT(% ho√†n th√†nh)</th>
                    <th class="px-3 py-2">CE(% ho√†n th√†nh)</th>
                    <th class="px-3 py-2">HDKT(% ho√†n th√†nh)</th>
                    <th class="px-3 py-2">BB ƒë√†o t·∫°o(% ho√†n th√†nh)</th>
                    <th class="px-3 py-2">Jig tool(% ho√†n th√†nh)</th>
                    <th class="px-3 py-2">KHKSCL(% ho√†n th√†nh)</th>
                    <th class="px-3 py-2">Th·∫ª P4 (%)</th>
                  </tr>
                </thead>
                <tbody id="f5a-body-p4" class="divide-y divide-gray-100">
                  <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                </tbody>
              </table>
            </div>
            <!-- Dashboard P4 -->
            <div id="f5a-dashboard-p4" class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-white rounded-lg border border-blue-200 hidden">
              <h3 class="text-lg font-semibold text-blue-800 mb-3">üìä Dashboard P4 - Ph√¢n t√≠ch chi ti·∫øt</h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">T·ª∑ l·ªá ho√†n th√†nh c√°c h·∫°ng m·ª•c</div>
                  <div class="h-80">
                    <canvas id="f5a-chart-p4-categories"></canvas>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-100">
                  <div class="text-sm text-gray-600 mb-2">Th·∫ª P4 theo nh√¢n vi√™n</div>
                  <div class="h-80">
                    <canvas id="f5a-chart-p4-overall"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="f5a-chart-controls" class="mt-4 text-sm text-gray-700 flex items-center gap-3" style="display:none">
          <span>Bi·ªÉu ƒë·ªì theo PIC</span>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Ch·∫ø ƒë·ªô</label>
            <select id="f5a-mode" class="border border-blue-200 rounded bg-white text-sm px-2 py-1">
              <option value="vertical">C·ªôt d·ªçc</option>
              <option value="horizontal">Thanh ngang</option>
            </select>
          </div>
          <button id="f5a-refresh" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">L√†m m·ªõi</button>
        </div>
        <div class="mt-2" style="display:none">
          <div class="text-xs text-gray-600 mb-1">T·ª∑ l·ªá tr·∫°ng th√°i</div>
          <div id="f5a-chart-container" class="h-80" style="display:none">
            <canvas id="f5a-chart"></canvas>
          </div>
        </div>
        <div class="mt-4" style="display:none">
          <div class="text-xs text-gray-600 mb-1">T·ªïng c√¥ng chu·∫©n</div>
          <div id="f5a-chart-container-manhour" class="h-80" style="display:none">
            <canvas id="f5a-chart-manhour"></canvas>
          </div>
        </div>
      </section>


      <!-- Form 6 -->
      <section id="form6" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 6 ¬∑ √ù t∆∞·ªüng c·∫£i ti·∫øn</h2>
          <div class="flex items-center gap-2">
            <button id="f6-open-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">N·ªôp √Ω t∆∞·ªüng</button>
            <button id="f6-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra c·ª©u</button>
            <button id="f6-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xu·∫•t XLSX</button>
          </div>
        </div>

        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Th√°ng n·ªôp</label>
          <input id="f6-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>

        <div class="mt-6 -mx-6">
          <div class="overflow-auto max-h-[60vh] border border-gray-200 rounded-lg bg-white">
            <table class="min-w-[2000px] w-full text-sm">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">Ng√†y n·ªôp</th>
                  <th class="px-3 py-2">Nh√¢n vi√™n</th>
                  <th class="px-3 py-2">Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng</th>
                  <th class="px-3 py-2">V·∫•n ƒë·ªÅ nh·∫≠n di·ªán</th>
                  <th class="px-3 py-2">Gi·∫£i ph√°p</th>
                  <th class="px-3 py-2">√ù ki·∫øn tr∆∞·ªüng ph√≤ng</th>
                  <th class="px-3 py-2">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="f6-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="f6-count" class="mt-4 p-3 rounded-lg border border-blue-200 bg-blue-50/30 text-blue-800 cursor-pointer inline-flex items-center gap-2">
          <span>Nh·∫•n ƒë·ªÉ xem s·ªë √Ω t∆∞·ªüng ƒë√£ n·ªôp</span>
        </div>
        <div class="mt-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-blue-800">Th·ªëng k√™ √Ω t∆∞·ªüng theo nh√¢n vi√™n</h3>
            <span id="f6-agg-note" class="text-xs text-gray-500"></span>
          </div>
          <div class="overflow-auto max-h-[50vh] border border-gray-200 rounded-lg bg-white">
            <table class="min-w-[520px] w-full text-sm">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">Nh√¢n vi√™n</th>
                  <th class="px-3 py-2">T·ªïng s·ªë √Ω t∆∞·ªüng</th>
                  <th class="px-3 py-2">S·ªë √Ω t∆∞·ªüng ƒë∆∞·ª£c duy·ªát</th>
                  <th class="px-3 py-2">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="f6-agg-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
      
      <!-- Form 7 ¬∑ Tri·ªÉn khai CE/4M (clone of Form 2 with wording changes) -->
      <section id="form7" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 7 ¬∑ Tri·ªÉn khai CE</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
            <div class="flex gap-2">
              <select id="f7-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
              </select>
              <button id="f7-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
            </div>
            <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ hi·ªÉn th·ªã t√°c v·ª• c·∫ßn tr·∫£ CE/4M.</p>
          </div>
        </div>
        <div class="mt-2 flex items-center gap-3 flex-wrap">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-700">L·ªçc theo th√°ng ho√†n th√†nh</label>
            <input id="f7-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <button id="f7-clear-month" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">X√≥a l·ªçc</button>
          </div>
          <p class="text-gray-500 text-xs">ƒê·ªÉ tr·ªëng ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£. L·ªçc theo c·ªôt "Ng√†y ho√†n th√†nh th·ª±c t·∫ø"</p>
        </div>
        
        <!-- Removed stray Form 9 controls from Form 7 -->
        <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-x-auto">
          <table class="min-w-[1600px] w-full text-sm border-collapse">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-3 min-w-[120px] border border-gray-300">M√£ t√°c v·ª•</th>
                <th class="px-3 py-3 min-w-[140px] border border-gray-300">Ng√†y ho√†n th√†nh th·ª±c t·∫ø</th>
                <th class="px-3 py-3 min-w-[120px] border border-gray-300">M√£ linh ki·ªán/m√°y</th>
                <th class="px-3 py-3 min-w-[200px] border border-gray-300">Task Name</th>
                <th class="px-3 py-3 min-w-[120px] border border-gray-300">M√£ B√°o c√°o</th>
                <th class="px-3 py-3 min-w-[150px] border border-gray-300">K·∫øt qu·∫£ ƒë√°nh gi√°</th>
                <th class="px-3 py-3 min-w-[150px] border border-gray-300">Ghi ch√∫</th>
                <th class="px-3 py-3 min-w-[100px] bg-cyan-50 text-cyan-800 border border-gray-300">Khai b√°o CE</th>
                <th class="px-3 py-3 min-w-[130px] bg-cyan-50 text-cyan-800 border border-gray-300">T√¨nh tr·∫°ng r√† so√°t</th>
                <th class="px-3 py-3 min-w-[180px] bg-cyan-50 text-cyan-800 border border-gray-300">Ng√†y khai b√°o CE g·∫ßn nh·∫•t</th>
                <th class="px-3 py-3 min-w-[200px] bg-cyan-50 text-cyan-800 border border-gray-300">Ghi ch√∫ n·ªôp CE</th>
                <th class="px-3 py-3 min-w-[120px] bg-amber-50 text-amber-800 border border-gray-300">Khai b√°o m·∫´u b√†n giao</th>
                <th class="px-3 py-3 min-w-[150px] bg-amber-50 text-amber-800 border border-gray-300">T√¨nh tr·∫°ng m·∫´u b√†n giao</th>
                <th class="px-3 py-3 min-w-[200px] bg-amber-50 text-amber-800 border border-gray-300">Ghi ch√∫ b√†n giao m·∫´u</th>
              </tr>
            </thead>
            <tbody id="f7-body" class="divide-y divide-gray-200">
              <tr><td class="px-3 py-4 text-center text-gray-500" colspan="13">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Form 8 ¬∑ Tri·ªÉn khai 4M -->
      <section id="form8" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 8 ¬∑ Tri·ªÉn khai 4M</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
            <div class="flex gap-2">
              <select id="f8-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
              </select>
              <button id="f8-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
              <a id="f8-template-link-top" href="https://drive.usercontent.google.com/download?id=1-8rjlAXi1x8lM235Smzd_jxoxmwT39kN&export=download&authuser=5&confirm=t&uuid=1f5e95c2-1291-4c15-a8d7-557f2a291549&at=AKSUxGNj-8k957V0Bj3nmNOF40aM:1760320142017" target="_blank" rel="noopener" class="px-3 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Form m·∫´u</a>
              <button id="f8-export-xlsx" class="px-3 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xu·∫•t XLSX</button>
            </div>
            <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ hi·ªÉn th·ªã t√°c v·ª• c·∫ßn tr·∫£ 4M.</p>
          </div>
        </div>
        <div class="mt-2 flex items-center gap-3 flex-wrap">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-700">L·ªçc theo th√°ng ho√†n th√†nh</label>
            <input id="f8-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <button id="f8-clear-month" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">X√≥a l·ªçc</button>
          </div>
          <p class="text-gray-500 text-xs">ƒê·ªÉ tr·ªëng ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£. L·ªçc theo c·ªôt "Ng√†y ho√†n th√†nh th·ª±c t·∫ø"</p>
        </div>

        <!-- B·∫£ng chi ti·∫øt t√°c v·ª• -->
        <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-auto" style="max-height: 70vh;">
          <table class="min-w-[1600px] w-full text-sm table-auto">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700 font-medium">
                <th class="px-3 py-3 min-w-[100px] border-r border-gray-200">Khai b√°o</th>
                <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">M√£ t√°c v·ª•</th>
                <th class="px-3 py-3 min-w-[140px] border-r border-gray-200">Ng√†y ho√†n th√†nh th·ª±c t·∫ø</th>
                <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">M√£ linh ki·ªán/m√°y</th>
                <th class="px-3 py-3 min-w-[200px] border-r border-gray-200">Task Name</th>
                <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">M√£ B√°o c√°o</th>
                <th class="px-3 py-3 min-w-[150px] border-r border-gray-200">K·∫øt qu·∫£ ƒë√°nh gi√°</th>
                <th class="px-3 py-3 min-w-[150px] border-r border-gray-200">Ghi ch√∫</th>
                <th class="px-3 py-3 min-w-[130px] border-r border-gray-200">T√¨nh tr·∫°ng r√† so√°t</th>
                <th class="px-3 py-3 min-w-[150px] border-r border-gray-200">Ng√†y khai b√°o g·∫ßn nh·∫•t</th>
                <th class="px-3 py-3 min-w-[140px]">T·ª∑ l·ªá ho√†n th√†nh 4M</th>
              </tr>
            </thead>
            <tbody id="f8-body" class="divide-y divide-gray-200">
              <tr><td class="px-3 py-4 text-center text-gray-500" colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Modal: Chi ti·∫øt 4M c·ªßa t√°c v·ª• -->
      <div id="f8-4m-modal" class="modal" aria-hidden="true">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 p-6 relative">
          <div class="px-4 py-3 bg-gradient-to-b from-emerald-50 to-white border-b border-gray-200 flex items-center justify-between">
            <h3 id="f8-4m-modal-title" class="text-lg font-semibold text-emerald-800">Chi ti·∫øt 4M</h3>
            <button id="f8-4m-modal-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
          
          <div class="p-4">
            <!-- Th√¥ng tin t√°c v·ª• -->
            <div class="mb-4 space-y-2">
              <div class="text-sm"><span class="font-medium text-gray-700">M√£ t√°c v·ª•:</span> <span id="f8-4m-task-id" class="text-blue-600 font-mono"></span></div>
              <div class="text-sm"><span class="font-medium text-gray-700">Task Name:</span> <span id="f8-4m-task-name" class="font-semibold"></span></div>
              <div class="text-sm"><span class="font-medium text-gray-700">Ng√†y ho√†n th√†nh:</span> <span id="f8-4m-completion-date"></span></div>
            </div>

            <!-- B·∫£ng ph·∫ßn trƒÉm 4M -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-emerald-100 to-emerald-50">
                  <tr>
                    <th class="px-4 py-2 text-left text-gray-700">H·∫°ng m·ª•c</th>
                    <th class="px-4 py-2 text-center text-gray-700">Ti·∫øn ƒë·ªô (%)</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium">TCKT</td>
                    <td class="px-4 py-2 text-center"><span id="f8-4m-tckt" class="font-semibold text-emerald-700"></span></td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium">CE</td>
                    <td class="px-4 py-2 text-center"><span id="f8-4m-ce" class="font-semibold text-emerald-700"></span></td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium">HDKT</td>
                    <td class="px-4 py-2 text-center"><span id="f8-4m-hdkt" class="font-semibold text-emerald-700"></span></td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium">BB ƒë√†o t·∫°o</td>
                    <td class="px-4 py-2 text-center"><span id="f8-4m-bb" class="font-semibold text-emerald-700"></span></td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium">Jig tool</td>
                    <td class="px-4 py-2 text-center"><span id="f8-4m-jig" class="font-semibold text-emerald-700"></span></td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium">KHKSCL</td>
                    <td class="px-4 py-2 text-center"><span id="f8-4m-khkscl" class="font-semibold text-emerald-700"></span></td>
                  </tr>
                  <tr class="bg-emerald-50 font-semibold">
                    <td class="px-4 py-3">Trung b√¨nh 4M</td>
                    <td class="px-4 py-3 text-center"><span id="f8-4m-avg" class="text-lg text-emerald-700"></span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="px-4 py-3 border-t border-gray-200 flex justify-end">
            <button id="f8-4m-modal-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
          </div>
        </div>
      </div>

      <!-- Form 9 ¬∑ Th·ªëng k√™ test b·ªÅn -->
      <section id="form9" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 9 ¬∑ Th·ªëng k√™ test b·ªÅn</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
            <div class="flex gap-2">
              <select id="f9-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
              </select>
              <button id="f9-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
          </div>
            <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu test b·ªÅn.</p>
            </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">L·ªçc theo th√°ng ho√†n th√†nh</label>
            <div class="flex items-center gap-2">
              <input id="f9-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              <button id="f9-clear-month" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">X√≥a l·ªçc</button>
          </div>
            <p class="text-gray-500 text-xs mt-1">ƒê·ªÉ tr·ªëng ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£. L·ªçc theo c·ªôt "Ng√†y ho√†n th√†nh th·ª±c t·∫ø"</p>
          </div>
        </div>
        <!-- Removed old size/stat controls to avoid duplication -->
        <div id="f9-controls" class="mt-2 flex items-center gap-2">
          <button id="f9-open-stats" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700">Th·ªëng k√™</button>
          <button id="f9-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xu·∫•t XLSX</button>
        </div>
        <div class="mt-4 space-y-6 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
          <table class="min-w-[1600px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2 min-w-[60px] border border-gray-500">STT</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Khai b√°o test b·ªÅn</th>
                <th class="px-3 py-2 min-w-[180px] border border-gray-500">Ng√†y tr·∫£ BC t·ª©c th·ªùi</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">T√¨nh tr·∫°ng test b·ªÅn</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Link b·∫±ng ch·ª©ng</th>
                <th class="px-3 py-2 min-w-[220px] border border-gray-500">D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn</th>
                <th class="px-3 py-2 min-w-[120px] border border-gray-500">M√£</th>
                <th class="px-3 py-2 min-w-[260px] border border-gray-500">Task Name</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">Assignee</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">M√£ B√°o c√°o</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">M√£ t√°c v·ª•</th>
                <th class="px-3 py-2 min-w-[220px] border border-gray-500">Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="f9-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="12">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Form 13 - Th·ªëng k√™ test b·ªÅn m·ªõi (H·ªá th·ªëng test b·ªÅn m·ªõi) -->
      <section id="form13" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 13 - H·ªá th·ªëng test b·ªÅn m·ªõi (ƒêang th·ª≠ nghi·ªám)</h2>
          <button id="f13-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">T·∫£i d·ªØ li·ªáu</button>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700">D·ªØ li·ªáu l·∫•y t·ª´ h·ªá th·ªëng test b·ªÅn m·ªõi. Nh·∫•n "T·∫£i d·ªØ li·ªáu" ƒë·ªÉ l√†m m·ªõi.</p>
        </div>
        <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-x-auto">
          <table class="min-w-[1800px] w-full text-sm border-collapse">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2 min-w-[50px] border border-gray-500">Id</th>
                <th class="px-3 py-2 min-w-[300px] border border-gray-500">Linh ki·ªán</th>
                <th class="px-3 py-2 min-w-[120px] border border-gray-500">Ng∆∞·ªùi l·∫≠p</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">M√£ t√°c v·ª•</th>
                <th class="px-3 py-2 min-w-[90px] border border-gray-500">M√£ danh m·ª•c</th>
                <th class="px-3 py-2 min-w-[200px] border border-gray-500">H·∫°ng m·ª•c ki·ªÉm tra</th>
                <th class="px-3 py-2 min-w-[220px] border border-gray-500">Ti√™u chu·∫©n</th>
                <th class="px-3 py-2 min-w-[160px] border border-gray-500">C√¥ng c·ª•</th>
                <th class="px-3 py-2 min-w-[60px] border border-gray-500">Type</th>
                <th class="px-3 py-2 min-w-[280px] border border-gray-500">Document</th>
                <th class="px-3 py-2 min-w-[70px] border border-gray-500">Available</th>
                <th class="px-3 py-2 min-w-[80px] border border-gray-500">T√¨nh tr·∫°ng</th>
                <th class="px-3 py-2 min-w-[140px] border border-gray-500">Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="f13-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="13">Ch∆∞a c√≥ d·ªØ li·ªáu. Nh·∫•n "T·∫£i d·ªØ li·ªáu" ƒë·ªÉ t·∫£i.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Form 11 - Ki·ªÉm tra tr∆∞·ªõc b√°o c√°o -->
      <section id="form11" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 11 - Ki·ªÉm tra tr∆∞·ªõc b√°o c√°o</h2>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700 mb-3">Vui l√≤ng t·∫£i file Excel (.xlsx) ƒë·ªÉ ki·ªÉm tra tr∆∞·ªõc khi b√°o c√°o.</p>
          <div class="flex items-center gap-3 flex-wrap">
            <input id="f11-file" type="file" accept=".xlsx" class="hidden"/>
            <button id="f11-upload-btn" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Ch·ªçn file XLSX</button>
            <span id="f11-file-name" class="text-sm text-gray-600">Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn</span>
            <button id="f11-submit-btn" class="px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>G·ª≠i</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Ch·ªâ ch·∫•p nh·∫≠n file ƒë·ªãnh d·∫°ng .xlsx. M·ªói l·∫ßn ch·ªâ ƒë∆∞·ª£c t·∫£i 1 file.</p>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ -->
        <div id="f11-results" class="hidden">
          <!-- Container cho K·∫øt lu·∫≠n v√† Th·ªëng k√™ (c√πng h√†ng) -->
          <div class="flex gap-3 mb-4">
            <!-- K·∫øt lu·∫≠n t·ªïng (50% chi·ªÅu ngang) -->
            <div id="f11-conclusion" class="w-1/2 rounded-lg border-2"></div>
            
            <!-- Th·ªëng k√™ (50% chi·ªÅu ngang) -->
            <div id="f11-statistics" class="w-1/2 grid grid-cols-3 gap-2"></div>
          </div>
          
          <!-- Nh·∫≠n x√©t v√† B√°o c√°o b·∫•t th∆∞·ªùng -->
          <div id="f11-comments" class="mb-4 space-y-3"></div>
          
          <!-- Container cho t·∫•t c·∫£ c√°c items -->
          <div id="f11-items-container" class="mb-4 space-y-6"></div>
        </div>
      </section>

      <!-- Form 12 - M√£ danh m·ª•c -->
      <section id="form12" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-blue-800">Form 12 - M√£ danh m·ª•c</h2>
          <div class="flex items-center gap-2">
            <button id="f12-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra c·ª©u</button>
            <button id="f12-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xu·∫•t XLSX</button>
          </div>
        </div>
        <div class="flex items-center gap-4 mb-4 flex-wrap">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">L·ªçc H·∫°ng m·ª•c ki·ªÉm tra:</label>
            <button id="f12-filter-hangmuc-btn" type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-300 bg-white hover:bg-blue-50 text-gray-700 text-sm font-medium shadow-sm transition min-w-[200px] justify-between">
              <span id="f12-filter-hangmuc-label">T·∫•t c·∫£</span>
              <span class="material-symbols-outlined text-lg text-blue-600">filter_list</span>
            </button>
          </div>
          <div class="flex items-center gap-2 hidden">
            <label class="text-sm font-medium text-gray-700">Tick theo T√™n linh ki·ªán:</label>
            <button id="f12-filter-btn" type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-300 bg-white hover:bg-blue-50 text-gray-700 text-sm font-medium shadow-sm transition min-w-[200px] justify-between">
              <span id="f12-filter-label">Ch·ªçn linh ki·ªán ƒë·ªÉ tick</span>
              <span class="material-symbols-outlined text-lg text-blue-600">checklist</span>
            </button>
          </div>
          <span id="f12-ticked-count" class="text-sm text-gray-600">ƒê√£ ch·ªçn: 0</span>
          <button id="f12-show-ticked-only-btn" type="button" class="px-3 py-1.5 rounded-lg border border-blue-300 bg-white hover:bg-blue-50 text-gray-700 text-sm font-medium transition">
            <span id="f12-show-ticked-only-label">Ch·ªâ hi·ªán ƒë√£ tick</span>
          </button>
        </div>
        <div id="f12-loading" class="hidden text-center py-4">
          <span class="spinner"></span>
          <span class="ml-2 text-gray-600">ƒêang t·∫£i...</span>
        </div>
        <div id="f12-results" class="mt-4 -mx-6">
          <div class="overflow-auto max-h-[70vh] border border-gray-200 rounded-lg bg-white">
            <table class="min-w-[1200px] w-full text-sm table-zebra">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2 w-10"><input id="f12-select-all" type="checkbox" class="rounded border-gray-400" title="Ch·ªçn/b·ªè ch·ªçn t·∫•t c·∫£" /></th>
                  <th class="px-3 py-2">Id</th>
                  <th class="px-3 py-2">M√£ danh m·ª•c</th>
                  <th class="px-3 py-2">H·∫°ng m·ª•c ki·ªÉm tra</th>
                  <th class="px-3 py-2">Ti√™u chu·∫©n</th>
                  <th class="px-3 py-2">C√¥ng c·ª•</th>
                  <th class="px-3 py-2">Type</th>
                  <th class="px-3 py-2">H∆∞·ªõng d·∫´n</th>
                  <th class="px-3 py-2">Available</th>
                  <th class="px-3 py-2">C√¥ng chu·∫©n</th>
                </tr>
              </thead>
              <tbody id="f12-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Nh·∫•n "Tra c·ª©u" ƒë·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- Form 12: Modal l·ªçc T√™n linh ki·ªán -->
    <div id="f12-filter-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f12-filter-modal-title">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="f12-filter-modal-title" class="text-lg font-semibold text-gray-800">Tick theo T√™n linh ki·ªán</h3>
          <button id="f12-filter-modal-close" type="button" class="p-1.5 rounded-lg hover:bg-gray-200 text-gray-600 transition">&times;</button>
        </div>
        <div class="p-4">
          <div class="relative mb-4">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xl">search</span>
            <input id="f12-filter-search" type="text" placeholder="T√¨m ki·∫øm theo t·ª´ kh√≥a..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm" />
          </div>
          <div id="f12-filter-list" class="max-h-[320px] overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100">
            <div class="p-3 text-center text-gray-500 text-sm">Nh·∫•n "Tra c·ª©u" ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
          </div>
        </div>
        <div class="px-4 py-3 border-t border-gray-200 bg-slate-50 flex justify-end gap-2">
          <button id="f12-filter-apply" type="button" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <!-- Form 12: Modal l·ªçc H·∫°ng m·ª•c ki·ªÉm tra -->
    <div id="f12-filter-hangmuc-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f12-filter-hangmuc-title">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="f12-filter-hangmuc-title" class="text-lg font-semibold text-gray-800">L·ªçc theo H·∫°ng m·ª•c ki·ªÉm tra</h3>
          <button id="f12-filter-hangmuc-close" type="button" class="p-1.5 rounded-lg hover:bg-gray-200 text-gray-600 transition">&times;</button>
        </div>
        <div class="p-4">
          <div class="relative mb-4">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xl">search</span>
            <input id="f12-filter-hangmuc-search" type="text" placeholder="T√¨m ki·∫øm theo t·ª´ kh√≥a..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm" />
          </div>
          <div id="f12-filter-hangmuc-list" class="max-h-[320px] overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100">
            <div class="p-3 text-center text-gray-500 text-sm">Nh·∫•n "Tra c·ª©u" ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
          </div>
        </div>
        <div class="px-4 py-3 border-t border-gray-200 bg-slate-50 flex justify-end gap-2">
          <button id="f12-filter-hangmuc-apply" type="button" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">√Åp d·ª•ng</button>
          <button id="f12-filter-hangmuc-reset" type="button" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">X√≥a l·ªçc</button>
        </div>
      </div>
    </div>

    <!-- Form 9: Modal chi ti·∫øt Test b·ªÅn -->
    <div id="f9-dur-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-2xl shadow-2xl max-w-[96vw] w-full mx-4 p-0 relative">
        <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-primary-blue text-white rounded-t-2xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full bg-white/15 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white"><path d="M3 6a1 1 0 011-1h3.28a1 1 0 01.948.684l.498 1.493A2 2 0 0010.64 8H19a1 1 0 110 2h-8.36a2 2 0 00-1.914 1.277l-.498 1.493A1 1 0 016.28 13H4a1 1 0 110-2h1.84l.36-1.08A4 4 0 0110.64 8H19V6H10.64a4 4 0 01-3.8-2.723L6.28 2H4a1 1 0 00-1 1v3z"/></svg>
            </div>
            <div>
          <h3 class="text-lg font-semibold leading-tight">Modal F9-1 ¬∑ Chi ti·∫øt Test b·ªÅn</h3>
              <div class="text-xs opacity-90">Khai b√°o b·∫±ng ch·ª©ng, tr·∫°ng th√°i v√† ghi ch√∫</div>
            </div>
          </div>
          <button id="f9-dur-close" class="text-white/90 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
            <div class="p-3 rounded-lg bg-blue-50 border border-blue-100"><div class="text-xs text-blue-700">Assignee</div><div id="f9-dur-assignee" class="font-medium text-blue-900"></div></div>
            <div class="p-3 rounded-lg bg-blue-50 border border-blue-100"><div class="text-xs text-blue-700">M√£ t√°c v·ª•</div><div id="f9-dur-taskid" class="font-mono font-medium text-blue-900"></div></div>
            <div class="p-3 rounded-lg bg-blue-50 border border-blue-100 md:col-span-1"><div class="text-xs text-blue-700">Task Name</div><div id="f9-dur-taskname" class="font-medium text-blue-900"></div></div>
          </div>
          <div id="f9-gatea-wrap" class="mt-3">
            <div class="mt-2 rounded-xl border border-gray-200 overflow-hidden">
              <div class="px-4 py-2 bg-gradient-to-r from-amber-100 to-amber-50 text-amber-900 font-semibold flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-amber-500 text-white text-xs">A</span>
                Gate A - B·∫±ng ch·ª©ng v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i
              </div>
              <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                <div class="md:col-span-1">
                  <label class="block text-gray-700 text-xs mb-1">B·∫±ng ch·ª©ng (ƒë√≠nh k√®m)</label>
                  <input id="f9-gatea-file" type="file" class="block w-full text-sm text-gray-700 file:mr-3 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200" />
                </div>
                <div class="md:col-span-1">
                  <label class="block text-gray-700 text-xs mb-1">Tr·∫°ng th√°i</label>
                  <select id="f9-gatea-status" class="w-full border border-gray-300 rounded px-2 py-2">
                    <option value="Pending">Pending</option>
                    <option value="ƒêang tri·ªÉn khai">ƒêang tri·ªÉn khai</option>
                    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                  </select>
                </div>
                <div class="md:col-span-1">
                  <label class="block text-gray-700 text-xs mb-1">Ghi ch√∫</label>
                  <input id="f9-gatea-note" type="text" class="w-full border border-gray-300 rounded px-2 py-2" placeholder="Ghi ch√∫ cho Gate A" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 bg-slate-50 rounded-b-2xl flex items-center justify-between">
          <div class="text-xs text-gray-600">Ki·ªÉm tra l·∫°i d·ªØ li·ªáu tr∆∞·ªõc khi l∆∞u. B·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh nhi·ªÅu l·∫ßn.</div>
          <div class="flex items-center gap-2">
            <button id="f9-dur-save-all" class="px-5 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 shadow">G·ª≠i d·ªØ li·ªáu</button>
            <button id="f9-dur-cancel" class="px-5 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 hover:bg-gray-50">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Form 9: Modal th·ªëng k√™ -->
    <div id="f9-stats-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-blue-800">Modal F9-2 ¬∑ Th·ªëng k√™ test b·ªÅn</h3>
          <button id="f9-stats-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
        <div class="p-4" id="f9-stats-body"></div>
        <div class="px-4 py-3 border-t border-gray-200 flex justify-end">
          <button id="f9-stats-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <!-- Create Task Modal (Form 3) -->
    <div id="create-task-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="create-task-title">
      <div class="w-full max-w-4xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden flex flex-col max-h-[90vh] my-4">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex-shrink-0">
          <h3 id="create-task-title" class="text-base font-semibold text-gray-800">T·∫°o t√°c v·ª•</h3>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
          <div id="create-task-alert" class="flex items-start gap-3 p-4 mb-4 border border-blue-200 bg-blue-50 text-blue-900 rounded-lg shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-sm leading-relaxed">
              T·ª´ ng√†y 12-11-2025, ch·ªâ cho ph√©p c·∫•p leader(ho·∫∑c ng∆∞·ªùi ƒë∆∞·ª£c leader ·ªßy quy·ªÅn) th·ª±c hi·ªán giao vi·ªác tr√™n c·ªïng t√°c v·ª•. Vui l√≤ng th√¥ng b√°o v·ªõi tr∆∞·ªüng nh√≥m tr∆∞·ªõc khi giao t√°c v·ª•.
            </p>
          </div>
          <form id="create-task-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ªùi y√™u c·∫ßu <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <input id="create-rq-by" required type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi y√™u c·∫ßu" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi gian y√™u c·∫ßu</label>
                <input id="create-rq-time" readonly type="text" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
                <p class="text-gray-500 text-xs mt-1">C·ªë ƒë·ªãnh theo th·ªùi gian h·ªá th·ªëng</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email ng∆∞·ªùi y√™u c·∫ßu</label>
                <input id="create-rq-by-email" type="email" readonly placeholder="T·ª± ƒë·ªông theo Ng∆∞·ªùi y√™u c·∫ßu" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
                <p class="text-gray-500 text-xs mt-1">T·ª± ƒë·ªông ƒëi·ªÅn theo "Ng∆∞·ªùi y√™u c·∫ßu"</p>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">T√™n t√°c v·ª• <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <input id="create-task-name" required type="text" placeholder="Nh·∫≠p t√™n t√°c v·ª•" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ªùi ƒë∆∞·ª£c giao <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <select id="create-f3-assignee" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                  <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">C√¥ng chu·∫©n <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <input id="create-man-hour" required type="text" min="0" placeholder="VD: 12,5" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                <p class="text-gray-500 text-xs mt-1">S·ª≠ d·ª•ng d·∫•u ph·∫©y (,) cho s·ªë th·∫≠p ph√¢n. VD: 12,5</p>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·∫ßu ra c√¥ng vi·ªác <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <input id="create-output" required type="text" placeholder="M√¥ t·∫£ ƒë·∫ßu ra" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
                <input id="create-deadline" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Link KOI</label>
                <input id="create-odoo-jira" type="text" placeholder="Copy link lu·ªìng ph√™ duy·ªát" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">T√†i li·ªáu ƒë√≠nh k√®m</label>
                <input id="create-attach" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
                <div id="create-f3-upload-list" class="mt-2 text-sm"></div>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i t√°c v·ª• <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <select id="create-task-type" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                  <option value="">‚Äî Ch·ªçn lo·∫°i t√°c v·ª• ‚Äî</option>
                  <option value="S·∫£n ph·∫©m">S·∫£n ph·∫©m</option>
                  <option value="Linh ki·ªán">Linh ki·ªán</option>
                  <option value="T√°c v·ª• kh√°c">T√°c v·ª• kh√°c</option>
                </select>
                <p id="create-task-type-note" class="text-gray-500 text-xs mt-1"></p>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">M·ª•c ƒë√≠ch ƒë√°nh gi√° <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
                <select id="create-purpose" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                  <option value="">‚Äî Ch·ªçn m·ª•c ƒë√≠ch ƒë√°nh gi√° ‚Äî</option>
                  <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° SP m·ªõi</option>
                  <option value="ƒê√°nh gi√° S·∫£n ph·∫©m SOP">ƒê√°nh gi√° S·∫£n ph·∫©m SOP</option>
                  <option value="T√°c v·ª• kh√°c">T√°c v·ª• kh√°c</option>
                </select>
              </div>
            </div>
            <div class="pt-2 flex items-center gap-3">
              <button type="submit" class="submit-btn px-6 py-2 text-white font-semibold transition">Giao vi·ªác</button>
            </div>
          </form>
        </div>
        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2 flex-shrink-0">
          <button id="create-task-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
      <div class="w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
          <div class="flex items-center justify-between">
            <!-- Tabs for Gate 1 / Gate 2 / Gate 3 (only show for Form 1) - moved to header as top tabs -->
            <div id="upload-tabs-wrap" class="flex items-end gap-2 text-sm" style="display:none">
              <button id="tab-gate1" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm">Gate 1: B√°o c√°o LK/M√°y</button>
              <button id="tab-gate2" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm">Gate 2: B√°o c√°o m√°y Base, r√† so√°t tem nh√£n</button>
              <button id="tab-gate3" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm" style="display:none">Gate 3: C·∫≠p nh·∫≠t b√°o c√°o</button>
            </div>
          </div>
          <h3 id="upload-title" class="text-base font-semibold text-gray-800">G·ª≠i b√°o c√°o</h3>
        </div>
        <div id="upload-content" class="p-4 space-y-3 min-h-[460px]">
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Ng∆∞·ªùi n·ªôp: <b class="ml-1" id="uploader-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">M√£: <b class="ml-1" id="uploader-code"></b></span>
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">T√°c v·ª•: <b class="ml-1" id="uploader-task"></b></span>
          </div>
          <div id="upload-form2-single">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t·ªáp b√°o c√°o</label>
            <div class="flex items-center gap-3">
              <input id="upload-file" type="file" class="hidden"/>
              <button id="upload-file-btn" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Ch·ªçn t·ªáp</button>
              <span id="upload-file-name" class="text-sm text-gray-600">Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">T·ªáp s·∫Ω g·ª≠i k√®m timestamp t·∫°i th·ªùi ƒëi·ªÉm g·ª≠i.</p>
          </div>
          <!-- Gate 1 heading (show only when Gate 1 active) -->
          <div id="gate1-title" class="mt-2 mb-1 text-3xl md:text-4xl font-bold text-cyan-700" style="display:none">Gate 1: B√°o c√°o LK/M√°y</div>
          <div id="upload-form1-split" style="display:none">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o PDF (.pdf)</label>
              <input id="upload-file-pdfzip" type="file" accept=".pdf" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .pdf.</p>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o Excel (.xlsx)</label>
              <input id="upload-file-xlsxzip" type="file" accept=".xlsx" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .xlsx.</p>
            </div>
          </div>
          <!-- Gate 1 extra: Ph√¢n lo·∫°i -->
          <div id="upload-classification-group" class="mt-3 highlight-section" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ph√¢n lo·∫°i</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-classification" value="S·∫£n ph·∫©m" class="h-4 w-4"/>
                <span class="text-sm">S·∫£n ph·∫©m</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-classification" value="Linh ki·ªán" class="h-4 w-4"/>
                <span class="text-sm">Linh ki·ªán</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-classification" value="T√°c v·ª• kh√°c" class="h-4 w-4"/>
                <span class="text-sm">T√°c v·ª• kh√°c</span>
              </label>
            </div>
            <div id="classification-note" class="mt-2 text-xs text-gray-500" style="display:none"></div>
          </div>
          <!-- Gate 1 extra: Conclusion (radio) -->
          <div id="upload-conclusion-group" class="mt-3 highlight-section" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">K·∫øt lu·∫≠n</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-conclusion" value="S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                <span class="text-sm">S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-conclusion" value="S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                <span class="text-sm">S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-conclusion" value="B√°o c√°o tham kh·∫£o" class="h-4 w-4"/>
                <span class="text-sm">B√°o c√°o tham kh·∫£o</span>
              </label>
            </div>
          </div>
          <!-- Gate 1 extra: Khai b√°o test b·ªÅn -->
          <div id="upload-durability-group" class="mt-3 highlight-section" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">Khai b√°o test b·ªÅn</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="durability-choice" value="co" class="h-4 w-4"/>
                <span class="text-sm">C√≥ test b·ªÅn</span>
              </label>
              <div id="durability-date-wrap" class="ml-6 mt-1" style="display:none">
                <label class="block text-xs text-gray-600 mb-1">Ng√†y d·ª± ki·∫øn tr·∫£ test b·ªÅn</label>
                <input id="durability-date" type="date" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="durability-choice" value="khong" class="h-4 w-4"/>
                <span class="text-sm">Kh√¥ng test b·ªÅn</span>
              </label>
            </div>
          </div>
          <!-- Gate 2: ch·ªâ nh·∫≠n file n√©n (.zip/.rar/.7z) -->
          <div id="upload-gate2" class="mt-3" style="display:none">
            <div id="gate2-title" class="mb-2 text-3xl md:text-4xl font-bold text-cyan-700">Gate 2: B√°o c√°o m√°y Base, r√† so√°t tem nh√£n</div>
            <label class="block text-sm font-medium text-gray-700 mb-1">T·ªáp n√©n b√°o c√°o (Gate 2)</label>
            <input id="upload-file-archive-g2" type="file" accept=".zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp n√©n: .zip, .rar, .7z</p>
            <!-- Gate 2 extra: Ph√¢n lo·∫°i -->
            <div id="upload-classification-group-g2" class="mt-3 highlight-section" style="display:none">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ph√¢n lo·∫°i</label>
              <div class="flex flex-col gap-2">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="upload-classification-g2" value="S·∫£n ph·∫©m" class="h-4 w-4"/>
                  <span class="text-sm">S·∫£n ph·∫©m</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="upload-classification-g2" value="Linh ki·ªán" class="h-4 w-4"/>
                  <span class="text-sm">Linh ki·ªán</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="upload-classification-g2" value="T√°c v·ª• kh√°c" class="h-4 w-4"/>
                  <span class="text-sm">T√°c v·ª• kh√°c</span>
                </label>
              </div>
            </div>
          </div>
          <!-- Gate 3: C·∫≠p nh·∫≠t b√°o c√°o (ch·ªâ hi·ªÉn th·ªã khi t√°c v·ª• ƒë√£ done) -->
          <div id="upload-gate3" class="mt-3" style="display:none">
            <div id="gate3-title" class="mb-2 text-3xl md:text-4xl font-bold text-cyan-700">Gate 3: C·∫≠p nh·∫≠t b√°o c√°o</div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o PDF (.pdf)</label>
              <input id="upload-file-pdfzip-g3" type="file" accept=".pdf" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .pdf.</p>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o Excel (.xlsx)</label>
              <input id="upload-file-xlsxzip-g3" type="file" accept=".xlsx" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .xlsx.</p>
            </div>
            <!-- Gate 3: K·∫øt lu·∫≠n -->
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">K·∫øt lu·∫≠n</label>
              <div class="flex flex-col gap-2">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="upload-conclusion-g3" value="S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                  <span class="text-sm">S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="upload-conclusion-g3" value="S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                  <span class="text-sm">S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="upload-conclusion-g3" value="B√°o c√°o tham kh·∫£o" class="h-4 w-4"/>
                  <span class="text-sm">B√°o c√°o tham kh·∫£o</span>
                </label>
              </div>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">N·ªôi dung c·∫≠p nh·∫≠t</label>
              <textarea id="upload-gate3-content" rows="5" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white resize-y" placeholder="Nh·∫≠p n·ªôi dung c·∫≠p nh·∫≠t b√°o c√°o..."></textarea>
              <p class="text-xs text-gray-500 mt-1">Gate 3 ch·ªâ s·ª≠ d·ª•ng khi t√°c v·ª• ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh (Done).</p>
            </div>
          </div>
          <div id="bps-option" class="flex items-center gap-2">
            <input id="upload-bps" type="checkbox" class="h-4 w-4" checked>
            <label for="upload-bps" class="text-sm text-gray-700 select-none">Tr·∫£ b√°o c√°o BPS</label>
          </div>
        </div>
        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
          <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i b√°o c√°o</button>
        </div>
      </div>
    </div>

    <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
      <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="detail-title" class="text-base font-semibold text-gray-800">Nhi·ªám v·ª• c·ªßa <span id="detail-name" class="text-primary-blue"></span></h3>
          <button id="detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
        </div>
        <div class="p-4">
          <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
            <table class="min-w-[1400px] w-full text-sm">
              <tbody id="detail-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
          <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
        </div>
      </div>
    </div>

    <!-- Modal: Danh s√°ch t√°c v·ª• nh·∫≠n trong th√°ng (Form 5 - theo requestDate) -->
    <div id="rq-detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="rq-detail-title">
      <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="rq-detail-title" class="text-base font-semibold text-gray-800">T√°c v·ª• nh·∫≠n trong th√°ng c·ªßa <span id="rq-detail-name" class="text-primary-blue"></span></h3>
          <button id="rq-detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
        </div>
        <div class="p-4">
          <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
            <table class="min-w-[1200px] w-full text-sm">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">STT</th>
                  <th class="px-3 py-2">M√£</th>
                  <th class="px-3 py-2">T√™n t√°c v·ª•</th>
                  <th class="px-3 py-2">Ng√†y y√™u c·∫ßu</th>
                  <th class="px-3 py-2" title="T·ªïng c√¥ng chu·∫©n c·ªßa sheet (TCKT) v√† sheet (THEM) c·ªßa b√°o c√°o">C√¥ng chu·∫©n</th>
                  <th class="px-3 py-2" title="Kho·∫£ng th·ªùi gian t·ª´ l√∫c t·∫£i (n·ªôp)form ƒë·∫øn khi k·∫øt qu·∫£ b√°o c√°o ƒë∆∞·ª£c g·ª≠i ƒëi (T√≠nh trong gi·ªù h√†nh ch√≠nh)">S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø</th>
                  <th class="px-3 py-2">H·∫°n mong mu·ªën</th>
                  <th class="px-3 py-2">Ng√†y ho√†n th√†nh</th>
                  <th class="px-3 py-2">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="rq-detail-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Form 10 - B·∫£ng c√¥ng (theo th√°ng) -->
    <div id="f10-attendance-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f10-attendance-title">
      <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="f10-attendance-title" class="text-base font-semibold text-gray-800">B·∫£ng c√¥ng theo th√°ng - <span id="f10-attendance-month-display" class="text-primary-blue"></span></h3>
          <button id="f10-attendance-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800 hover:bg-slate-200 transition-colors">ƒê√≥ng</button>
        </div>
        <div class="p-4">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-700 font-medium">Th√°ng:</label>
              <input id="f10-att-modal-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              <button id="f10-att-modal-search" class="submit-btn px-4 py-2 text-white text-sm font-semibold transition">Tra c·ª©u</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="f10-att-modal-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 text-sm">Xu·∫•t XLSX</button>
              <a id="f10-att-modal-detail-link" href="https://docs.google.com/spreadsheets/d/1vTaH-tOBv5GZ64Ij34mFyDH3r_7tkaVYCpheyOtDckU/" target="_blank" rel="noopener" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 text-sm">Gi·ªù c√¥ng chi ti·∫øt</a>
            </div>
          </div>
          <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
            <table class="min-w-[800px] w-full text-sm">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-gray-700">
                  <th class="px-3 py-2 text-center">STT</th>
                  <th class="px-3 py-2 text-center">Nh√¢n s·ª±</th>
                  <th class="px-3 py-2 text-center">S·ªë ng√†y ƒëi l√†m (th√°ng)</th>
                  <th class="px-3 py-2 text-center">T·ªïng gi·ªù tƒÉng ca (th√°ng)</th>
                  <th class="px-3 py-2 text-center">T·ªïng gi·ªù c√¥ng ƒëi l√†m</th>
                </tr>
              </thead>
              <tbody id="f10-att-modal-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Form 5 Submit Modal -->
    <div id="f5-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f5-modal-title">
      <div class="w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
          <h3 id="f5-modal-title" class="text-base font-semibold text-gray-800">N·ªôp √Ω t∆∞·ªüng c·∫£i ti·∫øn</h3>
        </div>
        <div class="p-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y</label>
              <input id="f5-date" type="date" readonly class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
              <p class="text-gray-500 text-xs mt-1">C·ªë ƒë·ªãnh theo ng√†y nh·∫≠p</p>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Nh√¢n vi√™n</label>
              <select id="f5-employee" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
                <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng</label>
              <input id="f5-title" type="text" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">V·∫•n ƒë·ªÅ nh·∫≠n di·ªán</label>
              <textarea id="f5-problem" rows="3" placeholder="M√¥ t·∫£ v·∫•n ƒë·ªÅ" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Gi·∫£i ph√°p</label>
              <textarea id="f5-solution" rows="3" placeholder="M√¥ t·∫£ gi·∫£i ph√°p" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
            </div>
          </div>
        </div>
        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="f5-btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
          <button id="f5-btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i √Ω t∆∞·ªüng</button>
        </div>
      </div>
    </div>

    <!-- Form 6: Modal xem √Ω t∆∞·ªüng theo nh√¢n vi√™n -->
    <div id="f6-ideas-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f6-ideas-title">
      <div class="w-full max-w-4xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="f6-ideas-title" class="text-base font-semibold text-gray-800">√ù t∆∞·ªüng c·ªßa <span id="f6-ideas-name" class="text-primary-blue"></span></h3>
          <button id="f6-ideas-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
        </div>
        <div class="p-4">
          <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
            <table class="min-w-[980px] w-full text-sm">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">Ng√†y n·ªôp</th>
                  <th class="px-3 py-2">Ti√™u ƒë·ªÅ</th>
                  <th class="px-3 py-2">V·∫•n ƒë·ªÅ nh·∫≠n di·ªán</th>
                  <th class="px-3 py-2">Gi·∫£i ph√°p</th>
                  <th class="px-3 py-2">√ù ki·∫øn tr∆∞·ªüng ph√≤ng</th>
                  <th class="px-3 py-2">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="f6-ideas-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Form 7 Modal ri√™ng bi·ªát - ƒê√É V√î HI·ªÜU H√ìA (d√πng form7-subpanel-modal thay th·∫ø) -->
    <!-- Modal c≈© n√†y kh√¥ng c√≤n s·ª≠ d·ª•ng, ƒë√£ thay b·∫±ng form7-subpanel-modal ·ªü d∆∞·ªõi -->
    <!--
    <div id="form7-modal-old-deprecated" class="modal" aria-hidden="true" style="display:none !important;">
      ...Modal c≈© ƒë√£ b·ªã v√¥ hi·ªáu h√≥a...
            </div>
    -->

    <!-- CE Review Modal -->
    <div id="ce-review-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-cyan-50 to-white border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-cyan-800">CE R√† so√°t</h3>
            <button id="ce-review-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
        </div>

        <div id="ce-review-content" class="p-4 space-y-4 min-h-[400px]">
          <!-- Th√¥ng tin t√°c v·ª• -->
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-cyan-50 border border-cyan-200">Ng∆∞·ªùi ph·ª• tr√°ch: <b class="ml-1" id="ce-review-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-cyan-50 border border-cyan-200">M√£ t√°c v·ª•: <b class="ml-1" id="ce-review-code"></b></span>
            <span class="px-3 py-1 rounded-full bg-cyan-50 border border-cyan-200">Task Name: <b class="ml-1" id="ce-review-task-name"></b></span>
          </div>

          <!-- N·ªôi dung CE r√† so√°t s·∫Ω ƒë∆∞·ª£c th√™m sau -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-gray-600 text-center">N·ªôi dung CE r√† so√°t s·∫Ω ƒë∆∞·ª£c khai b√°o sau</p>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="ce-review-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
          <button id="ce-review-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-cyan-600 hover:brightness-105">L∆∞u CE r√† so√°t</button>
        </div>
      </div>
    </div>

    <!-- 4M Review Modal -->
    <div id="4m-review-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-emerald-50 to-white border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-emerald-800">4M R√† so√°t</h3>
            <button id="4m-review-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
        </div>

        <div id="4m-review-content" class="p-4 space-y-4 min-h-[400px]">
          <!-- Th√¥ng tin t√°c v·ª• -->
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Ng∆∞·ªùi ph·ª• tr√°ch: <b class="ml-1" id="4m-review-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">M√£ t√°c v·ª•: <b class="ml-1" id="4m-review-code"></b></span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Task Name: <b class="ml-1" id="4m-review-task-name"></b></span>
          </div>

          <!-- N·ªôi dung 4M r√† so√°t s·∫Ω ƒë∆∞·ª£c th√™m sau -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-gray-600 text-center">N·ªôi dung 4M r√† so√°t s·∫Ω ƒë∆∞·ª£c khai b√°o sau</p>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="4m-review-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
          <button id="4m-review-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-emerald-600 hover:brightness-105">L∆∞u 4M r√† so√°t</button>
        </div>
      </div>
    </div>

    <!-- Form 8 Subpanel Modal -->
    <div id="form8-subpanel-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-emerald-50 to-white border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 id="form8-subpanel-title" class="text-lg font-semibold text-emerald-800">4M R√† so√°t - G·ª≠i d·ªØ li·ªáu</h3>
            <button id="form8-subpanel-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
        </div>

        <div id="form8-subpanel-content" class="p-4 space-y-4 min-h-[300px]">
          <!-- Th√¥ng tin t√°c v·ª• -->
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Ng∆∞·ªùi ph·ª• tr√°ch: <b class="ml-1" id="form8-subpanel-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">M√£ t√°c v·ª•: <b class="ml-1" id="form8-subpanel-code"></b></span>
            <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Task Name: <b class="ml-1" id="form8-subpanel-task-name"></b></span>
          </div>

          <!-- Form g·ª≠i d·ªØ li·ªáu -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫</label>
              <textarea id="form8-subpanel-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent" rows="4" placeholder="Nh·∫≠p ghi ch√∫ r√† so√°t..."></textarea>
            </div>
            <div>
              <label id="form8-subpanel-file-label" class="block text-sm font-medium text-gray-700 mb-1">ƒê√≠nh k√®m Excel (b·∫Øt bu·ªôc)</label>
              <input id="form8-subpanel-file" type="file" accept=".xlsx,.xls,.xlsm,.xlsb" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
              <p id="form8-subpanel-file-help" class="text-xs text-gray-500 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file Excel (.xlsx, .xls, .xlsm, .xlsb). Tick "Kh√¥ng c·∫ßn r√† so√°t" ƒë·ªÉ b·ªè qua.</p>
            </div>
          </div>

          <!-- Checkbox cho 4M -->
          <div class="flex items-center gap-2 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
            <input id="form8-subpanel-4m-checkbox" type="checkbox" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
            <label for="form8-subpanel-4m-checkbox" class="text-sm text-gray-700 cursor-pointer select-none">
              Kh√¥ng c·∫ßn r√† so√°t
            </label>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="form8-subpanel-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
          <button id="form8-subpanel-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-emerald-600 hover:brightness-105">G·ª≠i 4M r√† so√°t</button>
        </div>
      </div>
    </div>


    <!-- Form 7 Subpanel Modal -->
    <div id="form7-subpanel-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 id="form7-subpanel-title" class="text-lg font-semibold text-blue-800">CE/4M R√† so√°t - G·ª≠i d·ªØ li·ªáu</h3>
            <button id="form7-subpanel-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
        </div>

        <div id="form7-subpanel-content" class="p-4 space-y-4 min-h-[300px]">
          <!-- Th√¥ng tin t√°c v·ª• -->
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Ng∆∞·ªùi ph·ª• tr√°ch: <b class="ml-1" id="form7-subpanel-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">M√£ t√°c v·ª•: <b class="ml-1" id="form7-subpanel-code"></b></span>
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Task Name: <b class="ml-1" id="form7-subpanel-task-name"></b></span>
          </div>

          <!-- Form g·ª≠i d·ªØ li·ªáu -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫</label>
              <textarea id="form7-subpanel-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent" rows="4" placeholder="Nh·∫≠p ghi ch√∫ r√† so√°t..."></textarea>
            </div>
            <div>
              <label id="form7-subpanel-file-label" class="block text-sm font-medium text-gray-700 mb-1">ƒê√≠nh k√®m (t√πy ch·ªçn)</label>
              <input id="form7-subpanel-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
              <p id="form7-subpanel-file-help" class="text-xs text-gray-500 mt-1">H·ªó tr·ª£ m·ªçi ƒë·ªãnh d·∫°ng file ph·ªï bi·∫øn.</p>
            </div>
          </div>

          <!-- Checkbox cho CE -->
          <div id="form7-subpanel-ce-option" class="flex items-center gap-2 p-3 bg-cyan-50 border border-cyan-200 rounded-lg" style="display:none">
            <input id="form7-subpanel-ce-checkbox" type="checkbox" class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 rounded">
            <label for="form7-subpanel-ce-checkbox" class="text-sm text-gray-700 cursor-pointer select-none">
              T√°c v·ª• kh√¥ng c·∫ßn l√†m CE
            </label>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="form7-subpanel-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
          <button id="form7-subpanel-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i</button>
        </div>
      </div>
    </div>

    <!-- Modal: Khai b√°o m·∫´u b√†n giao -->
    <div id="sample-handover-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-orange-50 to-white border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-orange-800">Khai b√°o m·∫´u b√†n giao</h3>
            <button id="sample-handover-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
          </div>
        </div>

        <div class="p-4 space-y-4">
          <!-- Th√¥ng tin t√°c v·ª• -->
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-orange-50 border border-orange-200">Ng∆∞·ªùi ph·ª• tr√°ch: <b class="ml-1" id="sample-handover-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-orange-50 border border-orange-200">M√£ t√°c v·ª•: <b class="ml-1" id="sample-handover-code"></b></span>
          </div>
          <div class="text-sm text-gray-600 bg-blue-50 p-2 rounded">
            <b>Task Name:</b> <span id="sample-handover-task-name"></span>
          </div>

          <!-- 3 l·ª±a ch·ªçn -->
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn tr·∫°ng th√°i b√†n giao:</label>
            
            <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-green-50 hover:border-green-300 transition">
              <input type="radio" name="sample-handover-status" value="ƒê√£ b√†n giao" class="h-5 w-5 text-green-600 focus:ring-green-500">
              <div>
                <div class="font-semibold text-green-700">1. ƒê√£ b√†n giao</div>
                <div class="text-xs text-gray-500">M·∫´u ƒë√£ ƒë∆∞·ª£c b√†n giao ƒë·∫ßy ƒë·ªß</div>
              </div>
            </label>

            <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition">
              <input type="radio" name="sample-handover-status" value="Kh√¥ng c·∫ßn b√†n giao" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
              <div>
                <div class="font-semibold text-blue-700">2. Kh√¥ng c·∫ßn b√†n giao</div>
                <div class="text-xs text-gray-500">T√°c v·ª• kh√¥ng y√™u c·∫ßu b√†n giao m·∫´u</div>
              </div>
            </label>

            <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 hover:border-red-300 transition">
              <input type="radio" name="sample-handover-status" value="Kh√¥ng ƒë·ªß m·∫´u b√†n giao" class="h-5 w-5 text-red-600 focus:ring-red-500">
              <div>
                <div class="font-semibold text-red-700">3. Kh√¥ng ƒë·ªß m·∫´u b√†n giao</div>
                <div class="text-xs text-gray-500">M·∫´u ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ b√†n giao</div>
              </div>
            </label>
          </div>

          <!-- Ghi ch√∫ b·ªï sung -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫ (t√πy ch·ªçn)</label>
            <textarea id="sample-handover-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="3" placeholder="Nh·∫≠p ghi ch√∫ b·ªï sung n·∫øu c·∫ßn..."></textarea>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
          <button id="sample-handover-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">H·ªßy</button>
          <button id="sample-handover-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-orange-500 hover:brightness-105">X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>

  <!-- Modal Th·ªëng k√™ chi ti·∫øt -->
  <div id="modal-stats" class="modal" aria-hidden="true">
    <div class="w-full max-w-6xl bg-white rounded-xl shadow-lg p-6 flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between mb-4 flex-shrink-0">
        <h3 class="text-xl font-semibold text-blue-800" id="stats-title">Th·ªëng k√™ chi ti·∫øt</h3>
        <button data-close="modal-stats" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      
      <div id="stats-loading" class="text-center py-8 flex-shrink-0">
        <div class="spinner mx-auto mb-2"></div>
        <p class="text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>
      
      <div id="stats-content" class="hidden overflow-y-auto flex-1 pr-2">
        <!-- a. Th√¥ng tin c∆° b·∫£n -->
        <div class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">a. Th√¥ng tin c∆° b·∫£n</h4>
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div><span class="font-medium">M√£:</span> <span id="stats-ma" class="text-blue-700"></span></div>
              <div class="md:col-span-2"><span class="font-medium">Task Name:</span> <span id="stats-task-name" class="text-blue-700"></span></div>
              <div class="md:col-span-3"><span class="font-medium">K·∫øt lu·∫≠n (trang b√¨a):</span> <span id="stats-conclusion" class="text-blue-700"></span></div>
            </div>
          </div>
        </div>

        <!-- b. C√¥ng chu·∫©n -->
        <div class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">b. C√¥ng chu·∫©n</h4>
          <div class="bg-green-50 p-4 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
              <div><span class="font-medium">C√¥ng ∆∞·ªõc l∆∞·ª£ng:</span> <span id="stats-cong-uoc-luong" class="text-green-700"></span></div>
              <div><span class="font-medium">C√¥ng chu·∫©n ƒë·∫ßy ƒë·ªß:</span> <span id="stats-cong-chuan-day-du" class="text-green-700"></span></div>
              <div><span class="font-medium">S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø:</span> <span id="stats-cong-chuan-thuc-te" class="text-green-700"></span></div>
              <div><span class="font-medium">C√¥ng chu·∫©n ph·∫ßn PTC:</span> <span id="stats-cong-chuan-ptc" class="text-green-700"></span></div>
              <div><span class="font-medium">C√¥ng chu·∫©n ph·∫ßn B·ªï sung:</span> <span id="stats-cong-chuan-bo-sung" class="text-green-700"></span></div>
              <div><span class="font-medium">C√¥ng chu·∫©n th√™m:</span> <span id="stats-cong-chuan-them" class="text-green-700"></span></div>
              <div><span class="font-medium">T·ªïng c√¥ng chu·∫©n th·ª±c:</span> <span id="stats-tong-cong-chuan-thuc" class="text-green-700"></span></div>
              <div><span class="font-medium">S·ªë m·∫´u:</span> <span id="stats-so-mau" class="text-green-700"></span></div>
              <div><span class="font-medium">S·ªë m·∫´u Sheet Th√™m:</span> <span id="stats-so-mau-sheet-them" class="text-green-700"></span></div>
              <div class="md:col-span-4"><span class="font-medium">Nh·∫≠n x√©t PIC:</span> <span id="stats-nhan-xet-pic" class="text-green-700"></span></div>
            </div>
          </div>
        </div>

        <!-- c. Test b·ªÅn -->
        <div id="stats-section-c" class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">c. Test b·ªÅn</h4>
          <div class="bg-yellow-50 p-4 rounded-lg mb-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-3">
              <div><span class="font-medium">Test b·ªÅn:</span> <span id="stats-test-ben" class="text-yellow-800"></span></div>
              <div><span class="font-medium">D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn:</span> <span id="stats-test-ben-du-kien" class="text-yellow-800"></span></div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div id="stats-test-ben-1" class="bg-yellow-50 p-3 rounded-lg hidden">
              <div class="font-medium text-yellow-800 mb-1">Test b·ªÅn b√¨a 1</div>
              <div class="text-sm text-gray-700" id="stats-test-ben-1-content"></div>
            </div>
            <div id="stats-test-ben-2" class="bg-yellow-50 p-3 rounded-lg hidden">
              <div class="font-medium text-yellow-800 mb-1">Test b·ªÅn b√¨a 2</div>
              <div class="text-sm text-gray-700" id="stats-test-ben-2-content"></div>
            </div>
            <div id="stats-test-ben-3" class="bg-yellow-50 p-3 rounded-lg hidden">
              <div class="font-medium text-yellow-800 mb-1">Test b·ªÅn b√¨a 3</div>
              <div class="text-sm text-gray-700" id="stats-test-ben-3-content"></div>
            </div>
            <div id="stats-test-ben-4" class="bg-yellow-50 p-3 rounded-lg hidden">
              <div class="font-medium text-yellow-800 mb-1">Test b·ªÅn b√¨a 4</div>
              <div class="text-sm text-gray-700" id="stats-test-ben-4-content"></div>
            </div>
            <div id="stats-test-ben-5" class="bg-yellow-50 p-3 rounded-lg hidden">
              <div class="font-medium text-yellow-800 mb-1">Test b·ªÅn b√¨a 5</div>
              <div class="text-sm text-gray-700" id="stats-test-ben-5-content"></div>
            </div>
          </div>
        </div>

        <!-- d. Ti√™u chu·∫©n k·ªπ thu·∫≠t -->
        <div id="stats-section-d" class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">d. Ti√™u chu·∫©n k·ªπ thu·∫≠t</h4>
          <div class="bg-purple-50 p-4 rounded-lg">
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm">
              <div><span class="font-medium">H·∫°ng m·ª•c ƒë√°nh gi√° TCKT:</span> <span id="stats-total-tckt" class="text-purple-700"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c OK:</span> <span id="stats-ok" class="text-green-700"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c NG:</span> <span id="stats-ng" class="text-red-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c test b·ªÅn:</span> <span id="stats-test-ben-count" class="text-blue-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c kh√¥ng ƒë√°nh gi√°:</span> <span id="stats-not-eval" class="text-gray-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c kh√¥ng k·∫øt lu·∫≠n:</span> <span id="stats-not-conclusion" class="text-yellow-600"></span></div>
            </div>
          </div>
        </div>

        <!-- e. H·∫°ng m·ª•c th√™m -->
        <div id="stats-section-e" class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">e. H·∫°ng m·ª•c th√™m</h4>
          <div class="bg-orange-50 p-4 rounded-lg">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm mb-3">
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m:</span> <span id="stats-additional" class="text-orange-700"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m OK:</span> <span id="stats-additional-ok" class="text-green-700"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m NG:</span> <span id="stats-additional-ng" class="text-red-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m test b·ªÅn:</span> <span id="stats-additional-test-ben" class="text-blue-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m NA:</span> <span id="stats-additional-na" class="text-gray-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m KDG:</span> <span id="stats-additional-kdg" class="text-gray-600"></span></div>
              <div><span class="font-medium">H·∫°ng m·ª•c th√™m KKL:</span> <span id="stats-additional-kkl" class="text-gray-600"></span></div>
            </div>
            <div class="mt-2"><span class="font-medium">Nh·∫≠n x√©t H·∫°ng m·ª•c th√™m:</span> <span id="stats-additional-comment" class="text-orange-800"></span></div>
          </div>
        </div>

        <!-- f. R·ªßi ro v√† PTC -->
        <div id="stats-section-f" class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">f. R·ªßi ro v√† PTC</h4>
          <div class="bg-red-50 p-4 rounded-lg">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm mb-3">
              <div><span class="font-medium">R·ªßi ro v√† PTC:</span> <span id="stats-risk-ptc-total" class="text-red-700"></span></div>
              <div><span class="font-medium">PTC OK:</span> <span id="stats-ptc-ok" class="text-green-700"></span></div>
              <div><span class="font-medium">PTC NG:</span> <span id="stats-ptc-ng" class="text-red-600"></span></div>
              <div><span class="font-medium">PTC test b·ªÅn:</span> <span id="stats-ptc-test-ben" class="text-blue-600"></span></div>
              <div><span class="font-medium">PTC NA:</span> <span id="stats-ptc-na" class="text-gray-600"></span></div>
            </div>
            <div class="mt-2"><span class="font-medium">Nh·∫≠n x√©t PTC:</span> <span id="stats-ptc-comment" class="text-red-800"></span></div>
          </div>
        </div>

        <!-- g. AI ph√¢n t√≠ch -->
        <div id="stats-section-g" class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3 text-lg">g. AI ph√¢n t√≠ch</h4>
          <div class="space-y-4 mb-4">
            <div id="stats-test-1" class="bg-gray-50 p-4 rounded-lg hidden">
              <div class="font-semibold text-gray-800 mb-2">B√†i test 1</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">B√†i test:</span> <span id="stats-test-1-name" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti√™u chu·∫©n:</span> <span id="stats-test-1-standard" class="text-gray-700"></span></div>
                <div><span class="font-medium">ƒêi·ªÅu ki·ªán:</span> <span id="stats-test-1-condition" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti·∫øn ƒë·ªô:</span> <span id="stats-test-1-progress" class="text-gray-700"></span></div>
                <div class="md:col-span-2"><span class="font-medium">T√¨nh tr·∫°ng:</span> <span id="stats-test-1-status" class="text-gray-700"></span></div>
              </div>
            </div>
            <div id="stats-test-2" class="bg-gray-50 p-4 rounded-lg hidden">
              <div class="font-semibold text-gray-800 mb-2">B√†i test 2</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">B√†i test:</span> <span id="stats-test-2-name" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti√™u chu·∫©n:</span> <span id="stats-test-2-standard" class="text-gray-700"></span></div>
                <div><span class="font-medium">ƒêi·ªÅu ki·ªán:</span> <span id="stats-test-2-condition" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti·∫øn ƒë·ªô:</span> <span id="stats-test-2-progress" class="text-gray-700"></span></div>
                <div class="md:col-span-2"><span class="font-medium">T√¨nh tr·∫°ng:</span> <span id="stats-test-2-status" class="text-gray-700"></span></div>
              </div>
            </div>
            <div id="stats-test-3" class="bg-gray-50 p-4 rounded-lg hidden">
              <div class="font-semibold text-gray-800 mb-2">B√†i test 3</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">B√†i test:</span> <span id="stats-test-3-name" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti√™u chu·∫©n:</span> <span id="stats-test-3-standard" class="text-gray-700"></span></div>
                <div><span class="font-medium">ƒêi·ªÅu ki·ªán:</span> <span id="stats-test-3-condition" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti·∫øn ƒë·ªô:</span> <span id="stats-test-3-progress" class="text-gray-700"></span></div>
                <div class="md:col-span-2"><span class="font-medium">T√¨nh tr·∫°ng:</span> <span id="stats-test-3-status" class="text-gray-700"></span></div>
              </div>
            </div>
            <div id="stats-test-4" class="bg-gray-50 p-4 rounded-lg hidden">
              <div class="font-semibold text-gray-800 mb-2">B√†i test 4</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">B√†i test:</span> <span id="stats-test-4-name" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti√™u chu·∫©n:</span> <span id="stats-test-4-standard" class="text-gray-700"></span></div>
                <div><span class="font-medium">ƒêi·ªÅu ki·ªán:</span> <span id="stats-test-4-condition" class="text-gray-700"></span></div>
                <div><span class="font-medium">Ti·∫øn ƒë·ªô:</span> <span id="stats-test-4-progress" class="text-gray-700"></span></div>
                <div class="md:col-span-2"><span class="font-medium">T√¨nh tr·∫°ng:</span> <span id="stats-test-4-status" class="text-gray-700"></span></div>
              </div>
            </div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg mb-3">
            <h4 class="font-semibold text-purple-800 mb-2">Nh·∫≠n x√©t AI</h4>
            <div class="text-sm text-gray-700" id="stats-ai-comment"></div>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <h4 class="font-semibold text-red-800 mb-2">B·∫•t th∆∞·ªùng AI</h4>
            <div id="stats-abnormalities-list" class="space-y-2">
              <div class="text-sm text-gray-500 italic">Kh√¥ng c√≥ b·∫•t th∆∞·ªùng n√†o ƒë∆∞·ª£c ph√°t hi·ªán</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-6 flex items-center justify-end gap-2 flex-shrink-0">
        <button data-close="modal-stats" class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">ƒê√≥ng</button>
      </div>
    </div>
  </div>
 
    <div id="toast" class="toast"></div>

    <script>
      // Constants
      const FORM1_WEBHOOK_URL = "https://iatzhxxuk.tino.page/webhook/laydulieutacvu";
      // Form 1 - Tra c·ª©u d·ªØ li·ªáu theo t√™n (Lookup)
      const FORM1_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/4cdacd75-92ce-4156-aa79-62fc60f51730";
      const FORM1_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/TrabaocaoDQA";
      // Form 1 - Webhook t·∫£i form (khi system=1)
      const FORM1_DOWNLOAD_FORM_URL = "https://iatzhxxuk.tino.page/webhook/nuttaiform";
      // Form 1 - Webhook g·ª≠i b√°o c√°o cho system task (khi system=1)
      const FORM1_SYSTEM_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/SOPguibaocaoSPM";
      const FORM7_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/dc3b968a-2f2d-4746-98ac-48247555b9c9";
      // Ri√™ng b·∫£ng ph·ª• (subpanel) - Modal khai b√°o CE
      const FORM7_SUBPANEL_URL = "https://iatzhxxuk.tino.page/webhook/khaibaoce";
      const FORM2_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/congguiformbaocao";
      // Form 11 - Ki·ªÉm tra tr∆∞·ªõc b√°o c√°o
      const FORM11_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/doctruocbaocao";
      // Form 12 - M√£ danh m·ª•c (tra c·ª©u)
      const FORM12_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/tracuumadanhmuc";
      // Endpoint for Form 3 submission (single webhook; send form-data with optional files)
      const FORM3_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/form3guitacvu";
      // Endpoints for Form 6 (submit & list)
      const FORM6_SUBMIT_URL = "https://iatzhxxuk.tino.page/webhook/8e42168f-cb7b-44da-ae44-571f1e072d53";
      // Form 9 endpoints
      const FORM9_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/laydulieuform9";
      const FORM9_POST_URL = "https://iatzhxxuk.tino.page/webhook/Khaibaotestben";
      // Form 13 - H·ªá th·ªëng test b·ªÅn m·ªõi
      const FORM13_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/hethongtestbenmoi";
      const FORM6_LIST_URL = "https://iatzhxxuk.tino.page/webhook/7c18c686-7349-4d09-8769-e6a951096e73";
      // Backward-compat aliases for Form 6 handlers referencing FORM5_* names
      const FORM5_SUBMIT_URL = FORM6_SUBMIT_URL;
      const FORM5_LIST_URL = FORM6_LIST_URL;
      // Form 7 (CE/4M) lookup endpoint
      const FORM7_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/Form7tracuu";
      // Form 7 (CE/4M) post endpoint
      const FORM7_POST_URL = "https://iatzhxxuk.tino.page/webhook/dc3b968a-2f2d-4746-98ac-48247555b9c9";
      // Form 7: Khai b√°o m·∫´u b√†n giao endpoint
      const FORM7_SAMPLE_HANDOVER_URL = "https://iatzhxxuk.tino.page/webhook/Khaibaomau";
      // Form 8 (4M) lookup endpoint - GET
      const FORM8_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/laydulieuform8";
      // Form 8 (4M) post endpoint - POST (ƒë·ªÉ g·ª≠i d·ªØ li·ªáu khai b√°o)
      const FORM8_POST_URL = "https://iatzhxxuk.tino.page/webhook/a734cb2d-eaa2-490a-95f5-0ce2118eaa6b";
      // Form 9 endpoints ƒë√£ khai b√°o ·ªü tr√™n
      // Form 5 All (new single-source endpoint) - DEPRECATED: D√πng FORM5_P1_URL thay th·∫ø
      const FORM5_ALL_NEW_URL = "https://iatzhxxuk.tino.page/webhook/2c62c918-413c-49c3-99f6-49466f13c6d6";
      // Form 5 P1 (n8n processed data) - D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c aggregate v√† t√≠nh to√°n s·∫µn
      const FORM5_P1_URL = "https://iatzhxxuk.tino.page/webhook/form5-p1";
      // Form 5 P2 (n8n processed data) - Lu·ªìng ri√™ng cho P2
      const FORM5_P2_URL = "https://iatzhxxuk.tino.page/webhook/form5theP2";
      // Form 5 P3 (CE Review data)
      const FORM5_P3_URL = "https://iatzhxxuk.tino.page/webhook/tinhthep3p4";
      // Form 5 P4 (4M Review data)
      const FORM5_P4_URL = "https://iatzhxxuk.tino.page/webhook/tinhthep4";
      // Form 10 (Attendance) lookup endpoint - GET
      const FORM10_ATTENDANCE_URL = "https://iatzhxxuk.tino.page/webhook/tracuugiodilammoi";
      // Stats Detail endpoint
      const STATS_DETAIL_URL = 'https://iatzhxxuk.tino.page/webhook/817159ab-9a32-43dd-a2f2-a41c83b434ec';  // action=stats_detail
      // Version ho√° cache ƒë·ªÉ tr√°nh xung ƒë·ªôt/hi·ªÉn th·ªã sai gi·ªØa c√°c m√°y ho·∫∑c l·∫ßn tri·ªÉn khai
      const APP_CACHE_VERSION = "2025-09-25-f5a-v4";
      let F5_LAST_COUNT = 0;
      // Form 5 (All tasks) chart globals
      let F5A_CHART = null;
      // Dashboard charts for each tab
      let F5A_CHART_P1_STATUS = null;
      let F5A_CHART_P1_MANHOUR = null;
      let F5A_CHART_P2_COEFFICIENT = null;
      let F5A_CHART_P2_HOURS = null;
      let F5A_CHART_P3_CE = null;
      let F5A_CHART_P3_STATUS = null;
      let F5A_CHART_P4_CATEGORIES = null;
      let F5A_CHART_P4_OVERALL = null;
      let F5A_LAST_ROWS = [];
      let F5A_MODE = 'vertical';
      let F5A_CHART_MAN = null;
      let F5A_BASIS = 'rates';
      // T·∫°m th·ªùi v√¥ hi·ªáu ho√° ƒë·ªì th·ªã Form 5
      const F5A_DISABLE_CHARTS = true;
      let F5A_RAW_ALL = [];
      let F5A_RAW_META = { month: '' };
      // Form 5 P1: D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ n8n (aggregated data)
      let F5A_P1_DATA = null; // { success: true, data: [...], summary: {...}, month: "2025-08" }
      let F5A_P1_META = { month: '' };
      // Form 5 P2: D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ n8n (lu·ªìng ri√™ng)
      let F5A_P2_DATA = null; // { success: true, data: [...], summary: {...}, month: "2025-08" }
      let F5A_P2_META = { month: '' };
      // Form 5 P3: D·ªØ li·ªáu r√† so√°t CE
      let F5A_P3_RAW = [];
      let F5A_P3_META = { month: '' };
      // Form 5 P4: D·ªØ li·ªáu r√† so√°t 4M
      let F5A_P4_RAW = [];
      let F5A_P4_META = { month: '' };
      // Debug flag: b·∫≠t/t·∫Øt b·∫±ng localStorage key "f5a.debug" = '1'
      function f5aIsDebug(){ try{ return (localStorage.getItem('f5a.debug')||'') === '1'; }catch(_){ return false; } }
      // Form 5: C√¥ng chu·∫©n c·∫ßn nh·∫≠n (c√≥ th·ªÉ ch·ªânh t·∫°i ƒë√¢y)
      // Form 5: C√¥ng chu·∫©n c·∫ßn nh·∫≠n (ƒë√£ b·ªè, thay b·∫±ng d·ªØ li·ªáu Form 10)
      const F5A_NEED_MANHOUR_DEFAULT = 0;
      const F5A_NEED_MANHOUR_BY_NAME = {};
      // Form 7 rendering (clone of Form 2 with wording changes)
      let f7AllData = []; // L∆∞u t·∫•t c·∫£ d·ªØ li·ªáu Form 7
      let f7CurrentName = ''; // L∆∞u t√™n hi·ªán t·∫°i
      
      function displayForm7Data() {
        const body = document.getElementById('f7-body');
        const monthFilter = (document.getElementById('f7-month').value || '').trim();
        
        // L·ªçc d·ªØ li·ªáu theo th√°ng n·∫øu c√≥
        let filteredData = f7AllData;
        if (monthFilter) {
          // monthFilter c√≥ d·∫°ng "2025-01"
          filteredData = f7AllData.filter(item => {
            const dateStr = String(item.actualCompletionDate || '').trim();
            if (!dateStr) {
              return false;
            }
            
            // Parse nhi·ªÅu ƒë·ªãnh d·∫°ng ng√†y
            let parsedDate = null;
            
            try {
              // Th·ª≠ parse b·∫±ng toDateSafe
              const d = toDateSafe(dateStr);
              if (d && d instanceof Date && !isNaN(d.getTime())) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                parsedDate = `${year}-${month}`;
              }
            } catch(_) {}
            
            // N·∫øu ch∆∞a parse ƒë∆∞·ª£c, th·ª≠ regex
            if (!parsedDate) {
              // Th·ª≠ dd/mm/yyyy ho·∫∑c dd-mm-yyyy
              const ddmmyyyyMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
              if (ddmmyyyyMatch) {
                const m = ddmmyyyyMatch[2].padStart(2,'0');
                const y = ddmmyyyyMatch[3];
                parsedDate = `${y}-${m}`;
              }
            }
            
            if (!parsedDate) {
              // Th·ª≠ yyyy-mm-dd ho·∫∑c yyyy/mm/dd
              const yyyymmddMatch = dateStr.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
              if (yyyymmddMatch) {
                const y = yyyymmddMatch[1];
                const m = yyyymmddMatch[2].padStart(2,'0');
                parsedDate = `${y}-${m}`;
              }
            }
            
            return parsedDate === monthFilter;
          });
        }
        
        body.innerHTML = '';
        
        if (!filteredData.length) {
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Kh√¥ng c√≥ t√°c v·ª•'+ (monthFilter ? ' trong th√°ng ƒë√£ ch·ªçn' : '') +'.</td></tr>';
          return;
        }
        
        filteredData.forEach(rowData => {
          const tr = document.createElement('tr');
          const name = f7CurrentName;
          
          // Render theo c·∫•u tr√∫c Form 7 (ch·ªâ CE): M√£ t√°c v·ª•, Ng√†y ho√†n th√†nh th·ª±c t·∫ø, M√£ linh ki·ªán/m√°y, Task Name, M√£ B√°o c√°o, K·∫øt qu·∫£ ƒë√°nh gi√°, Ghi ch√∫, Khai b√°o CE, T√¨nh tr·∫°ng r√† so√°t, Ng√†y khai b√°o g·∫ßn nh·∫•t
          addTd(tr, rowData.taskId);
          addTd(tr, formatDdMmYyyy(rowData.actualCompletionDate));
          addTd(tr, rowData.code);
          addTd(tr, rowData.taskName);
          addTd(tr, rowData.reportCode);
          addTd(tr, rowData.evaluationResult);
          addTd(tr, rowData.notes);
          
          // C·ªôt Khai b√°o CE (button) - v·ªõi m√†u cyan
          const tdCeDeclare = document.createElement('td');
          tdCeDeclare.className = 'px-3 py-4 text-center bg-cyan-50 border border-gray-300';
          const btnCeDeclare = document.createElement('button');
          btnCeDeclare.className = 'px-3 py-1 rounded text-white bg-cyan-600 hover:brightness-105 text-sm font-medium';
          btnCeDeclare.textContent = 'Khai b√°o CE';
          btnCeDeclare.onclick = (e) => {
            e.preventDefault();
            if (btnCeDeclare.disabled) return;
            btnCeDeclare.disabled = true;
            btnCeDeclare.classList.add('opacity-50', 'pointer-events-none');
            openForm7SubpanelModal('ce', {
              name,
              Id: rowData.Id,
              code: rowData.code,
              taskId: rowData.taskId,
              taskName: rowData.taskName,
              reportCode: rowData.reportCode,
              evaluationResult: rowData.evaluationResult,
              notes: rowData.notes,
              ceReview: rowData.ceReview,
              ceDeclarationDate: rowData.ceDeclarationDate,
              fourMReview: rowData.fourMReview,
              fourMDeclarationDate: rowData.fourMDeclarationDate,
              f7emailassignee: rowData.f7emailassignee,
              rowData
            });
            setTimeout(() => {
              btnCeDeclare.disabled = false;
              btnCeDeclare.classList.remove('opacity-50', 'pointer-events-none');
            }, 300);
          };
          tdCeDeclare.appendChild(btnCeDeclare);
          tr.appendChild(tdCeDeclare);
          
          // C·ªôt T√¨nh tr·∫°ng r√† so√°t - v·ªõi m√†u cyan
          const tdCeReview = document.createElement('td');
          tdCeReview.className = 'px-3 py-4 bg-cyan-50 text-cyan-800 border border-gray-300';
          tdCeReview.textContent = rowData.ceReview || '';
          tr.appendChild(tdCeReview);
          
          // C·ªôt Ng√†y khai b√°o CE g·∫ßn nh·∫•t - v·ªõi m√†u cyan, hi·ªÉn th·ªã c·∫£ gi·ªù ph√∫t
          const tdCeDate = document.createElement('td');
          tdCeDate.className = 'px-3 py-4 bg-cyan-50 text-cyan-800 border border-gray-300';
          tdCeDate.textContent = formatDdMmYyyyHHmm(rowData.ceDeclarationDate) || '';
          tr.appendChild(tdCeDate);
          
          // C·ªôt Ghi ch√∫ n·ªôp CE - v·ªõi m√†u cyan
          const tdCeNotes = document.createElement('td');
          tdCeNotes.className = 'px-3 py-4 bg-cyan-50 text-cyan-800 border border-gray-300';
          tdCeNotes.textContent = rowData.ceNotes || '';
          tr.appendChild(tdCeNotes);
          
          // Khai b√°o m·∫´u b√†n giao (m√†u cam)
          const tdSampleDeclare = document.createElement('td');
          tdSampleDeclare.className = 'px-3 py-4 text-center bg-amber-50 border border-gray-300';
          const btnSample = document.createElement('button');
          btnSample.className = 'px-3 py-1 rounded text-white bg-orange-500 hover:brightness-105 text-sm font-medium';
          btnSample.textContent = 'Khai b√°o m·∫´u';
          btnSample.onclick = (e)=>{ 
            e.preventDefault(); 
            if (btnSample.disabled) return;
            btnSample.disabled = true;
            btnSample.classList.add('opacity-50', 'pointer-events-none');
            openSampleHandoverModal({
              name,
              ...rowData
            });
            setTimeout(() => {
              btnSample.disabled = false;
              btnSample.classList.remove('opacity-50', 'pointer-events-none');
            }, 300);
          };
          tdSampleDeclare.appendChild(btnSample);
          tr.appendChild(tdSampleDeclare);

          // T√¨nh tr·∫°ng m·∫´u b√†n giao (m√†u v√†ng nh·∫°t)
          const tdSampleStatus = document.createElement('td');
          tdSampleStatus.className = 'px-3 py-4 bg-amber-50 text-amber-800 border border-gray-300';
          tdSampleStatus.textContent = rowData.sampleHandoverStatus || '';
          tr.appendChild(tdSampleStatus);

          // Ghi ch√∫ b√†n giao m·∫´u (m√†u v√†ng nh·∫°t)
          const tdSampleNotes = document.createElement('td');
          tdSampleNotes.className = 'px-3 py-4 bg-amber-50 text-amber-800 border border-gray-300';
          tdSampleNotes.textContent = rowData.sampleHandoverNotes || '';
          tr.appendChild(tdSampleNotes);

          body.appendChild(tr);
        });
      }
      
      function restoreForm7FromCache() {
        try {
          const cached = LS.getJSON('f7.cache');
          if (!cached || !Array.isArray(cached.data) || !cached.data.length) return false;
          
          const body = document.getElementById('f7-body');
          const nameSelect = document.getElementById('f7-name');
          if (!body || !nameSelect) return false;
          
          // Kh√¥i ph·ª•c d·ªØ li·ªáu
          f7AllData = cached.data.slice();
          f7CurrentName = cached.name || '';
          
          // Kh√¥i ph·ª•c dropdown t√™n
          if (cached.name) {
            nameSelect.value = cached.name;
          }
          
          // Hi·ªÉn th·ªã d·ªØ li·ªáu
          displayForm7Data();
          
          return true;
        } catch(_) {
          return false;
        }
      }
      
      async function renderForm7(){
        const name = (document.getElementById('f7-name').value || '').trim();
        const body = document.getElementById('f7-body');
          if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
        body.innerHTML = "<tr><td colspan='14' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        try{
          const headerMapF7 = {
            header_taskId: 'M√£ t√°c v·ª•',
            header_actualCompletionDate: 'Ng√†y ho√†n th√†nh th·ª±c t·∫ø',
            header_code: 'M√£ linh ki·ªán/m√°y',
            header_taskName: 'Task Name',
            header_reportCode: 'M√£ B√°o c√°o',
            header_evaluationResult: 'K·∫øt qu·∫£ ƒë√°nh gi√°',
            header_notes: 'Ghi ch√∫',
            header_ceReview: 'T√¨nh tr·∫°ng r√† so√°t',
            header_ceDeclarationDate: 'Ng√†y khai b√°o g·∫ßn nh·∫•t',
            header_ceNotes: 'Ghi ch√∫ n·ªôp CE',
            header_4mReview: '4M r√† so√°t',
            header_4mDeclarationDate: 'Ng√†y khai b√°o 4M',
            header_f7emailassignee: 'F7emailassignee',
            header_sampleHandoverStatus: 'T√¨nh tr·∫°ng m·∫´u b√†n giao',
            header_sampleHandoverNotes: 'Ghi ch√∫ b√†n giao m·∫´u',
            field_taskId: 'taskId',
            field_actualCompletionDate: 'actualCompletionDate',
            field_code: 'code',
            field_taskName: 'taskName',
            field_reportCode: 'reportCode',
            field_evaluationResult: 'evaluationResult',
            field_notes: 'notes',
            field_ceReview: 'ceReview',
            field_ceDeclarationDate: 'ceDeclarationDate',
            field_ceNotes: 'ceNotes',
            field_4mReview: '4mReview',
            field_4mDeclarationDate: '4mDeclarationDate',
            field_f7emailassignee: 'f7emailassignee',
            field_sampleHandoverStatus: 'sampleHandoverStatus',
            field_sampleHandoverNotes: 'sampleHandoverNotes'
          };
          const params = new URLSearchParams({
            ...headerMapF7,
            action: 'form7_lookup',
            person_name: name,
            timestamp: new Date().toISOString()
          });
          const url = `${FORM7_LOOKUP_URL}?${params.toString()}`;
          const resp = await fetch(url, { method: 'GET' });
          const text = await resp.text();
          if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
          let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
          const rows = pickRows(data);
          if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Kh√¥ng c√≥ t√°c v·ª•.</td></tr>'; f7AllData=[]; return; }
          const getV = (obj, keys)=>{
            // Chu·∫©n ho√° key: b·ªè d·∫•u, lo·∫°i emoji/k√Ω t·ª± ƒë·∫∑c bi·ªát, g·ªôp kho·∫£ng tr·∫Øng
            const sanitize = (s)=>{
              try{
                const noDiacritics = String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
                const noEmoji = noDiacritics.replace(/[^\p{L}\p{N}\s_:\-]/gu,'');
                return noEmoji.toLowerCase().replace(/\s+/g,' ').trim();
              }catch(_){
                return String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
              }
            };
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{
              const v = obj[k];
              const k1 = String(k).toLowerCase();
              const k2 = k1.replace(/\s+/g,' ').trim();
              const k3 = sanitize(k);
              lower[k1] = v;
              lower[k2] = v;
              lower[k3] = v;
            });
            for(const k of keys){
              const c1 = String(k).toLowerCase();
              const c2 = c1.replace(/\s+/g,' ').trim();
              const c3 = sanitize(k);
              const v = (c1 in lower ? lower[c1] : (c2 in lower ? lower[c2] : lower[c3]));
              if(v!==undefined) return v;
            }
            return '';
          };
          // D·ª± ph√≤ng: t√¨m theo c·ª•m t·ª´ trong key ƒë√£ chu·∫©n ho√°
          const findBySanitizedIncludes = (obj, needle)=>{
            const san = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
            const target = san(needle);
            for (const k of Object.keys(obj||{})){
              const kk = san(k);
              if (kk.includes(target)) return obj[k];
            }
            return '';
          };
          
          // Parse t·∫•t c·∫£ d·ªØ li·ªáu
          f7AllData = [];
          f7CurrentName = name;
          rows.forEach(item=>{
            // Kh·ªõp theo t√™n "Assignee" t·ª´ server v·ªõi l·ª±a ch·ªçn trong √¥ t√™n Form 8
            try{
              const assignee = getV(item,[
                'Assignee','assignee','employee','nh√¢n vi√™n','nhan vien','nhanvien',
                't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien','ph·ª• tr√°ch','phu trac','phutrac'
              ]);
              if (assignee && typeof sameName === 'function'){
                if (!sameName(String(assignee||''), String(name||''))) return; // b·ªè n·∫øu kh√¥ng tr√πng t√™n ch·ªçn
              } else {
                // Fallback: so s√°nh kh√¥ng d·∫•u/kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
                const a = String(assignee||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
                const b = String(name||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
                if (a && b && a !== b) return;
              }
            }catch(_){ }
            // L·∫•y d·ªØ li·ªáu theo c·∫•u tr√∫c m·ªõi: M√£ t√°c v·ª•, Ng√†y ho√†n th√†nh th·ª±c t·∫ø, M√£ linh ki·ªán/m√°y, Task Name, M√£ B√°o c√°o, K·∫øt qu·∫£ ƒë√°nh gi√°, Ghi ch√∫, CE r√† so√°t, Ng√†y khai b√°o CE, 4M r√† so√°t, Ng√†y khai b√°o 4M
            const taskId = getV(item,['taskid','task_id','ma_tac_vu','m√£ t√°c v·ª•','requestid','id']);
            const actualCompletionDate = getV(item,['actualcompletiondate','actual_completion_date','ngay_hoan_thanh_thuc_te','ng√†y ho√†n th√†nh th·ª±c t·∫ø','completion_date','ngay hoan thanh','ng√†y ho√†n th√†nh','actual_date']);
            const code = getV(item,['code','ma','taskcode','m√£','componentcode','ma_linh_kien','ma_linh_kien_may','m√£ linh ki·ªán/m√°y','ma linh kien may']);
            let taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•','Task Name','task_name']);
            if (!taskName) {
              taskName = findBySanitizedIncludes(item, 'task name') || findBySanitizedIncludes(item, 'ten tac vu');
            }
            const reportCode = getV(item,['reportcode','ma_bao_cao','m√£ b√°o c√°o','report_id','reportid','üÜî M√£ B√°o c√°o','ma bao cao']);
            const evaluationResult = getV(item,['evaluationresult','ket_qua_danh_gia','k·∫øt qu·∫£ ƒë√°nh gi√°','ket qua danh gia','result','ket_qua','k·∫øt qu·∫£','‚ÅâÔ∏è K·∫øt qu·∫£','ket qua']);
            const notes = getV(item,['notes','ghi_chu','ghi ch√∫','note','description','m√¥ t·∫£']);
            const ceReview = getV(item,['cereview','ce_ra_soat','ce r√† so√°t','ce review','ce_review','ce_status','CE r√† so√°t','tinh_trang_ra_soat','t√¨nh tr·∫°ng r√† so√°t','tinh trang ra soat','T√¨nh tr·∫°ng r√† so√°t']);
            const ceDeclarationDate = getV(item,['cedeclarationdate','ngay_khai_bao_ce','ng√†y khai b√°o ce','ngay khai bao ce','ce_date','ce declaration','ce_declaration','\nNg√†y khai b√°o CE']);
            // C·ªôt "Ghi ch√∫ n·ªôp CE" l√† c·ªôt m·ªõi, ch∆∞a c√≥ trong d·ªØ li·ªáu hi·ªán t·∫°i, ƒë·ªÉ tr·ªëng
            const ceNotes = getV(item,['Ghi ch√∫ n·ªôp CE','Ghi ch√∫ CE','Ghi chu nop CE','Ghi chu CE','ghi_chu_nop_ce','ghi_chu_ce','ce_notes']);
            const fourMReview = getV(item,['4mreview','4m_ra_soat','4m r√† so√°t','4m review','4m_review','4m_status','4M r√† so√°t']);
            const fourMDeclarationDate = getV(item,['4mdeclarationdate','ngay_khai_bao_4m','ng√†y khai b√°o 4m','ngay khai bao 4m','4m_date','4m declaration','4m_declaration','Ng√†y khai b√°o 4M']);
            const f7emailassignee = getV(item,['f7emailassignee','F7emailassignee','email_assignee','emailassignee','email assignee','assignee_email']);
            const sampleHandoverStatus = getV(item,['Bangiaomau','bangiaomau','samplehandoverstatus','sample_handover_status','tinh_trang_mau_ban_giao','t√¨nh tr·∫°ng m·∫´u b√†n giao','tinh trang mau ban giao','handover_status','sample_status','T√¨nh tr·∫°ng m·∫´u b√†n giao']);
            const sampleHandoverNotes = getV(item,['Ghichubangiao','ghichubangiao','samplehandovernotes','sample_handover_notes','ghi_chu_ban_giao_mau','ghi ch√∫ b√†n giao m·∫´u','ghi chu ban giao mau','handover_notes','sample_notes']);
            const id = getV(item,['Id','id','ID','_id']);
            
            const taskIdBest = pickTaskIdPreferQA(taskId, code);
            const rowData = { Id: id, taskId: taskIdBest, actualCompletionDate, code, taskName, reportCode, evaluationResult, notes, ceReview, ceDeclarationDate, ceNotes, fourMReview, fourMDeclarationDate, f7emailassignee, sampleHandoverStatus, sampleHandoverNotes };
            
            f7AllData.push(rowData);
          });
          
          // Hi·ªÉn th·ªã d·ªØ li·ªáu
          displayForm7Data();
          
          // L∆∞u cache v√† c·∫≠p nh·∫≠t timestamp
          try {
            LS.setJSON('f7.cache', {
              data: f7AllData,
              name: name,
              ts: Date.now()
            });
            LS.set('f7.lastUpdated', String(Date.now()));
            updateLastUpdatedNote('f7-search','f7.lastUpdated');
          } catch(_) {}
        }catch(err){
          body.innerHTML = `<tr><td colspan='14' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
        }
      }
      const f7SearchBtn = document.getElementById('f7-search');
      if (f7SearchBtn) {
        let f7Busy = false;
        f7SearchBtn.onclick = async (e)=>{
          e.preventDefault();
          if (f7Busy) return;
          f7Busy = true;
          f7SearchBtn.disabled = true;
          const prev = f7SearchBtn.textContent;
          f7SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
          try { await renderForm7(); }
          finally {
            f7Busy = false;
            f7SearchBtn.disabled = false;
            f7SearchBtn.textContent = prev;
          }
        };
      }
      
      // ===== Form 8: Tri·ªÉn khai 4M (s·ª≠ d·ª•ng chung ch·ª©c nƒÉng v·ªõi Form 7) =====
      let f8AllData = []; // L∆∞u t·∫•t c·∫£ d·ªØ li·ªáu Form 8
      let f8CurrentName = ''; // L∆∞u t√™n hi·ªán t·∫°i
      
      function displayForm8Data() {
        const body = document.getElementById('f8-body');
        const monthFilter = (document.getElementById('f8-month').value || '').trim();
        
        // L·ªçc d·ªØ li·ªáu theo th√°ng n·∫øu c√≥
        let filteredData = f8AllData;
        if (monthFilter) {
          filteredData = f8AllData.filter(item => {
            const dateStr = String(item.actualCompletionDate || '').trim();
            if (!dateStr) {
              return false;
            }
            
            // Parse nhi·ªÅu ƒë·ªãnh d·∫°ng ng√†y
            let parsedDate = null;
            
            try {
              // Th·ª≠ parse b·∫±ng toDateSafe
              const d = toDateSafe(dateStr);
              if (d && d instanceof Date && !isNaN(d.getTime())) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                parsedDate = `${year}-${month}`;
              }
            } catch(_) {}
            
            // N·∫øu ch∆∞a parse ƒë∆∞·ª£c, th·ª≠ regex
            if (!parsedDate) {
              // Th·ª≠ dd/mm/yyyy ho·∫∑c dd-mm-yyyy
              const ddmmyyyyMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
              if (ddmmyyyyMatch) {
                const m = ddmmyyyyMatch[2].padStart(2,'0');
                const y = ddmmyyyyMatch[3];
                parsedDate = `${y}-${m}`;
              }
            }
            
            if (!parsedDate) {
              // Th·ª≠ yyyy-mm-dd ho·∫∑c yyyy/mm/dd
              const yyyymmddMatch = dateStr.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
              if (yyyymmddMatch) {
                const y = yyyymmddMatch[1];
                const m = yyyymmddMatch[2].padStart(2,'0');
                parsedDate = `${y}-${m}`;
              }
            }
            
            return parsedDate === monthFilter;
          });
        }
        
        body.innerHTML = '';
        
        if (!filteredData.length) {
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Kh√¥ng c√≥ t√°c v·ª•'+ (monthFilter ? ' trong th√°ng ƒë√£ ch·ªçn' : '') +'.</td></tr>';
          return;
        }
        
        filteredData.forEach((rowData, index) => {
          const tr = document.createElement('tr');
          const isLastRow = index === filteredData.length - 1;
          tr.className = 'hover:bg-gray-50' + (isLastRow ? ' border-b border-gray-200' : '');
          const name = f8CurrentName;
          
          // Render theo c·∫•u tr√∫c Form 8 (ch·ªâ 4M): Khai b√°o, M√£ t√°c v·ª•, Ng√†y ho√†n th√†nh th·ª±c t·∫ø, M√£ linh ki·ªán/m√°y, Task Name, M√£ B√°o c√°o, K·∫øt qu·∫£ ƒë√°nh gi√°, Ghi ch√∫, T√¨nh tr·∫°ng r√† so√°t, Ng√†y khai b√°o g·∫ßn nh·∫•t, T·ª∑ l·ªá ho√†n th√†nh 4M
          
          // C·ªôt Khai b√°o - N√∫t m·ªü modal khai b√°o 4M
          const tdKhaiBao = document.createElement('td');
          tdKhaiBao.className = 'px-3 py-2 text-center border-r border-gray-200';
          const btnKhaiBao = document.createElement('button');
          btnKhaiBao.className = 'px-3 py-1 rounded text-white bg-emerald-600 hover:brightness-105 text-sm font-medium';
          btnKhaiBao.textContent = 'Khai b√°o';
          btnKhaiBao.onclick = (e) => {
            e.preventDefault();
            if (btnKhaiBao.disabled) return;
            btnKhaiBao.disabled = true;
            btnKhaiBao.classList.add('opacity-50', 'pointer-events-none');
            openForm8SubpanelModal({
              name,
              code: rowData.code,
              taskId: rowData.taskId,
              taskName: rowData.taskName,
              reportCode: rowData.reportCode,
              evaluationResult: rowData.evaluationResult,
              notes: rowData.notes,
              ceReview: rowData.ceReview,
              ceDeclarationDate: rowData.ceDeclarationDate,
              fourMReview: rowData.fourMReview,
              fourMDeclaration: rowData.fourMDeclaration,
              fourMDeclarationDate: rowData.fourMDeclarationDate,
              Id: rowData.Id || rowData.id || '',
              rowData
            });
            setTimeout(() => {
              btnKhaiBao.disabled = false;
              btnKhaiBao.classList.remove('opacity-50', 'pointer-events-none');
            }, 300);
          };
          tdKhaiBao.appendChild(btnKhaiBao);
          tr.appendChild(tdKhaiBao);
          
          addTdF8(tr, rowData.taskId);
          addTdF8(tr, formatDdMmYyyy(rowData.actualCompletionDate));
          addTdF8(tr, rowData.code);
          
          // Task Name - Clickable ƒë·ªÉ xem chi ti·∫øt 4M
          const tdTaskName = document.createElement('td');
          tdTaskName.className = 'px-3 py-2 border-r border-gray-200';
          const btnTaskName = document.createElement('button');
          btnTaskName.className = 'text-primary-blue hover:underline cursor-pointer text-left w-full';
          btnTaskName.textContent = rowData.taskName || '';
          btnTaskName.title = 'Click ƒë·ªÉ xem chi ti·∫øt % 4M';
          btnTaskName.onclick = (e) => {
            e.preventDefault();
            openF8_4MModal(rowData);
          };
          tdTaskName.appendChild(btnTaskName);
          tr.appendChild(tdTaskName);
          
          addTdF8(tr, rowData.reportCode);
          addTdF8(tr, rowData.evaluationResult);
          addTdF8(tr, rowData.notes);
          
          // C·ªôt T√¨nh tr·∫°ng r√† so√°t - B√¥i v√†ng n·∫øu kh√°c "C√≥"
          const tdReview = document.createElement('td');
          tdReview.className = 'px-3 py-4 align-top text-gray-800 border-r border-gray-200';
          const reviewValue = rowData.fourMReview || '';
          tdReview.textContent = reviewValue;
          
          // B√¥i v√†ng n·∫øu gi√° tr·ªã kh√°c "C√≥", "Kh√¥ng c·∫ßn r√† so√°t" v√† "Kh√¥ng c·∫ßn"
          if (reviewValue.toLowerCase() !== 'c√≥' && 
              reviewValue.toLowerCase() !== 'kh√¥ng c·∫ßn r√† so√°t' && 
              reviewValue.toLowerCase() !== 'kh√¥ng c·∫ßn') {
            tdReview.className += ' bg-yellow-100';
          }
          
          tr.appendChild(tdReview);
          
          // C·ªôt Ng√†y khai b√°o g·∫ßn nh·∫•t
          const tdLast = document.createElement('td');
          tdLast.className = 'px-3 py-4 align-top text-gray-800 border-r border-gray-200';
          const declarationDate = rowData.fourMDeclarationDate;
          if (declarationDate && declarationDate.trim() !== '') {
            // Hi·ªÉn th·ªã nguy√™n g·ªëc n·∫øu c√≥ d·ªØ li·ªáu
            tdLast.textContent = declarationDate;
          } else {
            tdLast.textContent = '';
          }
          tr.appendChild(tdLast);
          
          // C·ªôt m·ªõi - T·ª∑ l·ªá ho√†n th√†nh 4M (hi·ªÉn th·ªã "Trung b√¨nh 4M" t·ª´ b·∫£ng ph·ª•)
          const td4mRate = document.createElement('td');
          td4mRate.className = 'px-3 py-4 align-top text-gray-800 text-center';
          
          // L·∫•y d·ªØ li·ªáu "Trung b√¨nh 4M" t·ª´ rowData
          const fourmAverage = rowData.fourmAverage || rowData.fourMAverage || rowData['Trung b√¨nh 4M'] || '';
          
          if (fourmAverage && fourmAverage.toString().trim() !== '') {
            // Hi·ªÉn th·ªã gi√° tr·ªã v·ªõi ƒë·ªãnh d·∫°ng ph·∫ßn trƒÉm
            const value = parseFloat(fourmAverage);
            if (!isNaN(value)) {
              td4mRate.innerHTML = `
                <span class="font-semibold ${value >= 80 ? 'text-green-600' : value >= 50 ? 'text-blue-600' : 'text-orange-600'}">
                  ${value.toFixed(2)}%
                </span>
              `;
            } else {
              td4mRate.textContent = fourmAverage;
            }
          } else {
            td4mRate.textContent = '‚Äî';
          }
          tr.appendChild(td4mRate);
          
          body.appendChild(tr);
        });
      }
      
      function restoreForm8FromCache() {
        try {
          const cached = LS.getJSON('f8.cache');
          if (!cached || !Array.isArray(cached.data) || !cached.data.length) return false;
          
          const body = document.getElementById('f8-body');
          const nameSelect = document.getElementById('f8-name');
          if (!body || !nameSelect) return false;
          
          // Kh√¥i ph·ª•c d·ªØ li·ªáu
          f8AllData = cached.data.slice();
          f8CurrentName = cached.name || '';
          
          // Kh√¥i ph·ª•c dropdown t√™n
          if (cached.name) {
            nameSelect.value = cached.name;
          }
          
          // Hi·ªÉn th·ªã d·ªØ li·ªáu
          displayForm8Data();
          
          return true;
        } catch(_) {
          return false;
        }
      }
      
      // Form 8 s·ª≠ d·ª•ng chung renderForm7 nh∆∞ng v·ªõi action kh√°c
      async function renderForm8(){
        const name = (document.getElementById('f8-name').value || '').trim();
        const body = document.getElementById('f8-body');
          if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
        body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        try{
          const headerMapF8 = {
            header_F8_taskId: 'M√£ t√°c v·ª•',
            header_F8_actualCompletionDate: 'Ng√†y ho√†n th√†nh th·ª±c t·∫ø',
            header_F8_code: 'M√£ linh ki·ªán/m√°y',
            header_F8_taskName: 'Task Name',
            header_F8_reportCode: 'M√£ B√°o c√°o',
            header_F8_evaluationResult: 'K·∫øt qu·∫£ ƒë√°nh gi√°',
            header_F8_notes: 'Ghi ch√∫',
            header_F8_4mReview: 'T√¨nh tr·∫°ng r√† so√°t',
            header_F8_4mDeclaration: 'Khai b√°o 4M',
            header_F8_4mDeclarationDate: 'Ng√†y khai b√°o g·∫ßn nh·∫•t',
            // C√°c tr∆∞·ªùng % 4M
            header_F8_tckt: 'TCKT(% ho√†n th√†nh)',
            header_F8_ce: 'CE(% ho√†n th√†nh)',
            header_F8_hdkt: 'HDKT(% ho√†n th√†nh)',
            header_F8_bbDaoTao: 'BB ƒë√†o t·∫°o(% ho√†n th√†nh)',
            header_F8_jigTool: 'Jig tool(% ho√†n th√†nh)',
            header_F8_khkscl: 'KHKSCL(% ho√†n th√†nh)',
            field_F8_taskId: 'taskId',
            field_F8_actualCompletionDate: 'actualCompletionDate',
            field_F8_code: 'code',
            field_F8_taskName: 'taskName',
            field_F8_reportCode: 'reportCode',
            field_F8_evaluationResult: 'evaluationResult',
            field_F8_notes: 'notes',
            field_F8_4mReview: '4mReview',
            field_F8_4mDeclaration: '4mDeclaration',
            field_F8_4mDeclarationDate: '4mDeclarationDate',
            // Field mappings cho % 4M
            field_F8_tckt: 'tckt',
            field_F8_ce: 'ce',
            field_F8_hdkt: 'hdkt',
            field_F8_bbDaoTao: 'bbDaoTao',
            field_F8_jigTool: 'jigTool',
            field_F8_khkscl: 'khkscl'
          };
          const params = new URLSearchParams({
            ...headerMapF8,
            action: 'form8_lookup', // Form 8 c√≥ action ri√™ng
            person_name: name,
            assignee: name,
            timestamp: new Date().toISOString()
          });
          // G·ª≠i k√®m body meta ƒë·ªÉ server d·ªÖ ƒë·ªçc (ngo√†i query)
          try{
            const meta = {
              action: 'form8_lookup',
              person_name: name,
              assignee: name,
              timestamp_iso: new Date().toISOString()
            };
            params.append('body', JSON.stringify(meta));
          }catch(_){ }
          const url = `${FORM8_LOOKUP_URL}?${params.toString()}`;
          const resp = await fetch(url, { method: 'GET' });
          const text = await resp.text();
          if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
          let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
          const rows = pickRows(data);
          if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Kh√¥ng c√≥ t√°c v·ª•.</td></tr>'; f8AllData=[]; return; }
          const getV = (obj, keys)=>{
            // Chu·∫©n ho√° key: b·ªè d·∫•u, lo·∫°i emoji/k√Ω t·ª± ƒë·∫∑c bi·ªát, g·ªôp kho·∫£ng tr·∫Øng
            const sanitize = (s)=>{
              try{
                const noDiacritics = String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
                const noEmoji = noDiacritics.replace(/[^\p{L}\p{N}\s_:\-]/gu,'');
                return noEmoji.toLowerCase().replace(/\s+/g,' ').trim();
              }catch(_){
                return String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
              }
            };
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{
              const v = obj[k];
              const k1 = String(k).toLowerCase();
              const k2 = k1.replace(/\s+/g,' ').trim();
              const k3 = sanitize(k);
              lower[k1] = v;
              lower[k2] = v;
              lower[k3] = v;
            });
            for(const k of keys){
              const c1 = String(k).toLowerCase();
              const c2 = c1.replace(/\s+/g,' ').trim();
              const c3 = sanitize(k);
              const v = (c1 in lower ? lower[c1] : (c2 in lower ? lower[c2] : lower[c3]));
              if(v!==undefined) return v;
            }
            return '';
          };
          // D·ª± ph√≤ng: t√¨m theo c·ª•m t·ª´ trong key ƒë√£ chu·∫©n ho√°
          const findBySanitizedIncludes = (obj, needle)=>{
            const san = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
            const target = san(needle);
            for (const k of Object.keys(obj||{})){
              const kk = san(k);
              if (kk.includes(target)) return obj[k];
            }
            return '';
          };
          
          // Parse t·∫•t c·∫£ d·ªØ li·ªáu (ƒë·ªÉ server l·ªçc theo person_name; kh√¥ng l·ªçc t·∫°i ch·ªó theo Assignee)
          f8AllData = [];
          f8CurrentName = name;
          rows.forEach(item=>{
            // L·∫•y d·ªØ li·ªáu theo c·∫•u tr√∫c m·ªõi: M√£ t√°c v·ª•, Ng√†y ho√†n th√†nh th·ª±c t·∫ø, M√£ linh ki·ªán/m√°y, Task Name, M√£ B√°o c√°o, K·∫øt qu·∫£ ƒë√°nh gi√°, Ghi ch√∫, T√¨nh tr·∫°ng r√† so√°t, Ng√†y khai b√°o g·∫ßn nh·∫•t
            const taskId = getV(item,['M√£ t√°c v·ª•','m√£ t√°c v·ª•','taskid','task_id','ma_tac_vu','requestid','id']);
            const actualCompletionDate = getV(item,['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','ng√†y ho√†n th√†nh th·ª±c t·∫ø','actualcompletiondate','actual_completion_date','ngay_hoan_thanh_thuc_te','completion_date','ngay hoan thanh','ng√†y ho√†n th√†nh','actual_date']);
            const code = getV(item,['M√£ linh ki·ªán/m√°y','m√£ linh ki·ªán/m√°y','code','ma','taskcode','m√£','componentcode','ma_linh_kien','ma_linh_kien_may','ma linh kien may']);
            let taskName = getV(item,['Task Name','task name','taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•','task_name']);
            if (!taskName) {
              taskName = findBySanitizedIncludes(item, 'task name') || findBySanitizedIncludes(item, 'ten tac vu');
            }
            const reportCode = getV(item,['M√£ B√°o c√°o','m√£ b√°o c√°o','reportcode','ma_bao_cao','report_id','reportid','üÜî M√£ B√°o c√°o','ma bao cao']);
            const evaluationResult = getV(item,['K·∫øt qu·∫£ ƒë√°nh gi√°','k·∫øt qu·∫£ ƒë√°nh gi√°','evaluationresult','ket_qua_danh_gia','ket qua danh gia','result','ket_qua','k·∫øt qu·∫£','‚ÅâÔ∏è K·∫øt qu·∫£','ket qua']);
            const notes = getV(item,['Ghi ch√∫','ghi ch√∫','notes','ghi_chu','note','description','m√¥ t·∫£']);
            const fourMReview = getV(item,['T√¨nh tr·∫°ng r√† so√°t','t√¨nh tr·∫°ng r√† so√°t','4mreview','4m_ra_soat','4m r√† so√°t','4m review','4m_review','4m_status','4M r√† so√°t','tinh_trang_ra_soat','tinh trang ra soat']);
            const fourMDeclaration = getV(item,['Khai b√°o 4M','khai b√°o 4m','4m_declaration','4m declaration','khai_bao_4m','khai bao 4m']);
            const fourMDeclarationDate = getV(item,['Ng√†y khai b√°o g·∫ßn nh·∫•t','ng√†y khai b√°o g·∫ßn nh·∫•t','4mdeclarationdate','ngay_khai_bao_4m','ng√†y khai b√°o 4m','ngay khai bao 4m','4m_date','4m_declaration','Ng√†y khai b√°o 4M']);
            
            // L·∫•y c√°c tr∆∞·ªùng ph·∫ßn trƒÉm 4M
            const tckt = getV(item,['TCKT(% ho√†n th√†nh)','tckt(% ho√†n th√†nh)','TCKT','tckt','tckt%']);
            const ce = getV(item,['CE(% ho√†n th√†nh)','ce(% ho√†n th√†nh)','CE','ce','ce%']);
            const hdkt = getV(item,['HDKT(% ho√†n th√†nh)','hdkt(% ho√†n th√†nh)','HDKT','hdkt','hdkt%']);
            const bbDaoTao = getV(item,['BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o(% ho√†n th√†nh)','BB ƒë√†o t·∫°o','bb dao tao','bb%']);
            const jigTool = getV(item,['Jig tool(% ho√†n th√†nh)','jig tool(% ho√†n th√†nh)','Jig tool','jig tool','jig%']);
            const khkscl = getV(item,['KHKSCL(% ho√†n th√†nh)','khkscl(% ho√†n th√†nh)','KHKSCL','khkscl','khkscl%']);
            
            // T√≠nh to√°n "Trung b√¨nh 4M" (gi·ªëng nh∆∞ trong modal)
            const parsePercent = (val) => {
              if (!val || val === '') return 0;
              const s = String(val).replace('%', '').trim();
              const num = parseFloat(s);
              if (isNaN(num)) return 0;
              // If value is 0-1, convert to 0-100
              if (num >= 0 && num <= 1) return num * 100;
              // If already 0-100, use as is
              return num;
            };
            
            const avg4m = (parsePercent(tckt) + parsePercent(ce) + parsePercent(hdkt) + 
                          parsePercent(bbDaoTao) + parsePercent(jigTool) + parsePercent(khkscl)) / 6;
            
            const taskIdBest = pickTaskIdPreferQA(taskId, code);
            const id = getV(item,['Id','id','ID','_id']);
            const rowData = { 
              Id: id,
              taskId: taskIdBest, 
              actualCompletionDate, 
              code, 
              taskName, 
              reportCode, 
              evaluationResult, 
              notes, 
              fourMReview, 
              fourMDeclaration, 
              fourMDeclarationDate,
              // Th√™m c√°c tr∆∞·ªùng 4M percentages
              TCKT: tckt,
              CE: ce,
              HDKT: hdkt,
              'BB ƒë√†o t·∫°o': bbDaoTao,
              'Jig tool': jigTool,
              KHKSCL: khkscl,
              // Th√™m trung b√¨nh 4M
              fourmAverage: avg4m.toFixed(2)
            };
            
            f8AllData.push(rowData);
          });
          
          // Hi·ªÉn th·ªã d·ªØ li·ªáu
          displayForm8Data();
          
          // L∆∞u cache
          try {
            LS.setJSON('f8.cache', {
              data: f8AllData,
              name: name,
              ts: Date.now()
            });
          } catch(_) {}
        }catch(err){
          body.innerHTML = `<tr><td colspan='11' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
        }
      }

      // ===== Form 8: Xu·∫•t XLSX =====
      function f8RowsToAOA(items) {
        // Helper function ƒë·ªÉ format gi√° tr·ªã th√†nh ph·∫ßn trƒÉm
        const formatPercent = (val) => {
          if (!val || val === '') return '';
          const str = String(val).trim();
          // N·∫øu ƒë√£ c√≥ k√Ω hi·ªáu %, gi·ªØ nguy√™n nh∆∞ng ƒë·∫£m b·∫£o format ƒë√∫ng
          if (str.includes('%')) {
            const numStr = str.replace('%', '').trim();
            const num = parseFloat(numStr);
            if (isNaN(num)) return str;
            return num.toFixed(2) + '%';
          }
          // N·∫øu l√† s·ªë, format th√†nh ph·∫ßn trƒÉm
          const num = parseFloat(str);
          if (isNaN(num)) return str;
          // N·∫øu gi√° tr·ªã t·ª´ 0-1, chuy·ªÉn th√†nh 0-100%
          if (num >= 0 && num <= 1) {
            return (num * 100).toFixed(2) + '%';
          }
          // N·∫øu ƒë√£ l√† gi√° tr·ªã 0-100, th√™m k√Ω hi·ªáu %
          return num.toFixed(2) + '%';
        };

        // Header: Ng∆∞·ªùi ph·ª• tr√°ch, M√£ t√°c v·ª•, Ng√†y ho√†n th√†nh th·ª±c t·∫ø, M√£ linh ki·ªán/m√°y, Task Name, M√£ B√°o c√°o, 
        // K·∫øt qu·∫£ ƒë√°nh gi√°, Ghi ch√∫, T√¨nh tr·∫°ng r√† so√°t, Ng√†y khai b√°o g·∫ßn nh·∫•t,
        // TCKT(% ho√†n th√†nh), CE(% ho√†n th√†nh), HDKT(% ho√†n th√†nh), BB ƒë√†o t·∫°o(% ho√†n th√†nh), 
        // Jig tool(% ho√†n th√†nh), KHKSCL(% ho√†n th√†nh), Trung b√¨nh 4M
        const head = [
          'Ng∆∞·ªùi ph·ª• tr√°ch',
          'M√£ t√°c v·ª•',
          'Ng√†y ho√†n th√†nh th·ª±c t·∫ø',
          'M√£ linh ki·ªán/m√°y',
          'Task Name',
          'M√£ B√°o c√°o',
          'K·∫øt qu·∫£ ƒë√°nh gi√°',
          'Ghi ch√∫',
          'T√¨nh tr·∫°ng r√† so√°t',
          'Ng√†y khai b√°o g·∫ßn nh·∫•t',
          'TCKT(% ho√†n th√†nh)',
          'CE(% ho√†n th√†nh)',
          'HDKT(% ho√†n th√†nh)',
          'BB ƒë√†o t·∫°o(% ho√†n th√†nh)',
          'Jig tool(% ho√†n th√†nh)',
          'KHKSCL(% ho√†n th√†nh)',
          'Trung b√¨nh 4M'
        ];
        const aoa = [head];
        
        (Array.isArray(items) ? items : []).forEach(it => {
          const row = [
            it.personName || it.name || '',
            it.taskId || '',
            formatDdMmYyyy(it.actualCompletionDate) || it.actualCompletionDate || '',
            it.code || '',
            it.taskName || '',
            it.reportCode || '',
            it.evaluationResult || '',
            it.notes || '',
            it.fourMReview || '',
            it.fourMDeclarationDate || '',
            formatPercent(it.TCKT || it.tckt),
            formatPercent(it.CE || it.ce),
            formatPercent(it.HDKT || it.hdkt),
            formatPercent(it['BB ƒë√†o t·∫°o'] || it.bbDaoTao),
            formatPercent(it['Jig tool'] || it.jigTool),
            formatPercent(it.KHKSCL || it.khkscl),
            formatPercent(it.fourmAverage || it.fourMAverage || it['Trung b√¨nh 4M'])
          ];
          aoa.push(row);
        });
        return aoa;
      }

      async function f8DownloadXLSX() {
        try {
          const btnXlsx = document.getElementById('f8-export-xlsx');
          if (!btnXlsx) return;
          
          // Disable button v√† hi·ªÉn th·ªã loading
          btnXlsx.disabled = true;
          const prevText = btnXlsx.textContent;
          btnXlsx.innerHTML = "<span class='spinner mr-2'></span>ƒêang xu·∫•t...";
          
          // L·∫•y danh s√°ch t·∫•t c·∫£ ng∆∞·ªùi
          const allNames = Array.isArray(FORM8_NAMES) ? FORM8_NAMES.slice() : [];
          if (!allNames.length) {
            showToast('Form 8: Kh√¥ng c√≥ danh s√°ch ng∆∞·ªùi ƒë·ªÉ xu·∫•t.', 'error');
            btnXlsx.disabled = false;
            btnXlsx.textContent = prevText;
            return;
          }

          // Fetch d·ªØ li·ªáu t·ª´ng ng∆∞·ªùi
          const allData = [];
          const headerMapF8 = {
            header_F8_taskId: 'M√£ t√°c v·ª•',
            header_F8_actualCompletionDate: 'Ng√†y ho√†n th√†nh th·ª±c t·∫ø',
            header_F8_code: 'M√£ linh ki·ªán/m√°y',
            header_F8_taskName: 'Task Name',
            header_F8_reportCode: 'M√£ B√°o c√°o',
            header_F8_evaluationResult: 'K·∫øt qu·∫£ ƒë√°nh gi√°',
            header_F8_notes: 'Ghi ch√∫',
            header_F8_4mReview: 'T√¨nh tr·∫°ng r√† so√°t',
            header_F8_4mDeclaration: 'Khai b√°o 4M',
            header_F8_4mDeclarationDate: 'Ng√†y khai b√°o g·∫ßn nh·∫•t',
            header_F8_tckt: 'TCKT(% ho√†n th√†nh)',
            header_F8_ce: 'CE(% ho√†n th√†nh)',
            header_F8_hdkt: 'HDKT(% ho√†n th√†nh)',
            header_F8_bbDaoTao: 'BB ƒë√†o t·∫°o(% ho√†n th√†nh)',
            header_F8_jigTool: 'Jig tool(% ho√†n th√†nh)',
            header_F8_khkscl: 'KHKSCL(% ho√†n th√†nh)',
            field_F8_taskId: 'taskId',
            field_F8_actualCompletionDate: 'actualCompletionDate',
            field_F8_code: 'code',
            field_F8_taskName: 'taskName',
            field_F8_reportCode: 'reportCode',
            field_F8_evaluationResult: 'evaluationResult',
            field_F8_notes: 'notes',
            field_F8_4mReview: '4mReview',
            field_F8_4mDeclaration: '4mDeclaration',
            field_F8_4mDeclarationDate: '4mDeclarationDate',
            field_F8_tckt: 'tckt',
            field_F8_ce: 'ce',
            field_F8_hdkt: 'hdkt',
            field_F8_bbDaoTao: 'bbDaoTao',
            field_F8_jigTool: 'jigTool',
            field_F8_khkscl: 'khkscl'
          };

          // Helper functions ƒë·ªÉ parse d·ªØ li·ªáu
          const getV = (obj, keys) => {
            const sanitize = (s) => {
              try {
                const noDiacritics = String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                const noEmoji = noDiacritics.replace(/[^\p{L}\p{N}\s_:\-]/gu, '');
                return noEmoji.toLowerCase().replace(/\s+/g, ' ').trim();
              } catch (_) {
                return String(s || '').toLowerCase().replace(/\s+/g, ' ').trim();
              }
            };
            const lower = {};
            Object.keys(obj || {}).forEach(k => {
              const v = obj[k];
              const k1 = String(k).toLowerCase();
              const k2 = k1.replace(/\s+/g, ' ').trim();
              const k3 = sanitize(k);
              lower[k1] = v;
              lower[k2] = v;
              lower[k3] = v;
            });
            for (const k of keys) {
              const c1 = String(k).toLowerCase();
              const c2 = c1.replace(/\s+/g, ' ').trim();
              const c3 = sanitize(k);
              const v = (c1 in lower ? lower[c1] : (c2 in lower ? lower[c2] : lower[c3]));
              if (v !== undefined) return v;
            }
            return '';
          };

          const findBySanitizedIncludes = (obj, needle) => {
            const san = (s) => {
              try {
                return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/\s+/g, ' ').trim();
              } catch (_) {
                return String(s || '').toLowerCase().replace(/\s+/g, ' ').trim();
              }
            };
            const target = san(needle);
            for (const k of Object.keys(obj || {})) {
              const kk = san(k);
              if (kk.includes(target)) return obj[k];
            }
            return '';
          };


          // Fetch d·ªØ li·ªáu t·ª´ng ng∆∞·ªùi
          for (let i = 0; i < allNames.length; i++) {
            const name = allNames[i];
            try {
              const params = new URLSearchParams({
                ...headerMapF8,
                action: 'form8_lookup',
                person_name: name,
                assignee: name,
                timestamp: new Date().toISOString()
              });
              
              try {
                const meta = {
                  action: 'form8_lookup',
                  person_name: name,
                  assignee: name,
                  timestamp_iso: new Date().toISOString()
                };
                params.append('body', JSON.stringify(meta));
              } catch (_) {}

              const url = `${FORM8_LOOKUP_URL}?${params.toString()}`;
              const resp = await fetch(url, { method: 'GET' });
              const text = await resp.text();
              
              if (!resp.ok) {
                console.warn(`[Form8 Export] L·ªói khi fetch d·ªØ li·ªáu c·ªßa ${name}:`, text);
                continue;
              }

              let data = null;
              try {
                data = JSON.parse(text);
              } catch {
                data = null;
              }

              const rows = pickRows(data);
              if (!rows.length) continue;

              // Parse d·ªØ li·ªáu gi·ªëng nh∆∞ trong renderForm8
              rows.forEach(item => {
                const taskId = getV(item, ['M√£ t√°c v·ª•', 'm√£ t√°c v·ª•', 'taskid', 'task_id', 'ma_tac_vu', 'requestid', 'id']);
                const actualCompletionDate = getV(item, ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø', 'ng√†y ho√†n th√†nh th·ª±c t·∫ø', 'actualcompletiondate', 'actual_completion_date', 'ngay_hoan_thanh_thuc_te', 'completion_date', 'ngay hoan thanh', 'ng√†y ho√†n th√†nh', 'actual_date']);
                const code = getV(item, ['M√£ linh ki·ªán/m√°y', 'm√£ linh ki·ªán/m√°y', 'code', 'ma', 'taskcode', 'm√£', 'componentcode', 'ma_linh_kien', 'ma_linh_kien_may', 'ma linh kien may']);
                let taskName = getV(item, ['Task Name', 'task name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 't√™n t√°c v·ª•', 'task_name']);
                if (!taskName) {
                  taskName = findBySanitizedIncludes(item, 'task name') || findBySanitizedIncludes(item, 'ten tac vu');
                }
                const reportCode = getV(item, ['M√£ B√°o c√°o', 'm√£ b√°o c√°o', 'reportcode', 'ma_bao_cao', 'report_id', 'reportid', 'üÜî M√£ B√°o c√°o', 'ma bao cao']);
                const evaluationResult = getV(item, ['K·∫øt qu·∫£ ƒë√°nh gi√°', 'k·∫øt qu·∫£ ƒë√°nh gi√°', 'evaluationresult', 'ket_qua_danh_gia', 'ket qua danh gia', 'result', 'ket_qua', 'k·∫øt qu·∫£', '‚ÅâÔ∏è K·∫øt qu·∫£', 'ket qua']);
                const notes = getV(item, ['Ghi ch√∫', 'ghi ch√∫', 'notes', 'ghi_chu', 'note', 'description', 'm√¥ t·∫£']);
                const fourMReview = getV(item, ['T√¨nh tr·∫°ng r√† so√°t', 't√¨nh tr·∫°ng r√† so√°t', '4mreview', '4m_ra_soat', '4m r√† so√°t', '4m review', '4m_review', '4m_status', '4M r√† so√°t', 'tinh_trang_ra_soat', 'tinh trang ra soat']);
                const fourMDeclaration = getV(item, ['Khai b√°o 4M', 'khai b√°o 4m', '4m_declaration', '4m declaration', 'khai_bao_4m', 'khai bao 4m']);
                const fourMDeclarationDate = getV(item, ['Ng√†y khai b√°o g·∫ßn nh·∫•t', 'ng√†y khai b√°o g·∫ßn nh·∫•t', '4mdeclarationdate', 'ngay_khai_bao_4m', 'ng√†y khai b√°o 4m', 'ngay khai bao 4m', '4m_date', '4m_declaration', 'Ng√†y khai b√°o 4M']);

                // L·∫•y c√°c tr∆∞·ªùng ph·∫ßn trƒÉm 4M
                const tckt = getV(item, ['TCKT(% ho√†n th√†nh)', 'tckt(% ho√†n th√†nh)', 'TCKT', 'tckt', 'tckt%']);
                const ce = getV(item, ['CE(% ho√†n th√†nh)', 'ce(% ho√†n th√†nh)', 'CE', 'ce', 'ce%']);
                const hdkt = getV(item, ['HDKT(% ho√†n th√†nh)', 'hdkt(% ho√†n th√†nh)', 'HDKT', 'hdkt', 'hdkt%']);
                const bbDaoTao = getV(item, ['BB ƒë√†o t·∫°o(% ho√†n th√†nh)', 'bb ƒë√†o t·∫°o(% ho√†n th√†nh)', 'BB ƒë√†o t·∫°o', 'bb dao tao', 'bb%']);
                const jigTool = getV(item, ['Jig tool(% ho√†n th√†nh)', 'jig tool(% ho√†n th√†nh)', 'Jig tool', 'jig tool', 'jig%']);
                const khkscl = getV(item, ['KHKSCL(% ho√†n th√†nh)', 'khkscl(% ho√†n th√†nh)', 'KHKSCL', 'khkscl', 'khkscl%']);

                // T√≠nh to√°n "Trung b√¨nh 4M"
                const parsePercent = (val) => {
                  if (!val || val === '') return 0;
                  const s = String(val).replace('%', '').trim();
                  const num = parseFloat(s);
                  if (isNaN(num)) return 0;
                  if (num >= 0 && num <= 1) return num * 100;
                  return num;
                };

                const avg4m = (parsePercent(tckt) + parsePercent(ce) + parsePercent(hdkt) +
                  parsePercent(bbDaoTao) + parsePercent(jigTool) + parsePercent(khkscl)) / 6;

                const taskIdBest = pickTaskIdPreferQA(taskId, code);
                const rowData = {
                  personName: name,
                  taskId: taskIdBest,
                  actualCompletionDate,
                  code,
                  taskName,
                  reportCode,
                  evaluationResult,
                  notes,
                  fourMReview,
                  fourMDeclaration,
                  fourMDeclarationDate,
                  TCKT: tckt,
                  CE: ce,
                  HDKT: hdkt,
                  'BB ƒë√†o t·∫°o': bbDaoTao,
                  'Jig tool': jigTool,
                  KHKSCL: khkscl,
                  fourmAverage: avg4m.toFixed(2)
                };

                allData.push(rowData);
              });
            } catch (err) {
              console.warn(`[Form8 Export] L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu c·ªßa ${name}:`, err);
            }
          }

          if (!allData.length) {
            showToast('Form 8: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.', 'error');
            btnXlsx.disabled = false;
            btnXlsx.textContent = prevText;
            return;
          }

          // Chuy·ªÉn ƒë·ªïi sang m·∫£ng 2 chi·ªÅu v√† xu·∫•t file
          const aoa = f8RowsToAOA(allData);
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Form8');
          
          const now = new Date();
          const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
          XLSX.writeFile(wb, `Form8_All_${dateStr}.xlsx`);
          
          showToast(`Form 8: ƒê√£ xu·∫•t ${allData.length} d√≤ng d·ªØ li·ªáu t·ª´ ${allNames.length} ng∆∞·ªùi.`, 'success');
        } catch (err) {
          console.error('[Form8 Export] L·ªói:', err);
          showToast('Form 8: Xu·∫•t XLSX th·∫•t b·∫°i.', 'error');
        } finally {
          const btnXlsx = document.getElementById('f8-export-xlsx');
          if (btnXlsx) {
            btnXlsx.disabled = false;
            btnXlsx.textContent = 'Xu·∫•t XLSX';
          }
        }
      }

      // ===== Form 5: B·∫£ng ph·ª• P4 - chi ti·∫øt t√°c v·ª• theo nh√¢n vi√™n =====
      window.showP4TaskDetails = function(empName, month){
        try{
          const modal = document.getElementById('detail-modal');
          const title = document.getElementById('detail-title');
          const body = document.getElementById('detail-body');
          const note = document.getElementById('detail-note');
          if (!modal || !body) return;
          if (title) title.textContent = `Chi ti·∫øt t√°c v·ª• (P4) c·ªßa ${empName}`;
          note.textContent = 'Ch·ªâ hi·ªÉn th·ªã t√°c v·ª• Ph√¢n lo·∫°i = S·∫£n ph·∫©m';
          body.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>`;
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');

          const norm = (s)=> String(s||'').toLowerCase().trim();
          const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=> lower[norm(k)] = obj[k]); for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; } return ''; };
          const parseDate = (v)=>{ try{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/); if(m){ const d=new Date(+m[3],+m[2]-1,+m[1]); return isNaN(d)?null:d; } m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/); if(m){ const d=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(d)?null:d; } const d=new Date(s); return isNaN(d)?null:d; }catch(_){ return null; } };
          const fmt = (d)=>{ if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; };

          // L·ªçc t·ª´ F5A_P4_RAW theo nh√¢n vi√™n, th√°ng, ph√¢n lo·∫°i S·∫£n ph·∫©m
          const list = (Array.isArray(window.F5A_P4_RAW)? window.F5A_P4_RAW: []).filter(r=>{
            const name = String(getV(r,['assignee','employee','name','nh√¢n vi√™n','nhan vien','nhanvien','t√™n nh√¢n vi√™n','ten nhan vien','tennhanvien','ph·ª• tr√°ch','phu trac','phutrac'])||'').trim();
            if (!name || name.toLowerCase()==='x') return false;
            if ((typeof vnLower==='function' ? vnLower(name):name.toLowerCase()) !== (typeof vnLower==='function'? vnLower(empName):empName.toLowerCase())) return false;
            const cls = String(getV(r,['Ph√¢n lo·∫°i','phan loai','phanloai','classification','loai','lo·∫°i'])||'');
            const clsNorm = (typeof vnLower==='function') ? vnLower(cls) : cls.toLowerCase();
            if (clsNorm !== 'san pham' && clsNorm !== 's·∫£n ph·∫©m') return false;
            const dDone = parseDate(getV(r,['ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te','ng√†y ho√†n th√†nh','ngay hoan thanh','completion date','completiondate','actual completion date','actualcompletiondate']));
            const dCE = parseDate(getV(r,['Ng√†y khai b√°o CE','ngay khai bao ce','ng√†y khai b√°o ce','cedate','ce_date']));
            const d4M = parseDate(getV(r,['Ng√†y khai b√°o 4M','ngay khai bao 4m','ng√†y khai b√°o 4m','4m_date','4mdate']));
            const ref = dDone || dCE || d4M;
            if (month){ const ym = ref? `${ref.getFullYear()}-${String(ref.getMonth()+1).padStart(2,'0')}`:''; if (ym !== month) return false; }
            return true;
          });

          if (!list.length){ body.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; return; }
          // Header chi ti·∫øt: Code, Task, Ng√†y ho√†n th√†nh, TCKT, CE, HDKT, BB, Jig, KHKSCL, R√† so√°t 4M
          const head = `<tr class="bg-slate-100 text-sm font-semibold"><td class="px-3 py-2">M√£</td><td class="px-3 py-2">Task Name</td><td class="px-3 py-2">Ng√†y ho√†n th√†nh</td><td class="px-3 py-2">TCKT</td><td class="px-3 py-2">CE</td><td class="px-3 py-2">HDKT</td><td class="px-3 py-2">BB</td><td class="px-3 py-2">Jig</td><td class="px-3 py-2">KHKSCL</td><td class="px-3 py-2">R√† so√°t 4M</td></tr>`;
          const rowHtml = list.map(r=>{
            const code = getV(r,['M√£','code','ma','taskcode']);
            const tname = getV(r,['Task Name','taskname','t√™n t√°c v·ª•','ten_tac_vu','name']);
            const dDone = parseDate(getV(r,['ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te','ng√†y ho√†n th√†nh','ngay hoan thanh','completion date','completiondate']));
            const tckt = getV(r,['TCKT(% ho√†n th√†nh)','tckt(% ho√†n th√†nh)','tckt']);
            const ce = getV(r,['CE(% ho√†n th√†nh)','ce(% ho√†n th√†nh)','ce']);
            const hdkt = getV(r,['HDKT(% ho√†n th√†nh)','hdkt(% ho√†n th√†nh)','hdkt']);
            const bb = getV(r,['BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o','bb']);
            const jig = getV(r,['Jig tool(% ho√†n th√†nh)','jig tool(% ho√†n th√†nh)','jig tool','jig']);
            const kh = getV(r,['KHKSCL(% ho√†n th√†nh)','khkscl(% ho√†n th√†nh)','khkscl']);
            const fourM = getV(r,['4M r√† so√°t','4m r√† so√°t','4m ra soat','4M','4m rasoat','rasoat4m']);
            return `<tr><td class="px-3 py-2">${code||''}</td><td class="px-3 py-2">${tname||''}</td><td class="px-3 py-2">${fmt(dDone)||''}</td><td class="px-3 py-2">${tckt||''}</td><td class="px-3 py-2">${ce||''}</td><td class="px-3 py-2">${hdkt||''}</td><td class="px-3 py-2">${bb||''}</td><td class="px-3 py-2">${jig||''}</td><td class="px-3 py-2">${kh||''}</td><td class="px-3 py-2">${fourM||''}</td></tr>`;
          }).join('');
          body.innerHTML = head + rowHtml;
        }catch(err){ try{ console.error('showP4TaskDetails error', err); }catch(_){ } }
      };

      // Open modal hi·ªÉn th·ªã chi ti·∫øt 4M c·ªßa t√°c v·ª•
      function openF8_4MModal(taskData) {
        try {
          const modal = document.getElementById('f8-4m-modal');
          if (!modal) return;

          // Helper: parse v√† format ph·∫ßn trƒÉm
          const formatPercent = (v) => {
            if (!v || v === '') return '0%';
            const s = String(v).replace('%', '').trim();
            const num = parseFloat(s);
            if (isNaN(num)) return '0%';
            // If value is 0-1, convert to 0-100
            if (num >= 0 && num <= 1) return (num * 100).toFixed(1) + '%';
            // If already 0-100, use as is
            return num.toFixed(1) + '%';
          };

          // Fill modal data
          document.getElementById('f8-4m-task-id').textContent = taskData.taskId || '';
          document.getElementById('f8-4m-task-name').textContent = taskData.taskName || '';
          document.getElementById('f8-4m-completion-date').textContent = formatDdMmYyyy(taskData.actualCompletionDate) || '';

          // Fill percentages
          const tckt = formatPercent(taskData.TCKT);
          const ce = formatPercent(taskData.CE);
          const hdkt = formatPercent(taskData.HDKT);
          const bb = formatPercent(taskData['BB ƒë√†o t·∫°o']);
          const jig = formatPercent(taskData['Jig tool']);
          const khkscl = formatPercent(taskData.KHKSCL);

          document.getElementById('f8-4m-tckt').textContent = tckt;
          document.getElementById('f8-4m-ce').textContent = ce;
          document.getElementById('f8-4m-hdkt').textContent = hdkt;
          document.getElementById('f8-4m-bb').textContent = bb;
          document.getElementById('f8-4m-jig').textContent = jig;
          document.getElementById('f8-4m-khkscl').textContent = khkscl;

          // Calculate average
          const parseNum = (s) => {
            const n = parseFloat(String(s).replace('%', ''));
            return isNaN(n) ? 0 : n;
          };
          const avg = (parseNum(tckt) + parseNum(ce) + parseNum(hdkt) + parseNum(bb) + parseNum(jig) + parseNum(khkscl)) / 6;
          document.getElementById('f8-4m-avg').textContent = avg.toFixed(1) + '%';

          // Show modal
          modal.classList.add('open');
          modal.classList.remove('hidden');
          modal.setAttribute('aria-hidden', 'false');
        } catch (err) {
          console.error('[Form8] Error opening 4M modal:', err);
        }
      }

      function closeF8_4MModal() {
        const modal = document.getElementById('f8-4m-modal');
        if (!modal) return;
        modal.classList.remove('open');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
      }

      // Event listeners cho modal
      const f8_4MModalClose = document.getElementById('f8-4m-modal-close');
      const f8_4MModalCancel = document.getElementById('f8-4m-modal-cancel');
      const f8_4MModal = document.getElementById('f8-4m-modal');

      if (f8_4MModalClose) {
        f8_4MModalClose.addEventListener('click', (e) => {
          e.preventDefault();
          closeF8_4MModal();
        });
      }

      if (f8_4MModalCancel) {
        f8_4MModalCancel.addEventListener('click', (e) => {
          e.preventDefault();
          closeF8_4MModal();
        });
      }

      if (f8_4MModal) {
        f8_4MModal.addEventListener('click', (e) => {
          if (e.target === f8_4MModal) {
            closeF8_4MModal();
          }
        });
      }

      // Close v·ªõi ph√≠m Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && f8_4MModal && !f8_4MModal.classList.contains('hidden')) {
          closeF8_4MModal();
        }
      });

      const f8SearchBtn = document.getElementById('f8-search');
      if (f8SearchBtn) {
        let f8Busy = false;
        f8SearchBtn.onclick = async (e)=>{
          e.preventDefault();
          if (f8Busy) return;
          f8Busy = true;
          f8SearchBtn.disabled = true;
          const prev = f8SearchBtn.textContent;
          f8SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
          try { await renderForm8(); }
          finally {
            f8Busy = false;
            f8SearchBtn.disabled = false;
            f8SearchBtn.textContent = prev;
          }
        };
        // ƒê·ªïi t√™n -> auto re-search
        const f8Name = document.getElementById('f8-name');
        if (f8Name && !f8Name._bound){
          f8Name.addEventListener('change', async ()=>{
            try{
              if (f8Busy) return;
              f8Busy = true;
              const btn = f8SearchBtn; const prev = btn.textContent; btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
              try{ await renderForm8(); } finally { btn.disabled=false; btn.textContent=prev; f8Busy=false; }
            }catch(_){ }
          });
          f8Name._bound = true;
        }
      }
      
      // Form 8: Event listeners cho l·ªçc th√°ng
      const f8MonthInput = document.getElementById('f8-month');
      const f8ClearMonthBtn = document.getElementById('f8-clear-month');
      
      // M·∫∑c ƒë·ªãnh set th√°ng hi·ªán t·∫°i
      if (f8MonthInput) {
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        f8MonthInput.value = currentMonth;
        
        f8MonthInput.addEventListener('change', () => {
          if (f8AllData.length > 0) {
            displayForm8Data();
          }
        });
      }
      // (B·ªè l·ªçc t√™n t·∫°i ch·ªó theo y√™u c·∫ßu)
      
      if (f8ClearMonthBtn) {
        f8ClearMonthBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const f8MonthInput = document.getElementById('f8-month');
          if (f8MonthInput) {
            f8MonthInput.value = '';
            if (f8AllData.length > 0) {
              displayForm8Data();
            }
          }
        });
      }

      // Event listener cho n√∫t xu·∫•t XLSX Form 8
      const f8ExportXlsxBtn = document.getElementById('f8-export-xlsx');
      if (f8ExportXlsxBtn) {
        f8ExportXlsxBtn.addEventListener('click', (e) => {
          e.preventDefault();
          f8DownloadXLSX();
        });
      }
      
      // Form 7: Event listeners cho l·ªçc th√°ng
      const f7MonthInput = document.getElementById('f7-month');
      const f7ClearMonthBtn = document.getElementById('f7-clear-month');
      
      // M·∫∑c ƒë·ªãnh set th√°ng hi·ªán t·∫°i
      if (f7MonthInput) {
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        f7MonthInput.value = currentMonth;
        
        f7MonthInput.addEventListener('change', () => {
          if (f7AllData.length > 0) {
            displayForm7Data();
          }
        });
      }
      
      if (f7ClearMonthBtn) {
        f7ClearMonthBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const f7MonthInput = document.getElementById('f7-month');
          if (f7MonthInput) {
            f7MonthInput.value = '';
            if (f7AllData.length > 0) {
              displayForm7Data();
            }
          }
        });
      }

      function f5aGetNeedManhour(name){
        try{
          const monthEl = document.getElementById('f5a-month');
          const month = monthEl ? (monthEl.value||'') : '';
          const attMap = (typeof f5aGetAttendanceMapByMonth==='function') ? f5aGetAttendanceMapByMonth(month) : new Map();
          const resolved = (typeof resolveAlias==='function') ? resolveAlias(name) : name;
          const totalText = attMap.get(resolved) || attMap.get(name) || '';
          const n = (typeof parseNumberFlexible==='function') ? parseNumberFlexible(totalText) : Number(totalText);
          return Number.isFinite(n) ? n : '';
        }catch(_){ return ''; }
      }
      // Form 5: whitelist t√™n hi·ªÉn th·ªã (c√≥ th·ªÉ m·ªü r·ªông)
      const F5A_WHITELIST = [
        "ƒê·ªó Quang Long",
        "Ph·∫°m Th√†nh Trung Ki√™n",
        "L√™ Th·ªã Th·∫£o",
        "V≈© Th·ªã Thanh Hi·ªÅn",
        "L·∫°i Qu·ªëc L·ªôc",
        "L√™ Ng·ªçc √Ånh",
        "L√™ VƒÉn S∆°n",
        "Nguy·ªÖn Th·ªã Hi·ªÅn",
        "Ph·∫°m Th·ªã Minh",
      ];
      // B·ªï sung whitelist ri√™ng (t√πy ch·ªânh nhanh trong v·∫≠n h√†nh)
      const F5A_WHITELIST_EXTRA = [
        // Th√™m t√™n t·∫°i ƒë√¢y n·∫øu c·∫ßn m·ªü r·ªông t·∫°m th·ªùi
        // "H√† M·ªπ Linh",
      ];
      // Form 5: blacklist t√™n c·∫ßn ·∫©n kh·ªèi t·∫•t c·∫£ c√°c th·∫ª (P1, P2, P3, P4)
      const F5A_BLACKLIST = [
        "Nguy·ªÖn H·ªØu Th·ªãnh",
        "Tr·∫ßn Hi·∫øu Nghƒ©a",
        "ƒê√†o Tu·∫•n K·ª≥",
        "Th√°i Th·ªã Giang",
        "V≈© Th·ªã H·∫±ng",
        "B√πi ƒê·∫∑ng Qu·ªëc Huy",
        "ƒê√†o Ho√†ng D∆∞∆°ng",
      ];
      // Helper function ƒë·ªÉ normalize t√™n v√† ki·ªÉm tra blacklist
      function isNameInBlacklist(name) {
        if (!name) return false;
        const normalizeName = (s) => {
          try {
            const raw = String(s || '').trim();
            const noAcc = (typeof vnLower === 'function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            return noAcc.replace(/\s+/g, ' ').trim();
          } catch (_) {
            return String(s || '').toLowerCase().trim();
          }
        };
        const normalizedName = normalizeName(name);
        return F5A_BLACKLIST.some(blackName => normalizeName(blackName) === normalizedName);
      }
      // √Ånh x·∫° alias t√™n -> t√™n chu·∫©n (ƒëi·ªÅn key kh√¥ng d·∫•u/th∆∞·ªùng)
      const F5A_NAME_ALIASES = {
        // v√≠ d·ª•: "le thi thao": "L√™ Th·ªã Th·∫£o",
      };
      function vnKey(s){
        try{ return (String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim()); }catch(_){ return String(s||'').toLowerCase().trim(); }
      }
      function tokenSet(str){
        const arr = vnKey(str).split(' ').filter(Boolean);
        return new Set(arr);
      }
      function jaccard(aSet, bSet){
        let inter = 0; for (const t of aSet){ if (bSet.has(t)) inter++; }
        const union = aSet.size + bSet.size - inter;
        return union ? (inter/union) : 0;
      }
      const F5A_WHITELIST_KEYS = (function(){
        const base = (Array.isArray(F5A_WHITELIST)? F5A_WHITELIST: []).concat(Array.isArray(F5A_WHITELIST_EXTRA)? F5A_WHITELIST_EXTRA: []);
        return base.map(v=> ({ raw: v, key: vnKey(v), tokens: tokenSet(v) }));
      })();
      function resolveAlias(name){ const k=vnKey(name); const alias = F5A_NAME_ALIASES[k]; return alias || name; }
      function f5aIsWhitelisted(name){
        try{
          const resolved = resolveAlias(name);
          const key = vnKey(resolved);
          // So kh·ªõp tuy·ªát ƒë·ªëi
          if (F5A_WHITELIST_KEYS.some(x=> x.key === key)) return true;
          // So kh·ªõp t∆∞∆°ng ƒë·ªìng theo token-set (Jaccard)
          const toks = tokenSet(resolved);
          for (const ref of F5A_WHITELIST_KEYS){
            const sim = jaccard(toks, ref.tokens);
            if (sim >= 0.75) return true; // ng∆∞·ª°ng t∆∞∆°ng ƒë·ªìng 75%
          }
          return false;
        }catch(_){ return false; }
      }
      // Form 6 (ideas) cache for month filter
      let F6_LAST_ROWS = [];

      // ===== Form 5 (All tasks) - fetch once and aggregate locally =====
      function f5aPickRowsDeep(json){
        if (!json) return [];
        // If input already an array of objects
        if (Array.isArray(json) && json.length && typeof json[0] === 'object' && !Array.isArray(json[0])) return json;

        // Helper convert table [ [headers...], [...], ... ] -> array of objects
        const tableToObjects = (tbl)=>{
          try{
            if (!Array.isArray(tbl) || tbl.length < 2) return [];
            const header = Array.isArray(tbl[0]) ? tbl[0] : null;
            if (!header) return [];
            const keys = header.map(h=> String(h||'').trim());
            return tbl.slice(1).map(row=>{
              const obj = {};
              keys.forEach((k,i)=>{ obj[k] = Array.isArray(row) ? row[i] : undefined; });
              return obj;
            });
          }catch(_){ return []; }
        };

        // Prefer explicit properties at root
        let recs = [];
        if (Array.isArray(json?.records) && json.records.length && typeof json.records[0] === 'object') recs = json.records;
        let tabObjs = [];
        if (Array.isArray(json?.table)) tabObjs = tableToObjects(json.table);
        // Sheets support
        try{
          if ((!recs.length || !tabObjs.length) && Array.isArray(json?.sheets)){
            const sh = json.sheets.find(s => Array.isArray(s?.records) || Array.isArray(s?.table)) || json.sheets[0];
            if (sh){
              if (!recs.length && Array.isArray(sh.records) && sh.records.length && typeof sh.records[0]==='object') recs = sh.records;
              if (!tabObjs.length && Array.isArray(sh.table)) tabObjs = tableToObjects(sh.table);
            }
          }
        }catch(_){ }
        // Merge if both exist (prefer records fields, add missing rows from table by simple key)
        if (recs.length || tabObjs.length){
          if (recs.length && tabObjs.length){
            // KH√îNG deduplicate - gi·ªØ l·∫°i T·∫§T C·∫¢ c√°c t√°c v·ª•, k·ªÉ c·∫£ tr√πng m√£/nh√¢n vi√™n/th·ªùi gian
            // V√¨ c√≥ th·ªÉ c√≥ nhi·ªÅu t√°c v·ª• gi·ªëng nhau nh∆∞ng kh√°c nh√¢n vi√™n ho·∫∑c th·ªùi gian kh√°c
            const out = [];
            try{ if (!window.F5A_LOG) window.F5A_LOG = {}; if (!window.F5A_LOG.dupKeys) window.F5A_LOG.dupKeys = []; }catch(_){ }
            // Th√™m t·∫•t c·∫£ records
            recs.forEach(r=>{ out.push(r); });
            // Th√™m t·∫•t c·∫£ table objects (kh√¥ng ki·ªÉm tra tr√πng)
            tabObjs.forEach(t=>{ out.push(t); });
            try{ console.info('[F5A] Merge records+table:', { recs: recs.length, table: tabObjs.length, merged: out.length, dups: (window.F5A_LOG&&window.F5A_LOG.dupKeys)? window.F5A_LOG.dupKeys.length:0 }); }catch(_){ }
            return out;
          }
          return recs.length ? recs : tabObjs;
        }

        // Generic deep search fallback (find array of objects; convert table if found)
        try{
          const queue=[json]; const seen=new Set();
          while(queue.length){
            const cur = queue.shift(); if(!cur || typeof cur !== 'object' || seen.has(cur)) continue; seen.add(cur);
            // table inside
            if (Array.isArray(cur.table)){
              const conv = tableToObjects(cur.table); if (conv.length) return conv;
            }
            for (const v of Object.values(cur)){
              if (Array.isArray(v)){
                if (v.length && typeof v[0] === 'object' && !Array.isArray(v[0])) return v;
                // potential nested table
                if (v.length && Array.isArray(v[0])){
                  const conv2 = tableToObjects(v); if (conv2.length) return conv2;
                }
              }
              if (v && typeof v === 'object') queue.push(v);
            }
          }
        }catch(_){ }
        return [];
      }

      // Fetch Form 5 P1 data t·ª´ n8n (ƒë√£ ƒë∆∞·ª£c aggregate v√† t√≠nh to√°n s·∫µn)
      async function f5aFetchP1Data(month){
        // ƒê√£ b·ªè check cache ƒë·ªÉ cho ph√©p nh·∫•n t·∫£i l·∫°i d·ªØ li·ªáu m·ªói l·∫ßn nh·∫•n n√∫t
        // if (F5A_P1_DATA && F5A_P1_META && F5A_P1_META.month === (month||'')) return;
        try{
          const qs = new URLSearchParams();
          if (month) qs.append('month', month);
          qs.append('_ts', Date.now().toString());
          const url = `${FORM5_P1_URL}?${qs.toString()}`;
          const r = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();
          // n8n tr·∫£ v·ªÅ format: { json: { success: true, data: [...], summary: {...}, month: "2025-08" } }
          // Ho·∫∑c c√≥ th·ªÉ tr·∫£ v·ªÅ tr·ª±c ti·∫øp: { success: true, data: [...], ... }
          // Ho·∫∑c c√≥ th·ªÉ l√† array tr·ª±c ti·∫øp: [{...}, {...}]
          let response = null;
          let dataArray = null;
          
          // Tr∆∞·ªùng h·ª£p 1: Response l√† array tr·ª±c ti·∫øp
          if (Array.isArray(data) && data.length > 0) {
            // Ki·ªÉm tra n·∫øu ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n c√≥ structure { success, data, ... }
            const firstItem = data[0];
            if (firstItem && typeof firstItem === 'object' && Array.isArray(firstItem.data)) {
              // Array ch·ª©a object c√≥ data field - l·∫•y data t·ª´ object ƒë√≥
              dataArray = firstItem.data;
              response = {
                success: firstItem.success !== undefined ? firstItem.success : true,
                data: dataArray,
                month: firstItem.month || month || '',
                summary: firstItem.summary || {},
                dateRange: firstItem.dateRange || {}
              };
            } else {
              // Array ch·ª©a c√°c employee records tr·ª±c ti·∫øp
              dataArray = data;
              response = {
                success: true,
                data: dataArray,
                month: month || ''
              };
            }
          }
          // Tr∆∞·ªùng h·ª£p 2: Response c√≥ format { json: {...} }
          else if (data && typeof data === 'object' && 'json' in data) {
            response = data.json;
          }
          // Tr∆∞·ªùng h·ª£p 3: Response tr·ª±c ti·∫øp l√† object
          else if (data && typeof data === 'object' && !Array.isArray(data)) {
            response = data;
          }
          
          // L·∫•y data array t·ª´ response
          if (!dataArray && response) {
            if (Array.isArray(response.data)) {
              dataArray = response.data;
            } else if (Array.isArray(response)) {
              dataArray = response;
            }
          }
          
          // Ki·ªÉm tra n·∫øu c√≥ data array h·ª£p l·ªá
          if (dataArray && Array.isArray(dataArray) && dataArray.length > 0){
            // T·∫°o response object n·∫øu ch∆∞a c√≥
            if (!response) {
              response = {
                success: true,
                data: dataArray,
                month: month || ''
              };
            } else {
              // ƒê·∫£m b·∫£o c√≥ success field v√† data field
              if (response.success === undefined) {
                response.success = true;
              }
              if (!response.data || !Array.isArray(response.data)) {
                response.data = dataArray;
              }
            }
            
            F5A_P1_DATA = response;
            F5A_P1_META = { month: month || '' };
            console.log('[F5A P1] Data loaded successfully, count:', response.data.length);
            try{ 
              LS.set('f5a.lastUpdated', String(Date.now())); 
              updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated');
              // P2 ƒë√£ c√≥ cache ri√™ng, kh√¥ng update ·ªü ƒë√¢y n·ªØa
              // updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated');
            }catch(_){ }
            try{ LS.setJSON('f5a.p1.cache', { version: APP_CACHE_VERSION, month: month || '', data: response, ts: Date.now() }); }catch(_){ }
          } else if (response && response.success === false) {
            console.error('[F5A P1] Response indicates failure:', response.error || 'Unknown error');
            throw new Error(response.error || 'Invalid response format');
          } else {
            console.error('[F5A P1] Invalid response format - no data array or empty data');
            console.error('[F5A P1] Response structure:', response);
            throw new Error('Invalid response format: missing or empty data array');
          }
        }catch(err){
          console.error('[F5A P1] Fetch error:', err);
          F5A_P1_DATA = null;
          F5A_P1_META = { month: '' };
        }
      }

      // Fetch Form 5 P2 data t·ª´ n8n (lu·ªìng ri√™ng)
      async function f5aFetchP2Data(month){
        // ƒê√£ b·ªè check cache ƒë·ªÉ cho ph√©p nh·∫•n t·∫£i l·∫°i d·ªØ li·ªáu m·ªói l·∫ßn nh·∫•n n√∫t
        // if (F5A_P2_DATA && F5A_P2_META && F5A_P2_META.month === (month||'')) {
        //   console.log('[F5A P2] Using cached data');
        //   return F5A_P2_DATA;
        // }
        
        try{
          const qs = new URLSearchParams();
          if (month) qs.append('month', month);
          qs.append('_ts', Date.now().toString());
          const url = `${FORM5_P2_URL}?${qs.toString()}`;
          console.log('[F5A P2] Fetching from:', url);
          
          const r = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();
          console.log('[F5A P2] Raw response:', data);
          
          // X·ª≠ l√Ω nhi·ªÅu format response (t∆∞∆°ng t·ª± P1)
          let response = null;
          let dataArray = null;
          
          // Tr∆∞·ªùng h·ª£p 1: Response l√† array tr·ª±c ti·∫øp
          if (Array.isArray(data) && data.length > 0) {
            const firstItem = data[0];
            if (firstItem && typeof firstItem === 'object' && Array.isArray(firstItem.data)) {
              dataArray = firstItem.data;
              response = {
                success: firstItem.success !== undefined ? firstItem.success : true,
                data: dataArray,
                month: firstItem.month || month || '',
                summary: firstItem.summary || {}
              };
            } else {
              dataArray = data;
              response = { success: true, data: dataArray, month: month || '' };
            }
          }
          // Tr∆∞·ªùng h·ª£p 2: Response c√≥ format { json: {...} }
          else if (data && typeof data === 'object' && 'json' in data) {
            response = data.json;
          }
          // Tr∆∞·ªùng h·ª£p 3: Response tr·ª±c ti·∫øp l√† object
          else if (data && typeof data === 'object' && !Array.isArray(data)) {
            response = data;
          }
          
          // L·∫•y data array t·ª´ response
          if (!dataArray && response) {
            if (Array.isArray(response.data)) {
              dataArray = response.data;
            } else if (Array.isArray(response)) {
              dataArray = response;
            }
          }
          
          // Ki·ªÉm tra n·∫øu c√≥ data array h·ª£p l·ªá
          if (dataArray && Array.isArray(dataArray) && dataArray.length > 0){
            if (!response) {
              response = { success: true, data: dataArray, month: month || '' };
            } else {
              if (response.success === undefined) response.success = true;
              if (!response.data || !Array.isArray(response.data)) {
                response.data = dataArray;
              }
            }
            
            F5A_P2_DATA = response;
            F5A_P2_META = { month: month || '' };
            console.log('[F5A P2] Data loaded successfully, count:', response.data.length);
            
            // L∆∞u cache v√† update UI
            try{ 
              LS.set('f5a.p2.lastUpdated', String(Date.now())); 
              updateLastUpdatedNote('f5a-search-p2','f5a.p2.lastUpdated');
              LS.setJSON('f5a.p2.cache', { 
                version: APP_CACHE_VERSION, 
                month: month || '', 
                data: response, 
                ts: Date.now() 
              }); 
            }catch(_){ }
            
            return response;
          } else if (response && response.success === false) {
            console.error('[F5A P2] Response indicates failure:', response.error || 'Unknown error');
            throw new Error(response.error || 'Invalid response format');
          } else {
            console.error('[F5A P2] Invalid response format - no data array or empty data');
            throw new Error('Invalid response format: missing or empty data array');
          }
        }catch(err){
          console.error('[F5A P2] Fetch error:', err);
          F5A_P2_DATA = null;
          F5A_P2_META = { month: '' };
          throw err;
        }
      }

      async function f5aFetchAllOnce(month, fromVal, toVal){
        if (F5A_RAW_ALL && F5A_RAW_ALL.length && F5A_RAW_META && F5A_RAW_META.month === (month||'')) return;
        const makeQs = (withAction, withRange)=>{
          const qs = new URLSearchParams();
          if (withAction) qs.append('action','form5_all');
          if (withRange){
            if (month) qs.append('month', month);
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
          }
          qs.append('_ts', Date.now().toString());
          return qs.toString();
        };
        const urls = [];
        const uBase = FORM5_ALL_NEW_URL;
        const uTest = uBase.replace('/webhook/','/webhook-test/');
        [true,false].forEach(withRange=>{
          [true,false].forEach(withAction=>{
            const q = makeQs(withAction, withRange);
            urls.push(`${uBase}${q?`?${q}`:''}`);
            urls.push(`${uTest}${q?`?${q}`:''}`);
          });
        });
        // th√™m ph∆∞∆°ng √°n kh√¥ng query
        urls.push(uBase);
        urls.push(uTest);
        let rows = [];
        for (const u of urls){
          try{
            const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
            const text = await r.text();
            let data = null; try{ data = JSON.parse(text); }catch{ data = null; }
            if (!data && typeof text === 'string'){
              const m = text.match(/\[[\s\S]*\]/);
              if (m) { try { data = JSON.parse(m[0]); } catch(_) { data = null; } }
            }
            const picked = f5aPickRowsDeep(data ?? text);
            if (Array.isArray(picked) && picked.length){ rows = picked; break; }
          }catch(_){ /* next */ }
        }
        // Unwrap n8n format: [{ json: {...} }]
        const unwrapped = Array.isArray(rows) ? rows.map(r=> (r && typeof r==='object' && ('json' in r)) ? r.json : r) : [];
        F5A_RAW_ALL = unwrapped;
        F5A_RAW_META = { month: month || '' };
        try{ LS.set('f5a.lastUpdated', String(Date.now())); updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); }catch(_){ }
        try{ LS.setJSON('f5a.raw', { month: (month||''), rows: F5A_RAW_ALL, ts: Date.now() }); }catch(_){ }
      }

      // DEPRECATED: H√†m n√†y ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng x·ª≠ l√Ω tr√™n n8n (FORM5_P1_URL)
      // Gi·ªØ l·∫°i ƒë·ªÉ tham kh·∫£o logic t√≠nh to√°n, nh∆∞ng kh√¥ng s·ª≠ d·ª•ng trong renderForm5P1 n·ªØa
      function f5aAggregate_DEPRECATED(rows, fromVal, toVal){
        // ==== CONFIG (tham kh·∫£o Code t·ªïng h·ª£p.txt) ====
        const assigneeKeys = ['Assignee','Ph·ª• tr√°ch','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
        const taskNameKeys = ['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','M√£','taskname','ten_tac_vu','ten','title'];
        const scoreKeys = ['ƒêi·ªÉm','Score','score'];
        const altScoreKeys = ['C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n ','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n','C√¥ng chu·∫©n','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
        const actualHoursKeys = ['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','so gio danh gia thuc te','actualhours','actual_hours','gio thuc te','gio_thuc_te','hours_actual'];
        const statusKeys = [
          'Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i',
          // B·ªï sung c√°c bi·∫øn th·ªÉ cho c·ªôt tr·∫°ng th√°i theo c√¥ng chu·∫©n
          'Tr·∫°ng th√°i theo c√¥ng chu·∫©n','trang thai theo cong chuan','hi·ªán tr·∫°ng theo c√¥ng chu·∫©n','hien trang theo cong chuan',
          'status_by_man','status_by_manhour','status_manhour','status_by_workload','ht_theo_cong_chuan'
        ];
        // C·ªôt "Hi·ªán tr·∫°ng theo h·∫°n mong mu·ªën" (ƒë√∫ng/tr·ªÖ h·∫°n y√™u c·∫ßu)
        const statusByWishKeys = [
          'Hi·ªán tr·∫°ng theo h·∫°n mong mu·ªën','hien trang theo han mong muon','trang thai theo han mong muon',
          'status_by_wish','status_wish','statuswish','ht_theo_han_mong_muon'
        ];
        const finishedDateKs = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh'];
        const countZeroTasks = true;
        const excludeCanceled = true;
        const minWeight = 0.0001;

        const hasVal = v => v != null && String(v).trim() !== '';
        const normalizeVi = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
        const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
        const getV = (obj, keys)=>{
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{
            const v = obj[k];
            const k1 = String(k).toLowerCase();
            const k2 = normKey(k);
            lower[k1] = v;
            lower[k2] = v;
          });
          for (const k of keys){
            const cand1 = String(k).toLowerCase();
            const cand2 = normKey(k);
            const v = lower[cand1] ?? lower[cand2];
            if (v !== undefined && hasVal(v)) return v;
          }
          return '';
        };
        function toNum(v){
          if (v == null) return 0;
          let s = String(v).trim();
          if (!s) return 0;
          s = s.replace(/\s|\u00A0/g, '');
          s = s.replace(/[%‚Ç´ƒëvnd]/gi, '');
          if (s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
          else s = s.replace(/\./g,'');
          const n = Number(s);
          return Number.isFinite(n) ? n : 0;
        }
        function getNumberFrom(row, keys){ const v = getV(row, keys); return toNum(v); }
        function getTextFrom(row, keys){ const v = getV(row, keys); return String(v||'').trim(); }
        function isCanceled(row){
          const f = getTextFrom(row, finishedDateKs).toLowerCase();
          const st = getTextFrom(row, statusKeys).toLowerCase();
          return f.includes('cancel') || st.includes('cancel') || st.includes('h·ªßy') || st.includes('hu·ª∑');
        }
        const resultKeys = ['‚ÅâÔ∏è K·∫øt qu·∫£','ket_qua','k·∫øt qu·∫£','result'];
        function inRange(v){
          if (!fromVal && !toVal) return true;
          const d = parseDateFlexible(v);
          if (!d) return true;
          const ds = d.toISOString().slice(0,10);
          if (fromVal && ds < fromVal) return false;
          if (toVal && ds > toVal) return false;
          return true;
        }
        // Ph·∫°m vi theo NG√ÄY HO√ÄN TH√ÄNH: d√πng ƒë·ªÉ t√≠nh DONE/V∆∞·ª£t/ƒê√∫ng/Ch·∫≠m theo th√°ng ho√†n th√†nh
        function inRangeByDone(v){
          if (!fromVal && !toVal) return true;
          const d = parseDateFlexible(v);
          if (!d) return false; // n·∫øu kh√¥ng c√≥ ng√†y ho√†n th√†nh th√¨ kh√¥ng t√≠nh v√†o DONE th√°ng n√†y
          const ds = d.toISOString().slice(0,10);
          if (fromVal && ds < fromVal) return false;
          if (toVal && ds > toVal) return false;
          return true;
        }
        const byName = new Map();
        const dbg = { total:0, done:0, both:0, addAhead:0, addOn:0, addLate:0, missWish:0, missMan:0 };
        rows.forEach(row=>{
          // B·ªè qua b·∫£n ghi kh√¥ng ph·∫£i task (thi·∫øu t√™n task)
          const taskVal = getTextFrom(row, taskNameKeys);
          if (!hasVal(taskVal)) return;
          if (excludeCanceled && isCanceled(row)) return;
          let name = getTextFrom(row, assigneeKeys);
          if (!name || name.toLowerCase() === 'nan') name = 'Ch∆∞a ph√¢n c√¥ng';

          const rq = getV(row,[
            'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','üìÜ ng√†y y√™u c·∫ßu'
          ]);
          const wish = getV(row,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
          const act = getV(row,['actualdue','handapung','han_dap_ung','completiondate']);
          const doneDate = getV(row, finishedDateKs);
          // L·ªçc theo m·ªëc ng√†y ∆∞u ti√™n: Ng√†y y√™u c·∫ßu -> H·∫°n ƒë√°p ·ª©ng -> H·∫°n mong mu·ªën -> Ng√†y ho√†n th√†nh
          const refDate = (
            hasVal(rq) ? rq : (
              hasVal(act) ? act : (
                hasVal(wish) ? wish : (
                  hasVal(doneDate) ? doneDate : ''
                )
              )
            )
          );
          const inRef = hasVal(refDate) && inRange(refDate);

          const weight = getNumberFrom(row, scoreKeys) || getNumberFrom(row, altScoreKeys);
          const resText = getTextFrom(row, resultKeys);
          const statusRaw = getTextFrom(row, statusKeys);
          const hasDoneDate = !!parseDateFlexible(doneDate);
          const inDoneMonth = inRangeByDone(doneDate);
          // B·ªè qua ho√†n to√†n n·∫øu kh√¥ng thu·ªôc ref range v√† c≈©ng kh√¥ng ho√†n th√†nh trong th√°ng
          if (!inRef && !inDoneMonth) return;
          const normRes = normalizeVi(resText);
          const normStatus = normalizeVi(statusRaw);
          const done = hasDoneDate || /^\s*done\s*$/i.test(resText||'') || /\bdone\b/.test(normRes) || /\bhoan\b|\bdone\b|\bda hoan\b/.test(normStatus);

          let rec = byName.get(name);
          if (!rec) { rec = { name, manhour: 0, count: 0, ahead: 0, ontime: 0, late: 0, na: 0, doneCnt: 0, doneSum: 0, activeCnt: 0, activeSum: 0 }; byName.set(name, rec); }

          const countThis = countZeroTasks ? true : (weight > minWeight);
          // T√≠nh s·ªë DONE theo TH√ÅNG HO√ÄN TH√ÄNH (kh√¥ng ph·ª• thu·ªôc refDate)
          if (done && inDoneMonth) {
            if (countThis) rec.doneCnt = (rec.doneCnt || 0) + 1;
          }
          // T·ªïng c√¥ng chu·∫©n ƒëang x·ª≠ l√Ω/ƒë√£ x·ª≠ l√Ω ch·ªâ t√≠nh theo refDate ƒë·ªÉ kh√¥ng l·ªách th√°ng nh·∫≠n
          if (inRef) {
            if (done) {
              rec.doneSum += weight;
            } else {
              if (countThis) rec.activeCnt += 1;
              rec.activeSum += weight;
            }
          }
          rec.count = (rec.doneCnt || 0) + (rec.activeCnt || 0);
          rec.manhour = (rec.doneSum || 0) + (rec.activeSum || 0);
          // T·ªïng c√¥ng chu·∫©n theo m·ªëc tham chi·∫øu refDate (kh√¥ng t√≠nh Cancel v√¨ ƒë√£ lo·∫°i ·ªü tr√™n)
          try{
            if (inRef){ rec.totalByRef = (rec.totalByRef || 0) + weight; }
          }catch(_){ }

            // Ph√¢n lo·∫°i v∆∞·ª£t/ƒë√∫ng/ch·∫≠m CH·ªà theo c√¥ng chu·∫©n (b·ªè logic "Hi·ªán tr·∫°ng theo h·∫°n mong mu·ªën")
            // H·∫°n mong mu·ªën v√† Ng√†y ho√†n th√†nh ch·ªâ mang t√≠nh hi·ªÉn th·ªã, kh√¥ng tham gia t√≠nh to√°n
            dbg.total++;
            if (done && inDoneMonth){
              // X√°c ƒë·ªãnh ƒëi·ªÅu ki·ªán N/A: c√≥ ng√†y ho√†n th√†nh v√† s·ªë gi·ªù th·ª±c t·∫ø = 0
              const EPS_NA = 1e-4;
              let actualNumForNA = 0;
              try { actualNumForNA = getNumberFrom(row, actualHoursKeys); } catch(_) { actualNumForNA = 0; }
              const isNA = (hasDoneDate && Number.isFinite(actualNumForNA) && Math.abs(actualNumForNA) < EPS_NA);
              
              // L·∫•y text t·ª´ c·ªôt "Hi·ªán tr·∫°ng" (theo c√¥ng chu·∫©n)
              const htText = normalizeVi(getTextFrom(row, statusKeys));
              let manAhead = htText.includes('vuot tien do');
              let manOn    = htText.includes('dung tien do');
              let manLate  = htText.includes('cham tien do');
              
              // Fallback: suy ra theo c√¥ng chu·∫©n n·∫øu thi·∫øu text
              if (!(manAhead || manOn || manLate)){
                try{
                  const actualNum = getNumberFrom(row, actualHoursKeys);
                  const manNum = weight;
                  const EPS = 1e-4;
                  // N·∫øu th·ª±c t·∫ø = 0 th√¨ coi l√† thi·∫øu d·ªØ li·ªáu -> kh√¥ng ph√¢n lo·∫°i v√†o V∆∞·ª£t/ƒê√∫ng/Ch·∫≠m
                  if (Number.isFinite(actualNum) && Math.abs(actualNum) < EPS) {
                    // gi·ªØ nguy√™n manAhead/manOn/manLate = false ƒë·ªÉ ƒë·∫©y v√†o N/A
                  } else if (Number.isFinite(actualNum) && Number.isFinite(manNum)){
                    // √Åp d·ª•ng dung sai 10% cho ƒê√∫ng ti·∫øn ƒë·ªô
                    const tolerance = Math.max(EPS, Math.abs(manNum) * 0.10);
                    if (actualNum > manNum + tolerance) manLate = true;
                    else if (Math.abs(actualNum - manNum) <= tolerance) manOn = true;
                    else manAhead = true;
                  }
                }catch(_){ }
              }
              
              // Ph√¢n lo·∫°i CH·ªà d·ª±a v√†o c√¥ng chu·∫©n (b·ªè logic h·∫°n mong mu·ªën)
              if (isNA){
                // N·∫øu thu·ªôc N/A th√¨ ∆∞u ti√™n ƒë∆∞a v√†o N/A
                rec.na = (rec.na || 0) + 1;
              } else if (manAhead || manOn || manLate){
                // Ph√¢n lo·∫°i theo c√¥ng chu·∫©n
                rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
                if (manAhead) { 
                  rec.ahead += 1; 
                  dbg.addAhead++; 
                } else if (manOn) { 
                  rec.ontime += 1; 
                  dbg.addOn++; 
                } else if (manLate) { 
                  rec.late += 1; 
                  dbg.addLate++; 
                }
              } else {
                // Kh√¥ng c√≥ ƒë·ªß th√¥ng tin ƒë·ªÉ ph√¢n lo·∫°i
                dbg.missMan++;
              }
            }
        });
        const out = Array.from(byName.values());
        out.forEach(r=>{
          const na = Math.max(0, Number(r.na||0));
          const sumClassified = Math.max(0, Number(r.ahead||0) + Number(r.ontime||0) + Number(r.late||0));
          // M·∫´u s·ªë m·ªõi: t·ªïng (V∆∞·ª£t + ƒê√∫ng + Ch·∫≠m + N/A)
          const denom = sumClassified + na;
          r.rateAhead = denom ? Math.round((Number(r.ahead||0)*100)/denom) : 0;
          r.rateOntime = denom ? Math.round((Number(r.ontime||0)*100)/denom) : 0;
          r.rateLate = denom ? Math.round((Number(r.late||0)*100)/denom) : 0;
          r.rateNA = denom ? Math.max(0, Math.min(100, Math.round((na*100)/denom))) : 0;
          r.classifiedCnt = sumClassified;
          // Map theo bi·ªÉu m·∫´u ngo√†i (·∫£nh)
          r["Ph·ª• tr√°ch"] = r.name || '';
          const activeSum = Number(r.activeSum||0);
          r["T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω)"] = +activeSum.toFixed(2);
          r["S·ªë task ƒëang x·ª≠ l√Ω"] = Number(r.activeCnt||0);
          const totalPts = Number((r.doneSum||0) + (r.activeSum||0));
          r["T·ªïng ƒëi·ªÉm t·∫•t c·∫£"] = +totalPts.toFixed(2);
          r["T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω"] = Number((r.doneCnt||0) + (r.activeCnt||0));
          // T·ªïng c√¥ng chu·∫©n theo m·ªëc refDate
          const byRef = Number(r.totalByRef||0);
          r["T·ªïng c√¥ng chu·∫©n"] = +byRef.toFixed(2);
        });
        try{ if (f5aIsDebug()) console.log('[F5A] classify summary:', dbg); }catch(_){ }
        return out;
      }

      // Date-time format helpers
      function toDateSafe(value){
        try{
          if (value instanceof Date && !isNaN(value)) return value;
          const parsed = (typeof parseDateFlexible === 'function') ? parseDateFlexible(value) : null;
          if (parsed && !isNaN(parsed)) return parsed;
          const d = new Date(value);
          return isNaN(d) ? null : d;
        }catch(_){ return null; }
      }
      function formatDdMmYyyy(value){
        try{
          const d = toDateSafe(value);
          if (!d) return '';
          const pad = n=> String(n).padStart(2,'0');
          return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
        }catch(_){ return ''; }
      }
      function formatDdMmYyyyHHmm(value){
        try{
          const d = toDateSafe(value);
          if (!d) return '';
          const pad = n=> String(n).padStart(2,'0');
          return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }catch(_){ return ''; }
      }
      function formatYyyyMmDdHHmm(value){
        try{
          const d = toDateSafe(value);
          if (!d) return '';
          const pad = n=> String(n).padStart(2,'0');
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }catch(_){ return ''; }
      }

      function formatYyyyMm(value){
        try{
          const d = toDateSafe(value);
          if (!d) return '';
          const pad = n=> String(n).padStart(2,'0');
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
        }catch(_){ return ''; }
      }
      // ===== Khu v·ª±c c·∫•u h√¨nh ng√†y ngh·ªâ (c√≥ th·ªÉ ch·ªânh s·ª≠a) =====
      // Danh s√°ch ngh·ªâ ri√™ng (v√≠ d·ª•) ‚Äî c√≥ th·ªÉ th√™m/b·ªõt ho·∫∑c t·∫°o th√™m c√°c Set kh√°c
      const SEP_2025_HOLIDAYS = new Set(["2025-09-01","2025-09-02","2025-09-08","2025-09-09"]);
      // G·ªôp t·∫•t c·∫£ set ngh·ªâ v√†o m·ªôt Set duy nh·∫•t ƒë·ªÉ ti·ªán tra c·ª©u
      const CUSTOM_HOLIDAYS = new Set([
        ...SEP_2025_HOLIDAYS,
        // Th√™m spread c√°c set kh√°c t·∫°i ƒë√¢y, v√≠ d·ª•: ...OCT_2025_HOLIDAYS
      ]);
      function isCustomHoliday(date){
        try{
          const d = toDateSafe(date);
          if (!d) return false;
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          const iso = `${y}-${m}-${dd}`;
          return CUSTOM_HOLIDAYS.has(iso);
        }catch(_){ return false; }
      }
      // Business time addition: Mon-Sat, 08:00-12:30 and 13:30-17:00 (skip Sundays and custom holidays)
      function addBusinessHours(start, hours){
        try{
          let cur = toDateSafe(start);
          if (!cur || isNaN(cur)) return null;
          let minutesLeft = Math.round((Number(hours)||0) * 60);
          if (minutesLeft <= 0) return cur;
          function cloneAt(d, hh, mm){ const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), hh, mm, 0, 0); return nd; }
          function isSunday(d){ return d.getDay() === 0; }
          function isWorkingDay(d){ return d.getDay() >= 1 && d.getDay() <= 6 && !isCustomHoliday(d); }
          function moveToNextWorkdayMorning(d){
            const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 8, 0, 0, 0);
            // if after or equal 17:00, go to next day 08:00
            const afterClose = d.getHours() > 17 || (d.getHours() === 17 && d.getMinutes() > 0);
            const exactlyClose = d.getHours() === 17 && d.getMinutes() === 0;
            let base = (afterClose || exactlyClose) ? new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 8, 0, 0, 0) : nd;
            // skip Sundays and custom holidays
            while (isSunday(base) || isCustomHoliday(base)) base = new Date(base.getFullYear(), base.getMonth(), base.getDate()+1, 8, 0, 0, 0);
            return base;
          }
          function normalizeToWorkingSlot(d){
            // If Sunday or custom holiday -> move to next working day 08:00
            while (!isWorkingDay(d)) d = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 8, 0, 0, 0);
            const mins = d.getHours()*60 + d.getMinutes();
            const mOpen = 8*60;          // 08:00
            const mLunch = 12*60 + 30;   // 12:30
            const mAfter = 13*60 + 30;   // 13:30
            const mClose = 17*60;        // 17:00
            if (mins < mOpen) return cloneAt(d, 8, 0);
            if (mins >= mClose) return moveToNextWorkdayMorning(d);
            if (mins >= mLunch && mins < mAfter) return cloneAt(d, 13, 30);
            if (mins >= mOpen && mins < mLunch) return d; // morning slot
            if (mins >= mAfter && mins < mClose) return d; // afternoon slot
            return d;
          }
          function segmentEnd(d){
            const mins = d.getHours()*60 + d.getMinutes();
            const mLunch = 12*60 + 30;   // 12:30
            const mAfter = 13*60 + 30;   // 13:30
            const mClose = 17*60;        // 17:00
            if (mins < mLunch) return cloneAt(d, 12, 30);
            if (mins >= mAfter && mins < mClose) return cloneAt(d, 17, 0);
            // exactly 12:30 -> next segment 13:30
            if (mins === mLunch) return cloneAt(d, 13, 30);
            return cloneAt(d, 17, 0);
          }
          cur = normalizeToWorkingSlot(cur);
          while (minutesLeft > 0){
            cur = normalizeToWorkingSlot(cur);
            // determine segment end
            const end = segmentEnd(cur);
            const avail = Math.max(0, Math.floor((end.getTime() - cur.getTime())/60000));
            if (minutesLeft <= avail){
              cur = new Date(cur.getTime() + minutesLeft*60000);
              minutesLeft = 0;
              break;
            }
            // consume this segment
            minutesLeft -= avail;
            // move to next slot
            const mins = cur.getHours()*60 + cur.getMinutes();
            const mLunch = 12*60 + 30; const mClose = 17*60;
            if (mins < mLunch){
              // go to 13:30 same day
              cur = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), 13, 30, 0, 0);
            } else {
              // go to next workday 08:00
              cur = moveToNextWorkdayMorning(new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), 17, 0, 0, 0));
            }
          }
          return cur;
        }catch(_){ return null; }
      }
      // Parse number flexible: supports both comma and dot decimals
      function parseNumberFlexible(value){
        try{
          let s = String(value ?? '').trim();
          if (!s) return NaN;
          s = s.replace(/\s|\u00A0/g,'');
          s = s.replace(/[%‚Ç´ƒëvnd]/gi,'');
          if (s.includes(',')) {
            s = s.replace(/\./g,'').replace(',', '.');
          } else {
            s = s.replace(/,/g,'');
          }
          const n = Number(s);
          return Number.isFinite(n) ? n : NaN;
        }catch(_){ return NaN; }
      }
      // Number formatters for display only (do not mutate source data)
      function formatNumberVi(num, min=2, max=2){
        try{
          if (!Number.isFinite(num)) return '';
          return num.toLocaleString('vi-VN', { minimumFractionDigits: min, maximumFractionDigits: max });
        }catch(_){
          try{ return String(num); }catch(__){ return ''; }
        }
      }
      function formatNumberViFromRaw(raw, min=2, max=2){
        try{
          const n = parseNumberFlexible(raw);
          return Number.isFinite(n) ? formatNumberVi(n, min, max) : String(raw||'');
        }catch(_){ return String(raw||''); }
      }

      // Local storage helpers & last-updated note
      const LS = {
        get(k){ try{ return localStorage.getItem(k); }catch(_){ return null; } },
        set(k,v){ try{ localStorage.setItem(k,v); }catch(_){ } },
        getJSON(k){ try{ const s=localStorage.getItem(k); return s? JSON.parse(s): null; }catch(_){ return null; } },
        setJSON(k,obj){ try{ localStorage.setItem(k, JSON.stringify(obj)); }catch(_){ } },
        remove(k){ try{ localStorage.removeItem(k); }catch(_){ } }
      };
      function formatHHmmDdMmYyyy(value){
        try{
          const d = toDateSafe(value);
          if (!d) return '';
          const pad = n=> String(n).padStart(2,'0');
          return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
        }catch(_){ return ''; }
      }
      function updateLastUpdatedNote(btnId, tsKey){
        try{
          const btn = document.getElementById(btnId);
          if (!btn) return;
          const parent = btn.parentElement || btn;
          // Ghi ch√∫ th·ªùi gian
          let note = parent.querySelector('[data-last-updated]');
          if (!note){
            note = document.createElement('span');
            note.setAttribute('data-last-updated','1');
            note.className = 'text-xs text-gray-500 ml-2';
            parent.appendChild(note);
          }
          const tsStr = LS.get(tsKey);
          const ts = Number(tsStr);
          const show = tsStr ? (isNaN(ts) ? '' : `D·ªØ li·ªáu c·∫≠p nh·∫≠t l√∫c ${formatHHmmDdMmYyyy(new Date(ts))}`) : '';
          note.textContent = show;

          // D√≤ng h∆∞·ªõng d·∫´n n·ªïi b·∫≠t b√™n d∆∞·ªõi
          const hintId = `${btnId}-refresh-hint`;
          let hint = document.getElementById(hintId);
          if (!hint){
            hint = document.createElement('div');
            hint.id = hintId;
            hint.className = 'mt-1 text-xs inline-flex items-center gap-1 px-2 py-1 rounded bg-amber-50 border border-amber-200 text-amber-700';
            parent.insertAdjacentElement('afterend', hint);
          }
          hint.innerHTML = `üîÑ <span>Nh·∫•n <b>TRA C·ª®U</b> ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi nh·∫•t.</span>`;
        }catch(_){ }
      }


      // Global helper: parse various date/time formats robustly (ISO/TZ, DD/MM/YYYY, YYYY-MM-DD, with optional time & AM/PM)
      // Sidebar navigation
      const navBtns = document.querySelectorAll('.nav-btn');
      const sections = ['form1','form11','form12','form4','form5','form6','form7','form8','form9','form13'].map(id=>document.getElementById(id));
      function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
      navBtns.forEach((btn)=>{
        btn.onclick=()=>{
          const target = btn.getAttribute('data-target');
          navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
          btn.classList.add('bg-primary-blue','font-bold');
          showSection(target);
          if (target === 'form4') {
            try {
              if (typeof initForm4 === 'function') {
                initForm4();
              }
            } catch(_){}
          }
          if (target === 'form6') { try { if(!restoreForm6FromCache()){ renderForm6List(); } } catch(_){} }
          if (target === 'form5') {
            try {
              const restored = restoreForm5FromCache();
              // Lu√¥n l√†m m·ªõi ng·∫ßm ƒë·ªÉ ƒë·∫£m b·∫£o % ƒë∆∞·ª£c t√≠nh l·∫°i sau khi chuy·ªÉn form ho·∫∑c c·∫≠p nh·∫≠t m√£
              renderForm5All().catch(()=>{});
            } catch(_){}
          }
          if (target === 'form7') {
            try {
              // Kh√¥i ph·ª•c d·ªØ li·ªáu Form 7 t·ª´ cache n·∫øu c√≥
              restoreForm7FromCache();
            } catch(_){}
          }
          if (target === 'form8') {
            try {
              // Kh√¥i ph·ª•c d·ªØ li·ªáu Form 8 t·ª´ cache n·∫øu c√≥
              restoreForm8FromCache();
            } catch(_){}
          }
          if (target === 'form9') {
            try {
              restoreForm9FromCache();
            } catch(_){}
          }
          if (target === 'form12') {
            try {
              if (!F12_LAST_ROWS || F12_LAST_ROWS.length === 0) { renderForm12Data(); }
            } catch(_){}
          }
          if (target === 'form13') {
            try {
              const cached = LS.getJSON('f13.cache');
              if (cached && Array.isArray(cached.rows) && cached.rows.length) {
                renderForm13FromRows(cached.rows);
              } else {
                renderForm13();
              }
            } catch(_){}
          }
        }
      });
      // Default
      navBtns[0].classList.add('bg-primary-blue','font-bold');
      showSection(navBtns[0].getAttribute('data-target'));
      // Hi·ªÉn th·ªã d√≤ng h∆∞·ªõng d·∫´n d∆∞·ªõi c√°c n√∫t Tra c·ª©u c·ªßa c√°c form kh√°c
      try { updateLastUpdatedNote('f4-search','f4.lastUpdated'); } catch(_){}
      try { updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated'); } catch(_){}
      try { updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated'); } catch(_){}
      try { updateLastUpdatedNote('f5a-search-p3','f5a.p3.lastUpdated'); } catch(_){}
      try { updateLastUpdatedNote('f6-search','f6.lastUpdated'); } catch(_){}

      // Names
      const FORM1_NAMES = [
        "B√πi ƒê·∫∑ng Qu·ªëc Huy","ƒê√†o Tu·∫•n K·ª≥","ƒê·ªó Quang Long","H√† M·ªπ Linh","L·∫°i Qu·ªëc L·ªôc",
        "L√™ Ng·ªçc √Ånh","L√™ Th·ªã Thanh Nh√†n","L√™ Th·ªã Th·∫£o","L√™ VƒÉn S∆°n","Nguy·ªÖn H·ªØu Th·ªãnh","Nguy·ªÖn Th·ªã Hi·ªÅn",
        "Ph·∫°m Th√†nh Trung Ki√™n","Ph·∫°m Th·ªã Minh","Th√°i Th·ªã Giang","Tr·∫ßn Hi·∫øu Nghƒ©a","V≈© Th·ªã H·∫±ng","V≈© Th·ªã Thanh Hi·ªÅn"
      ];
      const FORM7_NAMES = FORM1_NAMES;
      const FORM9_NAMES = (function(){
        try{
          const arr = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
          const exclude = new Set(["L√™ Th·ªã Thanh Nh√†n"]);
          return arr.filter(n => !exclude.has(n));
        }catch(_){ return FORM1_NAMES; }
      })();
      // Danh s√°ch ri√™ng cho Form 3 (Ng∆∞·ªùi ƒë∆∞·ª£c giao): lo·∫°i 3 t√™n v√† th√™m 3 t√™n
      const FORM3_ASSIGNEES = (()=>{
        const base = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
        const exclude = new Set(["H√† M·ªπ Linh","ƒê·ªó Th·∫ø C∆∞·ªùng","L√™ Th·ªã Thanh Nh√†n"]);
        const add = ["ƒê√†o Ho√†ng D∆∞∆°ng","Nguy·ªÖn VƒÉn Linh","Nguy·ªÖn VƒÉn Hi·∫øu"];
        const filtered = base.filter(n => !exclude.has(n));
        add.forEach(n => { if (filtered.indexOf(n) === -1) filtered.push(n); });
        return filtered;
      })();

      // ===== Form 10: Qu·∫£n l√Ω nh√¢n s·ª± =====
      // (Form 10 c≈©: ƒë√£ lo·∫°i b·ªè c√°c b·∫£ng ch·ª©c nƒÉng kh√°c, ch·ªâ gi·ªØ B·∫£ng c√¥ng)
      // ==== Form 10: Attendance (B·∫£ng c√¥ng theo th√°ng) ====
      let F10_ATT_ROWS = [];
      let F10_ATT_META = { month: '' };

      function f10BuildQuery(month){
        try{
          const qs = new URLSearchParams();
          // Optional action (server c√≥ th·ªÉ b·ªè qua)
          const action = 'form10_attendance';
          qs.append('action', action);
          // Header map (ƒë·ªÉ server t·∫°o ƒë√∫ng keys n·∫øu c·∫ßn)
          const headers = {
            employee: 'Nh√¢n s·ª±',
            month: 'Th√°ng',
            days: 'S·ªë ng√†y ƒëi l√†m (th√°ng)',
            ot: 'T·ªïng gi·ªù tƒÉng ca (th√°ng)',
            total: 'T·ªïng gi·ªù c√¥ng ƒëi l√†m'
          };
          qs.append('header_employee', headers.employee);
          qs.append('header_month', headers.month);
          qs.append('header_days', headers.days);
          qs.append('header_ot', headers.ot);
          qs.append('header_total', headers.total);
          // Standard field keys (fallback)
          const fields = {
            employee: 'employee',
            month: 'month',
            days: 'daysInMonth',
            ot: 'overtimeHours',
            total: 'totalWorkHours'
          };
          qs.append('field_employee', fields.employee);
          qs.append('field_month', fields.month);
          qs.append('field_days', fields.days);
          qs.append('field_ot', fields.ot);
          qs.append('field_total', fields.total);
          // Month filter; if provided as YYYY-MM, also include from/to for convenience
          const m = (month||'').trim();
          let from = '', to = '';
          if (m){
            qs.append('month', m);
            try{
              const [yy, mm] = m.split('-');
              const firstDay = `${yy}-${mm}-01`;
              const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
              const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
              qs.append('from', firstDay);
              qs.append('to', lastDay);
              from = firstDay; to = lastDay;
            }catch(_){ }
          }
          // Add meta body so server v·∫´n ƒë·ªçc ƒë∆∞·ª£c n·∫øu query b·ªã strip
          try{
            const meta = {
              action,
              headers,
              fields,
              month: m,
              from,
              to,
              timestamp_iso: new Date().toISOString()
            };
            qs.append('body', JSON.stringify(meta));
          }catch(_){ }
          // Cache buster
          qs.append('_ts', Date.now().toString());
          return qs.toString();
        }catch(_){ return ''; }
      }

      async function f10FetchAttendance(month){
        try{
          // Try prod & test variants and GET/POST forms
          const base = FORM10_ATTENDANCE_URL;
          const q = f10BuildQuery(month);
          const postOpts = (mode)=>({ method:'POST', mode, headers: { 'Content-Type':'application/x-www-form-urlencoded', 'Accept':'application/json, text/plain, */*' }, body: q });
          const tryList = [
            { url: `${base}?${q}`, opts: { method:'GET', headers:{ 'Accept':'application/json, text/plain, */*' } } },
            { url: base, opts: postOpts('cors') },
            // As last resort (opaque), still trigger server: result not readable
            { url: base, opts: postOpts('no-cors') },
          ];
          let rows = [];
          for (const t of tryList){
            try{
              const r = await fetch(t.url, t.opts);
              // Skip unreadable opaque responses
              let text = '';
              try{ text = await r.text(); }catch(__){ text = ''; }
              let data = null; try{ data = JSON.parse(text); }catch{ data = null; }
              // Unwrap simple or deep nested
              const picked = (function pickRows(json){
                if (!json) return [];
                if (Array.isArray(json)) return json;
                const keys=['data','rows','result','records','items','list'];
                for (const k of keys){ if (Array.isArray(json?.[k])) return json[k]; }
                try{
                  const queue=[json]; const seen=new Set();
                  while(queue.length){
                    const cur=queue.shift(); if(!cur||typeof cur!== 'object'||seen.has(cur)) continue; seen.add(cur);
                    for (const v of Object.values(cur)){
                      if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
                      if (v && typeof v==='object') queue.push(v);
                    }
                  }
                }catch(_){ }
                return [];
              })(data ?? text);
              if (Array.isArray(picked) && picked.length){ rows = picked; break; }
            }catch(_){ /* next */ }
          }
          // Normalize sample single-object payload to array
          if (!Array.isArray(rows) && rows && typeof rows==='object') rows = [rows];
          // Store
          F10_ATT_ROWS = Array.isArray(rows) ? rows : [];
          F10_ATT_META = { month: month||'' };
          try{ LS.setJSON('f10.att', { month: (month||''), rows: F10_ATT_ROWS, ts: Date.now() }); LS.set('f10.lastUpdated', String(Date.now())); }catch(_){ }
          // Friendly message for likely CORS/file:// case
          if (!F10_ATT_ROWS.length){
            try{
              const bodyEl = document.getElementById('f10-att-body');
              if (bodyEl){
                const isFile = (typeof location!=='undefined' && String(location.protocol||'').toLowerCase().startsWith('file'));
                bodyEl.innerHTML = `
                  <tr>
                    <td colspan="4" class="px-3 py-3 text-center">
                      <div class="text-red-600 mb-2">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Form 10</div>
                      <div class="text-sm text-gray-600 mb-2">${isFile ? 'L·ªói CORS do m·ªü file tr·ª±c ti·∫øp (file://)' : 'C√≥ th·ªÉ do m√°y ch·ªß ch∆∞a b·∫≠t CORS'}</div>
                      <div class="text-xs text-blue-600 text-left max-w-3xl mx-auto">
                        <strong>Gi·∫£i ph√°p:</strong><br>
                        1) M·ªü file qua web server (v√≠ d·ª•: VS Code Live Server, ho·∫∑c <code>python -m http.server 8080</code>) r·ªìi truy c·∫≠p <code>http://localhost:8080/index.html</code><br>
                        2) Y√™u c·∫ßu m√°y ch·ªß th√™m header CORS: <code>Access-Control-Allow-Origin: *</code> v√† <code>Access-Control-Allow-Headers: *</code><br>
                        3) N·∫øu c·∫ßn, cung c·∫•p m·ªôt endpoint proxy n·ªôi b·ªô c√≥ b·∫≠t CORS
                      </div>
                    </td>
                  </tr>
                `;
              }
            }catch(_){ }
          }
          return F10_ATT_ROWS;
        }catch(_){ F10_ATT_ROWS = []; return []; }
      }

      function f10GetV(obj, keys){
        const lower = {}; Object.keys(obj||{}).forEach(k=>{ lower[String(k||'').toLowerCase().trim()] = obj[k]; });
        for (const k of keys){ const v = lower[String(k||'').toLowerCase().trim()]; if (v!==undefined) return v; }
        // Loose includes fallback
        for (const key of Object.keys(lower)){ if (keys.some(k=> key.includes(String(k).toLowerCase()))) return lower[key]; }
        return '';
      }

      function f10MonthMatches(textMonth, monthVal){
        try{
          if (!monthVal) return true;
          const s = String(textMonth||'').trim();
          if (!s) return true;
          // MM/YYYY or M/YYYY
          let m = s.match(/^(\d{1,2})\/(\d{4})$/);
          if (m){
            const yy = m[2]; const mm = String(m[1]).padStart(2,'0');
            return `${yy}-${mm}` === monthVal;
          }
          // YYYY-MM or YYYY-MM-DD
          m = s.match(/^(\d{4})[-\/](\d{1,2})(?:[-\/]\d{1,2})?$/);
          if (m){
            const yy = m[1]; const mm = String(m[2]).padStart(2,'0');
            return `${yy}-${mm}` === monthVal;
          }
          // Fallback by parsing date
          const d = parseDateFlexible(s);
          if (d){
            const yy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0');
            return `${yy}-${mm}` === monthVal;
          }
          return true;
        }catch(_){ return true; }
      }

      // Render Form 10 Attendance v√†o modal body
      function renderForm10AttendanceModal(monthVal){
        try{
          const body = document.getElementById('f10-att-modal-body');
          if (!body) return;
          const rows = Array.isArray(F10_ATT_ROWS) ? F10_ATT_ROWS : [];
          if (!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; return; }

          // Helper parse number safely
          const toNum = (v)=>{ try{ const n = (typeof parseNumberFlexible==='function') ? parseNumberFlexible(v) : Number(v); return Number.isFinite(n) ? n : 0; }catch(_){ return 0; } };

          // Build filtered view by month, then sort by Total descending
          const view = [];
          rows.forEach(r=>{
            const emp = f10GetV(r, ['nh√¢n s·ª±','nhan su','employee','name']);
            const month = f10GetV(r, ['th√°ng','thang','month']);
            const days = f10GetV(r, ['s·ªë ng√†y ƒëi l√†m (th√°ng)','so ngay di lam (thang)','days','daysinmonth']);
            const ot = f10GetV(r, ['t·ªïng gi·ªù tƒÉng ca (th√°ng)','tong gio tang ca (thang)','overtime','overtimehours']);
            const total = f10GetV(r, ['t·ªïng gi·ªù c√¥ng ƒëi l√†m','tong gio cong di lam','total','totalworkhours']);
            if (f10MonthMatches(month, monthVal)){
              view.push({ emp, days, ot, total, totalNum: toNum(total) });
            }
          });
          view.sort((a,b)=> b.totalNum - a.totalNum);

          if (view.length){
            let stt = 0;
            body.innerHTML = view.map(x=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-center">${++stt}</td>
                <td class="px-3 py-2 text-center">${x.emp||''}</td>
                <td class="px-3 py-2 text-center">${x.days||''}</td>
                <td class="px-3 py-2 text-center">${x.ot||''}</td>
                <td class="px-3 py-2 text-center font-medium">${x.total||''}</td>
              </tr>
            `).join('');
            return;
          }

          // Fallback: n·∫øu kh√¥ng kh·ªõp th√°ng nh∆∞ng c√≥ d·ªØ li·ªáu -> hi·ªÉn th·ªã t·∫•t c·∫£, v·∫´n sort gi·∫£m d·∫ßn
          if (!view.length && rows.length > 0){
            const allView = rows.map(r=>{
              const emp = f10GetV(r, ['nh√¢n s·ª±','nhan su','employee','name']);
              const days = f10GetV(r, ['s·ªë ng√†y ƒëi l√†m (th√°ng)','so ngay di lam (thang)','days','daysinmonth']);
              const ot = f10GetV(r, ['t·ªïng gi·ªù tƒÉng ca (th√°ng)','tong gio tang ca (thang)','overtime','overtimehours']);
              const total = f10GetV(r, ['t·ªïng gi·ªù c√¥ng ƒëi l√†m','tong gio cong di lam','total','totalworkhours']);
              return { emp, days, ot, total, totalNum: toNum(total) };
            });
            allView.sort((a,b)=> b.totalNum - a.totalNum);
            let stt = 0;
            body.innerHTML = `
              <tr><td colspan="5" class="px-3 py-2 text-xs text-amber-700 bg-amber-50 text-center">Kh√¥ng kh·ªõp th√°ng l·ªçc. Hi·ªÉn th·ªã t·∫•t c·∫£ k·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ server (ƒë√£ s·∫Øp x·∫øp gi·∫£m d·∫ßn theo T·ªïng gi·ªù c√¥ng ƒëi l√†m).</td></tr>
              ${allView.map(x=>`
                <tr class="hover:bg-gray-50">
                  <td class="px-3 py-2 text-center">${++stt}</td>
                  <td class="px-3 py-2 text-center">${x.emp||''}</td>
                  <td class="px-3 py-2 text-center">${x.days||''}</td>
                  <td class="px-3 py-2 text-center">${x.ot||''}</td>
                  <td class="px-3 py-2 text-center font-medium">${x.total||''}</td>
                </tr>
              `).join('')}
            `;
            return;
          }

          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        }catch(_){
          try{ const body = document.getElementById('f10-att-modal-body'); if (body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="5">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu</td></tr>'; }catch(__){}
        }
      }

      function f10RowsToAOA(){
        const head = ['Nh√¢n s·ª±','Th√°ng','S·ªë ng√†y ƒëi l√†m (th√°ng)','T·ªïng gi·ªù tƒÉng ca (th√°ng)','T·ªïng gi·ªù c√¥ng ƒëi l√†m'];
        const aoa = [head];
        const rows = Array.isArray(F10_ATT_ROWS)? F10_ATT_ROWS: [];
        rows.forEach(r=>{
          const emp = f10GetV(r, ['nh√¢n s·ª±','nhan su','employee','name']);
          const month = f10GetV(r, ['th√°ng','thang','month']);
          const days = f10GetV(r, ['s·ªë ng√†y ƒëi l√†m (th√°ng)','so ngay di lam (thang)','days','daysinmonth']);
          const ot = f10GetV(r, ['t·ªïng gi·ªù tƒÉng ca (th√°ng)','tong gio tang ca (thang)','overtime','overtimehours']);
          const total = f10GetV(r, ['t·ªïng gi·ªù c√¥ng ƒëi l√†m','tong gio cong di lam','total','totalworkhours']);
          aoa.push([emp, month, days, ot, total]);
        });
        return aoa;
      }

      function f10DownloadXLSX(){
        try{
          const rows = Array.isArray(F10_ATT_ROWS)? F10_ATT_ROWS: [];
          if (!rows.length){ showToast('Form 10: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.','error'); return; }
          const aoa = f10RowsToAOA();
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Form10');
          const monthEl = document.getElementById('f10-att-month');
          const mv = (monthEl && monthEl.value) ? monthEl.value.replace(/\s+/g,'_') : '';
          XLSX.writeFile(wb, `Form10_Attendance_${mv||'export'}.xlsx`);
        }catch(_){ showToast('Form 10: Xu·∫•t XLSX th·∫•t b·∫°i.','error'); }
      }

      // Kh·ªüi t·∫°o modal Form 10
      (function initForm10Modal(){
        try{
          const modal = document.getElementById('f10-attendance-modal');
          if (!modal) return;
          
          // N√∫t ƒë√≥ng modal
          const closeBtn = document.getElementById('f10-attendance-close');
          if (closeBtn && !closeBtn._bound){
            closeBtn.addEventListener('click', (e)=>{
              e.preventDefault();
              modal.classList.remove('open');
              modal.setAttribute('aria-hidden','true');
            });
            closeBtn._bound = true;
          }
          
          // N√∫t Tra c·ª©u trong modal
          const searchBtn = document.getElementById('f10-att-modal-search');
          if (searchBtn && !searchBtn._bound){
            searchBtn.addEventListener('click', async (e)=>{
              e.preventDefault();
              if (searchBtn.disabled) return;
              const prev = searchBtn.textContent;
              searchBtn.disabled = true;
              searchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
              try{
                const monthInput = document.getElementById('f10-att-modal-month');
                const month = (monthInput?.value || '').trim();
                if (month){
                  await f10FetchAttendance(month);
                  renderForm10AttendanceModal(month);
                  const monthDisplay = document.getElementById('f10-attendance-month-display');
                  if (monthDisplay) monthDisplay.textContent = `${month.split('-')[1]}/${month.split('-')[0]}`;
                }
              }finally{
                searchBtn.disabled = false;
                searchBtn.textContent = prev || 'Tra c·ª©u';
              }
            });
            searchBtn._bound = true;
          }
          
          // N√∫t Xu·∫•t XLSX trong modal
          const exportBtn = document.getElementById('f10-att-modal-export-xlsx');
          if (exportBtn && !exportBtn._bound){
            exportBtn.addEventListener('click', (e)=>{
              e.preventDefault();
              f10DownloadXLSX();
            });
            exportBtn._bound = true;
          }
          
          // ƒê√≥ng modal khi click b√™n ngo√†i
          modal.addEventListener('click', (e)=>{
            if (e.target === modal){
              modal.classList.remove('open');
              modal.setAttribute('aria-hidden','true');
            }
          });
        }catch(_){
          console.error('[F10 Modal] Init error:', _);
        }
      })();


      // Global utility functions
      function fillSelect(sel, arr){ if(!sel || !arr) return; arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const candidates = ['data','rows','result','records','items','list'];
        for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const queue=[json]; const seen=new Set();
          while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
        }catch(_){ }
        return [];
      }
      function parseDateFlexible(value){
        try{
          if (value instanceof Date && !isNaN(value)) return value;
          if (typeof value === 'number'){
            const ts = Number(value);
            if (Number.isFinite(ts)) return new Date(ts > 1e12 ? ts : ts*1000);
          }
          if (!value && value !== 0) return null;
          let s = String(value).trim();
          if (!s) return null;
          s = s.replace(/\((?:GMT|UTC)[^)]+\)/ig,'');
          s = s.replace(/\b(?:GMT|UTC|ICT)\b/ig,'');
          s = s.replace(/\b(?:at|l√∫c)\b/ig,'');
          s = s.replace(/,\s*/g,' ');
          s = s.replace(/\s+/g,' ').trim();
          if (/^\d{4}-\d{2}-\d{2}[ T]\d{1,2}:\d{2}(?::\d{2})?(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?$/i.test(s)){
            const norm = s.replace(/([+-]\d{2})(\d{2})$/,'$1:$2');
            const dISO = new Date(norm);
            if (!isNaN(dISO)) return dISO;
            const m = norm.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{1,2}):(\d{2})(?::(\d{2}))?/);
            if (m) return new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0));
          }
          let m = s.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(AM|PM))?)?$/i);
          if (m){
            let d = +m[1], mo = +m[2], y = +m[3];
            if (y < 100) y += y < 50 ? 2000 : 1900;
            let h = m[4] ? +m[4] : 0, min = m[5] ? +m[5] : 0, sec = m[6] ? +m[6] : 0;
            if (m[7] && m[7].toUpperCase() === 'PM' && h < 12) h += 12;
            if (m[7] && m[7].toUpperCase() === 'AM' && h === 12) h = 0;
            const dt = new Date(y, mo-1, d, h, min, sec);
            if (!isNaN(dt)) return dt;
          }
          m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
          if (m){
            const dt = new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0));
            if (!isNaN(dt)) return dt;
          }
          const d = new Date(s);
          return isNaN(d) ? null : d;
        }catch(_){ return null; }
      }
      const f1NameEl = document.getElementById('f1-name');
      if(f1NameEl) fillSelect(f1NameEl, FORM1_NAMES);
      const f7NameEl = document.getElementById('f7-name');
      if(f7NameEl) fillSelect(f7NameEl, FORM7_NAMES);
      const f9NameSel = document.getElementById('f9-name');
      if (f9NameSel){
        // Th√™m m·ª•c T·∫•t c·∫£
        try{ const opt=document.createElement('option'); opt.value='__ALL__'; opt.textContent='T·∫•t c·∫£'; f9NameSel.appendChild(opt); }catch(_){ }
        fillSelect(f9NameSel, FORM9_NAMES);
      }
      // Create Task Modal: Fill assignee dropdown
      const createF3AssigneeSel = document.getElementById('create-f3-assignee');
      if (createF3AssigneeSel) fillSelect(createF3AssigneeSel, FORM3_ASSIGNEES);
      
      // Create Task Modal: T·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi d·∫•u ch·∫•m th√†nh d·∫•u ph·∫©y cho tr∆∞·ªùng C√¥ng chu·∫©n
      const createManHourInput = document.getElementById('create-man-hour');
      if (createManHourInput) {
        createManHourInput.addEventListener('input', function(e) {
          let value = e.target.value;
          // Chuy·ªÉn ƒë·ªïi d·∫•u ch·∫•m th√†nh d·∫•u ph·∫©y
          if (value.includes('.')) {
            value = value.replace(/\./g, ',');
            e.target.value = value;
            // Hi·ªÉn th·ªã th√¥ng b√°o nh·∫π cho ng∆∞·ªùi d√πng
            showToast('ƒê√£ t·ª± ƒë·ªông chuy·ªÉn d·∫•u ch·∫•m (.) th√†nh d·∫•u ph·∫©y (,)', 'info');
          }
        });
      }

      // Create Task Modal: C·∫≠p nh·∫≠t ch√∫ th√≠ch cho Lo·∫°i t√°c v·ª•
      (function initCreateTaskTypeNote() {
        const createTaskTypeSelect = document.getElementById('create-task-type');
        const createTaskTypeNote = document.getElementById('create-task-type-note');
        
        if (createTaskTypeSelect && createTaskTypeNote) {
          const taskTypeNotes = {
            'S·∫£n ph·∫©m': 'T√°c v·ª• ƒë√°nh gi√° SP m√°y, c√≥ m·∫´u ƒë√°nh gi√°',
            'Linh ki·ªán': 'T√°c v·ª• ƒë√°nh gi√° linh ki·ªán, c√≥ m·∫´u ƒë√°nh gi√°',
            'T√°c v·ª• kh√°c': 'C√°c t√°c v·ª• gi·∫•y t·ªù, b·ªï sung b√°o c√°o, ƒë√†o t·∫°o, c√°c t√°c v·ª• nh·ªè l·∫ª'
          };
          
          function updateCreateNote() {
            const selectedValue = createTaskTypeSelect.value;
            if (selectedValue && taskTypeNotes[selectedValue]) {
              createTaskTypeNote.textContent = taskTypeNotes[selectedValue];
              createTaskTypeNote.style.display = 'block';
            } else {
              createTaskTypeNote.textContent = '';
              createTaskTypeNote.style.display = 'none';
            }
          }
          
          createTaskTypeSelect.addEventListener('change', updateCreateNote);
          updateCreateNote();
        }
      })();
      const f5EmployeeSel = document.getElementById('f5-employee');
      if (f5EmployeeSel) fillSelect(f5EmployeeSel, FORM1_NAMES);

      // Persist selections and show last-updated notes for Form 1 & 2
      (function initPersistSelections(){
        try{
          const f1Sel = document.getElementById('f1-name');
          if (f1Sel){
            const last = LS.get('f1.selectedName');
            if (last && Array.prototype.some.call(f1Sel.options, op=> op.value===last)) f1Sel.value = last;
            f1Sel.addEventListener('change', ()=>{ LS.set('f1.selectedName', f1Sel.value||''); });
            updateLastUpdatedNote('f1-search','f1.lastUpdated');
          }
          const f7Sel = document.getElementById('f7-name');
          if (f7Sel){
            const last7 = LS.get('f7.selectedName');
            if (last7 && Array.prototype.some.call(f7Sel.options, op=> op.value===last7)) f7Sel.value = last7;
            f7Sel.addEventListener('change', ()=>{ LS.set('f7.selectedName', f7Sel.value||''); });
            updateLastUpdatedNote('f7-search','f7.lastUpdated');
          }
          const f9Sel = document.getElementById('f9-name');
          if (f9Sel){
            const last9 = LS.get('f9.selectedName');
            if (last9 && Array.prototype.some.call(f9Sel.options, op=> op.value===last9)) f9Sel.value = last9;
            f9Sel.addEventListener('change', ()=>{ LS.set('f9.selectedName', f9Sel.value||''); });
            updateLastUpdatedNote('f9-search','f9.lastUpdated');
          }
        }catch(_){ }
      })();

      // ===== Form 9: Test b·ªÅn =====
      function addTdF9(tr, text){ const td=document.createElement('td'); td.className='px-3 py-3 align-top text-gray-800 border border-gray-500'; td.textContent=text||''; tr.appendChild(td); }

      function openF9DurabilityModal(row){
        try{
          const modal = document.getElementById('f9-dur-modal');
          const closeBtn = document.getElementById('f9-dur-close');
          const cancelBtn = document.getElementById('f9-dur-cancel');
          if (!modal) return;
          // L∆∞u row hi·ªán t·∫°i v√†o data attribute c·ªßa modal ƒë·ªÉ tr√°nh closure issue
          try{
            modal._currentRow = row;
          }catch(_){ }
          // Reset tr·∫°ng th√°i n√∫t g·ª≠i m·ªói l·∫ßn m·ªü modal
          try{
            const btnSaveAll = document.getElementById('f9-dur-save-all');
            if (btnSaveAll){
              btnSaveAll.disabled = false;
              btnSaveAll.innerHTML = 'G·ª≠i d·ªØ li·ªáu';
            }
          }catch(_){ }
          // Reset c√°c input trong modal m·ªói l·∫ßn m·ªü
          try{
            document.getElementById('f9-gatea-status').value = '';
            document.getElementById('f9-gatea-note').value = '';
            const fileInput = document.getElementById('f9-gatea-file');
            if (fileInput) fileInput.value = '';
          }catch(_){ }
          // Fill header info
          try{ document.getElementById('f9-dur-assignee').textContent = row.assignee || ''; }catch(_){ }
          try{ document.getElementById('f9-dur-taskid').textContent = row.taskId || ''; }catch(_){ }
          try{ document.getElementById('f9-dur-taskname').textContent = row.taskName || ''; }catch(_){ }

          // B·∫£ng nh·∫≠p 4 b√†i test ƒë√£ ƒë∆∞·ª£c b·ªè

          const btnSaveAll = document.getElementById('f9-dur-save-all');
          if (btnSaveAll){
            if (!btnSaveAll._bound){
              btnSaveAll.addEventListener('click', async (e)=>{
                e.preventDefault();
                if (btnSaveAll.disabled) return;
                // L·∫•y row hi·ªán t·∫°i t·ª´ modal thay v√¨ d√πng closure
                const currentRow = modal._currentRow || row;
                // Kh√≥a n√∫t + spinner
                const prevHtml = btnSaveAll.innerHTML;
                btnSaveAll.disabled = true;
                btnSaveAll.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
                try{
                  try{
                    const ok = window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª≠i d·ªØ li·ªáu test b·ªÅn?');
                    if (!ok) { btnSaveAll.disabled = false; btnSaveAll.innerHTML = prevHtml; return; }
                  }catch(_){ }
                  const gateAStatus = (document.getElementById('f9-gatea-status')?.value||'')
                  const gateANote = (document.getElementById('f9-gatea-note')?.value||'')
                  const gateAFileEl = document.getElementById('f9-gatea-file');
                  const gateAHasFile = !!(gateAFileEl && gateAFileEl.files && gateAFileEl.files.length);

                  // R√†ng bu·ªôc: N·∫øu Gate A tr·∫°ng th√°i Done => b·∫Øt bu·ªôc c√≥ B·∫±ng ch·ª©ng
                  if ((gateAStatus||'').toLowerCase().includes('ho√†n') || (gateAStatus||'').toLowerCase()==='done'){
                    if (!gateAHasFile){ try{ showToast('Gate A: Tr·∫°ng th√°i Ho√†n th√†nh/Done c·∫ßn ƒë√≠nh k√®m B·∫±ng ch·ª©ng.','error'); }catch(_){ } btnSaveAll.disabled = false; btnSaveAll.innerHTML = prevHtml; return; }
                  }
                  // N·∫øu c√≥ file b·∫±ng ch·ª©ng Gate A: g·ª≠i FormData; n·∫øu kh√¥ng, g·ª≠i JSON th∆∞·ªùng
                  // Helper: fetch v·ªõi timeout + fallback no-cors
                  async function fetchWithTimeout(url, opts, timeoutMs){
                    const controller = (typeof AbortController!=='undefined') ? new AbortController() : null;
                    if (controller) opts = { ...(opts||{}), signal: controller.signal };
                    let tmo = null;
                    try{
                      const p = fetch(url, opts);
                      if (Number.isFinite(timeoutMs) && timeoutMs>0){
                        if (controller){
                          tmo = setTimeout(()=>{ try{ controller.abort(); }catch(_){} }, timeoutMs);
                        } else {
                          return await Promise.race([
                            p,
                            new Promise((_,rej)=> setTimeout(()=> rej(new Error('Timeout')), timeoutMs))
                          ]);
                        }
                      }
                      const r = await p;
                      return r;
                    } finally {
                      if (tmo) try{ clearTimeout(tmo); }catch(_){ }
                    }
                  }

                  const TIMEOUT_MS = 30000;

                  // Helper: Format timestamp th√†nh YYYY-MM-DD HH:mm
                  function formatTimestampYyyyMmDdHhMm(date) {
                    if (!date) date = new Date();
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    const hh = String(date.getHours()).padStart(2, '0');
                    const min = String(date.getMinutes()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
                  }

                  // L·∫•y Id t·ª´ currentRow - ki·ªÉm tra nhi·ªÅu ngu·ªìn v√† ƒë·∫£m b·∫£o c√≥ gi√° tr·ªã
                  const rowId = (currentRow && (currentRow.Id || currentRow.id || currentRow.ID || currentRow['Id'] || currentRow['id'] || currentRow['ID'])) || '';
                  // N·∫øu v·∫´n kh√¥ng c√≥, th·ª≠ l·∫•y t·ª´ data g·ªëc n·∫øu c√≥
                  const finalId = String(rowId || '').trim();

                  let response = null;
                  let success = false;

                  if (gateAHasFile){
                    const fd = new FormData();
                    fd.append('action','form9_update_tests_bulk');
                    fd.append('Id', finalId);
                    fd.append('taskId', currentRow.taskId||'');
                    fd.append('code', currentRow.code||'');
                    fd.append('assignee', currentRow.assignee||'');
                    fd.append('taskName', currentRow.taskName||'');
                    try{ fd.append('gate', 'Gate A'); }catch(_){ }
                    fd.append('gateAStatus', gateAStatus);
                    fd.append('noteGateA', gateANote);
                    fd.append('timestamp', formatTimestampYyyyMmDdHhMm(new Date()));
                    try{ fd.append('gateAEvidence', gateAFileEl.files[0]); }catch(_){ }
                    try{
                      response = await fetchWithTimeout(FORM9_POST_URL, { method:'POST', body: fd, mode:'cors' }, TIMEOUT_MS);
                      success = response && response.ok;
                    }catch(_){
                      // Fallback: no-cors (kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ph·∫£n h·ªìi nh∆∞ng v·∫´n k√≠ch ho·∫°t server)
                      try{
                        await fetchWithTimeout(FORM9_POST_URL, { method:'POST', body: fd, mode:'no-cors' }, 8000);
                        success = true; // Gi·∫£ ƒë·ªãnh th√†nh c√¥ng khi d√πng no-cors
                      }catch(e){
                        success = false;
                      }
                    }
                  } else {
                    // active gate info for backend (ch·ªâ c√≤n Gate A)
                    const activeGate = 'Gate A';
                    const payload = {
                      action: 'form9_update_tests_bulk',
                      Id: finalId,
                      taskId: currentRow.taskId||'',
                      code: currentRow.code||'',
                      assignee: currentRow.assignee||'',
                      taskName: currentRow.taskName||'',
                      gate: activeGate,
                      gateAStatus,
                      noteGateA: gateANote,
                      timestamp: formatTimestampYyyyMmDdHhMm(new Date())
                    };
                    try{
                      response = await fetchWithTimeout(FORM9_POST_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), mode:'cors' }, TIMEOUT_MS);
                      success = response && response.ok;
                    }catch(_){
                      // Fallback: no-cors (lo·∫°i b·ªè header ƒë·ªÉ tr√°nh b·ªã ch·∫∑n)
                      try{
                        await fetchWithTimeout(FORM9_POST_URL, { method:'POST', body: JSON.stringify(payload), mode:'no-cors' }, 8000);
                        success = true; // Gi·∫£ ƒë·ªãnh th√†nh c√¥ng khi d√πng no-cors
                      }catch(e){
                        success = false;
                      }
                    }
                  }

                  // Ch·ªâ render l·∫°i v√† hi·ªÉn th·ªã th√¥ng b√°o khi nh·∫≠n ƒë∆∞·ª£c response th√†nh c√¥ng
                  if (success){
                    try{ showToast('ƒê√£ g·ª≠i d·ªØ li·ªáu.','success'); }catch(_){ }
                    // T·ª± ƒë·ªông tra c·ª©u l·∫°i ƒë·ªÉ l√†m m·ªõi d·ªØ li·ªáu Form 9
                    try{ if (typeof renderForm9 === 'function') { await renderForm9(); } }catch(_){ }
                    // L√†m m·ªõi n·ªôi dung modal hi·ªán t·∫°i (kh√¥ng ƒë√≥ng modal)
                    try{
                      let updated = currentRow;
                      try{
                        const cached = (typeof LS!=='undefined' && LS.getJSON) ? LS.getJSON('f9.cache') : null;
                        let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : (Array.isArray(window.F9_LAST_ROWS) ? window.F9_LAST_ROWS : []);
                        const tid = String(currentRow.taskId||'').trim();
                        const codeKey = String(currentRow.code||'').trim();
                        const assigneeKey = String(currentRow.assignee||'').trim();
                        const found = rows.find(x => String(x.taskId||'').trim()===tid || (String(x.code||'').trim()===codeKey && String(x.assignee||'').trim()===assigneeKey));
                        if (found) updated = found;
                      }catch(_){ }
                      // C·∫≠p nh·∫≠t l·∫°i n·ªôi dung modal v·ªõi d·ªØ li·ªáu m·ªõi nh·∫•t
                      try{ openF9DurabilityModal(updated); }catch(_){ }
                    }catch(_){ }
                    // ƒê·ªïi tr·∫°ng th√°i n√∫t th√†nh 'ƒê√£ g·ª≠i' v√† gi·ªØ kho√° cho ƒë·∫øn khi ƒë√≥ng modal
                    try{ btnSaveAll.innerHTML = 'ƒê√£ g·ª≠i'; btnSaveAll.disabled = true; }catch(_){ }
                  } else {
                    // N·∫øu kh√¥ng th√†nh c√¥ng, hi·ªÉn th·ªã l·ªói v√† m·ªü kh√≥a n√∫t
                    try{ showToast('G·ª≠i d·ªØ li·ªáu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.','error'); }catch(_){ }
                    btnSaveAll.disabled = false;
                    btnSaveAll.innerHTML = prevHtml;
                    return;
                  }
                }catch(err){
                  try{ showToast('L∆∞u th·∫•t b·∫°i.','error'); }catch(_){ }
                  // M·ªü kh√≥a n√∫t n·∫øu l·ªói
                  btnSaveAll.disabled = false;
                  btnSaveAll.innerHTML = prevHtml;
                  return;
                }
                // Gi·ªØ tr·∫°ng th√°i kh√≥a cho ƒë·∫øn khi modal ƒë√≥ng
              });
              btnSaveAll._bound = true;
            }
          }

          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
          if (closeBtn && !closeBtn._bound){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); closeBtn._bound = true; }
          if (cancelBtn && !cancelBtn._bound){ cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); cancelBtn._bound = true; }
          if (!modal._bound){ modal.addEventListener('click', (e)=>{ if (e.target===modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }); modal._bound = true; }
        }catch(_){ }
      }

      function restoreForm9FromCache(){
        try{
          const cached = LS.getJSON('f9.cache');
          const name = LS.get('f9.selectedName')||'';
          if (!cached || !Array.isArray(cached.rows) || !name) return false;
          const body = document.getElementById('f9-body');
          if (!body) return false;
          renderForm9FromRows(cached.rows);
          updateLastUpdatedNote('f9-search','f9.lastUpdated');
          return true;
        }catch(_){ return false; }
      }

      function renderForm9FromRows(rows){
        const body = document.getElementById('f9-body');
        if (!body) return;
        if (!Array.isArray(rows) || !rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="12">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
        body.innerHTML = '';
        const name = (document.getElementById('f9-name')?.value || '').trim();
        const monthFilter = (document.getElementById('f9-month')?.value || '').trim();
        // Page size fixed default (no external selector)
        const pageSize = 50;
        let filtered = Array.isArray(rows) ? rows.slice() : [];
        if (monthFilter){
          filtered = filtered.filter(r => {
            const s = String(r.actualCompletionDate || '').trim();
            if (!s) return false;
            const d = (typeof toDateSafe==='function') ? toDateSafe(s) : new Date(s);
            if (!d || isNaN(d)) return false;
            const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return ym === monthFilter;
          });
        }
        if (!filtered.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="12">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
        const limited = filtered.slice(0, Math.max(1, pageSize));
        limited.forEach((r, idx)=>{
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          try{
            const dueStr = r.durabilityDue || '';
            const d = (typeof toDateSafe==='function') ? toDateSafe(dueStr) : new Date(dueStr);
            if (d && !isNaN(d)){
              const today = new Date();
              const dStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());
              const tStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
              if (dStart.getTime() === tStart.getTime()){
                tr.classList.add('bg-yellow-100');
              } else if (dStart.getTime() < tStart.getTime()){
                tr.classList.add('bg-red-100');
              }
            }
          }catch(_){ }
          // STT
          const sttDisp = (r.rowNumber || r.STT || r.row_number || (idx+1));
          addTdF9(tr, String(sttDisp));
          // Khai b√°o test b·ªÅn (button)
          const tdAction = document.createElement('td');
          tdAction.className = 'px-3 py-3 align-top text-gray-800 border border-gray-500';
          const btn = document.createElement('button');
          btn.className = 'px-3 py-1 rounded text-white bg-primary-blue hover:brightness-105 text-sm font-medium';
          btn.textContent = 'S·ª≠a/khai b√°o';
          (function(rowSnapshot){
            // Ghim b·∫£n sao d·ªØ li·ªáu h√†ng ƒë·ªÉ tr√°nh b·ªã thay ƒë·ªïi do render l·∫°i ho·∫∑c thay ƒë·ªïi m·∫£ng ngu·ªìn
            btn.onclick = (e)=>{
              e.preventDefault();
              e.stopPropagation();
              try{ openF9DurabilityModal(rowSnapshot); }catch(_){ try{ showToast('Ch·ª©c nƒÉng ƒëang c·∫≠p nh·∫≠t.','info'); }catch(__){} }
            };
          })({ ...r, Id: r.Id || r.id || r.ID || r['Id'] || r['id'] || r['ID'] || '' });
          tdAction.appendChild(btn);
          tr.appendChild(tdAction);
          // Ng√†y tr·∫£ BC t·ª©c th·ªùi (ƒë∆∞a ngay sau c·ªôt Khai b√°o)
          addTdF9(tr, (typeof formatDdMmYyyy==='function') ? formatDdMmYyyy(r.actualCompletionDate||'') : (r.actualCompletionDate||''));
          // T√¨nh tr·∫°ng test b·ªÅn (m√†u theo tr·∫°ng th√°i)
          (function(){
            const td=document.createElement('td');
            td.className='px-3 py-3 align-top text-gray-800 border border-gray-500';
            const val = String(r.durability||'').trim();
            td.textContent = val;
            const v = val.toLowerCase();
            if (v.includes('ho√†n th√†nh')){ td.classList.add('bg-green-50','text-green-800'); }
            else if (v.includes('ƒëang tri·ªÉn khai') || v.includes('dang trien khai')){ td.classList.add('bg-yellow-50','text-yellow-800'); }
            tr.appendChild(td);
          })();
          // Link b·∫±ng ch·ª©ng (gi·ªØa Tr·∫°ng th√°i v√† D·ª± ki·∫øn ho√†n th√†nh)
          (function(){
            const td=document.createElement('td');
            td.className='px-3 py-3 align-top text-gray-800 border border-gray-500';
            const url = String(r.gateAEvidence||'').trim();
            if (url){
              const a = document.createElement('a');
              a.href = url;
              a.target = '_blank';
              a.rel = 'noopener';
              a.className = 'text-primary-blue underline';
              a.textContent = 'M·ªü';
              td.appendChild(a);
            }
            tr.appendChild(td);
          })();
          // D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn
          addTdF9(tr, (typeof formatDdMmYyyy==='function') ? formatDdMmYyyy(r.durabilityDue||'') : (r.durabilityDue||''));
          // M√£
          addTdF9(tr, r.code||'');
          // Task Name
          addTdF9(tr, r.taskName||'');
          // Assignee
          addTdF9(tr, r.assignee||'');
          // M√£ B√°o c√°o
          addTdF9(tr, r.reportCode||'');
          // M√£ t√°c v·ª•
          addTdF9(tr, r.taskId||'');
          // Ghi ch√∫ (Gate A)
          addTdF9(tr, r.noteGateA || r.note || '');
          body.appendChild(tr);
        });
      }

      async function renderForm9(){
        const rawName = (document.getElementById('f9-name')?.value || '').trim();
        const norm = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
        const n = norm(rawName);
        const isAll = (!rawName) ? false : (n === '__all__' || n === 'all' || n === 'tat ca' || n === 'tatca' || n === 't·∫•t c·∫£');
        const name = isAll ? '__ALL__' : rawName;
        const body = document.getElementById('f9-body');
        if (!body) return;
        if (!name){ body.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500" colspan="12">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
        body.innerHTML = "<tr><td colspan='12' class='px-3 py-4 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        try{
          // ƒê∆°n gi·∫£n h√≥a: ch·ªâ g·ª≠i person_name n·∫øu c√≥, webhook m·ªõi kh√¥ng c·∫ßn c√°c tham s·ªë kh√°c
          const params = new URLSearchParams();
          if (name && name !== '__ALL__') params.append('person_name', name);
          const url = `${FORM9_LOOKUP_URL}?${params.toString()}`;
          const resp = await fetch(url, { method: 'GET' });
          const text = await resp.text();
          if (!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
          let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
          function pickRows(json){
            if (!json) return [];
            if (Array.isArray(json)) return json;
            const candidates = ['data','rows','result','records','items','list'];
            for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
            try{
              const queue=[json]; const seen=new Set();
              while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
            }catch(_){ }
            return [];
          }
          let rowsRaw = pickRows(data);
          // Unwrap n8n format [{ json: {...} }]
          if (Array.isArray(rowsRaw) && rowsRaw.length && rowsRaw.every(x=> x && typeof x==='object' && ('json' in x))){
            rowsRaw = rowsRaw.map(x=> x.json);
          }
          // Convert table [[headers...], [...]] -> objects
          if (Array.isArray(rowsRaw) && rowsRaw.length && Array.isArray(rowsRaw[0])){
            try{
              const header = rowsRaw[0].map(h=> String(h||'').trim());
              rowsRaw = rowsRaw.slice(1).map(r=>{
                const o={}; header.forEach((k,i)=>{ o[k]= Array.isArray(r)? r[i]: undefined; }); return o;
              });
            }catch(_){ }
          }
          // Helper: get value by flexible keys (diacritics/spacing insensitive)
          const getV = (obj, keys)=>{
            const sanitize = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=sanitize(k); lower[k1]=v; });
            for (const k of keys){ const c=sanitize(k); if (c in lower) return lower[c]; }
            // includes fallback
            for (const k of keys){ const c=sanitize(k); const m = Object.keys(lower).find(kk=> kk.includes(c)); if (m) return lower[m]; }
            return '';
          };
          let normRows = rowsRaw.map(item=>{
            const code = getV(item,['code','m√£','ma','taskcode','componentcode']);
            const taskIdRaw = getV(item,['taskid','task_id','m√£ t√°c v·ª•','ma_tac_vu','requestid','id']);
            const taskId = (typeof pickTaskIdPreferQA==='function') ? pickTaskIdPreferQA(taskIdRaw, code) : (taskIdRaw || code);
            // L·∫•y Id t·ª´ item - ki·ªÉm tra nhi·ªÅu c√°ch
            const itemId = item.Id || item.id || item.ID || item['Id'] || item['id'] || item['ID'] || getV(item,['Id','id','ID']) || '';
            return {
              Id: String(itemId || '').trim(),
              rowNumber: getV(item,['row_number','stt','STT']),
              assignee: getV(item,['Assignee','assignee','employee','ng∆∞·ªùi ph·ª• tr√°ch','nguoi_phu_trach','nhanvien','nh√¢n vi√™n']),
              code: code || getV(item,['M√£']),
              taskName: getV(item,['Task Name','taskname','task name','t√™n t√°c v·ª•','ten_tac_vu','name','title']),
              reportCode: getV(item,['M√£ B√°o c√°o','reportcode','ma_bao_cao','report_id','reportid']),
              taskId,
              result: getV(item,['K·∫øt qu·∫£','result','ket_qua']),
              actualCompletionDate: getV(item,['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','actualcompletiondate','ngay hoan thanh thuc te','ng√†y ho√†n th√†nh','ngay hoan thanh']),
              durability: getV(item,['T√¨nh tr·∫°ng test b·ªÅn','T√¨nh tr·∫°ng Test b·ªÅn','tinh trang test ben','tinh_trang_test_ben','durability_status','status_durability']),
              durabilityDue: getV(item,['D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn','ngay_du_kien_tra_test_ben','du_kien_hoan_thanh_test_ben','testbenduedate']),
              durabilityActual: getV(item,['Ng√†y ho√†n th√†nh test b·ªÅn th·ª±c t·∫ø','ngay_hoan_thanh_test_ben_thuc_te','durability_actual']),
              noteGateA: getV(item,['Ghi ch√∫ test b·ªÅn','Ghi ch√∫ Test b·ªÅn','ghi ch√∫ test b·ªÅn','ghi chu test ben','ghi_chu_test_ben','Ghi ch√∫','ghi ch√∫','note','ghi_chu','noteGateA','note_gate_a','ghi ch√∫ gate a','gate a note']),
              gateAStatus: getV(item,['Tr·∫°ng th√°i Gate A','gate a status','gatea status','gatea_status','status gate a']),
              gateAEvidence: getV(item,['Link b·∫±ng ch·ª©ng','link b·∫±ng ch·ª©ng','B·∫±ng ch·ª©ng Gate A','bang chung gate a','gate a evidence','gatea evidence','gatea_file','gateAEvidence'])
            };
          });
          // Locally filter by assignee when not All
          if (name && name !== '__ALL__'){
            const key = (typeof vnLower==='function') ? vnLower(name) : name.toLowerCase();
            normRows = normRows.filter(r => {
              const a = String(r.assignee||'');
              const ak = (typeof vnLower==='function') ? vnLower(a) : a.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
              return ak === key;
            });
          }
          renderForm9FromRows(normRows);
          try{ window.F9_LAST_ROWS = normRows; }catch(_){ }
          try{ LS.setJSON('f9.cache', { name, rows: normRows, ts: Date.now() }); LS.set('f9.lastUpdated', String(Date.now())); updateLastUpdatedNote('f9-search','f9.lastUpdated'); }catch(_){ }
        }catch(err){
          body.innerHTML = `<tr><td colspan='12' class='px-3 py-4 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
        }
      }

      const f9SearchBtn = document.getElementById('f9-search');
      if (f9SearchBtn){
        let f9Busy = false;
        f9SearchBtn.onclick = async (e)=>{
          e.preventDefault();
          if (f9Busy) return;
          f9Busy = true;
          f9SearchBtn.disabled = true;
          const prev = f9SearchBtn.textContent;
          f9SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
          try{ await renderForm9(); }
          finally{
            f9Busy = false;
            f9SearchBtn.disabled = false;
            f9SearchBtn.textContent = prev || 'Tra c·ª©u';
          }
        };
      }
      // Form 9: Stats modal
      (function initF9Stats(){
        const btn = document.getElementById('f9-open-stats');
        if (!btn || btn._bound) return;
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          try{
            const cached = LS.getJSON('f9.cache');
            let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : [];
            if (!rows.length && Array.isArray(window.F9_LAST_ROWS)) rows = window.F9_LAST_ROWS;
            openF9StatsModal(rows);
          }catch(_){ openF9StatsModal([]); }
        });
        btn._bound = true;
      })();

      // Form 9: Export XLSX
      (function initF9Export(){
        const btn = document.getElementById('f9-export-xlsx');
        if (!btn || btn._bound) return;
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          try{
            const cached = LS.getJSON('f9.cache');
            let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : (Array.isArray(window.F9_LAST_ROWS) ? window.F9_LAST_ROWS : []);
            if (!rows.length){ try{ showToast('Form 9: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.','error'); }catch(_){ } return; }
            const aoa = f9RowsToAOA(rows);
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Form9');
            const name = (document.getElementById('f9-name')?.value||'').trim().replace(/\s+/g,'_');
            XLSX.writeFile(wb, `Form9_${name||'export'}.xlsx`);
          }catch(_){ try{ showToast('Form 9: Xu·∫•t XLSX th·∫•t b·∫°i.','error'); }catch(__){} }
        });
        btn._bound = true;
      })();

      // ===== Form 13: H·ªá th·ªëng test b·ªÅn m·ªõi =====
      const F13_COLS = ['Id','Linh ki·ªán','Ng∆∞·ªùi l·∫≠p','M√£ t√°c v·ª•','M√£ danh m·ª•c','H·∫°ng m·ª•c ki·ªÉm tra','Ti√™u chu·∫©n','C√¥ng c·ª•','Type','Document','Available','T√¨nh tr·∫°ng','Ghi ch√∫'];
      function renderForm13FromRows(rows){
        const body = document.getElementById('f13-body');
        if (!body) return;
        if (!Array.isArray(rows) || !rows.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="13">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }
        function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        body.innerHTML = rows.map(function(r){
          const cells = F13_COLS.map(function(k){
            let v = r[k];
            if (v == null || v === undefined) v = '';
            v = esc(String(v)).replace(/\n/g, '<br>');
            return '<td class="px-3 py-2 text-gray-800 align-top border border-gray-500">' + (v || '‚Äî') + '</td>';
          }).join('');
          return '<tr class="hover:bg-blue-50/50">' + cells + '</tr>';
        }).join('');
      }
      async function renderForm13(){
        const body = document.getElementById('f13-body');
        const btn = document.getElementById('f13-search');
        if (!body) return;
        body.innerHTML = "<tr><td colspan='13' class='px-3 py-4 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        if (btn){ btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i..."; }
        try {
          const resp = await fetch(FORM13_LOOKUP_URL, { method: 'GET' });
          const text = await resp.text();
          if (!resp.ok) throw new Error(text || 'HTTP ' + resp.status);
          let data = [];
          try {
            const parsed = JSON.parse(text);
            if (Array.isArray(parsed)) data = parsed;
            else if (parsed && Array.isArray(parsed.data)) data = parsed.data;
            else if (parsed && Array.isArray(parsed.rows)) data = parsed.rows;
          } catch(_){ data = []; }
          renderForm13FromRows(data);
          try { LS.setJSON('f13.cache', { rows: data, ts: Date.now() }); } catch(_){}
        } catch(err) {
          body.innerHTML = '<tr><td colspan="13" class="px-3 py-3 text-center text-red-600 border border-gray-500">L·ªói: ' + (err.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu') + '</td></tr>';
          try { showToast('Form 13: ' + (err.message || 'L·ªói t·∫£i d·ªØ li·ªáu'), 'error'); } catch(_){}
        } finally {
          if (btn){ btn.disabled = false; btn.innerHTML = 'T·∫£i d·ªØ li·ªáu'; }
        }
      }
      (function initF13(){
        const btn = document.getElementById('f13-search');
        if (btn && !btn._bound){
          btn.addEventListener('click', function(e){ e.preventDefault(); renderForm13(); });
          btn._bound = true;
        }
      })();

      function f9RowsToAOA(items){
        const head = ['STT','Khai b√°o test b·ªÅn','Ng√†y tr·∫£ BC t·ª©c th·ªùi','T√¨nh tr·∫°ng test b·ªÅn','Link b·∫±ng ch·ª©ng','D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn','M√£','Task Name','Assignee','M√£ B√°o c√°o','M√£ t√°c v·ª•','Ghi ch√∫'];
        const aoa = [head];
        (Array.isArray(items)? items:[]).forEach((r, i)=>{
          const row = [
            r.rowNumber || i+1,
            'S·ª≠a/khai b√°o',
            r.actualCompletionDate || '',
            r.durability || '',
            r.gateAEvidence || '',
            r.durabilityDue || '',
            r.code || '',
            r.taskName || '',
            r.assignee || '',
            r.reportCode || '',
            r.taskId || '',
            r.noteGateA || r.note || ''
          ];
          aoa.push(row);
        });
        return aoa;
      }

      function openF9StatsModal(rows){
        try{
          const modal = document.getElementById('f9-stats-modal');
          const body = document.getElementById('f9-stats-body');
          if (!modal || !body) return;
          const name = (document.getElementById('f9-name')?.value || '').trim();
          const monthFilter = (document.getElementById('f9-month')?.value || '').trim();
          // Filter by person and month like table
          let list = Array.isArray(rows) ? rows.slice() : [];
          if (name && name !== '__ALL__'){
            const key = (typeof vnLower==='function') ? vnLower(name) : name.toLowerCase();
            list = list.filter(r=>{
              const a = String(r.assignee||'');
              const ak = (typeof vnLower==='function') ? vnLower(a) : a.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
              return ak === key;
            });
          }
          if (monthFilter){
            list = list.filter(r=>{
              const s = String(r.actualCompletionDate||'').trim();
              if(!s) return false;
              const d = (typeof toDateSafe==='function') ? toDateSafe(s) : new Date(s);
              if (!d || isNaN(d)) return false;
              const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
              return ym === monthFilter;
            });
          }
          // Build stats
          const today = new Date();
          const tStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          let total = 0, dueToday = 0, overdue = 0;
          const byStatus = new Map();
          list.forEach(r=>{
            total++;
            const k = String(r.durability||'').trim() || '(Tr·ªëng)';
            byStatus.set(k, (byStatus.get(k)||0)+1);
            const ds = r.durabilityDue || '';
            const d = (typeof toDateSafe==='function') ? toDateSafe(ds) : new Date(ds);
            if (d && !isNaN(d)){
              const dStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());
              if (dStart.getTime() === tStart.getTime()) dueToday++;
              else if (dStart.getTime() < tStart.getTime()) overdue++;
            }
          });
          // Render table
          const rowsHtml = Array.from(byStatus.entries()).map(([st, cnt])=>`<tr><td class="px-3 py-2">${st}</td><td class="px-3 py-2 text-right">${cnt}</td></tr>`).join('');
          body.innerHTML = `
            <div class="mb-3 text-sm text-gray-700">T·ªïng t√°c v·ª•: <b>${total}</b> ¬∑ ƒê·∫øn h·∫°n h√¥m nay: <b class="text-amber-700">${dueToday}</b> ¬∑ Qu√° h·∫°n: <b class="text-red-700">${overdue}</b></div>
            <div class="overflow-auto border border-gray-200 rounded-lg">
              <table class="min-w-[420px] w-full text-sm">
                <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0"><tr class="text-left text-gray-700"><th class="px-3 py-2">T√¨nh tr·∫°ng test b·ªÅn</th><th class="px-3 py-2 text-right">S·ªë l∆∞·ª£ng</th></tr></thead>
                <tbody class="divide-y divide-gray-100">${rowsHtml || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="2">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'}</tbody>
              </table>
            </div>`;
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
        }catch(_){ }
      }
      // Bind close for stats modal
      (function bindF9StatsClose(){
        try{
          const modal = document.getElementById('f9-stats-modal');
          const closeBtn = document.getElementById('f9-stats-close');
          const cancelBtn = document.getElementById('f9-stats-cancel');
          if (closeBtn && !closeBtn._bound){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); closeBtn._bound = true; }
          if (cancelBtn && !cancelBtn._bound){ cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); cancelBtn._bound = true; }
          if (modal && !modal._bound){ modal.addEventListener('click', (e)=>{ if (e.target===modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }); modal._bound = true; }
        }catch(_){ }
      })();
      // Form 9: Month filter events
      const f9MonthInput = document.getElementById('f9-month');
      const f9ClearMonthBtn = document.getElementById('f9-clear-month');
      const f9SizeSel = document.getElementById('f9-size');
      if (f9MonthInput){
        f9MonthInput.addEventListener('change', ()=>{
          try{
            const cached = LS.getJSON('f9.cache');
            if (cached && Array.isArray(cached.rows)) renderForm9FromRows(cached.rows);
            else if (Array.isArray(window.F9_LAST_ROWS)) renderForm9FromRows(window.F9_LAST_ROWS);
          }catch(_){ }
        });
      }
      if (f9ClearMonthBtn){
        f9ClearMonthBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          const el = document.getElementById('f9-month');
          if (el){ el.value=''; }
          try{
            const cached = LS.getJSON('f9.cache');
            if (cached && Array.isArray(cached.rows)) renderForm9FromRows(cached.rows);
            else if (Array.isArray(window.F9_LAST_ROWS)) renderForm9FromRows(window.F9_LAST_ROWS);
          }catch(_){ }
        });
      }
      if (f9SizeSel){
        const onSizeChange = ()=>{
          try{
            const val = f9SizeSel.value || '10';
            try{ if (typeof LS!=='undefined' && LS.set) LS.set('f9.pageSize', val); else localStorage.setItem('f9.pageSize', val); }catch(_){ }
            const cached = LS.getJSON('f9.cache');
            if (cached && Array.isArray(cached.rows)) renderForm9FromRows(cached.rows);
            else if (Array.isArray(window.F9_LAST_ROWS)) renderForm9FromRows(window.F9_LAST_ROWS);
          }catch(_){ }
        };
        f9SizeSel.addEventListener('change', onSizeChange);
        f9SizeSel.addEventListener('input', onSizeChange);
        // Apply saved value if present
        try{
          const saved = (typeof LS!=='undefined' && LS.get) ? LS.get('f9.pageSize') : localStorage.getItem('f9.pageSize');
          if (saved && f9SizeSel.value !== saved){ f9SizeSel.value = saved; }
        }catch(_){ }
      }

      // Delegated listeners to be extra robust
      // Remove delegated size handler since size selector removed
      document.addEventListener('click', (e)=>{
        const t = e.target;
        if (t && t.id === 'f9-open-stats'){
          e.preventDefault();
          try{
            const cached = LS.getJSON('f9.cache');
            let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : [];
            if (!rows.length && Array.isArray(window.F9_LAST_ROWS)) rows = window.F9_LAST_ROWS;
            openF9StatsModal(rows);
          }catch(_){ openF9StatsModal([]); }
        }
      });

      // Ensure Form 9 controls exist even if HTML cache is stale
      (function ensureF9Controls(){
        try{
          const form = document.getElementById('form9');
          if (!form) return;
          let controls = document.getElementById('f9-controls');
          if (!controls){
            // Insert before the table container
            const tableWrap = Array.from(form.children).find(el=> el && el.className && el.className.includes('overflow-x-auto'));
            controls = document.createElement('div');
            controls.id = 'f9-controls';
            controls.className = 'mt-2 flex items-center gap-2';
            controls.innerHTML = '<label class="text-sm text-gray-700">Hi·ªÉn th·ªã</label>'+
              '<select id="f9-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">'+
              '<option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select>'+
              '<button id="f9-open-stats" class="ml-2 px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700">Th·ªëng k√™</button>';
            if (tableWrap && tableWrap.parentNode){ tableWrap.parentNode.insertBefore(controls, tableWrap); }
            // Rebind events
            const sizeEl = document.getElementById('f9-size');
            if (sizeEl && !sizeEl._bound){ sizeEl.addEventListener('change', ()=>{ try{ const c=LS.getJSON('f9.cache'); if (c && Array.isArray(c.rows)) renderForm9FromRows(c.rows); }catch(_){ } }); sizeEl._bound=true; }
            const statsBtn = document.getElementById('f9-open-stats');
            if (statsBtn && !statsBtn._bound){ statsBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ const cached=LS.getJSON('f9.cache'); const rows=(cached&&Array.isArray(cached.rows))?cached.rows:[]; openF9StatsModal(rows);}catch(_){ openF9StatsModal([]);} }); statsBtn._bound=true; }
          }
        }catch(_){ }
      })();

      // Toast
      const toastEl = document.getElementById('toast');
      function showToast(msg,type='info'){
        toastEl.textContent = msg;
        toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), 2600);
      }

      // Modal functions
      function openModal(id){ 
        const m = document.getElementById(id); 
        if(m){ 
          m.classList.add('open'); 
          m.setAttribute('aria-hidden','false'); 
        } 
      }
      function closeModal(id){ 
        const m = document.getElementById(id); 
        if(m){ 
          m.classList.remove('open'); 
          m.setAttribute('aria-hidden','true'); 
        } 
      }

      // Bind modal close buttons
      (function initModalCloseButtons(){
        document.querySelectorAll('[data-close]').forEach(btn => {
          if (!btn._modalBound) {
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              const modalId = btn.getAttribute('data-close');
              if (modalId) closeModal(modalId);
            });
            btn._modalBound = true;
          }
        });
        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
          if (!modal._clickBound) {
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                const modalId = modal.id;
                closeModal(modalId);
              }
            });
            modal._clickBound = true;
          }
        });
      })();

      // ==== Sidebar: Nh√≥m/Accordion + ƒêi·ªÅu h∆∞·ªõng Form ====
      (function initSidebarGroups(){
        try{
          const sections = Array.from(document.querySelectorAll('main section[id^="form"]'));
          function showSection(id){
            sections.forEach(sec=>{ if (!sec || !sec.id) return; sec.classList.toggle('hidden', sec.id !== id); });
            try{ localStorage.setItem('app.lastForm', id); }catch(_){ }
            // M·ªü nh√≥m ch·ª©a n√∫t ƒëang ch·ªçn
            try{
              const btn = document.querySelector(`.nav-btn[data-target="${id}"]`);
              if (btn){
                const group = btn.closest('.rounded-md');
                const items = group && group.querySelector('.group-items');
                if (items){ items.classList.remove('hidden'); }
              }
            }catch(_){ }
          }
          // Click item -> chuy·ªÉn form
          document.querySelectorAll('.nav-btn[data-target]').forEach(btn=>{
            if (btn._boundNav) return; btn._boundNav = true;
            btn.addEventListener('click', (e)=>{
              e.preventDefault(); const id = btn.getAttribute('data-target'); if (!id) return; showSection(id);
            });
          });
          // Toggle nh√≥m
          document.querySelectorAll('.group-btn').forEach(h=>{
            if (h._boundGrp) return; h._boundGrp = true;
            h.addEventListener('click', (e)=>{
              e.preventDefault(); const wrap = h.parentElement; if (!wrap) return; const items = wrap.querySelector('.group-items'); if (!items) return; const nowHidden = items.classList.toggle('hidden'); if (nowHidden){ h.classList.remove('active'); } else { h.classList.add('active'); }
            });
          });
          // Kh·ªüi t·∫°o: kh√¥i ph·ª•c form g·∫ßn nh·∫•t ho·∫∑c m·∫∑c ƒë·ªãnh form1
          let last = '';
          try{ last = localStorage.getItem('app.lastForm') || ''; }catch(_){ last=''; }
          const defaultId = last || 'form1';
          if (!document.getElementById(defaultId)){
            // fallback n·∫øu kh√¥ng t·ªìn t·∫°i (v√≠ d·ª• form1 ƒë√£ ·∫©n/ƒë·ªïi id)
            const any = sections.find(s=> s && s.id);
            if (any) showSection(any.id);
          } else {
            showSection(defaultId);
            if (defaultId === 'form12') { setTimeout(function(){ try { if (typeof renderForm12Data === 'function' && (!F12_LAST_ROWS || F12_LAST_ROWS.length === 0)) renderForm12Data(); } catch(_){} }, 0); }
          }
          // ƒê√°nh d·∫•u active cho nh√≥m ch·ª©a form ƒëang m·ªü
          try{
            const activeBtn = document.querySelector(`.nav-btn[data-target="${defaultId}"]`);
            if (activeBtn){ const wrap = activeBtn.closest('.rounded-md'); const head = wrap && wrap.querySelector('.group-btn'); const items = wrap && wrap.querySelector('.group-items'); if (items){ items.classList.remove('hidden'); } if (head){ head.classList.add('active'); } }
          }catch(_){ }
        }catch(_){ }
      })();

      // Upload modal
      // ===== Form 1: Export helpers =====
      function f1RowsToAOA(items){
        const head = ['Tr·∫°ng th√°i','M√£ t√°c v·ª•','M√£','T√™n t√°c v·ª•','Tgian n·ªôp form','Ng√†y c·∫ßn tr·∫£ BC','Ng∆∞·ªùi y√™u c·∫ßu','Ng∆∞·ªùi nh·∫≠n m·∫´u','C√¥ng chu·∫©n','Ng√†y y√™u c·∫ßu','H·∫°n mong mu·ªën','M·ª•c ƒë√≠ch ƒë√°nh gi√°','Note','Y√™u c·∫ßu test ƒë·∫∑c bi·ªát','Form b√°o c√°o','T√™n file','Link'];
        const aoa = [head];
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        (Array.isArray(items)? items:[]).forEach(it=>{
          const code = getV(it,['code','ma','taskcode','m√£']);
          const tname = getV(it,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          const statusText = getV(it,['status','trangthai','trang_thai','tr·∫°ng th√°i']);
          const submitTimeRaw = getV(it,['submittime','submit_time','submitTime','tgian nop form','thoi_gian_nop_form','th·ªùi gian n·ªôp form']);
          const reportDue = getV(it,['reportduedate','report_due_date','reportDueDate','ngay can tra bc','ngay_can_tra_bc','ng√†y c·∫ßn tr·∫£ bc']);
          const requester = getV(it,['requester','nguoiyeucau','nguoi_yeu_cau','assigner','ng∆∞·ªùi y√™u c·∫ßu']);
          const receiver = getV(it,['receiver','receivername','nguoinhanmau','nguoi_nhan_mau','ng∆∞·ªùi nh·∫≠n m·∫´u','recipient','assignee','ng∆∞·ªùi nh·∫≠n']);
          const man = getV(it,[ 'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n' ]);
          const requestDate = getV(it,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
          const wishDue = getV(it,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
          const purpose = getV(it,['purpose','mucdich','muc_dich','m·ª•c ƒë√≠ch ƒë√°nh gi√°','muc dich danh gia','mucdichdanhgia']);
          const note = getV(it,['note','ghi_chu','ghichu']);
          const special = getV(it,['specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']);
          const reportForm = getV(it,['reportform','form_bao_cao','form_bao_cao_danh_gia']);
          const fileName = getV(it,[ 'attachmentfilename','file_name','filename','tenfile','ten_file','t√™n file','t√™n file ƒë√≠nh k√®m','attachment','file' ]);
          const url = getV(it,[ 'attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url' ]);
          const taskId = getV(it,['taskid','task_id','ma_tac_vu','m√£ t√°c v·ª•','taskcode2','requestid','id']);
          aoa.push([statusText,taskId,code,tname,submitTimeRaw,reportDue,requester,receiver,man,requestDate,wishDue,purpose,note,special,reportForm,fileName,url]);
        });
        return aoa;
      }
      function f1DownloadXLSX(){
        try{
          let items = [];
          try{ const raw = LS.getJSON('f1.raw'); if (raw && Array.isArray(raw.rows)) items = raw.rows; }catch(_){ }
          if (!items.length && Array.isArray(window.F1_LAST_RAW)) items = window.F1_LAST_RAW;
          if (!items.length){ showToast('Form 1: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.','error'); return; }
          const aoa = f1RowsToAOA(items);
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Form1');
          const name = (document.getElementById('f1-name')?.value||'').trim().replace(/\s+/g,'_');
          XLSX.writeFile(wb, `Form1_${name||'export'}.xlsx`);
        }catch(_){ showToast('Form 1: Xu·∫•t XLSX th·∫•t b·∫°i.','error'); }
      }
      (function initF1Exports(){
        const btnXlsx = document.getElementById('f1-export-xlsx');
        if (btnXlsx) btnXlsx.addEventListener('click', (e)=>{ e.preventDefault(); f1DownloadXLSX(); });
      })();
      const modal = document.getElementById('upload-modal');
      const fileInput = document.getElementById('upload-file');
      const uploaderName = document.getElementById('uploader-name');
      const uploaderCode = document.getElementById('uploader-code');
      const uploaderTask = document.getElementById('uploader-task');
      let uploadContext = null;
      let isModalSubmitting = false;
      let lastOpenTrigger = null;
      function openUploadModal(ctx){
        uploadContext = ctx || {};
        uploaderName.textContent = ctx?.name || '';
        uploaderCode.textContent = ctx?.code || '';
        uploaderTask.textContent = ctx?.taskName || '';
        // Hide Ng∆∞·ªùi n·ªôp pill for Form 2 per request
        try {
          const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
          if (namePill) namePill.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
          const bpsOption = document.getElementById('bps-option');
          const bpsCheckbox = document.getElementById('upload-bps');
          const isSystemTask = ctx?.isSystemTask === true;
          // Khi system=1: ·∫©n checkbox BPS
          if (bpsOption) bpsOption.style.display = (ctx && ctx.form === 'Form 2') || isSystemTask ? 'none' : '';
          if (bpsCheckbox) bpsCheckbox.checked = (ctx && ctx.form === 'Form 1' && !isSystemTask) ? true : false;
          const singleWrap = document.getElementById('upload-form2-single');
          const splitWrap = document.getElementById('upload-form1-split');
          const tabsWrap = document.getElementById('upload-tabs-wrap');
          const conclGroup = document.getElementById('upload-conclusion-group');
          const classifGroup = document.getElementById('upload-classification-group');
          const durGroup = document.getElementById('upload-durability-group');
          const durDateWrap = document.getElementById('durability-date-wrap');
          const durDate = document.getElementById('durability-date');
          const gate2Wrap = document.getElementById('upload-gate2');
          const gate3Wrap = document.getElementById('upload-gate3');
          const gate3Tab = document.getElementById('tab-gate3');
          const gate3Content = document.getElementById('upload-gate3-content');
          if (ctx && ctx.form === 'Form 1'){
            const isSystemTask = ctx?.isSystemTask === true;
            const isDone = ctx?.isDone === true;
            if (singleWrap) singleWrap.style.display = 'none';
            if (splitWrap) splitWrap.style.display = '';
            if (tabsWrap) tabsWrap.style.display = '';
            if (gate2Wrap) gate2Wrap.style.display = 'none';
            if (gate3Wrap) gate3Wrap.style.display = 'none';
            if (gate3Content) gate3Content.value = '';
            // Reset file inputs c·ªßa Gate 3
            try { const pdfG3 = document.getElementById('upload-file-pdfzip-g3'); if (pdfG3) pdfG3.value = ''; } catch(_){}
            try { const xlsxG3 = document.getElementById('upload-file-xlsxzip-g3'); if (xlsxG3) xlsxG3.value = ''; } catch(_){}
            // Reset hi·ªÉn th·ªã c√°c tr∆∞·ªùng Gate 3 v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu (hi·ªÉn th·ªã t·∫•t c·∫£)
            try {
              // Hi·ªÉn th·ªã l·∫°i tr∆∞·ªùng PDF
              const pdfG3Input = document.getElementById('upload-file-pdfzip-g3');
              if (pdfG3Input) {
                const pdfG3Div = pdfG3Input.closest('div');
                if (pdfG3Div) pdfG3Div.style.display = '';
              }
              // Hi·ªÉn th·ªã l·∫°i tr∆∞·ªùng K·∫øt lu·∫≠n
              const gate3WrapEl = document.getElementById('upload-gate3');
              if (gate3WrapEl) {
                const conclG3Labels = gate3WrapEl.querySelectorAll('label');
                if (conclG3Labels) {
                  conclG3Labels.forEach(label => {
                    if (label.textContent && label.textContent.includes('K·∫øt lu·∫≠n')) {
                      const conclG3Div = label.closest('div.mt-3');
                      if (conclG3Div) conclG3Div.style.display = '';
                    }
                  });
                }
              }
              // Hi·ªÉn th·ªã l·∫°i tr∆∞·ªùng N·ªôi dung c·∫≠p nh·∫≠t
              const contentG3Textarea = document.getElementById('upload-gate3-content');
              if (contentG3Textarea) {
                const contentG3Div = contentG3Textarea.closest('div.mt-3');
                if (contentG3Div) contentG3Div.style.display = '';
              }
              // Hi·ªÉn th·ªã l·∫°i n√∫t tick BPS
              const bpsOption = document.getElementById('bps-option');
              if (bpsOption) bpsOption.style.display = '';
            } catch(_){}
            
            // Khi system=1: ch·ªâ hi·ªÉn th·ªã Gate 1, ·∫©n Gate 2 v√† Gate 3, ch·ªâ y√™u c·∫ßu Excel
            // NH∆ØNG n·∫øu isDone = true: hi·ªÉn th·ªã Gate 3 thay v√¨ Gate 1
            if (isSystemTask && !isDone) {
              // ·∫®n t·∫•t c·∫£ tabs tr·ª´ Gate 1
              const t1 = document.getElementById('tab-gate1');
              const t2 = document.getElementById('tab-gate2');
              const t3 = document.getElementById('tab-gate3');
              if (t1) t1.style.display = '';
              if (t2) t2.style.display = 'none';
              if (t3) t3.style.display = 'none';
              // ·∫®n t·∫•t c·∫£ c√°c tr∆∞·ªùng kh√¥ng c·∫ßn thi·∫øt
              if (conclGroup) conclGroup.style.display = 'none';
              if (classifGroup) classifGroup.style.display = 'none';
              if (durGroup) durGroup.style.display = 'none';
              if (durDateWrap) durDateWrap.style.display = 'none';
              // ·∫®n input PDF, ch·ªâ hi·ªÉn th·ªã Excel
              try {
                const pdfInput = document.getElementById('upload-file-pdfzip');
                if (pdfInput) {
                  // T√¨m div cha ch·ª©a c·∫£ label v√† input
                  const parentDiv = pdfInput.closest('div');
                  if (parentDiv && parentDiv.querySelector('label')) {
                    parentDiv.style.display = 'none';
                  }
                  pdfInput.value = '';
                }
              } catch(_){}
              // K√≠ch ho·∫°t Gate 1
              try {
                const g1t = document.getElementById('gate1-title');
                const g2t = document.getElementById('gate2-title');
                const g3t = document.getElementById('gate3-title');
                if (g1t) g1t.style.display = '';
                if (g2t) g2t.style.display = 'none';
                if (g3t) g3t.style.display = 'none';
                if (t1) {
                  t1.classList.add('bg-primary-blue','text-white');
                  t1.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400');
                }
                // ·∫®n checkbox BPS khi system task
                const bpsOption = document.getElementById('bps-option');
                if (bpsOption) bpsOption.style.display = 'none';
              } catch(_){}
            } else {
              // Kh√¥ng ph·∫£i system task: hi·ªÉn th·ªã nh∆∞ b√¨nh th∆∞·ªùng
              if (conclGroup) conclGroup.style.display = '';
              if (classifGroup) classifGroup.style.display = '';
              if (durGroup) durGroup.style.display = '';
              if (durDateWrap) durDateWrap.style.display = 'none';
              try { document.querySelectorAll('input[name="durability-choice"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
              try { document.querySelectorAll('input[name="upload-classification"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
              try { 
                const noteEl = document.getElementById('classification-note');
                if (noteEl) noteEl.style.display = 'none';
              } catch(_){ }
              try { if (durDate) durDate.value = ''; } catch(_){ }
              // Hi·ªÉn th·ªã tab Gate 3 ch·ªâ khi t√°c v·ª• ƒë√£ done
              if (gate3Tab) gate3Tab.style.display = isDone ? '' : 'none';
            }
            
            // N·∫øu isDone = true (b·∫•t k·ªÉ system task hay kh√¥ng), ch·ªâ hi·ªÉn th·ªã Gate 3 v√† ·∫©n Gate 1, Gate 2
            if (isDone) {
              const t1 = document.getElementById('tab-gate1');
              const t2 = document.getElementById('tab-gate2');
              const t3 = document.getElementById('tab-gate3');
              if (t1) t1.style.display = 'none';
              if (t2) t2.style.display = 'none';
              if (t3) t3.style.display = '';
              // T·ª± ƒë·ªông k√≠ch ho·∫°t Gate 3
              try {
                if (splitWrap) splitWrap.style.display = 'none';
                if (conclGroup) conclGroup.style.display = 'none';
                if (classifGroup) classifGroup.style.display = 'none';
                if (durGroup) durGroup.style.display = 'none';
                if (gate3Wrap) gate3Wrap.style.display = '';
                const g1t = document.getElementById('gate1-title');
                const g2t = document.getElementById('gate2-title');
                const g3t = document.getElementById('gate3-title');
                if (g1t) g1t.style.display = 'none';
                if (g2t) g2t.style.display = 'none';
                if (g3t) g3t.style.display = '';
                if (t3) {
                  t3.classList.add('bg-cyan-700','text-white','border-cyan-800','shadow');
                  t3.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400');
                }
                // Khi system task + done: ch·ªâ hi·ªÉn th·ªã tr∆∞·ªùng Excel, ·∫©n PDF, K·∫øt lu·∫≠n, N·ªôi dung c·∫≠p nh·∫≠t, BPS
                if (isSystemTask) {
                  try {
                    // ·∫®n tr∆∞·ªùng PDF (t√¨m div cha ch·ª©a label v√† input)
                    const pdfG3Input = document.getElementById('upload-file-pdfzip-g3');
                    if (pdfG3Input) {
                      const pdfG3Div = pdfG3Input.closest('div');
                      if (pdfG3Div) pdfG3Div.style.display = 'none';
                    }
                    // ·∫®n tr∆∞·ªùng K·∫øt lu·∫≠n (t√¨m div ch·ª©a label "K·∫øt lu·∫≠n")
                    const conclG3Labels = gate3Wrap?.querySelectorAll('label');
                    if (conclG3Labels) {
                      conclG3Labels.forEach(label => {
                        if (label.textContent && label.textContent.includes('K·∫øt lu·∫≠n')) {
                          const conclG3Div = label.closest('div.mt-3');
                          if (conclG3Div) conclG3Div.style.display = 'none';
                        }
                      });
                    }
                    // ·∫®n tr∆∞·ªùng N·ªôi dung c·∫≠p nh·∫≠t (t√¨m div ch·ª©a textarea)
                    const contentG3Textarea = document.getElementById('upload-gate3-content');
                    if (contentG3Textarea) {
                      const contentG3Div = contentG3Textarea.closest('div.mt-3');
                      if (contentG3Div) contentG3Div.style.display = 'none';
                    }
                    // ·∫®n n√∫t tick BPS
                    const bpsOption = document.getElementById('bps-option');
                    if (bpsOption) bpsOption.style.display = 'none';
                  } catch(_){}
                } else {
                  const bpsOption = document.getElementById('bps-option');
                  if (bpsOption) bpsOption.style.display = '';
                  const bpsCheckbox = document.getElementById('upload-bps');
                  if (bpsCheckbox) bpsCheckbox.checked = true;
                }
              } catch(_){ }
            } else if (!isSystemTask) {
              // N·∫øu kh√¥ng ph·∫£i Done v√† kh√¥ng ph·∫£i system task, hi·ªÉn th·ªã Gate 1 v√† Gate 2 nh∆∞ b√¨nh th∆∞·ªùng
              const t1 = document.getElementById('tab-gate1');
              const t2 = document.getElementById('tab-gate2');
              if (t1) t1.style.display = '';
              if (t2) t2.style.display = '';
              try{
                const t1 = document.getElementById('tab-gate1');
                const t2 = document.getElementById('tab-gate2');
                const t3 = document.getElementById('tab-gate3');
                if (t1 && t2){
                  t1.classList.add('bg-primary-blue','text-white');
                  t2.classList.remove('bg-primary-blue','text-white');
                }
                if (t3) t3.classList.remove('bg-primary-blue','text-white');
                document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              }catch(_){ }
            }
            
            // K√≠ch ho·∫°t hi·ªáu ·ª©ng highlight cho Form 1 (ch·ªâ khi kh√¥ng ph·∫£i Done v√† kh√¥ng ph·∫£i system task)
            if (!isDone && !isSystemTask) {
              setTimeout(() => {
                try {
                  const conclGroup = document.getElementById('upload-conclusion-group');
                  const classifGroup = document.getElementById('upload-classification-group');
                  const durGroup = document.getElementById('upload-durability-group');
                  if (conclGroup) {
                    conclGroup.classList.add('highlight-section');
                    // Lo·∫°i b·ªè class sau khi animation k·∫øt th√∫c
                    setTimeout(() => {
                      conclGroup.classList.remove('highlight-section');
                    }, 2000);
                  }
                  if (classifGroup) {
                    classifGroup.classList.add('highlight-section');
                    // Lo·∫°i b·ªè class sau khi animation k·∫øt th√∫c
                    setTimeout(() => {
                      classifGroup.classList.remove('highlight-section');
                    }, 2000);
                  }
                  if (durGroup) {
                    durGroup.classList.add('highlight-section');
                    // Lo·∫°i b·ªè class sau khi animation k·∫øt th√∫c
                    setTimeout(() => {
                      durGroup.classList.remove('highlight-section');
                    }, 2000);
                  }
                } catch(_) {}
              }, 300); // Delay ƒë·ªÉ ƒë·∫£m b·∫£o modal ƒë√£ hi·ªÉn th·ªã
            }
          } else {
            if (singleWrap) singleWrap.style.display = '';
            if (splitWrap) splitWrap.style.display = 'none';
            if (tabsWrap) tabsWrap.style.display = 'none';
            if (conclGroup) conclGroup.style.display = 'none';
            if (classifGroup) classifGroup.style.display = 'none';
            if (durGroup) durGroup.style.display = 'none';
            if (gate2Wrap) gate2Wrap.style.display = 'none';
            if (gate3Wrap) gate3Wrap.style.display = 'none';
            if (gate3Tab) gate3Tab.style.display = 'none';
          }
        } catch(_) {}
        fileInput.value = '';
        // Reset text hi·ªÉn th·ªã cho Form 2
        try { 
          const fileNameSpan = document.getElementById('upload-file-name');
          if (fileNameSpan) {
            fileNameSpan.textContent = 'Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn';
            fileNameSpan.className = 'text-sm text-gray-600';
          }
        } catch(_){ }
        try { document.getElementById('upload-file-pdfzip').value = ''; } catch(_){}
        try { document.getElementById('upload-file-xlsxzip').value = ''; } catch(_){}
        try { document.getElementById('upload-file-archive-g2').value = ''; } catch(_){ }
        try { const gate3Content = document.getElementById('upload-gate3-content'); if (gate3Content) gate3Content.value = ''; } catch(_){ }
        try { document.getElementById('upload-file-pdfzip-g3').value = ''; } catch(_){}
        try { document.getElementById('upload-file-xlsxzip-g3').value = ''; } catch(_){}
        // Reset radio buttons cho Form 1
        try { document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
        try { document.querySelectorAll('input[name="upload-conclusion-g3"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }
      function closeUploadModal(){
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
        // Re-enable last trigger and reset submit button state
        if (lastOpenTrigger) {
          try {
            lastOpenTrigger.disabled = false;
            if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
          } catch(_) {}
          lastOpenTrigger = null;
        }
        const sendBtn = document.getElementById('btn-send');
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.textContent = 'G·ª≠i b√°o c√°o';
        }
        isModalSubmitting = false;
      }
      document.getElementById('btn-cancel').onclick = closeUploadModal;
      modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });
      // Tabs: Gate 1 / Gate 2 / Gate 3
      (function initUploadTabs(){
        try{
          const t1 = document.getElementById('tab-gate1');
          const t2 = document.getElementById('tab-gate2');
          const t3 = document.getElementById('tab-gate3');
          const conclGroup = document.getElementById('upload-conclusion-group');
          const gate2Wrap = document.getElementById('upload-gate2');
          const gate3Wrap = document.getElementById('upload-gate3');
          const splitWrap = document.getElementById('upload-form1-split');
          const contentWrap = document.getElementById('upload-content') || document.querySelector('#upload-modal .p-4');
          function activateGate1(){
            try{
              if (t1){ t1.classList.add('bg-cyan-700','text-white','border-cyan-800','shadow'); t1.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400'); }
              if (t2){ t2.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t2.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
              if (t3){ t3.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t3.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
            }catch(_){ }
            try{ conclGroup && (conclGroup.style.display = ''); }catch(_){ }
            try{ const classifGroup = document.getElementById('upload-classification-group'); if (classifGroup) classifGroup.style.display = ''; }catch(_){ }
            try{ const durGroup = document.getElementById('upload-durability-group'); if (durGroup) durGroup.style.display = ''; }catch(_){ }
            try{ gate2Wrap && (gate2Wrap.style.display = 'none'); }catch(_){ }
            try{ gate3Wrap && (gate3Wrap.style.display = 'none'); }catch(_){ }
            try{ const classifGroupG2 = document.getElementById('upload-classification-group-g2'); if (classifGroupG2) classifGroupG2.style.display = 'none'; }catch(_){ }
            try{ splitWrap && (splitWrap.style.display = ''); }catch(_){ }
            try{ if (contentWrap) { contentWrap.style.background = 'linear-gradient(180deg, rgba(207,250,254,0.35), rgba(255,255,255,0))'; contentWrap.style.transition = 'background 200ms ease'; } }catch(_){ }
            try{ const g1t = document.getElementById('gate1-title'); if (g1t) g1t.style.display = ''; }catch(_){ }
            try{ const g2t = document.getElementById('gate2-title'); if (g2t) g2t.style.display = 'none'; }catch(_){ }
            try{ const g3t = document.getElementById('gate3-title'); if (g3t) g3t.style.display = 'none'; }catch(_){ }
            try{
              const bpsOption = document.getElementById('bps-option');
              if (bpsOption) bpsOption.style.display = '';
              const bpsCheckbox = document.getElementById('upload-bps');
              if (bpsCheckbox) bpsCheckbox.checked = true;
            }catch(_){ }
          }
          function activateGate2(){
            try{
              if (t2){ t2.classList.add('bg-cyan-700','text-white','border-cyan-800','shadow'); t2.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400'); }
              if (t1){ t1.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t1.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
              if (t3){ t3.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t3.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
            }catch(_){ }
            try{ conclGroup && (conclGroup.style.display = 'none'); }catch(_){ }
            try{ const classifGroup = document.getElementById('upload-classification-group'); if (classifGroup) classifGroup.style.display = 'none'; }catch(_){ }
            try{ const durGroup = document.getElementById('upload-durability-group'); if (durGroup) durGroup.style.display = 'none'; }catch(_){ }
            try{ gate2Wrap && (gate2Wrap.style.display = ''); }catch(_){ }
            try{ gate3Wrap && (gate3Wrap.style.display = 'none'); }catch(_){ }
            try{ const classifGroupG2 = document.getElementById('upload-classification-group-g2'); if (classifGroupG2) classifGroupG2.style.display = ''; }catch(_){ }
            try{
              // reset Gate 1 inputs when chuy·ªÉn sang Gate 2
              const pdf = document.getElementById('upload-file-pdfzip'); if (pdf) pdf.value = '';
              const xlsx = document.getElementById('upload-file-xlsxzip'); if (xlsx) xlsx.value = '';
              const dateDur = document.getElementById('durability-date'); if (dateDur) dateDur.value = '';
              const gate3Content = document.getElementById('upload-gate3-content'); if (gate3Content) gate3Content.value = '';
              document.querySelectorAll('input[name="durability-choice"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-conclusion-g3"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-classification"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-classification-g2"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              try { 
                const noteEl = document.getElementById('classification-note');
                if (noteEl) noteEl.style.display = 'none';
              } catch(_){ }
            }catch(_){ }
            try{ splitWrap && (splitWrap.style.display = 'none'); }catch(_){ }
            try{ if (contentWrap) { contentWrap.style.background = 'linear-gradient(180deg, rgba(232,121,249,0.18), rgba(255,255,255,0))'; contentWrap.style.transition = 'background 200ms ease'; } }catch(_){ }
            try{ const g1t = document.getElementById('gate1-title'); if (g1t) g1t.style.display = 'none'; }catch(_){ }
            try{ const g2t = document.getElementById('gate2-title'); if (g2t) g2t.style.display = ''; }catch(_){ }
            try{ const g3t = document.getElementById('gate3-title'); if (g3t) g3t.style.display = 'none'; }catch(_){ }
            try{
              const bpsOption = document.getElementById('bps-option');
              if (bpsOption) bpsOption.style.display = 'none';
              const bpsCheckbox = document.getElementById('upload-bps');
              if (bpsCheckbox) bpsCheckbox.checked = false;
            }catch(_){ }
          }
          function activateGate3(){
            try{
              if (t3){ t3.classList.add('bg-cyan-700','text-white','border-cyan-800','shadow'); t3.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400'); }
              if (t1){ t1.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t1.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
              if (t2){ t2.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t2.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
            }catch(_){ }
            try{ conclGroup && (conclGroup.style.display = 'none'); }catch(_){ }
            try{ const classifGroup = document.getElementById('upload-classification-group'); if (classifGroup) classifGroup.style.display = 'none'; }catch(_){ }
            try{ const durGroup = document.getElementById('upload-durability-group'); if (durGroup) durGroup.style.display = 'none'; }catch(_){ }
            try{ gate2Wrap && (gate2Wrap.style.display = 'none'); }catch(_){ }
            try{ gate3Wrap && (gate3Wrap.style.display = ''); }catch(_){ }
            try{ const classifGroupG2 = document.getElementById('upload-classification-group-g2'); if (classifGroupG2) classifGroupG2.style.display = 'none'; }catch(_){ }
            try{
              // reset Gate 1 & Gate 2 inputs when chuy·ªÉn sang Gate 3
              const pdf = document.getElementById('upload-file-pdfzip'); if (pdf) pdf.value = '';
              const xlsx = document.getElementById('upload-file-xlsxzip'); if (xlsx) xlsx.value = '';
              const dateDur = document.getElementById('durability-date'); if (dateDur) dateDur.value = '';
              const arch = document.getElementById('upload-file-archive-g2'); if (arch) arch.value = '';
              document.querySelectorAll('input[name="durability-choice"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-conclusion-g3"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-classification"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              document.querySelectorAll('input[name="upload-classification-g2"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
              try { 
                const noteEl = document.getElementById('classification-note');
                if (noteEl) noteEl.style.display = 'none';
              } catch(_){ }
            }catch(_){ }
            try{ splitWrap && (splitWrap.style.display = 'none'); }catch(_){ }
            try{ if (contentWrap) { contentWrap.style.background = 'linear-gradient(180deg, rgba(34,197,94,0.15), rgba(255,255,255,0))'; contentWrap.style.transition = 'background 200ms ease'; } }catch(_){ }
            try{ const g1t = document.getElementById('gate1-title'); if (g1t) g1t.style.display = 'none'; }catch(_){ }
            try{ const g2t = document.getElementById('gate2-title'); if (g2t) g2t.style.display = 'none'; }catch(_){ }
            try{ const g3t = document.getElementById('gate3-title'); if (g3t) g3t.style.display = ''; }catch(_){ }
            try{
              const bpsOption = document.getElementById('bps-option');
              if (bpsOption) bpsOption.style.display = '';
              const bpsCheckbox = document.getElementById('upload-bps');
              if (bpsCheckbox) bpsCheckbox.checked = true;
            }catch(_){ }
          }
          if (t1 && !t1._bound){ t1.addEventListener('click', (e)=>{ e.preventDefault(); activateGate1(); }); t1._bound = true; }
          if (t2 && !t2._bound){ t2.addEventListener('click', (e)=>{ e.preventDefault(); activateGate2(); }); t2._bound = true; }
          if (t3 && !t3._bound){ t3.addEventListener('click', (e)=>{ e.preventDefault(); activateGate3(); }); t3._bound = true; }
          
        }catch(_){ }
      })();
      // Show/hide ng√†y d·ª± ki·∫øn tr·∫£ test b·ªÅn theo l·ª±a ch·ªçn
      (function initDurabilityChoice(){
        try{
          // Gate 1 durability choice
          const wrap = document.getElementById('durability-date-wrap');
          const radios = document.querySelectorAll('input[name="durability-choice"]');
          function update(){
            try{
              let v = '';
              radios.forEach(r=>{ if (r && r.checked) v = r.value || ''; });
              if (wrap) wrap.style.display = (v === 'co') ? '' : 'none';
            }catch(_){ }
          }
          radios.forEach(r=>{ r.addEventListener('change', update); });
          
        }catch(_){ }
      })();

      // Show/hide ch√∫ th√≠ch ph√¢n lo·∫°i theo l·ª±a ch·ªçn
      (function initClassificationNote(){
        try{
          const noteEl = document.getElementById('classification-note');
          const radios = document.querySelectorAll('input[name="upload-classification"]');
          function update(){
            try{
              let v = '';
              radios.forEach(r=>{ if (r && r.checked) v = r.value || ''; });
              if (!noteEl) return;
              if (v === 'S·∫£n ph·∫©m' || v === 'Linh ki·ªán') {
                noteEl.textContent = 'D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c g·ª≠i l√™n h·ªá th·ªëng ph√¢n t√≠ch';
                noteEl.style.display = '';
              } else if (v === 'T√°c v·ª• kh√°c') {
                noteEl.textContent = 'D·ªØ li·ªáu s·∫Ω KH√îNG ƒë∆∞·ª£c g·ª≠i l√™n h·ªá th·ªëng ph√¢n t√≠ch';
                noteEl.style.display = '';
              } else {
                noteEl.style.display = 'none';
              }
            }catch(_){ }
          }
          radios.forEach(r=>{ r.addEventListener('change', update); });
          
        }catch(_){ }
      })();


      document.getElementById('btn-send').onclick = async ()=>{
        if (isModalSubmitting) return;
        const isForm1 = (uploadContext && uploadContext.form === 'Form 1');
        const btn = document.getElementById('btn-send');
        const bpsCheckbox = document.getElementById('upload-bps');
        const bpsChecked = bpsCheckbox ? bpsCheckbox.checked : false;
        function extOf(name){ const m = String(name||'').toLowerCase().match(/\.([a-z0-9]+)$/); return m?m[1]:''; }
        let fd = new FormData();
        if (isForm1) {
          // Determine active gate
          const g2Wrap = document.getElementById('upload-gate2');
          const g3Wrap = document.getElementById('upload-gate3');
          const isGate2 = !!(g2Wrap && g2Wrap.style.display !== 'none');
          const isGate3 = !!(g3Wrap && g3Wrap.style.display !== 'none');
          if (isGate3){
            // Gate 3: C·∫≠p nh·∫≠t b√°o c√°o (c√≥ th·ªÉ upload file PDF/Excel v√† n·ªôi dung c·∫≠p nh·∫≠t)
            const gate3Content = document.getElementById('upload-gate3-content');
            const content = gate3Content ? (gate3Content.value || '').trim() : '';
            const isSystemTaskG3 = uploadContext?.isSystemTask === true;
            // Khi system task: kh√¥ng b·∫Øt bu·ªôc n·ªôi dung c·∫≠p nh·∫≠t, ch·ªâ c·∫ßn file Excel
            if (!isSystemTaskG3 && !content){ showToast('Vui l√≤ng nh·∫≠p n·ªôi dung c·∫≠p nh·∫≠t.','error'); return; }
            
            const pdfInputG3 = document.getElementById('upload-file-pdfzip-g3');
            const xlsxInputG3 = document.getElementById('upload-file-xlsxzip-g3');
            const okPdf = ['pdf'];
            const okXlsx = ['xlsx'];
            
            let fPdfG3 = null;
            let fXlsxG3 = null;
            
            // Ki·ªÉm tra file PDF n·∫øu c√≥
            if (pdfInputG3 && pdfInputG3.files && pdfInputG3.files.length > 0){
              fPdfG3 = pdfInputG3.files[0];
              const extPdf = extOf(fPdfG3.name);
              if (okPdf.indexOf(extPdf)===-1){ showToast('File PDF kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.','error'); return; }
            }
            
            // Ki·ªÉm tra file Excel n·∫øu c√≥
            if (xlsxInputG3 && xlsxInputG3.files && xlsxInputG3.files.length > 0){
              fXlsxG3 = xlsxInputG3.files[0];
              const extX = extOf(fXlsxG3.name);
              if (okXlsx.indexOf(extX)===-1){ showToast('File Excel kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (.xlsx).','error'); return; }
              // Ki·ªÉm tra t√™n file ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng QA.R.xx-xxxxxx
              const fileNameWithoutExt = fXlsxG3.name.replace(/\.xlsx$/i, '');
              const fileNamePattern = /^QA\.R\.\d{2}-\d{6}$/i;
              if (!fileNamePattern.test(fileNameWithoutExt)){
                showToast('T√™n file Excel ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng: QA.R.xx-xxxxxx (v√≠ d·ª•: QA.R.25-023028)','error');
                return;
              }
            }
            // Khi system task: b·∫Øt bu·ªôc ph·∫£i c√≥ file Excel
            if (isSystemTaskG3 && !fXlsxG3){
              showToast('Vui l√≤ng ch·ªçn file Excel ƒë·ªÉ c·∫≠p nh·∫≠t b√°o c√°o.','error');
              return;
            }
            
            isModalSubmitting = true;
            if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
            
            // Append files n·∫øu c√≥
            if (fPdfG3) {
              fd.append('file_pdfzip', fPdfG3);
              fd.append('file_name', fPdfG3.name || '');
            }
            if (fXlsxG3) {
              fd.append('file_xlsxzip', fXlsxG3);
              fd.append('file_name_xlsx', fXlsxG3.name || '');
            }
            
            fd.append('noi_dung_cap_nhat', content);
            fd.append('upload_type', fXlsxG3 ? (fPdfG3 ? 'pdf_xlsx' : 'xlsx_only') : (fPdfG3 ? 'pdf_only' : 'text_only'));
            fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
            
            // Append Gate 3 conclusion if selected
            try{
              const conclusionPicked = (function(){ const els = document.querySelectorAll('input[name="upload-conclusion-g3"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
              if (conclusionPicked) fd.append('ket_luan', conclusionPicked);
            }catch(_){ }
            
            if(uploadContext){
              fd.append('nguoi_nop', uploadContext.name||'');
              const taskIdVal = uploadContext.taskId || uploadContext.code || '';
              fd.append('ma_tac_vu', taskIdVal);
              fd.append('ten_tac_vu', uploadContext.taskName||'');
              fd.append('form', uploadContext.form||'Form 1');
              if (uploadContext.id !== undefined && uploadContext.id !== null && uploadContext.id !== '') {
                fd.append('id', String(uploadContext.id));
              }
              // Th√™m flag system=1 n·∫øu l√† lu·ªìng system task
              if (uploadContext.isSystemTask === true) {
                fd.append('system', '1');
              }
              // Th√™m flag isupdate="yes" n·∫øu l√† system task v√† ƒë√£ Done
              if (uploadContext.isSystemTask === true && uploadContext.isDone === true) {
                fd.append('isupdate', 'yes');
              }
            }
            // Khi system=1: kh√¥ng g·ª≠i is_bps ho·∫∑c g·ª≠i is_bps = '0'
            if (!uploadContext?.isSystemTask && bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
            try{
              const conclusionPicked = (function(){ const els = document.querySelectorAll('input[name="upload-conclusion-g3"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
              const meta = {
                action: 'form1_upload',
                gate: 'Gate 3',
                person_name: uploadContext?.name || '',
                taskId: (uploadContext?.taskId || uploadContext?.code || ''),
                code: uploadContext?.code || '',
                taskName: uploadContext?.taskName || '',
                noi_dung_cap_nhat: content,
                ket_luan: conclusionPicked || '',
                upload_type: fXlsxG3 ? (fPdfG3 ? 'pdf_xlsx' : 'xlsx_only') : (fPdfG3 ? 'pdf_only' : 'text_only'),
                is_bps: uploadContext?.isSystemTask === true ? '0' : (bpsChecked ? '1' : '0'),
                system: uploadContext?.isSystemTask === true ? '1' : '0',
                isupdate: (uploadContext?.isSystemTask === true && uploadContext?.isDone === true) ? 'yes' : '',
                timestamp_iso: new Date().toISOString()
              };
              fd.append('meta_json', JSON.stringify(meta));
              fd.append('body', JSON.stringify(meta));
              // T√°ch ri√™ng id ra body ri√™ng
              if (uploadContext?.id !== undefined && uploadContext?.id !== null && uploadContext?.id !== '') {
                fd.append('id_body', String(uploadContext.id));
              }
              fd.append('action', 'form1_upload');
              fd.append('gate', 'Gate 3');
            }catch(_){ }
            try{
              // Khi system=1: g·ª≠i ƒë·∫øn webhook ri√™ng
              const uploadUrl = uploadContext?.isSystemTask === true ? FORM1_SYSTEM_UPLOAD_URL : FORM1_UPLOAD_URL;
              await fetch(uploadUrl,{method:'POST',body:fd, mode: 'no-cors'});
              showToast('ƒê√£ g·ª≠i c·∫≠p nh·∫≠t b√°o c√°o Gate 3.','success');
              closeUploadModal();
              // T·ª± ƒë·ªông refresh b·∫£ng Form 1 sau khi g·ª≠i th√†nh c√¥ng
              try { if (typeof renderForm1 === 'function') await renderForm1(); } catch(_){}
            } catch(e){
              console.error(e);
              showToast('G·ª≠i th·∫•t b·∫°i.','error');
              isModalSubmitting = false;
              if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
            }
            return;
          }
          if (isGate2){
            // Gate 2: only archive
            const arch = document.getElementById('upload-file-archive-g2');
            if (!arch || !arch.files || arch.files.length===0){ showToast('Vui l√≤ng ch·ªçn t·ªáp n√©n (.zip/.rar/.7z).','error'); return; }
            const fArc = arch.files[0];
            const ext = extOf(fArc.name);
            const okArc = ['zip','rar','7z'];
            if (okArc.indexOf(ext)===-1){ showToast('Ch·ªâ nh·∫≠n t·ªáp n√©n .zip/.rar/.7z cho Gate 2.','error'); return; }
            isModalSubmitting = true;
            if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
            fd.append('file_archive', fArc);
            fd.append('upload_type', 'archive_only');
            fd.append('file_name', fArc.name || '');
            fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
            // Gate 2: k·∫øt lu·∫≠n m·∫∑c ƒë·ªãnh (·∫©n)
            try { fd.append('ket_luan', 'B√°o c√°o m√°y Base, r√† so√°t tem nh√£n'); } catch(_){ }
            if(uploadContext){
              fd.append('nguoi_nop', uploadContext.name||'');
              const taskIdVal = uploadContext.taskId || uploadContext.code || '';
              fd.append('ma_tac_vu', taskIdVal);
              fd.append('ten_tac_vu', uploadContext.taskName||'');
              fd.append('form', uploadContext.form||'Form 1');
              if (uploadContext.id !== undefined && uploadContext.id !== null && uploadContext.id !== '') {
                fd.append('id', String(uploadContext.id));
              }
              // Th√™m flag system=1 n·∫øu l√† lu·ªìng system task
              if (uploadContext.isSystemTask === true) {
                fd.append('system', '1');
              }
            }
            // Append Gate 2 classification if selected
            try{
              const classifPickedG2 = (function(){ const els = document.querySelectorAll('input[name="upload-classification-g2"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
              if (classifPickedG2) fd.append('phan_loai', classifPickedG2);
            }catch(_){ }
            try{
              const classifPickedG2 = (function(){ const els = document.querySelectorAll('input[name="upload-classification-g2"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
              const meta = {
                action: 'form1_upload',
                gate: 'Gate 2',
                person_name: uploadContext?.name || '',
                taskId: (uploadContext?.taskId || uploadContext?.code || ''),
                code: uploadContext?.code || '',
                taskName: uploadContext?.taskName || '',
                ket_luan: 'B√°o c√°o m√°y Base, r√† so√°t tem nh√£n',
                phan_loai: classifPickedG2 || '',
                is_bps: uploadContext?.isSystemTask === true ? '0' : (bpsChecked ? '1' : '0'),
                system: uploadContext?.isSystemTask === true ? '1' : '0',
                upload_type: 'archive_only',
                timestamp_iso: new Date().toISOString()
              };
              fd.append('meta_json', JSON.stringify(meta));
              fd.append('body', JSON.stringify(meta));
              // T√°ch ri√™ng id ra body ri√™ng
              if (uploadContext?.id !== undefined && uploadContext?.id !== null && uploadContext?.id !== '') {
                fd.append('id_body', String(uploadContext.id));
              }
              fd.append('action', 'form1_upload');
              fd.append('gate', 'Gate 2');
            }catch(_){ }
            try{
              // Khi system=1: g·ª≠i ƒë·∫øn webhook ri√™ng
              const uploadUrl = uploadContext?.isSystemTask === true ? FORM1_SYSTEM_UPLOAD_URL : FORM1_UPLOAD_URL;
              await fetch(uploadUrl,{method:'POST',body:fd, mode: 'no-cors'});
              showToast('ƒê√£ g·ª≠i b√°o c√°o Gate 2.','success');
              closeUploadModal();
              // T·ª± ƒë·ªông refresh b·∫£ng Form 1 sau khi g·ª≠i th√†nh c√¥ng
              try { if (typeof renderForm1 === 'function') await renderForm1(); } catch(_){}
            } catch(e){
              console.error(e);
              showToast('G·ª≠i th·∫•t b·∫°i.','error');
              isModalSubmitting = false;
              if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
            }
            return;
          }
          const pdfInput = document.getElementById('upload-file-pdfzip');
          const xlsxInput = document.getElementById('upload-file-xlsxzip');
          const okPdf = ['pdf'];
          const okXlsx = ['xlsx'];
          const isSystemTask = uploadContext?.isSystemTask === true;
          
          // Khi system=1: ch·ªâ y√™u c·∫ßu file Excel, kh√¥ng c·∫ßn PDF
          let fPdf = null;
          if (!isSystemTask) {
            // Kh√¥ng ph·∫£i system task: y√™u c·∫ßu PDF nh∆∞ b√¨nh th∆∞·ªùng
            if (!pdfInput || !pdfInput.files || pdfInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn file PDF.','error'); return; }
            fPdf = pdfInput.files[0];
            const extPdf = extOf(fPdf.name);
            if (okPdf.indexOf(extPdf)===-1){ showToast('File PDF kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.','error'); return; }
          }
          
          // B·∫Øt bu·ªôc ph·∫£i n·ªôp file Excel
          if (!xlsxInput || !xlsxInput.files || xlsxInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn file Excel (.xlsx).','error'); return; }
          const fXlsx = xlsxInput.files[0];
          const extX = extOf(fXlsx.name);
          if (okXlsx.indexOf(extX)===-1){ showToast('File Excel kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (.xlsx).','error'); return; }
          // Ki·ªÉm tra t√™n file ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng QA.R.xx-xxxxxx
          const fileNameWithoutExt = fXlsx.name.replace(/\.xlsx$/i, '');
          const fileNamePattern = /^QA\.R\.\d{2}-\d{6}$/i;
          if (!fileNamePattern.test(fileNameWithoutExt)){
            showToast('T√™n file Excel ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng: QA.R.xx-xxxxxx (v√≠ d·ª•: QA.R.25-023028)','error');
            return;
          }
        isModalSubmitting = true;
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
          // Append files
          if (fPdf) fd.append('file_pdfzip', fPdf);
          fd.append('file_xlsxzip', fXlsx);
          fd.append('upload_type', isSystemTask ? 'xlsx_only' : (fPdf ? 'pdf_xlsx' : 'xlsx_only'));
          if (fPdf) fd.append('file_name', fPdf.name || '');
          fd.append('file_name_xlsx', fXlsx.name || '');
          fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          if(uploadContext){
            fd.append('nguoi_nop', uploadContext.name||'');
            const taskIdVal = uploadContext.taskId || uploadContext.code || '';
            fd.append('ma_tac_vu', taskIdVal);
            fd.append('ten_tac_vu', uploadContext.taskName||'');
            fd.append('form', uploadContext.form||'Form 1');
            if (uploadContext.id !== undefined && uploadContext.id !== null && uploadContext.id !== '') {
              fd.append('id', String(uploadContext.id));
            }
            // Th√™m flag system=1 n·∫øu l√† lu·ªìng system task
            if (uploadContext.isSystemTask === true) {
              fd.append('system', '1');
            }
          }
          // Khi system=1: kh√¥ng c·∫ßn c√°c tr∆∞·ªùng conclusion, classification, durability
          if (!isSystemTask) {
            // Durability test fields
            let durPicked = '';
            try{ durPicked = (function(){ const els = document.querySelectorAll('input[name="durability-choice"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })(); }catch(_){ }
            const durDateVal = (document.getElementById('durability-date')?.value || '');
            if (durPicked){ fd.append('test_ben', durPicked === 'co' ? 'C√≥ test b·ªÅn' : 'Kh√¥ng test b·ªÅn'); }
            if (durPicked === 'co' && durDateVal){ fd.append('ngay_du_kien_tra_test_ben', durDateVal); }
            // Append Gate 1 conclusion if selected
            try{
              const picked = (function(){ const els = document.querySelectorAll('input[name="upload-conclusion"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
              if (picked) fd.append('ket_luan', picked);
            }catch(_){ }
            // Append Gate 1 classification if selected
            try{
              const classifPicked = (function(){ const els = document.querySelectorAll('input[name="upload-classification"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
              if (classifPicked) fd.append('phan_loai', classifPicked);
            }catch(_){ }
          }
          // Append meta JSON body for server
          try{
            const activeGate = (function(){ 
              const g2 = document.getElementById('upload-gate2');
              const g3 = document.getElementById('upload-gate3');
              if (g3 && g3.style.display !== 'none') return 'Gate 3';
              if (g2 && g2.style.display !== 'none') return 'Gate 2';
              return 'Gate 1';
            })();
            const uploadType = isSystemTask ? 'xlsx_only' : (fPdf ? 'pdf_xlsx' : 'xlsx_only');
            // Khi system=1: kh√¥ng g·ª≠i c√°c tr∆∞·ªùng conclusion, classification, durability
            const meta = {
              action: 'form1_upload',
              gate: activeGate,
              person_name: uploadContext?.name || '',
              taskId: (uploadContext?.taskId || uploadContext?.code || ''),
              code: uploadContext?.code || '',
              taskName: uploadContext?.taskName || '',
              ket_luan: isSystemTask ? '' : (function(){ const els = document.querySelectorAll('input[name="upload-conclusion"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })(),
              phan_loai: isSystemTask ? '' : (function(){ const els = document.querySelectorAll('input[name="upload-classification"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })(),
              test_ben: isSystemTask ? '' : (function(){ try{ const durPicked = (function(){ const els = document.querySelectorAll('input[name="durability-choice"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })(); return durPicked==='co' ? 'C√≥ test b·ªÅn' : (durPicked==='khong' ? 'Kh√¥ng test b·ªÅn' : ''); }catch(_){ return ''; } })(),
              ngay_du_kien_tra_test_ben: isSystemTask ? '' : (document.getElementById('durability-date')?.value || ''),
              is_bps: isSystemTask ? '0' : (bpsChecked ? '1' : '0'),
              system: uploadContext?.isSystemTask === true ? '1' : '0',
              upload_type: uploadType,
              timestamp_iso: new Date().toISOString()
            };
            fd.append('meta_json', JSON.stringify(meta));
            // Th√™m body cho server
            try{ fd.append('body', JSON.stringify(meta)); }catch(_){ }
            // T√°ch ri√™ng id ra body ri√™ng
            if (uploadContext?.id !== undefined && uploadContext?.id !== null && uploadContext?.id !== '') {
              fd.append('id_body', String(uploadContext.id));
            }
            fd.append('action', 'form1_upload');
            fd.append('gate', activeGate);
          }catch(_){ }
          // Khi system=1: kh√¥ng g·ª≠i is_bps ho·∫∑c g·ª≠i is_bps = '0'
          if (!isSystemTask && bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
          try{
            // Khi system=1: g·ª≠i ƒë·∫øn webhook ri√™ng
            const uploadUrl = isSystemTask ? FORM1_SYSTEM_UPLOAD_URL : FORM1_UPLOAD_URL;
            try { showToast(`S·∫Ω g·ª≠i ${isSystemTask ? '1 t·ªáp' : (fXlsx? '2 t·ªáp' : '1 t·ªáp')}: ${isSystemTask ? (fXlsx?.name||'') : (fPdf?.name||'')}${!isSystemTask && fXlsx? (', '+(fXlsx.name||'')) : ''}`,'info'); } catch(_){}
            await fetch(uploadUrl,{method:'POST',body:fd, mode: 'no-cors'});
            showToast('ƒê√£ g·ª≠i b√°o c√°o.','success');
            closeUploadModal();
            // T·ª± ƒë·ªông refresh b·∫£ng Form 1 sau khi g·ª≠i th√†nh c√¥ng
            try { if (typeof renderForm1 === 'function') await renderForm1(); } catch(_){}
          } catch(e){
            console.error(e);
            showToast('G·ª≠i th·∫•t b·∫°i.','error');
            isModalSubmitting = false;
            if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
          }
          return;
        }
        // Form 2 (gi·ªØ nguy√™n logic upload 1 file)
        if(!fileInput.files || fileInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn t·ªáp b√°o c√°o.','error'); return; }
        isModalSubmitting = true;
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
        fd.append('file', fileInput.files[0]);
        fd.append('file_name', fileInput.files[0].name || '');
        fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        fd.append('timestamp_yyyy_mm_dd', formatYyyyMmDdHHmm(new Date()));
        if(uploadContext){
          fd.append('nguoi_nop', uploadContext.name||'');
          const taskIdVal = uploadContext.taskId || uploadContext.code || '';
          fd.append('ma_tac_vu', taskIdVal);
          fd.append('ten_tac_vu', uploadContext.taskName||'');
          fd.append('form', uploadContext.form||'');
          fd.append('id', String(uploadContext.id || ''));
          // Th√™m Assignee t·ª´ rowData ƒë·ªÉ d√πng cho l·ªçc theo t√™n
          if(uploadContext.rowData && typeof uploadContext.rowData === 'object'){
            const assigneeKey = Object.keys(uploadContext.rowData).find(k => k.toLowerCase() === 'assignee');
            if(assigneeKey && uploadContext.rowData[assigneeKey]){
              fd.append('Assignee', String(uploadContext.rowData[assigneeKey]));
            }
          }
          
          // G·ª≠i t·∫•t c·∫£ c√°c tr∆∞·ªùng t·ª´ rowData (ch·ª©a to√†n b·ªô d·ªØ li·ªáu t·ª´ JSON g·ªëc)
          if(uploadContext.rowData && typeof uploadContext.rowData === 'object'){
            try{
              Object.keys(uploadContext.rowData).forEach(key => {
                const value = uploadContext.rowData[key];
                if(value !== null && value !== undefined){
                  // Chuy·ªÉn ƒë·ªïi object/array th√†nh JSON string, c√°c gi√° tr·ªã kh√°c th√†nh string
                  const strValue = (typeof value === 'object' || Array.isArray(value)) ? JSON.stringify(value) : String(value);
                  // G·ª≠i t·∫•t c·∫£ c√°c tr∆∞·ªùng v·ªõi prefix rowData_ ƒë·ªÉ ph√¢n bi·ªát v·ªõi c√°c tr∆∞·ªùng ƒë√£ g·ª≠i ri√™ng
                  fd.append(`rowData_${key}`, strValue);
                }
              });
            }catch(_){}
          }
        }
        if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
        // Th√™m body t·ªïng h·ª£p cho Form 2 - ch·ª©a to√†n b·ªô d·ªØ li·ªáu t·ª´ rowData
        try{
          // L·∫•y Assignee t·ª´ rowData (case-insensitive)
          let assigneeValue = '';
          if(uploadContext?.rowData && typeof uploadContext.rowData === 'object'){
            const assigneeKey = Object.keys(uploadContext.rowData).find(k => k.toLowerCase() === 'assignee');
            if(assigneeKey) assigneeValue = String(uploadContext.rowData[assigneeKey] || '');
          }
          const meta2 = {
            action: 'form2_upload',
            person_name: uploadContext?.name || '',
            taskId: (uploadContext?.taskId || uploadContext?.code || ''),
            code: uploadContext?.code || '',
            taskName: uploadContext?.taskName || '',
            id: uploadContext?.id || '',
            Assignee: assigneeValue,
            is_bps: bpsChecked ? '1' : '0',
            timestamp: formatDdMmYyyyHHmm(new Date()),
            timestamp_yyyy_mm_dd: formatYyyyMmDdHHmm(new Date()),
            timestamp_iso: new Date().toISOString(),
            // Th√™m to√†n b·ªô d·ªØ li·ªáu t·ª´ rowData
            ...(uploadContext?.rowData || {})
          };
          fd.append('body', JSON.stringify(meta2));
        }catch(_){ }
        // (Gi·ªØ nguy√™n Form 2 - kh√¥ng th√™m meta JSON, theo y√™u c·∫ßu ch·ªâ ch·ªânh Form 1)
        try{
          // G·ª≠i request v√† ƒë·ª£i response v·ªÅ
          const response = await fetch(FORM2_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
          // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o webhook ƒë√£ x·ª≠ l√Ω xong
          await new Promise(resolve => setTimeout(resolve, 500));
          showToast('ƒê√£ g·ª≠i b√°o c√°o.','success');
          closeUploadModal();
          // T·ª± ƒë·ªông refresh b·∫£ng Form 1 sau khi webhook response v·ªÅ th√†nh c√¥ng
          try { if (typeof renderForm1 === 'function') await renderForm1(); } catch(_){}
        } catch(e){
          console.error(e);
          showToast('G·ª≠i th·∫•t b·∫°i.','error');
          isModalSubmitting = false;
          if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
        }
      };

      

      // Helpers for tables - C·∫≠p nh·∫≠t cho Form 7 m·ªü r·ªông
      function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-4 align-top text-gray-800 border border-gray-500'; td.textContent=text; tr.appendChild(td); }
      
      // H√†m ri√™ng cho Form 8 ƒë·ªÉ x·ª≠ l√Ω ƒë∆∞·ªùng vi·ªÅn
      function addTdF8(tr, text, isLastColumn = false){ 
        const td=document.createElement('td'); 
        td.className='px-3 py-4 align-top text-gray-800 border-r border-gray-200'; 
        td.textContent=text; 
        tr.appendChild(td); 
      }
      // Enable drag-drop reordering on table body rows
      function enableTableDrag(tbodyId){
        try{
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          let dragging = null;
          const onDragStart = (e)=>{ dragging = e.currentTarget; dragging.classList.add('opacity-50'); try{ e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain',''); }catch(_){ } };
          const onDragEnd = ()=>{ try{ if (dragging) dragging.classList.remove('opacity-50'); }catch(_){ } dragging = null; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); }catch(_){ } };
          const onDragOver = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || row === dragging) return; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); row.classList.add('drag-over'); }catch(_){ } };
          const onDrop = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || !dragging || row===dragging) { onDragEnd(); return; } try{ tbody.insertBefore(dragging, row.nextSibling); }catch(_){ } onDragEnd(); };
          tbody.querySelectorAll('tr').forEach(tr=>{ try{ tr.setAttribute('draggable','true'); tr.classList.add('cursor-move','select-none'); tr.removeEventListener('dragstart', onDragStart); tr.addEventListener('dragstart', onDragStart); tr.removeEventListener('dragend', onDragEnd); tr.addEventListener('dragend', onDragEnd); }catch(_){ } });
          try{ tbody.removeEventListener('dragover', onDragOver); tbody.addEventListener('dragover', onDragOver); }catch(_){ }
          try{ tbody.removeEventListener('drop', onDrop); tbody.addEventListener('drop', onDrop); }catch(_){ }
        }catch(_){ }
      }
      // Flexible date parser supporting multiple formats
      // Form 1: fetch via webhook with query for headers/fields
      let F1_ALL_ROWS = [];
      let F1_PAGE = 1;
      let F1_SIZE = 20;
      // Cache b·∫£n r·ªóng ƒë√£ chu·∫©n ho√° cho Form 1 ƒë·ªÉ l·ªçc theo th√°ng v·ªõi Done/Cancel
      let F1_LAST_ITEMS = [];
      
      // H√†m x·ª≠ l√Ω t·∫£i form v√† g·ª≠i webhook khi system=1
      async function handleForm1DownloadForm(downloadUrl, taskData) {
        try {
          // Format th·ªùi gian: YYYY-MM-DD HH:mm
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const timestamp = `${year}-${month}-${day} ${hours}:${minutes}`;
          
          // T·∫£i file v·ªÅ
          if (downloadUrl && downloadUrl.trim()) {
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.target = '_blank';
            link.rel = 'noopener';
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
          
          // G·ª≠i d·ªØ li·ªáu l√™n webhook - t√°ch th√†nh c√°c tr∆∞·ªùng ri√™ng l·∫ª
          const formData = new FormData();
          formData.append('timestamp', timestamp);
          formData.append('taskId', taskData.taskId || '');
          formData.append('code', taskData.code || '');
          formData.append('taskName', taskData.taskName || '');
          formData.append('name', taskData.name || '');
          formData.append('requestDate', taskData.requestDate || '');
          formData.append('wishDue', taskData.wishDue || '');
          formData.append('status', taskData.status || '');
          formData.append('itemId', taskData.itemId || '');
          formData.append('requester', taskData.requester || '');
          formData.append('receiverSample', taskData.receiverSample || '');
          formData.append('manHour', taskData.manHour || '');
          formData.append('purpose', taskData.purpose || '');
          formData.append('note', taskData.note || '');
          formData.append('specialTest', taskData.specialTest || '');
          formData.append('reportForm', taskData.reportForm || '');
          formData.append('submitTime', taskData.submitTime || '');
          formData.append('reportDueDate', taskData.reportDueDate || '');
          formData.append('attachmentFileName', taskData.attachmentFileName || '');
          formData.append('attachmentUrl', taskData.attachmentUrl || '');
          formData.append('downloadFormUrl', downloadUrl || '');
          
          // G·ª≠i d∆∞·ªõi d·∫°ng FormData v·ªõi c√°c tr∆∞·ªùng ri√™ng l·∫ª
          await fetch(FORM1_DOWNLOAD_FORM_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
          });
          
          showToast('ƒê√£ t·∫£i form v√† ghi nh·∫≠n th·ªùi gian b·∫Øt ƒë·∫ßu t√°c v·ª•', 'success');
        } catch (error) {
          console.error('L·ªói khi t·∫£i form:', error);
          showToast('ƒê√£ t·∫£i form nh∆∞ng c√≥ l·ªói khi g·ª≠i th√¥ng tin l√™n server', 'warning');
        }
      }
      
      function applyForm1Paging(){
        const body = document.getElementById('f1-body');
        const pager = document.getElementById('f1-pager');
        const total = F1_ALL_ROWS.length;
        if(total === 0){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="20">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
          pager.style.display = 'none';
          return;
        }
        pager.style.display = '';
        const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
        if(F1_PAGE > maxPage) F1_PAGE = maxPage;
        const start = (F1_PAGE - 1) * F1_SIZE;
        const end = Math.min(total, start + F1_SIZE);
        const slice = F1_ALL_ROWS.slice(start, end);
        const pageInfo = document.getElementById('f1-page-info');
        if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} d√≤ng)`;
        const prev = document.getElementById('f1-prev');
        const next = document.getElementById('f1-next');
        if(prev) prev.disabled = (F1_PAGE <= 1);
        if(next) next.disabled = (F1_PAGE >= maxPage);
        // render rows
        body.innerHTML = '';
        slice.forEach(tr => body.appendChild(tr));
      }

      function formatYyyyMmSafe(v){ try{ const d = toDateSafe(v); if(!d) return ''; const mm=String(d.getMonth()+1).padStart(2,'0'); return `${d.getFullYear()}-${mm}`; }catch(_){ return ''; } }

      function vnLower(s){
        try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); }
      }

      function applyForm1MonthFilter(){
        try{
          const monthEl = document.getElementById('f1-month');
          const monthVal = monthEl ? (monthEl.value||'').trim() : '';
          const items = Array.isArray(F1_LAST_ITEMS) ? F1_LAST_ITEMS.slice() : [];
          // Done & Cancel: l·ªçc theo th√°ng (monthVal)
          // "Chuy·ªÉn SPM c·∫≠p nh·∫≠t" ƒë∆∞·ª£c x·ª≠ l√Ω nh∆∞ Done n√™n s·∫Ω l·ªçc theo th√°ng
          let partDoneCancel = items.filter(it=> it.isDone || it.isCancel);
          if (monthVal) partDoneCancel = partDoneCancel.filter(it=> it.monthTagReq === monthVal);
          // Doing, Chuy·ªÉn nh√≥m SPM, Ch·ªù ph√™ duy·ªát, Ch·ªù ph√¢n c√¥ng, Test b·ªÅn: lu√¥n hi·ªÉn th·ªã kh√¥ng ph·ª• thu·ªôc th·ªùi gian
          // L∆∞u √Ω: "Chuy·ªÉn SPM c·∫≠p nh·∫≠t" ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang logic Done n√™n kh√¥ng c√≤n ·ªü ƒë√¢y
          let partTimeRestricted = items.filter(it=> {
            const s = it.statusNorm || '';
            return s.includes('doing') || s.includes('chuyen nhom spm') || s.includes('cho phe duyet') || s.includes('truong nhom review') || s.includes('cho phan cong') || s.includes('test ben');
          });
          // ∆Øu ti√™n nh√≥m th·ªùi gian th·ª±c (Doing/Ch·ªù ph√¢n c√¥ng/Test b·ªÅn) l√™n tr∆∞·ªõc
          const filtered = partTimeRestricted.concat(partDoneCancel);
          // Render l·∫°i tbody v√† ph√¢n trang
          const body = document.getElementById('f1-body');
          const pager = document.getElementById('f1-pager');
          if (!filtered.length){
            if (body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="20">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
            if (pager) pager.style.display = 'none';
            F1_ALL_ROWS = [];
            return;
          }
          F1_ALL_ROWS = filtered.map(it=> it.rowEl).filter(Boolean);
          F1_PAGE = 1;
          applyForm1Paging();
        }catch(_){ }
      }

      // Render Form 1 t·ª´ m·∫£ng rows (d√πng cho cache)
      function renderForm1FromRows(rows){
        const body = document.getElementById('f1-body');
        if(!rows || !rows.length){ body.innerHTML = "<tr><td colspan='20' class='px-3 py-3 text-center text-gray-500 border border-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
        const getV = (obj, keys)=>{
          if (!obj) return '';
          // T·∫°o map v·ªõi c·∫£ key g·ªëc v√† lowercase
          const keyMap = {};
          for (const k of Object.keys(obj)) {
            keyMap[k] = obj[k];
            keyMap[k.toLowerCase()] = obj[k];
          }
          // T√¨m ki·∫øm theo th·ª© t·ª± ∆∞u ti√™n
          for(const k of keys){
            // Th·ª≠ key g·ªëc tr∆∞·ªõc (case-sensitive)
            if (keyMap[k] !== undefined) return keyMap[k];
            // Th·ª≠ lowercase
            const v = keyMap[k.toLowerCase()];
            if(v !== undefined && v !== null && v !== '') return v;
          }
          return '';
        };
        function getStatusRank(obj){
          const s = vnLower(getV(obj,['T√¨nh tr·∫°ng','status','trangthai','trang_thai','tr·∫°ng th√°i']) || '');
          if (s.includes('doing') || s.includes('dang') || s.includes('chuyen nhom spm')) return 0; // ∆∞u ti√™n cao nh·∫•t
          if (s.includes('cho phan cong') || s.includes('test ben')) return 1; // nh√≥m th·ª© hai
          // "Chuy·ªÉn SPM c·∫≠p nh·∫≠t" ƒë∆∞·ª£c x·ª≠ l√Ω nh∆∞ Done n√™n s·∫Ω ·ªü nh√≥m c√≤n l·∫°i (rank 2)
          return 2; // c√≤n l·∫°i
        }
        function getTimeValue(obj){
          const v = getV(obj,[
            'Ng√†y y√™u c·∫ßu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu'
          ]) || getV(obj,[
            'H·∫°n mong mu·ªën','wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën'
          ]);
          const d = parseDateFlexible(v);
          return d ? d.getTime() : 0;
        }
        const rowsSorted = rows.slice().sort((a,b)=>{
          const ra = getStatusRank(a), rb = getStatusRank(b);
          if (ra !== rb) return ra - rb;
          const ta = getTimeValue(a), tb = getTimeValue(b);
          return tb - ta; // m·ªõi nh·∫•t tr∆∞·ªõc
        });
        F1_ALL_ROWS = [];
        F1_LAST_ITEMS = [];
        rowsSorted.forEach(item=>{
          const tr=document.createElement('tr');
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2 border border-gray-500';
          const code = getV(item,['M√£','code','ma','taskcode','m√£']);
          const taskId = getV(item,['M√£ t√°c v·ª•','taskid','task_id','ma_tac_vu','m√£ t√°c v·ª•','taskcode2','requestid','id']);
          const tname = getV(item,['T√™n t√°c v·ª•','taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          const itemId = getV(item,['Id','id','ID','_id']);
          const statusText = getV(item,['T√¨nh tr·∫°ng','status','trangthai','trang_thai','tr·∫°ng th√°i','T√¨nh Tr·∫°ng']);
          const statusLower = (statusText||'').toLowerCase();
          const isDone = statusLower.includes('ho√†n') || statusLower.includes('done') || statusLower.includes('chuy·ªÉn spm c·∫≠p nh·∫≠t') || statusLower.includes('chuyen spm cap nhat');
          const isCancelled = statusLower.includes('cancel') || statusLower.includes('h·ªßy') || statusLower.includes('hu·ª∑');
          const isPendingApproval = statusLower.includes('ch·ªù ph√™ duy·ªát') || statusLower.includes('cho phe duyet') || statusLower.includes('tr∆∞·ªüng nh√≥m review') || statusLower.includes('truong nhom review');
          const isEmptyStatus = statusLower.trim()==='';
          // Cho ph√©p n√∫t ho·∫°t ƒë·ªông khi isDone ƒë·ªÉ s·ª≠ d·ª•ng Gate 3, nh∆∞ng v·∫´n kh√≥a c√°c tr∆∞·ªùng h·ª£p kh√°c
          const isLocked = isCancelled || isPendingApproval || isEmptyStatus;
          const isDoing = statusLower.includes('doing') || statusLower.includes('ƒëang') || statusLower.includes('chuy·ªÉn nh√≥m spm') || statusLower.includes('chuyen nhom spm');
          const wishDue = getV(item,['H·∫°n mong mu·ªën','wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
          const dueDate = parseDateFlexible(wishDue || '');
          if (isDoing && dueDate){
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
            const isSameDay = dueDayStart.getTime() === todayStart.getTime();
            const isPast = dueDayStart.getTime() < todayStart.getTime();
            try { if (isSameDay) { tr.style.backgroundColor = '#fef3c7'; } else if (isPast) { tr.style.backgroundColor = '#fee2e2'; } } catch(_){}
          }
          // Ki·ªÉm tra gi√° tr·ªã "Form b√°o c√°o ƒë√°nh gi√°"
          const reportFormValue = getV(item,['Form b√°o c√°o ƒë√°nh gi√°','reportform','form_bao_cao','form_bao_cao_danh_gia']);
          const isFormSent = String(reportFormValue || '').trim().toLowerCase() === 'sent';
          // Ki·ªÉm tra gi√° tr·ªã "system" ƒë·ªÉ x√°c ƒë·ªãnh lu·ªìng ri√™ng cho system=1
          const systemValue = getV(item,['system','System','SYSTEM']);
          const isSystemTask = String(systemValue) === '1' || Number(systemValue) === 1;
          // Logic: 
          // - N·∫øu t√°c v·ª• ƒë√£ Done: lu√¥n cho ph√©p c·∫≠p nh·∫≠t b√°o c√°o (b·∫•t k·ªÉ form ƒë√£ sent hay ch∆∞a)
          // - N·∫øu system=1: cho ph√©p "Tr·∫£ b√°o c√°o" theo lu·ªìng ri√™ng (kh√¥ng ph·ª• thu·ªôc v√†o isFormSent)
          // - N·∫øu Form b√°o c√°o ƒë√°nh gi√° = "Sent": b·∫≠t n√∫t "Tr·∫£ b√°o c√°o", kh√≥a n√∫t "Tr·∫£ form"
          // - Ng∆∞·ª£c l·∫°i: b·∫≠t n√∫t "Tr·∫£ form", kh√≥a n√∫t "Tr·∫£ b√°o c√°o"
          const labelBtn = document.createElement('button');
          if (isLocked) {
            labelBtn.disabled = true;
            labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
            labelBtn.textContent = isCancelled ? 'ƒê√£ h·ªßy' : (isPendingApproval ? 'Ch·ªù ph√™ duy·ªát' : 'Kh√¥ng th·ªÉ g·ª≠i');
            labelBtn.title = labelBtn.textContent;
          } else if (isDone) {
            // T√°c v·ª• ƒë√£ Done: lu√¥n cho ph√©p c·∫≠p nh·∫≠t b√°o c√°o
            // Ph√¢n bi·ªát m√†u: System task + Done (m√†u t√≠m) vs kh√¥ng ph·∫£i System task + Done (m√†u h·ªìng)
            if (isSystemTask) {
              labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-purple-600 hover:bg-purple-700 cursor-pointer';
            } else {
              labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-pink-600 hover:bg-pink-700 cursor-pointer';
            }
            labelBtn.textContent = 'C·∫≠p nh·∫≠t b√°o c√°o';
            labelBtn.disabled = false;
            labelBtn.onclick = (e)=>{ e.preventDefault(); if (labelBtn.disabled) return; labelBtn.disabled=true; labelBtn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = labelBtn; const name=(document.getElementById('f1-name')?.value||'').trim(); openUploadModal({ form: 'Form 1', name, code, taskId, taskName: tname, isDone, id: itemId, isSystemTask }); };
          } else if (isSystemTask) {
            // system=1: cho ph√©p "Tr·∫£ b√°o c√°o" theo lu·ªìng ri√™ng
            labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
            labelBtn.textContent = 'Tr·∫£ b√°o c√°o';
            labelBtn.disabled = false;
            labelBtn.title = 'G·ª≠i b√°o c√°o theo lu·ªìng system=1';
            labelBtn.onclick = (e)=>{ e.preventDefault(); if (labelBtn.disabled) return; labelBtn.disabled=true; labelBtn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = labelBtn; const name=(document.getElementById('f1-name')?.value||'').trim(); openUploadModal({ form: 'Form 1', name, code, taskId, taskName: tname, isDone, id: itemId, isSystemTask: true }); };
          } else if (isFormSent) {
            // Form ƒë√£ Sent: b·∫≠t n√∫t "Tr·∫£ b√°o c√°o"
            labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
            labelBtn.textContent = 'Tr·∫£ b√°o c√°o';
            labelBtn.disabled = false;
            labelBtn.onclick = (e)=>{ e.preventDefault(); if (labelBtn.disabled) return; labelBtn.disabled=true; labelBtn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = labelBtn; const name=(document.getElementById('f1-name')?.value||'').trim(); openUploadModal({ form: 'Form 1', name, code, taskId, taskName: tname, isDone, id: itemId, isSystemTask }); };
          } else {
            // Form ch∆∞a Sent v√† ch∆∞a Done: kh√≥a n√∫t "Tr·∫£ b√°o c√°o"
            labelBtn.disabled = true;
            labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
            labelBtn.textContent = 'Ch∆∞a g·ª≠i form';
            labelBtn.title = 'Vui l√≤ng g·ª≠i form b√°o c√°o ƒë√°nh gi√° tr∆∞·ªõc';
          }
          tdBtn.appendChild(labelBtn);
          tr.appendChild(tdBtn);
          // Th√™m c·ªôt "N√∫t Tr·∫£ form" gi·ªëng Form 2 (v·ªã tr√≠ th·ª© 2)
          const tdReturnForm = document.createElement('td');
          tdReturnForm.className = 'px-3 py-2 border border-gray-500';
          const returnFormBtn = document.createElement('button');
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const requestDateStr = getV(item,['Ng√†y y√™u c·∫ßu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
          // L∆∞u to√†n b·ªô d·ªØ li·ªáu t·ª´ item g·ªëc v√†o rowData ƒë·ªÉ g·ª≠i k√®m khi upload (gi·ªëng Form 2)
          const rowData = { ...item, taskId: taskIdBest, requestDate: requestDateStr, wishDue, code, taskName: tname };
          
          // Ki·ªÉm tra "N√∫t t·∫£i form" (isSystemTask ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü tr√™n)
          const downloadFormUrl = getV(item,['N√∫t t·∫£i form','nuttaiform','nut_tai_form','download_form','downloadForm','Download Form','N√∫t T·∫£i Form']);
          
          if (isLocked) {
            // T√°c v·ª• b·ªã kh√≥a (Cancel, ch·ªù ph√™ duy·ªát, ho·∫∑c tr·∫°ng th√°i r·ªóng): kh√≥a n√∫t "Tr·∫£ form b√°o c√°o"
            returnFormBtn.disabled = true;
            returnFormBtn.className = 'px-3 py-1 rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
            returnFormBtn.textContent = isCancelled ? 'ƒê√£ h·ªßy' : (isPendingApproval ? 'Ch·ªù ph√™ duy·ªát' : 'Kh√¥ng th·ªÉ g·ª≠i');
            returnFormBtn.title = returnFormBtn.textContent;
          } else if (isDone) {
            // T√°c v·ª• ƒë√£ Done: kh√≥a n√∫t "Tr·∫£ form b√°o c√°o", ch·ªâ cho ph√©p c·∫≠p nh·∫≠t b√°o c√°o
            returnFormBtn.disabled = true;
            returnFormBtn.className = 'px-3 py-1 rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
            returnFormBtn.textContent = 'ƒê√£ ho√†n th√†nh';
            returnFormBtn.title = 'T√°c v·ª• ƒë√£ ho√†n th√†nh, ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t b√°o c√°o';
          } else if (isFormSent) {
            // Form ƒë√£ Sent: kh√≥a n√∫t "Tr·∫£ form b√°o c√°o"
            returnFormBtn.disabled = true;
            returnFormBtn.className = 'px-3 py-1 rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
            returnFormBtn.textContent = 'ƒê√£ g·ª≠i form';
            returnFormBtn.title = 'Form ƒë√£ ƒë∆∞·ª£c g·ª≠i';
          } else if (isSystemTask) {
            // system=1: kh√≥a n√∫t "Tr·∫£ form b√°o c√°o", s·ª≠ d·ª•ng n√∫t "T·∫£i form" thay th·∫ø
            returnFormBtn.disabled = true;
            returnFormBtn.className = 'px-3 py-1 rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
            returnFormBtn.textContent = 'Kh√¥ng d√πng';
            returnFormBtn.title = 'T√°c v·ª• h·ªá th·ªëng, vui l√≤ng s·ª≠ d·ª•ng n√∫t T·∫£i form';
          } else {
            // Form ch∆∞a Sent v√† ch∆∞a Done: b·∫≠t n√∫t "Tr·∫£ form b√°o c√°o"
            returnFormBtn.className = 'px-3 py-1 rounded-lg text-white bg-green-500 hover:bg-green-600';
            returnFormBtn.textContent = 'Tr·∫£ form b√°o c√°o';
            returnFormBtn.disabled = false;
            returnFormBtn.onclick = (e) => {
              e.preventDefault();
              if (returnFormBtn.disabled) return;
              returnFormBtn.disabled = true;
              returnFormBtn.classList.add('opacity-50', 'pointer-events-none');
              lastOpenTrigger = returnFormBtn;
              const name = (document.getElementById('f1-name')?.value || '').trim();
              openUploadModal({ form: 'Form 2', name, code, taskId: taskIdBest, taskName: tname, rowData, id: itemId });
            };
          }
          tdReturnForm.appendChild(returnFormBtn);
          tr.appendChild(tdReturnForm);
          
          // Th√™m c·ªôt "T·∫£i form" (v·ªã tr√≠ th·ª© 3) - ch·ªâ hi·ªÉn th·ªã khi system=1
          const tdDownloadForm = document.createElement('td');
          tdDownloadForm.className = 'px-3 py-2 border border-gray-500';
          if (isSystemTask && downloadFormUrl && downloadFormUrl.trim()) {
            const downloadFormBtn = document.createElement('button');
            downloadFormBtn.className = 'px-3 py-1 rounded-lg text-white bg-purple-500 hover:bg-purple-600';
            downloadFormBtn.textContent = 'T·∫£i form';
            downloadFormBtn.disabled = false;
            downloadFormBtn.onclick = async (e) => {
              e.preventDefault();
              if (downloadFormBtn.disabled) return;
              
              // Hi·ªÉn th·ªã c·∫£nh b√°o
              const confirmed = confirm('Khi t·∫£i v·ªÅ s·∫Ω b·∫Øt ƒë·∫ßu t√≠nh th·ªùi gian th·ª±c hi·ªán t√°c v·ª•. B·∫°n c√≥ mu·ªën t·∫£i?');
              if (!confirmed) return;
              
              downloadFormBtn.disabled = true;
              downloadFormBtn.classList.add('opacity-50', 'pointer-events-none');
              downloadFormBtn.textContent = 'ƒêang t·∫£i...';
              
              // Chu·∫©n b·ªã th√¥ng tin t√°c v·ª• ƒë·ªÉ g·ª≠i webhook - l·∫•y c√°c tr∆∞·ªùng ri√™ng bi·ªát
              const submitTimeRaw = getV(item,['Tgian n·ªôp form','submittime','submit_time','submitTime','tgian nop form','thoi_gian_nop_form','th·ªùi gian n·ªôp form']);
              const reportDueDateRaw = getV(item,['Ng√†y c·∫ßn tr·∫£ BC','reportduedate','report_due_date','reportDueDate','ngay can tra bc','ngay_can_tra_bc','ng√†y c·∫ßn tr·∫£ bc']);
              const taskData = {
                taskId: taskIdBest,
                code: code,
                taskName: tname,
                name: (document.getElementById('f1-name')?.value || '').trim(),
                requestDate: requestDateStr,
                wishDue: wishDue,
                status: statusText,
                itemId: itemId,
                requester: getV(item,['Ng∆∞·ªùi y√™u c·∫ßu','requester','nguoiyeucau','nguoi_yeu_cau','assigner','ng∆∞·ªùi y√™u c·∫ßu']),
                receiverSample: getV(item,['Ng∆∞·ªùi nh·∫≠n m·∫´u','receiver','receivername','nguoinhanmau','nguoi_nhan_mau','ng∆∞·ªùi nh·∫≠n m·∫´u','recipient','assignee','ng∆∞·ªùi nh·∫≠n']),
                manHour: getV(item,['C√¥ng chu·∫©n','manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n']),
                purpose: getV(item,['M·ª•c ƒë√≠ch ƒë√°nh gi√°','purpose','mucdich','muc_dich','m·ª•c ƒë√≠ch ƒë√°nh gi√°','muc dich danh gia','mucdichdanhgia']),
                note: getV(item,['Note','note','ghi_chu','ghichu']),
                specialTest: getV(item,['Y√™u c·∫ßu test ƒë·∫∑c bi·ªát','specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']),
                reportForm: getV(item,['Form b√°o c√°o ƒë√°nh gi√°','reportform','form_bao_cao','form_bao_cao_danh_gia']),
                submitTime: submitTimeRaw,
                reportDueDate: reportDueDateRaw,
                attachmentFileName: getV(item,['T√™n file ƒë√≠nh k√®m','attachmentfilename','file_name','filename','tenfile','ten_file','t√™n file','t√™n file ƒë√≠nh k√®m','attachment','file']),
                attachmentUrl: getV(item,['T·∫£i ƒë√≠nh k√®m','T√†i ƒë√≠nh k√®m','attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url'])
              };
              
              try {
                await handleForm1DownloadForm(downloadFormUrl, taskData);
              } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω t·∫£i form:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi t·∫£i form', 'error');
              } finally {
                downloadFormBtn.disabled = false;
                downloadFormBtn.classList.remove('opacity-50', 'pointer-events-none');
                downloadFormBtn.textContent = 'T·∫£i form';
              }
            };
            tdDownloadForm.appendChild(downloadFormBtn);
          } else {
            // Kh√¥ng ph·∫£i system task ho·∫∑c kh√¥ng c√≥ URL: ƒë·ªÉ tr·ªëng ho·∫∑c hi·ªÉn th·ªã "-"
            tdDownloadForm.textContent = '-';
            tdDownloadForm.className += ' text-gray-400';
          }
          tr.appendChild(tdDownloadForm);
          const tdStatus=document.createElement('td'); tdStatus.className='px-3 py-2 border border-gray-500';
          const s=(statusText||'').toLowerCase();
          const badge=document.createElement('span');
          let badgeClass = 'bg-blue-100 text-blue-800';
          if (s.includes('ch·ªù ph√™ duy·ªát') || s.includes('cho phe duyet') || s.includes('tr∆∞·ªüng nh√≥m review') || s.includes('truong nhom review')) badgeClass = 'bg-orange-100 text-orange-800';
          else if (s.includes('chuy·ªÉn spm c·∫≠p nh·∫≠t') || s.includes('chuyen spm cap nhat')) badgeClass = 'bg-cyan-100 text-cyan-800';
          else if (s.includes('ho√†n') || s.includes('done')) badgeClass = 'bg-green-100 text-green-800';
          else if (s.includes('cancel') || s.includes('h·ªßy') || s.includes('hu·ª∑') || s.includes('ch·ªù') || s.includes('pending')) badgeClass = 'bg-yellow-100 text-yellow-800';
          badge.className='px-2 py-1 rounded text-xs ' + badgeClass; badge.textContent=statusText||''; tdStatus.appendChild(badge); tr.appendChild(tdStatus);
          addTd(tr, taskId);
          addTd(tr, code);
          // T√™n t√°c v·ª• - c√≥ th·ªÉ click ƒë·ªÉ m·ªü modal th·ªëng k√™ chi ti·∫øt
          const tdTaskName = document.createElement('td');
          tdTaskName.className = 'px-3 py-2 border border-gray-500';
          if (taskId && taskId.trim()) {
            const taskNameLink = document.createElement('a');
            taskNameLink.href = '#';
            taskNameLink.className = 'text-blue-600 hover:text-blue-800 hover:underline cursor-pointer';
            taskNameLink.textContent = tname || '';
            taskNameLink.onclick = (e) => {
              e.preventDefault();
              if (taskId && taskId.trim()) {
                openStatsDetail(taskId);
              }
            };
            tdTaskName.appendChild(taskNameLink);
          } else {
            tdTaskName.textContent = tname || '';
          }
          tr.appendChild(tdTaskName);
          // New columns right after Task Name: Tgian n·ªôp form & Ng√†y c·∫ßn tr·∫£ BC
          (function(){
            const submitTimeRaw = getV(item,['Tgian n·ªôp form','submittime','submit_time','submitTime','tgian nop form','thoi_gian_nop_form','th·ªùi gian n·ªôp form']);
            const manHourRaw = getV(item,[ 'C√¥ng chu·∫©n','manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n' ]);
            const submitTimeDisp = (function(v){ const d=toDateSafe(v); if(!d) return String(v||''); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`; })(submitTimeRaw);
            addTd(tr, submitTimeDisp);
            let dueDateRaw = getV(item,['Ng√†y c·∫ßn tr·∫£ BC','reportduedate','report_due_date','reportDueDate','ngay can tra bc','ngay_can_tra_bc','ng√†y c·∫ßn tr·∫£ bc']);
            if (!dueDateRaw){
              try{
                const base = toDateSafe(submitTimeRaw);
                const hrs = parseNumberFlexible(manHourRaw);
                const calc = (base && Number.isFinite(hrs)) ? addBusinessHours(base, hrs) : null;
                if (calc) dueDateRaw = calc;
              }catch(_){ }
            }
            const dueDisp = (function(v){ const d=toDateSafe(v); if(!d) return String(v||''); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`; })(dueDateRaw || '');
            addTd(tr, dueDisp);
          })();
          addTd(tr, getV(item,['Ng∆∞·ªùi y√™u c·∫ßu','requester','nguoiyeucau','nguoi_yeu_cau','assigner','ng∆∞·ªùi y√™u c·∫ßu']));
          addTd(tr, getV(item,['Ng∆∞·ªùi nh·∫≠n m·∫´u','receiver','receivername','nguoinhanmau','nguoi_nhan_mau','ng∆∞·ªùi nh·∫≠n m·∫´u','recipient','assignee','ng∆∞·ªùi nh·∫≠n']));
          addTd(tr, getV(item,[ 'C√¥ng chu·∫©n','manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n' ]));
          addTd(tr, requestDateStr);
          addTd(tr, getV(item,['H·∫°n mong mu·ªën','wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']));
          addTd(tr, getV(item,['M·ª•c ƒë√≠ch ƒë√°nh gi√°','purpose','mucdich','muc_dich','m·ª•c ƒë√≠ch ƒë√°nh gi√°','muc dich danh gia','mucdichdanhgia']));
          addTd(tr, getV(item,['Note','note','ghi_chu','ghichu']));
          addTd(tr, getV(item,['Y√™u c·∫ßu test ƒë·∫∑c bi·ªát','specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']));
          addTd(tr, getV(item,['Form b√°o c√°o ƒë√°nh gi√°','reportform','form_bao_cao','form_bao_cao_danh_gia']));
          const attachmentName = getV(item,[ 'T√™n file ƒë√≠nh k√®m','attachmentfilename','file_name','filename','tenfile','ten_file','t√™n file','t√™n file ƒë√≠nh k√®m','attachment','file' ]);
          addTd(tr, attachmentName);
          const tdDl = document.createElement('td'); tdDl.className='px-3 py-2 border border-gray-500';
          const url = getV(item,[ 'T·∫£i ƒë√≠nh k√®m','T√†i ƒë√≠nh k√®m','attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url' ]);
          if (url) { const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105'; a.textContent = 'T·∫£i v·ªÅ'; tdDl.appendChild(a); }
          else { const btn = document.createElement('button'); btn.disabled = true; btn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60'; btn.textContent = 'Kh√¥ng c√≥ link'; tdDl.appendChild(btn); }
          tr.appendChild(tdDl);
          F1_ALL_ROWS.push(tr);
          try{ if (!window.F1_LAST_RAW) window.F1_LAST_RAW = []; window.F1_LAST_RAW.push(item); }catch(_){ }
          const statusNorm = vnLower(statusText);
          const monthTagReq = formatYyyyMmSafe(requestDateStr);
          F1_LAST_ITEMS.push({ rowEl: tr, statusNorm, monthTagReq, requestDateRaw: requestDateStr, isDone, isCancel: isCancelled });
        });
        applyForm1Paging();
        try{ applyForm1MonthFilter(); }catch(_){ }
      }

      // ===== Stats Detail Modal - S·ª≠ d·ª•ng M√£ t√°c v·ª• l√†m id
      async function openStatsDetail(taskId){
        const modalId = 'modal-stats';
        const titleEl = document.getElementById('stats-title');
        const loadingEl = document.getElementById('stats-loading');
        const contentEl = document.getElementById('stats-content');
        
        // Reset modal state
        if (loadingEl) loadingEl.style.display = 'block';
        if (contentEl) contentEl.classList.add('hidden');
        
        // Reset t·∫•t c·∫£ c√°c section v·ªÅ hi·ªÉn th·ªã (s·∫Ω ·∫©n sau n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu)
        const sections = ['stats-section-c', 'stats-section-d', 'stats-section-e', 'stats-section-f', 'stats-section-g'];
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) section.style.display = 'block';
        });
        
        if (titleEl) titleEl.textContent = taskId ? `Th·ªëng k√™ chi ti·∫øt - ${taskId}` : 'Th·ªëng k√™ chi ti·∫øt';
        
        try {
          // Fetch stats data t·ª´ webhook m·ªõi - tr·∫£ v·ªÅ t·∫•t c·∫£ records, c·∫ßn filter theo M√£ t√°c v·ª•
          async function fetchStatsJson(url) {
            const r = await fetch(url, { method: 'GET' });
            const txt = await r.text();
            let parsed = null;
            try { parsed = JSON.parse(txt); } catch {}
            return { ok: r.ok, parsed, raw: txt };
          }
          
          let resp = await fetchStatsJson(STATS_DETAIL_URL);
          if (!resp.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™');
          }
          
          // Parse response data - webhook m·ªõi tr·∫£ v·ªÅ t·∫•t c·∫£ records
          const data = resp.parsed;
          if (!data || !Array.isArray(data) || data.length === 0) {
            throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™');
          }
          
          // Helper function ƒë·ªÉ normalize chu·ªói ƒë·ªÉ so s√°nh
          const normalizeString = (str) => {
            if (!str) return '';
            return String(str).trim().replace(/\s+/g, ' ');
          };
          
          // Normalize taskId ƒë·ªÉ so s√°nh
          const normalizedTaskId = normalizeString(taskId);
          
          // T√¨m record c√≥ M√£ t√°c v·ª• kh·ªõp v·ªõi taskId (so s√°nh ch√≠nh x√°c)
          let stats = data.find(item => {
            const maTacVu = normalizeString(item['M√£ t√°c v·ª•'] || '');
            return maTacVu === normalizedTaskId;
          });
          
          // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m v·ªõi c√°c key kh√°c c√≥ th·ªÉ ch·ª©a m√£ t√°c v·ª•
          if (!stats) {
            stats = data.find(item => {
              // Th·ª≠ c√°c key kh√°c c√≥ th·ªÉ ch·ª©a m√£ t√°c v·ª•
              const maTacVu1 = normalizeString(item['M√£ t√°c v·ª•'] || '');
              const maTacVu2 = normalizeString(item['taskId'] || item['task_id'] || item['M√£'] || '');
              return maTacVu1 === normalizedTaskId || maTacVu2 === normalizedTaskId;
            });
          }
          
          if (!stats) {
            // Log ƒë·ªÉ debug
            console.warn('[Stats Detail] Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho m√£ t√°c v·ª•:', taskId);
            console.warn('[Stats Detail] C√°c m√£ t√°c v·ª• c√≥ trong d·ªØ li·ªáu:', data.slice(0, 5).map(item => item['M√£ t√°c v·ª•']));
            throw new Error(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho m√£ t√°c v·ª•: ${taskId}`);
          }
          
          // Log ƒë·ªÉ x√°c nh·∫≠n ƒë√£ t√¨m th·∫•y
          console.log('[Stats Detail] ƒê√£ t√¨m th·∫•y d·ªØ li·ªáu cho m√£ t√°c v·ª•:', taskId, '‚Üí', stats['M√£ t√°c v·ª•']);
          
          // Helper function ƒë·ªÉ parse JSON string t·ª´ c√°c tr∆∞·ªùng nh∆∞ "Th·ªëng k√™ sheet TCKT", "D·ªØ li·ªáu test b·ªÅn b√¨a"
          const parseJsonField = (value) => {
            if (!value) return null;
            if (typeof value === 'object') return value;
            if (typeof value === 'string') {
              try {
                return JSON.parse(value);
              } catch (_) {
                return value;
              }
            }
            return value;
          };
          
          // Parse c√°c tr∆∞·ªùng JSON t·ª´ response
          const thongKeTCKT = parseJsonField(stats['Th·ªëng k√™ sheet TCKT']);
          const thongKeThem = parseJsonField(stats['Th·ªëng k√™ sheet Th√™m']);
          const duLieuTestBenBia = parseJsonField(stats['D·ªØ li·ªáu test b·ªÅn b√¨a']);
          
          // a. Populate Th√¥ng tin c∆° b·∫£n
          const maEl = document.getElementById('stats-ma');
          const taskNameEl = document.getElementById('stats-task-name');
          const conclusionEl = document.getElementById('stats-conclusion');
          if (maEl) maEl.textContent = stats['M√£'] || '';
          if (taskNameEl) taskNameEl.textContent = stats['Task Name'] || '';
          // ∆Øu ti√™n "K·∫øt lu·∫≠n trang b√¨a", fallback v·ªÅ "K·∫øt lu·∫≠n"
          if (conclusionEl) conclusionEl.textContent = stats['K·∫øt lu·∫≠n trang b√¨a'] || stats['K·∫øt lu·∫≠n'] || '';
          
          // b. Populate C√¥ng chu·∫©n - Map t·ª´ DataDB.js structure
          const congUocLuongEl = document.getElementById('stats-cong-uoc-luong');
          const congChuanDayDuEl = document.getElementById('stats-cong-chuan-day-du');
          const congChuanThucTeEl = document.getElementById('stats-cong-chuan-thuc-te');
          const congChuanPtcEl = document.getElementById('stats-cong-chuan-ptc');
          const congChuanBoSungEl = document.getElementById('stats-cong-chuan-bo-sung');
          const congChuanThemEl = document.getElementById('stats-cong-chuan-them');
          const tongCongChuanThucEl = document.getElementById('stats-tong-cong-chuan-thuc');
          const soMauEl = document.getElementById('stats-so-mau');
          const soMauSheetThemEl = document.getElementById('stats-so-mau-sheet-them');
          const nhanXetPicEl = document.getElementById('stats-nhan-xet-pic');
          
          // Parse c√¥ng chu·∫©n t·ª´ "C√¥ng chu·∫©n Sheet TCKT" n·∫øu l√† JSON
          const congChuanSheetTCKT = parseJsonField(stats['C√¥ng chu·∫©n Sheet TCKT']);
          
          if (congUocLuongEl) congUocLuongEl.textContent = stats['C√¥ng ∆∞·ªõc l∆∞·ª£ng'] || (congChuanSheetTCKT && congChuanSheetTCKT['C√¥ng ∆∞·ªõc l∆∞·ª£ng']) || '0';
          if (congChuanDayDuEl) congChuanDayDuEl.textContent = stats['C√¥ng chu·∫©n ƒë·∫ßy ƒë·ªß'] || (congChuanSheetTCKT && congChuanSheetTCKT['C√¥ng chu·∫©n ƒë·∫ßy ƒë·ªß']) || '0';
          // C√¥ng chu·∫©n th·ª±c t·∫ø = S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø
          if (congChuanThucTeEl) congChuanThucTeEl.textContent = stats['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '0';
          if (congChuanPtcEl) congChuanPtcEl.textContent = stats['C√¥ng chu·∫©n ph·∫ßn PTC'] || (congChuanSheetTCKT && congChuanSheetTCKT['C√¥ng chu·∫©n ph·∫ßn PTC']) || '0';
          // X·ª≠ l√Ω c·∫£ tr∆∞·ªùng c≈© v√† m·ªõi ƒë·ªÉ t∆∞∆°ng th√≠ch ng∆∞·ª£c
          if (congChuanBoSungEl) {
            const congChuanBoSung = stats['C√¥ng chu·∫©n ph·∫ßn B·ªï sung'] || stats['C√¥ng chu·∫©n th√™m'] || (congChuanSheetTCKT && congChuanSheetTCKT['C√¥ng chu·∫©n th√™m']) || '0';
            congChuanBoSungEl.textContent = congChuanBoSung;
          }
          if (congChuanThemEl) congChuanThemEl.textContent = stats['C√¥ng chu·∫©n th√™m'] || (congChuanSheetTCKT && congChuanSheetTCKT['C√¥ng chu·∫©n th√™m']) || '0';
          if (tongCongChuanThucEl) tongCongChuanThucEl.textContent = stats['T·ªïng c√¥ng chu·∫©n th·ª±c'] || '0';
          if (soMauEl) soMauEl.textContent = stats['s·ªë l∆∞·ª£ng m·∫´u'] || stats['S·ªë m·∫´u'] || '0';
          // Parse s·ªë m·∫´u sheet th√™m t·ª´ "Th·ªëng k√™ sheet Th√™m"
          if (soMauSheetThemEl) {
            const soMauThem = (thongKeThem && thongKeThem['S·ªë m·∫´u']) || stats['S·ªë m·∫´u Sheet Th√™m'] || '0';
            soMauSheetThemEl.textContent = soMauThem;
          }
          if (nhanXetPicEl) nhanXetPicEl.textContent = stats['Nh·∫≠n x√©t tr∆∞·ªüng nh√≥m'] || stats['Nh·∫≠n x√©t PIC'] || '';
          
          // c. Populate Test b·ªÅn
          const testBenEl = document.getElementById('stats-test-ben');
          const testBenDuKienEl = document.getElementById('stats-test-ben-du-kien');
          if (testBenEl) testBenEl.textContent = stats['Test b·ªÅn'] || '';
          if (testBenDuKienEl) testBenDuKienEl.textContent = stats['D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn'] || '';
          
          // Populate test ben sections (5 b√¨a)
          let hasTestBenData = false;
          const testBenValue = String(stats['Test b·ªÅn'] || '').trim();
          const testBenDuKien = String(stats['D·ª± ki·∫øn ho√†n th√†nh test b·ªÅn'] || '').trim();
          if (testBenValue || testBenDuKien) {
            hasTestBenData = true;
          }
          
          // Parse d·ªØ li·ªáu test b·ªÅn b√¨a t·ª´ "D·ªØ li·ªáu test b·ªÅn b√¨a" (c√≥ th·ªÉ l√† JSON)
          const testBenBiaData = duLieuTestBenBia || {};
          
          for (let i = 1; i <= 5; i++) {
            // ∆Øu ti√™n l·∫•y t·ª´ "D·ªØ li·ªáu test b·ªÅn b√¨a" (JSON), sau ƒë√≥ m·ªõi ƒë·∫øn tr∆∞·ªùng ri√™ng l·∫ª
            const testBenKey = `Test b·ªÅn b√¨a ${i}`;
            const testBenBiaKey = `B√¨a ${i}`;
            const testBenContent = (testBenBiaData && testBenBiaData[testBenBiaKey]) || stats[testBenKey] || stats[`Test b·ªÅn (B√¨a)`] || '';
            const testBenItemEl = document.getElementById(`stats-test-ben-${i}`);
            const testBenContentEl = document.getElementById(`stats-test-ben-${i}-content`);
            
            if (testBenContent && String(testBenContent).trim()) {
              hasTestBenData = true;
              if (testBenItemEl) testBenItemEl.classList.remove('hidden');
              if (testBenContentEl) testBenContentEl.textContent = testBenContent;
            } else {
              if (testBenItemEl) testBenItemEl.classList.add('hidden');
            }
          }
          
          // ·∫®n section c n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
          const sectionC = document.getElementById('stats-section-c');
          if (sectionC) {
            sectionC.style.display = hasTestBenData ? 'block' : 'none';
          }
          
          // d. Populate Ti√™u chu·∫©n k·ªπ thu·∫≠t - Parse t·ª´ "Th·ªëng k√™ sheet TCKT" (JSON)
          const tcktData = thongKeTCKT || {};
          const totalTckt = parseInt(tcktData['T·ªïng'] || tcktData['H·∫°ng m·ª•c ƒë√°nh gi√° TCKT'] || stats['H·∫°ng m·ª•c ƒë√°nh gi√° TCKT'] || '0');
          const ok = parseInt(tcktData['OK'] || tcktData['H·∫°ng m·ª•c OK'] || stats['H·∫°ng m·ª•c OK'] || '0');
          const ng = parseInt(tcktData['NG'] || tcktData['H·∫°ng m·ª•c NG'] || stats['H·∫°ng m·ª•c NG'] || '0');
          const testBenCount = parseInt(tcktData['Test b·ªÅn'] || tcktData['H·∫°ng m·ª•c test b·ªÅn'] || stats['H·∫°ng m·ª•c test b·ªÅn'] || stats['S·ªë b√†i test b·ªÅn (TCKT)'] || '0');
          const notEval = parseInt(tcktData['Kh√¥ng ƒë√°nh gi√°'] || tcktData['H·∫°ng m·ª•c kh√¥ng ƒë√°nh gi√°'] || stats['H·∫°ng m·ª•c kh√¥ng ƒë√°nh gi√°'] || '0');
          const notConclusion = parseInt(tcktData['Kh√¥ng k·∫øt lu·∫≠n'] || tcktData['H·∫°ng m·ª•c kh√¥ng k·∫øt lu·∫≠n'] || stats['H·∫°ng m·ª•c kh√¥ng k·∫øt lu·∫≠n'] || '0');
          
          document.getElementById('stats-total-tckt').textContent = totalTckt || '0';
          document.getElementById('stats-ok').textContent = ok || '0';
          document.getElementById('stats-ng').textContent = ng || '0';
          document.getElementById('stats-test-ben-count').textContent = testBenCount || '0';
          document.getElementById('stats-not-eval').textContent = notEval || '0';
          const notConclusionEl = document.getElementById('stats-not-conclusion');
          if (notConclusionEl) notConclusionEl.textContent = notConclusion || '0';
          
          // ·∫®n section d n·∫øu t·∫•t c·∫£ ƒë·ªÅu 0 ho·∫∑c r·ªóng
          const sectionD = document.getElementById('stats-section-d');
          const hasDataD = totalTckt > 0 || ok > 0 || ng > 0 || testBenCount > 0 || notEval > 0 || notConclusion > 0;
          if (sectionD) {
            sectionD.style.display = hasDataD ? 'block' : 'none';
          }
          
          // e. Populate H·∫°ng m·ª•c th√™m - Parse t·ª´ "Th·ªëng k√™ sheet Th√™m" (JSON)
          const themData = thongKeThem || {};
          const additional = parseInt(themData['T·ªïng'] || themData['H·∫°ng m·ª•c th√™m '] || stats['H·∫°ng m·ª•c th√™m '] || '0');
          const additionalOk = parseInt(themData['OK'] || themData['H·∫°ng m·ª•c th√™m OK'] || stats['H·∫°ng m·ª•c th√™m OK'] || '0');
          const additionalNg = parseInt(themData['NG'] || themData['H·∫°ng m·ª•c th√™m NG'] || stats['H·∫°ng m·ª•c th√™m NG'] || '0');
          const additionalTestBen = parseInt(themData['Test b·ªÅn'] || themData['H·∫°ng m·ª•c th√™m test b·ªÅn'] || stats['H·∫°ng m·ª•c th√™m test b·ªÅn'] || '0');
          const additionalNa = parseInt(themData['NA'] || themData['H·∫°ng m·ª•c th√™m NA'] || stats['H·∫°ng m·ª•c th√™m NA'] || '0');
          const additionalKdg = parseInt(themData['KDG'] || themData['H·∫°ng m·ª•c th√™m KDG'] || stats['H·∫°ng m·ª•c th√™m KDG'] || '0');
          const additionalKkl = parseInt(themData['KKL'] || themData['H·∫°ng m·ª•c th√™m KKL'] || stats['H·∫°ng m·ª•c th√™m KKL'] || '0');
          const additionalComment = themData['Nh·∫≠n x√©t'] || themData['Nh·∫≠n x√©t H·∫°ng m·ª•c th√™m'] || stats['Nh·∫≠n x√©t H·∫°ng m·ª•c th√™m'] || '';
          
          document.getElementById('stats-additional').textContent = additional || '0';
          document.getElementById('stats-additional-ok').textContent = additionalOk || '0';
          document.getElementById('stats-additional-ng').textContent = additionalNg || '0';
          document.getElementById('stats-additional-test-ben').textContent = additionalTestBen || '0';
          // X·ª≠ l√Ω c·∫£ tr∆∞·ªùng c≈© v√† m·ªõi ƒë·ªÉ t∆∞∆°ng th√≠ch ng∆∞·ª£c
          const additionalNaEl = document.getElementById('stats-additional-na');
          if (additionalNaEl) {
            const naValue = additionalNa || additionalKdg || additionalKkl || '0';
            additionalNaEl.textContent = naValue;
          }
          const additionalKdgEl = document.getElementById('stats-additional-kdg');
          if (additionalKdgEl) additionalKdgEl.textContent = additionalKdg || '0';
          const additionalKklEl = document.getElementById('stats-additional-kkl');
          if (additionalKklEl) additionalKklEl.textContent = additionalKkl || '0';
          document.getElementById('stats-additional-comment').textContent = additionalComment;
          
          // ·∫®n section e n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
          const sectionE = document.getElementById('stats-section-e');
          const hasDataE = additional > 0 || additionalOk > 0 || additionalNg > 0 || additionalTestBen > 0 || additionalNa > 0 || additionalKdg > 0 || additionalKkl > 0 || additionalComment.trim();
          if (sectionE) {
            sectionE.style.display = hasDataE ? 'block' : 'none';
          }
          
          // f. Populate R·ªßi ro v√† PTC
          const riskPtcTotal = parseInt(stats['R·ªßi ro v√† PTC'] || '0');
          const ptcOk = parseInt(stats['PTC OK'] || '0');
          const ptcNg = parseInt(stats['PTC NG'] || '0');
          const ptcTestBen = parseInt(stats['PTC test b·ªÅn'] || '0');
          const ptcNa = parseInt(stats['PTC NA'] || '0');
          const ptcComment = stats['Nh·∫≠n x√©t PTC'] || '';
          
          document.getElementById('stats-risk-ptc-total').textContent = riskPtcTotal || '0';
          document.getElementById('stats-ptc-ok').textContent = ptcOk || '0';
          document.getElementById('stats-ptc-ng').textContent = ptcNg || '0';
          document.getElementById('stats-ptc-test-ben').textContent = ptcTestBen || '0';
          document.getElementById('stats-ptc-na').textContent = ptcNa || '0';
          document.getElementById('stats-ptc-comment').textContent = ptcComment;
          
          // ·∫®n section f n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
          const sectionF = document.getElementById('stats-section-f');
          const hasDataF = riskPtcTotal > 0 || ptcOk > 0 || ptcNg > 0 || ptcTestBen > 0 || ptcNa > 0 || ptcComment.trim();
          if (sectionF) {
            sectionF.style.display = hasDataF ? 'block' : 'none';
          }
          
          // g. Populate AI ph√¢n t√≠ch - B√†i test 1-4
          let hasTestData = false;
          for (let i = 1; i <= 4; i++) {
            const testName = stats[`B√†i test ${i}`];
            const testEl = document.getElementById(`stats-test-${i}`);
            
            if (testName && testName.trim()) {
              hasTestData = true;
              if (testEl) testEl.classList.remove('hidden');
              document.getElementById(`stats-test-${i}-name`).textContent = testName;
              document.getElementById(`stats-test-${i}-standard`).textContent = stats[`Ti√™u chu·∫©n ${i}`] || '';
              document.getElementById(`stats-test-${i}-condition`).textContent = stats[`ƒêi·ªÅu ki·ªán ${i}`] || '';
              document.getElementById(`stats-test-${i}-progress`).textContent = stats[`Ti·∫øn ƒë·ªô ${i}`] || '';
              // X·ª≠ l√Ω c·∫£ "T√¨nh tr·∫°ng" v√† "Tr√¨nh tr·∫°ng" (c√≥ th·ªÉ c√≥ typo)
              const statusKey = `T√¨nh tr·∫°ng ${i}`;
              const statusKeyAlt = `Tr√¨nh tr·∫°ng ${i}`;
              document.getElementById(`stats-test-${i}-status`).textContent = stats[statusKey] || stats[statusKeyAlt] || '';
            } else {
              if (testEl) testEl.classList.add('hidden');
            }
          }
          
          // Populate Nh·∫≠n x√©t AI
          const aiComment = stats['Nh·∫≠n x√©t AI'] || '';
          document.getElementById('stats-ai-comment').textContent = aiComment;
          
          // Populate B·∫•t th∆∞·ªùng AI
          const abnormalitiesList = document.getElementById('stats-abnormalities-list');
          const abnormalities = stats['Ph√°t hi·ªán b·∫•t th∆∞·ªùng AI'] || stats['B·∫•t th∆∞·ªùng AI'];
          
          let hasAbnormalities = false;
          if (abnormalitiesList) {
            abnormalitiesList.innerHTML = '';
            
            // Handle different data types for abnormalities
            let abnormalityItems = [];
            
            if (Array.isArray(abnormalities)) {
              abnormalityItems = abnormalities;
            } else if (typeof abnormalities === 'string' && abnormalities.trim()) {
              // If it's a string, split by common delimiters
              abnormalityItems = abnormalities.split(/[;\n\r]+/).map(item => item.trim()).filter(item => item);
            } else if (abnormalities && typeof abnormalities === 'object') {
              // If it's an object, try to extract values
              abnormalityItems = Object.values(abnormalities).filter(item => item && typeof item === 'string' && item.trim());
            }
            
            if (abnormalityItems.length > 0) {
              hasAbnormalities = true;
              abnormalityItems.forEach((abnormality, index) => {
                if (abnormality && abnormality.trim()) {
                  const div = document.createElement('div');
                  div.className = 'bg-red-50 p-3 rounded-lg border-l-4 border-red-400';
                  div.innerHTML = `<div class="text-sm text-gray-700">${abnormality}</div>`;
                  abnormalitiesList.appendChild(div);
                }
              });
            } else {
              abnormalitiesList.innerHTML = '<div class="text-sm text-gray-500 italic">Kh√¥ng c√≥ b·∫•t th∆∞·ªùng n√†o ƒë∆∞·ª£c ph√°t hi·ªán</div>';
            }
          }
          
          // ·∫®n section g n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu (kh√¥ng c√≥ b√†i test n√†o, kh√¥ng c√≥ nh·∫≠n x√©t AI, kh√¥ng c√≥ b·∫•t th∆∞·ªùng)
          const sectionG = document.getElementById('stats-section-g');
          const hasDataG = hasTestData || aiComment.trim() || hasAbnormalities;
          if (sectionG) {
            sectionG.style.display = hasDataG ? 'block' : 'none';
          }
          
          // Show content and hide loading
          if (loadingEl) loadingEl.style.display = 'none';
          if (contentEl) contentEl.classList.remove('hidden');
          
        } catch (err) {
          console.error('Error loading stats:', err);
          if (loadingEl) loadingEl.innerHTML = '<div class="text-red-600">L·ªói t·∫£i d·ªØ li·ªáu: ' + err.message + '</div>';
        }
        
        openModal(modalId);
      }

      async function renderForm1(){
        const name = (document.getElementById('f1-name').value || '').trim();
        const body = document.getElementById('f1-body');
        if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="20">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
        body.innerHTML = "<tr><td colspan='20' class='px-3 py-3 text-center text-gray-500 border border-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        try{
            const headerMapF1 = {
            header_btn: 'N√∫t nh·∫≠p g·ª≠i b√°o c√°o',
            header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
            header_requestDate: 'Ng√†y y√™u c·∫ßu',
            header_wishDue: 'H·∫°n mong mu·ªën',
            header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
            header_code: 'M√£',
            header_taskId: 'M√£ t√°c v·ª•',
            header_taskName: 'T√™n t√°c v·ª•',
            header_receiverSample: 'Ng∆∞·ªùi nh·∫≠n m·∫´u',
            header_manHour: 'C√¥ng chu·∫©n',
            header_purpose: 'M·ª•c ƒë√≠ch ƒë√°nh gi√°',
            header_note: 'Note',
            header_specialTest: 'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát',
            header_reportForm: 'Form b√°o c√°o ƒë√°nh gi√°',
            header_submitTime: 'Tgian n·ªôp form',
            header_reportDueDate: 'Ng√†y c·∫ßn tr·∫£ BC',
            header_status: 'Tr·∫°ng th√°i',
            header_attachmentFileName: 'T√™n file ƒë√≠nh k√®m',
            header_attachmentUrl: 'T·∫£i ƒë√≠nh k√®m',
            field_requester: 'requester',
            field_requestDate: 'requestDate',
            field_wishDue: 'wishDue',
            field_actualDue: 'actualDue',
            field_code: 'code',
            field_taskId: 'taskId',
            field_taskName: 'taskName',
            field_receiverSample: 'receiverSample',
            field_manHour: 'manHour',
            field_purpose: 'purpose',
            field_note: 'note',
            field_specialTest: 'specialTest',
            field_reportForm: 'reportForm',
            field_submitTime: 'submitTime',
            field_reportDueDate: 'reportDueDate',
            field_status: 'status',
            field_attachmentFileName: 'attachmentFileName',
            field_attachmentUrl: 'attachmentUrl'
          };
          const params = new URLSearchParams({
            ...headerMapF1,
            action: 'form1_lookup',
            person_name: name,
            timestamp: new Date().toISOString()
          });
          const testUrl = `${FORM1_WEBHOOK_URL}?${params.toString()}`;
          async function fetchJson(url){
            const r = await fetch(url, { method: 'GET' });
            const text = await r.text();
            if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
            let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
            return { parsed, raw: text };
          }
          let data = null; let firstErr = null;
          try{
            const { parsed, raw } = await fetchJson(testUrl);
            if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
              throw new Error('WEBHOOK_TEST_INACTIVE');
            }
            data = parsed ?? raw;
          } catch (e) {
            firstErr = e;
            // Fallback sang production webhook khi test webhook ch∆∞a b·∫≠t l·∫Øng nghe
            const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
            const { parsed, raw } = await fetchJson(prodUrl);
            data = parsed ?? raw;
          }
          const rows = pickRows(data);
          try{ LS.setJSON('f1.raw', { name, rows, ts: Date.now() }); }catch(_){ }
          if(!rows.length){ body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
          // Cache v√† timestamp
          try{ LS.setJSON('f1.cache', { name, rows }); LS.set('f1.lastUpdated', String(Date.now())); updateLastUpdatedNote('f1-search','f1.lastUpdated'); }catch(_){ }
          renderForm1FromRows(rows);
        }catch(err){
          body.innerHTML = `<tr><td colspan='17' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
        }
      }
      document.getElementById('f1-name').onchange = ()=>{};
      // T·ª± kh·ªüi t·∫°o t·ª´ cache n·∫øu c√≥
      (function initF1FromCache(){
        try{
          const cached = LS.getJSON('f1.cache');
          const cachedName = LS.get('f1.selectedName')||'';
          if (!cached || !cached.rows || !cachedName) return;
          const sel = document.getElementById('f1-name');
          if (sel && (!sel.value)) sel.value = cachedName;
          renderForm1FromRows(cached.rows);
          updateLastUpdatedNote('f1-search','f1.lastUpdated');
        }catch(_){ }
      })();
      const f1SearchBtn = document.getElementById('f1-search');
      if (f1SearchBtn) {
        let f1Busy = false;
        f1SearchBtn.onclick = async (e)=>{
          e.preventDefault();
          if (f1Busy) return;
          f1Busy = true;
          f1SearchBtn.disabled = true;
          const prev = f1SearchBtn.textContent;
          f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
          try { await renderForm1(); }
          finally {
            f1Busy = false;
            f1SearchBtn.disabled = false;
            f1SearchBtn.textContent = prev;
          }
        };
      }
      // Pagination events
      const f1Prev = document.getElementById('f1-prev');
      const f1Next = document.getElementById('f1-next');
      const f1Size = document.getElementById('f1-size');
      if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
      if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
      if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'20',10)||20; F1_PAGE=1; applyForm1Paging(); };
      // Default month and change handler for Form 1 filter (Done/Cancel)
      (function initF1Month(){
        const m = document.getElementById('f1-month');
        if (!m) return;
        const d = new Date();
        const yy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        if (!m.value) m.value = `${yy}-${mm}`;
        if (!m._bound){ m.addEventListener('change', ()=> applyForm1MonthFilter()); m._bound = true; }
      })();

      // Helper: ∆∞u ti√™n ch·ªçn M√£ t√°c v·ª• theo ti·ªÅn t·ªë QA.Y/QA.NB
      function pickTaskIdPreferQA(taskId, code){
        try{
          const s1 = String(taskId||'').trim();
          const s2 = String(code||'').trim();
          const re = /^QA\.(?:Y|NB)\./i;
          const has1 = re.test(s1);
          const has2 = re.test(s2);
          if (has1 && has2) return s1;
          if (has1) return s1;
          if (has2) return s2;
          return s1 || s2 || '';
        }catch(_){ return String(taskId||code||'').trim(); }
      }

      // Create Task Modal (Form 3) logic
      function openCreateTaskModal(){
        const modal = document.getElementById('create-task-modal');
        if (!modal) return;
        // Set time
        const d = new Date();
        const timeEl = document.getElementById('create-rq-time');
        if (timeEl) timeEl.value = formatYyyyMmDdHHmm(d);
        // Reset form
        const form = document.getElementById('create-task-form');
        if (form) form.reset();
        if (timeEl) timeEl.value = formatYyyyMmDdHHmm(d);
        // Clear file preview
        const list = document.getElementById('create-f3-upload-list');
        if (list) list.innerHTML = '';
        // Show modal
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }
      function closeCreateTaskModal(){
        const modal = document.getElementById('create-task-modal');
        if (!modal) return;
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
      }
      // Event listeners for Create Task Modal
      const createTaskBtn = document.getElementById('create-task-btn');
      if (createTaskBtn) createTaskBtn.onclick = (e) => { e.preventDefault(); openCreateTaskModal(); };
      const createTaskCancelBtn = document.getElementById('create-task-cancel');
      if (createTaskCancelBtn) createTaskCancelBtn.onclick = closeCreateTaskModal;
      const createTaskModal = document.getElementById('create-task-modal');
      if (createTaskModal) {
        createTaskModal.addEventListener('click', (e) => { if(e.target === createTaskModal) closeCreateTaskModal(); });
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && createTaskModal.classList.contains('open')) closeCreateTaskModal(); });
      }
      
      function setCreateRqTime(){ const d=new Date(); const el=document.getElementById('create-rq-time'); if (el) el.value = formatYyyyMmDdHHmm(d); }
      setCreateRqTime();
      // Helper: set default date for Form 5 inputs
      function setF5DateDefault(){
        const el = document.getElementById('f5-date');
        if (!el) return;
        const d = new Date();
        const pad = n=>String(n).padStart(2,'0');
        el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }

      // Create Task Modal: preview selected file (send with form later via webhook)
      (function setupCreateTaskUploadPreview(){
        const createFileInput = document.getElementById('create-attach');
        const createList = document.getElementById('create-f3-upload-list');
        if (createFileInput && createList) {
          createList.innerHTML = '';
          function renderCreatePreview(file){
            const row = document.createElement('div');
            row.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
            row.innerHTML = `<span>üìÑ<span class="ml-2">${file.name}</span></span><span class="text-xs text-blue-700">S·∫Ω g·ª≠i k√®m khi giao vi·ªác</span>`;
            createList.innerHTML = '';
            createList.appendChild(row);
          }
          createFileInput.addEventListener('change', function(){
            createList.innerHTML = '';
            if (!this.files || this.files.length === 0) return;
            renderCreatePreview(this.files[0]);
          });
        }
      })();


      // Submit Form 3 via webhook endpoint (multipart form-data) - Create Task Modal
      const createTaskForm = document.getElementById('create-task-form');
      if (createTaskForm) {
        createTaskForm.onsubmit = async (e) => {
          e.preventDefault();
          const requester = document.getElementById('create-rq-by').value.trim();
          const requesterEmail = (document.getElementById('create-rq-by-email')?.value || '').trim();
          const taskName = (document.getElementById('create-task-name')?.value || '').trim();
          const rqTime = document.getElementById('create-rq-time').value;
          let manHourRaw = document.getElementById('create-man-hour').value;
          const output = document.getElementById('create-output').value.trim();
          const assignee = (document.getElementById('create-f3-assignee').value || '').trim();
          const deadline = document.getElementById('create-deadline').value;
          const odooJira = document.getElementById('create-odoo-jira').value.trim();
          const taskType = (document.getElementById('create-task-type')?.value || '').trim();
          const purpose = (document.getElementById('create-purpose')?.value || '').trim();

          if(!requester || !taskName || !output || !manHourRaw || !assignee || !taskType || !purpose){ 
            showToast('Vui l√≤ng ƒëi·ªÅn ƒë·ªß tr∆∞·ªùng b·∫Øt bu·ªôc.','error'); 
            return; 
          }
          
          // T·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi d·∫•u ch·∫•m th√†nh d·∫•u ph·∫©y cho s·ªë th·∫≠p ph√¢n
          manHourRaw = manHourRaw.replace(/\./g, ',');
          
          // C·∫≠p nh·∫≠t gi√° tr·ªã trong input ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y s·ª± thay ƒë·ªïi
          document.getElementById('create-man-hour').value = manHourRaw;
          
          if(!/^\d+(,\d{1,2})?$/.test(manHourRaw)){ showToast('C√¥ng chu·∫©n t·ªëi ƒëa 2 ch·ªØ s·ªë th·∫≠p ph√¢n. S·ª≠ d·ª•ng d·∫•u ph·∫©y (,) thay v√¨ d·∫•u ch·∫•m (.)','error'); return; }

          const btn = e.target.querySelector('button[type="submit"]');
          const prev = btn ? btn.textContent : '';
          if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }

          // Generate Reqcode: QA.NB.DDMM-XXXXXX (X: A-Z0-9)
          const Reqcode = (function(){
            const d = new Date();
            const pad = (n)=> String(n).padStart(2,'0');
            const ddmm = pad(d.getDate()) + pad(d.getMonth()+1);
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let rand = '';
            for (let i = 0; i < 6; i++) rand += chars[Math.floor(Math.random()*chars.length)];
            return `QA.NB.${ddmm}-${rand}`;
          })();

          // ƒê·∫£m b·∫£o requestDate lu√¥n c√≥ format YYYY-MM-DD HH:mm
          let requestDateFormatted = '';
          if (rqTime && rqTime.trim()) {
            // N·∫øu rqTime ƒë√£ c√≥ gi√° tr·ªã, format l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√∫ng format
            requestDateFormatted = formatYyyyMmDdHHmm(rqTime);
          } else {
            // N·∫øu kh√¥ng c√≥, d√πng th·ªùi gian hi·ªán t·∫°i
            requestDateFormatted = formatYyyyMmDdHHmm(new Date());
          }

          const mapped = {
            requesterName: requester,
            requesterEmail: requesterEmail,
            requestDate: requestDateFormatted,
            itemName: taskName,
            Score: String(manHourRaw || '').trim(),
            changeReq: output,
            Assignee: assignee,
            desiredDate: deadline ? formatDdMmYyyy(deadline) : '',
            Odoojira: odooJira,
            taskType: taskType,
            purpose: purpose,
            deptRequest: 'DQA',
            Reqcode: Reqcode
          };

          const fd = new FormData();
          Object.entries(mapped).forEach(([k,v])=> fd.append(k, v));
          // Th√™m action v√† timestamp ƒë·ªÉ server nh·∫≠n di·ªán
          fd.append('action', 'form3_submit');
          fd.append('timestamp', formatYyyyMmDdHHmm(new Date()));
          fd.append('timestamp_iso', new Date().toISOString());
          const fileEl = document.getElementById('create-attach');
          if (fileEl && fileEl.files && fileEl.files.length){
            const f = fileEl.files[0];
            try { fd.append('file', f, f.name); } catch(_){ fd.append('file', f); }
          }

          try{
            // G·ª≠i FormData v·ªõi mode no-cors
            await fetch(FORM3_ENDPOINT, { method: 'POST', body: fd, mode: 'no-cors' });
            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o webhook ƒë√£ x·ª≠ l√Ω xong
            await new Promise(resolve => setTimeout(resolve, 500));
            showToast('ƒê√£ giao vi·ªác v√† g·ª≠i d·ªØ li·ªáu.','success');
            e.target.reset();
            setCreateRqTime();
            try{ const list = document.getElementById('create-f3-upload-list'); if (list) list.innerHTML = ''; }catch(_){ }
            closeCreateTaskModal();
            // T·ª± ƒë·ªông refresh b·∫£ng Form 1 sau khi t·∫°o t√°c v·ª• th√†nh c√¥ng
            try { if (typeof renderForm1 === 'function') await renderForm1(); } catch(_){}
          }catch(err){
            console.error('Create Task submit error:', err);
            showToast('G·ª≠i th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.','error');
          }finally{
            if (btn) { btn.disabled = false; btn.textContent = prev || 'Giao vi·ªác'; }
          }
        };
      }
      
      const detailModal = document.getElementById('detail-modal');
      const detailBody = document.getElementById('detail-body');
      const detailNameEl = document.getElementById('detail-name');
      const detailNote = document.getElementById('detail-note');
      const detailClose = document.getElementById('detail-close');

      function openDetailModal(empName, filter, from, to){
        if (!detailModal) return;
        detailNameEl.textContent = empName || '';
        detailBody.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500"><span class="spinner mr-2"></span>ƒêang t·∫£i...</td></tr>`;
        detailNote.textContent = filter === 'Doing' ? 'Ch·ªâ hi·ªÉn th·ªã t√°c v·ª• ƒëang Doing.' : 'Hi·ªÉn th·ªã t·∫•t c·∫£ t√°c v·ª•.';
        detailModal.classList.add('open');
        detailModal.setAttribute('aria-hidden','false');
        try{
          const isForm5Visible = (function(){
            try{
              const sec5 = document.getElementById('form5');
              return sec5 && !sec5.classList.contains('hidden');
            }catch(_){ return false; }
          })();
          // ∆Øu ti√™n s·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ n8n (F5A_P1_DATA) n·∫øu c√≥
          if (isForm5Visible && F5A_P1_DATA && Array.isArray(F5A_P1_DATA.data) && F5A_P1_DATA.data.length > 0){
            renderDetailTasksFromF5All(empName, from, to).catch(()=> renderDetailTasks(empName, filter, from, to));
            return;
          }
          // Fallback v·ªÅ F5A_RAW_ALL n·∫øu kh√¥ng c√≥ F5A_P1_DATA
          if (isForm5Visible && Array.isArray(F5A_RAW_ALL) && F5A_RAW_ALL.length){
            renderDetailTasksFromF5All(empName, from, to).catch(()=> renderDetailTasks(empName, filter, from, to));
            return;
          }
        }catch(_){ }
        renderDetailTasks(empName, filter, from, to).catch(()=>{});
      }
      function closeDetailModal(){
        if (!detailModal) return;
        detailModal.classList.remove('open');
        detailModal.setAttribute('aria-hidden','true');
      }
      if (detailClose) detailClose.onclick = closeDetailModal;
      if (detailModal) detailModal.addEventListener('click', (e)=>{ if(e.target===detailModal) closeDetailModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && detailModal && detailModal.classList.contains('open')) closeDetailModal(); });

      // Renderer d√πng d·ªØ li·ªáu t·ª´ n8n (field details) thay v√¨ t√≠nh to√°n l·∫°i t·ª´ raw data
      async function renderDetailTasksFromF5All(name, from, to){
        try{
          // L·∫•y th√°ng t·ª´ from ho·∫∑c to, ho·∫∑c t·ª´ F5A_P1_META n·∫øu ƒë√£ c√≥
          const monthGuess = (from || '').slice(0,7) || (to || '').slice(0,7) || F5A_P1_META.month || '';
          
          // Ch·ªâ fetch l·∫°i n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu ho·∫∑c th√°ng kh√¥ng kh·ªõp
          if (!F5A_P1_DATA || !Array.isArray(F5A_P1_DATA.data) || F5A_P1_DATA.data.length === 0 || (monthGuess && F5A_P1_META.month !== monthGuess)){
            console.log('[F5A P1 Detail] Fetching data for month:', monthGuess);
            await f5aFetchP1Data(monthGuess);
          } else {
            console.log('[F5A P1 Detail] Using cached data for month:', F5A_P1_META.month);
          }
          
          // Ki·ªÉm tra cache n·∫øu fetch th·∫•t b·∫°i
          if (!F5A_P1_DATA || !Array.isArray(F5A_P1_DATA.data) || F5A_P1_DATA.data.length === 0){
            try{
              const cached = LS.getJSON('f5a.p1.cache');
              if (cached && cached.version === APP_CACHE_VERSION && cached.data && Array.isArray(cached.data.data) && cached.data.data.length > 0){
                F5A_P1_DATA = cached.data;
                F5A_P1_META = { month: cached.month || monthGuess };
                console.log('[F5A P1 Detail] Loaded from cache');
              }
            }catch(_){ }
          }
          
          // ƒê·∫£m b·∫£o F5A_RAW_ALL c√≥ d·ªØ li·ªáu ƒë·ªÉ modal ho·∫°t ƒë·ªông
          if ((!F5A_RAW_ALL || !Array.isArray(F5A_RAW_ALL) || F5A_RAW_ALL.length === 0) && monthGuess) {
            try {
              let fromVal = '', toVal = '';
              if (monthGuess) {
                const [yy, mm] = monthGuess.split('-');
                fromVal = `${yy}-${mm}-01`;
                const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
                toVal = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
              }
              await f5aFetchAllOnce(monthGuess, fromVal, toVal);
            } catch(_) {
              console.warn('[F5A Detail] Failed to fetch raw data');
            }
          }
          
          // T√¨m nh√¢n vi√™n trong d·ªØ li·ªáu t·ª´ n8n
          if (!F5A_P1_DATA || !F5A_P1_DATA.success || !Array.isArray(F5A_P1_DATA.data)){
            detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
            return;
          }
          
          // T√¨m employee data t·ª´ n8n response
          const normalizeName = (s)=>{
            try{
              const raw = String(s||'').trim();
              const noAcc = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
              return noAcc.replace(/\s+/g,' ').trim();
            }catch(_){ return String(s||'').toLowerCase().trim(); }
          };
          const targetNameNorm = normalizeName(name);
          const empData = F5A_P1_DATA.data.find(emp => {
            const empName = emp['Ph·ª• tr√°ch'] || emp.name || '';
            return normalizeName(empName) === targetNameNorm;
          });
          
          if (!empData || !empData.details){
            detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu cho nh√¢n vi√™n n√†y</td></tr>`;
            return;
          }
          
          // S·ª≠ d·ª•ng details t·ª´ n8n (ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n v√† ph√¢n lo·∫°i s·∫µn)
          // Map d·ªØ li·ªáu t·ª´ n8n sang format ƒë·ªÉ render
          function mapTaskDetail(task){
            const actualHoursDisp = Number.isFinite(task.actualNum) ? formatNumberVi(task.actualNum, 2, 2) : (task.actualHours || '');
            const manDisp = formatNumberVi(Number(task.man || 0), 2, 2);
            const wishDisp = formatDdMmYyyy(task.wish || '');
            let wishPlus2Disp = '';
            try{
              const dW = parseDateFlexible(task.wish);
              if (dW){
                const plus1 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 1);
                wishPlus2Disp = formatDdMmYyyy(plus1);
              }
            }catch(_){ }
            const doneDisp = formatDdMmYyyy(task.done || '');
            return {
              code: task.code || '',
              tname: task.tname || '',
              rq: task.rq || '',
              actualHours: task.actualHours || '',
              actualHoursDisp: actualHoursDisp,
              man: task.man || 0,
              manDisp: manDisp,
              statusByMan: task.statusByMan || '',
              wish: task.wish || '',
              wishDisp: wishDisp,
              wishPlus2Disp: wishPlus2Disp,
              done: task.done || '',
              doneDisp: doneDisp,
              statusVsWish: task.statusVsWish || '',
              actualIsZero: task.actualIsZero || false
            };
          }
          
          const listSameMonth = Array.isArray(empData.details.sameMonth) 
            ? empData.details.sameMonth.map(mapTaskDetail) 
            : [];
          const listPrevMonth = Array.isArray(empData.details.prevMonth) 
            ? empData.details.prevMonth.map(mapTaskDetail) 
            : [];
          if (!listSameMonth.length && !listPrevMonth.length){
            const hasRange = Boolean((from||'').trim() || (to||'').trim());
            const msg = hasRange ? 'Kh√¥ng c√≥ t√°c v·ª• trong th√°ng ƒë√£ ch·ªçn.' : 'Kh√¥ng c√≥ t√°c v·ª•.';
            detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">${msg}</td></tr>`;
            return;
          }
          let stt = 0;
          function renderRow(it){ return `
            <tr>
              <td class="px-3 py-2">${++stt}</td>
              <td class="px-3 py-2">${it.code}</td>
              <td class="px-3 py-2">${it.tname}</td>
              <td class="px-3 py-2">${(function(v){ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } })(it.rq||it.rqDisp||'')}</td>
              <td class="px-3 py-2${it.actualIsZero ? ' bg-amber-100 text-amber-800' : ''}">${it.actualHoursDisp||''}</td>
              <td class="px-3 py-2">${it.manDisp||''}</td>
              <td class="px-3 py-2">${(function(s){ const t=String(s||'').toLowerCase(); let cls='bg-blue-100 text-blue-800'; if(t.includes('thi·∫øu d·ªØ li·ªáu')) cls='bg-amber-100 text-amber-800'; else if(t.includes('v∆∞·ª£t ti·∫øn ƒë·ªô')) cls='bg-blue-100 text-blue-800'; else if(t.includes('ƒë√∫ng ti·∫øn ƒë·ªô')||t.includes('dung tien do')) cls='bg-green-100 text-green-800'; else if(t.includes('ch·∫≠m ti·∫øn ƒë·ªô')||t.includes('cham tien do')) cls='bg-red-100 text-red-800'; else if(t.includes('ch·ªù ph√™ duy·ªát')||t.includes('cho phe duyet')) cls='bg-orange-100 text-orange-800'; else if(t.includes('cancel')||t.includes('h·ªßy')||t.includes('hu·ª∑')) cls='bg-gray-200 text-gray-700'; else if(t.includes('doing')||t.includes('ƒëang')) cls='bg-blue-100 text-blue-800'; return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`; })(it.statusByMan || it.status)}</td>
              <td class="px-3 py-2">${it.wishDisp||it.wish||''}${it.wishPlus2Disp? `<div class=\"text-xs text-gray-500 mt-0.5\">H·∫°n +1: ${it.wishPlus2Disp}</div>`:''}</td>
              <td class="px-3 py-2">${it.doneDisp||it.done||''}</td>
            </tr>
          `; }
          const groupHeader = (title)=> `<tr class="bg-blue-50"><td class="px-3 py-2 font-semibold" colspan="9">${title}</td></tr>`;
          const headerRow = `<tr class="bg-slate-100 text-sm font-semibold"><td class="px-3 py-2">STT</td><td class="px-3 py-2">M√£</td><td class="px-3 py-2">T√™n t√°c v·ª•</td><td class="px-3 py-2">Ng√†y y√™u c·∫ßu</td><td class="px-3 py-2" title="Kho·∫£ng th·ªùi gian t·ª´ l√∫c t·∫£i (n·ªôp)form ƒë·∫øn khi k·∫øt qu·∫£ b√°o c√°o ƒë∆∞·ª£c g·ª≠i ƒëi (T√≠nh trong gi·ªù h√†nh ch√≠nh)">S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø</td><td class="px-3 py-2" title="T·ªïng c√¥ng chu·∫©n c·ªßa sheet (TCKT) v√† sheet (THEM) c·ªßa b√°o c√°o">C√¥ng chu·∫©n</td><td class="px-3 py-2">Tr·∫°ng th√°i theo c√¥ng chu·∫©n</td><td class="px-3 py-2">H·∫°n mong mu·ªën</td><td class="px-3 py-2">Ng√†y ho√†n th√†nh</td></tr>`;
          const htmlParts = [];
          htmlParts.push(groupHeader('Nh·∫≠n trong th√°ng n√†y v√† ho√†n th√†nh trong th√°ng'));
          htmlParts.push(headerRow);
          htmlParts.push(listSameMonth.length ? listSameMonth.map(renderRow).join('') : `<tr><td colspan="9" class="px-3 py-2 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`);
          htmlParts.push(groupHeader('Nh·∫≠n th√°ng tr∆∞·ªõc nh∆∞ng ho√†n th√†nh trong th√°ng'));
          htmlParts.push(headerRow);
          htmlParts.push(listPrevMonth.length ? listPrevMonth.map(renderRow).join('') : `<tr><td colspan="9" class="px-3 py-2 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`);
          detailBody.innerHTML = htmlParts.join('');
        }catch(_){
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="9">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu.</td></tr>`;
        }
      }

      async function renderDetailTasks(name, filter, from, to){
        const headerMapF1 = {
          header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_code: 'M√£',
          header_taskName: 'T√™n t√°c v·ª•',
          header_manHour: 'C√¥ng chu·∫©n',
          header_status: 'Tr·∫°ng th√°i',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
          field_manHour: 'manHour',
          field_status: 'status'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        // KH√îNG truy·ªÅn from/to l√™n server ƒë·ªÉ tr√°nh l·ªçc sai m·ªëc (server c√≥ th·ªÉ ch·ªâ l·ªçc theo Ng√†y y√™u c·∫ßu);
        // Thay v√†o ƒë√≥, l·ªçc c·ª•c b·ªô theo th√°ng b·∫±ng logic refDate ·ªü d∆∞·ªõi ƒë·ªÉ kh·ªõp v·ªõi "C√¥ng chu·∫©n ƒë√£ nh·∫≠n".
        function getV(obj, keys){
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        }
        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
          return { ok: r.ok, parsed, raw: text, status: r.status };
        }
        try{
          const testUrl = `${FORM1_LOOKUP_URL}?${params.toString()}`;
          let first = await fetchJson(testUrl);
          if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
            const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
            first = await fetchJson(prodUrl);
          }
          if (!first.ok) throw new Error(first.raw || `HTTP ${first.status}`);
          const data = first.parsed ?? (first.raw ? JSON.parse(first.raw) : null);
          let rows = pickRows(data);
          if (filter === 'Doing'){
            rows = rows.filter(item=>{
              const statusText = String(getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i'])||'');
              const s = statusText.toLowerCase();
              // "Chuy·ªÉn SPM c·∫≠p nh·∫≠t" kh√¥ng c√≤n trong filter Doing v√¨ ƒë√£ chuy·ªÉn sang logic Done
              const isDoing = s.includes('doing') || s.includes('ƒëang') || s.includes('chuy·ªÉn nh√≥m spm') || s.includes('chuyen nhom spm');
              return isDoing;
            });
          }
          // L·ªçc c·ª•c b·ªô theo th√°ng d·ª±a tr√™n m·ªëc tham chi·∫øu refDate (requestDate -> actualDue -> wishDue -> doneDate), lo·∫°i Cancel
          (function(){
            try{
              const fromVal = (from || '').trim();
              const toVal = (to || '').trim();
              function hasVal(v){ return v != null && String(v).trim() !== ''; }
              function getText(o, keys){
                const lower = Object.keys(o||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = o[k]; return acc; },{});
                for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return String(v); }
                return '';
              }
              function isCanceledRow(o){
                const st = getText(o,['status','trangthai','trang_thai','tr·∫°ng th√°i']).toLowerCase();
                const doneDate = getText(o,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh']);
                return st.includes('cancel') || st.includes('h·ªßy') || st.includes('hu·ª∑') || /cancel/i.test(doneDate||'');
              }
              function chooseRefDate(o){
                const rq = getText(o,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','üìÜ ng√†y y√™u c·∫ßu']);
                const act = getText(o,['actualdue','handapung','han_dap_ung','completiondate']);
                const wish= getText(o,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
                const done= getText(o,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh']);
                return hasVal(rq) ? rq : (hasVal(act) ? act : (hasVal(wish) ? wish : (hasVal(done) ? done : '')));
              }
              try{ if (!window.F5A_LOG) window.F5A_LOG = {}; if (!window.F5A_LOG.filteredOut) window.F5A_LOG.filteredOut = []; }catch(_){ }
              if (fromVal || toVal){
                rows = rows.filter(o=>{
                  if (isCanceledRow(o)) return false;
                  const ref = chooseRefDate(o);
                  const d = parseDateFlexible(ref);
                  if (!d){ try{ window.F5A_LOG.filteredOut.push({ reason:'bad_date', row:o, ref }); }catch(_){ } return false; }
                  const ds = d.toISOString().slice(0,10);
                  if (fromVal && ds < fromVal){ try{ window.F5A_LOG.filteredOut.push({ reason:'before_range', row:o, refDate: ds }); }catch(_){ } return false; }
                  if (toVal && ds > toVal){ try{ window.F5A_LOG.filteredOut.push({ reason:'after_range', row:o, refDate: ds }); }catch(_){ } return false; }
                  return true;
                });
              } else {
                rows = rows.filter(o=> { const drop = isCanceledRow(o); try{ if (drop){ if (!window.F5A_LOG) window.F5A_LOG={}; if(!window.F5A_LOG.filteredOut) window.F5A_LOG.filteredOut=[]; window.F5A_LOG.filteredOut.push({ reason:'cancel', row:o }); } }catch(_){ } return !drop; });
              }
              try{ console.info('[F5A] Month filter result:', { kept: rows.length, filtered: (window.F5A_LOG&&window.F5A_LOG.filteredOut)? window.F5A_LOG.filteredOut.length:0 }); }catch(_){ }
            }catch(_){ }
          })();
          if (!rows.length){
            const hasRange = Boolean((from||'').trim() || (to||'').trim());
            const msg = hasRange ? 'Kh√¥ng c√≥ t√°c v·ª• trong th√°ng ƒë√£ ch·ªçn.' : `Kh√¥ng c√≥ t√°c v·ª•${filter==='Doing'?' Doing':''}.`;
            detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">${msg}</td></tr>`;
            return;
          }
          // Helper parse date (h·ªó tr·ª£ YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD, c√≥/kh√¥ng gi·ªù)
          function toDate(v){
            if(!v) return null;
            const s = String(v).trim();
            let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
            if (m) {
              const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
              const dt = new Date(y, mo-1, d); return isNaN(dt) ? null : dt;
            }
            m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
            if (m) {
              const dt = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(dt) ? null : dt;
            }
            const dt = new Date(s);
            return isNaN(dt) ? null : dt;
          }

          let stt = 0;
          const html = rows.map(item=>{
            const code = getV(item,['code','ma','taskcode','m√£']);
            const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
            const status = getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i']);
            const man = getV(item,['manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n']);
            const rq = getV(item,['üìÜ ng√†y y√™u c·∫ßu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
            const wish = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
            const act = getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
            const done = getV(item,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh','completion','done_date','ng√†y ho√†n th√†nh']);
            const actualHours = getV(item,[ 'so gio danh gia thuc te','s·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te' ]);
            // Hi·ªÉn th·ªã ƒë·ªìng nh·∫•t
            const manNum = parseNumberFlexible(man);
            const actualNum = parseNumberFlexible(actualHours);
            const manDisp = Number.isFinite(manNum) ? formatNumberVi(manNum, 2, 2) : String(man||'');
            const actualHoursDisp = Number.isFinite(actualNum) ? formatNumberVi(actualNum, 2, 2) : String(actualHours||'');
            const wishDisp = formatDdMmYyyy(wish);
            const doneDisp = formatDdMmYyyy(done);
            let wishPlus1Disp = '';
            try{
              const dW = toDate(wish);
              if (dW){
                const plus1 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 1);
                wishPlus1Disp = formatDdMmYyyy(plus1);
              }
            }catch(_){ }
            // T√≠nh Tr·∫°ng th√°i theo c√¥ng chu·∫©n b·∫±ng so s√°nh s·ªë gi·ªù th·ª±c t·∫ø v√† c√¥ng chu·∫©n (h·ªó tr·ª£ d·∫•u ph·∫©y/d·∫•u ch·∫•m)
            let statusByMan = '';
            try{
              // Custom parse function to handle comma decimal separator
              const parseNumberFlexible = (value) => {
                if (!value) return NaN;
                const str = String(value).trim();
                // Replace comma with dot for decimal separator
                const normalized = str.replace(',', '.');
                const num = parseFloat(normalized);
                return isNaN(num) ? NaN : num;
              };
              
              const manNum = parseNumberFlexible(man);
              const actualNum = parseNumberFlexible(actualHours);
              const EPS = 1e-4;
              const hasDone = !!toDate(done);
              if (Number.isFinite(actualNum) && Math.abs(actualNum) < EPS) {
                statusByMan = 'Thi·∫øu d·ªØ li·ªáu';
              } else if (hasDone && !isNaN(actualNum) && !isNaN(manNum)){
                // Cho ph√©p sai l·ªách 10% cho "ƒê√∫ng ti·∫øn ƒë·ªô"
                const tolerance = manNum * 0.1; // 10% tolerance
                const diff = Math.abs(actualNum - manNum);
                
                if (actualNum > manNum + tolerance) {
                  statusByMan = 'Ch·∫≠m ti·∫øn ƒë·ªô';
                } else if (diff <= tolerance) {
                  statusByMan = 'ƒê√∫ng ti·∫øn ƒë·ªô';
                } else {
                  statusByMan = 'V∆∞·ª£t ti·∫øn ƒë·ªô';
                }
              }
            }catch(_){ }
            let statusVsWish = '';
            try{
              const dDone = toDate(done);
              const dWish = toDate(wish);
              if (dWish && dDone){
                const wishPlus1 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate() + 1);
                statusVsWish = (dDone.getTime() <= wishPlus1.getTime()) ? 'ƒê√∫ng h·∫°n y√™u c·∫ßu' : 'Tr·ªÖ h·∫°n y√™u c·∫ßu';
              }
            }catch(_){ }

            // Late completed highlight (yellow)
            const dueForCompare = act || wish || '';
            const isLate = (()=>{ const d1 = toDate(done), d2 = toDate(dueForCompare); return d1 && d2 ? (d1.getTime() > d2.getTime()) : false; })();
            let trClass = isLate ? 'bg-yellow-100' : '';
            // Overdue doing highlight + today highlight (match Form 1)
            const sLower = (status||'').toLowerCase();
            // "Chuy·ªÉn SPM c·∫≠p nh·∫≠t" kh√¥ng c√≤n trong isDoing v√¨ ƒë√£ chuy·ªÉn sang logic Done
            const isDoing = sLower.includes('doing') || sLower.includes('ƒëang') || sLower.includes('chuy·ªÉn nh√≥m spm') || sLower.includes('chuyen nhom spm');
            const dueDate = parseDateFlexible(dueForCompare);
            if (isDoing && dueDate){
              const today = new Date();
              const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
              const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
              const isSameDay = dueDayStart.getTime() === todayStart.getTime();
              const isPast = dueDayStart.getTime() < todayStart.getTime();
              if (isSameDay) trClass = 'bg-yellow-100';
              else if (isPast) trClass = 'bg-red-100';
            }

            return `
              <tr class="${trClass}">
                <td class="px-3 py-2">${++stt}</td>
                <td class="px-3 py-2">${code}</td>
                <td class="px-3 py-2">${tname}</td>
                <td class="px-3 py-2${(function(n){ const EPS=1e-4; return (Number.isFinite(parseNumberFlexible(actualHours)) && Math.abs(parseNumberFlexible(actualHours))<EPS) ? ' bg-amber-100 text-amber-800' : ''; })()}">${actualHoursDisp}</td>
                <td class="px-3 py-2">${manDisp}</td>
                <td class="px-3 py-2">${(function(s){ const t=String(s||'').toLowerCase(); let cls='bg-blue-100 text-blue-800'; if(t.includes('thi·∫øu d·ªØ li·ªáu')) cls='bg-amber-100 text-amber-800'; else if(t.includes('v∆∞·ª£t ti·∫øn ƒë·ªô')) cls='bg-blue-100 text-blue-800'; else if(t.includes('ƒë√∫ng ti·∫øn ƒë·ªô')||t.includes('dung tien do')) cls='bg-green-100 text-green-800'; else if(t.includes('ch·∫≠m ti·∫øn ƒë·ªô')||t.includes('cham tien do')) cls='bg-red-100 text-red-800'; else if(t.includes('ch·ªù ph√™ duy·ªát')||t.includes('cho phe duyet')) cls='bg-orange-100 text-orange-800'; else if(t.includes('cancel')||t.includes('h·ªßy')||t.includes('hu·ª∑')) cls='bg-gray-200 text-gray-700'; else if(t.includes('doing')||t.includes('ƒëang')) cls='bg-blue-100 text-blue-800'; return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`; })(statusByMan && statusByMan.trim() ? statusByMan : status)}</td>
                <td class="px-3 py-2">${wishDisp||wish||''}${wishPlus1Disp? `<div class=\"text-xs text-gray-500 mt-0.5\">H·∫°n +1: ${wishPlus1Disp}</div>`:''}</td>
                <td class="px-3 py-2">${doneDisp||done||''}</td>
              </tr>
            `;
          }).join('');
          detailBody.innerHTML = html;
        }catch(err){
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="8">L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
        }
      }

      // Copy on click and open link for storage (Form 1)
      const f1StorageLink = document.getElementById('f1-storage-link');
      if (f1StorageLink) {
        f1StorageLink.addEventListener('click', async ()=>{
          const url = f1StorageLink.getAttribute('href') || '';
          try { await navigator.clipboard.writeText(url); showToast('ƒê√£ copy li√™n k·∫øt.','success'); }
          catch(_) { /* ignore copy error to not block open */ }
        });
      }
      // Trigger fetch only when nh·∫•n Tra c·ª©u ·ªü Form 6
      const f6Btn = document.getElementById('f6-search');
      if (f6Btn) {
        f6Btn.addEventListener('click', async (e)=>{
          e.preventDefault();
          console.log('[DEBUG] Button clicked:', e.target);
          console.log('[DEBUG] Current form visible:', document.querySelector('section:not(.hidden)')?.id);
          if (f6Btn.disabled) return;
          const prev = f6Btn.textContent;
          f6Btn.disabled = true;
          f6Btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
          try { 
            console.log('[DEBUG] Form 6 Tra c·ª©u button clicked, calling renderForm6List()');
            await renderForm6List(); 
            console.log('[DEBUG] renderForm6List() completed');
          }
          finally {
            f6Btn.disabled = false;
            f6Btn.textContent = prev || 'Tra c·ª©u';
            try{ updateLastUpdatedNote('f6-search','f6.lastUpdated'); }catch(_){ }
          }
        });
      }
      // Default month and change handler for Form 6 filtering
      (function initF6MonthFilter(){
        const m = document.getElementById('f6-month');
        if (!m) return;
        const d = new Date();
        const yy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        try{
          const last = LS.get('f6.selectedMonth');
          if (!m.value) m.value = (last && /\d{4}-\d{2}/.test(last)) ? last : `${yy}-${mm}`;
        }catch(_){ if (!m.value) m.value = `${yy}-${mm}`; }
        // on change, re-apply local filter if data already loaded and persist selection
        if (!m._bound){
          m.addEventListener('change', ()=>{
            try{ LS.set('f6.selectedMonth', m.value||''); }catch(_){ }
            try{
              if (Array.isArray(F6_LAST_ROWS) && F6_LAST_ROWS.length) {
                if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
                else renderForm6List();
              }
            }catch(_){ }
          });
          m._bound = true;
        }
      })();
      // Trigger fetch for Form 5 - P1, P2 (shared data source)
      const f5aBtnP1 = document.getElementById('f5a-search-p1');
      const f5aBtnP2 = document.getElementById('f5a-search-p2');
      
      if (f5aBtnP1) { 
        f5aBtnP1.addEventListener('click', async (e)=>{ 
          e.preventDefault(); 
          if(f5aBtnP1.disabled) return;
          f5aBtnP1.disabled = true;
          const prevText = f5aBtnP1.textContent;
          f5aBtnP1.innerHTML = "<span class='spinner mr-1'></span>ƒêang t·∫£i...";
          try{ 
            await renderForm5All(); 
            console.log('[F5A P1] Data loaded successfully.');
          }catch(err){ 
            console.error('[F5A P1] Search error:', err); 
            showToast('L·ªói t·∫£i d·ªØ li·ªáu P1', 'error');
          }finally{
            f5aBtnP1.disabled = false;
            f5aBtnP1.textContent = prevText;
          }
        }); 
      }
      
      if (f5aBtnP2) { 
        f5aBtnP2.addEventListener('click', async (e)=>{ 
          e.preventDefault(); 
          if(f5aBtnP2.disabled) return;
          f5aBtnP2.disabled = true;
          const prevText = f5aBtnP2.textContent;
          f5aBtnP2.innerHTML = "<span class='spinner mr-1'></span>ƒêang t·∫£i...";
          try{ 
            // G·ªçi h√†m render ri√™ng cho P2 t·ª´ webhook m·ªõi
            await renderForm5P2();
            console.log('[F5A P2] Data loaded successfully.');
          }catch(err){ 
            console.error('[F5A P2] Search error:', err); 
            showToast('L·ªói t·∫£i d·ªØ li·ªáu P2', 'error');
          }finally{
            f5aBtnP2.disabled = false;
            f5aBtnP2.textContent = prevText;
          }
        }); 
      }
      
      // Trigger fetch for Form 5 - P3 (separate data source)
      const f5aBtnP3 = document.getElementById('f5a-search-p3');
      if (f5aBtnP3) { 
        f5aBtnP3.addEventListener('click', async (e)=>{ 
          e.preventDefault(); 
          if(f5aBtnP3.disabled) return;
          f5aBtnP3.disabled = true;
          const prevText = f5aBtnP3.textContent;
          f5aBtnP3.innerHTML = "<span class='spinner mr-1'></span>ƒêang t·∫£i...";
          try{ 
            const monthInput = document.getElementById('f5a-month');
            const month = monthInput ? monthInput.value : '';
            await f5aFetchP3Data(month);
            renderForm5P3();
            console.log('[F5A P3] Data loaded successfully.');
          }catch(err){ 
            console.error('[F5A P3] Search error:', err); 
            showToast('L·ªói t·∫£i d·ªØ li·ªáu P3', 'error');
          }finally{
            f5aBtnP3.disabled = false;
            f5aBtnP3.textContent = prevText;
          }
        }); 
      }
      
      // Trigger fetch for Form 5 - P4 (uses P3 data source)
      const f5aBtnP4 = document.getElementById('f5a-search-p4');
      if (f5aBtnP4) { 
        f5aBtnP4.addEventListener('click', async (e)=>{ 
          e.preventDefault(); 
          if(f5aBtnP4.disabled) return;
          f5aBtnP4.disabled = true;
          const prevText = f5aBtnP4.textContent;
          f5aBtnP4.innerHTML = "<span class='spinner mr-1'></span>ƒêang t·∫£i...";
          try{ 
            const monthInput = document.getElementById('f5a-month');
            const month = monthInput ? monthInput.value : '';
            
            // P4 fetches from its own endpoint
            await f5aFetchP4Data(month);
            
            // Then render P4 using P4 data
            renderForm5P4();
            showToast('D·ªØ li·ªáu P4 ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
          }catch(err){ 
            console.error('[F5A P4] Search error:', err); 
            showToast('L·ªói t·∫£i d·ªØ li·ªáu P4', 'error');
          }finally{
            f5aBtnP4.disabled = false;
            f5aBtnP4.textContent = prevText;
          }
        }); 
      }

      // ===== Form 5: T·ªëi ∆∞u b·ªô l·ªçc th√°ng =====
      // Kh·ªüi t·∫°o gi√° tr·ªã th√°ng m·∫∑c ƒë·ªãnh (th√°ng hi·ªán t·∫°i)
      (function initForm5MonthFilter() {
        const monthInput = document.getElementById('f5a-month');
        if (monthInput && !monthInput.value) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          monthInput.value = `${year}-${month}`;
        }
      })();

      // H√†m ƒëi·ªÅu h∆∞·ªõng th√°ng
      function navigateForm5Month(direction) {
        const monthInput = document.getElementById('f5a-month');
        if (!monthInput || !monthInput.value) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          monthInput.value = `${year}-${month}`;
          return;
        }

        const [year, month] = monthInput.value.split('-').map(Number);
        const date = new Date(year, month - 1, 1);
        
        if (direction === 'prev') {
          date.setMonth(date.getMonth() - 1);
        } else if (direction === 'next') {
          date.setMonth(date.getMonth() + 1);
        } else if (direction === 'current') {
          const now = new Date();
          date.setFullYear(now.getFullYear());
          date.setMonth(now.getMonth());
        }

        const newYear = date.getFullYear();
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        monthInput.value = `${newYear}-${newMonth}`;
        
        // Trigger change event ƒë·ªÉ c√°c listener kh√°c c√≥ th·ªÉ ph·∫£n ·ª©ng
        monthInput.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Event listeners cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng th√°ng
      const f5aMonthPrev = document.getElementById('f5a-month-prev');
      const f5aMonthNext = document.getElementById('f5a-month-next');
      const f5aMonthCurrent = document.getElementById('f5a-month-current');

      if (f5aMonthPrev) {
        f5aMonthPrev.addEventListener('click', (e) => {
          e.preventDefault();
          navigateForm5Month('prev');
        });
      }

      if (f5aMonthNext) {
        f5aMonthNext.addEventListener('click', (e) => {
          e.preventDefault();
          navigateForm5Month('next');
        });
      }

      if (f5aMonthCurrent) {
        f5aMonthCurrent.addEventListener('click', (e) => {
          e.preventDefault();
          navigateForm5Month('current');
        });
      }

      // ƒê√É B·ªé: T·ª± ƒë·ªông fetch t·∫•t c·∫£ d·ªØ li·ªáu Form 5 khi trang load
      // Gi·ªù ch·ªâ fetch khi nh·∫•n n√∫t "Tra c·ª©u" t∆∞∆°ng ·ª©ng
      // async function autoFetchForm5Data(){ ... }

      // ===== Form 5 P2: Adjust with Form 10 attendance =====
      function f5aGetAttendanceMapByMonth(month){
        try{
          const map = new Map();
          let rows = Array.isArray(window.F10_ATT_ROWS) ? window.F10_ATT_ROWS : [];
          // Restore from localStorage cache if empty
          if ((!rows || !rows.length) && typeof LS !== 'undefined'){
            try{
              const cached = LS.getJSON('f10.att');
              if (cached && Array.isArray(cached.rows)){
                rows = cached.rows.slice();
                window.F10_ATT_ROWS = rows;
                window.F10_ATT_META = { month: cached.month || '' };
              }
            }catch(_){ }
          }
          rows.forEach(r=>{
            const emp = (typeof f10GetV==='function') ? f10GetV(r, ['nh√¢n s·ª±','nhan su','employee','name']) : (r['Nh√¢n s·ª±']||r['employee']||r['name']||'');
            const m = (typeof f10GetV==='function') ? f10GetV(r, ['th√°ng','thang','month']) : (r['Th√°ng']||r['month']||'');
            const total = (typeof f10GetV==='function') ? f10GetV(r, ['t·ªïng gi·ªù c√¥ng ƒëi l√†m','tong gio cong di lam','total','totalworkhours']) : (r['T·ªïng gi·ªù c√¥ng ƒëi l√†m']||r['total']||r['totalWorkHours']||'');
            const matches = (typeof f10MonthMatches==='function') ? f10MonthMatches(m, month) : true;
            if (!emp || !matches) return;
            const raw = String(emp).trim();
            map.set(raw, total);
            try{
              const nk = (typeof vnKey==='function') ? vnKey(raw) : raw.toLowerCase().trim();
              map.set(`__norm__:${nk}`, total);
            }catch(_){ }
          });
          return map;
        }catch(_){ return new Map(); }
      }

      async function adjustForm5P2WithAttendance(){
        try{
          const tbody = document.getElementById('f5a-body-p2');
          if (!tbody) return;
          const monthEl = document.getElementById('f5a-month');
          const month = monthEl ? (monthEl.value||'') : '';
          // Ensure attendance loaded for this month
          const needFetch = !(window.F10_ATT_META && window.F10_ATT_META.month === (month||''));
          if (needFetch && typeof f10FetchAttendance === 'function'){
            try{ await f10FetchAttendance(month); }catch(_){ }
          }
          const attMap = f5aGetAttendanceMapByMonth(month);
          // Iterate rows and rewrite 4th and 5th columns
          const rows = Array.from(tbody.querySelectorAll('tr'));
          rows.forEach(tr=>{
            const tds = tr.querySelectorAll('td');
            if (!tds || tds.length < 5) return;
            let name = (tds[0].textContent||'').trim();
            // Clean decorations: take first segment before '(' or line-break or ' - '
            try{ name = name.split('\n')[0]; }catch(_){ }
            try{ name = name.split('(')[0]; }catch(_){ }
            try{ name = name.split(' - ')[0]; }catch(_){ }
            name = name.trim();
            if (!name) return;
            // Current manhour received (col 3)
            const manText = (tds[2].textContent||'').trim();
            // Try exact, then alias, then case-insensitive match
            let totalText = attMap.get(name) || '';
            if (!totalText && typeof resolveAlias==='function'){
              const alias = resolveAlias(name);
              totalText = attMap.get(alias) || '';
            }
            if (!totalText){
              const key = (typeof vnKey==='function') ? vnKey(name) : String(name).toLowerCase().trim();
              // Direct normalized key hit
              totalText = attMap.get(`__norm__:${key}`) || '';
              if (!totalText){
                for (const k of attMap.keys()){
                  if (String(k).startsWith('__norm__:')){
                    if (k === `__norm__:${key}`){ totalText = attMap.get(k); break; }
                  } else {
                    const kk = (typeof vnKey==='function') ? vnKey(k) : String(k).toLowerCase().trim();
                    if (kk === key){ totalText = attMap.get(k); break; }
                  }
                }
              }
            }
            // Update col 4: n·∫øu kh√¥ng kh·ªõp th√¨ ƒë·ªÉ r·ªóng, kh√¥ng ghi 0
            tds[3].textContent = totalText ? String(totalText) : '';
            // N·∫øu v·∫´n r·ªóng, th·ª≠ hi·ªÉn th·ªã debug ·∫©n (console) 1 l·∫ßn ƒë·∫ßu
            if (!totalText){
              try{ console.debug('[P2] No attendance match for:', name, 'month:', month, 'map keys:', Array.from(attMap.keys())); }catch(_){ }
            }
            // Compute H·ªá s·ªë = manReceived / totalWorkHours
            function toNum(v){ try{ return (typeof parseNumberFlexible==='function') ? parseNumberFlexible(v) : Number(String(v).replace(/[^0-9.,-]/g,'').replace('.', '').replace(',', '.')); }catch(_){ return NaN; } }
            const man = toNum(manText);
            const denom = toNum(totalText);
            const coef = (Number.isFinite(man) && Number.isFinite(denom) && Math.abs(denom) > 1e-9) ? (man/denom) : NaN;
            tds[4].textContent = Number.isFinite(coef) ? coef.toFixed(2) : '';
          });
        }catch(_){ }
      }
      
      // Auto render once when Form 5 first shows - DISABLED to prevent interference with Form 6
      try {
        // setTimeout(()=>{ try{ renderForm5All(); }catch(_){ } }, 300); // Disabled
        // Rebind khi user thay ƒë·ªïi ch·∫ø ƒë·ªô bi·ªÉu ƒë·ªì ƒë·ªÉ tr√°nh m·∫•t handler sau khi chuy·ªÉn form
        const modeSel = document.getElementById('f5a-mode');
        if (modeSel && !modeSel._bound){
          modeSel.addEventListener('change', ()=>{ try{ renderForm5All(); }catch(_){ } });
          modeSel._bound = true;
        }
        const refreshBtn = document.getElementById('f5a-refresh');
        if (refreshBtn && !refreshBtn._bound){
          refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ renderForm5All(); }catch(_){ } });
          refreshBtn._bound = true;
        }
      } catch(_) {}

      // ===== Form 6: submit and list ideas =====
      async function renderForm6List(){
        console.log('[DEBUG] renderForm6List() started');
        const body = document.getElementById('f6-body');
        const aggBody = document.getElementById('f6-agg-body');
        const aggNote = document.getElementById('f6-agg-note');
        console.log('[DEBUG] Elements found:', { body: !!body, aggBody: !!aggBody, aggNote: !!aggNote });
        if (!body) return;
        body.innerHTML = "<tr><td colspan='7' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        const headerMapF6 = {
          header_submitDate: 'Ng√†y n·ªôp',
          header_employee: 'Nh√¢n vi√™n',
          header_title: 'Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng',
          header_problem: 'V·∫•n ƒë·ªÅ nh·∫≠n di·ªán',
          header_solution: 'Gi·∫£i ph√°p',
          header_managerOpinion: '√ù ki·∫øn tr∆∞·ªüng ph√≤ng',
          header_status: 'Tr·∫°ng th√°i',
          field_submitDate: 'submitDate',
          field_employee: 'employee',
          field_title: 'title',
          field_problem: 'problem',
          field_solution: 'solution',
          field_managerOpinion: 'managerOpinion',
          field_status: 'status'
        };
        const params = new URLSearchParams({ ...headerMapF6, action: 'form6_list', _ts: Date.now().toString() });
        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const t = await r.text();
          let parsed=null; try{ parsed=JSON.parse(t);}catch{}
          return { ok:r.ok, parsed, raw:t, status:r.status };
        }
        console.log('[DEBUG] Form 6 calling URL:', `${FORM6_LIST_URL}?${params.toString()}`);
        console.log('[DEBUG] FORM6_LIST_URL value:', FORM6_LIST_URL);
        let first = await fetchJson(`${FORM6_LIST_URL}?${params.toString()}`);
        console.log('[DEBUG] First response:', { ok: first.ok, status: first.status, parsed: first.parsed, raw: first.raw });
        if (!first.ok || (first.parsed && first.parsed.code===0 && /could not be started/i.test(String(first.parsed.message||'')))){
          console.log('[DEBUG] Retrying with webhook URL...');
          first = await fetchJson(`${FORM6_LIST_URL.replace('/webhook-test/','/webhook/')}?${params.toString()}`);
          console.log('[DEBUG] Second response:', { ok: first.ok, status: first.status, parsed: first.parsed, raw: first.raw });
        }
        if (!first.ok){
          console.log('[DEBUG] Fetch failed:', first);
          body.innerHTML = `<tr><td colspan='7' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i: ${String(first.raw||first.status)}</td></tr>`;
          return;
        }
        const rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
        console.log('[DEBUG] Parsed rows:', rows.length, 'items:', rows);
        if (!rows.length){
          console.log('[DEBUG] No rows found, showing empty state');
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          F5_LAST_COUNT = 0;
          F6_LAST_ROWS = [];
          if (aggBody) aggBody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          if (aggNote) aggNote.textContent = '';
          return;
        }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{});
          for (const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // Normalize to cache for client-side month filtering
        F6_LAST_ROWS = rows.map((item)=>{
          const submitDate = getV(item,['submitdate','date','submit_date','ngaynop','ngay_nop','ng√†y n·ªôp']);
          const employee = getV(item,['employee','nhanvien','nhan_vien','nh√¢n vi√™n']);
          const title = getV(item,['title','tieude','tieu_de','ti√™u ƒë·ªÅ √Ω t∆∞·ªüng','n·ªôi dung ƒë·ªÅ xu·∫•t']);
          const problem = getV(item,['problem','van_de','vande','v·∫•n ƒë·ªÅ nh·∫≠n di·ªán']);
          const solution = getV(item,['solution','giai_phap','giaiphap','gi·∫£i ph√°p']);
          const managerOpinion = getV(item,[
            'manageropinion','manager_opinion','y_kien_truong_phong','√Ω ki·∫øn tr∆∞·ªüng ph√≤ng','ykien_truong_phong','ykien_tp',
            'ykien','y_kien','ykien_duyet','ykien_phe_duyet','tp dqa nh·∫≠n x√©t','tp_dqa_nhan_xet','nh·∫≠n x√©t','nhan xet'
          ]);
          // Tr·∫°ng th√°i: qu√©t th√™m c√°c bi·∫øn th·ªÉ th∆∞·ªùng g·∫∑p
          const statusRaw = getV(item,[
            'status','trangthai','trang_thai','tr·∫°ng th√°i','phe_duyet','ph√™ duy·ªát','approval','approve','approved',
            'duyet','ƒë√£ duy·ªát','ket_qua','k·∫øt qu·∫£','result','tinh_trang','t√¨nh tr·∫°ng','state','trang thai'
          ]) || managerOpinion || getV(item,['Tr·∫°ng th√°i']);
          return { submitDate, employee, title, problem, solution, managerOpinion, status: statusRaw };
        });
        // Local filter + render
        window.applyForm6LocalFilter = function(){
          console.log('[DEBUG] applyForm6LocalFilter called');
          try{
            const monthEl = document.getElementById('f6-month');
            const monthVal = monthEl ? (monthEl.value || '').trim() : '';
            let list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
            console.log('[DEBUG] Month filter:', monthVal, 'Total rows:', list.length);
            console.log('[DEBUG] F6_LAST_ROWS type:', typeof F6_LAST_ROWS, 'isArray:', Array.isArray(F6_LAST_ROWS));
            if (monthVal) {
              console.log('[DEBUG] Applying month filter...');
              list = list.filter(r => {
                const formatted = formatYyyyMm(r.submitDate);
                console.log('[DEBUG] Row date:', r.submitDate, '-> formatted:', formatted, 'matches?', formatted === monthVal);
                return formatted === monthVal;
              });
            }
            console.log('[DEBUG] After month filter:', list.length);
            if (!list.length){
              console.log('[DEBUG] No data after filtering, showing empty state');
              body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
              if (aggBody) aggBody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
              if (aggNote) aggNote.textContent = '';
              return;
            }
            const html2 = list.map(r=>`
              <tr class="${(function(st,op){ try{ const raw1=String(st||''); const raw2=String(op||''); const s1=raw1.toLowerCase(); const s2=raw2.toLowerCase(); if(s1.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát')||s2.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát')) return 'bg-yellow-100'; const n1=(typeof vnLower==='function'? vnLower(raw1): raw1.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); const n2=(typeof vnLower==='function'? vnLower(raw2): raw2.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); if(n1.includes('khong duoc duyet')||n2.includes('khong duoc duyet')) return 'bg-yellow-100'; return ''; }catch(_){ return ''; }})(r.status, r.managerOpinion)}">
                <td class="px-3 py-2">${r.submitDate}</td>
                <td class="px-3 py-2">${r.employee}</td>
                <td class="px-3 py-2">${r.title}</td>
                <td class="px-3 py-2">${r.problem}</td>
                <td class="px-3 py-2">${r.solution}</td>
                <td class="px-3 py-2">${(function(s){
                  try{
                    const t = ((typeof vnLower==='function') ? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()).replace(/\s+/g,' ').trim();
                    const approved = (
                      t.includes('duoc duyet') || t.includes('da duyet') || t.includes('duoc phe duyet') || t.includes('da phe duyet') ||
                      t.includes('phe duyet') || t.includes('phe chuan') || t.includes('thong qua') || t.includes('chap thuan') ||
                      t.includes('approved') || t.includes('approve') || (t.includes('dong y') && (t.includes('duyet') || t.includes('phe duyet')))
                    );
                    const denied = (
                      (t.includes('khong') && (t.includes('duyet') || t.includes('phe duyet'))) || t.includes('ko duyet') || t.includes('k duyet') ||
                      t.includes('chua duyet') || t.includes('tu choi') || t.includes('reject') || t.includes('rejected')
                    );
                    let cls = '';
                    if (approved) cls = 'bg-green-100 text-green-800';
                    else if (denied) cls = 'bg-red-100 text-red-800';
                    return cls ? `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>` : (s||'');
                  }catch(_){ return String(s||''); }
                })(r.managerOpinion||'')}</td>
                <td class="px-3 py-2">${(function(s){
                  try{
                    const raw = String(s||'');
                    const sLower = raw.toLowerCase().trim();
                    const t = ((typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()).replace(/\s+/g,' ').trim();
                    const approved = (
                      t.includes('duoc duyet') || t.includes('da duyet') || t.includes('duoc phe duyet') || t.includes('da phe duyet') ||
                      t.includes('phe duyet') || t.includes('phe chuan') || t.includes('thong qua') || t.includes('chap thuan') ||
                      t.includes('approved') || t.includes('approve') || (t.includes('dong y') && (t.includes('duyet') || t.includes('phe duyet'))) ||
                      sLower.includes('ƒë∆∞·ª£c duy·ªát') || sLower.includes('ƒë√£ duy·ªát') || sLower.includes('ƒë∆∞·ª£c ph√™ duy·ªát') || sLower.includes('ƒë√£ ph√™ duy·ªát') ||
                      sLower.includes('ph√™ duy·ªát') || sLower.includes('ph√™ chu·∫©n') || sLower.includes('th√¥ng qua') || sLower.includes('ch·∫•p thu·∫≠n') ||
                      (sLower.includes('ƒë·ªìng √Ω') && (sLower.includes('duy·ªát') || sLower.includes('ph√™ duy·ªát')))
                    );
                    const denied = (
                      (t.includes('khong') && (t.includes('duyet') || t.includes('phe duyet'))) || t.includes('ko duyet') || t.includes('k duyet') ||
                      t.includes('chua duyet') || t.includes('tu choi') || t.includes('reject') || t.includes('rejected') ||
                      ((sLower.includes('kh√¥ng') && (sLower.includes('duy·ªát') || sLower.includes('ph√™ duy·ªát'))) || sLower.includes('t·ª´ ch·ªëi'))
                    );
                    const deniedStrict = sLower.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát') || t.includes('khong duoc duyet');
                    // Ch·ªâ b√¥i xanh ch·ªØ khi tr·∫°ng th√°i ƒë√£ duy·ªát
                    if (approved) return `<span class=\"text-green-700 font-semibold\">${s||''}</span>`;
                    if (deniedStrict) return `<span class=\"text-red-700 font-semibold\">${s||''}</span>`;
                    let cls = 'bg-gray-100 text-gray-800';
                    if (denied) cls = 'bg-red-100 text-red-800';
                    return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`;
                  }catch(_){ return String(s||''); }
                })(r.status||'')}</td>
              </tr>
            `).join('');
            console.log('[DEBUG] Generated HTML length:', html2.length);
            console.log('[DEBUG] First 500 chars of HTML:', html2.substring(0, 500));
            body.innerHTML = html2;
            console.log('[DEBUG] HTML set to body, body children count:', body.children.length);
            try{ enableTableDrag('f6-body'); }catch(_){ }

            // Aggregate by employee and render f6-agg-body (k√®m s·ªë √Ω t∆∞·ªüng ƒë∆∞·ª£c duy·ªát)
            try{
              const totalCounts = new Map();
              const rejectedCounts = new Map();
              const toNorm = (s)=>{
                try{ return (typeof vnLower==='function') ? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); }
              };
              list.forEach(r=>{
                const name = String(r.employee||'').trim() || '(Ch∆∞a r√µ)';
                totalCounts.set(name, (totalCounts.get(name)||0) + 1);
                // X√ÅC ƒê·ªäNH B·ªä T·ª™ CH·ªêI: h√†ng b·ªã b√¥i v√†ng ("Kh√¥ng ƒë∆∞·ª£c duy·ªát")
                const rawSt = String(r.status||'');
                const rawOp = String(r.managerOpinion||'');
                const sLower = rawSt.toLowerCase();
                const oLower = rawOp.toLowerCase();
                const stNz = toNorm(rawSt);
                const opNz = toNorm(rawOp);
                const isRejected = (
                  sLower.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát') || oLower.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát') ||
                  stNz.includes('khong duoc duyet') || opNz.includes('khong duoc duyet')
                );
                if (isRejected) rejectedCounts.set(name, (rejectedCounts.get(name)||0) + 1);
              });
              const items = Array.from(totalCounts.entries()).map(([name, cnt])=>{
                const rej = rejectedCounts.get(name)||0;
                const approved = Math.max(0, cnt - rej);
                return { name, cnt, approved };
              })
                .sort((a,b)=> b.cnt - a.cnt || a.name.localeCompare(b.name,'vi'));
              const rowsHtml = items.map(it=>`
                <tr${it.cnt < 5 ? ' class="bg-yellow-100"' : ''}>
                  <td class="px-3 py-2">${it.name}</td>
                  <td class="px-3 py-2">${it.cnt}</td>
                  <td class="px-3 py-2">${it.approved}</td>
                  <td class="px-3 py-2"><button class="px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105" data-f6-view="${it.name.replace(/"/g,'&quot;')}">Xem</button></td>
                </tr>
              `).join('');
              if (aggBody) aggBody.innerHTML = rowsHtml || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
              if (aggNote) {
                const monthTxt = monthVal ? `th√°ng ${monthVal}` : 't·∫•t c·∫£ th·ªùi gian';
                aggNote.textContent = `ƒê·∫øm theo ${monthTxt}`;
              }
            }catch(_){ }
          }catch(err){ 
            console.error('[DEBUG] Error in applyForm6LocalFilter:', err);
          }
        };
        // initial render
        try{ applyForm6LocalFilter(); }catch(_){ }
        F5_LAST_COUNT = F6_LAST_ROWS.length;
        try{ LS.setJSON('f6.cache', { rows: F6_LAST_ROWS, ts: Date.now() }); LS.set('f6.lastUpdated', String(Date.now())); }catch(_){ }
      }

      // Form 6: Modal helpers
      (function initF6IdeasModal(){
        const modal = document.getElementById('f6-ideas-modal');
        const closeBtn = document.getElementById('f6-ideas-close');
        if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } });
        if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
      })();

      function openF6IdeasModal(empName, ideas){
        try{
          const modal = document.getElementById('f6-ideas-modal');
          const nameEl = document.getElementById('f6-ideas-name');
          const body = document.getElementById('f6-ideas-body');
          if (!modal || !nameEl || !body) return;
          nameEl.textContent = empName || '';
          if (!Array.isArray(ideas) || !ideas.length){
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          } else {
          const rows = ideas.map(r=>`
            <tr class="${(function(st,op){ try{ const raw1=String(st||''); const raw2=String(op||''); const s1=raw1.toLowerCase(); const s2=raw2.toLowerCase(); if(s1.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát')||s2.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát')) return 'bg-yellow-100'; const n1=(typeof vnLower==='function'? vnLower(raw1): raw1.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); const n2=(typeof vnLower==='function'? vnLower(raw2): raw2.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); if(n1.includes('khong duoc duyet')||n2.includes('khong duoc duyet')) return 'bg-yellow-100'; return ''; }catch(_){ return ''; }})(r.status, r.managerOpinion)}">
                <td class="px-3 py-2">${r.submitDate||''}</td>
                <td class="px-3 py-2">${r.title||''}</td>
                <td class="px-3 py-2">${r.problem||''}</td>
                <td class="px-3 py-2">${r.solution||''}</td>
                <td class="px-3 py-2">${r.managerOpinion||''}</td>
                <td class="px-3 py-2">${(function(s){
                  try{
                    const raw = String(s||'');
                    const sLower = raw.toLowerCase();
                    const t = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                    // Ch·ªâ b√¥i xanh ch·ªØ khi tr·∫°ng th√°i ƒë√£ duy·ªát
                    if (
                      t.includes('duoc duyet') || t.includes('da duyet') || t.includes('duoc phe duyet') || t.includes('da phe duyet') ||
                      t.includes('phe duyet') || t.includes('phe chuan') || t.includes('thong qua') || t.includes('chap thuan') ||
                      sLower.includes('ƒë∆∞·ª£c duy·ªát') || sLower.includes('ƒë√£ duy·ªát') || sLower.includes('ƒë∆∞·ª£c ph√™ duy·ªát') || sLower.includes('ƒë√£ ph√™ duy·ªát') ||
                      sLower.includes('ph√™ duy·ªát') || sLower.includes('ph√™ chu·∫©n') || sLower.includes('th√¥ng qua') || sLower.includes('ch·∫•p thu·∫≠n')
                    ) return `<span class=\"text-green-700 font-semibold\">${s||''}</span>`;
                    let cls = 'bg-gray-100 text-gray-800';
                    const deniedStrict = sLower.includes('kh√¥ng ƒë∆∞·ª£c duy·ªát') || t.includes('khong duoc duyet');
                    if (deniedStrict) return `<span class=\"text-red-700 font-semibold\">${s||''}</span>`;
                    if ((t.includes('khong') && (t.includes('duyet') || t.includes('phe duyet'))) || t.includes('tu choi') || (sLower.includes('kh√¥ng') && (sLower.includes('duy·ªát') || sLower.includes('ph√™ duy·ªát'))) || sLower.includes('t·ª´ ch·ªëi')) cls = 'bg-red-100 text-red-800';
                    return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`;
                  }catch(_){ return String(s||''); }
                })(r.status||'')}</td>
              </tr>
            `).join('');
            body.innerHTML = rows;
          }
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
        }catch(_){ }
      }
      function restoreForm6FromCache(){
        try{
          const cached = LS.getJSON('f6.cache');
          if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
          const body = document.getElementById('f6-body');
          if (!body) return false;
          F6_LAST_ROWS = cached.rows.slice();
          try{ const m = document.getElementById('f6-month'); if (m && cached.ts) { updateLastUpdatedNote('f6-search','f6.lastUpdated'); } }catch(_){ }
          if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
          return true;
        }catch(_){ return false; }
      }

      // ===== Form 6: Export XLSX =====
      function f6GetListForCurrentMonth(){
        try{
          let list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
          const monthEl = document.getElementById('f6-month');
          const monthVal = monthEl ? (monthEl.value || '').trim() : '';
          if (monthVal) list = list.filter(r => formatYyyyMm(r.submitDate) === monthVal);
          return list;
        }catch(_){ return []; }
      }
      function f6RowsToAOA(list){
        try{
          const headers = ['Ng√†y n·ªôp','Nh√¢n vi√™n','Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng','V·∫•n ƒë·ªÅ nh·∫≠n di·ªán','Gi·∫£i ph√°p','√ù ki·∫øn tr∆∞·ªüng ph√≤ng','Tr·∫°ng th√°i'];
          const aoa = [headers];
          (Array.isArray(list)? list: []).forEach(r=>{
            aoa.push([
              r.submitDate||'', r.employee||'', r.title||'', r.problem||'', r.solution||'', r.managerOpinion||'', r.status||''
            ]);
          });
          return aoa;
        }catch(_){ return [['L·ªói x√¢y d·ª±ng d·ªØ li·ªáu']]; }
      }
      function f6AggToAOA(list){
        try{
          const toNorm = (s)=>{ try{ return (typeof vnLower==='function') ? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } };
          const totalCounts = new Map();
          const rejectedCounts = new Map();
          (Array.isArray(list)? list: []).forEach(r=>{
            const name = String(r.employee||'').trim() || '(Ch∆∞a r√µ)';
            totalCounts.set(name, (totalCounts.get(name)||0) + 1);
            const st = String(r.status||'');
            const op = String(r.managerOpinion||'');
            const isRejected = st.toLowerCase().includes('kh√¥ng ƒë∆∞·ª£c duy·ªát') || op.toLowerCase().includes('kh√¥ng ƒë∆∞·ª£c duy·ªát') || toNorm(st).includes('khong duoc duyet') || toNorm(op).includes('khong duoc duyet');
            if (isRejected) rejectedCounts.set(name, (rejectedCounts.get(name)||0) + 1);
          });
          const items = Array.from(totalCounts.entries()).map(([name, cnt])=>{ const rej = rejectedCounts.get(name)||0; return { name, cnt, approved: Math.max(0, cnt - rej) }; })
            .sort((a,b)=> b.cnt - a.cnt || a.name.localeCompare(b.name,'vi'));
          const headers = ['Nh√¢n vi√™n','T·ªïng s·ªë √Ω t∆∞·ªüng','S·ªë √Ω t∆∞·ªüng ƒë∆∞·ª£c duy·ªát'];
          const aoa = [headers];
          items.forEach(it=> aoa.push([ it.name, it.cnt, it.approved ]));
          return aoa;
        }catch(_){ return [['L·ªói x√¢y d·ª±ng th·ªëng k√™']]; }
      }
      function f6DownloadXLSX(){
        try{
          const list = f6GetListForCurrentMonth();
          if (!Array.isArray(list) || !list.length){ showToast('Form 6: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.','error'); return; }
          const wb = XLSX.utils.book_new();
          const wsList = XLSX.utils.aoa_to_sheet(f6RowsToAOA(list));
          XLSX.utils.book_append_sheet(wb, wsList, 'Danh s√°ch');
          const wsAgg = XLSX.utils.aoa_to_sheet(f6AggToAOA(list));
          XLSX.utils.book_append_sheet(wb, wsAgg, 'Th·ªëng k√™');
          const month = (document.getElementById('f6-month')?.value || '').replace(/\s+/g,'');
          XLSX.writeFile(wb, `Form6_Ideas_${month||'export'}.xlsx`);
        }catch(_){ showToast('Form 6: Xu·∫•t XLSX th·∫•t b·∫°i.','error'); }
      }
      (function initF6Export(){
        const btn = document.getElementById('f6-export-xlsx');
        if (!btn) return;
        btn.addEventListener('click', (e)=>{ e.preventDefault(); f6DownloadXLSX(); });
      })();

      (function setupForm6(){
        const openBtn = document.getElementById('f6-open-submit');
        const modal = document.getElementById('f5-modal');
        const sendBtn = document.getElementById('f5-btn-send');
        const cancelBtn = document.getElementById('f5-btn-cancel');
        const countBox = document.getElementById('f6-count');
        const aggBody = document.getElementById('f6-agg-body');

        function openF5Modal(){
          try { setF5DateDefault(); } catch(_){}
          // reset inputs
          try{ (document.getElementById('f5-title')||{}).value=''; }catch(_){ }
          try{ (document.getElementById('f5-problem')||{}).value=''; }catch(_){ }
          try{ (document.getElementById('f5-solution')||{}).value=''; }catch(_){ }
          if (modal){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
        }
        function closeF5Modal(){ if (modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }
        if (openBtn) openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openF5Modal(); });
        if (cancelBtn) cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeF5Modal(); });
        if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal) closeF5Modal(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')) closeF5Modal(); });

        async function submitF5(){
          const date = (document.getElementById('f5-date')?.value||'').trim();
          const emp = (document.getElementById('f5-employee')?.value||'').trim();
          const title = (document.getElementById('f5-title')?.value||'').trim();
          const prob = (document.getElementById('f5-problem')?.value||'').trim();
          const sol = (document.getElementById('f5-solution')?.value||'').trim();
          if (!date || !emp || !title || !prob || !sol){ showToast('Vui l√≤ng ƒëi·ªÅn ƒë·ªß t·∫•t c·∫£ tr∆∞·ªùng.','error'); return; }
          const prev = sendBtn ? sendBtn.textContent : '';
          if (sendBtn){ sendBtn.disabled = true; sendBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
          // Build payload (send both submitDate and date for compatibility)
          const toDMY = (v)=>{ try{ return formatDdMmYyyy(v); }catch(_){ return String(v||''); } };
          const p = new URLSearchParams({
            submitDate: date,
            date: date,
            submit_date: date,
            ngay_nop: date,
            ngayNop: date,
            ngayNopDMY: toDMY(date),
            employee: emp,
            title,
            problem: prob,
            solution: sol,
            _ts: Date.now().toString()
          });
          async function tryPost(url){
            try{
              const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
              const t = await r.text().catch(()=>"");
              return { ok: r.ok, raw: t };
            }catch(err){ return { ok:false, raw: String(err||'') }; }
          }
          async function tryPostNoCors(url){
            try{
              await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
              // opaque response cannot be inspected; treat as success if resolved
              return { ok: true, raw: '' };
            }catch(err){ return { ok:false, raw: String(err||'') }; }
          }
          async function tryGet(url){
            try{
              const r = await fetch(`${url}?${p.toString()}`, { method:'GET' });
              const t = await r.text();
              return { ok: r.ok, raw: t };
            }catch(err){ return { ok:false, raw: String(err||'') }; }
          }
          try{
            // 1) POST no-cors to test URL (avoid CORS false negatives)
            let r = await tryPostNoCors(FORM5_SUBMIT_URL);
            // 2) If above failed (network), try normal POST test URL
            if (!r.ok) r = await tryPost(FORM5_SUBMIT_URL);
            // 3) Fallback GET test URL
            if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL);
            // 4) Fallback POST prod URL
            if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryPost(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
            // 5) Fallback GET prod URL
            if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
            if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
            showToast('ƒê√£ g·ª≠i √Ω t∆∞·ªüng.','success');
            closeF5Modal();
            // L√†m m·ªõi b·∫£ng sau 3 gi√¢y ƒë·ªÉ backend k·ªãp ghi d·ªØ li·ªáu
            setTimeout(()=>{ try{ renderForm6List(); }catch(_){} }, 3000);
          }catch(err){
            showToast('G·ª≠i th·∫•t b·∫°i.','error');
          }finally{
            if (sendBtn){ sendBtn.disabled=false; sendBtn.textContent = prev || 'G·ª≠i √Ω t∆∞·ªüng'; }
          }
        }
        if (sendBtn) sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitF5(); });

        if (countBox){
          countBox.addEventListener('click', ()=>{
            countBox.innerHTML = `<span>üìä</span><span>S·ªë √Ω t∆∞·ªüng ƒë√£ n·ªôp: <b>${F5_LAST_COUNT}</b></span>`;
          });
        }

        // Delegate click on "Xem" buttons in aggregate table
        if (aggBody){
          aggBody.addEventListener('click', (e)=>{
            const btn = e.target && e.target.closest ? e.target.closest('[data-f6-view]') : null;
            if (!btn) return;
            const name = btn.getAttribute('data-f6-view') || '';
            try {
              const list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
              const monthEl = document.getElementById('f6-month');
              const monthVal = monthEl ? (monthEl.value || '').trim() : '';
              const filtered = list.filter(r=> (!monthVal || formatYyyyMm(r.submitDate) === monthVal) && String(r.employee||'').trim() === name);
              openF6IdeasModal(name, filtered);
            } catch(_) {}
          });
        }
      })();

      // Map t√™n -> email cho Form 3 (t·ª± ƒë·ªông ƒëi·ªÅn)
      const REQUESTER_EMAIL = (()=>{
        const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
        const raw = {
          "B√πi ƒê·∫∑ng Qu·ªëc Huy":"huy.bui@karofi.vn",
          "ƒê√†o Ho√†ng D∆∞∆°ng":"duong.dao@karofi.vn",
          "ƒê·ªó Quang Long":"long.do@karofi.vn",
          "Nguy·ªÖn VƒÉn Hi·∫øu":"hieu.nguyen2@karofi.vn",
          "Nguy·ªÖn H·ªØu Th·ªãnh":"thinh.nguyen2@karofi.vn",
          "Nguy·ªÖn VƒÉn Linh":"linh.nguyen@karofi.vn",
          "Ph·∫°m Th√†nh Trung Ki√™n":"kien.pham1@karofi.vn",
          "Th√°i Th·ªã Giang":"giang.thai@karofi.vn",
          "Tr·∫ßn Hi·∫øu Nghƒ©a":"nghia.tran1@karofi.vn",
          "V≈© Th·ªã H·∫±ng":"hang.vu@karofi.vn",
          "ƒê√†o Tu·∫•n K·ª≥":"ky.dao@karofi.vn",
          "L·∫°i Qu·ªëc L·ªôc":"loc.lai@karofi.vn",
          "L√™ Ng·ªçc √Ånh":"anh.le1@karofi.vn",
          "L√™ Th·ªã Thanh Nh√†n":"nhan.le@karofi.vn",
          "L√™ Th·ªã Th·∫£o":"thao.le@karofi.vn",
          "L√™ VƒÉn S∆°n":"son.le2@karofi.vn",
          "Nguy·ªÖn Th·ªã Hi·ªÅn":"hien.nguyen1@karofi.vn",
          "Ph·∫°m Th·ªã Minh":"minh.pham1@karofi.vn",
          "V≈© Duy Minh":"minh.vu@karofi.com",
          "V≈© Th·ªã Thanh Hi·ªÅn":"hien.vu2@karofi.vn",
          "ƒêo√†n Th·ªã Minh Th∆∞":"thu.doan@karofi.vn",
          "ƒê·∫∑ng VƒÉn H·∫£i":"haidv1@karofi.vn",
          "Nguy·ªÖn Quang Tr·ªçng":"trongnq@karofi.vn",
          "Ph·∫°m Quang Doanh":"doanh.pham@karofi.vn",
          "Nguy·ªÖn Th·ªã M·ª´ng":"mung.nguyen1@karofi.vn",
          "V≈© ƒêƒÉng L∆∞∆°ng":"luong.vu@karofi.vn",
          "Ho√†ng L√™ Anh":"anh.hoang2@karofi.com",
          "Phan VƒÉn C·ª≠":"cupv@karofi.vn",
          "Ph·∫°m VƒÉn Thu·∫≠n":"thuan.pham2@karofi.vn",
          "Chu VƒÉn Quang":"quangcv@karofi.vn",
          "Tr·∫ßn Kh·∫Øc L√¢m":"lamtk@karofi.vn",
          "ƒê·∫∑ng Th·∫ø Huy":"huydt@karofi.com",
          "Tr·∫ßn H·ªìng Nhung":"nhung.tran2@karofi.vn",
          "ƒê·ªó Th√†nh C√¥ng":"congdt@karofi.vn",
          "Nguy·ªÖn Kim C∆∞∆°ng":"cuong.nguyen6@karofi.com",
          "Nguy·ªÖn Chung Nam":"nam.nguyen5@karofi.vn",
          "Nguy·ªÖn Ng·ªçc Quang":"quang.nguyen1@karofi.vn",
          "Ho√†ng Th√πy Linh":"linh.hoang1@karofi.vn",
          "ƒêo√†n VƒÉn Minh":"minh.doan@karofi.vn",
          "Tr·∫ßn VƒÉn C∆∞·ªùng":"cuong.tran1@karofi.vn",
          "ƒê·ªó C√¥ng Nh·∫≠m":"nham.do@karofi.vn",
          "L√™ Minh H·∫£i":"hai.le3@karofi.vn",
          "ƒê·ªó Xu√¢n Th√°i":"thai.do1@karofi.vn",
          "Tr·ªãnh K·∫ø L·ª±c":"luc.trinh@karofi.vn",
          "ƒê·∫∑ng VƒÉn Thu·∫•n":"thuan.dang@karofi.vn",
          "L√™ Th·∫ø Anh":"anh.le@karofi.vn",
          "D∆∞∆°ng Qu·ªëc Hi·∫øu":"hieudq1@karofi.vn",
          "Ph√πng Ch√≠ Ti·∫øn":"tien.phung@karofi.vn",
          "Nguy·ªÖn Th·ªã H∆∞∆°ng Th√∫y":"thuy.nguyen@karofi.vn",
          "Nguy·ªÖn M·∫°nh H√πng":"hung.nguyen2@karofi.vn",
          "Nguy·ªÖn H·ªìng Hi·∫øu":"hieu.nguyen@karofi.vn",
          "ƒê√†m Huy H√πng":"hung.dam@karofi.vn",
          "Kh∆∞∆°ng ƒê·ª©c T√¨nh":"tinh.khuong@karofi.vn",
          "ƒê·∫∑ng Th·ªã Ch√≠n":"chindt@karofi.vn",
          "Ho√†ng VƒÉn Th√†nh":"thanhhv@karofi.vn",
          "Nguy·ªÖn Th·ªã Th·ªßy":"thuynt3@karofi.vn"
        };
        const map = {};
        Object.keys(raw).forEach(k => map[normalize(k)] = raw[k]);
        return { get: (name)=> map[normalize(name)] || '' };
      })();
      // Create Task Modal: T·ª± ƒë·ªông ƒëi·ªÅn email khi nh·∫≠p ng∆∞·ªùi y√™u c·∫ßu
      function syncCreateRequesterEmail(){
        const nameEl = document.getElementById('create-rq-by');
        const emailEl = document.getElementById('create-rq-by-email');
        if (!nameEl || !emailEl) return;
        emailEl.value = REQUESTER_EMAIL.get(nameEl.value||'');
      }
      (function initCreateRequesterEmail(){
        const createNameEl = document.getElementById('create-rq-by');
        if (createNameEl) {
          createNameEl.addEventListener('input', syncCreateRequesterEmail);
          createNameEl.addEventListener('change', syncCreateRequesterEmail);
          syncCreateRequesterEmail();
        }
      })();

      async function renderForm5All(){
        const bodyP1 = document.getElementById('f5a-body-p1');
        const bodyP2 = document.getElementById('f5a-body-p2');
        // ƒê√£ b·ªè hi·ªÉn th·ªã spinner loading trong b·∫£ng ƒë·ªÉ tr√°nh hi·ªÉu nh·∫ßm cho ng∆∞·ªùi d√πng
        const chartWrap = document.getElementById('f5a-chart-container');
        const chartCanvas = document.getElementById('f5a-chart');
        const chartWrapMan = document.getElementById('f5a-chart-container-manhour');
        const chartCanvasMan = document.getElementById('f5a-chart-manhour');
        function destroyChart(){ try{ if (F5A_CHART) { F5A_CHART.destroy(); F5A_CHART = null; } }catch(_){}
          try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); F5A_CHART_MAN = null; } }catch(_){}
        }
        function renderStackedChart(rows){
          try{
            // N·∫øu t·∫°m th·ªùi v√¥ hi·ªáu ho√° bi·ªÉu ƒë·ªì, ·∫©n containers v√† tho√°t s·ªõm
            if (typeof F5A_DISABLE_CHARTS !== 'undefined' && F5A_DISABLE_CHARTS){
              const chartWrap = document.getElementById('f5a-chart-container');
              const chartWrapMan = document.getElementById('f5a-chart-container-manhour');
              if (chartWrap) chartWrap.style.display = 'none';
              if (chartWrapMan) chartWrapMan.style.display = 'none';
              try{ destroyChart(); }catch(_){ }
              return;
            }
            try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
            if (!Array.isArray(rows) || !rows.length || !chartCanvas) { if(chartWrap) chartWrap.style.display='none'; destroyChart(); return; }
            // Ch·ªçn ch·∫ø ƒë·ªô d·ªØ li·ªáu: rates (c≈©) ho·∫∑c manhour (m·ªõi)
            const basisSel = document.getElementById('f5a-basis');
            const basis = basisSel ? (basisSel.value || 'rates') : 'rates';
            if (basis === 'manhour'){
              const filteredRows = rows.filter(r => {
                const name = (r['Ph·ª• tr√°ch'] || r.name || '').trim();
                if (name.toLowerCase() === 'x') return false;
                if (isNameInBlacklist(name)) return false;
                return true;
              });
              const labels = filteredRows.map(r=> r.name);
              const isHorizontal = (F5A_MODE === 'horizontal');
              if (chartWrap) {
                chartWrap.style.display = '';
                const baseH = 420;
                chartWrap.style.height = isHorizontal ? Math.max(baseH, 28*labels.length + 100) + 'px' : baseH + 'px';
              }
              const ctx = chartCanvas.getContext('2d');
              destroyChart();
              const dataMan = filteredRows.map(r=> Number(r.manhour)||0);
              const valueLabelsPlugin = {
                id: 'valueLabels',
                afterDatasetsDraw(chart){
                  const { ctx } = chart;
                  const isHorizontal = chart.options.indexAxis === 'y';
                  const meta = chart.getDatasetMeta(0);
                  if (!meta || !meta.data) return;
                  ctx.save();
                  meta.data.forEach((bar, i)=>{
                    const val = Number(chart.data.datasets[0].data?.[i]) || 0;
                    if (val <= 0) return;
                    const x = isHorizontal ? (bar.x + 12) : bar.x;
                    const y = isHorizontal ? bar.y : (bar.y - 6);
                    ctx.fillStyle = '#0b1324';
                    ctx.font = 'bold 12px Inter, Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(val.toFixed(2), x, y);
                  });
                  ctx.restore();
                }
              };
              F5A_CHART = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'C√¥ng chu·∫©n hi·ªán t·∫°i', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  indexAxis: isHorizontal ? 'y' : 'x',
                  scales: {
                    x: { ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false }, title: { display: true, text: isHorizontal? 'C√¥ng chu·∫©n' : 'Nh√¢n vi√™n' } },
                    y: { beginAtZero: true, ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: isHorizontal? 'Nh√¢n vi√™n' : 'C√¥ng chu·∫©n' } }
                  },
                  plugins: { legend: { display: false } }
                },
                plugins: [valueLabelsPlugin]
              });
              try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
              F5A_LAST_ROWS = filteredRows;
              const modeSel = document.getElementById('f5a-mode');
              if (modeSel){ modeSel.value = F5A_MODE; modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); }; }
              if (basisSel){ basisSel.value = basis; basisSel.onchange = ()=> renderStackedChart(F5A_LAST_ROWS); }
              try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
              return;
            }
            // Fallback t√≠nh t·ª∑ l·ªá n·∫øu ch∆∞a c√≥ % nh∆∞ng c√≥ s·ªë l∆∞·ª£ng
            const normalized = rows.filter(r => {
              const name = (r['Ph·ª• tr√°ch'] || r.name || '').trim();
              if (name.toLowerCase() === 'x') return false;
              if (isNameInBlacklist(name)) return false;
              return true;
            }).map(r=>{
              const a = Number(r.rateAhead)||0, o = Number(r.rateOntime)||0, l = Number(r.rateLate)||0;
              if ((a+o+l) > 0) return { ...r, rateAhead:a, rateOntime:o, rateLate:l };
              const ca = Number(r.ahead)||0, co = Number(r.ontime)||0, cl = Number(r.late)||0;
              const sum = ca + co + cl;
              if (sum > 0) return { ...r, rateAhead: Math.round(ca*100/sum), rateOntime: Math.round(co*100/sum), rateLate: Math.round(cl*100/sum) };
              return { ...r };
            });
            const labels = normalized.map(r=> r.name);
            const counts   = normalized.map(r=> isNaN(r.count)?0:Number(r.count));
            // T√≠nh s·ªë l∆∞·ª£ng theo tr·∫°ng th√°i, n·∫øu thi·∫øu th√¨ suy ra t·ª´ % * t·ªïng count
            const cntOn  = normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ontime)||Math.round((Number(r.rateOntime)||0)*c/100); return v; });
            const cntLate= normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.late)||Math.round((Number(r.rateLate)||0)*c/100); return v; });
            const cntAhead=normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ahead)||Math.round((Number(r.rateAhead)||0)*c/100); return v; });
            // T√≠nh ph·∫ßn trƒÉm ƒë·ªÉ hi·ªÉn th·ªã nh√£n
            const pctOn   = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntOn[i]||0)*100/c); });
            const pctLate = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntLate[i]||0)*100/c); });
            const pctAhead= normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntAhead[i]||0)*100/c); });
            const maxCount = Math.max(1, ...counts);
            const isHorizontal = (F5A_MODE === 'horizontal');
            if (chartWrap) { chartWrap.style.display = ''; chartWrap.style.height = (isHorizontal ? Math.max(440, 28*labels.length + 100) : 440) + 'px'; }
            if (chartWrapMan) { chartWrapMan.style.display = ''; chartWrapMan.style.height = 420 + 'px'; }
            const ctx = chartCanvas.getContext('2d');
            destroyChart();
            const stackedLabelsPlugin = {
              id: 'stackedLabels',
              afterDatasetsDraw(chart){
                const { ctx, chartArea } = chart;
                ctx.save();
                const isHorizontal = chart.options.indexAxis === 'y';
                chart.data.datasets.forEach((ds, dsIdx)=>{
                  const meta = chart.getDatasetMeta(dsIdx);
                  if (!meta || meta.hidden || !meta.data || (ds.type && ds.type !== 'bar')) return;
                  const inSameStack = (other)=> (other.stack || '') === (ds.stack || '');
                  meta.data.forEach((bar, i)=>{
                    const val = Number(ds.data?.[i]) || 0;
                    if (val <= 0) return;
                    let total = 0;
                    chart.data.datasets.forEach((ods, j)=>{
                      const m = chart.getDatasetMeta(j);
                      if (!m || m.hidden || (ods.type && ods.type !== 'bar')) return;
                      if (!inSameStack(ods)) return;
                      total += Number(ods.data?.[i]) || 0;
                    });
                    if (!total) return;
                    const percent = Math.round((val * 100) / total);
                    const x = bar.x !== undefined ? bar.x : (bar.tooltipPosition ? bar.tooltipPosition().x : 0);
                    const y = bar.y !== undefined ? bar.y : (bar.tooltipPosition ? bar.tooltipPosition().y : 0);
                    const base = bar.base !== undefined ? bar.base : (isHorizontal ? chart.scales.x.getPixelForValue(0) : chart.scales.y.getPixelForValue(0));
                    const midX = isHorizontal ? (x + base) / 2 : x;
                    const midY = isHorizontal ? y : (y + base) / 2;
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 12px Inter, Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, midX, Math.min(midY, chartArea.bottom - 4));
                  });
                });
                ctx.restore();
              }
            };
            const stackTotalsPlugin = {
              id: 'stackTotals',
              afterDatasetsDraw(chart){
                const { ctx } = chart;
                const isHorizontal = chart.options.indexAxis === 'y';
                const datasets = chart.data.datasets || [];
                const labels = chart.data.labels || [];
                ctx.save();
                for (let i=0; i<labels.length; i++){
                  let total = 0;
                  let anchor = null;
                  datasets.forEach((ds, idx)=>{
                    const meta = chart.getDatasetMeta(idx);
                    if (!meta || meta.hidden || (ds.type && ds.type !== 'bar')) return;
                    if ((ds.stack || '') !== 'rates') return;
                    const val = Number(ds.data?.[i]) || 0;
                    total += val;
                    if (!anchor) anchor = meta.data?.[i] || null;
                  });
                  if (!anchor || !total) continue;
                  const scale = isHorizontal ? chart.scales.x : chart.scales.y;
                  const pos = scale.getPixelForValue(total);
                  const x = isHorizontal ? (pos + 12) : anchor.x;
                  const y = isHorizontal ? anchor.y : (pos - 6);
                  ctx.fillStyle = '#0b1324';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillText(String(total), x, y);
                }
                ctx.restore();
              }
            };
            const COLOR_ON = 'rgba(134,239,172,0.85)';      // green-300
            const COLOR_LATE = 'rgba(254,202,202,0.9)';     // red-200
            const COLOR_AHEAD = 'rgba(147,197,253,0.9)';    // blue-300
            const BORDER_SEG = '#e5e7eb';                   // slate-200
            const barT = isHorizontal ? 20 : 26;
            const catPct = isHorizontal ? 0.75 : 0.9;
            const barPct = isHorizontal ? 0.9 : 0.95;
            F5A_CHART = new Chart(ctx, {
              type: 'bar',
              data: {
                labels,
                datasets: [
                  { label: 'V∆∞·ª£t ti·∫øn ƒë·ªô', data: cntAhead, backgroundColor: COLOR_AHEAD, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                  { label: 'ƒê√∫ng ti·∫øn ƒë·ªô', data: cntOn, backgroundColor: COLOR_ON, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                  { label: 'Ch·∫≠m ti·∫øn ƒë·ªô', data: cntLate, backgroundColor: COLOR_LATE, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: isHorizontal ? 'y' : 'x',
                scales: {
                  x: { stacked: true, ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false } },
                  y: { stacked: true, beginAtZero: true, suggestedMax: Math.ceil(maxCount*1.15), ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: 'S·ªë t√°c v·ª•' } }
                },
                plugins: {
                  stackedLabels: {},
                  legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                  tooltip: {
                    callbacks: {
                      label: (ctx)=>{
                        const dsLabel = ctx.dataset.label || '';
                        const value = ctx.parsed[isHorizontal?'x':'y'];
                        const total = counts[ctx.dataIndex] || 0;
                        const pct = total ? Math.round(value*100/total) : 0;
                        return ` ${dsLabel}: ${value} (${pct}%)`;
                      }
                    }
                  }
                },
                plugins: [stackedLabelsPlugin, stackTotalsPlugin]
              }
            });
            try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
            // l∆∞u l·∫°i rows (gi·ªØ ƒë·ªß thu·ªôc t√≠nh, k·ªÉ c·∫£ manhour) ƒë·ªÉ ƒë·ªïi ch·∫ø ƒë·ªô
            F5A_LAST_ROWS = rows;
            const modeSel = document.getElementById('f5a-mode');
            if (modeSel){
              modeSel.value = F5A_MODE;
              modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); };
            }
            // Render chart manhour song song
            try {
              const manRows = ((F5A_LAST_ROWS && Array.isArray(F5A_LAST_ROWS)) ? F5A_LAST_ROWS : normalized).filter(r => {
                const name = (r['Ph·ª• tr√°ch'] || r.name || '').trim();
                if (name.toLowerCase() === 'x') return false;
                if (isNameInBlacklist(name)) return false;
                return true;
              }).slice().sort((a,b)=> Number(b.manhour||0) - Number(a.manhour||0));
              const labels2 = manRows.map(r=> r.name);
              const ctxMan = chartCanvasMan ? chartCanvasMan.getContext('2d') : null;
              if (ctxMan){
                const dataMan = manRows.map(r=> Number(r.manhour)||0);
                try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); } }catch(_){ }
                const valueLabelsPlugin2 = {
                  id: 'valueLabels2',
                  afterDatasetsDraw(chart){
                    const { ctx } = chart; const meta = chart.getDatasetMeta(0); if (!meta||!meta.data) return;
                    ctx.save(); meta.data.forEach((bar,i)=>{ const v=Number(chart.data.datasets[0].data?.[i])||0; if(v<=0) return; const x=bar.x; const y=(bar.y-6); ctx.fillStyle='#0b1324'; ctx.font='bold 12px Inter, Arial'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(v.toFixed(2), x, y); }); ctx.restore();
                  }
                };
                F5A_CHART_MAN = new Chart(ctxMan, {
                  type: 'bar',
                  data: { labels: labels2, datasets: [{ label: 'C√¥ng chu·∫©n hi·ªán t·∫°i', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
                  options: { responsive:true, maintainAspectRatio:false, indexAxis: 'x', scales: { x:{ ticks:{ autoSkip:false, maxRotation:20, minRotation:0, font:{ size:11 } }, grid:{ display:false }, title:{ display:true, text: 'Nh√¢n vi√™n' } }, y:{ beginAtZero:true, ticks:{ precision:0 }, grid:{ color:'rgba(0,0,0,0.06)', borderDash:[4,3] }, title:{ display:true, text: 'C√¥ng chu·∫©n' } } }, plugins: { legend:{ display:false } } },
                  plugins: [valueLabelsPlugin2]
                });
              }
            } catch(_) {}
          }catch(_){ if(chartWrap) chartWrap.style.display='none'; }
        }
        try{
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          const toNumeric = (v)=>{ const s=String(v??''); const n=parseFloat(s.replace(/[^0-9.+-]/g,'')); return isNaN(n)?0:n; };
          let fromVal = '';
          let toVal = '';
          if (monthVal) {
            try{
              const [yy, mm] = monthVal.split('-');
              const firstDay = `${yy}-${mm}-01`;
              const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
              const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
              fromVal = firstDay; toVal = lastDay;
            }catch(_){ }
          }
          // Fetch d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ n8n (backend ƒë√£ t√≠nh to√°n v·ªõi logic m·ªõi - b·ªè "Hi·ªán tr·∫°ng theo h·∫°n mong mu·ªën")
          await f5aFetchP1Data(monthVal);
          
          // Ki·ªÉm tra cache n·∫øu fetch th·∫•t b·∫°i
          if (!F5A_P1_DATA || (!F5A_P1_DATA.success && F5A_P1_DATA.success !== undefined) || !Array.isArray(F5A_P1_DATA.data) || F5A_P1_DATA.data.length === 0){
            try{
              const cached = LS.getJSON('f5a.p1.cache');
              if (cached && cached.version === APP_CACHE_VERSION && cached.month === monthVal && cached.data && Array.isArray(cached.data.data) && cached.data.data.length > 0){
                F5A_P1_DATA = cached.data;
                F5A_P1_META = { month: monthVal };
              }
            }catch(_){ }
          }
          
          // Ki·ªÉm tra l·∫°i sau khi load cache
          if (!F5A_P1_DATA || !Array.isArray(F5A_P1_DATA.data) || F5A_P1_DATA.data.length === 0){
            if (bodyP1) bodyP1.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            if (chartWrap) chartWrap.style.display = 'none';
            if (chartWrapMan) chartWrapMan.style.display = 'none';
            return;
          }
          
          // S·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c aggregate t·ª´ n8n (backend ƒë√£ t√≠nh to√°n v·ªõi logic m·ªõi)
          const aggregated = F5A_P1_DATA.data;
          try{ 
            LS.setJSON('f5a.cache', { version: APP_CACHE_VERSION, month: monthVal, rows: aggregated, ts: Date.now() }); 
            LS.set('f5a.lastUpdated', String(Date.now())); 
            updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated');
            // P2 ƒë√£ c√≥ cache ri√™ng, kh√¥ng update ·ªü ƒë√¢y n·ªØa
            // updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated');
          }catch(_){ }
          // Sau khi render, gi·ªØ m·ªôt b·∫£n sao trong bi·∫øn to√†n c·ª•c ƒë·ªÉ c√°c l·∫ßn render l·∫°i nhanh kh√¥ng ph·ª• thu·ªôc cache/b·ªô nh·ªõ ngo√†i
          try { F5A_LAST_ROWS = Array.isArray(aggregated) ? aggregated.slice() : []; } catch(_) {}
          // L·ªçc theo whitelist t√™n v√† lo·∫°i b·ªè nh√¢n vi√™n test "x" v√† blacklist
          const filtered = Array.isArray(aggregated) ? aggregated.filter(item => {
            const name = (item['Ph·ª• tr√°ch'] || item.name || '').trim();
            // Lo·∫°i b·ªè nh√¢n vi√™n c√≥ t√™n l√† "x" (d√πng cho test code)
            if (name.toLowerCase() === 'x') return false;
            // Lo·∫°i b·ªè nh√¢n vi√™n trong blacklist
            if (isNameInBlacklist(name)) return false;
            return true;
          }) : [];
          if (!filtered.length){
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            if (chartWrap) chartWrap.style.display = 'none';
            if (chartWrapMan) chartWrapMan.style.display = 'none';
              return;
            }
          // Sort P1 theo S·ªë DONE t·ª´ l·ªõn ƒë·∫øn nh·ªè
          const sorted = filtered.slice().sort((a,b)=> {
            const doneA = Number(a.doneCnt || 0);
            const doneB = Number(b.doneCnt || 0);
            return doneB - doneA;
          });
          // T√≠nh l·∫°i "S·ªë t√°c v·ª• trong th√°ng" theo ng√†y nh·∫≠n (requestDate) t·ª´ d·ªØ li·ªáu th√¥ ƒë·ªÉ kh·ªõp b·∫£ng ph·ª•
          const rqCountMap = (()=>{
            try{
              const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
              const map = new Map();
              const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
              const sameName = (a,b)=> toKey(a)===toKey(b);
              const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
              const parseDate = (v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
              const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
              const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
              const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
              const rqKeys = [
                'üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ',
                'ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu ',
                'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
                'submissiondate','submitteddate','submitdate','submit_date',
                'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
                'ngaygui','ngay_gui','ng√†y g·ª≠i','Ng√†y g·ª≠i',
                'createddate','created_date','creationdate','created',
                'ngaytao','ngay_tao','ng√†y t·∫°o','Ng√†y t·∫°o',
                'th·ªùi gian y√™u c·∫ßu','th·ªùi ƒëi·ªÉm y√™u c·∫ßu'
              ];
              const statusKeys = ['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
              const doneKeys = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
              const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(done); };
              // ƒê·∫øm theo t·ª´ng t√™n hi·ªÉn th·ªã trong b·∫£ng sorted (kh√¥ng ph·ª• thu·ªôc tr√πng kh·ªõp tuy·ªát ƒë·ªëi)
              const displayKeys = [];
              const keyToDisplay = new Map();
              sorted.forEach(it=>{ const displayName = it['Ph·ª• tr√°ch'] || it.name || ''; const key = toKey(displayName); if(!map.has(key)) map.set(key,0); displayKeys.push(key); keyToDisplay.set(key, displayName); });
              rows.forEach(o=>{
                if (isCanceled(o)) return;
                const emp = getV(o, assigneeKeys);
                const rq = getV(o, rqKeys); const rqD = parseDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
                const rk = toKey(emp);
                // t√¨m kh·ªõp g·∫ßn ƒë√∫ng v·ªõi t√™n hi·ªÉn th·ªã
                let matchedKey = null;
                if (map.has(rk)) matchedKey = rk; else {
                  for (const dk of displayKeys){ if (rk.includes(dk) || dk.includes(rk)) { matchedKey = dk; break; } }
                }
                if (!matchedKey) return;
                map.set(matchedKey, (map.get(matchedKey)||0) + 1);
              });
              return map;
            }catch(_){ return new Map(); }
          })();
          // ƒê·∫øm s·ªë task nh·∫≠n trong th√°ng t·ª´ details c·ªßa n8n (ch·ªâ t√≠nh sameMonth)
          function f5aCountByAssigneeInline(displayName){
            try{
              // ∆Øu ti√™n s·ª≠ d·ª•ng details t·ª´ n8n
              if (F5A_P1_DATA && F5A_P1_DATA.success && Array.isArray(F5A_P1_DATA.data)){
                const normalizeName = (s)=>{
                  try{
                    const raw = String(s||'').trim();
                    const noAcc = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                    return noAcc.replace(/\s+/g,' ').trim();
                  }catch(_){ return String(s||'').toLowerCase().trim(); }
                };
                const targetNameNorm = normalizeName(displayName);
                const empData = F5A_P1_DATA.data.find(emp => {
                  const empName = emp['Ph·ª• tr√°ch'] || emp.name || '';
                  return normalizeName(empName) === targetNameNorm;
                });
                if (empData && empData.details && Array.isArray(empData.details.sameMonth)){
                  return empData.details.sameMonth.length;
                }
              }
              
              // Fallback: t√≠nh t·ª´ raw data (n·∫øu kh√¥ng c√≥ n8n data)
              const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
              const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
              const targetKey = toKey(displayName);
              const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
              const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
              const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
              const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
              const rqKeys = [
                'üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ',
                'ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu ',
                'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
                'submissiondate','submitteddate','submitdate','submit_date',
                'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
                'ngaygui','ngay_gui','ng√†y g·ª≠i','Ng√†y g·ª≠i',
                'createddate','created_date','creationdate','created',
                'ngaytao','ngay_tao','ng√†y t·∫°o','Ng√†y t·∫°o',
                'th·ªùi gian y√™u c·∫ßu','th·ªùi ƒëi·ªÉm y√™u c·∫ßu'
              ];
              const statusKeys = ['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
              const doneKeys = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
              const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(done); };
              let cnt = 0;
              rows.forEach(o=>{
                if (isCanceled(o)) return;
                const emp = getV(o, assigneeKeys); const rk = toKey(emp);
                if (rk !== targetKey) return;
                const rq = getV(o, rqKeys); let d = parseDateFlexible(rq); let ds = d? iso(d):'';
                if (!inRange(ds)) {
                  try{
                    let found = '';
                    for (const v of Object.values(o||{})){
                      const dv = parseDateFlexible(v); if (!dv) continue; const svi = iso(dv); if (inRange(svi)) { found = svi; break; }
                    }
                    if (found){ cnt++; return; }
                  }catch(_){ }
                  return;
                }
                cnt++;
              });
              return cnt;
            }catch(_){ return 0; }
          }
          const rowsP1 = [];
          // const rowsP2 = []; // COMMENTED: P2 d√πng webhook ri√™ng
          sorted.forEach(item=>{
            // S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ n8n (ƒë√£ ƒë∆∞·ª£c aggregate v√† t√≠nh to√°n s·∫µn)
            const name = item['Ph·ª• tr√°ch'] || item.name || '';
            // T·ªïng c√¥ng chu·∫©n t·ª´ n8n
            const man = Number(item['T·ªïng c√¥ng chu·∫©n'] || item.totalByRef || 0);
            // S·ªë task nh·∫≠n trong th√°ng (c·∫ßn t√≠nh t·ª´ raw data ho·∫∑c t·ª´ details)
            const count = f5aCountByAssigneeInline(name);
            const ahead = Number(item.ahead || 0);
            const ontime = Number(item.ontime || 0);
            const late = Number(item.late || 0);
            const na = Number(item.na || 0);
            const doneCnt = Number(item.doneCnt || 0);
            
            // Ki·ªÉm tra v√† t√≠nh l·∫°i t·ª∑ l·ªá % t·ª´ s·ªë l∆∞·ª£ng ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n
            // T·ªïng s·ªë task ƒë√£ DONE (kh√¥ng bao g·ªìm N/A)
            const totalDoneForRate = ahead + ontime + late;
            // T√≠nh t·ª∑ l·ªá % d·ª±a tr√™n s·ªë l∆∞·ª£ng th·ª±c t·∫ø
            let rAhead = 0, rOn = 0, rLate = 0, rNA = 0;
            
            if (doneCnt > 0) {
              // T√≠nh t·ª∑ l·ªá % d·ª±a tr√™n doneCnt (t·ªïng s·ªë task ƒë√£ ho√†n th√†nh)
              rAhead = totalDoneForRate > 0 ? (ahead / doneCnt) * 100 : 0;
              rOn = totalDoneForRate > 0 ? (ontime / doneCnt) * 100 : 0;
              rLate = totalDoneForRate > 0 ? (late / doneCnt) * 100 : 0;
              rNA = (na / doneCnt) * 100;
            } else {
              // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ n8n, s·ª≠ d·ª•ng gi√° tr·ªã t·ª´ n8n
              rAhead = Number(item.rateAhead || 0);
              rOn = Number(item.rateOntime || 0);
              rLate = Number(item.rateLate || 0);
              rNA = Number(item.rateNA || 0);
            }
            
            // L√†m tr√≤n ƒë·∫øn 1 ch·ªØ s·ªë th·∫≠p ph√¢n
            rAhead = Math.round(rAhead * 10) / 10;
            rOn = Math.round(rOn * 10) / 10;
            rLate = Math.round(rLate * 10) / 10;
            rNA = Math.round(rNA * 10) / 10;
            
            // Ki·ªÉm tra t·ªïng t·ª∑ l·ªá c√≥ b·∫±ng 100% kh√¥ng (cho ph√©p sai s·ªë do l√†m tr√≤n)
            const totalRate = rAhead + rOn + rLate + rNA;
            const rateDiff = Math.abs(totalRate - 100);
            
            // N·∫øu sai s·ªë l·ªõn h∆°n 1% do l√†m tr√≤n, ƒëi·ªÅu ch·ªânh l·∫°i
            if (rateDiff > 1 && doneCnt > 0) {
              // ƒêi·ªÅu ch·ªânh t·ª∑ l·ªá l·ªõn nh·∫•t ƒë·ªÉ t·ªïng = 100%
              const maxRate = Math.max(rAhead, rOn, rLate, rNA);
              if (maxRate === rAhead) rAhead = 100 - (rOn + rLate + rNA);
              else if (maxRate === rOn) rOn = 100 - (rAhead + rLate + rNA);
              else if (maxRate === rLate) rLate = 100 - (rAhead + rOn + rNA);
              else rNA = 100 - (rAhead + rOn + rLate);
              
              // L√†m tr√≤n l·∫°i sau khi ƒëi·ªÅu ch·ªânh
              rAhead = Math.round(rAhead * 10) / 10;
              rOn = Math.round(rOn * 10) / 10;
              rLate = Math.round(rLate * 10) / 10;
              rNA = Math.round(rNA * 10) / 10;
            }
            
            // Ki·ªÉm tra t√≠nh nh·∫•t qu√°n: t·ªïng s·ªë l∆∞·ª£ng ph·∫£i b·∫±ng doneCnt
            const totalCount = ahead + ontime + late + na;
            // N·∫øu c√≥ s·ª± kh√¥ng kh·ªõp, log warning (kh√¥ng s·ª≠a d·ªØ li·ªáu t·ª´ n8n)
            if (Math.abs(totalCount - doneCnt) > 0.1 && doneCnt > 0) {
              console.warn(`[Form 5 P1] D·ªØ li·ªáu kh√¥ng kh·ªõp cho ${name}: t·ªïng s·ªë l∆∞·ª£ng (${totalCount}) != doneCnt (${doneCnt})`);
            }
            const need = f5aGetNeedManhour(name);
            // T√≠nh t·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø cho nh√¢n vi√™n n√†y (v·∫´n c·∫ßn raw data)
            const totalActualHoursData = calculateTotalActualHours(name, fromVal, toVal);
            const totalActualHours = totalActualHoursData.formatted;
            
            // L∆∞u v√†o Map ƒë·ªÉ s·ª≠ d·ª•ng sau n√†y
            if (!window.F5A_TOTAL_ACTUAL_HOURS_MAP) {
              window.F5A_TOTAL_ACTUAL_HOURS_MAP = new Map();
            }
            window.F5A_TOTAL_ACTUAL_HOURS_MAP.set(name, totalActualHoursData);
            // P2 ƒë√£ ƒë∆∞·ª£c t√°ch ra h√†m ri√™ng renderForm5P2() - kh√¥ng render ·ªü ƒë√¢y n·ªØa
            // rowsP2.push(`...`); // COMMENTED: P2 d√πng webhook ri√™ng
            rowsP1.push(`
              <tr>
                <td class="px-3 py-2">${name}</td>
                <td class="px-3 py-2 f5a-col-done"><button class="text-primary-blue hover:underline" data-f5a-done="${name}">${doneCnt}</button></td>
                <td class="px-3 py-2">${ahead}</td>
                <td class="px-3 py-2">${ontime}</td>
                <td class="px-3 py-2">${late}</td>
                <td class="px-3 py-2">${na}</td>
                <td class="px-3 py-2">${rAhead.toFixed(1)}%</td>
                <td class="px-3 py-2">${rOn.toFixed(1)}%</td>
                <td class="px-3 py-2">${rLate.toFixed(1)}%</td>
                <td class="px-3 py-2">${rNA.toFixed(1)}%</td>
              </tr>`);
          });
          try{ const b1 = document.getElementById('f5a-body-p1'); if (b1) b1.innerHTML = rowsP1.join('') || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; }catch(_){ }
          // H√†ng t·ªïng cu·ªëi b·∫£ng
          const sumAhead = sorted.reduce((a,it)=> a + Number(it.ahead||0), 0);
          const sumOn = sorted.reduce((a,it)=> a + Number(it.ontime||0), 0);
          const sumLate = sorted.reduce((a,it)=> a + Number(it.late||0), 0);
          const sumNA = sorted.reduce((a,it)=> a + Number(it.na||0), 0);
          const sumDone = sorted.reduce((a,it)=> a + Number(it.doneCnt || 0), 0);
          
          // T√≠nh t·ª∑ l·ªá % t·ªïng h·ª£p t·ª´ t·ªïng s·ªë l∆∞·ª£ng
          let totalRateAhead = 0, totalRateOn = 0, totalRateLate = 0, totalRateNA = 0;
          if (sumDone > 0) {
            totalRateAhead = (sumAhead / sumDone) * 100;
            totalRateOn = (sumOn / sumDone) * 100;
            totalRateLate = (sumLate / sumDone) * 100;
            totalRateNA = (sumNA / sumDone) * 100;
          }
          // L√†m tr√≤n ƒë·∫øn 1 ch·ªØ s·ªë th·∫≠p ph√¢n
          totalRateAhead = Math.round(totalRateAhead * 10) / 10;
          totalRateOn = Math.round(totalRateOn * 10) / 10;
          totalRateLate = Math.round(totalRateLate * 10) / 10;
          totalRateNA = Math.round(totalRateNA * 10) / 10;
          
          const totalP1 = `
            <tr class="bg-blue-50 font-semibold">
              <td class="px-3 py-2">T·ªîNG</td>
              <td class="px-3 py-2 f5a-col-done">${sumDone}</td>
              <td class="px-3 py-2">${sumAhead}</td>
              <td class="px-3 py-2">${sumOn}</td>
              <td class="px-3 py-2">${sumLate}</td>
              <td class="px-3 py-2">${sumNA}</td>
              <td class="px-3 py-2">${totalRateAhead.toFixed(1)}%</td>
              <td class="px-3 py-2">${totalRateOn.toFixed(1)}%</td>
              <td class="px-3 py-2">${totalRateLate.toFixed(1)}%</td>
              <td class="px-3 py-2">${totalRateNA.toFixed(1)}%</td>
            </tr>`;
          try{ const b1 = document.getElementById('f5a-body-p1'); if (b1) b1.innerHTML = (rowsP1.join('') + totalP1); }catch(_){ }
          // P2 ƒë√£ ƒë∆∞·ª£c t√°ch ra h√†m ri√™ng renderForm5P2() - kh√¥ng render ·ªü ƒë√¢y n·ªØa
          // try{ const b2 = document.getElementById('f5a-body-p2'); if (b2) b2.innerHTML = (rowsP2.join('') + totalP2); }catch(_){ }
          try{ enableTableDrag('f5a-body-p1'); }catch(_){ }
          // try{ enableTableDrag('f5a-body-p2'); }catch(_){ } // P2 d√πng webhook ri√™ng
          // Chart
          F5A_LAST_ROWS = sorted;
          renderStackedChart(sorted);
          // Render dashboard P1
          renderDashboardP1();
        }catch(err){
          try{ const b1 = document.getElementById('f5a-body-p1'); if (b1) b1.innerHTML = `<tr><td colspan='10' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`; }catch(_){ }
          try{ const b2 = document.getElementById('f5a-body-p2'); if (b2) b2.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`; }catch(_){ }
          if (chartWrap) chartWrap.style.display = 'none';
        }
      }

      // Render Form 5 P2 t·ª´ d·ªØ li·ªáu n8n (lu·ªìng ri√™ng)
      async function renderForm5P2(){
        const bodyP2 = document.getElementById('f5a-body-p2');
        if (!bodyP2) {
          console.warn('[F5A P2] Body element not found');
          return;
        }
        
        // ƒê√£ b·ªè hi·ªÉn th·ªã spinner loading trong b·∫£ng ƒë·ªÉ tr√°nh hi·ªÉu nh·∫ßm cho ng∆∞·ªùi d√πng
        
        try{
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          // Fetch d·ªØ li·ªáu P2 t·ª´ n8n
          await f5aFetchP2Data(monthVal);
          
          // Ki·ªÉm tra cache n·∫øu fetch th·∫•t b·∫°i
          if (!F5A_P2_DATA || !Array.isArray(F5A_P2_DATA.data) || F5A_P2_DATA.data.length === 0){
            try{
              const cached = LS.getJSON('f5a.p2.cache');
              console.log('[F5A P2] Checking cache:', cached);
              if (cached && cached.version === APP_CACHE_VERSION && cached.month === monthVal && cached.data && Array.isArray(cached.data.data) && cached.data.data.length > 0){
                F5A_P2_DATA = cached.data;
                F5A_P2_META = { month: monthVal };
                console.log('[F5A P2] Loaded from cache, count:', F5A_P2_DATA.data.length);
              }
            }catch(_){ }
          }
          
          // Ki·ªÉm tra l·∫°i sau khi load cache
          if (!F5A_P2_DATA || !Array.isArray(F5A_P2_DATA.data) || F5A_P2_DATA.data.length === 0){
            console.error('[F5A P2] No valid data found');
            bodyP2.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            return;
          }
          
          const data = F5A_P2_DATA.data;
          const currentMonth = F5A_P2_DATA.month || monthVal || '';
          console.log('[F5A P2] Rendering data, count:', data.length);
          
          // L·ªçc b·ªè c√°c nh√¢n vi√™n trong blacklist
          const filteredData = Array.isArray(data) ? data.filter(item => {
            const name = item.name || item['Ph·ª• tr√°ch'] || '';
            return !isNameInBlacklist(name);
          }) : [];
          
          // Render b·∫£ng
          const rows = [];
          let sumCount = 0;
          let sumActualHours = 0;
          let sumManhour = 0;
          let sumWorkHours = 0;
          
          // Helper function ƒë·ªÉ parse s·ªë t·ª´ format "48,00"
          const parseNumber = (str) => {
            if (!str) return 0;
            const cleaned = String(str).replace(/[^0-9.,-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
          };
          
          // Helper function ƒë·ªÉ format s·ªë v·ªõi d·∫•u ph·∫©y
          const formatNumber = (num) => {
            if (!Number.isFinite(num)) return '';
            return num.toFixed(2).replace('.', ',');
          };
          
          // Helper function ƒë·ªÉ format coefficient v·ªõi d·∫•u ph·∫©y
          const formatCoefficient = (coef) => {
            if (!coef || coef === '') return '';
            // X·ª≠ l√Ω d·∫•u ph·∫©y: chuy·ªÉn d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m tr∆∞·ªõc khi parse
            let cleaned = String(coef).trim();
            // N·∫øu c√≥ d·∫•u ph·∫©y v√† kh√¥ng c√≥ d·∫•u ch·∫•m, thay d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m
            if (cleaned.includes(',') && !cleaned.includes('.')) {
              cleaned = cleaned.replace(',', '.');
            }
            // N·∫øu c√≥ c·∫£ d·∫•u ph·∫©y v√† d·∫•u ch·∫•m, lo·∫°i b·ªè d·∫•u ch·∫•m (d·∫•u ph·∫©y l√† d·∫•u ph√¢n c√°ch h√†ng ngh√¨n)
            else if (cleaned.includes(',') && cleaned.includes('.')) {
              cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            }
            const num = parseFloat(cleaned);
            if (isNaN(num)) return '';
            return num.toFixed(2).replace('.', ',');
          };
          
          // Helper function ƒë·ªÉ l·∫•y m√†u cho coefficient
          const getCoefficientColor = (coef) => {
            if (!coef || coef === '') return 'text-gray-500';
            // X·ª≠ l√Ω d·∫•u ph·∫©y: chuy·ªÉn d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m tr∆∞·ªõc khi parse
            let cleaned = String(coef).trim();
            if (cleaned.includes(',') && !cleaned.includes('.')) {
              cleaned = cleaned.replace(',', '.');
            } else if (cleaned.includes(',') && cleaned.includes('.')) {
              cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            }
            const val = parseFloat(cleaned);
            if (isNaN(val)) return 'text-gray-500';
            if (val >= 0.8) return 'text-green-600 font-semibold';
            if (val >= 0.6) return 'text-blue-600 font-semibold';
            if (val >= 0.4) return 'text-yellow-600 font-semibold';
            return 'text-red-600 font-semibold';
          };
          
          // Helper function ƒë·ªÉ parse coefficient (x·ª≠ l√Ω d·∫•u ph·∫©y)
          const parseCoefficient = (coef) => {
            if (!coef || coef === '') return 0;
            let cleaned = String(coef).trim();
            if (cleaned.includes(',') && !cleaned.includes('.')) {
              cleaned = cleaned.replace(',', '.');
            } else if (cleaned.includes(',') && cleaned.includes('.')) {
              cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            }
            return parseFloat(cleaned) || 0;
          };
          
          // Sort P2 theo H·ªá s·ªë t·ª´ l·ªõn ƒë·∫øn nh·ªè
          const sortedData = filteredData.slice().sort((a, b) => {
            const coefA = parseCoefficient(a.coefficient || '0');
            const coefB = parseCoefficient(b.coefficient || '0');
            // N·∫øu h·ªá s·ªë b·∫±ng nhau, sort theo t√™n
            if (coefB === coefA) {
              const nameA = (a.name || a['Ph·ª• tr√°ch'] || '').trim();
              const nameB = (b.name || b['Ph·ª• tr√°ch'] || '').trim();
              return nameA.localeCompare(nameB, 'vi');
            }
            return coefB - coefA;
          });
          
          sortedData.forEach((item, index) => {
            const stt = index + 1;
            const name = item.name || item['Ph·ª• tr√°ch'] || '';
            const taskCount = Number(item.taskCount || item.count || 0);
            const totalActualHours = item.totalActualHours || item['T·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '0,00';
            const manhourReceived = item.manhourReceived || item['C√¥ng chu·∫©n ƒë√£ nh·∫≠n'] || item['T·ªïng c√¥ng chu·∫©n'] || '0,00';
            const totalWorkHours = item.totalWorkHours || item['T·ªïng gi·ªù c√¥ng ƒëi l√†m'] || '';
            const coefficient = item.coefficient || '';
            const coefficientFormatted = formatCoefficient(coefficient);
            const coefficientColor = getCoefficientColor(coefficient);
            
            // T√≠nh t·ªïng (parse t·ª´ string)
            sumCount += taskCount;
            sumActualHours += parseNumber(totalActualHours);
            sumManhour += parseNumber(manhourReceived);
            if (totalWorkHours) {
              sumWorkHours += parseNumber(totalWorkHours);
            }
            
            rows.push(`
              <tr class="hover:bg-blue-50 transition-colors">
                <td class="px-3 py-2 text-center">${stt}</td>
                <td class="px-3 py-2 text-center"><span class="font-medium text-gray-800">${name}</span></td>
                <td class="px-3 py-2 text-center">
                  <button class="text-blue-600 hover:text-blue-800 hover:underline font-medium cursor-pointer" data-f5a-rqcount="${name}" title="Xem chi ti·∫øt ${taskCount} t√°c v·ª•">
                    ${taskCount}
                  </button>
                </td>
                <td class="px-3 py-2 text-center font-medium">${totalActualHours}</td>
                <td class="px-3 py-2 text-center font-medium">${manhourReceived}</td>
                <td class="px-3 py-2 text-center cell-div">
                  <button 
                    class="text-blue-600 hover:text-blue-800 hover:underline font-medium cursor-pointer" 
                    data-f10-open-modal="${name}" 
                    data-f10-month="${currentMonth}"
                    title="Xem b·∫£ng c√¥ng c·ªßa ${name}">
                    ${totalWorkHours || '-'}
                  </button>
                </td>
                <td class="px-3 py-2 text-center ${coefficientColor}">${coefficientFormatted || '-'}</td>
              </tr>
            `);
          });
          
          // Th√™m h√†ng t·ªïng
          const sumCoefficient = (sumWorkHours > 0) ? formatNumber(sumManhour / sumWorkHours) : '';
          rows.push(`
            <tr class="bg-blue-50 font-semibold">
              <td class="px-3 py-2 text-center">T·ªîNG</td>
              <td class="px-3 py-2 text-center"></td>
              <td class="px-3 py-2 text-center">${sumCount}</td>
              <td class="px-3 py-2 text-center">${formatNumber(sumActualHours)}</td>
              <td class="px-3 py-2 text-center">${formatNumber(sumManhour)}</td>
              <td class="px-3 py-2 text-center cell-div">${sumWorkHours > 0 ? formatNumber(sumWorkHours) : ''}</td>
              <td class="px-3 py-2 text-center">${sumCoefficient}</td>
            </tr>
          `);
          
          bodyP2.innerHTML = rows.join('') || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          
          try{ enableTableDrag('f5a-body-p2'); }catch(_){ }
          
          // Render dashboard P2
          renderDashboardP2();
          
          console.log('[F5A P2] Render completed successfully');
          
        }catch(err){
          console.error('[F5A P2] Render error:', err);
          if (bodyP2) bodyP2.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
        }
      }

      function restoreForm5FromCache(){
        try{
          const cached = LS.getJSON('f5a.cache');
          if (!cached || cached.version !== APP_CACHE_VERSION || !Array.isArray(cached.rows) || !cached.rows.length) return false;
          // Ch·ªâ kh√¥i ph·ª•c khi tr√πng th√°ng hi·ªán ƒëang ch·ªçn; n·∫øu input tr·ªëng th√¨ g√°n theo cache
          const monthInput = document.getElementById('f5a-month');
          const wantMonth = monthInput ? (monthInput.value || '').trim() : '';
          if (wantMonth && cached.month && cached.month !== wantMonth) return false;
          if (!wantMonth && cached.month && monthInput) { try { monthInput.value = cached.month; } catch(_){} }
          updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated');
          // P2 ƒë√£ c√≥ cache ri√™ng, kh√¥ng update ·ªü ƒë√¢y n·ªØa
          // updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated');
          const body = document.getElementById('f5a-body');
          if (!body) return false;
          const baseRows = Array.isArray(cached.rows) ? cached.rows.slice() : [];
          const filtered = baseRows.filter(item => {
            const name = (item['Ph·ª• tr√°ch'] || item.name || '').trim().toLowerCase();
            // Lo·∫°i b·ªè nh√¢n vi√™n c√≥ t√™n l√† "x" (d√πng cho test code)
            if (name === 'x') return false;
            return true;
          });
          if (!filtered.length){
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
            return true;
          }
          const sorted = filtered.slice().sort((a,b)=> Number(b["T·ªïng c√¥ng chu·∫©n"]||b.manhour||0) - Number(a["T·ªïng c√¥ng chu·∫©n"]||a.manhour||0));
          const html = sorted.map(item=>{
            const name = item['Ph·ª• tr√°ch'] || item.name || '';
            const man = Number(((item['T·ªïng c√¥ng chu·∫©n'] ?? item['T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω)'] ?? item.manhour) || 0));
            const count = Number(((item['T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω'] ?? item.count) || 0));
            const ahead = Number(item.ahead||0);
            const ontime = Number(item.ontime||0);
            const late = Number(item.late||0);
            const rAhead = Number(item.rateAhead||0);
            const rOn = Number(item.rateOntime||0);
            const rLate = Number(item.rateLate||0);
            const rNA = Number(item.rateNA||0);
            const need = f5aGetNeedManhour(name);
            return `<tr>
                <td class="px-3 py-2">${name}</td>
                <td class="px-3 py-2">${man.toFixed(2)}</td>
                <td class="px-3 py-2 cell-div">${need}</td>
                <td class="px-3 py-2">${count}</td>
                <td class="px-3 py-2 f5a-col-done">${Number(item.doneCnt || (ahead + ontime + late))}</td>
                <td class="px-3 py-2">${ahead}</td>
                <td class="px-3 py-2">${ontime}</td>
                <td class="px-3 py-2">${late}</td>
                <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
                <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
                <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
                <td class="px-3 py-2">${rNA.toFixed(0)}%</td>
              </tr>`; }).join('');
          // H√†ng t·ªïng cu·ªëi b·∫£ng (kh√¥i ph·ª•c t·ª´ cache)
          const sumMan = sorted.reduce((a,it)=> a + Number(((it['T·ªïng c√¥ng chu·∫©n'] ?? it['T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω)'] ?? it.manhour) || 0)), 0);
          const sumNeed = sorted.reduce((a,it)=> a + Number(f5aGetNeedManhour(it['Ph·ª• tr√°ch'] || it.name || '')), 0);
          const sumCount = sorted.reduce((a,it)=> a + Number(((it['T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω'] ?? it.count) || 0)), 0);
          const sumAhead = sorted.reduce((a,it)=> a + Number(it.ahead||0), 0);
          const sumOn = sorted.reduce((a,it)=> a + Number(it.ontime||0), 0);
          const sumLate = sorted.reduce((a,it)=> a + Number(it.late||0), 0);
          const sumDone = sorted.reduce((a,it)=> a + Number(it.doneCnt || ((Number(it.ahead||0) + Number(it.ontime||0) + Number(it.late||0)))), 0);
          const totalRow = `
              <tr class="bg-blue-50 font-semibold">
                <td class="px-3 py-2">T·ªîNG</td>
                <td class="px-3 py-2">${sumMan.toFixed(2)}</td>
                <td class="px-3 py-2 cell-div">${sumNeed.toFixed(2)}</td>
                <td class="px-3 py-2">${sumCount}</td>
                <td class="px-3 py-2 f5a-col-done">${sumDone}</td>
                <td class="px-3 py-2">${sumAhead}</td>
                <td class="px-3 py-2">${sumOn}</td>
                <td class="px-3 py-2">${sumLate}</td>
                <td class="px-3 py-2"></td>
                <td class="px-3 py-2"></td>
                <td class="px-3 py-2"></td>
                <td class="px-3 py-2"></td>
              </tr>`;
          body.innerHTML = html + totalRow;
          try{ enableTableDrag('f5a-body'); }catch(_){ }
          F5A_LAST_ROWS = sorted;
          try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
          return true;
        }catch(_){ return false; }
      }

      // Xu·∫•t CSV/XLSX
      function f5aRowsToAOA(rows){
        // ∆Øu ti√™n s·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ F5A_P1_DATA n·∫øu c√≥ (gi·ªëng nh∆∞ render)
        let dataToUse = rows;
        if (F5A_P1_DATA && F5A_P1_DATA.data && Array.isArray(F5A_P1_DATA.data) && F5A_P1_DATA.data.length > 0) {
          dataToUse = F5A_P1_DATA.data;
        }
        
        // L·∫•y th√°ng hi·ªán ch·ªçn ƒë·ªÉ l·ªçc theo ng√†y nh·∫≠n
        let fromVal = '', toVal = '';
        try{
          const m = (document.getElementById('f5a-month')?.value||'').trim();
          if (m){ const [yy,mm] = m.split('-'); fromVal = `${yy}-${mm}-01`; const last = new Date(Number(yy), Number(mm), 0).getDate(); toVal = `${yy}-${mm}-${String(last).padStart(2,'0')}`; } 
        }catch(_){ }
        const headers = [
          'Nh√¢n vi√™n','S·ªë DONE','V∆∞·ª£t ti·∫øn ƒë·ªô','ƒê√∫ng ti·∫øn ƒë·ªô','Ch·∫≠m ti·∫øn ƒë·ªô','S·ªë N/A','T·ª∑ l·ªá v∆∞·ª£t (%)','T·ª∑ l·ªá ƒë√∫ng (%)','T·ª∑ l·ªá ch·∫≠m (%)','%N/A'
        ];
        const aoa = [headers];
        // L·ªçc b·ªè nh√¢n vi√™n test "x" v√† blacklist (gi·ªëng nh∆∞ renderForm5All)
        const list = Array.isArray(dataToUse) ? dataToUse.filter(item => {
          const name = (item['Ph·ª• tr√°ch'] || item.name || '').trim();
          if (name.toLowerCase() === 'x') return false;
          if (isNameInBlacklist(name)) return false;
          return true;
        }) : [];
        // Map ƒë·∫øm s·ªë task theo ng√†y nh·∫≠n (requestDate) trong th√°ng ƒë√£ ch·ªçn, lo·∫°i Cancel
        const rqCountMap = (function(){
          try{
            const raw = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
            const map = new Map();
            const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
            const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
            const parseDate = (v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
            const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
            const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
            const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
              const rqKeys = [
                'üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ',
                'ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu ',
                'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
                'submissiondate','submitteddate','submitdate','submit_date',
                'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
                'ngaygui','ngay_gui','ng√†y g·ª≠i','Ng√†y g·ª≠i',
                'createddate','created_date','creationdate','created',
                'ngaytao','ngay_tao','ng√†y t·∫°o','Ng√†y t·∫°o',
                'üìÜ ng√†y g·ª≠i','üìÜ Ng√†y g·ª≠i'
              ];
            const statusKeys = ['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
            const doneKeys = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
            const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(done); };
            raw.forEach(o=>{
              if (isCanceled(o)) return;
              const emp = getV(o, assigneeKeys);
              const rq = getV(o, rqKeys); const rqD = parseDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
              const key = toKey(emp);
              map.set(key, (map.get(key)||0) + 1);
            });
            return map;
          }catch(_){ return new Map(); }
        })();
        // Sort P1 theo S·ªë DONE t·ª´ l·ªõn ƒë·∫øn nh·ªè (gi·ªëng nh∆∞ render)
        const sortedList = list.slice().sort((a, b) => {
          const doneA = Number(a.doneCnt || 0);
          const doneB = Number(b.doneCnt || 0);
          return doneB - doneA;
        });
        // S·ª≠ d·ª•ng c√πng logic nh∆∞ renderForm5All ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu kh·ªõp
        // T√≠nh l·∫°i "S·ªë t√°c v·ª• trong th√°ng" theo ng√†y nh·∫≠n (requestDate) t·ª´ d·ªØ li·ªáu th√¥ ƒë·ªÉ kh·ªõp b·∫£ng ph·ª•
        const f5aCountByAssigneeInline = (displayName) => {
          try{
            // ∆Øu ti√™n s·ª≠ d·ª•ng details t·ª´ n8n
            if (F5A_P1_DATA && F5A_P1_DATA.success && Array.isArray(F5A_P1_DATA.data)){
              const normalizeName = (s)=>{
                try{
                  const raw = String(s||'').trim();
                  const noAcc = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                  return noAcc.replace(/\s+/g,' ').trim();
                }catch(_){ return String(s||'').toLowerCase().trim(); }
              };
              const targetNameNorm = normalizeName(displayName);
              const empData = F5A_P1_DATA.data.find(emp => {
                const empName = emp['Ph·ª• tr√°ch'] || emp.name || '';
                return normalizeName(empName) === targetNameNorm;
              });
              if (empData && empData.details && Array.isArray(empData.details.sameMonth)){
                return empData.details.sameMonth.length;
              }
            }
            // Fallback: t√≠nh t·ª´ raw data
            const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
            const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
            const targetKey = toKey(displayName);
            const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
            const parseDateFlexible = (v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
            const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
            const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
            const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
            const rqKeys = ['üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ','ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu ','requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date','submissiondate','submitteddate','submitdate','submit_date','ngayyeucau','ngay_yeu_cau','ngay yeu cau','ngaygui','ngay_gui','ng√†y g·ª≠i','Ng√†y g·ª≠i','createddate','created_date','creationdate','created','ngaytao','ngay_tao','ng√†y t·∫°o','Ng√†y t·∫°o','th·ªùi gian y√™u c·∫ßu','th·ªùi ƒëi·ªÉm y√™u c·∫ßu'];
            const statusKeys = ['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
            const doneKeys = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
            const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(done); };
            let cnt = 0;
            rows.forEach(o=>{
              if (isCanceled(o)) return;
              const emp = getV(o, assigneeKeys); const rk = toKey(emp);
              if (rk !== targetKey) return;
              const rq = getV(o, rqKeys); let d = parseDateFlexible(rq); let ds = d? iso(d):'';
              if (!inRange(ds)) {
                try{
                  let found = '';
                  for (const v of Object.values(o||{})){
                    const dv = parseDateFlexible(v); if (!dv) continue; const svi = iso(dv); if (inRange(svi)) { found = svi; break; }
                  }
                  if (found){ cnt++; return; }
                }catch(_){ }
                return;
              }
              cnt++;
            });
            return cnt;
          }catch(_){ return 0; }
        };
        
        sortedList.forEach(item=>{
          // S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ n8n (ƒë√£ ƒë∆∞·ª£c aggregate v√† t√≠nh to√°n s·∫µn) - gi·ªëng renderForm5All
          const name = item['Ph·ª• tr√°ch'] || item.name || '';
          const ahead = Number(item.ahead || 0);
          const ontime = Number(item.ontime || 0);
          const late = Number(item.late || 0);
          const na = Number(item.na || 0);
          // % t·ª´ n8n (ƒë√£ l√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n)
          const rAhead = Number(item.rateAhead || 0);
          const rOn = Number(item.rateOntime || 0);
          const rLate = Number(item.rateLate || 0);
          const rNA = Number(item.rateNA || 0);
          const doneCnt = Number(item.doneCnt || 0);
          aoa.push([
            name,
            doneCnt,
            ahead,
            ontime,
            late,
            na,
            rAhead.toFixed(1) + '%',
            rOn.toFixed(1) + '%',
            rLate.toFixed(1) + '%',
            rNA.toFixed(1) + '%'
          ]);
        });
        // T·ªïng cu·ªëi (ƒë·ªìng b·ªô th·ª© t·ª± c·ªôt, s·ª≠ d·ª•ng sortedList ƒë·ªÉ t√≠nh t·ªïng)
        const sumAhead = sortedList.reduce((a,it)=> a + Number(it.ahead||0), 0);
        const sumOn = sortedList.reduce((a,it)=> a + Number(it.ontime||0), 0);
        const sumLate = sortedList.reduce((a,it)=> a + Number(it.late||0), 0);
        const sumDone = sortedList.reduce((a,it)=> a + Number(it.doneCnt || ((Number(it.ahead||0) + Number(it.ontime||0) + Number(it.late||0)))), 0);
        const sumNA = sortedList.reduce((a,it)=> a + Number(it.na||0), 0);
        // T√≠nh t·ªïng t·ª∑ l·ªá (trung b√¨nh)
        const sumRateAhead = sortedList.length > 0 ? sortedList.reduce((a,it)=> a + Number(it.rateAhead||0), 0) / sortedList.length : 0;
        const sumRateOn = sortedList.length > 0 ? sortedList.reduce((a,it)=> a + Number(it.rateOntime||0), 0) / sortedList.length : 0;
        const sumRateLate = sortedList.length > 0 ? sortedList.reduce((a,it)=> a + Number(it.rateLate||0), 0) / sortedList.length : 0;
        const sumRateNA = sortedList.length > 0 ? sortedList.reduce((a,it)=> a + Number(it.rateNA||0), 0) / sortedList.length : 0;
        aoa.push(['T·ªîNG', sumDone, sumAhead, sumOn, sumLate, sumNA, sumRateAhead.toFixed(1) + '%', sumRateOn.toFixed(1) + '%', sumRateLate.toFixed(1) + '%', sumRateNA.toFixed(1) + '%' ]);
        return aoa;
      }
      function f5aDownloadXLSX(rows){
        try{
          const wb = XLSX.utils.book_new();
          const month = (document.getElementById('f5a-month')?.value || '').replace(/\s+/g,'');
          // Sheet P1 - S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ F5A_P1_DATA n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng rows
          let p1Data = rows;
          if (F5A_P1_DATA && F5A_P1_DATA.data && Array.isArray(F5A_P1_DATA.data) && F5A_P1_DATA.data.length > 0) {
            p1Data = F5A_P1_DATA.data;
          }
          const aoa = f5aRowsToAOA(p1Data);
          if (aoa && aoa.length > 1) { // C√≥ header v√† √≠t nh·∫•t 1 d√≤ng d·ªØ li·ªáu
            const wsAll = XLSX.utils.aoa_to_sheet(aoa);
            XLSX.utils.book_append_sheet(wb, wsAll, 'P1');
          }
          // Sheet b·∫£ng ph·ª• - Ho√†n th√†nh (l·ªçc theo ng√†y ho√†n th√†nh, chia nh√≥m theo ng√†y nh·∫≠n)
          (function appendDetailDoneSheet(){
            try{
              let fromVal = '', toVal = '';
              try{ const m=(document.getElementById('f5a-month')?.value||'').trim(); if(m){ const [yy,mm]=m.split('-'); fromVal=`${yy}-${mm}-01`; const last=new Date(Number(yy), Number(mm), 0).getDate(); toVal=`${yy}-${mm}-${String(last).padStart(2,'0')}`; } }catch(_){ }
              const rowsRaw = Array.isArray(F5A_RAW_ALL)? F5A_RAW_ALL: [];
              const getV=(obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
              const toDate=(v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
              const iso=(d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
              const inRange=(ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
              const noAcc=(s)=>{ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } };
              const sameName=(a,b)=> noAcc(a).replace(/\s+/g,' ').trim() === noAcc(b).replace(/\s+/g,' ').trim();
              const empKeys=['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
              const rqKeys=[
                'üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ',
                'ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu ',
                'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
                'submissiondate','submitteddate','submitdate','submit_date',
                'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
                'ngaygui','ngay_gui','ng√†y g·ª≠i','Ng√†y g·ª≠i',
                'createddate','created_date','creationdate','created',
                'ngaytao','ngay_tao','ng√†y t·∫°o','Ng√†y t·∫°o'
              ];
              const codeKeys=['code','ma','taskcode','m√£'];
              const tnameKeys=['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','taskname','ten_tac_vu','ten','name','title'];
              const manKeys=['ƒêi·ªÉm','Score','score','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n ','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n','C√¥ng chu·∫©n','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
              const actualKeys=['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','so gio danh gia thuc te','s·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
              const wishKeys=['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën','H·∫°n mong mu·ªën ','H·∫°n mong mu·ªën'];
              const doneKeys=['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
              const statusKeys=['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
              const isCanceled=(o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(dn); };
              const head=['Nh√¢n vi√™n','Nh√≥m theo ng√†y nh·∫≠n','M√£','T√™n t√°c v·ª•','Ng√†y y√™u c·∫ßu','S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','C√¥ng chu·∫©n','H·∫°n mong mu·ªën','H·∫°n +1','Ng√†y ho√†n th√†nh','Tr·∫°ng th√°i theo c√¥ng chu·∫©n'];
              const aoaD=[head];
              rowsRaw.forEach(o=>{
                if (isCanceled(o)) return;
                const done = getV(o, doneKeys); const dD = toDate(done); const doneIso = dD? iso(dD):''; if (!inRange(doneIso)) return;
                const emp = getV(o, empKeys);
                const rq = getV(o, rqKeys); const rqD = toDate(rq); const rqIso = rqD? iso(rqD):'';
                const grp = (rqIso && inRange(rqIso)) ? 'Nh·∫≠n trong th√°ng' : 'Nh·∫≠n th√°ng tr∆∞·ªõc';
                const code=getV(o, codeKeys);
                const tn=getV(o, tnameKeys);
                const man=getV(o, manKeys);
                const act=getV(o, actualKeys);
                const wish=getV(o, wishKeys);
                let wishP1=''; try{ const dW=toDate(wish); if(dW){ const p1=new Date(dW.getFullYear(), dW.getMonth(), dW.getDate()+1); const pad=n=>String(n).padStart(2,'0'); wishP1=`${pad(p1.getDate())}/${pad(p1.getMonth()+1)}/${p1.getFullYear()}`; } }catch(_){ }
                // T√≠nh "Tr·∫°ng th√°i theo c√¥ng chu·∫©n" gi·ªëng modal P1
                const toNum=(s)=>{ try{ const t=String(s||'').trim().replace(/[^0-9.,-]/g,'').replace(',', '.'); const n=parseFloat(t); return Number.isFinite(n)? n: 0; }catch(_){ return 0; } };
                let stByMan = '';
                try{
                  const actualNum = toNum(act);
                  const manNum = toNum(man);
                  const EPS = 1e-4;
                  const hasDone = !!toDate(done);
                  const actualIsZero = Number.isFinite(actualNum) && Math.abs(actualNum) < 1e-9;
                  if (actualIsZero){
                    stByMan = 'Thi·∫øu d·ªØ li·ªáu';
                  } else if (hasDone && Number.isFinite(actualNum) && Number.isFinite(manNum)){
                    const tolerance = Math.max(EPS, Math.abs(manNum) * 0.10);
                    if (actualNum > manNum + tolerance) stByMan = 'Ch·∫≠m ti·∫øn ƒë·ªô';
                    else if (Math.abs(actualNum - manNum) <= tolerance) stByMan = 'ƒê√∫ng ti·∫øn ƒë·ªô';
                    else stByMan = 'V∆∞·ª£t ti·∫øn ƒë·ªô';
                  }
                }catch(_){ }
                const fmt=(v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
                aoaD.push([ emp, grp, code, tn, fmt(rq), act, man, wish, wishP1, fmt(done), stByMan ]);
              });
              // Ch·ªâ th√™m sheet n·∫øu c√≥ d·ªØ li·ªáu (√≠t nh·∫•t c√≥ header v√† 1 d√≤ng d·ªØ li·ªáu)
              if (aoaD && aoaD.length > 1) {
                const ws = XLSX.utils.aoa_to_sheet(aoaD);
                XLSX.utils.book_append_sheet(wb, ws, 'B·∫£ng ph·ª• P1');
              }
            }catch(_){ }
          })();
          // Sheet b·∫£ng ph·ª• - Nh·∫≠n th√°ng (l·ªçc theo ng√†y y√™u c·∫ßu, lo·∫°i Cancel)
          (function appendDetailReceivedSheet(){
            try{
              let fromVal = '', toVal = '';
              try{ const m=(document.getElementById('f5a-month')?.value||'').trim(); if(m){ const [yy,mm]=m.split('-'); fromVal=`${yy}-${mm}-01`; const last=new Date(Number(yy), Number(mm), 0).getDate(); toVal=`${yy}-${mm}-${String(last).padStart(2,'0')}`; } }catch(_){ }
              const rowsRaw = Array.isArray(F5A_RAW_ALL)? F5A_RAW_ALL: [];
              const getV=(obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
              const toDate=(v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
              const iso=(d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
              const inRange=(ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
              const empKeys=['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
              const rqKeys=['üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ','ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui'];
              const codeKeys=['code','ma','taskcode','m√£'];
              const tnameKeys=['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','taskname','ten_tac_vu','ten','name','title'];
              const manKeys=['ƒêi·ªÉm','Score','score','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n ','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n','C√¥ng chu·∫©n','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
              const actualKeys=['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','so gio danh gia thuc te','s·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
              const wishKeys=['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën','H·∫°n mong mu·ªën ','H·∫°n mong mu·ªën'];
              const doneKeys=['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
              const statusKeys=['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
              const isCanceled=(o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(dn); };
              const head=['Nh√¢n vi√™n','M√£','T√™n t√°c v·ª•','Ng√†y y√™u c·∫ßu','C√¥ng chu·∫©n','S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','H·∫°n mong mu·ªën','Ng√†y ho√†n th√†nh','Tr·∫°ng th√°i'];
              const aoaR=[head];
              rowsRaw.forEach(o=>{
                if (isCanceled(o)) return;
                const rq = getV(o, rqKeys); const rqD = toDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
                const emp=getV(o, empKeys);
                const code=getV(o, codeKeys);
                const tn=getV(o, tnameKeys);
                const man=getV(o, manKeys);
                const act=getV(o, actualKeys);
                const wish=getV(o, wishKeys);
                const done=getV(o, doneKeys);
                const st=getV(o, statusKeys);
                const fmt=(v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
                aoaR.push([ emp, code, tn, fmt(rq), man, act, wish, fmt(done), st ]);
              });
              // Ch·ªâ th√™m sheet n·∫øu c√≥ d·ªØ li·ªáu (√≠t nh·∫•t c√≥ header v√† 1 d√≤ng d·ªØ li·ªáu)
              if (aoaR && aoaR.length > 1) {
                const ws = XLSX.utils.aoa_to_sheet(aoaR);
                XLSX.utils.book_append_sheet(wb, ws, 'B·∫£ng ph·ª• P1 - Nh·∫≠n th√°ng');
              }
            }catch(_){ }
          })();
          
          // Sheet b·∫£ng ph·ª• P2 - Nh·∫≠n th√°ng (l·ªçc theo ng√†y y√™u c·∫ßu, lo·∫°i Cancel, ch·ªâ l·∫•y nh√¢n vi√™n trong P2)
          (function appendDetailP2ReceivedSheet(){
            try{
              let fromVal = '', toVal = '';
              try{ const m=(document.getElementById('f5a-month')?.value||'').trim(); if(m){ const [yy,mm]=m.split('-'); fromVal=`${yy}-${mm}-01`; const last=new Date(Number(yy), Number(mm), 0).getDate(); toVal=`${yy}-${mm}-${String(last).padStart(2,'0')}`; } }catch(_){ }
              const rowsRaw = Array.isArray(F5A_RAW_ALL)? F5A_RAW_ALL: [];
              
              // L·∫•y danh s√°ch nh√¢n vi√™n t·ª´ P2 (ƒë√£ l·ªçc blacklist)
              const p2Names = new Set();
              if (F5A_P2_DATA && F5A_P2_DATA.data && Array.isArray(F5A_P2_DATA.data)) {
                F5A_P2_DATA.data.forEach(item => {
                  const name = item.name || item['Ph·ª• tr√°ch'] || '';
                  if (name && !isNameInBlacklist(name)) {
                    p2Names.add(name);
                  }
                });
              }
              
              // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu P2, kh√¥ng t·∫°o sheet
              if (p2Names.size === 0) return;
              
              const getV=(obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
              const toDate=(v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
              const iso=(d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
              const inRange=(ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
              const noAcc=(s)=>{ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } };
              const sameName=(a,b)=> noAcc(a).replace(/\s+/g,' ').trim() === noAcc(b).replace(/\s+/g,' ').trim();
              const empKeys=['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
              const rqKeys=['üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ','ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui'];
              const codeKeys=['code','ma','taskcode','m√£'];
              const tnameKeys=['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','taskname','ten_tac_vu','ten','name','title'];
              const manKeys=['ƒêi·ªÉm','Score','score','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n ','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n','C√¥ng chu·∫©n','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
              const actualKeys=['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','so gio danh gia thuc te','s·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
              const wishKeys=['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën','H·∫°n mong mu·ªën ','H·∫°n mong mu·ªën'];
              const doneKeys=['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
              const statusKeys=['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
              const isCanceled=(o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(dn); };
              const head=['Nh√¢n vi√™n','M√£','T√™n t√°c v·ª•','Ng√†y y√™u c·∫ßu','C√¥ng chu·∫©n','S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','H·∫°n mong mu·ªën','Ng√†y ho√†n th√†nh','Tr·∫°ng th√°i'];
              const aoaP2=[head];
              rowsRaw.forEach(o=>{
                if (isCanceled(o)) return;
                const rq = getV(o, rqKeys); const rqD = toDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
                const emp=getV(o, empKeys);
                // Ch·ªâ l·∫•y nh√¢n vi√™n trong P2
                if (!emp || !p2Names.has(emp)) return;
                const code=getV(o, codeKeys);
                const tn=getV(o, tnameKeys);
                const man=getV(o, manKeys);
                const act=getV(o, actualKeys);
                const wish=getV(o, wishKeys);
                const done=getV(o, doneKeys);
                const st=getV(o, statusKeys);
                const fmt=(v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
                aoaP2.push([ emp, code, tn, fmt(rq), man, act, wish, fmt(done), st ]);
              });
              // Ch·ªâ th√™m sheet n·∫øu c√≥ d·ªØ li·ªáu (√≠t nh·∫•t c√≥ header v√† 1 d√≤ng d·ªØ li·ªáu)
              if (aoaP2 && aoaP2.length > 1) {
                const ws = XLSX.utils.aoa_to_sheet(aoaP2);
                XLSX.utils.book_append_sheet(wb, ws, 'B·∫£ng ph·ª• P2');
              }
            }catch(_){ }
          })();
          
          // B·ªè t·∫°o sheet ri√™ng t·ª´ng nh√¢n vi√™n; ƒë√£ c√≥ 3 b·∫£ng ph·ª• ·ªü tr√™n theo y√™u c·∫ßu
          
          // Add P2 sheet - Lu√¥n th√™m n·∫øu c√≥ d·ªØ li·ªáu t·ª´ F5A_P2_DATA
          try{
            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu P2 kh√¥ng
            if (F5A_P2_DATA && F5A_P2_DATA.data && Array.isArray(F5A_P2_DATA.data) && F5A_P2_DATA.data.length > 0) {
              const aoaP2 = f5aExportP2ToAOA();
              // Ki·ªÉm tra n·∫øu c√≥ d·ªØ li·ªáu th·ª±c s·ª± (kh√¥ng ph·∫£i ch·ªâ l√† th√¥ng b√°o l·ªói)
              if (aoaP2 && aoaP2.length > 1 && 
                  !(aoaP2.length === 2 && aoaP2[1] && Array.isArray(aoaP2[1]) && 
                    aoaP2[1][0] && String(aoaP2[1][0]).includes('Ch∆∞a c√≥ d·ªØ li·ªáu'))) {
                const wsP2 = XLSX.utils.aoa_to_sheet(aoaP2);
                XLSX.utils.book_append_sheet(wb, wsP2, 'P2');
              }
            }
          }catch(err){
            console.error('[Export] P2 sheet error:', err);
          }
          
          // Add P3 sheet
          try{
            const aoaP3 = f5aExportP3ToAOA();
            // Ch·ªâ th√™m sheet n·∫øu c√≥ d·ªØ li·ªáu (√≠t nh·∫•t c√≥ header v√† 1 d√≤ng d·ªØ li·ªáu ho·∫∑c h√†ng t·ªïng)
            if (aoaP3 && aoaP3.length > 1 && !(aoaP3.length === 2 && aoaP3[1] && Array.isArray(aoaP3[1]) && aoaP3[1][0] && String(aoaP3[1][0]).includes('Ch∆∞a c√≥ d·ªØ li·ªáu'))) {
              const wsP3 = XLSX.utils.aoa_to_sheet(aoaP3);
              XLSX.utils.book_append_sheet(wb, wsP3, 'P3');
            }
          }catch(err){
            console.error('[Export] P3 sheet error:', err);
          }
          
          // Add P4 sheet
          try{
            const aoaP4 = f5aExportP4ToAOA();
            // Ch·ªâ th√™m sheet n·∫øu c√≥ d·ªØ li·ªáu (√≠t nh·∫•t c√≥ header v√† 1 d√≤ng d·ªØ li·ªáu ho·∫∑c h√†ng t·ªïng)
            if (aoaP4 && aoaP4.length > 1 && !(aoaP4.length === 2 && aoaP4[1] && Array.isArray(aoaP4[1]) && aoaP4[1][0] && String(aoaP4[1][0]).includes('Ch∆∞a c√≥ d·ªØ li·ªáu'))) {
              const wsP4 = XLSX.utils.aoa_to_sheet(aoaP4);
              XLSX.utils.book_append_sheet(wb, wsP4, 'P4');
            }
          }catch(err){
            console.error('[Export] P4 sheet error:', err);
          }
          
          // Add chi ti·∫øt P1 - Ho√†n th√†nh (t·ª´ modal)
          try{
            const aoaP1Detail = f5aExportP1DetailToAOA();
            if (aoaP1Detail && aoaP1Detail.length > 1) {
              const wsP1Detail = XLSX.utils.aoa_to_sheet(aoaP1Detail);
              XLSX.utils.book_append_sheet(wb, wsP1Detail, 'Chi ti·∫øt P1');
            }
          }catch(err){
            console.error('[Export] P1 Detail sheet error:', err);
          }
          
          // Add chi ti·∫øt P2 - Nh·∫≠n th√°ng (t·ª´ modal)
          try{
            const aoaP2Detail = f5aExportP2DetailToAOA();
            if (aoaP2Detail && aoaP2Detail.length > 1) {
              const wsP2Detail = XLSX.utils.aoa_to_sheet(aoaP2Detail);
              XLSX.utils.book_append_sheet(wb, wsP2Detail, 'Chi ti·∫øt P2');
            }
          }catch(err){
            console.error('[Export] P2 Detail sheet error:', err);
          }
          
          // Add chi ti·∫øt P3 (t·ª´ modal)
          try{
            const aoaP3Detail = f5aExportP3DetailToAOA();
            if (aoaP3Detail && aoaP3Detail.length > 1) {
              const wsP3Detail = XLSX.utils.aoa_to_sheet(aoaP3Detail);
              XLSX.utils.book_append_sheet(wb, wsP3Detail, 'Chi ti·∫øt P3');
            }
          }catch(err){
            console.error('[Export] P3 Detail sheet error:', err);
          }
          
          XLSX.writeFile(wb, `Form5_All_${month||'export'}.xlsx`);
        }catch(_){ showToast('Xu·∫•t XLSX th·∫•t b·∫°i.','error'); }
      }
      (function initF5aFileExports(){
        const btnXlsx = document.getElementById('f5a-export-xlsx');
        if (btnXlsx) btnXlsx.addEventListener('click', (e)=>{ 
          e.preventDefault(); 
          // ∆Øu ti√™n s·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ F5A_P1_DATA n·∫øu c√≥
          let rows = [];
          if (F5A_P1_DATA && F5A_P1_DATA.data && Array.isArray(F5A_P1_DATA.data) && F5A_P1_DATA.data.length > 0) {
            rows = F5A_P1_DATA.data;
          } else if (Array.isArray(F5A_LAST_ROWS) && F5A_LAST_ROWS.length > 0) {
            rows = F5A_LAST_ROWS;
          }
          if(!rows.length){ showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.','error'); return; } 
          f5aDownloadXLSX(rows); 
        });
      })();
      
      // Helper functions to export P2, P3 and P4 data
      function f5aExportP2ToAOA(){
        try{
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          if(!F5A_P2_DATA || !F5A_P2_DATA.data || !Array.isArray(F5A_P2_DATA.data) || !F5A_P2_DATA.data.length){
            return [['Ch∆∞a c√≥ d·ªØ li·ªáu P2. Vui l√≤ng nh·∫•n "Tra c·ª©u P2" tr∆∞·ªõc.']];
          }
          
          const data = F5A_P2_DATA.data;
          
          // L·ªçc b·ªè c√°c nh√¢n vi√™n trong blacklist
          const filteredData = data.filter(item => {
            const name = item.name || item['Ph·ª• tr√°ch'] || '';
            return !isNameInBlacklist(name);
          });
          
          // Helper function ƒë·ªÉ parse s·ªë t·ª´ format "48,00"
          const parseNumber = (str) => {
            if (!str) return 0;
            const cleaned = String(str).replace(/[^0-9.,-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
          };
          
          // Helper function ƒë·ªÉ format s·ªë v·ªõi d·∫•u ph·∫©y
          const formatNumber = (num) => {
            if (!Number.isFinite(num)) return '';
            return num.toFixed(2).replace('.', ',');
          };
          
          // Helper function ƒë·ªÉ format coefficient v·ªõi d·∫•u ph·∫©y
          const formatCoefficient = (coef) => {
            if (!coef || coef === '') return '';
            // X·ª≠ l√Ω d·∫•u ph·∫©y: chuy·ªÉn d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m tr∆∞·ªõc khi parse
            let cleaned = String(coef).trim();
            // N·∫øu c√≥ d·∫•u ph·∫©y v√† kh√¥ng c√≥ d·∫•u ch·∫•m, thay d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m
            if (cleaned.includes(',') && !cleaned.includes('.')) {
              cleaned = cleaned.replace(',', '.');
            }
            // N·∫øu c√≥ c·∫£ d·∫•u ph·∫©y v√† d·∫•u ch·∫•m, lo·∫°i b·ªè d·∫•u ch·∫•m (d·∫•u ph·∫©y l√† d·∫•u ph√¢n c√°ch h√†ng ngh√¨n)
            else if (cleaned.includes(',') && cleaned.includes('.')) {
              cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            }
            const num = parseFloat(cleaned);
            if (isNaN(num)) return '';
            return num.toFixed(2).replace('.', ',');
          };
          
          // Sort P2 theo H·ªá s·ªë t·ª´ l·ªõn ƒë·∫øn nh·ªè (gi·ªëng nh∆∞ render)
          const sortedData = filteredData.slice().sort((a, b) => {
            const coefA = parseFloat(a.coefficient || '0');
            const coefB = parseFloat(b.coefficient || '0');
            // N·∫øu h·ªá s·ªë b·∫±ng nhau, sort theo t√™n
            if (coefB === coefA) {
              const nameA = (a.name || a['Ph·ª• tr√°ch'] || '').trim();
              const nameB = (b.name || b['Ph·ª• tr√°ch'] || '').trim();
              return nameA.localeCompare(nameB, 'vi');
            }
            return coefB - coefA;
          });
          
          const headers = ['STT','Nh√¢n vi√™n','S·ªë t√°c v·ª• trong th√°ng','T·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','C√¥ng chu·∫©n ƒë√£ nh·∫≠n','T·ªïng gi·ªù c√¥ng ƒëi l√†m','H·ªá s·ªë'];
          const aoa = [headers];
          
          let sumCount = 0;
          let sumActualHours = 0;
          let sumManhour = 0;
          let sumWorkHours = 0;
          
          sortedData.forEach((item, index) => {
            const stt = index + 1;
            const name = item.name || item['Ph·ª• tr√°ch'] || '';
            const taskCount = Number(item.taskCount || item.count || 0);
            const totalActualHours = item.totalActualHours || item['T·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '0,00';
            const manhourReceived = item.manhourReceived || item['C√¥ng chu·∫©n ƒë√£ nh·∫≠n'] || item['T·ªïng c√¥ng chu·∫©n'] || '0,00';
            const totalWorkHours = item.totalWorkHours || item['T·ªïng gi·ªù c√¥ng ƒëi l√†m'] || '';
            const coefficient = item.coefficient || '';
            const coefficientFormatted = formatCoefficient(coefficient);
            
            // T√≠nh t·ªïng (parse t·ª´ string)
            sumCount += taskCount;
            sumActualHours += parseNumber(totalActualHours);
            sumManhour += parseNumber(manhourReceived);
            if (totalWorkHours) {
              sumWorkHours += parseNumber(totalWorkHours);
            }
            
            aoa.push([
              stt,
              name,
              taskCount,
              totalActualHours,
              manhourReceived,
              totalWorkHours || '-',
              coefficientFormatted || '-'
            ]);
          });
          
          // Th√™m h√†ng t·ªïng
          const sumCoefficient = (sumWorkHours > 0) ? formatNumber(sumManhour / sumWorkHours) : '';
          aoa.push([
            'T·ªîNG',
            '',
            sumCount,
            formatNumber(sumActualHours),
            formatNumber(sumManhour),
            sumWorkHours > 0 ? formatNumber(sumWorkHours) : '',
            sumCoefficient
          ]);
          
          return aoa;
        }catch(err){
          console.error('[P2 Export] Error:', err);
          return [['L·ªói xu·∫•t d·ªØ li·ªáu P2']];
        }
      }
      
      function f5aExportP3ToAOA(){
        try{
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          if(!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length){
            return [['Ch∆∞a c√≥ d·ªØ li·ªáu P3. Vui l√≤ng nh·∫•n "Tra c·ª©u P3" tr∆∞·ªõc.']];
          }
          
          // Helper functions
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
              return new Date(s);
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          };
          
          // Aggregate by employee
          const byName = new Map();
          
          F5A_P3_RAW.forEach(r => {
            // Get assignee name
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            if(!name) return;
            
            // Skip tasks assigned to "x" (pending tasks)
            if(name.toLowerCase() === 'x') {
              return;
            }
            
            // Get completion date
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh',
              'completion date','completiondate',
              'actual completion date','actualcompletiondate'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            
            // Filter by month if specified
            if(monthVal && completionDate){
              const taskMonth = formatYyyyMm(completionDate);
              if(taskMonth !== monthVal) return; // Skip if not in selected month
            } else if(monthVal && !completionDate) {
              return; // Skip tasks without completion date when month filter is active
            }
            
            // Get CE review status
            const ceReview = String(getV(r, [
              'ce r√† so√°t','ce ra soat','cerasoat',
              'ce review','cereview',
              'r√† so√°t ce','ra soat ce','rasotce',
              't√¨nh tr·∫°ng ce','tinh trang ce'
            ])||'').trim();
            
            // Initialize record if not exists
            if(!byName.has(name)){
              byName.set(name, { 
                name, 
                total: 0,
                completed: 0, 
                notNeeded: 0, 
                pending: 0
              });
            }
            
            const rec = byName.get(name);
            
            // Count by CE review status
            const ceNorm = norm(ceReview);
            if(ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui' || ceNorm === 'dagui'){
              rec.completed += 1;
            } else if(ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can' || ceNorm === 'khongcan'){
              rec.notNeeded += 1;
            } else if(!ceReview || ceReview === ''){
              rec.pending += 1;
            }
            
            // Total = sum of completed + notNeeded + pending
            rec.total = rec.completed + rec.notNeeded + rec.pending;
          });
          
          // Build AOA
          const headers = ['T√™n nh√¢n vi√™n', 'S·ªë t√°c v·ª• ho√†n th√†nh th√°ng', 'T√°c v·ª• ƒë√£ ho√†n thi·ªán CE', 'T√°c v·ª• kh√¥ng c·∫ßn l√†m CE', 'Ch∆∞a ho√†n th√†nh', 'Th·∫ª P3/R√† so√°t CE (%)'];
          const aoa = [headers];
          
          const sorted = Array.from(byName.values()).sort((a,b) => a.name.localeCompare(b.name, 'vi'));
          
          let sumTotal = 0, sumCompleted = 0, sumNotNeeded = 0, sumPending = 0;
          
          sorted.forEach(rec => {
            // Calculate percentage (gi·ªëng renderForm5P3)
            const percentage = rec.total > 0 ? Math.round(((rec.completed + rec.notNeeded) / rec.total) * 100) : 0;
            
            aoa.push([
              rec.name,
              rec.total,
              rec.completed,
              rec.notNeeded,
              rec.pending,
              `${percentage}%`
            ]);
            
            sumTotal += rec.total;
            sumCompleted += rec.completed;
            sumNotNeeded += rec.notNeeded;
            sumPending += rec.pending;
          });
          
          // Total row (gi·ªëng renderForm5P3)
          const totalPercentage = sumTotal > 0 ? Math.round(((sumCompleted + sumNotNeeded) / sumTotal) * 100) : 0;
          aoa.push([
            'T·ªîNG',
            sumTotal,
            sumCompleted,
            sumNotNeeded,
            sumPending,
            `${totalPercentage}%`
          ]);
          
          return aoa;
        }catch(err){
          console.error('[P3 Export] Error:', err);
          return [['L·ªói xu·∫•t d·ªØ li·ªáu P3']];
        }
      }
      
      function f5aExportP4ToAOA(){
        try{
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          if(!Array.isArray(F5A_P4_RAW) || !F5A_P4_RAW.length){
            return [['Ch∆∞a c√≥ d·ªØ li·ªáu P4. Vui l√≤ng nh·∫•n "Tra c·ª©u P4" tr∆∞·ªõc.']];
          }
          
          // Helper functions
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
              return new Date(s);
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          };
          
          const parsePercent = (v) => {
            try{
              if(!v) return 0;
              const s = String(v).trim();
              const num = parseFloat(s);
              if(isNaN(num)) return 0;
              // If already in 0-1 range, convert to 0-100
              if(num >= 0 && num <= 1) return num * 100;
              // If in 0-100 range, use as is
              if(num >= 0 && num <= 100) return num;
              return 0;
            }catch(_){ return 0; }
          };
          
          // Aggregate by employee
          const byName = new Map();
          
          F5A_P4_RAW.forEach(r => {
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            if(!name || name.toLowerCase() === 'x') return;
            
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            
            if(monthVal && completionDate){
              const taskMonth = formatYyyyMm(completionDate);
              if(taskMonth !== monthVal) return;
            } else if(monthVal && !completionDate) {
              return;
            }
            
            // Ch·ªâ l·∫•y c√°c t√°c v·ª• c√≥ "Ph√¢n lo·∫°i" = "S·∫£n ph·∫©m"
            const classification = String(getV(r, [ 'Ph√¢n lo·∫°i','phan loai','phanloai','classification','loai','lo·∫°i' ])||'').trim();
            const clsNorm = classification.toLowerCase();
            if (clsNorm !== 'san pham' && clsNorm !== 's·∫£n ph·∫©m') return;
            
            // Check "4M r√† so√°t"
            const rasoat4m = String(getV(r, [
              '4M r√† so√°t','4m r√† so√°t','4m ra soat',
              '4M','4m rasoat'
            ])||'').trim();
            
            if(!rasoat4m) return; // Only count tasks with 4M data
            
            if(!byName.has(name)){
              byName.set(name, {
                name,
                totalTasks: 0,
                tcktCompleted: 0, tcktTotal: 0,
                ceCompleted: 0, ceTotal: 0,
                hdktCompleted: 0, hdktTotal: 0,
                bbCompleted: 0, bbTotal: 0,
                jigCompleted: 0, jigTotal: 0,
                khksclCompleted: 0, khksclTotal: 0,
                notNeeded4m: 0
              });
            }
            
            const rec = byName.get(name);
            rec.totalTasks++;
            
            // Check if "4M r√† so√°t" = "Kh√¥ng c·∫ßn"
            const fourMStatus = String(rasoat4m).trim();
            const fourMNorm = fourMStatus.toLowerCase();
            if(fourMNorm.includes('khong can') || fourMNorm.includes('kh√¥ng c·∫ßn')) {
              rec.notNeeded4m += 1;
            }
            
            // Parse percentages
            const tckt = parsePercent(getV(r, ['TCKT(% ho√†n th√†nh)','tckt','tckt%']));
            const ce = parsePercent(getV(r, ['CE(% ho√†n th√†nh)','ce','ce%']));
            const hdkt = parsePercent(getV(r, ['HDKT(% ho√†n th√†nh)','hdkt','hdkt%']));
            const bb = parsePercent(getV(r, ['BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb dao tao','bb%']));
            const jig = parsePercent(getV(r, ['Jig tool(% ho√†n th√†nh)','jig tool','jig%']));
            const khkscl = parsePercent(getV(r, ['KHKSCL(% ho√†n th√†nh)','khkscl','khkscl%']));
            
            // Accumulate
            if(tckt > 0) { rec.tcktCompleted += tckt; rec.tcktTotal++; }
            if(ce > 0) { rec.ceCompleted += ce; rec.ceTotal++; }
            if(hdkt > 0) { rec.hdktCompleted += hdkt; rec.hdktTotal++; }
            if(bb > 0) { rec.bbCompleted += bb; rec.bbTotal++; }
            if(jig > 0) { rec.jigCompleted += jig; rec.jigTotal++; }
            if(khkscl > 0) { rec.khksclCompleted += khkscl; rec.khksclTotal++; }
          });
          
          // Build AOA
          const headers = ['T√™n nh√¢n vi√™n', 'T·ªïng t√°c v·ª• m√°y', 'T√°c v·ª• kh√¥ng c·∫ßn khai b√°o', 'TCKT(% ho√†n th√†nh)', 'CE(% ho√†n th√†nh)', 'HDKT(% ho√†n th√†nh)', 'BB ƒë√†o t·∫°o(% ho√†n th√†nh)', 'Jig tool(% ho√†n th√†nh)', 'KHKSCL(% ho√†n th√†nh)', 'Th·∫ª P4 (%)'];
          const aoa = [headers];
          
          const sorted = Array.from(byName.values()).sort((a,b)=> a.name.localeCompare(b.name, 'vi'));
          
          let sumTotal = 0, sumNotNeeded = 0, sumTckt = 0, sumCe = 0, sumHdkt = 0, sumBb = 0, sumJig = 0, sumKhkscl = 0, sumP4 = 0;
          
          sorted.forEach(r => {
            const tcktPercentage = r.tcktTotal > 0 ? (r.tcktCompleted / r.tcktTotal).toFixed(2) : '0.00';
            const cePercentage = r.ceTotal > 0 ? (r.ceCompleted / r.ceTotal).toFixed(2) : '0.00';
            const hdktPercentage = r.hdktTotal > 0 ? (r.hdktCompleted / r.hdktTotal).toFixed(2) : '0.00';
            const bbPercentage = r.bbTotal > 0 ? (r.bbCompleted / r.bbTotal).toFixed(2) : '0.00';
            const jigPercentage = r.jigTotal > 0 ? (r.jigCompleted / r.jigTotal).toFixed(2) : '0.00';
            const khksclPercentage = r.khksclTotal > 0 ? (r.khksclCompleted / r.khksclTotal).toFixed(2) : '0.00';
            
            // Calculate P4 percentage (average of all 6, always divide by 6)
            const tcktVal = parseFloat(tcktPercentage);
            const ceVal = parseFloat(cePercentage);
            const hdktVal = parseFloat(hdktPercentage);
            const bbVal = parseFloat(bbPercentage);
            const jigVal = parseFloat(jigPercentage);
            const khksclVal = parseFloat(khksclPercentage);
            
            const totalSum = tcktVal + ceVal + hdktVal + bbVal + jigVal + khksclVal;
            const p4Percentage = (totalSum / 6).toFixed(2);
            
            aoa.push([
              r.name,
              r.totalTasks,
              r.notNeeded4m || 0,
              `${tcktPercentage}%`,
              `${cePercentage}%`,
              `${hdktPercentage}%`,
              `${bbPercentage}%`,
              `${jigPercentage}%`,
              `${khksclPercentage}%`,
              `${p4Percentage}%`
            ]);
            
            sumTotal += r.totalTasks;
            sumNotNeeded += (r.notNeeded4m || 0);
            sumTckt += parseFloat(tcktPercentage);
            sumCe += parseFloat(cePercentage);
            sumHdkt += parseFloat(hdktPercentage);
            sumBb += parseFloat(bbPercentage);
            sumJig += parseFloat(jigPercentage);
            sumKhkscl += parseFloat(khksclPercentage);
            sumP4 += parseFloat(p4Percentage);
          });
          
          // Total row
          const count = sorted.length;
          const avgTckt = count > 0 ? (sumTckt / count).toFixed(2) : '0.00';
          const avgCe = count > 0 ? (sumCe / count).toFixed(2) : '0.00';
          const avgHdkt = count > 0 ? (sumHdkt / count).toFixed(2) : '0.00';
          const avgBb = count > 0 ? (sumBb / count).toFixed(2) : '0.00';
          const avgJig = count > 0 ? (sumJig / count).toFixed(2) : '0.00';
          const avgKhkscl = count > 0 ? (sumKhkscl / count).toFixed(2) : '0.00';
          const avgP4 = count > 0 ? (sumP4 / count).toFixed(2) : '0.00';
          
          aoa.push([
            'T·ªîNG',
            sumTotal,
            sumNotNeeded,
            `${avgTckt}%`,
            `${avgCe}%`,
            `${avgHdkt}%`,
            `${avgBb}%`,
            `${avgJig}%`,
            `${avgKhkscl}%`,
            `${avgP4}%`
          ]);
          
          return aoa;
        }catch(err){
          console.error('[P4 Export] Error:', err);
          return [['L·ªói xu·∫•t d·ªØ li·ªáu P4']];
        }
      }
      
      // Export chi ti·∫øt P1 - Ho√†n th√†nh (t·ª´ modal openDetailModal)
      function f5aExportP1DetailToAOA(){
        try{
          if (!F5A_P1_DATA || !F5A_P1_DATA.data || !Array.isArray(F5A_P1_DATA.data) || !F5A_P1_DATA.data.length) {
            return [['Ch∆∞a c√≥ d·ªØ li·ªáu P1. Vui l√≤ng nh·∫•n "Tra c·ª©u P1" tr∆∞·ªõc.']];
          }
          
          const headers = ['Nh√¢n vi√™n', 'Nh√≥m', 'STT', 'M√£', 'T√™n t√°c v·ª•', 'Ng√†y y√™u c·∫ßu', 'S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø', 'C√¥ng chu·∫©n', 'Tr·∫°ng th√°i theo c√¥ng chu·∫©n', 'H·∫°n mong mu·ªën', 'H·∫°n +1', 'Ng√†y ho√†n th√†nh'];
          const aoa = [headers];
          
          const formatNumberVi = (num, minDec, maxDec) => {
            if (!Number.isFinite(num)) return '';
            const fixed = num.toFixed(maxDec);
            return fixed.replace(/\.?0+$/, '').replace('.', ',');
          };
          
          const formatDdMmYyyy = (v) => {
            try {
              if (!v) return '';
              const d = parseDateFlexible(v);
              if (!d) return String(v || '');
              const dd = String(d.getDate()).padStart(2, '0');
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const yyyy = d.getFullYear();
              return `${dd}/${mm}/${yyyy}`;
            } catch(_) { return String(v || ''); }
          };
          
          F5A_P1_DATA.data.forEach(emp => {
            const empName = emp['Ph·ª• tr√°ch'] || emp.name || '';
            if (!empName || isNameInBlacklist(empName)) return;
            if (!emp.details) return;
            
            const sameMonth = Array.isArray(emp.details.sameMonth) ? emp.details.sameMonth : [];
            const prevMonth = Array.isArray(emp.details.prevMonth) ? emp.details.prevMonth : [];
            
            let stt = 0;
            
            sameMonth.forEach(task => {
              const actualHoursDisp = Number.isFinite(task.actualNum) ? formatNumberVi(task.actualNum, 2, 2) : (task.actualHours || '');
              const manDisp = formatNumberVi(Number(task.man || 0), 2, 2);
              const wishDisp = formatDdMmYyyy(task.wish || '');
              let wishPlus1Disp = '';
              try {
                const dW = parseDateFlexible(task.wish);
                if (dW) {
                  const plus1 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 1);
                  wishPlus1Disp = formatDdMmYyyy(plus1);
                }
              } catch(_) {}
              const doneDisp = formatDdMmYyyy(task.done || '');
              const rqDisp = formatDdMmYyyy(task.rq || '');
              
              aoa.push([
                empName,
                'Nh·∫≠n trong th√°ng',
                ++stt,
                task.code || '',
                task.tname || '',
                rqDisp,
                actualHoursDisp,
                manDisp,
                task.statusByMan || '',
                wishDisp,
                wishPlus1Disp,
                doneDisp
              ]);
            });
            
            prevMonth.forEach(task => {
              const actualHoursDisp = Number.isFinite(task.actualNum) ? formatNumberVi(task.actualNum, 2, 2) : (task.actualHours || '');
              const manDisp = formatNumberVi(Number(task.man || 0), 2, 2);
              const wishDisp = formatDdMmYyyy(task.wish || '');
              let wishPlus1Disp = '';
              try {
                const dW = parseDateFlexible(task.wish);
                if (dW) {
                  const plus1 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 1);
                  wishPlus1Disp = formatDdMmYyyy(plus1);
                }
              } catch(_) {}
              const doneDisp = formatDdMmYyyy(task.done || '');
              const rqDisp = formatDdMmYyyy(task.rq || '');
              
              aoa.push([
                empName,
                'Nh·∫≠n th√°ng tr∆∞·ªõc',
                ++stt,
                task.code || '',
                task.tname || '',
                rqDisp,
                actualHoursDisp,
                manDisp,
                task.statusByMan || '',
                wishDisp,
                wishPlus1Disp,
                doneDisp
              ]);
            });
          });
          
          return aoa.length > 1 ? aoa : [['Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt P1']];
        }catch(err){
          console.error('[P1 Detail Export] Error:', err);
          return [['L·ªói xu·∫•t d·ªØ li·ªáu chi ti·∫øt P1']];
        }
      }
      
      // Export chi ti·∫øt P2 - Nh·∫≠n th√°ng (t·ª´ modal openRqDetailModal)
      function f5aExportP2DetailToAOA(){
        try{
          const headers = ['Nh√¢n vi√™n', 'STT', 'M√£', 'T√™n t√°c v·ª•', 'Ng√†y y√™u c·∫ßu', 'C√¥ng chu·∫©n', 'S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø', 'H·∫°n mong mu·ªën', 'Ng√†y ho√†n th√†nh', 'Tr·∫°ng th√°i'];
          const aoa = [headers];
          
          if (!F5A_P2_DATA || !F5A_P2_DATA.data || !Array.isArray(F5A_P2_DATA.data) || !F5A_P2_DATA.data.length) {
            return [['Ch∆∞a c√≥ d·ªØ li·ªáu P2. Vui l√≤ng nh·∫•n "Tra c·ª©u P2" tr∆∞·ªõc.']];
          }
          
          const formatDdMmYyyy = (v) => {
            try {
              if (!v) return '';
              const d = parseDateFlexible(v);
              if (!d) return String(v || '');
              const dd = String(d.getDate()).padStart(2, '0');
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const yyyy = d.getFullYear();
              return `${dd}/${mm}/${yyyy}`;
            } catch(_) { return String(v || ''); }
          };
          
          F5A_P2_DATA.data.forEach(item => {
            const name = item.name || item['Ph·ª• tr√°ch'] || '';
            if (!name || isNameInBlacklist(name)) return;
            
            const tasks = Array.isArray(item.tasks) ? item.tasks : [];
            let stt = 0;
            
            tasks.forEach(task => {
              const code = String(task['M√£'] || '').trim();
              const tname = String(task['T√™n t√°c v·ª•'] || '').trim();
              if (!tname) return;
              
              aoa.push([
                name,
                ++stt,
                code,
                tname,
                formatDdMmYyyy(task['Ng√†y y√™u c·∫ßu'] || ''),
                task['C√¥ng chu·∫©n'] || '',
                task['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '',
                formatDdMmYyyy(task['H·∫°n mong mu·ªën'] || ''),
                formatDdMmYyyy(task['Ng√†y ho√†n th√†nh'] || ''),
                task['K·∫øt qu·∫£'] || task['Tr·∫°ng th√°i'] || task['Hi·ªán tr·∫°ng'] || ''
              ]);
            });
          });
          
          return aoa.length > 1 ? aoa : [['Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt P2']];
        }catch(err){
          console.error('[P2 Detail Export] Error:', err);
          return [['L·ªói xu·∫•t d·ªØ li·ªáu chi ti·∫øt P2']];
        }
      }
      
      // Export chi ti·∫øt P3 (t·ª´ modal showP3TaskDetails)
      function f5aExportP3DetailToAOA(){
        try{
          if (!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length) {
            return [['Ch∆∞a c√≥ d·ªØ li·ªáu P3. Vui l√≤ng nh·∫•n "Tra c·ª©u P3" tr∆∞·ªõc.']];
          }
          
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          const headers = ['Nh√¢n vi√™n', 'Lo·∫°i CE', 'STT', 'M√£', 'T√™n t√°c v·ª•', 'Ng√†y ho√†n th√†nh', 'CE r√† so√°t'];
          const aoa = [headers];
          
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
              return new Date(s);
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          };
          
          const formatDdMmYyyy = (v) => {
            try {
              if (!v) return '';
              const d = parseDate(v);
              if (!d) return String(v || '');
              const dd = String(d.getDate()).padStart(2, '0');
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const yyyy = d.getFullYear();
              return `${dd}/${mm}/${yyyy}`;
            } catch(_) { return String(v || ''); }
          };
          
          const byEmployee = new Map();
          
          F5A_P3_RAW.forEach(r => {
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            if(!name || name.toLowerCase() === 'x') return;
            
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh',
              'completion date','completiondate',
              'actual completion date','actualcompletiondate'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            
            if(monthVal && completionDate){
              const taskMonth = formatYyyyMm(completionDate);
              if(taskMonth !== monthVal) return;
            } else if(monthVal && !completionDate) {
              return;
            }
            
            const ceReview = String(getV(r, [
              'ce r√† so√°t','ce ra soat','cerasoat',
              'ce review','cereview',
              'r√† so√°t ce','ra soat ce','rasotce',
              't√¨nh tr·∫°ng ce','tinh trang ce'
            ])||'').trim();
            
            const ceNorm = norm(ceReview);
            let ceType = 'Ch∆∞a ho√†n th√†nh';
            if(ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui' || ceNorm === 'dagui'){
              ceType = 'ƒê√£ g·ª≠i';
            } else if(ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can' || ceNorm === 'khongcan'){
              ceType = 'Kh√¥ng c·∫ßn';
            }
            
            if(!byEmployee.has(name)){
              byEmployee.set(name, []);
            }
            
            const code = getV(r, ['code','ma','taskcode','m√£']) || '';
            const tname = getV(r, ['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','taskname','ten_tac_vu','ten','name','title']) || '';
            
            byEmployee.get(name).push({
              ceType,
              code,
              tname,
              completionDate: completionDateStr,
              ceReview
            });
          });
          
          Array.from(byEmployee.entries()).sort((a,b) => a[0].localeCompare(b[0], 'vi')).forEach(([empName, tasks]) => {
            let stt = 0;
            tasks.forEach(task => {
              aoa.push([
                empName,
                task.ceType,
                ++stt,
                task.code,
                task.tname,
                formatDdMmYyyy(task.completionDate),
                task.ceReview
              ]);
            });
          });
          
          return aoa.length > 1 ? aoa : [['Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt P3']];
        }catch(err){
          console.error('[P3 Detail Export] Error:', err);
          return [['L·ªói xu·∫•t d·ªØ li·ªáu chi ti·∫øt P3']];
        }
      }
      
      // N√∫t l√†m m·ªõi l·ª±a ch·ªçn bi·ªÉu ƒë·ªì Form 5
      (function initF5aRefresh(){
        const btn = document.getElementById('f5a-refresh');
        if (!btn) return;
        btn.addEventListener('click', (e)=>{ e.preventDefault(); try{ if (window.F5A_RENDER_CHART) { window.F5A_RENDER_CHART(); } else { try{ renderStackedChart(F5A_LAST_ROWS||[]); }catch(_){ } } }catch(_){ } });
      })();
      // Default Form 4 month = current month (ƒë√£ c√≥ ·ªü tr√™n)
      // Th√™m default cho Form 5 (All tasks)
      (function setDefaultF5aMonth(){
        const m = document.getElementById('f5a-month');
        if (!m) return;
        const d = new Date();
        const yy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        if (!m.value) m.value = `${yy}-${mm}`;
      })();
      // Modal: t√°c v·ª• nh·∫≠n trong th√°ng (l·ªçc theo requestDate thu·ªôc [from,to])
      (function initRqDetailModal(){
        const modal = document.getElementById('rq-detail-modal');
        const closeBtn = document.getElementById('rq-detail-close');
        if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } });
        if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
        
        
      })();
      // H√†m t√≠nh t·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø cho m·ªôt nh√¢n vi√™n
      function calculateTotalActualHours(empName, from, to) {
        try {
          // ∆Øu ti√™n s·ª≠ d·ª•ng details t·ª´ n8n
          if (F5A_P1_DATA && F5A_P1_DATA.success && Array.isArray(F5A_P1_DATA.data)){
            const normalizeName = (s)=>{
              try{
                const raw = String(s||'').trim();
                const noAcc = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                return noAcc.replace(/\s+/g,' ').trim();
              }catch(_){ return String(s||'').toLowerCase().trim(); }
            };
            const targetNameNorm = normalizeName(empName);
            const empData = F5A_P1_DATA.data.find(emp => {
              const empName = emp['Ph·ª• tr√°ch'] || emp.name || '';
              return normalizeName(empName) === targetNameNorm;
            });
            if (empData && empData.details){
              // T√≠nh t·ªïng t·ª´ details (c·∫£ sameMonth v√† prevMonth v√¨ ƒë·ªÅu ho√†n th√†nh trong th√°ng)
              const allTasks = [
                ...(Array.isArray(empData.details.sameMonth) ? empData.details.sameMonth : []),
                ...(Array.isArray(empData.details.prevMonth) ? empData.details.prevMonth : [])
              ];
              let total = 0;
              allTasks.forEach(task => {
                const hours = Number(task.actualNum || 0);
                if (Number.isFinite(hours) && hours > 0){
                  total += hours;
                }
              });
              const formatted = total.toFixed(2).replace('.', ',');
              return { raw: total, formatted: formatted };
            }
          }
          
          // Fallback: t√≠nh t·ª´ raw data (n·∫øu kh√¥ng c√≥ n8n data)
          const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
          function norm(s){ return String(s||'').trim(); }
          function getV(obj, keys){ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; }
          function vnNoAcc(s){ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } }
          function sameName(a,b){ return vnNoAcc(a).replace(/\s+/g,' ').trim() === vnNoAcc(b).replace(/\s+/g,' ').trim(); }
          function parseDate(v){ try{ return parseDateFlexible(v); } catch(_){ return null; } }
          function iso(d){ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
          function inRange(ds){ if(!from && !to) return true; if(!ds) return false; if(from && ds < from) return false; if(to && ds > to) return false; return true; }
          
          const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
          const actualKeys = ['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','so gio danh gia thuc te','s·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
          const statusKeys = ['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
          const doneKeys = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
          
          const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(dn); };
          
          let totalActualHours = 0;
          rows.forEach(o=>{
            if (isCanceled(o)) return;
            const emp = norm(getV(o, assigneeKeys));
            if(!sameName(emp, empName)) return;
            
            let rq = norm(getV(o, rqKeys)); let rqD = parseDate(rq); let rqIso = rqD? iso(rqD):'';
            if(!rqD || !inRange(rqIso)){
              let picked = '';
              try{
                const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
                const rqSet = new Set(rqKeys.map(normKey));
                const wishSet = new Set(['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën','H·∫°n mong mu·ªën ','H·∫°n mong mu·ªën'].map(normKey));
                for(const [k, v] of Object.entries(o||{})){
                  const kn = normKey(k);
                  if (!rqSet.has(kn) || wishSet.has(kn)) continue;
                  const d = parseDate(v); if(!d) continue; const ds = iso(d); if(inRange(ds)){ picked = v; rqD = d; rqIso = ds; break; }
                }
              }catch(_){ }
              if (picked) rq = norm(picked); else if (!inRange(rqIso)) return;
            }
            
            const actual = norm(getV(o, actualKeys));
            // Parse gi√° tr·ªã actual m·ªôt c√°ch robust h∆°n
            let actualStr = String(actual || '').trim();
            actualStr = actualStr.replace(/[^\d.,]/g, '');
            actualStr = actualStr.replace(',', '.');
            const actualNum = parseFloat(actualStr) || 0;
            totalActualHours += actualNum;
          });
          
          // L√†m tr√≤n ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n v√† format v·ªõi d·∫•u ph·∫©y
          const totalActualHoursFormatted = totalActualHours.toFixed(2).replace('.', ',');
          
          return {
            raw: totalActualHours,
            formatted: totalActualHoursFormatted
          };
        } catch(_) {
          return { raw: 0, formatted: '0,00' };
        }
      }

      function openRqDetailModal(empName, from, to){
        try{
          const modal = document.getElementById('rq-detail-modal');
          const nameEl = document.getElementById('rq-detail-name');
          const body = document.getElementById('rq-detail-body');
          if (!modal || !nameEl || !body) return;
          nameEl.textContent = empName || '';
          body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>`;
          
          // ∆Øu ti√™n l·∫•y t·ª´ F5A_P2_DATA n·∫øu c√≥ (d·ªØ li·ªáu t·ª´ n8n workflow m·ªõi)
          let useP2Data = false;
          let p2Tasks = [];
          if (F5A_P2_DATA && F5A_P2_DATA.data && Array.isArray(F5A_P2_DATA.data)) {
            const empData = F5A_P2_DATA.data.find(item => {
              const itemName = item.name || '';
              return itemName === empName || itemName.toLowerCase() === empName.toLowerCase();
            });
            if (empData && empData.tasks && Array.isArray(empData.tasks) && empData.tasks.length > 0) {
              useP2Data = true;
              p2Tasks = empData.tasks;
              console.log('[F5A P2] Using tasks from P2 data, count:', p2Tasks.length);
            }
          }
          
          const rows = useP2Data ? p2Tasks : (Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : []);
          function norm(s){ return String(s||'').trim(); }
          function getV(obj, keys){ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; }
          function vnNoAcc(s){ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } }
          function sameName(a,b){ return vnNoAcc(a).replace(/\s+/g,' ').trim() === vnNoAcc(b).replace(/\s+/g,' ').trim(); }
          function parseDate(v){ try{ return parseDateFlexible(v); } catch(_){ return null; } }
          function iso(d){ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
          function inRange(ds){ if(!from && !to) return true; if(!ds) return false; if(from && ds < from) return false; if(to && ds > to) return false; return true; }
          const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Ph·ª• tr√°ch','Ph·ª• tr√°ch ch√≠nh','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','Ng∆∞·ªùi nh·∫≠n m·∫´u','Ng∆∞·ªùi nh·∫≠n','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
          const rqKeys = [
            'üìÜ ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu','üìÜ Ng√†y y√™u c·∫ßu ',
            'ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu','Ng√†y y√™u c·∫ßu ',
            'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
            'submissiondate','submitteddate','submitdate','submit_date',
            'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
            'ngaygui','ngay_gui','ng√†y g·ª≠i','Ng√†y g·ª≠i',
            'createddate','created_date','creationdate','created',
            'ngaytao','ngay_tao','ng√†y t·∫°o','Ng√†y t·∫°o',
            'üìÜ ng√†y g·ª≠i','üìÜ Ng√†y g·ª≠i',
            'th·ªùi gian y√™u c·∫ßu','th·ªùi ƒëi·ªÉm y√™u c·∫ßu'
          ];
          const codeKeys = ['code','ma','taskcode','m√£'];
          const nameKeys = ['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','taskname','ten_tac_vu','ten','name','title'];
          const manKeys = ['ƒêi·ªÉm','Score','score','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n ','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n','C√¥ng chu·∫©n','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
          const actualKeys = ['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','so gio danh gia thuc te','s·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
          const wishKeys = ['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën','H·∫°n mong mu·ªën ','H·∫°n mong mu·ªën'];
          const doneKeys = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','Ng√†y k·∫øt th√∫c','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
          // ∆Øu ti√™n l·∫•y t·ª´ "K·∫øt qu·∫£" tr∆∞·ªõc, sau ƒë√≥ m·ªõi ƒë·∫øn c√°c key kh√°c
          const statusKeys = ['K·∫øt qu·∫£','k·∫øt qu·∫£','ketqua','ket_qua','K·∫øt Qu·∫£','KETQUA','KET_QUA','Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
          const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('h·ªßy')||st.includes('hu·ª∑')||/cancel/i.test(dn); };
          const items = [];
          
          if (useP2Data) {
            // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ P2 (ƒë√£ c√≥ s·∫µn c·∫•u tr√∫c tasks)
            p2Tasks.forEach(task => {
              const code = norm(task['M√£'] || '');
              const tname = norm(task['T√™n t√°c v·ª•'] || '');
              if (!tname) return;
              const rq = norm(task['Ng√†y y√™u c·∫ßu'] || '');
              const man = norm(task['C√¥ng chu·∫©n'] || '');
              const actual = norm(task['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '');
              const wish = norm(task['H·∫°n mong mu·ªën'] || '');
              const done = norm(task['Ng√†y ho√†n th√†nh'] || '');
              // ∆Øu ti√™n l·∫•y t·ª´ "K·∫øt qu·∫£", n·∫øu kh√¥ng c√≥ th√¨ l·∫•y t·ª´ "Tr·∫°ng th√°i"
              const status = norm(task['K·∫øt qu·∫£'] || task['Tr·∫°ng th√°i'] || task['Hi·ªán tr·∫°ng'] || '');
              items.push({ code, tname, rq, man, actual, wish, done, status });
            });
          } else {
            // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ F5A_RAW_ALL (logic c≈©)
            rows.forEach(o=>{
              if (isCanceled(o)) return;
              const emp = norm(getV(o, assigneeKeys));
              if(!sameName(emp, empName)) return;
              
              let rq = norm(getV(o, rqKeys)); let rqD = parseDate(rq); let rqIso = rqD? iso(rqD):'';
              if(!rqD || !inRange(rqIso)){
                let picked = '';
                try{
                  const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
                  const rqSet = new Set(rqKeys.map(normKey));
                  const wishSet = new Set(['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën','H·∫°n mong mu·ªën ','H·∫°n mong mu·ªën'].map(normKey));
                  for(const [k, v] of Object.entries(o||{})){
                    const kn = normKey(k);
                    if (!rqSet.has(kn) || wishSet.has(kn)) continue;
                    const d = parseDate(v); if(!d) continue; const ds = iso(d); if(inRange(ds)){ picked = v; rqD = d; rqIso = ds; break; }
                  }
                }catch(_){ }
                if (picked) rq = norm(picked); else if (!inRange(rqIso)) return;
              }
              const code = norm(getV(o, codeKeys));
              const tname = norm(getV(o, nameKeys)); if(!tname) return;
              const man = norm(getV(o, manKeys));
              const actual = norm(getV(o, actualKeys));
              const wish = norm(getV(o, wishKeys));
              const done = norm(getV(o, doneKeys));
              const status = norm(getV(o, statusKeys));
              items.push({ code, tname, rq, man, actual, wish, done, status });
            });
          }
          if (!items.length){ body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); return; }
          const fmt = (v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
          let stt = 0;
          
          // Helper functions ƒë·ªÉ parse v√† format s·ªë
          const parseNumber = (str) => {
            if (!str) return 0;
            const cleaned = String(str).replace(/[^0-9.,-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
          };
          const formatNumber = (num) => {
            if (!Number.isFinite(num)) return '0,00';
            return num.toFixed(2).replace('.', ',');
          };
          
          // L·∫•y t·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø
          let totalActualHours = 0;
          let totalActualHoursFormatted = '0,00';
          
          // T√≠nh t·ªïng c√¥ng chu·∫©n
          let totalManhour = 0;
          let totalManhourFormatted = '0,00';
          
          if (useP2Data) {
            // T√≠nh t·ª´ tasks trong P2 data
            p2Tasks.forEach(task => {
              const actual = task['S·ªë gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '';
              const man = task['C√¥ng chu·∫©n'] || '';
              totalActualHours += parseNumber(actual);
              totalManhour += parseNumber(man);
            });
            totalActualHoursFormatted = formatNumber(totalActualHours);
            totalManhourFormatted = formatNumber(totalManhour);
          } else {
            // L·∫•y t·ª´ Map (logic c≈©)
            const totalActualHoursData = (window.F5A_TOTAL_ACTUAL_HOURS_MAP && window.F5A_TOTAL_ACTUAL_HOURS_MAP.get(empName)) || { raw: 0, formatted: '0,00' };
            totalActualHours = totalActualHoursData.raw;
            totalActualHoursFormatted = totalActualHoursData.formatted;
            
            // T√≠nh t·ªïng c√¥ng chu·∫©n t·ª´ items
            items.forEach(it => {
              totalManhour += parseNumber(it.man);
            });
            totalManhourFormatted = formatNumber(totalManhour);
          }
          
          // Render c√°c h√†ng d·ªØ li·ªáu
          const dataRows = items.map(it=>`
            <tr>
              <td class="px-3 py-2">${++stt}</td>
              <td class="px-3 py-2">${it.code}</td>
              <td class="px-3 py-2">${it.tname}</td>
              <td class="px-3 py-2">${fmt(it.rq)}</td>
              <td class="px-3 py-2">${it.man}</td>
              <td class="px-3 py-2">${it.actual}</td>
              <td class="px-3 py-2">${fmt(it.wish)}</td>
              <td class="px-3 py-2">${fmt(it.done)}</td>
              <td class="px-3 py-2">${it.status}</td>
            </tr>
          `).join('');
          
          // H√†ng t·ªïng
          const totalRow = `
            <tr class="bg-blue-50 font-semibold">
              <td class="px-3 py-2" colspan="4">T·ªîNG</td>
              <td class="px-3 py-2">${totalManhourFormatted}</td>
              <td class="px-3 py-2">${totalActualHoursFormatted}</td>
              <td class="px-3 py-2" colspan="3"></td>
            </tr>
          `;
          
          body.innerHTML = dataRows + totalRow;
          
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
        }catch(_){ }
      }
      // M·ªü modal Form 10 - B·∫£ng c√¥ng
      async function openForm10AttendanceModal(monthVal, empName){
        try{
          const modal = document.getElementById('f10-attendance-modal');
          const monthDisplay = document.getElementById('f10-attendance-month-display');
          const monthInput = document.getElementById('f10-att-modal-month');
          if (!modal) return;
          
          // Set th√°ng hi·ªÉn th·ªã
          const monthDisplayText = monthVal ? `${monthVal.split('-')[1]}/${monthVal.split('-')[0]}` : 'Ch∆∞a ch·ªçn';
          if (monthDisplay) monthDisplay.textContent = monthDisplayText;
          if (monthInput) monthInput.value = monthVal || '';
          
          // Fetch d·ªØ li·ªáu n·∫øu ch∆∞a c√≥ ho·∫∑c th√°ng kh√°c
          const currentMonth = F10_ATT_META.month || '';
          if (!F10_ATT_ROWS.length || currentMonth !== monthVal){
            await f10FetchAttendance(monthVal);
          }
          
          // Render d·ªØ li·ªáu v√†o modal
          renderForm10AttendanceModal(monthVal);
          
          // M·ªü modal
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
        }catch(_){
          console.error('[F10 Modal] Error opening modal:', _);
        }
      }

      // M·ªü b·∫£ng ph·ª• theo y√™u c·∫ßu: DONE (P1) -> Ho√†n th√†nh; S·ªë t√°c v·ª• trong th√°ng (P2) -> Nh·∫≠n th√°ng; T·ªïng gi·ªù c√¥ng ƒëi l√†m (P2) -> Form 10
      (function initF5aSubTables(){
        const p1 = document.getElementById('f5a-body-p1');
        const p2 = document.getElementById('f5a-body-p2');
        function onClick(e){
          const doneBtn = e.target && e.target.closest ? e.target.closest('[data-f5a-done]') : null;
          const rqBtn = e.target && e.target.closest ? e.target.closest('[data-f5a-rqcount]') : null;
          const f10Btn = e.target && e.target.closest ? e.target.closest('[data-f10-open-modal]') : null;
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          let fromVal = '', toVal = '';
          if (monthVal) {
            try{
              const parts = monthVal.split('-');
              const yy = Number(parts[0]);
              const mm = Number(parts[1]);
              const firstDay = `${yy}-${String(mm).padStart(2,'0')}-01`;
              const lastDate = new Date(yy, mm, 0).getDate();
              const lastDay = `${yy}-${String(mm).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
              fromVal = firstDay; toVal = lastDay;
            }catch(_){ }
          }
          if (f10Btn){
            const name = f10Btn.getAttribute('data-f10-open-modal') || '';
            const month = f10Btn.getAttribute('data-f10-month') || monthVal || '';
            if (month) openForm10AttendanceModal(month, name);
            return;
          }
          if (rqBtn){
            const name = rqBtn.getAttribute('data-f5a-rqcount') || '';
            if (name) openRqDetailModal(name, fromVal, toVal);
            return;
          }
          if (doneBtn){
            const name = doneBtn.getAttribute('data-f5a-done') || '';
            if (name) openDetailModal(name, 'All', fromVal, toVal);
            return;
          }
        }
        if (p1) p1.addEventListener('click', onClick);
        if (p2) p2.addEventListener('click', onClick);
      })();

      // ===== Form 7: Modal c≈© ƒë√£ b·ªã v√¥ hi·ªáu h√≥a - KH√îNG S·ª¨ D·ª§NG =====
      // Modal c≈© "form7-modal" v·ªõi Gate 1/2 ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng "form7-subpanel-modal"
      // C√°c function d∆∞·ªõi ƒë√¢y ƒë∆∞·ª£c gi·ªØ l·∫°i ƒë·ªÉ tr√°nh l·ªói reference, nh∆∞ng KH√îNG n√™n g·ªçi
      
      let form7Context = null;
      let form7IsSubmitting = false;
      let form7LastOpenTrigger = null;

      function openForm7Modal(ctx) {
        console.warn('‚ö†Ô∏è openForm7Modal() ƒë√£ b·ªã deprecated! S·ª≠ d·ª•ng openForm7SubpanelModal() thay th·∫ø.');
        // Kh√¥ng l√†m g√¨ c·∫£ - modal c≈© ƒë√£ b·ªã x√≥a
      }

      function closeForm7Modal() {
        console.warn('‚ö†Ô∏è closeForm7Modal() ƒë√£ b·ªã deprecated!');
        // Kh√¥ng l√†m g√¨ c·∫£
      }

      async function submitForm7() {
        console.error('‚ùå submitForm7() ƒë√£ b·ªã deprecated! Modal c≈© kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng.');
        showToast('L·ªói: ƒêang s·ª≠ d·ª•ng modal c≈© ƒë√£ b·ªã v√¥ hi·ªáu h√≥a. Vui l√≤ng F5 t·∫£i l·∫°i trang.', 'error');
          return;
      }

      // ===== Form 7: Modal Subpanel =====
      let form7SubpanelContext = null;
      let form7SubpanelKind = null;

      function openForm7SubpanelModal(kind, ctx){
        form7SubpanelContext = ctx || {};
        form7SubpanelKind = kind;
        
        // Ki·ªÉm tra modal c√≥ t·ªìn t·∫°i kh√¥ng
        const modal = document.getElementById('form7-subpanel-modal');
        if (!modal) {
          console.error('Modal form7-subpanel-modal not found!');
          return;
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin trong modal
        const nameEl = document.getElementById('form7-subpanel-name');
        const codeEl = document.getElementById('form7-subpanel-code');
        const taskNameEl = document.getElementById('form7-subpanel-task-name');
        
        if (nameEl) nameEl.textContent = ctx?.name || '';
        if (codeEl) codeEl.textContent = ctx?.taskId || '';
        if (taskNameEl) taskNameEl.textContent = ctx?.taskName || '';
        
        // C·∫≠p nh·∫≠t title v√† m√†u s·∫Øc
        const title = document.getElementById('form7-subpanel-title');
        const submitBtn = document.getElementById('form7-subpanel-submit');
        
        if (title && submitBtn) {
          if (kind === 'ce') {
            title.textContent = 'CE R√† so√°t - G·ª≠i d·ªØ li·ªáu';
            title.className = 'text-lg font-semibold text-cyan-800';
            submitBtn.textContent = 'G·ª≠i CE r√† so√°t';
            submitBtn.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-cyan-600 hover:brightness-105';
          } else {
            title.textContent = '4M R√† so√°t - G·ª≠i d·ªØ li·ªáu';
            title.className = 'text-lg font-semibold text-emerald-800';
            submitBtn.textContent = 'G·ª≠i 4M r√† so√°t';
            submitBtn.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-emerald-600 hover:brightness-105';
          }
        }
        
        // Reset form
        const notesEl = document.getElementById('form7-subpanel-notes');
        const fileEl = document.getElementById('form7-subpanel-file');
        const ceCheckbox = document.getElementById('form7-subpanel-ce-checkbox');
        if (notesEl) notesEl.value = '';
        if (fileEl) fileEl.value = '';
        if (ceCheckbox) ceCheckbox.checked = false;
        
        // Hi·ªÉn th·ªã/·∫©n checkbox CE t√πy theo lo·∫°i modal
        const ceOption = document.getElementById('form7-subpanel-ce-option');
        if (ceOption) {
          if (kind === 'ce') {
            ceOption.style.display = 'flex';
          } else {
            ceOption.style.display = 'none';
          }
        }
        
        // Hi·ªÉn th·ªã modal
        modal.classList.add('open');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }

      // ===== Form 8: Modal Subpanel =====
      let form8SubpanelContext = null;

      function openForm8SubpanelModal(ctx){
        form8SubpanelContext = ctx || {};
        
        // Ki·ªÉm tra modal c√≥ t·ªìn t·∫°i kh√¥ng
        const modal = document.getElementById('form8-subpanel-modal');
        if (!modal) {
          console.error('Modal form8-subpanel-modal not found!');
          return;
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin trong modal
        const nameEl = document.getElementById('form8-subpanel-name');
        const codeEl = document.getElementById('form8-subpanel-code');
        const taskNameEl = document.getElementById('form8-subpanel-task-name');
        
        if (nameEl) nameEl.textContent = ctx?.name || '';
        if (codeEl) codeEl.textContent = ctx?.taskId || '';
        if (taskNameEl) taskNameEl.textContent = ctx?.taskName || '';
        
        // Reset form
        const notesEl = document.getElementById('form8-subpanel-notes');
        const fileEl = document.getElementById('form8-subpanel-file');
        const fourMCheckbox = document.getElementById('form8-subpanel-4m-checkbox');
        if (notesEl) notesEl.value = '';
        if (fileEl) fileEl.value = '';
        if (fourMCheckbox) fourMCheckbox.checked = false;
        
        // Hi·ªÉn th·ªã modal
        modal.classList.add('open');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeForm8SubpanelModal(){
        const modal = document.getElementById('form8-subpanel-modal');
        modal.classList.remove('open');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        form8SubpanelContext = null;
      }

      async function submitForm8SubpanelModal(){
        if (!form8SubpanelContext) return;
        
        const notes = document.getElementById('form8-subpanel-notes').value.trim();
        const fileEl = document.getElementById('form8-subpanel-file');
        const fourMCheckbox = document.getElementById('form8-subpanel-4m-checkbox');
        const ctx = form8SubpanelContext;
        const fourMNotRequired = fourMCheckbox ? fourMCheckbox.checked : false;

        // Validation: N·∫øu kh√¥ng tick "kh√¥ng c·∫ßn r√† so√°t", th√¨ file Excel l√† b·∫Øt bu·ªôc
        if (!fourMNotRequired) {
          const hasFile = fileEl && fileEl.files && fileEl.files[0];
          
          if (!hasFile) {
            showToast('Vui l√≤ng ch·ªçn t·ªáp Excel ƒë√≠nh k√®m ho·∫∑c tick "Kh√¥ng c·∫ßn r√† so√°t"', 'error');
            return;
          }
          
          // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file Excel
          const file = fileEl.files[0];
          const fileName = file.name.toLowerCase();
          const isExcelFile = fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || 
                            fileName.endsWith('.xlsm') || fileName.endsWith('.xlsb');
          
          if (!isExcelFile) {
            showToast('Vui l√≤ng ch·ªçn file Excel (.xlsx, .xls, .xlsm, .xlsb)', 'error');
            return;
          }
        }

        const formData = new FormData();
        formData.append('action', '4m_review_submit');
        formData.append('form_type', '4M Review');
        formData.append('timestamp', formatYyyyMmDdHHmm(new Date()));
        formData.append('Id', ctx?.Id || ctx?.rowData?.Id || '');
        formData.append('person_name', ctx?.name || '');
        formData.append('task_id', ctx?.taskId || '');
        formData.append('code', ctx?.code || '');
        formData.append('task_name', ctx?.taskName || '');
        formData.append('notes', notes);
        formData.append('4m_not_required', fourMNotRequired ? '1' : '0');
        
        if (fileEl && fileEl.files && fileEl.files[0]){
          const file = fileEl.files[0];
          formData.append('file', file);
          formData.append('file_name', file.name || '');
          try{ 
            const extension = file.name.split('.').pop().toLowerCase();
            formData.append('file_extension', extension);
          }catch(e){}
        }

        // G·ª≠i d·ªØ li·ªáu
        const submitBtn = document.getElementById('form8-subpanel-submit');
        const prevText = submitBtn?.textContent;
        
        try {
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang g·ª≠i...';
          }

          const response = await fetch('https://iatzhxxuk.tino.page/webhook/Khaibao4M', {
            method: 'POST',
            body: formData,
            mode: 'cors',
            headers: {
              'Accept': 'application/json'
            }
          });

          if (response.ok) {
            showToast('G·ª≠i 4M r√† so√°t th√†nh c√¥ng!', 'success');
            closeForm8SubpanelModal();
            // Refresh data n·∫øu c·∫ßn
            if (typeof renderForm8 === 'function') {
              renderForm8();
            }
          } else {
            const errorText = await response.text();
            console.error('[Form8 Debug] Server error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }
        } catch (e) {
          console.error('[Form8 Debug] Error:', e);
          
          // X·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau
          let errorMessage = 'G·ª≠i th·∫•t b·∫°i';
          if (e.message.includes('CORS')) {
            errorMessage = 'L·ªói CORS: Server kh√¥ng cho ph√©p truy c·∫≠p t·ª´ tr√¨nh duy·ªát n√†y';
          } else if (e.message.includes('404')) {
            errorMessage = 'L·ªói 404: URL kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng ƒë√∫ng';
          } else if (e.message.includes('Failed to fetch')) {
            errorMessage = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng';
          } else {
            errorMessage = `G·ª≠i th·∫•t b·∫°i: ${e.message}`;
          }
          
          showToast(errorMessage, 'error');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = prevText || 'G·ª≠i 4M r√† so√°t';
          }
        }
      }


      function closeForm7SubpanelModal(){
        const modal = document.getElementById('form7-subpanel-modal');
        modal.classList.remove('open');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        form7SubpanelContext = null;
        form7SubpanelKind = null;
      }

      async function submitForm7SubpanelModal(){
        if (!form7SubpanelContext || !form7SubpanelKind) return;
        
        const notes = document.getElementById('form7-subpanel-notes').value.trim();
        const fileEl = document.getElementById('form7-subpanel-file');
        const ceCheckbox = document.getElementById('form7-subpanel-ce-checkbox');
        const kind = form7SubpanelKind;
        const ctx = form7SubpanelContext;
        const ceNotRequired = ceCheckbox ? ceCheckbox.checked : false;

        // Validation nh·∫π h∆°n: ch·ªâ c·∫£nh b√°o n·∫øu kh√¥ng c√≥ c·∫£ file v√† checkbox
        if (kind === 'ce' && !ceNotRequired) {
          const hasFile = fileEl && fileEl.files && fileEl.files[0];
          if (!hasFile && !notes) {
            showToast('Vui l√≤ng nh·∫≠p ghi ch√∫ ho·∫∑c ƒë√≠nh k√®m file, ho·∫∑c tick "T√°c v·ª• kh√¥ng c·∫ßn l√†m CE"', 'error');
            return;
          }
        }

        const formData = new FormData();
        formData.append('action', kind==='ce' ? 'ce_review_submit' : '4m_review_submit');
        formData.append('form_type', kind==='ce' ? 'CE Review' : '4M Review');
        formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        formData.append('Id', ctx?.Id || ctx?.rowData?.Id || '');
        formData.append('person_name', ctx?.name || '');
        formData.append('task_id', ctx?.taskId || '');
        formData.append('code', ctx?.code || '');
        formData.append('task_name', ctx?.taskName || '');
        formData.append('notes', notes);
        formData.append('f7emailassignee', ctx?.f7emailassignee || '');
        
        // Th√™m th√¥ng tin checkbox
        if (kind === 'ce') {
          formData.append('ce_not_required', ceNotRequired ? '1' : '0');
        }
        if (fileEl && fileEl.files && fileEl.files[0]){
          formData.append('file', fileEl.files[0]);
          formData.append('file_name', fileEl.files[0].name || '');
          try{ formData.append('file_extension', (fileEl.files[0].name||'').split('.').pop().toLowerCase()); }catch(_){ }
        }
        const metadata = {
          action: kind==='ce' ? 'ce_review_submit' : '4m_review_submit',
          form_type: kind==='ce' ? 'CE Review' : '4M Review',
          Id: ctx?.Id || ctx?.rowData?.Id || '',
          person_name: ctx?.name || '',
          task_id: ctx?.taskId || '',
          code: ctx?.code || '',
          task_name: ctx?.taskName || '',
          notes,
          f7emailassignee: ctx?.f7emailassignee || '',
          ce_not_required: kind === 'ce' ? ceNotRequired : false,
          timestamp_iso: new Date().toISOString()
        };
        formData.append('metadata_json', JSON.stringify(metadata));
        formData.append('body', JSON.stringify(metadata));

        const btn = document.getElementById('form7-subpanel-submit');
        const prev = btn ? btn.textContent : '';
        
        // Khai b√°o baseUrl ngo√†i try block ƒë·ªÉ d√πng trong catch
        const baseUrl = FORM7_SUBPANEL_URL;
        const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
        const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
        
        try{
          if (btn){ btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
          
          console.log('[Form7 CE Debug] B·∫Øt ƒë·∫ßu g·ª≠i d·ªØ li·ªáu:', {
            url: FORM7_SUBPANEL_URL,
            kind: kind,
            person_name: ctx?.name,
            task_id: ctx?.taskId,
            hasFile: fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0].name : 'No file',
            ceNotRequired: ceNotRequired,
            hasNotes: !!notes
          });
          
          // Ch·ªâ s·ª≠ d·ª•ng CORS mode ƒë·ªÉ tr√°nh redirect v√† GET request kh√¥ng mong mu·ªën
          
          let success = false;
          let lastError = null;
          
          // 1. Th·ª≠ test URL v·ªõi CORS
          try {
            console.log('[Form7 CE Debug] [1/2] Th·ª≠ test URL v·ªõi CORS...');
            const r1 = await fetch(testUrl, { 
              method: 'POST', 
              body: formData, 
              mode: 'cors',
              credentials: 'omit'
            });
            if (r1.ok) {
              const responseText = await r1.text().catch(() => '');
              console.log('[Form7 CE Debug] ‚úÖ Test CORS th√†nh c√¥ng!');
              console.log('[Form7 CE Debug] Response:', responseText);
              success = true;
            } else {
              const errText = await r1.text().catch(() => '');
              console.log('[Form7 CE Debug] ‚ùå Test CORS failed:', r1.status, errText);
              throw new Error(`HTTP ${r1.status}: ${errText}`);
            }
          } catch (e1) {
            console.warn('[Form7 CE Debug] [1/2] Test CORS th·∫•t b·∫°i:', e1.message);
            lastError = e1;
            
            // 2. Th·ª≠ prod URL v·ªõi CORS
            try {
              console.log('[Form7 CE Debug] [2/2] Th·ª≠ prod URL v·ªõi CORS...');
              const r2 = await fetch(prodUrl, { 
                method: 'POST', 
                body: formData, 
                mode: 'cors',
                credentials: 'omit'
              });
              if (r2.ok) {
                const responseText = await r2.text().catch(() => '');
                console.log('[Form7 CE Debug] ‚úÖ Prod CORS th√†nh c√¥ng!');
                console.log('[Form7 CE Debug] Response:', responseText);
                success = true;
              } else {
                const errText = await r2.text().catch(() => '');
                console.log('[Form7 CE Debug] ‚ùå Prod CORS failed:', r2.status, errText);
                throw new Error(`HTTP ${r2.status}: ${errText}`);
              }
            } catch (e2) {
              console.error('[Form7 CE Debug] [2/2] Prod CORS th·∫•t b·∫°i:', e2.message);
              lastError = e2;
            }
          }
          
          if (!success) {
            // N·∫øu server tr·∫£ v·ªÅ 500, c√≥ th·ªÉ do t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng
            if (lastError && lastError.message.includes('500')) {
              console.log('[Form7 CE Debug] Server 500 error - c√≥ th·ªÉ do t·∫°m th·ªùi, th·ª≠ l·∫°i sau 3 gi√¢y...');
              showToast('Server t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng, ƒëang th·ª≠ l·∫°i...', 'warning');
              
              // Th·ª≠ l·∫°i sau 3 gi√¢y
              setTimeout(async () => {
                try {
                  console.log('[Form7 CE Debug] Retry attempt...');
                  const retryResponse = await fetch(prodUrl, { 
                    method: 'POST', 
                    body: formData, 
                    mode: 'cors',
                    credentials: 'omit'
                  });
                  
                  if (retryResponse.ok) {
                    const retryText = await retryResponse.text().catch(() => '');
                    console.log('[Form7 CE Debug] ‚úÖ Retry th√†nh c√¥ng!');
                    console.log('[Form7 CE Debug] Retry Response:', retryText);
                    showToast('ƒê√£ g·ª≠i ' + (kind==='ce' ? 'CE r√† so√°t' : '4M r√† so√°t') + ' th√†nh c√¥ng! (retry)', 'success');
                    closeForm7SubpanelModal();
                  } else {
                    const retryErrText = await retryResponse.text().catch(() => '');
                    console.log('[Form7 CE Debug] ‚ùå Retry failed:', retryResponse.status, retryErrText);
                    showToast('G·ª≠i th·∫•t b·∫°i: ' + retryErrText, 'error');
                  }
                } catch (retryErr) {
                  console.error('[Form7 CE Debug] ‚ùå Retry error:', retryErr);
                  showToast('G·ª≠i th·∫•t b·∫°i: ' + retryErr.message, 'error');
                }
              }, 3000);
              return; // Kh√¥ng throw error ngay
            }
            
            throw lastError || new Error('T·∫•t c·∫£ ph∆∞∆°ng √°n g·ª≠i ƒë·ªÅu th·∫•t b·∫°i');
          }
          
          console.log('[Form7 CE Debug] ‚úÖ Request g·ª≠i th√†nh c√¥ng!');
          console.log('[Form7 CE Debug] Response headers:', success ? 'Success' : 'Failed');
          showToast('ƒê√£ g·ª≠i ' + (kind==='ce' ? 'CE r√† so√°t' : '4M r√† so√°t') + ' th√†nh c√¥ng!', 'success');
          closeForm7SubpanelModal();
          
          // Refresh d·ªØ li·ªáu sau 2 gi√¢y
          setTimeout(() => {
            try {
              if (typeof renderForm7 === 'function') {
                console.log('[Form7 CE Debug] L√†m m·ªõi d·ªØ li·ªáu...');
                renderForm7();
              }
            } catch(_) {}
          }, 2000);
          
        }catch(err){
          console.error('[Form7 CE Debug] ‚ùå L·ªói g·ª≠i d·ªØ li·ªáu:', err);
          
          // X·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau
          let errorMessage = 'G·ª≠i th·∫•t b·∫°i';
          if (err.message.includes('NetworkError') || err.message.includes('Failed to fetch')) {
            errorMessage = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.';
          } else if (err.message.includes('CORS')) {
            errorMessage = 'L·ªói CORS: Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ ki·ªÉm tra c·∫•u h√¨nh webhook.';
          } else if (err.message.includes('404')) {
            errorMessage = 'L·ªói 404: URL webhook kh√¥ng t·ªìn t·∫°i.';
          } else if (err.message.includes('400')) {
            errorMessage = 'L·ªói 400: D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.';
          } else if (err.message.includes('500')) {
            errorMessage = 'L·ªói 500: Server g·∫∑p s·ª± c·ªë. Vui l√≤ng th·ª≠ l·∫°i sau.';
          } else {
            errorMessage = `G·ª≠i th·∫•t b·∫°i: ${err.message}`;
          }
          
          showToast(errorMessage, 'error');
          
          // Log chi ti·∫øt ƒë·ªÉ debug
          console.error('[Form7 CE Debug] Chi ti·∫øt l·ªói:', {
            message: err.message,
            stack: err.stack,
            testUrl: baseUrl.replace('/webhook/', '/webhook-test/'),
            prodUrl: baseUrl.replace('/webhook-test/', '/webhook/'),
            metadata: metadata
          });
          
        }finally{
          if (btn){ 
            btn.disabled = false; 
            btn.textContent = prev || 'G·ª≠i'; 
          }
        }
      }

      // ===== CE Review Modal Functions =====
      let ceReviewContext = null;
      let ceReviewIsSubmitting = false;

      function openCeReviewModal(ctx) {
        ceReviewContext = ctx || {};
        
        // C·∫≠p nh·∫≠t th√¥ng tin t√°c v·ª• trong modal
        document.getElementById('ce-review-name').textContent = ctx?.name || '';
        document.getElementById('ce-review-code').textContent = ctx?.taskId || '';
        document.getElementById('ce-review-task-name').textContent = ctx?.taskName || '';
        
        // Hi·ªÉn th·ªã modal
        const modal = document.getElementById('ce-review-modal');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeCeReviewModal() {
        const modal = document.getElementById('ce-review-modal');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        ceReviewContext = null;
      }

      async function submitCeReview() {
        if (ceReviewIsSubmitting) return;
        
        try {
          ceReviewIsSubmitting = true;
          const btn = document.getElementById('ce-review-submit');
          const prev = btn.textContent;
          btn.disabled = true;
          btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang l∆∞u...";
          
          // T·∫°o FormData cho CE Review
          const formData = new FormData();
          
          // Th√¥ng tin t√°c v·ª•
          if (ceReviewContext) {
            formData.append('person_name', ceReviewContext.name || '');
            formData.append('task_id', ceReviewContext.taskId || '');
            formData.append('code', ceReviewContext.code || '');
            formData.append('task_name', ceReviewContext.taskName || '');
          }
          
          // Th√™m timestamp v√† action
          formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          formData.append('action', 'ce_review_submit');
          formData.append('form_type', 'CE Review');
          
          // T·∫°o metadata JSON
          const metadata = {
            action: 'ce_review_submit',
            form_type: 'CE Review',
            person_name: ceReviewContext?.name || '',
            task_id: ceReviewContext?.taskId || '',
            code: ceReviewContext?.code || '',
            task_name: ceReviewContext?.taskName || '',
            timestamp_iso: new Date().toISOString()
          };
          
          formData.append('metadata_json', JSON.stringify(metadata));
          formData.append('body', JSON.stringify(metadata));
          
          console.log('CE Review: G·ª≠i d·ªØ li·ªáu ƒë·∫øn URL:', FORM7_UPLOAD_URL);
          console.log('CE Review: Metadata:', metadata);
          
          // G·ª≠i d·ªØ li·ªáu
          const response = await fetch(FORM7_UPLOAD_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
          });
          
          showToast('L∆∞u CE r√† so√°t th√†nh c√¥ng!', 'success');
          closeCeReviewModal();
          
        } catch (error) {
          console.error('CE Review: L·ªói g·ª≠i d·ªØ li·ªáu:', error);
          showToast('L∆∞u CE r√† so√°t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        } finally {
          ceReviewIsSubmitting = false;
          const btn = document.getElementById('ce-review-submit');
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'L∆∞u CE r√† so√°t';
          }
        }
      }

      // ===== 4M Review Modal Functions =====
      let fourMReviewContext = null;
      let fourMReviewIsSubmitting = false;

      function open4mReviewModal(ctx) {
        fourMReviewContext = ctx || {};
        
        // C·∫≠p nh·∫≠t th√¥ng tin t√°c v·ª• trong modal
        document.getElementById('4m-review-name').textContent = ctx?.name || '';
        document.getElementById('4m-review-code').textContent = ctx?.taskId || '';
        document.getElementById('4m-review-task-name').textContent = ctx?.taskName || '';
        
        // Hi·ªÉn th·ªã modal
        const modal = document.getElementById('4m-review-modal');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }

      function close4mReviewModal() {
        const modal = document.getElementById('4m-review-modal');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        fourMReviewContext = null;
      }

      async function submit4mReview() {
        if (fourMReviewIsSubmitting) return;
        
        try {
          fourMReviewIsSubmitting = true;
          const btn = document.getElementById('4m-review-submit');
          const prev = btn.textContent;
          btn.disabled = true;
          btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang l∆∞u...";
          
          // T·∫°o FormData cho 4M Review
          const formData = new FormData();
          
          // Th√¥ng tin t√°c v·ª•
          if (fourMReviewContext) {
            formData.append('person_name', fourMReviewContext.name || '');
            formData.append('task_id', fourMReviewContext.taskId || '');
            formData.append('code', fourMReviewContext.code || '');
            formData.append('task_name', fourMReviewContext.taskName || '');
          }
          
          // Th√™m timestamp v√† action
          formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          formData.append('action', '4m_review_submit');
          formData.append('form_type', '4M Review');
          
          // T·∫°o metadata JSON
          const metadata = {
            action: '4m_review_submit',
            form_type: '4M Review',
            person_name: fourMReviewContext?.name || '',
            task_id: fourMReviewContext?.taskId || '',
            code: fourMReviewContext?.code || '',
            task_name: fourMReviewContext?.taskName || '',
            timestamp_iso: new Date().toISOString()
          };
          
          formData.append('metadata_json', JSON.stringify(metadata));
          formData.append('body', JSON.stringify(metadata));
          
          console.log('[4M Review Debug] G·ª≠i d·ªØ li·ªáu ƒë·∫øn URL:', FORM7_UPLOAD_URL);
          console.log('[4M Review Debug] Metadata:', metadata);
          
          // Ch·ªâ s·ª≠ d·ª•ng CORS mode ƒë·ªÉ tr√°nh redirect v√† GET request kh√¥ng mong mu·ªën
          const baseUrl = FORM7_UPLOAD_URL;
          const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
          const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
          
          let success = false;
          let lastError = null;
          
          // 1. Th·ª≠ test URL v·ªõi CORS
          try {
            console.log('[4M Review Debug] [1/2] Th·ª≠ test URL v·ªõi CORS...');
            const r1 = await fetch(testUrl, { 
              method: 'POST', 
              body: formData, 
              mode: 'cors',
              credentials: 'omit'
            });
            if (r1.ok) {
              const responseText = await r1.text().catch(() => '');
              console.log('[4M Review Debug] ‚úÖ Test CORS th√†nh c√¥ng!');
              console.log('[4M Review Debug] Response:', responseText);
              success = true;
            } else {
              const errText = await r1.text().catch(() => '');
              console.log('[4M Review Debug] ‚ùå Test CORS failed:', r1.status, errText);
              throw new Error(`HTTP ${r1.status}: ${errText}`);
            }
          } catch (e1) {
            console.warn('[4M Review Debug] [1/2] Test CORS th·∫•t b·∫°i:', e1.message);
            lastError = e1;
            
            // 2. Th·ª≠ prod URL v·ªõi CORS
            try {
              console.log('[4M Review Debug] [2/2] Th·ª≠ prod URL v·ªõi CORS...');
              const r2 = await fetch(prodUrl, { 
                method: 'POST', 
                body: formData, 
                mode: 'cors',
                credentials: 'omit'
              });
              if (r2.ok) {
                const responseText = await r2.text().catch(() => '');
                console.log('[4M Review Debug] ‚úÖ Prod CORS th√†nh c√¥ng!');
                console.log('[4M Review Debug] Response:', responseText);
                success = true;
              } else {
                const errText = await r2.text().catch(() => '');
                console.log('[4M Review Debug] ‚ùå Prod CORS failed:', r2.status, errText);
                throw new Error(`HTTP ${r2.status}: ${errText}`);
              }
            } catch (e2) {
              console.error('[4M Review Debug] [2/2] Prod CORS th·∫•t b·∫°i:', e2.message);
              lastError = e2;
            }
          }
          
          if (!success) {
            // N·∫øu server tr·∫£ v·ªÅ 500, c√≥ th·ªÉ do t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng
            if (lastError && lastError.message.includes('500')) {
              console.log('[4M Review Debug] Server 500 error - c√≥ th·ªÉ do t·∫°m th·ªùi, th·ª≠ l·∫°i sau 3 gi√¢y...');
              showToast('Server t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng, ƒëang th·ª≠ l·∫°i...', 'warning');
              
              // Th·ª≠ l·∫°i sau 3 gi√¢y
              setTimeout(async () => {
                try {
                  console.log('[4M Review Debug] Retry attempt...');
                  const retryResponse = await fetch(prodUrl, { 
                    method: 'POST', 
                    body: formData, 
                    mode: 'cors',
                    credentials: 'omit'
                  });
                  
                  if (retryResponse.ok) {
                    const retryText = await retryResponse.text().catch(() => '');
                    console.log('[4M Review Debug] ‚úÖ Retry th√†nh c√¥ng!');
                    console.log('[4M Review Debug] Retry Response:', retryText);
                    showToast('L∆∞u 4M r√† so√°t th√†nh c√¥ng! (retry)', 'success');
                    close4mReviewModal();
                  } else {
                    const retryErrText = await retryResponse.text().catch(() => '');
                    console.log('[4M Review Debug] ‚ùå Retry failed:', retryResponse.status, retryErrText);
                    showToast('L∆∞u 4M r√† so√°t th·∫•t b·∫°i: ' + retryErrText, 'error');
                  }
                } catch (retryErr) {
                  console.error('[4M Review Debug] ‚ùå Retry error:', retryErr);
                  showToast('L∆∞u 4M r√† so√°t th·∫•t b·∫°i: ' + retryErr.message, 'error');
                }
              }, 3000);
              return; // Kh√¥ng throw error ngay
            }
            
            throw lastError || new Error('T·∫•t c·∫£ ph∆∞∆°ng √°n g·ª≠i ƒë·ªÅu th·∫•t b·∫°i');
          }
          
          console.log('[4M Review Debug] ‚úÖ Request g·ª≠i th√†nh c√¥ng!');
          showToast('L∆∞u 4M r√† so√°t th√†nh c√¥ng!', 'success');
          close4mReviewModal();
          
        } catch (error) {
          console.error('[4M Review Debug] ‚ùå L·ªói g·ª≠i d·ªØ li·ªáu:', error);
          showToast('L∆∞u 4M r√† so√°t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        } finally {
          fourMReviewIsSubmitting = false;
          const btn = document.getElementById('4m-review-submit');
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'L∆∞u 4M r√† so√°t';
          }
        }
      }

      // ===== Sample Handover Modal Functions =====
      let sampleHandoverContext = null;
      let sampleHandoverIsSubmitting = false;

      function openSampleHandoverModal(ctx) {
        sampleHandoverContext = ctx || {};
        
        // C·∫≠p nh·∫≠t th√¥ng tin t√°c v·ª• trong modal
        document.getElementById('sample-handover-name').textContent = ctx?.name || '';
        document.getElementById('sample-handover-code').textContent = ctx?.taskId || '';
        document.getElementById('sample-handover-task-name').textContent = ctx?.taskName || '';
        
        // Reset form
        const radios = document.querySelectorAll('input[name="sample-handover-status"]');
        radios.forEach(r => r.checked = false);
        const notesEl = document.getElementById('sample-handover-notes');
        if (notesEl) notesEl.value = '';
        
        // Hi·ªÉn th·ªã modal
        const modal = document.getElementById('sample-handover-modal');
        modal.classList.add('open');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeSampleHandoverModal() {
        const modal = document.getElementById('sample-handover-modal');
        modal.classList.remove('open');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        sampleHandoverContext = null;
      }

      async function submitSampleHandover() {
        if (sampleHandoverIsSubmitting) return;
        
        // L·∫•y l·ª±a ch·ªçn
        const selectedRadio = document.querySelector('input[name="sample-handover-status"]:checked');
        if (!selectedRadio) {
          showToast('Vui l√≤ng ch·ªçn tr·∫°ng th√°i b√†n giao', 'error');
          return;
        }
        
        const status = selectedRadio.value;
        const notes = document.getElementById('sample-handover-notes').value.trim();
        
        try {
          sampleHandoverIsSubmitting = true;
          const btn = document.getElementById('sample-handover-submit');
          const prev = btn.textContent;
          btn.disabled = true;
          btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
          
          // T·∫°o FormData
          const formData = new FormData();
          
          // Th√¥ng tin t√°c v·ª• - g·ª≠i ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë√£ nh·∫≠n v·ªÅ
          if (sampleHandoverContext) {
            // C√°c tr∆∞·ªùng c∆° b·∫£n
            formData.append('person_name', sampleHandoverContext.name || '');
            formData.append('task_id', sampleHandoverContext.taskId || '');
            formData.append('code', sampleHandoverContext.code || '');
            formData.append('task_name', sampleHandoverContext.taskName || '');
            formData.append('f7emailassignee', sampleHandoverContext.f7emailassignee || '');
            
            // G·ª≠i ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng t·ª´ rowData
            if (sampleHandoverContext.Id) formData.append('Id', sampleHandoverContext.Id);
            if (sampleHandoverContext.actualCompletionDate) formData.append('actualCompletionDate', sampleHandoverContext.actualCompletionDate);
            if (sampleHandoverContext.reportCode) formData.append('reportCode', sampleHandoverContext.reportCode);
            if (sampleHandoverContext.evaluationResult) formData.append('evaluationResult', sampleHandoverContext.evaluationResult);
            if (sampleHandoverContext.notes) formData.append('original_notes', sampleHandoverContext.notes);
            if (sampleHandoverContext.ceReview) formData.append('ceReview', sampleHandoverContext.ceReview);
            if (sampleHandoverContext.ceDeclarationDate) formData.append('ceDeclarationDate', sampleHandoverContext.ceDeclarationDate);
            if (sampleHandoverContext.ceNotes) formData.append('ceNotes', sampleHandoverContext.ceNotes);
            if (sampleHandoverContext.fourMReview) formData.append('fourMReview', sampleHandoverContext.fourMReview);
            if (sampleHandoverContext.fourMDeclarationDate) formData.append('fourMDeclarationDate', sampleHandoverContext.fourMDeclarationDate);
            if (sampleHandoverContext.sampleHandoverStatus) formData.append('sampleHandoverStatus', sampleHandoverContext.sampleHandoverStatus);
            if (sampleHandoverContext.sampleHandoverNotes) formData.append('sampleHandoverNotes', sampleHandoverContext.sampleHandoverNotes);
          }
          
          // Tr·∫°ng th√°i v√† ghi ch√∫ m·ªõi
          formData.append('handover_status', status);
          formData.append('handover_notes', notes);
          formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          formData.append('action', 'sample_handover_submit');
          formData.append('form_type', 'Sample Handover');
          
          // T·∫°o metadata JSON v·ªõi ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng
          const metadata = {
            action: 'sample_handover_submit',
            form_type: 'Sample Handover',
            person_name: sampleHandoverContext?.name || '',
            task_id: sampleHandoverContext?.taskId || '',
            code: sampleHandoverContext?.code || '',
            task_name: sampleHandoverContext?.taskName || '',
            f7emailassignee: sampleHandoverContext?.f7emailassignee || '',
            handover_status: status,
            handover_notes: notes,
            timestamp_iso: new Date().toISOString(),
            // G·ª≠i ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng t·ª´ rowData
            ...(sampleHandoverContext?.Id && { Id: sampleHandoverContext.Id }),
            ...(sampleHandoverContext?.actualCompletionDate && { actualCompletionDate: sampleHandoverContext.actualCompletionDate }),
            ...(sampleHandoverContext?.reportCode && { reportCode: sampleHandoverContext.reportCode }),
            ...(sampleHandoverContext?.evaluationResult && { evaluationResult: sampleHandoverContext.evaluationResult }),
            ...(sampleHandoverContext?.notes && { original_notes: sampleHandoverContext.notes }),
            ...(sampleHandoverContext?.ceReview && { ceReview: sampleHandoverContext.ceReview }),
            ...(sampleHandoverContext?.ceDeclarationDate && { ceDeclarationDate: sampleHandoverContext.ceDeclarationDate }),
            ...(sampleHandoverContext?.ceNotes && { ceNotes: sampleHandoverContext.ceNotes }),
            ...(sampleHandoverContext?.fourMReview && { fourMReview: sampleHandoverContext.fourMReview }),
            ...(sampleHandoverContext?.fourMDeclarationDate && { fourMDeclarationDate: sampleHandoverContext.fourMDeclarationDate }),
            ...(sampleHandoverContext?.sampleHandoverStatus && { sampleHandoverStatus: sampleHandoverContext.sampleHandoverStatus }),
            ...(sampleHandoverContext?.sampleHandoverNotes && { sampleHandoverNotes: sampleHandoverContext.sampleHandoverNotes })
          };
          
          formData.append('metadata_json', JSON.stringify(metadata));
          formData.append('body', JSON.stringify(metadata));
          
          console.log('[Sample Handover Debug] B·∫Øt ƒë·∫ßu g·ª≠i d·ªØ li·ªáu...');
          console.log('[Sample Handover Debug] Metadata:', metadata);
          
          // Ch·ªâ s·ª≠ d·ª•ng CORS mode ƒë·ªÉ tr√°nh redirect v√† GET request kh√¥ng mong mu·ªën
          const baseUrl = FORM7_SAMPLE_HANDOVER_URL;
          const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
          const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
          
          let success = false;
          let lastError = null;
          
          // 1. Th·ª≠ test URL v·ªõi CORS
          try {
            console.log('[Sample Handover Debug] [1/2] Th·ª≠ test URL v·ªõi CORS...');
            const r1 = await fetch(testUrl, { 
              method: 'POST', 
              body: formData, 
              mode: 'cors',
              credentials: 'omit'
            });
            if (r1.ok) {
              const responseText = await r1.text().catch(() => '');
              console.log('[Sample Handover Debug] ‚úÖ Test CORS th√†nh c√¥ng!');
              console.log('[Sample Handover Debug] Response:', responseText);
              success = true;
            } else {
              const errText = await r1.text().catch(() => '');
              console.log('[Sample Handover Debug] ‚ùå Test CORS failed:', r1.status, errText);
              throw new Error(`HTTP ${r1.status}: ${errText}`);
            }
          } catch (e1) {
            console.warn('[Sample Handover Debug] [1/2] Test CORS th·∫•t b·∫°i:', e1.message);
            lastError = e1;
            
            // 2. Th·ª≠ prod URL v·ªõi CORS
            try {
              console.log('[Sample Handover Debug] [2/2] Th·ª≠ prod URL v·ªõi CORS...');
              const r2 = await fetch(prodUrl, { 
                method: 'POST', 
                body: formData, 
                mode: 'cors',
                credentials: 'omit'
              });
              if (r2.ok) {
                const responseText = await r2.text().catch(() => '');
                console.log('[Sample Handover Debug] ‚úÖ Prod CORS th√†nh c√¥ng!');
                console.log('[Sample Handover Debug] Response:', responseText);
                success = true;
              } else {
                const errText = await r2.text().catch(() => '');
                console.log('[Sample Handover Debug] ‚ùå Prod CORS failed:', r2.status, errText);
                throw new Error(`HTTP ${r2.status}: ${errText}`);
              }
            } catch (e2) {
              console.error('[Sample Handover Debug] [2/2] Prod CORS th·∫•t b·∫°i:', e2.message);
              lastError = e2;
            }
          }
          
          if (!success) {
            // N·∫øu server tr·∫£ v·ªÅ 500, c√≥ th·ªÉ do t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng
            if (lastError && lastError.message.includes('500')) {
              console.log('[Sample Handover Debug] Server 500 error - c√≥ th·ªÉ do t·∫°m th·ªùi, th·ª≠ l·∫°i sau 3 gi√¢y...');
              showToast('Server t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng, ƒëang th·ª≠ l·∫°i...', 'warning');
              
              // Th·ª≠ l·∫°i sau 3 gi√¢y
              setTimeout(async () => {
                try {
                  console.log('[Sample Handover Debug] Retry attempt...');
                  const retryResponse = await fetch(prodUrl, { 
                    method: 'POST', 
                    body: formData, 
                    mode: 'cors',
                    credentials: 'omit'
                  });
                  
                  if (retryResponse.ok) {
                    const retryText = await retryResponse.text().catch(() => '');
                    console.log('[Sample Handover Debug] ‚úÖ Retry th√†nh c√¥ng!');
                    console.log('[Sample Handover Debug] Retry Response:', retryText);
                    showToast('B√†n giao m·∫´u th√†nh c√¥ng! (retry)', 'success');
                    closeSampleHandoverModal();
                    // T·∫£i l·∫°i b·∫£ng Form 7
                    if (typeof renderForm7 === 'function') {
                      await renderForm7();
                    }
                  } else {
                    const retryErrText = await retryResponse.text().catch(() => '');
                    console.log('[Sample Handover Debug] ‚ùå Retry failed:', retryResponse.status, retryErrText);
                    showToast('B√†n giao m·∫´u th·∫•t b·∫°i: ' + retryErrText, 'error');
                  }
                } catch (retryErr) {
                  console.error('[Sample Handover Debug] ‚ùå Retry error:', retryErr);
                  showToast('B√†n giao m·∫´u th·∫•t b·∫°i: ' + retryErr.message, 'error');
                }
              }, 3000);
              return; // Kh√¥ng throw error ngay
            }
            
            throw lastError || new Error('T·∫•t c·∫£ ph∆∞∆°ng √°n g·ª≠i ƒë·ªÅu th·∫•t b·∫°i');
          }
          
          console.log('[Sample Handover Debug] ‚úÖ Request g·ª≠i th√†nh c√¥ng!');
          showToast('Khai b√°o m·∫´u b√†n giao th√†nh c√¥ng!', 'success');
          closeSampleHandoverModal();
          // T·∫£i l·∫°i b·∫£ng Form 7 ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi
          if (typeof renderForm7 === 'function') {
            await renderForm7();
          }
          
        } catch (error) {
          console.error('[Sample Handover Debug] ‚ùå L·ªói g·ª≠i d·ªØ li·ªáu:', error);
          showToast('Khai b√°o m·∫´u b√†n giao th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        } finally {
          sampleHandoverIsSubmitting = false;
          const btn = document.getElementById('sample-handover-submit');
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'X√°c nh·∫≠n';
          }
        }
      }

      // Event listeners cho Form 7 modal C≈® - ƒê√É V√î HI·ªÜU H√ìA
      // Modal c≈© ƒë√£ b·ªã x√≥a, c√°c listeners n√†y kh√¥ng c√≤n t√°c d·ª•ng
      // Gi·ªØ l·∫°i ƒë·ªÉ tr√°nh l·ªói reference trong code c≈©
      const form7Modal = null; // Modal c≈© ƒë√£ b·ªã x√≥a
      const form7CloseBtn = null;
      const form7CancelBtn = null;
      const form7SubmitBtn = null;
      
      console.log('‚ÑπÔ∏è Form 7: ƒêang s·ª≠ d·ª•ng modal Subpanel m·ªõi (form7-subpanel-modal)');

      // ===== Event listeners cho CE Review Modal =====
      const ceReviewModal = document.getElementById('ce-review-modal');
      const ceReviewCloseBtn = document.getElementById('ce-review-close');
      const ceReviewCancelBtn = document.getElementById('ce-review-cancel');
      const ceReviewSubmitBtn = document.getElementById('ce-review-submit');

      if (ceReviewCloseBtn) {
        ceReviewCloseBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeCeReviewModal();
        });
      }

      if (ceReviewCancelBtn) {
        ceReviewCancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeCeReviewModal();
        });
      }

      if (ceReviewSubmitBtn) {
        ceReviewSubmitBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          await submitCeReview();
        });
      }

      // ===== Event listeners cho 4M Review Modal =====
      const fourMReviewModal = document.getElementById('4m-review-modal');
      const fourMReviewCloseBtn = document.getElementById('4m-review-close');
      const fourMReviewCancelBtn = document.getElementById('4m-review-cancel');
      const fourMReviewSubmitBtn = document.getElementById('4m-review-submit');

      if (fourMReviewCloseBtn) {
        fourMReviewCloseBtn.addEventListener('click', (e) => {
          e.preventDefault();
          close4mReviewModal();
        });
      }

      if (fourMReviewCancelBtn) {
        fourMReviewCancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          close4mReviewModal();
        });
      }

      if (fourMReviewSubmitBtn) {
        fourMReviewSubmitBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          await submit4mReview();
        });
      }

      // Close modal khi click outside
      if (form7Modal) {
        form7Modal.addEventListener('click', (e) => {
          if (e.target === form7Modal) {
            closeForm7Modal();
          }
        });
      }

      if (ceReviewModal) {
        ceReviewModal.addEventListener('click', (e) => {
          if (e.target === ceReviewModal) {
            closeCeReviewModal();
          }
        });
      }

      if (fourMReviewModal) {
        fourMReviewModal.addEventListener('click', (e) => {
          if (e.target === fourMReviewModal) {
            close4mReviewModal();
          }
        });
      }

      // ===== Event listeners cho Form 8 Subpanel Modal =====
      const form8SubpanelModal = document.getElementById('form8-subpanel-modal');
      const form8SubpanelCloseBtn = document.getElementById('form8-subpanel-close');
      const form8SubpanelCancelBtn = document.getElementById('form8-subpanel-cancel');
      const form8SubpanelSubmitBtn = document.getElementById('form8-subpanel-submit');

      if (form8SubpanelCloseBtn) {
        form8SubpanelCloseBtn.addEventListener('click', closeForm8SubpanelModal);
      }
      if (form8SubpanelCancelBtn) {
        form8SubpanelCancelBtn.addEventListener('click', closeForm8SubpanelModal);
      }
      if (form8SubpanelSubmitBtn) {
        form8SubpanelSubmitBtn.addEventListener('click', submitForm8SubpanelModal);
      }
      if (form8SubpanelModal) {
        form8SubpanelModal.addEventListener('click', (e) => {
          if (e.target === form8SubpanelModal) {
            closeForm8SubpanelModal();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !form8SubpanelModal.classList.contains('hidden')) {
            closeForm8SubpanelModal();
          }
        });
      }


      // ===== Event listeners cho Form 7 Subpanel Modal =====
      const form7SubpanelModal = document.getElementById('form7-subpanel-modal');
      const form7SubpanelCloseBtn = document.getElementById('form7-subpanel-close');
      const form7SubpanelCancelBtn = document.getElementById('form7-subpanel-cancel');
      const form7SubpanelSubmitBtn = document.getElementById('form7-subpanel-submit');

      if (form7SubpanelCloseBtn) {
        form7SubpanelCloseBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeForm7SubpanelModal();
        });
      }

      if (form7SubpanelCancelBtn) {
        form7SubpanelCancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeForm7SubpanelModal();
        });
      }

      if (form7SubpanelSubmitBtn) {
        form7SubpanelSubmitBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          await submitForm7SubpanelModal();
        });
      }

      if (form7SubpanelModal) {
        form7SubpanelModal.addEventListener('click', (e) => {
          if (e.target === form7SubpanelModal) {
            closeForm7SubpanelModal();
          }
        });
        // ƒê·∫£m b·∫£o ·∫©n khi load trang
        form7SubpanelModal.classList.remove('open');
        form7SubpanelModal.classList.add('hidden');
        form7SubpanelModal.setAttribute('aria-hidden','true');
      }

      // Close modal v·ªõi ph√≠m Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (form7Modal && !form7Modal.classList.contains('hidden')) {
            closeForm7Modal();
          } else if (ceReviewModal && !ceReviewModal.classList.contains('hidden')) {
            closeCeReviewModal();
          } else if (fourMReviewModal && !fourMReviewModal.classList.contains('hidden')) {
            close4mReviewModal();
          } else if (form7SubpanelModal && !form7SubpanelModal.classList.contains('hidden')) {
            closeForm7SubpanelModal();
          } else {
            const sampleHandoverModal = document.getElementById('sample-handover-modal');
            if (sampleHandoverModal && !sampleHandoverModal.classList.contains('hidden')) {
              closeSampleHandoverModal();
            }
          }
        }
      });

      // ===== Event listeners cho Sample Handover Modal =====
      const sampleHandoverModal = document.getElementById('sample-handover-modal');
      const sampleHandoverCloseBtn = document.getElementById('sample-handover-close');
      const sampleHandoverCancelBtn = document.getElementById('sample-handover-cancel');
      const sampleHandoverSubmitBtn = document.getElementById('sample-handover-submit');

      if (sampleHandoverCloseBtn) {
        sampleHandoverCloseBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeSampleHandoverModal();
        });
      }

      if (sampleHandoverCancelBtn) {
        sampleHandoverCancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeSampleHandoverModal();
        });
      }

      if (sampleHandoverSubmitBtn) {
        sampleHandoverSubmitBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          await submitSampleHandover();
        });
      }

      if (sampleHandoverModal) {
        sampleHandoverModal.addEventListener('click', (e) => {
          if (e.target === sampleHandoverModal) {
            closeSampleHandoverModal();
          }
        });
        // ƒê·∫£m b·∫£o ·∫©n khi load trang
        sampleHandoverModal.classList.remove('open');
        sampleHandoverModal.classList.add('hidden');
        sampleHandoverModal.setAttribute('aria-hidden','true');
      }

      // ===== Kh·ªüi t·∫°o dropdown cho Form 8 (Form 7 ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ·ªü d√≤ng 2915) =====
      const f8NameSelect = document.getElementById('f8-name');
      
      // S·ª≠ d·ª•ng danh s√°ch t√™n gi·ªëng Form 1
      const FORM8_NAMES = FORM1_NAMES;
      
      // Kh·ªüi t·∫°o dropdown cho Form 8
      if (f8NameSelect) {
        FORM8_NAMES.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          f8NameSelect.appendChild(option);
        });
      }

      console.log('Form 7: Modal v√† handlers ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
      console.log('Form 8: Dropdown v√† tra c·ª©u ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
      // ===== Form 5 P4: Render using P3 data =====
      function renderForm5P4(){
        try{
          const body = document.getElementById('f5a-body-p4');
          if (!body) return;

          // Get month filter
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          // Check if P4 data is available
          if(!F5A_P4_RAW || F5A_P4_RAW.length === 0){
            body.innerHTML = `
              <tr>
                <td colspan="10" class="px-3 py-3 text-center">
                  <div class="text-gray-500 mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                  <div class="text-sm text-blue-600">üëÜ Nh·∫•n n√∫t <b>"Tra c·ª©u P4"</b> ·ªü tr√™n ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
                </td>
              </tr>
            `;
            return;
          }

          // Helper functions (same as P3)
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){
                const d = new Date(+m[3], +m[2]-1, +m[1]);
                return isNaN(d) ? null : d;
              }
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){
                const d = new Date(+m[1], +m[2]-1, +m[3]);
                return isNaN(d) ? null : d;
              }
              const d = new Date(s);
              return isNaN(d) ? null : d;
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            const yy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            return `${yy}-${mm}`;
          };
          
          // Aggregate by employee with completion percentages
          const byName = new Map();
          
          let processedCount = 0;
          let skippedNoName = 0;
          let skippedWrongMonth = 0;
          let skippedNotProduct = 0;
          
          F5A_P4_RAW.forEach(r => {
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            if(!name) {
              skippedNoName++;
              return;
            }
            
            // Skip tasks assigned to "x" (pending tasks)
            if(name.toLowerCase() === 'x') {
              return;
            }
            
            // Skip tasks assigned to blacklisted employees
            if (isNameInBlacklist(name)) {
              return;
            }
            
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh',
              'completion date','completiondate',
              'actual completion date','actualcompletiondate'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            // Prefer month filter by 'Ng√†y khai b√°o 4M' -> 'Ng√†y khai b√°o CE' -> completion date
            const fourMDateStr = getV(r,[ 'Ng√†y khai b√°o 4M','ngay khai bao 4m','ng√†y khai b√°o 4m','4m_date','4mdate' ]);
            const ceDateStr = getV(r,[ 'Ng√†y khai b√°o CE','ngay khai bao ce','ng√†y khai b√°o ce','cedate','ce_date' ]);
            const fourMDate = parseDate(fourMDateStr);
            const ceDate = parseDate(ceDateStr);
            // Form 8 gi·ªëng ƒëi·ªÅu ki·ªán: ∆∞u ti√™n Ng√†y ho√†n th√†nh th·ª±c t·∫ø, thi·∫øu m·ªõi fallback CE/4M
            const refDate = completionDate || ceDate || fourMDate;
            // Filter by selected month using refDate
            if (monthVal){
              if (!refDate){ skippedWrongMonth++; return; }
              const taskMonth = formatYyyyMm(refDate);
              if (taskMonth !== monthVal){ skippedWrongMonth++; return; }
            }
            
            // Ch·ªâ l·∫•y c√°c t√°c v·ª• c√≥ "Ph√¢n lo·∫°i" = "S·∫£n ph·∫©m"
            const classification = String(getV(r,[ 'Ph√¢n lo·∫°i','phan loai','phanloai','classification','loai','lo·∫°i' ])||'').trim();
            const clsNorm = (typeof vnLower==='function') ? vnLower(classification) : classification.toLowerCase();
            if (clsNorm !== 'san pham' && clsNorm !== 's·∫£n ph·∫©m') { skippedNotProduct++; return; }
            
            processedCount++;
            
            if(!byName.has(name)){
              byName.set(name, { 
                name, 
                totalTasks: 0,
                tcktTotal: 0, tcktCompleted: 0,
                ceTotal: 0, ceCompleted: 0,
                hdktTotal: 0, hdktCompleted: 0,
                bbTotal: 0, bbCompleted: 0,
                jigTotal: 0, jigCompleted: 0,
                khksclTotal: 0, khksclCompleted: 0,
                notNeeded4m: 0
              });
            }
            
            const rec = byName.get(name);
            rec.totalTasks += 1; // Count only tasks with "4M r√† so√°t" not empty
            
            // Get completion percentages for each category (exact JSON field names)
            const tckt = String(getV(r, [
              'TCKT(% ho√†n th√†nh)','tckt(% ho√†n th√†nh)',
              'tckt','TCKT','tckt % ho√†n th√†nh'
            ])||'').trim();
            const ce = String(getV(r, [
              'CE(% ho√†n th√†nh)','ce(% ho√†n th√†nh)',
              'ce','CE','ce % ho√†n th√†nh'
            ])||'').trim();
            const hdkt = String(getV(r, [
              'HDKT(% ho√†n th√†nh)','hdkt(% ho√†n th√†nh)',
              'hdkt','HDKT','hdkt % ho√†n th√†nh'
            ])||'').trim();
            const bb = String(getV(r, [
              'BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o(% ho√†n th√†nh)',
              'bb ƒë√†o t·∫°o','BB ƒë√†o t·∫°o','bb','bb dao tao'
            ])||'').trim();
            const jig = String(getV(r, [
              'Jig tool(% ho√†n th√†nh)','jig tool(% ho√†n th√†nh)',
              'jig tool','Jig tool','jig','jigtool'
            ])||'').trim();
            const khkscl = String(getV(r, [
              'KHKSCL(% ho√†n th√†nh)','khkscl(% ho√†n th√†nh)',
              'khkscl','KHKSCL','khkscl % ho√†n th√†nh'
            ])||'').trim();
            
            // Parse percentage values and accumulate (for average calculation)
            const parsePercent = (val) => {
              if(!val) return 0;
              let v = String(val).replace('%','').trim();
              // Chu·∫©n h√≥a d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m
              if (v.includes(',') && !v.includes('.')) v = v.replace(',', '.');
              const num = parseFloat(v);
              if(isNaN(num)) return 0;
              // Convert 0-1 range to 0-100 range
              return num <= 1 && num > 0 ? num * 100 : num;
            };
            
            // Accumulate percentage values for average calculation
            // N·∫øu 4M r√† so√°t = "Kh√¥ng c·∫ßn" => t√≠nh 100% cho t·∫•t c·∫£ h·∫°ng m·ª•c
            const fourMStatus = String(getV(r, [ '4M r√† so√°t','4m r√† so√°t','4m ra soat','4M','4m rasoat','rasoat4m' ])||'').trim();
            const fourMNorm = (typeof vnLower==='function') ? vnLower(fourMStatus) : fourMStatus.toLowerCase();
            // Ki·ªÉm tra c√°c bi·∫øn th·ªÉ: "kh√¥ng c·∫ßn", "kh√¥ng c·∫ßn r√† so√°t", "kh√¥ng c·∫ßn khai b√°o"
            const isNotNeeded = (fourMNorm.includes('khong can') || fourMNorm.includes('kh√¥ng c·∫ßn'));
            if (isNotNeeded) rec.notNeeded4m += 1;
            const pTCKT = isNotNeeded ? 100 : parsePercent(tckt);
            const pCE = isNotNeeded ? 100 : parsePercent(ce);
            const pHDKT = isNotNeeded ? 100 : parsePercent(hdkt);
            const pBB = isNotNeeded ? 100 : parsePercent(bb);
            const pJIG = isNotNeeded ? 100 : parsePercent(jig);
            const pKH = isNotNeeded ? 100 : parsePercent(khkscl);
            rec.tcktTotal += 1; rec.tcktCompleted += pTCKT;
            rec.ceTotal += 1; rec.ceCompleted += pCE;
            rec.hdktTotal += 1; rec.hdktCompleted += pHDKT;
            rec.bbTotal += 1; rec.bbCompleted += pBB;
            rec.jigTotal += 1; rec.jigCompleted += pJIG;
            rec.khksclTotal += 1; rec.khksclCompleted += pKH;
          });
          
          // Sort by name
          const sorted = Array.from(byName.values()).sort((a,b) => a.name.localeCompare(b.name, 'vi'));
          
          // Generate rows with completion percentages (average values)
          const rowsP4 = [];
          let sumTotal = 0, sumTckt = 0, sumCe = 0, sumHdkt = 0, sumBb = 0, sumJig = 0, sumKhkscl = 0, sumP4 = 0;
          
          sorted.forEach(r => {
            // Calculate AVERAGE percentages for each category (with 2 decimal places)
            const tcktPercentage = r.tcktTotal > 0 ? (r.tcktCompleted / r.tcktTotal).toFixed(2) : '0.00';
            const cePercentage = r.ceTotal > 0 ? (r.ceCompleted / r.ceTotal).toFixed(2) : '0.00';
            const hdktPercentage = r.hdktTotal > 0 ? (r.hdktCompleted / r.hdktTotal).toFixed(2) : '0.00';
            const bbPercentage = r.bbTotal > 0 ? (r.bbCompleted / r.bbTotal).toFixed(2) : '0.00';
            const jigPercentage = r.jigTotal > 0 ? (r.jigCompleted / r.jigTotal).toFixed(2) : '0.00';
            const khksclPercentage = r.khksclTotal > 0 ? (r.khksclCompleted / r.khksclTotal).toFixed(2) : '0.00';
            
            // Calculate "Th·∫ª P4 (%)" - average of all 6 categories (always divide by 6)
            const tcktVal = parseFloat(tcktPercentage);
            const ceVal = parseFloat(cePercentage);
            const hdktVal = parseFloat(hdktPercentage);
            const bbVal = parseFloat(bbPercentage);
            const jigVal = parseFloat(jigPercentage);
            const khksclVal = parseFloat(khksclPercentage);
            
            // Always sum all 6 values (0% for empty categories) and divide by 6
            const totalSum = tcktVal + ceVal + hdktVal + bbVal + jigVal + khksclVal;
            const p4Percentage = (totalSum / 6).toFixed(2);
            
            sumTotal += r.totalTasks;
            sumTckt += parseFloat(tcktPercentage);
            sumCe += parseFloat(cePercentage);
            sumHdkt += parseFloat(hdktPercentage);
            sumBb += parseFloat(bbPercentage);
            sumJig += parseFloat(jigPercentage);
            sumKhkscl += parseFloat(khksclPercentage);
            sumP4 += parseFloat(p4Percentage);
            
            rowsP4.push(`
              <tr>
                <td class="px-3 py-2 font-medium">${r.name}</td>
                <td class="px-3 py-2 text-center font-semibold cursor-pointer hover:bg-blue-50" onclick="openP4MachineModal('${r.name.replace(/'/g, "\\'")}', '${monthVal}')" title="Click ƒë·ªÉ xem chi ti·∫øt t√°c v·ª• m√°y">
                  ${r.totalTasks}
                </td>
                <td class="px-3 py-2 text-center font-semibold">${r.notNeeded4m || 0}</td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(tcktPercentage) >= 80 ? 'text-green-600' : parseFloat(tcktPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${tcktPercentage}%</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(cePercentage) >= 80 ? 'text-green-600' : parseFloat(cePercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${cePercentage}%</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(hdktPercentage) >= 80 ? 'text-green-600' : parseFloat(hdktPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${hdktPercentage}%</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(bbPercentage) >= 80 ? 'text-green-600' : parseFloat(bbPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${bbPercentage}%</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(jigPercentage) >= 80 ? 'text-green-600' : parseFloat(jigPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${jigPercentage}%</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(khksclPercentage) >= 80 ? 'text-green-600' : parseFloat(khksclPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${khksclPercentage}%</span>
                </td>
                <td class="px-3 py-2 text-center">
                  <span class="font-semibold ${parseFloat(p4Percentage) >= 80 ? 'text-green-600' : parseFloat(p4Percentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${p4Percentage}%</span>
                </td>
              </tr>
            `);
          });
          
          // Add total row with average percentages (with 2 decimal places)
          const avgTckt = sorted.length > 0 ? (sumTckt / sorted.length).toFixed(2) : '0.00';
          const avgCe = sorted.length > 0 ? (sumCe / sorted.length).toFixed(2) : '0.00';
          const avgHdkt = sorted.length > 0 ? (sumHdkt / sorted.length).toFixed(2) : '0.00';
          const avgBb = sorted.length > 0 ? (sumBb / sorted.length).toFixed(2) : '0.00';
          const avgJig = sorted.length > 0 ? (sumJig / sorted.length).toFixed(2) : '0.00';
          const avgKhkscl = sorted.length > 0 ? (sumKhkscl / sorted.length).toFixed(2) : '0.00';
          const avgP4 = sorted.length > 0 ? (sumP4 / sorted.length).toFixed(2) : '0.00';
          
          const totalNotNeeded = sorted.reduce((a,b)=> a + (b.notNeeded4m||0), 0);
          const totalRow = `
            <tr class="bg-blue-50 font-semibold">
              <td class="px-3 py-2">T·ªîNG</td>
              <td class="px-3 py-2 text-center">${sumTotal}</td>
              <td class="px-3 py-2 text-center">${totalNotNeeded}</td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgTckt) >= 80 ? 'text-green-600' : parseFloat(avgTckt) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgTckt}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgCe) >= 80 ? 'text-green-600' : parseFloat(avgCe) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgCe}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgHdkt) >= 80 ? 'text-green-600' : parseFloat(avgHdkt) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgHdkt}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgBb) >= 80 ? 'text-green-600' : parseFloat(avgBb) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgBb}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgJig) >= 80 ? 'text-green-600' : parseFloat(avgJig) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgJig}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgKhkscl) >= 80 ? 'text-green-600' : parseFloat(avgKhkscl) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgKhkscl}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-bold ${parseFloat(avgP4) >= 80 ? 'text-green-600' : parseFloat(avgP4) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgP4}%</span>
              </td>
            </tr>
          `;
          
          body.innerHTML = (rowsP4.join('') + totalRow) || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          
          // Enable table drag
          try{ enableTableDrag('f5a-body-p4'); }catch(_){ }
          
          // Render dashboard P4
          renderDashboardP4();
          
          console.log('[F5A P4] Rendered', sorted.length, 'employees with enhanced analysis');
          
        }catch(err){
          console.error('[F5A P4] Render error:', err);
          const body = document.getElementById('f5a-body-p4');
          if(body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="10">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu</td></tr>';
        }
      }

      // ===== Form 5: Dashboard Render Functions =====
      
      // Render Dashboard P1
      function renderDashboardP1() {
        try {
          const dashboard = document.getElementById('f5a-dashboard-p1');
          if (!dashboard) return;
          
          if (!F5A_P1_DATA || !Array.isArray(F5A_P1_DATA.data) || F5A_P1_DATA.data.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          dashboard.classList.remove('hidden');
          
          const data = F5A_P1_DATA.data.filter(item => {
            const name = (item['Ph·ª• tr√°ch'] || item.name || '').trim();
            if (name.toLowerCase() === 'x') return false;
            if (isNameInBlacklist(name)) return false;
            return true;
          });
          
          if (data.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          // Chart 1: T·ª∑ l·ªá tr·∫°ng th√°i (stacked bar)
          const canvas1 = document.getElementById('f5a-chart-p1-status');
          if (canvas1) {
            const ctx1 = canvas1.getContext('2d');
            if (F5A_CHART_P1_STATUS) F5A_CHART_P1_STATUS.destroy();
            
            const labels = data.map(d => d['Ph·ª• tr√°ch'] || d.name || '');
            const ahead = data.map(d => Number(d.ahead || 0));
            const ontime = data.map(d => Number(d.ontime || 0));
            const late = data.map(d => Number(d.late || 0));
            
            F5A_CHART_P1_STATUS = new Chart(ctx1, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  { label: 'V∆∞·ª£t ti·∫øn ƒë·ªô', data: ahead, backgroundColor: 'rgba(147,197,253,0.9)', borderColor: '#93c5fd', borderWidth: 1, stack: 'status' },
                  { label: 'ƒê√∫ng ti·∫øn ƒë·ªô', data: ontime, backgroundColor: 'rgba(134,239,172,0.85)', borderColor: '#86efac', borderWidth: 1, stack: 'status' },
                  { label: 'Ch·∫≠m ti·∫øn ƒë·ªô', data: late, backgroundColor: 'rgba(254,202,202,0.9)', borderColor: '#fecaca', borderWidth: 1, stack: 'status' }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { stacked: true, ticks: { maxRotation: 45, minRotation: 0, font: { size: 10 } } },
                  y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
                },
                plugins: {
                  legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                  tooltip: { mode: 'index', intersect: false }
                }
              }
            });
          }
          
          // Chart 2: T·ªïng c√¥ng chu·∫©n
          const canvas2 = document.getElementById('f5a-chart-p1-manhour');
          if (canvas2) {
            const ctx2 = canvas2.getContext('2d');
            if (F5A_CHART_P1_MANHOUR) F5A_CHART_P1_MANHOUR.destroy();
            
            const sorted = data.slice().sort((a, b) => {
              const manA = Number(a['T·ªïng c√¥ng chu·∫©n'] || a.totalByRef || 0);
              const manB = Number(b['T·ªïng c√¥ng chu·∫©n'] || b.totalByRef || 0);
              return manB - manA;
            });
            
            const labels2 = sorted.map(d => d['Ph·ª• tr√°ch'] || d.name || '');
            const manhours = sorted.map(d => Number(d['T·ªïng c√¥ng chu·∫©n'] || d.totalByRef || 0));
            
            F5A_CHART_P1_MANHOUR = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: labels2,
                datasets: [{
                  label: 'C√¥ng chu·∫©n',
                  data: manhours,
                  backgroundColor: 'rgba(90, 169, 255, 0.6)',
                  borderColor: '#5aa9ff',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                  x: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'C√¥ng chu·∫©n' } },
                  y: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Nh√¢n vi√™n' } }
                },
                plugins: {
                  legend: { display: false },
                  tooltip: { callbacks: { label: (ctx) => `C√¥ng chu·∫©n: ${ctx.parsed.x.toFixed(2)}` } }
                }
              }
            });
          }
        } catch (err) {
          console.error('[Dashboard P1] Error:', err);
        }
      }
      
      // Render Dashboard P2
      function renderDashboardP2() {
        try {
          const dashboard = document.getElementById('f5a-dashboard-p2');
          if (!dashboard) return;
          
          if (!F5A_P2_DATA || !Array.isArray(F5A_P2_DATA.data) || F5A_P2_DATA.data.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          dashboard.classList.remove('hidden');
          
          const data = F5A_P2_DATA.data.filter(item => {
            const name = (item.name || item['Ph·ª• tr√°ch'] || '').trim();
            return !isNameInBlacklist(name);
          });
          
          if (data.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          const parseNumber = (str) => {
            if (!str) return 0;
            const cleaned = String(str).replace(/[^0-9.,-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
          };
          
          // Helper function ƒë·ªÉ parse coefficient (x·ª≠ l√Ω d·∫•u ph·∫©y)
          const parseCoefficient = (coef) => {
            if (!coef || coef === '') return 0;
            let cleaned = String(coef).trim();
            if (cleaned.includes(',') && !cleaned.includes('.')) {
              cleaned = cleaned.replace(',', '.');
            } else if (cleaned.includes(',') && cleaned.includes('.')) {
              cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            }
            return parseFloat(cleaned) || 0;
          };
          
          // Chart 1: H·ªá s·ªë
          const canvas1 = document.getElementById('f5a-chart-p2-coefficient');
          if (canvas1) {
            const ctx1 = canvas1.getContext('2d');
            if (F5A_CHART_P2_COEFFICIENT) F5A_CHART_P2_COEFFICIENT.destroy();
            
            const sorted = data.slice().sort((a, b) => {
              const coefA = parseCoefficient(a.coefficient || '0');
              const coefB = parseCoefficient(b.coefficient || '0');
              return coefB - coefA;
            });
            
            const labels = sorted.map(d => d.name || d['Ph·ª• tr√°ch'] || '');
            const coefficients = sorted.map(d => parseCoefficient(d.coefficient || '0'));
            
            F5A_CHART_P2_COEFFICIENT = new Chart(ctx1, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'H·ªá s·ªë',
                  data: coefficients,
                  backgroundColor: coefficients.map(c => {
                    if (c >= 0.8) return 'rgba(34,197,94,0.7)'; // green
                    if (c >= 0.6) return 'rgba(59,130,246,0.7)'; // blue
                    if (c >= 0.4) return 'rgba(234,179,8,0.7)'; // yellow
                    return 'rgba(239,68,68,0.7)'; // red
                  }),
                  borderColor: coefficients.map(c => {
                    if (c >= 0.8) return '#22c55e';
                    if (c >= 0.6) return '#3b82f6';
                    if (c >= 0.4) return '#eab308';
                    return '#ef4444';
                  }),
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                  x: { beginAtZero: true, max: 2, ticks: { precision: 2 }, title: { display: true, text: 'H·ªá s·ªë' } },
                  y: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Nh√¢n vi√™n' } }
                },
                plugins: {
                  legend: { display: false },
                  tooltip: { callbacks: { label: (ctx) => `H·ªá s·ªë: ${ctx.parsed.x.toFixed(2)}` } }
                }
              }
            });
          }
          
          // Chart 2: So s√°nh gi·ªù c√¥ng
          const canvas2 = document.getElementById('f5a-chart-p2-hours');
          if (canvas2) {
            const ctx2 = canvas2.getContext('2d');
            if (F5A_CHART_P2_HOURS) F5A_CHART_P2_HOURS.destroy();
            
            const labels = data.map(d => d.name || d['Ph·ª• tr√°ch'] || '');
            const actualHours = data.map(d => parseNumber(d.totalActualHours || d['T·ªïng gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø'] || '0,00'));
            const manhours = data.map(d => parseNumber(d.manhourReceived || d['C√¥ng chu·∫©n ƒë√£ nh·∫≠n'] || '0,00'));
            const workHours = data.map(d => parseNumber(d.totalWorkHours || d['T·ªïng gi·ªù c√¥ng ƒëi l√†m'] || '0'));
            
            F5A_CHART_P2_HOURS = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  { label: 'Gi·ªù ƒë√°nh gi√° th·ª±c t·∫ø', data: actualHours, backgroundColor: 'rgba(59,130,246,0.6)', borderColor: '#3b82f6', borderWidth: 1 },
                  { label: 'C√¥ng chu·∫©n ƒë√£ nh·∫≠n', data: manhours, backgroundColor: 'rgba(34,197,94,0.6)', borderColor: '#22c55e', borderWidth: 1 },
                  { label: 'Gi·ªù c√¥ng ƒëi l√†m', data: workHours, backgroundColor: 'rgba(234,179,8,0.6)', borderColor: '#eab308', borderWidth: 1 }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { stacked: false, ticks: { maxRotation: 45, minRotation: 0, font: { size: 10 } } },
                  y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'Gi·ªù' } }
                },
                plugins: {
                  legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                  tooltip: { mode: 'index', intersect: false }
                }
              }
            });
          }
        } catch (err) {
          console.error('[Dashboard P2] Error:', err);
        }
      }
      
      // Render Dashboard P3
      function renderDashboardP3() {
        try {
          const dashboard = document.getElementById('f5a-dashboard-p3');
          if (!dashboard) return;
          
          if (!F5A_P3_RAW || !Array.isArray(F5A_P3_RAW) || F5A_P3_RAW.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          dashboard.classList.remove('hidden');
          
          // Get month filter (same as renderForm5P3)
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          // Aggregate data (same logic as renderForm5P3)
          const byName = new Map();
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          // Parse date flexible (same as renderForm5P3)
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              // DD/MM/YYYY HH:mm
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){
                const d = new Date(+m[3], +m[2]-1, +m[1]);
                return isNaN(d) ? null : d;
              }
              // YYYY-MM-DD
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){
                const d = new Date(+m[1], +m[2]-1, +m[3]);
                return isNaN(d) ? null : d;
              }
              const d = new Date(s);
              return isNaN(d) ? null : d;
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            const yy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            return `${yy}-${mm}`;
          };
          
          F5A_P3_RAW.forEach(r => {
            const name = String(getV(r, ['assignee','employee','name','nh√¢n vi√™n','ph·ª• tr√°ch'])||'').trim();
            if(!name || name.toLowerCase() === 'x') return;
            
            // Get completion date and filter by month (same as renderForm5P3)
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh',
              'completion date','completiondate',
              'actual completion date','actualcompletiondate'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            
            // Filter by month if specified (same as renderForm5P3)
            if(monthVal && completionDate){
              const taskMonth = formatYyyyMm(completionDate);
              if(taskMonth !== monthVal) return; // Skip if not in selected month
            } else if(monthVal && !completionDate) {
              return; // Skip tasks without completion date when month filter is active
            }
            
            if(!byName.has(name)){
              byName.set(name, { name, total: 0, completed: 0, notNeeded: 0, pending: 0 });
            }
            
            const rec = byName.get(name);
            const ceReview = String(getV(r, ['ce r√† so√°t','ce review','r√† so√°t ce'])||'').trim();
            const ceNorm = norm(ceReview);
            
            if(ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui'){
              rec.completed += 1;
            } else if(ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can'){
              rec.notNeeded += 1;
            } else {
              rec.pending += 1;
            }
            rec.total = rec.completed + rec.notNeeded + rec.pending;
          });
          
          const sorted = Array.from(byName.values()).sort((a,b) => a.name.localeCompare(b.name, 'vi'));
          
          if (sorted.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          // Chart 1: T·ª∑ l·ªá ho√†n th√†nh CE
          const canvas1 = document.getElementById('f5a-chart-p3-ce');
          if (canvas1) {
            const ctx1 = canvas1.getContext('2d');
            if (F5A_CHART_P3_CE) F5A_CHART_P3_CE.destroy();
            
            const labels = sorted.map(r => r.name);
            const percentages = sorted.map(r => r.total > 0 ? Math.round(((r.completed + r.notNeeded) / r.total) * 100) : 0);
            
            F5A_CHART_P3_CE = new Chart(ctx1, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'T·ª∑ l·ªá ho√†n th√†nh CE (%)',
                  data: percentages,
                  backgroundColor: percentages.map(p => {
                    if (p >= 80) return 'rgba(34,197,94,0.7)';
                    if (p >= 50) return 'rgba(59,130,246,0.7)';
                    return 'rgba(234,179,8,0.7)';
                  }),
                  borderColor: percentages.map(p => {
                    if (p >= 80) return '#22c55e';
                    if (p >= 50) return '#3b82f6';
                    return '#eab308';
                  }),
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                  x: { beginAtZero: true, max: 100, ticks: { precision: 0 }, title: { display: true, text: 'T·ª∑ l·ªá (%)' } },
                  y: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Nh√¢n vi√™n' } }
                },
                plugins: {
                  legend: { display: false },
                  tooltip: { callbacks: { label: (ctx) => `T·ª∑ l·ªá: ${ctx.parsed.x}%` } }
                }
              }
            });
          }
          
          // Chart 2: Ph√¢n b·ªï tr·∫°ng th√°i CE
          const canvas2 = document.getElementById('f5a-chart-p3-status');
          if (canvas2) {
            const ctx2 = canvas2.getContext('2d');
            if (F5A_CHART_P3_STATUS) F5A_CHART_P3_STATUS.destroy();
            
            const labels = sorted.map(r => r.name);
            const completed = sorted.map(r => r.completed);
            const notNeeded = sorted.map(r => r.notNeeded);
            const pending = sorted.map(r => r.pending);
            
            F5A_CHART_P3_STATUS = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  { label: 'ƒê√£ ho√†n thi·ªán', data: completed, backgroundColor: 'rgba(34,197,94,0.7)', borderColor: '#22c55e', borderWidth: 1, stack: 'status' },
                  { label: 'Kh√¥ng c·∫ßn', data: notNeeded, backgroundColor: 'rgba(59,130,246,0.7)', borderColor: '#3b82f6', borderWidth: 1, stack: 'status' },
                  { label: 'Ch∆∞a ho√†n th√†nh', data: pending, backgroundColor: 'rgba(234,179,8,0.7)', borderColor: '#eab308', borderWidth: 1, stack: 'status' }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { stacked: true, ticks: { maxRotation: 45, minRotation: 0, font: { size: 10 } } },
                  y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
                },
                plugins: {
                  legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                  tooltip: { mode: 'index', intersect: false }
                }
              }
            });
          }
        } catch (err) {
          console.error('[Dashboard P3] Error:', err);
        }
      }
      
      // Render Dashboard P4
      function renderDashboardP4() {
        try {
          const dashboard = document.getElementById('f5a-dashboard-p4');
          if (!dashboard) return;
          
          if (!F5A_P4_RAW || !Array.isArray(F5A_P4_RAW) || F5A_P4_RAW.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          // L·∫•y danh s√°ch nh√¢n vi√™n t·ª´ b·∫£ng P4 (ch·ªâ nh·ªØng ng∆∞·ªùi c√≥ trong b·∫£ng)
          const tableBody = document.getElementById('f5a-body-p4');
          if (!tableBody) {
            dashboard.classList.add('hidden');
            return;
          }
          
          // L·∫•y t·∫•t c·∫£ c√°c t√™n nh√¢n vi√™n t·ª´ b·∫£ng (b·ªè qua h√†ng T·ªîNG)
          const employeeNamesInTable = new Set();
          const rows = tableBody.querySelectorAll('tr');
          rows.forEach(row => {
            const firstCell = row.querySelector('td');
            if (firstCell && firstCell.textContent.trim() !== 'T·ªîNG') {
              const name = firstCell.textContent.trim();
              if (name) {
                employeeNamesInTable.add(name);
              }
            }
          });
          
          // N·∫øu kh√¥ng c√≥ nh√¢n vi√™n n√†o trong b·∫£ng, ·∫©n dashboard
          if (employeeNamesInTable.size === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          dashboard.classList.remove('hidden');
          
          // Aggregate data (same logic as renderForm5P4)
          const byName = new Map();
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parsePercent = (val) => {
            if(!val) return 0;
            let v = String(val).replace('%','').trim();
            if (v.includes(',') && !v.includes('.')) v = v.replace(',', '.');
            const num = parseFloat(v);
            if(isNaN(num)) return 0;
            return num <= 1 && num > 0 ? num * 100 : num;
          };
          
          // Helper function ƒë·ªÉ so s√°nh t√™n (gi·ªëng nh∆∞ trong renderForm5P4)
          const sameName = (a, b) => {
            try {
              const normalize = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim();
              return normalize(a) === normalize(b);
            } catch (_) {
              return String(a||'').toLowerCase().trim() === String(b||'').toLowerCase().trim();
            }
          };
          
          F5A_P4_RAW.forEach(r => {
            const name = String(getV(r, ['assignee','employee','name','nh√¢n vi√™n','ph·ª• tr√°ch'])||'').trim();
            if(!name || name.toLowerCase() === 'x') return;
            
            // CH·ªà l·∫•y nh·ªØng nh√¢n vi√™n c√≥ trong b·∫£ng P4
            let isInTable = false;
            for (const tableName of employeeNamesInTable) {
              if (sameName(name, tableName)) {
                isInTable = true;
                break;
              }
            }
            if (!isInTable) return;
            
            if(!byName.has(name)){
              byName.set(name, {
                name,
                tcktTotal: 0, tcktCompleted: 0,
                ceTotal: 0, ceCompleted: 0,
                hdktTotal: 0, hdktCompleted: 0,
                bbTotal: 0, bbCompleted: 0,
                jigTotal: 0, jigCompleted: 0,
                khksclTotal: 0, khksclCompleted: 0
              });
            }
            
            const rec = byName.get(name);
            const fourMStatus = String(getV(r, ['4M r√† so√°t','4m r√† so√°t'])||'').trim();
            const fourMNorm = norm(fourMStatus);
            const isNotNeeded = (fourMNorm.includes('khong can') || fourMNorm.includes('kh√¥ng c·∫ßn'));
            
            const pTCKT = isNotNeeded ? 100 : parsePercent(getV(r, ['TCKT(% ho√†n th√†nh)','tckt']));
            const pCE = isNotNeeded ? 100 : parsePercent(getV(r, ['CE(% ho√†n th√†nh)','ce']));
            const pHDKT = isNotNeeded ? 100 : parsePercent(getV(r, ['HDKT(% ho√†n th√†nh)','hdkt']));
            const pBB = isNotNeeded ? 100 : parsePercent(getV(r, ['BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o']));
            const pJIG = isNotNeeded ? 100 : parsePercent(getV(r, ['Jig tool(% ho√†n th√†nh)','jig tool']));
            const pKH = isNotNeeded ? 100 : parsePercent(getV(r, ['KHKSCL(% ho√†n th√†nh)','khkscl']));
            
            rec.tcktTotal += 1; rec.tcktCompleted += pTCKT;
            rec.ceTotal += 1; rec.ceCompleted += pCE;
            rec.hdktTotal += 1; rec.hdktCompleted += pHDKT;
            rec.bbTotal += 1; rec.bbCompleted += pBB;
            rec.jigTotal += 1; rec.jigCompleted += pJIG;
            rec.khksclTotal += 1; rec.khksclCompleted += pKH;
          });
          
          // S·∫Øp x·∫øp theo th·ª© t·ª± gi·ªëng nh∆∞ trong b·∫£ng (theo t√™n trong b·∫£ng)
          const sorted = Array.from(byName.values()).sort((a, b) => {
            // T√¨m v·ªã tr√≠ trong b·∫£ng ƒë·ªÉ s·∫Øp x·∫øp ƒë√∫ng th·ª© t·ª±
            const aIndex = Array.from(employeeNamesInTable).findIndex(n => sameName(n, a.name));
            const bIndex = Array.from(employeeNamesInTable).findIndex(n => sameName(n, b.name));
            if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
            if (aIndex !== -1) return -1;
            if (bIndex !== -1) return 1;
            return a.name.localeCompare(b.name, 'vi');
          });
          
          if (sorted.length === 0) {
            dashboard.classList.add('hidden');
            return;
          }
          
          // Chart 1: T·ª∑ l·ªá ho√†n th√†nh c√°c h·∫°ng m·ª•c
          const canvas1 = document.getElementById('f5a-chart-p4-categories');
          if (canvas1) {
            const ctx1 = canvas1.getContext('2d');
            if (F5A_CHART_P4_CATEGORIES) F5A_CHART_P4_CATEGORIES.destroy();
            
            const labels = sorted.map(r => r.name);
            const tckt = sorted.map(r => r.tcktTotal > 0 ? (r.tcktCompleted / r.tcktTotal) : 0);
            const ce = sorted.map(r => r.ceTotal > 0 ? (r.ceCompleted / r.ceTotal) : 0);
            const hdkt = sorted.map(r => r.hdktTotal > 0 ? (r.hdktCompleted / r.hdktTotal) : 0);
            const bb = sorted.map(r => r.bbTotal > 0 ? (r.bbCompleted / r.bbTotal) : 0);
            const jig = sorted.map(r => r.jigTotal > 0 ? (r.jigCompleted / r.jigTotal) : 0);
            const khkscl = sorted.map(r => r.khksclTotal > 0 ? (r.khksclCompleted / r.khksclTotal) : 0);
            
            F5A_CHART_P4_CATEGORIES = new Chart(ctx1, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  { label: 'TCKT', data: tckt.map(v => v * 100), backgroundColor: 'rgba(59,130,246,0.7)', borderColor: '#3b82f6', borderWidth: 1 },
                  { label: 'CE', data: ce.map(v => v * 100), backgroundColor: 'rgba(34,197,94,0.7)', borderColor: '#22c55e', borderWidth: 1 },
                  { label: 'HDKT', data: hdkt.map(v => v * 100), backgroundColor: 'rgba(234,179,8,0.7)', borderColor: '#eab308', borderWidth: 1 },
                  { label: 'BB ƒë√†o t·∫°o', data: bb.map(v => v * 100), backgroundColor: 'rgba(168,85,247,0.7)', borderColor: '#a855f7', borderWidth: 1 },
                  { label: 'Jig tool', data: jig.map(v => v * 100), backgroundColor: 'rgba(236,72,153,0.7)', borderColor: '#ec4899', borderWidth: 1 },
                  { label: 'KHKSCL', data: khkscl.map(v => v * 100), backgroundColor: 'rgba(251,146,60,0.7)', borderColor: '#fb923c', borderWidth: 1 }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { stacked: false, ticks: { maxRotation: 45, minRotation: 0, font: { size: 9 } } },
                  y: { beginAtZero: true, max: 100, ticks: { precision: 0 }, title: { display: true, text: 'T·ª∑ l·ªá (%)' } }
                },
                plugins: {
                  legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                  tooltip: { mode: 'index', intersect: false, callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%` } }
                }
              }
            });
          }
          
          // Chart 2: Th·∫ª P4 t·ªïng th·ªÉ
          const canvas2 = document.getElementById('f5a-chart-p4-overall');
          if (canvas2) {
            const ctx2 = canvas2.getContext('2d');
            if (F5A_CHART_P4_OVERALL) F5A_CHART_P4_OVERALL.destroy();
            
            const labels = sorted.map(r => r.name);
            const p4Values = sorted.map(r => {
              const tckt = r.tcktTotal > 0 ? (r.tcktCompleted / r.tcktTotal) : 0;
              const ce = r.ceTotal > 0 ? (r.ceCompleted / r.ceTotal) : 0;
              const hdkt = r.hdktTotal > 0 ? (r.hdktCompleted / r.hdktTotal) : 0;
              const bb = r.bbTotal > 0 ? (r.bbCompleted / r.bbTotal) : 0;
              const jig = r.jigTotal > 0 ? (r.jigCompleted / r.jigTotal) : 0;
              const khkscl = r.khksclTotal > 0 ? (r.khksclCompleted / r.khksclTotal) : 0;
              return ((tckt + ce + hdkt + bb + jig + khkscl) / 6) * 100;
            });
            
            F5A_CHART_P4_OVERALL = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Th·∫ª P4 (%)',
                  data: p4Values,
                  backgroundColor: p4Values.map(v => {
                    if (v >= 80) return 'rgba(34,197,94,0.7)';
                    if (v >= 50) return 'rgba(59,130,246,0.7)';
                    return 'rgba(234,179,8,0.7)';
                  }),
                  borderColor: p4Values.map(v => {
                    if (v >= 80) return '#22c55e';
                    if (v >= 50) return '#3b82f6';
                    return '#eab308';
                  }),
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                  x: { beginAtZero: true, max: 100, ticks: { precision: 0 }, title: { display: true, text: 'Th·∫ª P4 (%)' } },
                  y: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Nh√¢n vi√™n' } }
                },
                plugins: {
                  legend: { display: false },
                  tooltip: { callbacks: { label: (ctx) => `Th·∫ª P4: ${ctx.parsed.x.toFixed(1)}%` } }
                }
              }
            });
          }
        } catch (err) {
          console.error('[Dashboard P4] Error:', err);
        }
      }

      // ===== Form 5: Tab Navigation Handler =====
      // ===== Form 5 P3: Fetch and render CE review data =====
      async function f5aFetchP3Data(month){
        try{
          console.log('[F5A P3] Fetching CE review data for month:', month || 'all');
          
          // Build URLs with proper parameters like P1/P2
          const baseUrl = FORM5_P3_URL;
          const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
          const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
          
          // Build query string with month filter
          const makeQs = (withAction, withRange) => {
            const qs = new URLSearchParams();
            if(withAction) qs.append('action', 'form5_p3');
            if(withRange && month){
              qs.append('month', month);
              try{
                const [yy, mm] = month.split('-');
                const firstDay = `${yy}-${mm}-01`;
                const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
                const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
                qs.append('from', firstDay);
                qs.append('to', lastDay);
              }catch(_){}
            }
            qs.append('_ts', Date.now().toString());
            return qs.toString();
          };
          
          // Try multiple URL combinations like P1/P2
          const urls = [];
          [true, false].forEach(withRange => {
            [true, false].forEach(withAction => {
              const q = makeQs(withAction, withRange);
              urls.push(`${prodUrl}${q ? `?${q}` : ''}`);
              urls.push(`${testUrl}${q ? `?${q}` : ''}`);
            });
          });
          // Also try without query
          urls.push(prodUrl);
          urls.push(testUrl);
          
          let rows = [];
          for(const u of urls){
            try{
              console.log('[F5A P3] Trying:', u);
              const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
              const text = await r.text();
              console.log('[F5A P3] Response status:', r.status, 'length:', text.length);
              
              let data = null;
              try{ data = JSON.parse(text); }catch{ data = null; }
              
              if(!data && typeof text === 'string'){
                const m = text.match(/\[[\s\S]*\]/);
                if(m){
                  try{ data = JSON.parse(m[0]); console.log('[F5A P3] Extracted JSON from text'); }catch(_){}
                }
              }
              
              const picked = f5aPickRowsDeep(data ?? text);
              if(Array.isArray(picked) && picked.length){
                rows = picked;
                console.log('[F5A P3] Success! Got', rows.length, 'rows from:', u);
                break;
              }
            }catch(e){
              console.log('[F5A P3] Failed:', e.message);
              // Continue to next URL
            }
          }
          
          // Unwrap n8n format: [{ json: {...} }]
          const unwrapped = Array.isArray(rows) ? rows.map(r => (r && typeof r === 'object' && ('json' in r)) ? r.json : r) : [];
          
          // Debug: Ki·ªÉm tra xem c√≥ t√°c v·ª• tr√πng "M√£" kh√¥ng
          // ƒê·∫£m b·∫£o l·∫•y m√£ ƒë√∫ng ƒë·ªãnh d·∫°ng (gi·ªØ nguy√™n s·ªë 0 ƒë·∫ßu)
          const codeCount = new Map();
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          unwrapped.forEach((r, idx) => {
            // L·∫•y m√£ - ƒë·∫£m b·∫£o gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng (kh√¥ng parse s·ªë)
            const codeRaw = getV(r, ['M√£','code','ma','taskcode','M√£ t√°c v·ª•','m√£ t√°c v·ª•','taskid','TaskId']);
            // Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng g·ªëc, ch·ªâ trim kho·∫£ng tr·∫Øng
            const code = String(codeRaw||'').trim();
            
            if (code) {
              if (!codeCount.has(code)) {
                codeCount.set(code, []);
              }
              const taskName = getV(r, ['Task Name','taskname','t√™n t√°c v·ª•'])||'';
              const assignee = getV(r, ['assignee','employee','name','nh√¢n vi√™n'])||'';
              const completionDate = getV(r, ['ng√†y ho√†n th√†nh th·ª±c t·∫ø','completion date'])||'';
              
              codeCount.get(code).push({ 
                idx, 
                code: code,  // Gi·ªØ nguy√™n m√£ g·ªëc (c√≥ th·ªÉ c√≥ s·ªë 0 ƒë·∫ßu)
                taskName,
                assignee,
                completionDate,
                rawData: r  // Gi·ªØ to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ debug
              });
            }
          });
          
          // Log c√°c m√£ tr√πng (bao g·ªìm c·∫£ s·ªë 0 ƒë·∫ßu)
          const duplicateCodes = Array.from(codeCount.entries()).filter(([code, items]) => items.length > 1);
          if (duplicateCodes.length > 0) {
            console.log('[F5A P3] ‚ö†Ô∏è Ph√°t hi·ªán', duplicateCodes.length, 'm√£ tr√πng l·∫∑p (s·∫Ω gi·ªØ l·∫°i T·∫§T C·∫¢):');
            duplicateCodes.forEach(([code, items]) => {
              console.log(`  - M√£ "${code}" (ƒë·ªô d√†i: ${code.length}) xu·∫•t hi·ªán ${items.length} l·∫ßn:`);
              items.forEach((item, i) => {
                console.log(`    [${i+1}] idx:${item.idx}, assignee:"${item.assignee}", date:"${item.completionDate}", task:"${item.taskName}"`);
              });
            });
            console.log('[F5A P3] ‚ö†Ô∏è L∆∞u √Ω: T·∫•t c·∫£ c√°c t√°c v·ª• tr√πng m√£ s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i v√† hi·ªÉn th·ªã');
          } else {
            console.log('[F5A P3] ‚úì Kh√¥ng c√≥ m√£ tr√πng l·∫∑p');
          }
          
          // Ki·ªÉm tra ƒë·∫∑c bi·ªát m√£ "2010021450" v√† "201002145"
          const code2010021450 = unwrapped.filter(r => {
            const c = String(getV(r, ['M√£','code','ma','taskcode','M√£ t√°c v·ª•','m√£ t√°c v·ª•'])||'').trim();
            return c === '2010021450' || c === '201002145';
          });
          if (code2010021450.length > 0) {
            console.log('[F5A P3] üîç T√¨m th·∫•y m√£ li√™n quan "2010021450"/"201002145":', code2010021450.length, 't√°c v·ª•');
            code2010021450.forEach((r, i) => {
              const c = String(getV(r, ['M√£','code','ma','taskcode','M√£ t√°c v·ª•','m√£ t√°c v·ª•'])||'').trim();
              console.log(`  [${i+1}] M√£: "${c}" (ƒë·ªô d√†i: ${c.length}), assignee: "${getV(r, ['assignee','employee','name'])||''}"`);
            });
          }
          
          // ƒê·∫£m b·∫£o gi·ªØ l·∫°i T·∫§T C·∫¢ c√°c t√°c v·ª•, k·ªÉ c·∫£ tr√πng "M√£"
          // (Kh√¥ng deduplicate, v√¨ c√≥ th·ªÉ l√† c√°c t√°c v·ª• kh√°c nhau nh∆∞ng c√πng m√£)
          F5A_P3_RAW = unwrapped;
          F5A_P3_META = { month: month || '' };
          
          // Save timestamp
          try{ LS.set('f5a.p3.lastUpdated', String(Date.now())); }catch(_){ }
          
          console.log('[F5A P3] Final result:', F5A_P3_RAW.length, 'records');
          console.log('[F5A P3] ‚ö†Ô∏è QUAN TR·ªåNG: T·∫•t c·∫£ t√°c v·ª• s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i, k·ªÉ c·∫£ tr√πng m√£');
          console.log('[F5A P3] ƒê·ªÉ debug m√£ "2010021450", ki·ªÉm tra console log ph√≠a tr√™n');
          
          // If no data due to CORS, show helpful message
          if(!F5A_P3_RAW || F5A_P3_RAW.length === 0){
            console.warn('[F5A P3] No data received. This is likely a CORS issue.');
            console.warn('[F5A P3] Endpoint:', FORM5_P3_URL);
            console.warn('[F5A P3] Solutions:');
            console.warn('[F5A P3] 1. Serve HTML from web server (not file://)');
            console.warn('[F5A P3] 2. Add CORS headers to webhook endpoint');
            console.warn('[F5A P3] 3. Contact admin to fix endpoint CORS');
            
            // Show user-friendly error message
            const body = document.getElementById('f5a-body-p3');
            if(body){
              body.innerHTML = `
                <tr>
                  <td colspan="6" class="px-3 py-3 text-center">
                    <div class="text-red-500 mb-2">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu P3</div>
                    <div class="text-sm text-gray-600 mb-2">L·ªói CORS - Endpoint ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng</div>
                    <div class="text-xs text-blue-600">
                      <strong>Gi·∫£i ph√°p:</strong><br>
                      1. Li√™n h·ªá admin ƒë·ªÉ th√™m CORS headers v√†o endpoint<br>
                      2. Ho·∫∑c host file HTML tr√™n web server
                    </div>
                  </td>
                </tr>
              `;
            }
          }
          
          return F5A_P3_RAW;
        }catch(err){
          console.error('[F5A P3] Fetch error:', err);
          F5A_P3_RAW = [];
          return [];
        }
      }

      // ===== Form 5 P4: Fetch 4M Review data =====
      async function f5aFetchP4Data(month){
        try{
          console.log('[F5A P4] Fetching 4M review data for month:', month || 'all');
          
          // Build URLs with proper parameters like P3
          const baseUrl = FORM5_P4_URL;
          const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
          const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
          
          // Build query string with month filter
          const makeQs = (withAction, withRange) => {
            const qs = new URLSearchParams();
            if(withAction) qs.append('action', 'form5_p4');
            if(withRange && month){
              qs.append('month', month);
              try{
                const [yy, mm] = month.split('-');
                const firstDay = `${yy}-${mm}-01`;
                const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
                const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
                qs.append('from', firstDay);
                qs.append('to', lastDay);
              }catch(_){}
            }
            qs.append('_ts', Date.now().toString());
            return qs.toString();
          };
          
          // Try multiple URL combinations like P3
          const urls = [];
          [true, false].forEach(withRange => {
            [true, false].forEach(withAction => {
              const q = makeQs(withAction, withRange);
              urls.push(`${prodUrl}${q ? `?${q}` : ''}`);
              urls.push(`${testUrl}${q ? `?${q}` : ''}`);
            });
          });
          // Also try without query
          urls.push(prodUrl);
          urls.push(testUrl);
          
          let rows = [];
          for(const u of urls){
            try{
              console.log('[F5A P4] Trying:', u);
              const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
              const text = await r.text();
              console.log('[F5A P4] Response status:', r.status, 'length:', text.length);
              
              let data = null;
              try{ data = JSON.parse(text); }catch{ data = null; }
              
              if(!data && typeof text === 'string'){
                const m = text.match(/\[[\s\S]*\]/);
                if(m){
                  try{ data = JSON.parse(m[0]); console.log('[F5A P4] Extracted JSON from text'); }catch(_){}
                }
              }
              
              const picked = f5aPickRowsDeep(data ?? text);
              if(Array.isArray(picked) && picked.length){
                rows = picked;
                console.log('[F5A P4] Success! Got', rows.length, 'rows from:', u);
                break;
              }
            }catch(e){
              console.log('[F5A P4] Failed:', e.message);
              // Continue to next URL
            }
          }
          
          // Unwrap n8n format: [{ json: {...} }]
          const unwrapped = Array.isArray(rows) ? rows.map(r => (r && typeof r === 'object' && ('json' in r)) ? r.json : r) : [];
          
          // ƒê·∫£m b·∫£o gi·ªØ l·∫°i T·∫§T C·∫¢ c√°c t√°c v·ª•
          F5A_P4_RAW = unwrapped;
          F5A_P4_META = { month: month || '' };
          
          // Save timestamp
          try{ LS.set('f5a.p4.lastUpdated', String(Date.now())); }catch(_){ }
          
          console.log('[F5A P4] Final result:', F5A_P4_RAW.length, 'records');
          
          // If no data due to CORS, show helpful message
          if(!F5A_P4_RAW || F5A_P4_RAW.length === 0){
            console.warn('[F5A P4] No data received. This is likely a CORS issue.');
            console.warn('[F5A P4] Endpoint:', FORM5_P4_URL);
            console.warn('[F5A P4] Solutions:');
            console.warn('[F5A P4] 1. Serve HTML from web server (not file://)');
            console.warn('[F5A P4] 2. Add CORS headers to webhook endpoint');
            console.warn('[F5A P4] 3. Contact admin to fix endpoint CORS');
            
            // Show user-friendly error message
            const body = document.getElementById('f5a-body-p4');
            if(body){
              body.innerHTML = `
                <tr>
                  <td colspan="10" class="px-3 py-3 text-center">
                    <div class="text-red-500 mb-2">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu P4</div>
                    <div class="text-sm text-gray-600 mb-2">L·ªói CORS - Endpoint ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng</div>
                    <div class="text-xs text-blue-600">
                      <strong>Gi·∫£i ph√°p:</strong><br>
                      1. Li√™n h·ªá admin ƒë·ªÉ th√™m CORS headers v√†o endpoint<br>
                      2. Ho·∫∑c host file HTML tr√™n web server
                    </div>
                  </td>
                </tr>
              `;
            }
          }
          
          return F5A_P4_RAW;
        }catch(err){
          console.error('[F5A P4] Fetch error:', err);
          F5A_P4_RAW = [];
          return [];
        }
      }

      function renderForm5P3(){
        try{
          const body = document.getElementById('f5a-body-p3');
          if (!body) return;
          
          console.log('[F5A P3] Rendering from F5A_P3_RAW, length:', F5A_P3_RAW ? F5A_P3_RAW.length : 0);
          
          if(!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length){
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            return;
          }
          
          // Get month filter
          const monthInput = document.getElementById('f5a-month');
          const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
          
          // Helper functions
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          // Parse date flexible
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              // DD/MM/YYYY HH:mm
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){
                const d = new Date(+m[3], +m[2]-1, +m[1]);
                return isNaN(d) ? null : d;
              }
              // YYYY-MM-DD
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){
                const d = new Date(+m[1], +m[2]-1, +m[3]);
                return isNaN(d) ? null : d;
              }
              const d = new Date(s);
              return isNaN(d) ? null : d;
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            const yy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            return `${yy}-${mm}`;
          };
          
          // Aggregate by employee
          const byName = new Map();
          
          F5A_P3_RAW.forEach(r => {
            // Get assignee name
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            if(!name) return;
            
            // Skip tasks assigned to "x" (pending tasks)
            if(name.toLowerCase() === 'x') {
              return;
            }
            
            // Skip tasks assigned to blacklisted employees
            if (isNameInBlacklist(name)) {
              return;
            }
            
            // Get completion date
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh',
              'completion date','completiondate',
              'actual completion date','actualcompletiondate'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            
            // Filter by month if specified
            if(monthVal && completionDate){
              const taskMonth = formatYyyyMm(completionDate);
              if(taskMonth !== monthVal) return; // Skip if not in selected month
            } else if(monthVal && !completionDate) {
              return; // Skip tasks without completion date when month filter is active
            }
            
            // Get CE review status
            const ceReview = String(getV(r, [
              'ce r√† so√°t','ce ra soat','cerasoat',
              'ce review','cereview',
              'r√† so√°t ce','ra soat ce','rasotce',
              't√¨nh tr·∫°ng ce','tinh trang ce'
            ])||'').trim();
            
            // Initialize record if not exists
            if(!byName.has(name)){
              byName.set(name, { 
                name, 
                total: 0,
                completed: 0, 
                notNeeded: 0, 
                pending: 0
              });
            }
            
            const rec = byName.get(name);
            
            // Count by CE review status
            const ceNorm = norm(ceReview);
            if(ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui' || ceNorm === 'dagui'){
              rec.completed += 1;
            } else if(ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can' || ceNorm === 'khongcan'){
              rec.notNeeded += 1;
            } else if(!ceReview || ceReview === ''){
              rec.pending += 1;
            }
            
            // Total = sum of completed + notNeeded + pending
            rec.total = rec.completed + rec.notNeeded + rec.pending;
          });
          
          // Sort by name
          const sorted = Array.from(byName.values()).sort((a,b) => a.name.localeCompare(b.name, 'vi'));
          
          // Render table
          const rowsP3 = [];
          let sumTotal = 0, sumCompleted = 0, sumNotNeeded = 0, sumPending = 0;
          
          sorted.forEach(r => {
            // Calculate percentage
            const percentage = r.total > 0 ? Math.round(((r.completed + r.notNeeded) / r.total) * 100) : 0;
            
            sumTotal += r.total;
            sumCompleted += r.completed;
            sumNotNeeded += r.notNeeded;
            sumPending += r.pending;
            
            rowsP3.push(`
              <tr>
                <td class="px-3 py-2">${r.name}</td>
                <td class="px-3 py-2 text-center">
                  <button onclick="showP3TaskDetails('${r.name}', 'total', '${monthVal}')" 
                          class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer font-semibold" 
                          title="Click ƒë·ªÉ xem chi ti·∫øt">
                    ${r.total}
                  </button>
                </td>
                <td class="px-3 py-2 text-center">
                  <button onclick="showP3TaskDetails('${r.name}', 'completed', '${monthVal}')" 
                          class="text-green-600 hover:text-green-800 hover:underline cursor-pointer font-semibold" 
                          title="Click ƒë·ªÉ xem chi ti·∫øt">
                    ${r.completed}
                  </button>
                </td>
                <td class="px-3 py-2 text-center">
                  <button onclick="showP3TaskDetails('${r.name}', 'notNeeded', '${monthVal}')" 
                          class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer font-semibold" 
                          title="Click ƒë·ªÉ xem chi ti·∫øt">
                    ${r.notNeeded}
                  </button>
                </td>
                <td class="px-3 py-2 text-center">
                  <button onclick="showP3TaskDetails('${r.name}', 'pending', '${monthVal}')" 
                          class="text-orange-600 hover:text-orange-800 hover:underline cursor-pointer font-semibold" 
                          title="Click ƒë·ªÉ xem chi ti·∫øt">
                    ${r.pending}
                  </button>
                </td>
                <td class="px-3 py-2 text-center"><span class="font-semibold ${percentage >= 80 ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-orange-600'}">${percentage}%</span></td>
              </tr>
            `);
          });
          
          // Add total row
          const totalPercentage = sumTotal > 0 ? Math.round(((sumCompleted + sumNotNeeded) / sumTotal) * 100) : 0;
          const totalRow = `
            <tr class="bg-blue-50 font-semibold">
              <td class="px-3 py-2">T·ªîNG</td>
              <td class="px-3 py-2 text-center">${sumTotal}</td>
              <td class="px-3 py-2 text-center">${sumCompleted}</td>
              <td class="px-3 py-2 text-center">${sumNotNeeded}</td>
              <td class="px-3 py-2 text-center">${sumPending}</td>
              <td class="px-3 py-2 text-center"><span class="font-bold ${totalPercentage >= 80 ? 'text-green-600' : totalPercentage >= 50 ? 'text-blue-600' : 'text-orange-600'}">${totalPercentage}%</span></td>
            </tr>
          `;
          
          body.innerHTML = (rowsP3.join('') + totalRow) || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          
          // Enable table drag
          try{ enableTableDrag('f5a-body-p3'); }catch(_){ }
          
          // Render dashboard P3
          renderDashboardP3();
          
          console.log('[F5A P3] Rendered', sorted.length, 'employees');
          
          // Debug: Log first employee details
          if(sorted.length > 0){
            const firstEmp = sorted[0];
            console.log('[F5A P3] Debug - First employee:', firstEmp.name);
            console.log('[F5A P3] Debug - Total tasks:', firstEmp.total);
            console.log('[F5A P3] Debug - Completed:', firstEmp.completed);
            console.log('[F5A P3] Debug - Not needed:', firstEmp.notNeeded);
            console.log('[F5A P3] Debug - Pending:', firstEmp.pending);
          }
        }catch(err){
          console.error('[F5A P3] Render error:', err);
          const body = document.getElementById('f5a-body-p3');
          if(body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="6">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu</td></tr>';
        }
      }

      (function initF5aTabs(){
        try{
          const tabBtns = [
            document.getElementById('f5a-tab-p1'),
            document.getElementById('f5a-tab-p2'),
            document.getElementById('f5a-tab-p3'),
            document.getElementById('f5a-tab-p4')
          ];
          const panels = [
            document.getElementById('f5a-panel-p1'),
            document.getElementById('f5a-panel-p2'),
            document.getElementById('f5a-panel-p3'),
            document.getElementById('f5a-panel-p4')
          ];

          function setActiveBtn(btn, active){
            if (!btn) return;
            if (active){
              btn.classList.remove('text-gray-600');
              btn.classList.add('text-white','bg-primary-blue','border-primary-blue');
            } else {
              btn.classList.remove('text-white','bg-primary-blue','border-primary-blue');
              btn.classList.add('text-gray-600');
            }
          }

          function switchTab(index){
            try{
              panels.forEach((p,i)=>{ if (p) p.classList.toggle('hidden', i!==index); });
              tabBtns.forEach((b,i)=> setActiveBtn(b, i===index));
              try{ LS.set('f5a.activeTab', String(index)); }catch(_){ }
              
              // Show/hide dashboards based on active tab
              const dashboards = [
                document.getElementById('f5a-dashboard-p1'),
                document.getElementById('f5a-dashboard-p2'),
                document.getElementById('f5a-dashboard-p3'),
                document.getElementById('f5a-dashboard-p4')
              ];
              dashboards.forEach((d, i) => {
                if (d) d.classList.toggle('hidden', i !== index);
              });
              
              // P1: Ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, kh√¥ng t·ª± ƒë·ªông fetch
              if(index === 0){
                const body = document.getElementById('f5a-body-p1');
                if(body){
                  // Ki·ªÉm tra xem ƒë√£ c√≥ d·ªØ li·ªáu ƒë∆∞·ª£c render ch∆∞a
                  const hasData = body.children.length > 0 && !body.textContent.includes('Ch∆∞a c√≥ d·ªØ li·ªáu');
                  if(!hasData && (!F5A_P1_DATA || !F5A_P1_DATA.data || !Array.isArray(F5A_P1_DATA.data) || F5A_P1_DATA.data.length === 0)){
                    body.innerHTML = `
                      <tr>
                        <td colspan="10" class="px-3 py-3 text-center">
                          <div class="text-gray-500 mb-2 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu P1</div>
                          <div class="text-sm text-blue-600 text-center">üëÜ Nh·∫•n n√∫t <b>"Tra c·ª©u P1"</b> ·ªü tr√™n ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
                        </td>
                      </tr>
                    `;
                  }
                }
              }
              
              // P2: Ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, kh√¥ng t·ª± ƒë·ªông fetch
              if(index === 1){
                const body = document.getElementById('f5a-body-p2');
                if(body){
                  // Ki·ªÉm tra xem ƒë√£ c√≥ d·ªØ li·ªáu ƒë∆∞·ª£c render ch∆∞a
                  const hasData = body.children.length > 0 && !body.textContent.includes('Ch∆∞a c√≥ d·ªØ li·ªáu');
                  if(!hasData && (!F5A_P2_DATA || !F5A_P2_DATA.data || !Array.isArray(F5A_P2_DATA.data) || F5A_P2_DATA.data.length === 0)){
                    body.innerHTML = `
                      <tr>
                        <td colspan="7" class="px-3 py-3 text-center">
                          <div class="text-gray-500 mb-2 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu P2</div>
                          <div class="text-sm text-blue-600 text-center">üëÜ Nh·∫•n n√∫t <b>"Tra c·ª©u P2"</b> ·ªü tr√™n ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
                        </td>
                      </tr>
                    `;
                  }
                }
              }
              
              // P3: Ch·ªâ render n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu, kh√¥ng t·ª± ƒë·ªông fetch
              if(index === 2){
                if(F5A_P3_RAW && F5A_P3_RAW.length){
                  renderForm5P3();
                } else {
                  const body = document.getElementById('f5a-body-p3');
                  if(body){
                    body.innerHTML = `
                      <tr>
                        <td colspan="6" class="px-3 py-3 text-center">
                          <div class="text-gray-500 mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu P3</div>
                          <div class="text-sm text-blue-600">üëÜ Nh·∫•n n√∫t <b>"Tra c·ª©u P3"</b> ·ªü tr√™n ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
                        </td>
                      </tr>
                    `;
                  }
                }
              }
              
              // P4: Ch·ªâ render n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu, kh√¥ng t·ª± ƒë·ªông fetch
              if(index === 3){
                if(F5A_P4_RAW && F5A_P4_RAW.length){
                  renderForm5P4();
                } else {
                  const body = document.getElementById('f5a-body-p4');
                  if(body){
                    body.innerHTML = `
                      <tr>
                        <td colspan="8" class="px-3 py-3 text-center">
                          <div class="text-gray-500 mb-2">Ch∆∞a c√≥ d·ªØ li·ªáu P4</div>
                          <div class="text-sm text-blue-600">üëÜ Nh·∫•n n√∫t <b>"Tra c·ª©u P4"</b> ·ªü tr√™n ƒë·ªÉ t·∫£i d·ªØ li·ªáu</div>
                        </td>
                      </tr>
                    `;
                  }
                }
              }
            }catch(err){ console.error('Form5 switchTab error:', err); }
          }

          tabBtns.forEach((btn, idx)=>{ if(btn){ btn.addEventListener('click', (e)=>{ e.preventDefault(); switchTab(idx); }); } });

          // Restore last tab or default to P1
          let initial = 0;
          try{ const last = LS.get('f5a.activeTab'); const n = Number(last); if (Number.isFinite(n) && n>=0 && n<4) initial = n; }catch(_){ }
          switchTab(initial);
        }catch(err){ console.warn('initF5aTabs failed', err); }
      })();

      // Bind explicit click for "Tra c·ª©u P4" to fetch P3-data and render P4 (avoid any legacy handlers)
      (function initF5aSearchP4(){
        try{
          const btn = document.getElementById('f5a-search-p4');
          if (btn && !btn._bound){
            try{ btn.onclick = null; }catch(_){ }
            btn.addEventListener('click', async (e)=>{
              e.preventDefault();
              try{ e.stopImmediatePropagation(); }catch(_){ }
              const monthInput = document.getElementById('f5a-month');
              const month = monthInput ? (monthInput.value||'') : '';
              const prev = btn.textContent;
              btn.disabled = true;
              btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
              try{
                await f5aFetchP4Data(month);
                renderForm5P4();
              }finally{
                btn.disabled = false;
                btn.textContent = prev || 'Tra c·ª©u P4';
              }
            });
            btn._bound = true;
          }
        }catch(_){ }
      })();

      // ===== P4 Machine Task Details Modal Functions =====
      function openP4MachineModal(employeeName, month) {
        try {
          const modal = document.getElementById('p4-machine-modal');
          const employeeEl = document.getElementById('p4-machine-employee');
          const body = document.getElementById('p4-machine-modal-body');
          
          if (!modal || !employeeEl || !body) return;
          
          // Set employee name
          employeeEl.textContent = employeeName || '';
          
          // Show loading state
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
          
          // Show modal
          modal.classList.remove('hidden');
          modal.setAttribute('aria-hidden', 'false');
          
          // Load data
          loadP4MachineTaskDetails(employeeName, month);
          
        } catch (err) {
          console.error('[P4 Machine Modal] Open error:', err);
        }
      }

      function closeP4MachineModal() {
        try {
          const modal = document.getElementById('p4-machine-modal');
          if (modal) {
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
          }
        } catch (err) {
          console.error('[P4 Machine Modal] Close error:', err);
        }
      }

      async function loadP4MachineTaskDetails(employeeName, month) {
        try {
          const body = document.getElementById('p4-machine-modal-body');
          if (!body) return;
          
          console.log('[P4 Machine Details] Loading for:', employeeName, 'month:', month);
          
          // Check if we have P4 data, n·∫øu ch∆∞a c√≥ th√¨ t·ª± ƒë·ªông fetch
          if (!Array.isArray(F5A_P4_RAW) || !F5A_P4_RAW.length) {
            console.log('[P4 Machine Details] No P4 data found, fetching...');
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            
            try {
              await f5aFetchP4Data(month);
              console.log('[P4 Machine Details] Fetch completed, got', F5A_P4_RAW.length, 'records');
            } catch(err) {
              console.error('[P4 Machine Details] Fetch error:', err);
              body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="13">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "Tra c·ª©u P4" tr∆∞·ªõc.</td></tr>';
              return;
            }
            
            // Ki·ªÉm tra l·∫°i sau khi fetch
            if (!Array.isArray(F5A_P4_RAW) || !F5A_P4_RAW.length) {
              body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="13">Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "Tra c·ª©u P4" tr∆∞·ªõc.</td></tr>';
              return;
            }
          }
          
          // Helper functions
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
              return new Date(s);
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          };
          
          const parsePercent = (v) => {
            try{
              if(!v) return 0;
              const s = String(v).trim();
              const num = parseFloat(s);
              if(isNaN(num)) return 0;
              if(num >= 0 && num <= 1) return num * 100;
              if(num >= 0 && num <= 100) return num;
              return 0;
            }catch(_){ return 0; }
          };
          
          // Filter tasks for this employee and month
          const employeeTasks = F5A_P4_RAW.filter(r => {
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            if(!name || name.toLowerCase() === 'x') return false;
            if(!sameName(name, employeeName)) return false;
            
            const completionDateStr = getV(r, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh'
            ]);
            
            const completionDate = parseDate(completionDateStr);
            
            if(month && completionDate){
              const taskMonth = formatYyyyMm(completionDate);
              if(taskMonth !== month) return false;
            } else if(month && !completionDate) {
              return false;
            }
            
            // Only include tasks with 4M data
            const rasoat4m = String(getV(r, [
              '4M r√† so√°t','4m r√† so√°t','4m ra soat',
              '4M','4m rasoat'
            ])||'').trim();
            
            return !!rasoat4m;
          });
          
          console.log('[P4 Machine Details] Found', employeeTasks.length, 'tasks for', employeeName);
          
          if (!employeeTasks.length) {
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Kh√¥ng c√≥ d·ªØ li·ªáu t√°c v·ª• m√°y</td></tr>';
            return;
          }
          
          // Render table rows
          const rows = [];
          let stt = 0;
          
          employeeTasks.forEach(task => {
            stt++;
            
            const taskId = String(getV(task, ['taskid','task_id','ma_tac_vu','m√£ t√°c v·ª•','requestid','id'])||'').trim();
            const taskName = String(getV(task, [
              'taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•',
              'Task Name','TaskName','task_name','taskName',
              'T√™n t√°c v·ª•','T√™n Task','T√™nTask','ten_task',
              'C√¥ng vi·ªác','cong_viec','congviec','work','job',
              'M√¥ t·∫£','mo_ta','mota','description','desc',
              'N·ªôi dung','noi_dung','noidung','content'
            ])||'').trim();
            
            // Debug: Log task data if taskName is empty
            if (!taskName && stt <= 3) {
              console.log('[P4 Machine Debug] Task', stt, 'has empty taskName. Available fields:', Object.keys(task));
              console.log('[P4 Machine Debug] Sample task data:', task);
            }
            
            // Fallback: If taskName is still empty, try to find the longest text field
            let finalTaskName = taskName;
            if (!finalTaskName) {
              const textFields = Object.entries(task).filter(([key, value]) => {
                const str = String(value || '').trim();
                return str.length > 5 && str.length < 200 && !str.match(/^\d+$/) && !str.match(/^\d{4}-\d{2}-\d{2}/);
              });
              
              if (textFields.length > 0) {
                // Sort by length and take the longest one
                textFields.sort((a, b) => String(b[1]).length - String(a[1]).length);
                finalTaskName = String(textFields[0][1]).trim();
                console.log('[P4 Machine Debug] Using fallback taskName from field:', textFields[0][0], '=', finalTaskName);
              }
            }
            const completionDateStr = getV(task, [
              'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
              'ng√†y ho√†n th√†nh','ngay hoan thanh'
            ]);
            const completionDate = parseDate(completionDateStr);
            const formattedDate = completionDate ? formatDdMmYyyy(completionDate) : '';
            
            // Parse 4M percentages
            const tckt = parsePercent(getV(task, ['TCKT(% ho√†n th√†nh)','tckt','tckt%']));
            const ce = parsePercent(getV(task, ['CE(% ho√†n th√†nh)','ce','ce%']));
            const hdkt = parsePercent(getV(task, ['HDKT(% ho√†n th√†nh)','hdkt','hdkt%']));
            const bb = parsePercent(getV(task, ['BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb dao tao','bb%']));
            const jig = parsePercent(getV(task, ['Jig tool(% ho√†n th√†nh)','jig tool','jig%']));
            const khkscl = parsePercent(getV(task, ['KHKSCL(% ho√†n th√†nh)','khkscl','khkscl%']));
            
            // Get 4M review data
            const rasoat4m = String(getV(task, [
              '4M r√† so√°t','4m r√† so√°t','4m ra soat',
              '4M','4m rasoat'
            ])||'').trim();
            
            const ngayKhaiBao4m = String(getV(task, [
              'ng√†y khai b√°o 4M','ngay khai bao 4m',
              'ng√†y khai b√°o','ngay khai bao',
              '4M ng√†y khai b√°o','4m ngay khai bao'
            ])||'').trim();
            
            const ghiChu4m = String(getV(task, [
              'ghi ch√∫ 4M','ghi chu 4m',
              'ghi ch√∫','ghi chu',
              '4M ghi ch√∫','4m ghi chu',
              'note 4M','note 4m'
            ])||'').trim();
            
            rows.push(`
              <tr>
                <td class="px-3 py-2 text-center">${stt}</td>
                <td class="px-3 py-2 font-mono text-blue-600">${taskId}</td>
                <td class="px-3 py-2">${finalTaskName || taskId || 'N/A'}</td>
                <td class="px-3 py-2">${formattedDate}</td>
                <td class="px-3 py-2 text-center">${tckt.toFixed(1)}%</td>
                <td class="px-3 py-2 text-center">${ce.toFixed(1)}%</td>
                <td class="px-3 py-2 text-center">${hdkt.toFixed(1)}%</td>
                <td class="px-3 py-2 text-center">${bb.toFixed(1)}%</td>
                <td class="px-3 py-2 text-center">${jig.toFixed(1)}%</td>
                <td class="px-3 py-2 text-center">${khkscl.toFixed(1)}%</td>
                <td class="px-3 py-2 text-center">
                  <span class="px-2 py-1 rounded text-xs ${rasoat4m.toLowerCase().includes('ƒë√£') ? 'bg-green-100 text-green-800' : rasoat4m.toLowerCase().includes('ch∆∞a') ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                    ${rasoat4m || '-'}
                  </span>
                </td>
                <td class="px-3 py-2">${ngayKhaiBao4m || '-'}</td>
                <td class="px-3 py-2">${ghiChu4m || '-'}</td>
              </tr>
            `);
          });
          
          body.innerHTML = rows.join('');
          
        } catch (err) {
          console.error('[P4 Machine Details] Load error:', err);
          const body = document.getElementById('p4-machine-modal-body');
          if (body) {
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="13">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
          }
        }
      }

      // Helper function to compare names (same as used in P3)
      function sameName(a, b) {
        try {
          const normalize = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim();
          return normalize(a) === normalize(b);
        } catch (_) {
          return String(a||'').toLowerCase().trim() === String(b||'').toLowerCase().trim();
        }
      }
    </script>

    <!-- Modal for P3 Task Details -->
    <div id="p3-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
          <div class="flex items-center justify-between p-4 border-b">
            <h3 id="p3-modal-title" class="text-lg font-semibold text-gray-800">Chi ti·∫øt t√°c v·ª•</h3>
            <button onclick="closeP3TaskModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
          <div class="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">
            <div id="p3-modal-content" class="space-y-4">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
          <div class="flex items-center justify-end p-4 border-t bg-gray-50">
            <button onclick="closeP3TaskModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for P4 Machine Task Details -->
    <div id="p4-machine-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-7xl w-full max-h-[90vh] overflow-hidden">
          <div class="flex items-center justify-between p-4 border-b bg-gradient-to-r from-emerald-50 to-white">
            <h3 id="p4-machine-modal-title" class="text-lg font-semibold text-emerald-800">Chi ti·∫øt t√°c v·ª• m√°y</h3>
            <button onclick="closeP4MachineModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
          <div class="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">
            <div class="mb-4 text-sm text-gray-600">
              <span class="font-medium">Nh√¢n vi√™n:</span> <span id="p4-machine-employee" class="text-emerald-700 font-semibold"></span>
            </div>
            <div class="overflow-x-auto border border-gray-200 rounded-lg">
              <table class="min-w-[1600px] w-full text-sm table-zebra table-vdiv">
                <thead class="bg-gradient-to-r from-emerald-100 to-emerald-50 sticky top-0">
                  <tr class="text-left text-gray-700">
                    <th class="px-3 py-2">STT</th>
                    <th class="px-3 py-2">M√£ t√°c v·ª•</th>
                    <th class="px-3 py-2">T√™n t√°c v·ª•</th>
                    <th class="px-3 py-2">Ng√†y ho√†n th√†nh</th>
                    <th class="px-3 py-2">TCKT(%)</th>
                    <th class="px-3 py-2">CE(%)</th>
                    <th class="px-3 py-2">HDKT(%)</th>
                    <th class="px-3 py-2">BB ƒë√†o t·∫°o(%)</th>
                    <th class="px-3 py-2">Jig tool(%)</th>
                    <th class="px-3 py-2">KHKSCL(%)</th>
                    <th class="px-3 py-2">4M r√† so√°t</th>
                    <th class="px-3 py-2">Ng√†y khai b√°o 4M</th>
                    <th class="px-3 py-2">Ghi ch√∫ 4M</th>
                  </tr>
                </thead>
                <tbody id="p4-machine-modal-body" class="divide-y divide-gray-100">
                  <tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="flex items-center justify-end p-4 border-t bg-gray-50">
            <button onclick="closeP4MachineModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for P4 Task Details -->
    <div id="p4-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-7xl w-full max-h-[90vh] overflow-hidden">
          <div class="flex items-center justify-between p-4 border-b bg-gradient-to-r from-blue-50 to-white">
            <h3 id="p4-modal-title" class="text-lg font-semibold text-blue-800">Chi ti·∫øt t√°c v·ª• m√°y</h3>
            <button onclick="closeP4TaskModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
          <div class="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">
            <div id="p4-modal-content"></div>
          </div>
          <div class="flex items-center justify-end p-4 border-t bg-gray-50">
            <button onclick="closeP4TaskModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // P3 Task Details Modal Functions
      function showP3TaskDetails(employeeName, taskType, month) {
        try {
          console.log('[P3 Modal] Showing details for:', employeeName, taskType, month);
          
          // Filter tasks for this employee (s·ª≠a t·ª´ F5A_P4_RAW sang F5A_P3_RAW)
          if (!Array.isArray(F5A_P3_RAW) || F5A_P3_RAW.length === 0) {
            console.warn('[P3 Modal] F5A_P3_RAW is empty or not available');
            showToast('Ch∆∞a c√≥ d·ªØ li·ªáu P3. Vui l√≤ng nh·∫•n "Tra c·ª©u P3" tr∆∞·ªõc.', 'warning');
            return;
          }
          
          const employeeTasks = F5A_P3_RAW.filter(r => {
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            // Skip tasks assigned to "x" (pending tasks)
            if(name.toLowerCase() === 'x') {
              return false;
            }
            
            return name === employeeName;
          });
          
          console.log('[P3 Modal] Found', employeeTasks.length, 'tasks for', employeeName);
          
          // Filter by month if specified (same logic as main table)
          let filteredTasks = employeeTasks;
          if(month){
            filteredTasks = employeeTasks.filter(r => {
              const completionDateStr = String(getV(r, [
                'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te','completion date',
                'actual completion date','actualcompletiondate'
              ])||'').trim();
              
              const completionDate = parseDate(completionDateStr);
              if(!completionDate) return false; // Skip tasks without completion date
              
              const taskMonth = formatYyyyMm(completionDate);
              const matches = taskMonth === month;
              
              return matches;
            });
          }
          
          console.log('[P3 Modal] After month filter:', filteredTasks.length, 'tasks');
          
          // Filter by task type
          let finalTasks = [];
          const norm = (s) => String(s||'').toLowerCase().trim();
          
          filteredTasks.forEach(r => {
            const ceReview = String(getV(r, [
              'ce r√† so√°t','ce ra soat','cerasoat',
              'ce review','cereview',
              'r√† so√°t ce','ra soat ce','rasotce',
              't√¨nh tr·∫°ng ce','tinh trang ce'
            ])||'').trim();
            
            const ceNorm = norm(ceReview);
            
            switch(taskType) {
              case 'total':
                // For total: show tasks that have CE review status (completed + notNeeded + pending)
                if(ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui' || ceNorm === 'dagui' ||
                  ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can' || ceNorm === 'khongcan' ||
                  !ceNorm || ceNorm === ''){
                  finalTasks.push({...r, status: 'T·∫•t c·∫£'});
                }
                break;
              case 'completed':
                if(ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui' || ceNorm === 'dagui'){
                  finalTasks.push({...r, status: 'ƒê√£ g·ª≠i'});
                }
                break;
              case 'notNeeded':
                if(ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can' || ceNorm === 'khongcan'){
                  finalTasks.push({...r, status: 'Kh√¥ng c·∫ßn'});
                }
                break;
              case 'pending':
                if(!ceReview || ceNorm === ''){
                  finalTasks.push({...r, status: 'Ch∆∞a ho√†n th√†nh'});
                }
                break;
            }
          });
          
          console.log('[P3 Modal] Final tasks to show:', finalTasks.length);
          console.log('[P3 Modal] Debug - Employee:', employeeName);
          console.log('[P3 Modal] Debug - Task type:', taskType);
          console.log('[P3 Modal] Debug - Month filter:', month);
          console.log('[P3 Modal] Debug - Total employee tasks:', employeeTasks.length);
          console.log('[P3 Modal] Debug - After month filter:', filteredTasks.length);
          
          // Show warning if numbers don't match
          if(taskType === 'total' && finalTasks.length !== 5) {
            console.warn('[P3 Modal] WARNING: Expected 5 tasks but got', finalTasks.length);
            console.warn('[P3 Modal] This suggests you might be looking at P1/P2 data instead of P3');
          }
          
          // Update modal title
          const typeNames = {
            'total': 'T·∫•t c·∫£ t√°c v·ª•',
            'completed': 'ƒê√£ ho√†n thi·ªán CE',
            'notNeeded': 'Kh√¥ng c·∫ßn l√†m CE', 
            'pending': 'Ch∆∞a ho√†n th√†nh'
          };
          
          document.getElementById('p3-modal-title').textContent = 
            `${employeeName} - ${typeNames[taskType]} (${finalTasks.length} t√°c v·ª•)`;
          
          // Generate task list HTML
          let content = '';
          if(finalTasks.length === 0){
            content = '<div class="text-center text-gray-500 py-8">Kh√¥ng c√≥ t√°c v·ª• n√†o</div>';
          } else {
            content = '<div class="overflow-x-auto"><table class="w-full text-sm border-collapse border border-gray-300">';
            content += `
              <thead class="bg-gray-100">
                <tr>
                  <th class="border border-gray-300 px-3 py-2 text-left">STT</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">M√£ t√°c v·ª•</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">T√™n t√°c v·ª•</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Ng√†y ho√†n th√†nh</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">CE r√† so√°t</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">K·∫øt lu·∫≠n</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Ghi ch√∫</th>
                </tr>
              </thead>
              <tbody>
            `;
            
            finalTasks.forEach((task, idx) => {
              const taskCode = String(getV(task, ['m√£ t√°c v·ª•','ma tac vu','matacvu','task code','taskcode','M√£ t√°c v·ª•'])||'').trim();
              const taskName = String(getV(task, ['task name','ten tac vu','t√™n t√°c v·ª•','taskname','ten tac vu','Task Name'])||'').trim();
              const completionDate = String(getV(task, ['ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te','completion date','Ng√†y ho√†n th√†nh th·ª±c t·∫ø'])||'').trim();
              const ceReview = String(getV(task, ['ce r√† so√°t','ce ra soat','ce review','CE r√† so√°t','CE review'])||'').trim();
              const conclusion = String(getV(task, ['k·∫øt lu·∫≠n','ket luan','ketluan','conclusion','K·∫øt lu·∫≠n','Conclusion'])||'').trim();
              const note = String(getV(task, ['ghi ch√∫','ghi chu','ghichu','note','notes','Ghi ch√∫','Comment','comment'])||'').trim();
              
              // X√°c ƒë·ªãnh m√†u v√† text cho c·ªôt "CE r√† so√°t"
              const normCeReview = (s) => String(s||'').toLowerCase().trim();
              const ceNorm = normCeReview(ceReview);
              let ceReviewDisplay = ceReview || 'Ch∆∞a khai b√°o';
              let ceReviewClass = '';
              
              if (ceNorm === 'ƒë√£ g·ª≠i' || ceNorm === 'da gui' || ceNorm === 'dagui' || ceNorm === 'ƒë√£ g·ª≠i ce' || ceNorm === 'da gui ce') {
                ceReviewClass = 'bg-green-100 text-green-800';
              } else if (ceNorm === 'kh√¥ng c·∫ßn' || ceNorm === 'khong can' || ceNorm === 'khongcan' || ceNorm === 'kh√¥ng c·∫ßn l√†m ce' || ceNorm === 'khong can lam ce') {
                ceReviewClass = 'bg-blue-100 text-blue-800';
              } else if (!ceReview || ceNorm === '') {
                ceReviewDisplay = 'Ch∆∞a khai b√°o';
                ceReviewClass = 'bg-gray-100 text-gray-600';
              } else {
                // C√°c gi√° tr·ªã kh√°c (n·∫øu c√≥)
                ceReviewClass = 'bg-orange-100 text-orange-800';
              }
              
              content += `
                <tr class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-3 py-2">${idx + 1}</td>
                  <td class="border border-gray-300 px-3 py-2 font-mono text-xs">${taskCode || '-'}</td>
                  <td class="border border-gray-300 px-3 py-2">${taskName || '-'}</td>
                  <td class="border border-gray-300 px-3 py-2">${completionDate || '-'}</td>
                  <td class="border border-gray-300 px-3 py-2">
                    <span class="px-2 py-1 rounded text-xs ${ceReviewClass}">${ceReviewDisplay}</span>
                  </td>
                  <td class="border border-gray-300 px-3 py-2">${conclusion || '-'}</td>
                  <td class="border border-gray-300 px-3 py-2">${note || '-'}</td>
                </tr>
              `;
            });
            
            content += '</tbody></table></div>';
          }
          
          document.getElementById('p3-modal-content').innerHTML = content;
          
          // Show modal
          document.getElementById('p3-task-modal').classList.remove('hidden');
          
        } catch(err) {
          console.error('[P3 Modal] Error:', err);
          showToast('L·ªói hi·ªÉn th·ªã chi ti·∫øt t√°c v·ª•', 'error');
        }
      }
      
      function closeP3TaskModal() {
        document.getElementById('p3-task-modal').classList.add('hidden');
      }
      
      // Close modal when clicking outside
      document.getElementById('p3-task-modal').addEventListener('click', function(e) {
        if(e.target === this) {
          closeP3TaskModal();
        }
      });
      
      // Helper functions (reuse from P3 render)
      function getV(obj, keys) {
        const lower = {};
        Object.keys(obj||{}).forEach(k=>{ lower[String(k||'').toLowerCase().trim()] = obj[k]; });
        for(const k of keys){ const v = lower[String(k||'').toLowerCase().trim()]; if(v!==undefined) return v; }
        return '';
      }
      
      function parseDate(value) {
        try{
          if(!value) return null;
          const s = String(value).trim();
          // DD/MM/YYYY HH:mm
          let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
          if(m){
            const d = new Date(+m[3], +m[2]-1, +m[1]);
            return isNaN(d) ? null : d;
          }
          // YYYY-MM-DD
          m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
          if(m){
            const d = new Date(+m[1], +m[2]-1, +m[3]);
            return isNaN(d) ? null : d;
          }
          const d = new Date(s);
          return isNaN(d) ? null : d;
        }catch(_){ return null; }
      }
      
      function formatYyyyMm(d) {
        if(!d) return '';
        try {
          // Handle string dates like "2025-08-19"
          if (typeof d === 'string') {
            const match = d.match(/^(\d{4})-(\d{2})/);
            if (match) return `${match[1]}-${match[2]}`;
          }
          // Handle Date objects
          if (d instanceof Date) {
        const yy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        return `${yy}-${mm}`;
          }
          return '';
        } catch(_) {
          return '';
        }
      }
      
      // P4 Task Details Modal Functions
      async function showP4TaskDetails(employeeName, taskType, month) {
        try {
          console.log('[P4 Modal] Showing details for:', employeeName, taskType, month);
          
          const content = document.getElementById('p4-modal-content');
          const modal = document.getElementById('p4-task-modal');
          
          // Check if we have P4 data, n·∫øu ch∆∞a c√≥ th√¨ t·ª± ƒë·ªông fetch
          if (!Array.isArray(F5A_P4_RAW) || !F5A_P4_RAW.length) {
            console.log('[P4 Modal] No P4 data found, fetching...');
            if (content) {
              content.innerHTML = '<div class="text-center text-gray-500 py-8">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
            }
            if (modal) {
              modal.classList.remove('hidden');
            }
            
            try {
              await f5aFetchP4Data(month);
              console.log('[P4 Modal] Fetch completed, got', F5A_P4_RAW.length, 'records');
            } catch(err) {
              console.error('[P4 Modal] Fetch error:', err);
              if (content) {
                content.innerHTML = '<div class="text-center text-red-600 py-8">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "Tra c·ª©u P4" tr∆∞·ªõc.</div>';
              }
              return;
            }
            
            // Ki·ªÉm tra l·∫°i sau khi fetch
            if (!Array.isArray(F5A_P4_RAW) || !F5A_P4_RAW.length) {
              if (content) {
                content.innerHTML = '<div class="text-center text-red-600 py-8">Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "Tra c·ª©u P4" tr∆∞·ªõc.</div>';
              }
              return;
            }
          }
          
          // Helper functions
          const norm = (s) => String(s||'').toLowerCase().trim();
          const getV = (obj, keys) => {
            const lower = {};
            Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
            for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
            return '';
          };
          
          const parseDate = (value) => {
            try{
              if(!value) return null;
              const s = String(value).trim();
              let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
              m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
              if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
              return new Date(s);
            }catch(_){ return null; }
          };
          
          const formatYyyyMm = (d) => {
            if(!d) return '';
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          };
          
          // Filter tasks for this employee with "4M r√† so√°t" not empty
          let filteredTasks = F5A_P4_RAW.filter(r => {
            const name = String(getV(r, [
              'assignee','employee','name',
              'nh√¢n vi√™n','nhan vien','nhanvien',
              't√™n nh√¢n vi√™n','ten nhan vien','tennhanvien',
              'ph·ª• tr√°ch','phu trac','phutrac'
            ])||'').trim();
            
            // Skip tasks assigned to "x" (pending tasks)
            if(name.toLowerCase() === 'x') {
              return false;
            }
            
            if(name !== employeeName) return false;
            
            // Check "4M r√† so√°t" - must not be empty
            const rasoat4m = String(getV(r, [
              '4M r√† so√°t','4m r√† so√°t','4m ra soat',
              '4M','4m rasoat','rasoat4m'
            ])||'').trim();
            
            if(!rasoat4m) return false;
            
            // Filter by month if specified
            if(month){
              const completionDateStr = getV(r, [
                'ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te',
                'ng√†y ho√†n th√†nh','ngay hoan thanh',
                'completion date','completiondate'
              ]);
              const completionDate = parseDate(completionDateStr);
              if(completionDate && formatYyyyMm(completionDate) !== month) return false;
            }
            
            return true;
          });
          
          console.log('[P4 Modal] Found', filteredTasks.length, 'tasks');
          
          // Generate table HTML
          let tableHtml = `
            <table class="min-w-full text-sm border">
              <thead class="bg-blue-50">
                <tr>
                  <th class="px-3 py-2 text-left border">STT</th>
                  <th class="px-3 py-2 text-left border">M√£ t√°c v·ª•</th>
                  <th class="px-3 py-2 text-left border">Task Name</th>
                  <th class="px-3 py-2 text-left border">Ng√†y ho√†n th√†nh</th>
                  <th class="px-3 py-2 text-center border">TCKT(%)</th>
                  <th class="px-3 py-2 text-center border">CE(%)</th>
                  <th class="px-3 py-2 text-center border">HDKT(%)</th>
                  <th class="px-3 py-2 text-center border">BB ƒë√†o t·∫°o(%)</th>
                  <th class="px-3 py-2 text-center border">Jig tool(%)</th>
                  <th class="px-3 py-2 text-center border">KHKSCL(%)</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          if(filteredTasks.length === 0){
            tableHtml += '<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500 border">Kh√¥ng c√≥ t√°c v·ª• n√†o</td></tr>';
          } else {
            filteredTasks.forEach((task, idx) => {
              const taskCode = String(getV(task, ['m√£ t√°c v·ª•','ma tac vu','task code','taskcode'])||'');
              const taskName = String(getV(task, ['task name','taskname','t√™n t√°c v·ª•','ten tac vu'])||'');
              const completionDate = String(getV(task, ['ng√†y ho√†n th√†nh th·ª±c t·∫ø','ngay hoan thanh thuc te'])||'');
              
              // Parse and format percentage values
              const formatPercent = (val) => {
                if(!val) return '-';
                const v = String(val).replace('%','').trim();
                const num = parseFloat(v);
                if(isNaN(num)) return '-';
                // If value is between 0-1, convert to percentage
                if(num <= 1 && num > 0) {
                  return Math.round(num * 100) + '%';
                }
                // If value is already percentage, just add % if missing
                return Math.round(num) + '%';
              };
              
              const tckt = formatPercent(getV(task, ['TCKT(% ho√†n th√†nh)','tckt(% ho√†n th√†nh)','tckt']));
              const ce = formatPercent(getV(task, ['CE(% ho√†n th√†nh)','ce(% ho√†n th√†nh)','ce']));
              const hdkt = formatPercent(getV(task, ['HDKT(% ho√†n th√†nh)','hdkt(% ho√†n th√†nh)','hdkt']));
              const bb = formatPercent(getV(task, ['BB ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o(% ho√†n th√†nh)','bb ƒë√†o t·∫°o']));
              const jig = formatPercent(getV(task, ['Jig tool(% ho√†n th√†nh)','jig tool(% ho√†n th√†nh)','jig tool']));
              const khkscl = formatPercent(getV(task, ['KHKSCL(% ho√†n th√†nh)','khkscl(% ho√†n th√†nh)','khkscl']));
              
              tableHtml += `
                <tr class="hover:bg-gray-50">
                  <td class="px-3 py-2 border">${idx + 1}</td>
                  <td class="px-3 py-2 border font-mono text-xs">${taskCode}</td>
                  <td class="px-3 py-2 border">${taskName}</td>
                  <td class="px-3 py-2 border text-center">${completionDate}</td>
                  <td class="px-3 py-2 border text-center">${tckt}</td>
                  <td class="px-3 py-2 border text-center">${ce}</td>
                  <td class="px-3 py-2 border text-center">${hdkt}</td>
                  <td class="px-3 py-2 border text-center">${bb}</td>
                  <td class="px-3 py-2 border text-center">${jig}</td>
                  <td class="px-3 py-2 border text-center">${khkscl}</td>
                </tr>
              `;
            });
          }
          
          tableHtml += '</tbody></table>';
          
          // Update modal
          document.getElementById('p4-modal-title').textContent = `Chi ti·∫øt t√°c v·ª• m√°y - ${employeeName} (${filteredTasks.length} t√°c v·ª•)`;
          document.getElementById('p4-modal-content').innerHTML = tableHtml;
          document.getElementById('p4-task-modal').classList.remove('hidden');
          
        } catch(err) {
          console.error('[P4 Modal] Error:', err);
          alert('L·ªói hi·ªÉn th·ªã chi ti·∫øt t√°c v·ª•');
        }
      }
      
      function closeP4TaskModal() {
        document.getElementById('p4-task-modal').classList.add('hidden');
      }

      // Event listener cho n√∫t "Ch·ªçn t·ªáp" c·ªßa Form 2
      // ƒê√É B·ªé: T·ª± ƒë·ªông fetch Form 5 khi trang load - Ch·ªâ fetch khi nh·∫•n n√∫t "Tra c·ª©u"

      document.addEventListener('DOMContentLoaded', function() {
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const uploadFileInput = document.getElementById('upload-file');
        const uploadFileName = document.getElementById('upload-file-name');
        
        if (uploadFileBtn && uploadFileInput && uploadFileName) {
          uploadFileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            uploadFileInput.click();
          });
          
          uploadFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              uploadFileName.textContent = file.name;
              uploadFileName.className = 'text-sm text-green-600 font-medium';
            } else {
              uploadFileName.textContent = 'Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn';
              uploadFileName.className = 'text-sm text-gray-600';
            }
          });
        }

        // Form 11 - Ki·ªÉm tra tr∆∞·ªõc b√°o c√°o
        const f11UploadBtn = document.getElementById('f11-upload-btn');
        const f11FileInput = document.getElementById('f11-file');
        const f11FileName = document.getElementById('f11-file-name');
        const f11SubmitBtn = document.getElementById('f11-submit-btn');
        
        if (f11UploadBtn && f11FileInput && f11FileName && f11SubmitBtn) {
          // N√∫t ch·ªçn file
          f11UploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            f11FileInput.click();
          });
          
          // Hi·ªÉn th·ªã t√™n file khi ch·ªçn v√† enable n√∫t G·ª≠i
          f11FileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
              const fileName = file.name.toLowerCase();
              if (!fileName.endsWith('.xlsx')) {
                showToast('Ch·ªâ ch·∫•p nh·∫≠n file ƒë·ªãnh d·∫°ng .xlsx', 'error');
                f11FileInput.value = '';
                f11FileName.textContent = 'Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn';
                f11FileName.className = 'text-sm text-gray-600';
                f11SubmitBtn.disabled = true;
                // ·∫®n k·∫øt qu·∫£ c≈©
                const resultsContainer = document.getElementById('f11-results');
                if (resultsContainer) resultsContainer.classList.add('hidden');
                return;
              }
              
              f11FileName.textContent = file.name;
              f11FileName.className = 'text-sm text-green-600 font-medium';
              f11SubmitBtn.disabled = false;
              // ·∫®n k·∫øt qu·∫£ c≈© khi ch·ªçn file m·ªõi
              const resultsContainer = document.getElementById('f11-results');
              if (resultsContainer) resultsContainer.classList.add('hidden');
            } else {
              f11FileName.textContent = 'Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn';
              f11FileName.className = 'text-sm text-gray-600';
              f11SubmitBtn.disabled = true;
              // ·∫®n k·∫øt qu·∫£
              const resultsContainer = document.getElementById('f11-results');
              if (resultsContainer) resultsContainer.classList.add('hidden');
            }
          });
          
          // N√∫t G·ª≠i - upload file
          f11SubmitBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const file = f11FileInput.files[0];
            if (!file) {
              showToast('Vui l√≤ng ch·ªçn file tr∆∞·ªõc', 'error');
              return;
            }
            await handleForm11Upload(file);
          });
        }

        // Form 12 - M√£ danh m·ª•c
        const f12SearchBtn = document.getElementById('f12-search');
        if (f12SearchBtn) {
          f12SearchBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            await renderForm12Data();
          });
        }
        const f12ExportBtn = document.getElementById('f12-export-xlsx');
        if (f12ExportBtn) {
          f12ExportBtn.addEventListener('click', function(e) { e.preventDefault(); f12DownloadXLSX(); });
        }
        const f12FilterBtn = document.getElementById('f12-filter-btn');
        if (f12FilterBtn) f12FilterBtn.addEventListener('click', f12OpenFilterModal);
        const f12FilterModalClose = document.getElementById('f12-filter-modal-close');
        if (f12FilterModalClose) f12FilterModalClose.addEventListener('click', f12CloseFilterModal);
        const f12FilterApply = document.getElementById('f12-filter-apply');
        if (f12FilterApply) f12FilterApply.addEventListener('click', f12CloseFilterModal);
        const f12FilterSearch = document.getElementById('f12-filter-search');
        if (f12FilterSearch) f12FilterSearch.addEventListener('input', function(){ f12RenderFilterList(this.value); });
        document.getElementById('f12-filter-modal') && document.getElementById('f12-filter-modal').addEventListener('click', function(e){ if (e.target === this) f12CloseFilterModal(); });
        var f12HangMucBtn = document.getElementById('f12-filter-hangmuc-btn');
        if (f12HangMucBtn) f12HangMucBtn.addEventListener('click', f12OpenFilterHangMucModal);
        var f12HangMucClose = document.getElementById('f12-filter-hangmuc-close');
        if (f12HangMucClose) f12HangMucClose.addEventListener('click', f12CloseFilterHangMucModal);
        var f12HangMucApply = document.getElementById('f12-filter-hangmuc-apply');
        if (f12HangMucApply) f12HangMucApply.addEventListener('click', f12CloseFilterHangMucModal);
        var f12HangMucReset = document.getElementById('f12-filter-hangmuc-reset');
        if (f12HangMucReset) f12HangMucReset.addEventListener('click', function(){ F12_FILTER_HANG_MUC = ''; f12UpdateFilterHangMucLabel(); f12CloseFilterHangMucModal(); renderForm12Table(f12GetDisplayedRows()); });
        var f12HangMucSearch = document.getElementById('f12-filter-hangmuc-search');
        if (f12HangMucSearch) f12HangMucSearch.addEventListener('input', function(){ f12RenderFilterHangMucList(this.value); });
        document.getElementById('f12-filter-hangmuc-modal') && document.getElementById('f12-filter-hangmuc-modal').addEventListener('click', function(e){ if (e.target === this) f12CloseFilterHangMucModal(); });
        var f12SelectAll = document.getElementById('f12-select-all');
        var f12ShowTickedBtn = document.getElementById('f12-show-ticked-only-btn');
        if (f12ShowTickedBtn) f12ShowTickedBtn.addEventListener('click', function(){
          F12_SHOW_ONLY_TICKED = !F12_SHOW_ONLY_TICKED;
          var lbl = document.getElementById('f12-show-ticked-only-label');
          if (lbl) lbl.textContent = F12_SHOW_ONLY_TICKED ? 'Hi·ªán t·∫•t c·∫£' : 'Ch·ªâ hi·ªán ƒë√£ tick';
          f12ShowTickedBtn.classList.toggle('bg-blue-100', F12_SHOW_ONLY_TICKED);
          f12ShowTickedBtn.classList.toggle('border-blue-500', F12_SHOW_ONLY_TICKED);
          renderForm12Table(f12GetDisplayedRows());
        });
        if (f12SelectAll) f12SelectAll.addEventListener('change', function(){
          var displayed = f12GetDisplayedRows();
          var allChecked = this.checked;
          displayed.forEach(function(r){ var i = F12_LAST_ROWS.indexOf(r); if (i >= 0) F12_TICKED_IDS[f12RowKey(i)] = allChecked; });
          f12UpdateTickedCount();
          renderForm12Table(displayed);
        });
      });

      // H√†m x·ª≠ l√Ω upload cho Form 11
      async function handleForm11Upload(file) {
        if (!file) {
          showToast('Vui l√≤ng ch·ªçn file', 'error');
          return;
        }

        // Ki·ªÉm tra ƒë·ªãnh d·∫°ng
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.xlsx')) {
          showToast('Ch·ªâ ch·∫•p nh·∫≠n file ƒë·ªãnh d·∫°ng .xlsx', 'error');
          return;
        }

        const submitBtn = document.getElementById('f11-submit-btn');
        const originalText = submitBtn ? submitBtn.textContent : '';
        
        try {
          // Disable n√∫t v√† hi·ªÉn th·ªã loading
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
          }

          // T·∫°o FormData v·ªõi key "data0" cho file binary
          const fd = new FormData();
          // G·ª≠i file v·ªõi key "data0" - ƒë·∫£m b·∫£o file ƒë∆∞·ª£c append ƒë√∫ng c√°ch
          fd.append('data0', file, file.name);
          
          // Th√™m c√°c metadata kh√°c n·∫øu c·∫ßn
          fd.append('file_name', file.name || '');
          fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          fd.append('timestamp_yyyy_mm_dd', formatYyyyMmDdHHmm(new Date()));
          fd.append('action', 'form11_upload');

          console.log('[Form 11] G·ª≠i file:', file.name, 'Size:', file.size, 'bytes');
          console.log('[Form 11] URL:', FORM11_UPLOAD_URL);
          console.log('[Form 11] FormData keys:', Array.from(fd.keys()));

          // G·ª≠i request - th·ª≠ cors tr∆∞·ªõc ƒë·ªÉ c√≥ th·ªÉ ƒë·ªçc response
          let response = null;
          let responseData = null;
          try {
            response = await fetch(FORM11_UPLOAD_URL, {
              method: 'POST',
              body: fd,
              mode: 'cors',
              credentials: 'omit'
            });
            console.log('[Form 11] Response status:', response.status);
            if (response.ok) {
              try {
                const responseText = await response.text();
                console.log('[Form 11] Response:', responseText);
                // Parse JSON response
                try {
                  responseData = JSON.parse(responseText);
                  console.log('[Form 11] Parsed data:', responseData);
                } catch (parseError) {
                  console.warn('[Form 11] Kh√¥ng th·ªÉ parse JSON:', parseError);
                }
              } catch (e) {
                console.log('[Form 11] Kh√¥ng th·ªÉ ƒë·ªçc response text');
              }
            }
          } catch (corsError) {
            console.warn('[Form 11] CORS failed, trying no-cors:', corsError);
            // Fallback v·ªÅ no-cors - kh√¥ng th·ªÉ ƒë·ªçc response nh∆∞ng v·∫´n g·ª≠i ƒë∆∞·ª£c
            try {
              await fetch(FORM11_UPLOAD_URL, {
                method: 'POST',
                body: fd,
                mode: 'no-cors'
              });
              console.log('[Form 11] ƒê√£ g·ª≠i v·ªõi no-cors mode');
            } catch (noCorsError) {
              console.error('[Form 11] C·∫£ cors v√† no-cors ƒë·ªÅu fail:', noCorsError);
              throw noCorsError;
            }
          }

          // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o webhook ƒë√£ x·ª≠ l√Ω xong
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Hi·ªÉn th·ªã k·∫øt qu·∫£ n·∫øu c√≥
          if (responseData && Array.isArray(responseData) && responseData.length > 0) {
            renderForm11Results(responseData);
            showToast('ƒê√£ x·ª≠ l√Ω file th√†nh c√¥ng', 'success');
          } else {
            showToast('ƒê√£ g·ª≠i file th√†nh c√¥ng', 'success');
          }
          
          // Kh√¥ng reset file input sau khi g·ª≠i th√†nh c√¥ng ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ xem l·∫°i k·∫øt qu·∫£
          // Ch·ªâ reset khi ng∆∞·ªùi d√πng ch·ªçn file m·ªõi
        } catch (e) {
          console.error('[Form 11] Upload error:', e);
          showToast('G·ª≠i file th·∫•t b·∫°i: ' + (e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
        } finally {
          // Restore n√∫t
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      }

      // Form 12 - Cache d·ªØ li·ªáu ƒë·ªÉ l·ªçc v√† xu·∫•t
      let F12_LAST_ROWS = [];
      let F12_FILTER_HANG_MUC = '';
      let F12_HANG_MUC_OPTIONS = [];
      let F12_FILTER_OPTIONS = [];
      let F12_TICKED_IDS = {};
      let F12_SHOW_ONLY_TICKED = false;
      const F12_COLS = ['Id','T√™n linh ki·ªán','M√£ danh m·ª•c','H·∫°ng m·ª•c ki·ªÉm tra','Ti√™u chu·∫©n','C√¥ng c·ª•','Type','H∆∞·ªõng d·∫´n','Available','C√¥ng chu·∫©n'];
      const F12_DISPLAY_COLS = ['Id','M√£ danh m·ª•c','H·∫°ng m·ª•c ki·ªÉm tra','Ti√™u chu·∫©n','C√¥ng c·ª•','Type','H∆∞·ªõng d·∫´n','Available','C√¥ng chu·∫©n'];

      function f12RowKey(idx) { return 'idx_' + idx; }

      function renderForm12Table(rows) {
        const bodyEl = document.getElementById('f12-body');
        if (!bodyEl) return;
        const escape = (v) => (v == null || v === '') ? '' : String(v).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        if (!rows.length) {
          bodyEl.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        } else {
          bodyEl.innerHTML = rows.map(function(row){
            var globalIdx = F12_LAST_ROWS.indexOf(row);
            if (globalIdx < 0) globalIdx = F12_LAST_ROWS.length;
            var key = f12RowKey(globalIdx);
            var checked = F12_TICKED_IDS[key] ? ' checked' : '';
            var cells = F12_DISPLAY_COLS.map(k => escape(row[k] ?? ''));
            return '<tr class="hover:bg-blue-50/50" data-f12-key="' + escape(key) + '"><td class="px-3 py-2 align-middle"><input type="checkbox" class="f12-row-cb rounded border-gray-400" data-key="' + escape(key) + '"' + checked + ' /></td>' + cells.map(c => '<td class="px-3 py-2 text-gray-800 align-top">' + c + '</td>').join('') + '</tr>';
          }).join('');
        }
        bodyEl.querySelectorAll('.f12-row-cb').forEach(function(cb){
          cb.addEventListener('change', function(){ var k = cb.getAttribute('data-key'); F12_TICKED_IDS[k] = cb.checked; f12UpdateTickedCount(); });
        });
        var selAll = document.getElementById('f12-select-all');
        if (selAll) {
          if (rows.length === 0) { selAll.checked = false; selAll.indeterminate = false; }
          else {
            var anyTicked = rows.some(function(r){ var i = F12_LAST_ROWS.indexOf(r); return i >= 0 && F12_TICKED_IDS[f12RowKey(i)]; });
            var allTicked = rows.every(function(r){ var i = F12_LAST_ROWS.indexOf(r); return i >= 0 && F12_TICKED_IDS[f12RowKey(i)]; });
            selAll.checked = allTicked;
            selAll.indeterminate = anyTicked && !allTicked;
          }
        }
        f12UpdateTickedCount();
      }

      function f12UpdateTickedCount() {
        var cnt = Object.keys(F12_TICKED_IDS).filter(function(k){ return F12_TICKED_IDS[k]; }).length;
        var el = document.getElementById('f12-ticked-count');
        if (el) el.textContent = 'ƒê√£ ch·ªçn: ' + cnt;
      }

      function f12GetDisplayedRows() {
        var base = !F12_FILTER_HANG_MUC ? F12_LAST_ROWS : F12_LAST_ROWS.filter(function(r){ return String(r['H·∫°ng m·ª•c ki·ªÉm tra'] || '').trim() === F12_FILTER_HANG_MUC; });
        if (!F12_SHOW_ONLY_TICKED) return base;
        return base.filter(function(r, i){ var idx = F12_LAST_ROWS.indexOf(r); return idx >= 0 && F12_TICKED_IDS[f12RowKey(idx)]; });
      }

      function f12GetTickedRows() {
        return F12_LAST_ROWS.filter(function(r, i){ return F12_TICKED_IDS[f12RowKey(i)]; });
      }

      function f12RenderFilterList(keyword) {
        const listEl = document.getElementById('f12-filter-list');
        if (!listEl) return;
        if (F12_FILTER_OPTIONS.length === 0) {
          listEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu. Nh·∫•n "Tra c·ª©u" ƒë·ªÉ t·∫£i.</div>';
          return;
        }
        var kw = (keyword || '').toLowerCase().trim();
        var filtered = kw ? F12_FILTER_OPTIONS.filter(function(v){ return String(v).toLowerCase().indexOf(kw) >= 0; }) : F12_FILTER_OPTIONS;
        if (filtered.length === 0) {
          listEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
          return;
        }
        var html = '<div class="f12-tick-item cursor-pointer px-4 py-2.5 hover:bg-blue-50 text-gray-800 text-sm" data-value="">Tick t·∫•t c·∫£</div>';
        filtered.forEach(function(v){
          var esc = String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
          html += '<div class="f12-tick-item cursor-pointer px-4 py-2.5 hover:bg-blue-50 text-gray-800 text-sm" data-value="' + esc + '">Tick: ' + esc + '</div>';
        });
        listEl.innerHTML = html;
        listEl.querySelectorAll('.f12-tick-item').forEach(function(el){
          el.addEventListener('click', function(){
            var val = el.getAttribute('data-value') || '';
            F12_LAST_ROWS.forEach(function(r, i){
              var k = f12RowKey(i);
              if (!val) { F12_TICKED_IDS[k] = true; }
              else if (String(r['T√™n linh ki·ªán'] || '').trim() === val) { F12_TICKED_IDS[k] = true; }
            });
            f12UpdateTickedCount();
            f12CloseFilterModal();
            renderForm12Table(f12GetDisplayedRows());
          });
        });
      }

      function f12OpenFilterModal() {
        var m = document.getElementById('f12-filter-modal');
        if (m) { m.classList.add('open'); m.setAttribute('aria-hidden','false'); document.getElementById('f12-filter-search').value = ''; f12RenderFilterList(''); }
      }
      function f12CloseFilterModal() {
        var m = document.getElementById('f12-filter-modal');
        if (m) { m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }
      }

      function f12UpdateFilterHangMucLabel() {
        var lbl = document.getElementById('f12-filter-hangmuc-label');
        if (lbl) lbl.textContent = F12_FILTER_HANG_MUC || 'T·∫•t c·∫£';
      }

      function f12RenderFilterHangMucList(keyword) {
        var listEl = document.getElementById('f12-filter-hangmuc-list');
        if (!listEl) return;
        if (F12_HANG_MUC_OPTIONS.length === 0) {
          listEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu. Nh·∫•n "Tra c·ª©u" ƒë·ªÉ t·∫£i.</div>';
          return;
        }
        var kw = (keyword || '').toLowerCase().trim();
        var filtered = kw ? F12_HANG_MUC_OPTIONS.filter(function(v){ return String(v).toLowerCase().indexOf(kw) >= 0; }) : F12_HANG_MUC_OPTIONS;
        if (filtered.length === 0) {
          listEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
          return;
        }
        var sel = F12_FILTER_HANG_MUC;
        var html = '<div class="f12-hangmuc-item cursor-pointer px-4 py-2.5 hover:bg-blue-50 text-gray-800 text-sm' + (sel === '' ? ' bg-blue-100 font-medium' : '') + '" data-value="">T·∫•t c·∫£</div>';
        filtered.forEach(function(v){
          var esc = String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
          html += '<div class="f12-hangmuc-item cursor-pointer px-4 py-2.5 hover:bg-blue-50 text-gray-800 text-sm' + (sel === v ? ' bg-blue-100 font-medium' : '') + '" data-value="' + esc + '">' + esc + '</div>';
        });
        listEl.innerHTML = html;
        listEl.querySelectorAll('.f12-hangmuc-item').forEach(function(el){
          el.addEventListener('click', function(){ F12_FILTER_HANG_MUC = (el.getAttribute('data-value') || ''); f12UpdateFilterHangMucLabel(); f12CloseFilterHangMucModal(); renderForm12Table(f12GetDisplayedRows()); });
        });
      }

      function f12OpenFilterHangMucModal() {
        var m = document.getElementById('f12-filter-hangmuc-modal');
        if (m) { m.classList.add('open'); m.setAttribute('aria-hidden','false'); document.getElementById('f12-filter-hangmuc-search').value = ''; f12RenderFilterHangMucList(''); }
      }
      function f12CloseFilterHangMucModal() {
        var m = document.getElementById('f12-filter-hangmuc-modal');
        if (m) { m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }
      }

      function f12PopulateFilter(rows) {
        var arrTen = rows.map(function(r){ return String(r['T√™n linh ki·ªán'] || '').trim(); }).filter(Boolean);
        var arrHangMuc = rows.map(function(r){ return String(r['H·∫°ng m·ª•c ki·ªÉm tra'] || '').trim(); }).filter(Boolean);
        F12_FILTER_OPTIONS = [...new Set(arrTen)].sort();
        F12_HANG_MUC_OPTIONS = [...new Set(arrHangMuc)].sort();
        F12_FILTER_HANG_MUC = '';
        f12UpdateFilterHangMucLabel();
        f12RenderFilterList('');
        f12RenderFilterHangMucList('');
      }

      async function renderForm12Data() {
        const loadingEl = document.getElementById('f12-loading');
        const bodyEl = document.getElementById('f12-body');
        if (!bodyEl) return;
        try {
          if (loadingEl) loadingEl.classList.remove('hidden');
          bodyEl.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10"><span class="spinner mr-2"></span>ƒêang t·∫£i...</td></tr>';
          const url = `${FORM12_LOOKUP_URL}?_ts=${Date.now()}`;
          const r = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          let data = await r.json();
          let rows = [];
          if (Array.isArray(data)) rows = data;
          else if (data && typeof data === 'object') {
            if (Array.isArray(data.data)) rows = data.data;
            else if (data.json && Array.isArray(data.json.data)) rows = data.json.data;
            else if (data.json && Array.isArray(data.json)) rows = data.json;
          }
          F12_LAST_ROWS = rows;
          F12_TICKED_IDS = {};
          F12_SHOW_ONLY_TICKED = false;
          var stBtn = document.getElementById('f12-show-ticked-only-btn');
          if (stBtn) { stBtn.classList.remove('bg-blue-100','border-blue-500'); var stLbl = document.getElementById('f12-show-ticked-only-label'); if (stLbl) stLbl.textContent = 'Ch·ªâ hi·ªán ƒë√£ tick'; }
          f12PopulateFilter(rows);
          const displayed = f12GetDisplayedRows();
          renderForm12Table(displayed);
          showToast(`ƒê√£ t·∫£i ${rows.length} b·∫£n ghi`, 'success');
        } catch (e) {
          console.error('[Form 12] Fetch error:', e);
          const errMsg = String(e.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          bodyEl.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="10">L·ªói: ${errMsg}</td></tr>`;
          showToast('T·∫£i d·ªØ li·ªáu th·∫•t b·∫°i', 'error');
        } finally {
          if (loadingEl) loadingEl.classList.add('hidden');
        }
      }

      function f12DownloadXLSX() {
        try {
          const rows = f12GetTickedRows();
          if (!Array.isArray(rows) || !rows.length) { showToast('Form 12: Vui l√≤ng tick √≠t nh·∫•t 1 d√≤ng ƒë·ªÉ xu·∫•t.', 'error'); return; }
          const aoa = [F12_DISPLAY_COLS].concat(rows.map(r => F12_DISPLAY_COLS.map(k => r[k] ?? '')));
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'M√£ danh m·ª•c');
          XLSX.writeFile(wb, `Form12_MaDanhMuc_${new Date().toISOString().slice(0,10)}.xlsx`);
          showToast(`ƒê√£ xu·∫•t ${rows.length} b·∫£n ghi`, 'success');
        } catch (_) { showToast('Form 12: Xu·∫•t XLSX th·∫•t b·∫°i.', 'error'); }
      }

      // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ Form 11
      function renderForm11Results(data) {
        const resultsContainer = document.getElementById('f11-results');
        if (!resultsContainer) return;

        // Hi·ªÉn th·ªã container
        resultsContainer.classList.remove('hidden');

        // Parse d·ªØ li·ªáu - c·∫•u tr√∫c m·ªõi: m·∫£ng ch·ª©a object, object c√≥ data v√† rows
        let mainData = null; // D·ªØ li·ªáu ch√≠nh (c√≥ output, nhan_xet, bao_cao_bat_thuong, thong_ke_them, data, rows)
        let conclusionData = null;
        let statisticsData = null;
        let tcktDataArray = []; // M·∫£ng c√°c object c√≥ H·∫°ng m·ª•c ki·ªÉm tra ƒë·ªÉ t·∫°o b·∫£ng TCKT
        let rowsDataArray = []; // M·∫£ng c√°c rows ƒë·ªÉ t·∫°o b·∫£ng H·∫°ng m·ª•c th√™m
        
        // X·ª≠ l√Ω d·ªØ li·ªáu - c√≥ th·ªÉ l√† m·∫£ng ch·ª©a object ho·∫∑c object ƒë∆°n
        if (Array.isArray(data) && data.length > 0) {
          // L·∫•y object ƒë·∫ßu ti√™n (ho·∫∑c x·ª≠ l√Ω nhi·ªÅu items n·∫øu c√≥)
          mainData = data[0];
        } else if (typeof data === 'object' && data !== null) {
          mainData = data;
        }
        
        if (!mainData) {
          console.warn('[Form 11] Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã');
          return;
        }
        
        console.log('[Form 11] D·ªØ li·ªáu ch√≠nh:', mainData);
        
        // L·∫•y output (k·∫øt lu·∫≠n)
        conclusionData = mainData;
        
        // L·∫•y th·ªëng k√™ t·ª´ data array
        if (mainData.data && Array.isArray(mainData.data)) {
          statisticsData = mainData.data.find(item => item && item.thong_ke && item.thong_ke.total !== undefined);
          
          // L·ªçc c√°c object c√≥ H·∫°ng m·ª•c ki·ªÉm tra (lo·∫°i b·ªè object c√≥ thong_ke)
          tcktDataArray = mainData.data.filter(item => {
            if (!item || typeof item !== 'object' || Array.isArray(item)) return false;
            // Lo·∫°i b·ªè object c√≥ thong_ke (th·ªëng k√™)
            if (item.thong_ke) return false;
            // Ch·ªâ l·∫•y object c√≥ H·∫°ng m·ª•c ki·ªÉm tra
            const hasHangMuc = item['H·∫°ng m·ª•c ki·ªÉm tra (Index)'] || item['H·∫°ng m·ª•c ki·ªÉm tra \n(Index)'];
            return !!hasHangMuc;
          });
        }
        
        // L·∫•y rows array
        if (mainData.rows && Array.isArray(mainData.rows)) {
          rowsDataArray = mainData.rows;
        }

        if (tcktDataArray.length === 0 && rowsDataArray.length === 0) {
          console.warn('[Form 11] Kh√¥ng c√≥ d·ªØ li·ªáu TCKT ho·∫∑c rows ƒë·ªÉ hi·ªÉn th·ªã');
          return;
        }

        const nhanXet = mainData?.nhan_xet || '';
        const baoCaoBatThuong = mainData?.bao_cao_bat_thuong || '';
        const soMauTest = mainData?.so_mau_test || 0;
        const congChuanSheet = mainData?.Cong_chuan_Sheet_theo_so_mau || 0;
        const congChuanSheetThem = mainData?.Cong_chuan_Sheetthem_theo_so_mau || 0;
        const tongCongChuanThuc = mainData?.tong_cong_chuan_thuc || 0;
        const tongCongChuanThucChuyenDoi = mainData?.tong_cong_chuan_thuc_chuyen_doi || '';
        const thongKeThem = mainData?.thong_ke_them || {};
        
        // H√†m format s·ªë th·∫≠p ph√¢n: ƒë·ªïi d·∫•u . th√†nh d·∫•u ,
        function formatDecimal(value) {
          if (value === null || value === undefined || value === '') return value;
          return String(value).replace(/\./g, ',');
        }
        
        // Format c√¥ng chu·∫©n Sheet v√† Sheet th√™m
        const congChuanSheetFormatted = formatDecimal(congChuanSheet);
        const congChuanSheetThemFormatted = formatDecimal(congChuanSheetThem);
        
        // L·∫•y th·ªëng k√™ t·ª´ statisticsData n·∫øu c√≥
        const thongKe = statisticsData?.thong_ke || {};

        // 1. Hi·ªÉn th·ªã K·∫øt lu·∫≠n ƒë√°nh gi√° (n·∫øu c√≥)
        const conclusionDiv = document.getElementById('f11-conclusion');
        if (conclusionDiv) {
          if (conclusionData && conclusionData.output) {
            const ketQua = conclusionData.output.Ket_qua_danh_gia || '';
            const coTestBen = conclusionData.output.co_test_ben || '';
            const noiDungTestBen = conclusionData.output.Noi_dung_test_ben || '';
            
            let bgColor = 'bg-blue-50 border-blue-300';
            let textColor = 'text-blue-800';
            if (ketQua.includes('kh√¥ng ƒë·∫°t') || ketQua.includes('KH√îNG ƒê·∫†T')) {
              bgColor = 'bg-red-50 border-red-300';
              textColor = 'text-red-800';
            } else if (ketQua.includes('ƒë·∫°t') || ketQua.includes('ƒê·∫†T')) {
              bgColor = 'bg-green-50 border-green-300';
              textColor = 'text-green-800';
            }

            conclusionDiv.className = `p-3 rounded-lg border-2 ${bgColor}`;
            conclusionDiv.innerHTML = `
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="text-lg font-semibold ${textColor}">üìä K·∫øt lu·∫≠n:</span>
                  <span class="text-base font-semibold ${textColor}">${ketQua}</span>
                </div>
                ${coTestBen ? `<span class="text-xs ${textColor}">Test b·ªÅn: ${coTestBen}</span>` : ''}
              </div>
              ${noiDungTestBen ? `<div class="text-xs ${textColor} mb-2">N·ªôi dung: ${noiDungTestBen}</div>` : ''}
              <div class="grid grid-cols-4 gap-2 pt-2 border-t ${textColor.replace('800', '300')}">
                <div class="text-center">
                  <div class="text-xs text-gray-600">S·ªë m·∫´u</div>
                  <div class="text-base font-bold ${textColor}">${soMauTest}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-600">C√¥ng chu·∫©n Sheet</div>
                  <div class="text-base font-bold ${textColor}">${congChuanSheetFormatted}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-600">Sheet th√™m</div>
                  <div class="text-base font-bold ${textColor}">${congChuanSheetThemFormatted}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-600">T·ªïng c√¥ng chu·∫©n</div>
                  <div class="text-base font-bold ${textColor}">${tongCongChuanThucChuyenDoi || tongCongChuanThuc}</div>
                </div>
              </div>
            `;
          } else {
            // Kh√¥ng c√≥ k·∫øt lu·∫≠n, ch·ªâ hi·ªÉn th·ªã th√¥ng tin t·ªïng quan
            conclusionDiv.className = 'p-3 rounded-lg border-2 bg-blue-50 border-blue-300';
            conclusionDiv.innerHTML = `
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg font-semibold text-blue-800">üìä Th√¥ng tin t·ªïng quan</span>
              </div>
              <div class="grid grid-cols-4 gap-2">
                <div class="text-center">
                  <div class="text-xs text-gray-600">S·ªë m·∫´u</div>
                  <div class="text-base font-bold text-blue-800">${soMauTest}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-600">C√¥ng chu·∫©n Sheet</div>
                  <div class="text-base font-bold text-blue-800">${congChuanSheetFormatted}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-600">Sheet th√™m</div>
                  <div class="text-base font-bold text-blue-800">${congChuanSheetThemFormatted}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-600">T·ªïng c√¥ng chu·∫©n</div>
                  <div class="text-base font-bold text-blue-800">${tongCongChuanThucChuyenDoi || tongCongChuanThuc}</div>
                </div>
              </div>
            `;
          }
        }

        // 2. Hi·ªÉn th·ªã Th·ªëng k√™
        const statisticsDiv = document.getElementById('f11-statistics');
        if (statisticsDiv) {
          // ∆Øu ti√™n th·ªëng k√™ t·ª´ thong_ke (t·ªïng) n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng thong_ke_them
          const stats = thongKe.total !== undefined ? thongKe : (thongKeThem.thong_ke_danh_gia || {});
          const soHangMuc = thongKeThem.so_hang_muc || (thongKe.total !== undefined ? thongKe.total : 0);
          const soCotMau = thongKeThem.so_cot_mau || 0;
          const rowsCoCongChuan = thongKeThem.rows_co_cong_chuan || 0;
          const rowsCoDuLieuMau = thongKeThem.rows_co_du_lieu_mau || 0;
          
          statisticsDiv.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">T·ªïng s·ªë</div>
              <div class="text-lg font-bold text-blue-800">${thongKe.total || soHangMuc || 0}</div>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">OK</div>
              <div class="text-lg font-bold text-green-800">${stats.OK || thongKe.OK || 0}</div>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">NG</div>
              <div class="text-lg font-bold text-red-800">${stats.NG || thongKe.NG || 0}</div>
            </div>
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">KDG</div>
              <div class="text-lg font-bold text-orange-800">${stats.KDG || thongKe.KDG || 0}</div>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">KKL</div>
              <div class="text-lg font-bold text-yellow-800">${stats.KKL || thongKe.KKL || 0}</div>
            </div>
            ${thongKe.Test_ben !== undefined ? `
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">Test b·ªÅn</div>
              <div class="text-lg font-bold text-purple-800">${thongKe.Test_ben || 0}</div>
            </div>
            ` : ''}
          `;
        }

        // 3. Hi·ªÉn th·ªã Nh·∫≠n x√©t v√† B√°o c√°o b·∫•t th∆∞·ªùng
        const commentsDiv = document.getElementById('f11-comments');
        if (commentsDiv) {
          commentsDiv.innerHTML = `
            ${nhanXet ? `
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">üí¨ Nh·∫≠n x√©t</h3>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">${nhanXet}</p>
              </div>
            ` : ''}
            ${baoCaoBatThuong ? `
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <h3 class="font-semibold text-amber-800 mb-2">‚ö†Ô∏è B√°o c√°o b·∫•t th∆∞·ªùng</h3>
                <div class="text-sm text-gray-700 whitespace-pre-wrap">${baoCaoBatThuong}</div>
              </div>
            ` : ''}
          `;
        }

        // 4. Hi·ªÉn th·ªã B·∫£ng TCKT (t·ª´ data array)
        const itemsContainer = document.getElementById('f11-items-container');
        if (itemsContainer && tcktDataArray.length > 0) {
          itemsContainer.innerHTML = ''; // Clear container
          
          // T√¨m c√°c c·ªôt m·∫´u t·ª´ d·ªØ li·ªáu TCKT (M1, M2, M3, M4, M5, ...)
          const tcktSampleCols = [];
          tcktDataArray.forEach(item => {
            Object.keys(item).forEach(key => {
              if (key.match(/^M\d+$/) && !tcktSampleCols.includes(key)) {
                tcktSampleCols.push(key);
              }
            });
          });
          tcktSampleCols.sort();
          
          // T·∫°o section cho b·∫£ng TCKT
          const itemSection = document.createElement('div');
          itemSection.className = 'mb-6 p-4 bg-white border border-gray-200 rounded-lg shadow-sm';
          itemSection.innerHTML = `
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-blue-800">üìã B·∫£ng TCKT</h3>
              ${thongKe.total ? `
                <div class="flex items-center gap-4 text-sm">
                  <span class="text-gray-600">T·ªïng: <strong class="text-blue-800">${thongKe.total}</strong></span>
                  <span class="text-green-600">OK: <strong>${thongKe.OK || 0}</strong></span>
                  <span class="text-red-600">NG: <strong>${thongKe.NG || 0}</strong></span>
                  <span class="text-orange-600">KDG: <strong>${thongKe.KDG || 0}</strong></span>
                  <span class="text-yellow-600">KKL: <strong>${thongKe.KKL || 0}</strong></span>
                </div>
              ` : ''}
            </div>
            <div class="overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
              <table class="min-w-full text-sm border-collapse">
                <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                  <tr>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">STT</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">H·∫°ng m·ª•c ki·ªÉm tra</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">Ti√™u chu·∫©n</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">C√¥ng chu·∫©n</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">ƒê√°nh gi√°</th>
                    ${tcktSampleCols.map(col => `<th class="px-2 py-2 border border-gray-300 text-center font-semibold">${col}</th>`).join('')}
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">Ghi ch√∫</th>
                  </tr>
                </thead>
                <tbody id="f11-tckt-tbody">
                </tbody>
              </table>
            </div>
          `;
          
          const tbody = itemSection.querySelector('#f11-tckt-tbody');
          if (tbody) {
            tcktDataArray.forEach((row, idx) => {
              const danhGia = row['ƒê√°nh gi√°'] || '';
              let rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
              let danhGiaColor = 'text-gray-700';
              if (danhGia === 'OK') danhGiaColor = 'text-green-700 font-semibold';
              else if (danhGia === 'NG') danhGiaColor = 'text-red-700 font-semibold';
              else if (danhGia === 'KDG' || danhGia === 'KKL') danhGiaColor = 'text-orange-700 font-semibold';

              const hangMuc = row['H·∫°ng m·ª•c ki·ªÉm tra (Index)'] || row['H·∫°ng m·ª•c ki·ªÉm tra \n(Index)'] || '';
              const tieuChuan = row['Ti√™u chu·∫©n (Standard)'] || row['Ti√™u chu·∫©n\n(Standard)'] || '';
              const ghiChu = row['Ghi ch√∫'] || '';
              const congChuan = row['C√¥ng chu·∫©n'] || '';

              const tr = document.createElement('tr');
              tr.className = rowBg;
              tr.innerHTML = `
                <td class="px-3 py-2 border border-gray-300">${idx + 1}</td>
                <td class="px-3 py-2 border border-gray-300">${hangMuc}</td>
                <td class="px-3 py-2 border border-gray-300">${tieuChuan}</td>
                <td class="px-3 py-2 border border-gray-300 text-right">${congChuan}</td>
                <td class="px-3 py-2 border border-gray-300 ${danhGiaColor}">${danhGia}</td>
                ${tcktSampleCols.map(col => `<td class="px-2 py-2 border border-gray-300 text-center">${row[col] !== null && row[col] !== undefined ? row[col] : '-'}</td>`).join('')}
                <td class="px-3 py-2 border border-gray-300 text-xs">${ghiChu || '-'}</td>
              `;
              tbody.appendChild(tr);
            });
          }
          
          itemsContainer.appendChild(itemSection);
        }

        // 5. Hi·ªÉn th·ªã B·∫£ng H·∫°ng m·ª•c th√™m (t·ª´ rows array)
        if (itemsContainer && rowsDataArray.length > 0) {
          // L·∫•y danh s√°ch c·ªôt m·∫´u t·ª´ thong_ke_them ho·∫∑c t·ª´ d·ªØ li·ªáu
          const sampleCols = thongKeThem.sample_cols || [];
          let allSampleCols = [...sampleCols];
          
          // N·∫øu kh√¥ng c√≥ trong thong_ke_them, t·ª± ƒë·ªông t√¨m t·ª´ rows
          if (allSampleCols.length === 0) {
            rowsDataArray.forEach(row => {
              Object.keys(row).forEach(key => {
                if (key.match(/^M·∫´u \d+$/) && !allSampleCols.includes(key)) {
                  allSampleCols.push(key);
                }
              });
            });
            allSampleCols.sort();
          }

          // T·∫°o section cho b·∫£ng H·∫°ng m·ª•c th√™m
          const rowsSection = document.createElement('div');
          rowsSection.className = 'mb-6 p-4 bg-white border border-gray-200 rounded-lg shadow-sm';
          rowsSection.innerHTML = `
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-blue-800">üìã B·∫£ng H·∫°ng m·ª•c th√™m</h3>
            </div>
            <div class="overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
              <table class="min-w-full text-sm border-collapse">
                <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                  <tr>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">STT</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">H·∫°ng m·ª•c ki·ªÉm tra</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">Ti√™u chu·∫©n</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">C√¥ng chu·∫©n</th>
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">ƒê√°nh gi√°</th>
                    ${allSampleCols.map(col => `<th class="px-2 py-2 border border-gray-300 text-center font-semibold">${col}</th>`).join('')}
                    <th class="px-3 py-2 border border-gray-300 text-left font-semibold">Ghi ch√∫</th>
                  </tr>
                </thead>
                <tbody id="f11-rows-tbody">
                </tbody>
              </table>
            </div>
          `;

          const tbody = rowsSection.querySelector('#f11-rows-tbody');
          if (tbody) {
            rowsDataArray.forEach((row, rowIndex) => {
              const danhGia = row['ƒê√°nh gi√°'] || '';
              let rowBg = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
              let danhGiaColor = 'text-gray-700';
              if (danhGia === 'OK') danhGiaColor = 'text-green-700 font-semibold';
              else if (danhGia === 'NG') danhGiaColor = 'text-red-700 font-semibold';
              else if (danhGia === 'KDG' || danhGia === 'KKL') danhGiaColor = 'text-orange-700 font-semibold';

              // X·ª≠ l√Ω c√°c key c√≥ th·ªÉ c√≥ \n trong t√™n
              const hangMuc = row['H·∫°ng m·ª•c ki·ªÉm tra (Index)'] || row['H·∫°ng m·ª•c ki·ªÉm tra \n(Index)'] || '';
              const tieuChuan = row['Ti√™u chu·∫©n (Standard)'] || row['Ti√™u chu·∫©n\n(Standard)'] || '';
              const ghiChu = row['Ghi ch√∫'] || '';
              const congChuan = row['C√¥ng chu·∫©n'] || '';

              const tr = document.createElement('tr');
              tr.className = rowBg;
              tr.innerHTML = `
                <td class="px-3 py-2 border border-gray-300">${row.STT || rowIndex + 1}</td>
                <td class="px-3 py-2 border border-gray-300">${hangMuc}</td>
                <td class="px-3 py-2 border border-gray-300">${tieuChuan}</td>
                <td class="px-3 py-2 border border-gray-300 text-right">${congChuan}</td>
                <td class="px-3 py-2 border border-gray-300 ${danhGiaColor}">${danhGia}</td>
                ${allSampleCols.map(col => `<td class="px-2 py-2 border border-gray-300 text-center">${row[col] !== null && row[col] !== undefined ? row[col] : '-'}</td>`).join('')}
                <td class="px-3 py-2 border border-gray-300 text-xs">${ghiChu || '-'}</td>
              `;
              tbody.appendChild(tr);
            });
          }
          
          itemsContainer.appendChild(rowsSection);
        }
      }

      // ===== NAVIGATION AND FORM VISIBILITY CONTROL =====
      // H√†m ·∫©n t·∫•t c·∫£ c√°c form
      function hideAllForms() {
        const forms = document.querySelectorAll('section[id^="form"]');
        forms.forEach(form => {
          form.classList.add('hidden');
        });
      }

      // H√†m hi·ªÉn th·ªã form theo ID
      function showForm(formId) {
        hideAllForms();
        const targetForm = document.getElementById(formId);
        if (targetForm) {
          targetForm.classList.remove('hidden');
          // B·∫≠t t√≠nh nƒÉng collapse sidebar khi ƒë√£ ch·ªçn form
          const sidebarNav = document.getElementById('sidebar-nav');
          if (sidebarNav) {
            sidebarNav.classList.add('collapsible');
          }
        }
      }

      // H√†m ƒë√≥ng t·∫•t c·∫£ c√°c nh√≥m sidebar
      function closeAllSidebarGroups() {
        const groupItems = document.querySelectorAll('.group-items');
        groupItems.forEach(item => {
          item.classList.add('hidden');
        });
      }

      // H√†m m·ªü/ƒë√≥ng nh√≥m sidebar
      function toggleSidebarGroup(button) {
        const groupItems = button.nextElementSibling;
        if (groupItems && groupItems.classList.contains('group-items')) {
          // ƒê√≥ng t·∫•t c·∫£ c√°c nh√≥m kh√°c
          closeAllSidebarGroups();
          // M·ªü/ƒë√≥ng nh√≥m hi·ªán t·∫°i
          groupItems.classList.toggle('hidden');
        }
      }

      // Kh·ªüi t·∫°o navigation khi DOM loaded
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[Navigation] Initializing navigation system...');
        
        // 1. ·∫®n t·∫•t c·∫£ c√°c form tr∆∞·ªõc
        hideAllForms();
        
        // 2. Kh√¥ng hi·ªÉn th·ªã form n√†o m·∫∑c ƒë·ªãnh - ng∆∞·ªùi d√πng ph·∫£i ch·ªçn form ƒë·ªÉ xem
        
        // 3. M·ªû T·∫§T C·∫¢ c√°c nh√≥m sidebar ƒë·ªÉ c√≥ th·ªÉ click tr·ª±c ti·∫øp v√†o form
        const groupItems = document.querySelectorAll('.group-items');
        groupItems.forEach(item => {
          item.classList.remove('hidden');
        });
        
        // 4. X·ª≠ l√Ω click v√†o c√°c n√∫t navigation (data-target)
        const navButtons = document.querySelectorAll('.nav-btn[data-target]');
        navButtons.forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const targetForm = this.getAttribute('data-target');
            console.log('[Navigation] Switching to form:', targetForm);
            
            // Hi·ªÉn th·ªã form ƒë∆∞·ª£c ch·ªçn
            showForm(targetForm);
          });
        });
        
        // 5. V√¥ hi·ªáu h√≥a click v√†o c√°c n√∫t nh√≥m sidebar (group-btn) v√¨ kh√¥ng c·∫ßn thi·∫øt
        const groupButtons = document.querySelectorAll('.group-btn');
        groupButtons.forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            // Kh√¥ng l√†m g√¨ c·∫£ - gi·ªØ nguy√™n tr·∫°ng th√°i m·ªü
          });
        });
        
        console.log('[Navigation] Navigation system initialized successfully');
        console.log('[Navigation] Found', navButtons.length, 'navigation buttons');
        console.log('[Navigation] Found', groupButtons.length, 'sidebar group buttons');
        console.log('[Navigation] All sidebar groups are now OPEN for direct form access');
      });

      // ===== FORM 4: K·∫ø ho·∫°ch c√¥ng vi·ªác (Dashboard Gantt Chart) =====
      (function initForm4() {
        const ZONE = 'Asia/Ho_Chi_Minh';
        const WORKING_BLOCKS = [
          { start: { hour: 8, minute: 0 }, end: { hour: 12, minute: 30 } },
          { start: { hour: 13, minute: 30 }, end: { hour: 17, minute: 0 } },
        ];
        const WORKING_DAYS = [1, 2, 3, 4, 5, 6]; // Monday - Saturday
        const palette = [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1',
        ];
        const { DateTime } = luxon;

        const statusText = document.getElementById('f4-statusText');
        const assigneeFilter = document.getElementById('f4-assigneeFilter');
        const tableBody = document.getElementById('f4-scheduleTable');
        const recordCounter = document.getElementById('f4-recordCounter');
        const legendContainer = document.getElementById('f4-legend');
        const chartWrapper = document.getElementById('f4-chartWrapper');
        const taskList = document.getElementById('f4-taskList');
        const detailSection = document.getElementById('f4-detailSection');
        const closeDetailBtn = document.getElementById('f4-closeDetailBtn');
        const reloadButton = document.getElementById('f4-reloadButton');

        let rawData = [];
        let scheduleRows = [];
        let segments = [];
        let subBars = []; // D·ªØ li·ªáu thanh ph·ª•
        const colorCache = new Map();
        const expandedCategories = new Set();
        
        // URL webhook cho thanh ph·ª• (webhook ri√™ng)
        const SUBBARS_WEBHOOK_URL = 'https://iatzhxxuk.tino.page/webhook/thanhphuform4DB';

        const dateFormatter = new Intl.DateTimeFormat('vi-VN', {
          timeZone: ZONE,
          weekday: 'short',
          day: '2-digit',
          month: '2-digit',
        });
        const timeFormatter = new Intl.DateTimeFormat('vi-VN', {
          timeZone: ZONE,
          hour: '2-digit',
          minute: '2-digit',
        });

        function parseDateInput(value) {
          if (!value) return null;
          if (value instanceof Date) {
            return DateTime.fromJSDate(value, { zone: ZONE });
          }
          if (typeof value === 'string') {
            // Parse format "dd/MM/yyyy HH:mm" (d√πng cho thanh ph·ª•)
            const ddmmyyyyMatch = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
            if (ddmmyyyyMatch) {
              const [, day, month, year, hour, minute] = ddmmyyyyMatch;
              return DateTime.fromObject({
                year: parseInt(year),
                month: parseInt(month),
                day: parseInt(day),
                hour: parseInt(hour),
                minute: parseInt(minute),
              }, { zone: ZONE });
            }
            const normalised = value.includes('T') ? value : value.replace(' ', 'T');
            return DateTime.fromISO(normalised, { zone: ZONE });
          }
          return DateTime.fromISO(String(value), { zone: ZONE });
        }

        function formatDateTime(dt) {
          if (!dt) return '';
          const dateText = dateFormatter.format(dt.toJSDate());
          const timeText = timeFormatter.format(dt.toJSDate());
          return `${dateText} ${timeText}`;
        }

        function getColorForAssignee(name) {
          if (!colorCache.has(name)) {
            colorCache.set(name, palette[colorCache.size % palette.length]);
          }
          return colorCache.get(name);
        }

        function isWorkingDay(dt) {
          return WORKING_DAYS.includes(dt.weekday);
        }

        function startOfBlock(dt, block) {
          return dt.set({
            hour: block.start.hour,
            minute: block.start.minute,
            second: 0,
            millisecond: 0,
          });
        }

        function endOfBlock(dt, block) {
          return dt.set({
            hour: block.end.hour,
            minute: block.end.minute,
            second: 0,
            millisecond: 0,
          });
        }

        function nextWorkingDayStart(dt) {
          let probe = dt.plus({ days: 1 }).startOf('day');
          while (!isWorkingDay(probe)) {
            probe = probe.plus({ days: 1 });
          }
          return startOfBlock(probe, WORKING_BLOCKS[0]);
        }

        function alignToWorkingWindow(dt) {
          let pointer = dt.set({ second: 0, millisecond: 0 });
          while (true) {
            if (!isWorkingDay(pointer)) {
              pointer = nextWorkingDayStart(pointer);
              continue;
            }
            const morningStart = startOfBlock(pointer, WORKING_BLOCKS[0]);
            const morningEnd = endOfBlock(pointer, WORKING_BLOCKS[0]);
            const afternoonStart = startOfBlock(pointer, WORKING_BLOCKS[1]);
            const afternoonEnd = endOfBlock(pointer, WORKING_BLOCKS[1]);

            if (pointer < morningStart) {
              pointer = morningStart;
              continue;
            }
            if (pointer < morningEnd) {
              return pointer;
            }
            if (pointer < afternoonStart) {
              pointer = afternoonStart;
              continue;
            }
            if (pointer < afternoonEnd) {
              return pointer;
            }
            pointer = nextWorkingDayStart(pointer);
          }
        }

        function currentBlockEnd(dt) {
          const morningStart = startOfBlock(dt, WORKING_BLOCKS[0]);
          const morningEnd = endOfBlock(dt, WORKING_BLOCKS[0]);
          const afternoonStart = startOfBlock(dt, WORKING_BLOCKS[1]);
          const afternoonEnd = endOfBlock(dt, WORKING_BLOCKS[1]);

          if (dt >= morningStart && dt < morningEnd) {
            return morningEnd;
          }
          if (dt >= afternoonStart && dt < afternoonEnd) {
            return afternoonEnd;
          }
          return alignToWorkingWindow(dt);
        }

        function calculateEndTime(startTime, points) {
          let currentTime = startTime;
          let remainingHours = points;
          
          const dayStartMinutes = 8 * 60;
          const lunchStartMinutes = 12 * 60 + 30;
          const lunchEndMinutes = 13 * 60 + 30;
          const dayEndMinutes = 17 * 60;
          
          while (remainingHours > 0) {
            const currentHour = currentTime.hour;
            const currentMinute = currentTime.minute;
            const currentTotalMinutes = currentHour * 60 + currentMinute;
            
            let workingStartMinutes, workingEndMinutes;
            
            if (currentTotalMinutes < dayStartMinutes) {
              currentTime = currentTime.set({ hour: 8, minute: 0, second: 0, millisecond: 0 });
              continue;
            } else if (currentTotalMinutes >= dayStartMinutes && currentTotalMinutes < lunchStartMinutes) {
              workingStartMinutes = currentTotalMinutes;
              workingEndMinutes = lunchStartMinutes;
            } else if (currentTotalMinutes >= lunchStartMinutes && currentTotalMinutes < lunchEndMinutes) {
              currentTime = currentTime.set({ hour: 13, minute: 30, second: 0, millisecond: 0 });
              continue;
            } else if (currentTotalMinutes >= lunchEndMinutes && currentTotalMinutes < dayEndMinutes) {
              workingStartMinutes = currentTotalMinutes;
              workingEndMinutes = dayEndMinutes;
            } else {
              currentTime = currentTime.plus({ days: 1 }).set({ hour: 8, minute: 0, second: 0, millisecond: 0 });
              continue;
            }
            
            const availableMinutes = workingEndMinutes - workingStartMinutes;
            const availableHours = availableMinutes / 60;
            
            if (remainingHours <= availableHours) {
              const minutesToAdd = remainingHours * 60;
              currentTime = currentTime.plus({ minutes: minutesToAdd });
              remainingHours = 0;
            } else {
              remainingHours -= availableHours;
              currentTime = currentTime.plus({ days: 1 }).set({ hour: 8, minute: 0, second: 0, millisecond: 0 });
            }
          }
          
          return currentTime;
        }

        function createSimpleSchedule(data) {
          const rows = [];
          const segments = [];
          
          const tasksByAssignee = {};
          data.forEach((task, index) => {
            const startTime = parseDateInput(task.start_time);
            if (!startTime || !startTime.isValid) return;
            
            const points = Number(task.points) || 0;
            if (!points) return;
            
            // Parse end_time n·∫øu c√≥
            let providedEndTime = null;
            if (task.end_time) {
              providedEndTime = parseDateInput(task.end_time);
              if (!providedEndTime || !providedEndTime.isValid) {
                providedEndTime = null;
              }
            }
            
            if (!tasksByAssignee[task.assignee]) {
              tasksByAssignee[task.assignee] = [];
            }
            
            tasksByAssignee[task.assignee].push({
              originalIndex: index,
              assignee: task.assignee,
              originalStartTime: startTime,
              providedEndTime: providedEndTime,
              points: points,
              task_code: task.task_code || '',
              task_name: task.task_name || '',
            });
          });
          
          Object.keys(tasksByAssignee).forEach(assignee => {
            tasksByAssignee[assignee].sort((a, b) => 
              a.originalStartTime.toMillis() - b.originalStartTime.toMillis()
            );
          });
          
          Object.keys(tasksByAssignee).forEach(assignee => {
            const assigneeTasks = tasksByAssignee[assignee];
            let currentEndTime = null;
            
            assigneeTasks.forEach((task, index) => {
              // Task ƒë·∫ßu ti√™n: d√πng originalStartTime
              // Task ti·∫øp theo: LU√îN b·∫Øt ƒë·∫ßu ngay sau khi task tr∆∞·ªõc k·∫øt th√∫c (kh√¥ng c√≥ kho·∫£ng c√°ch)
              let actualStartTime = currentEndTime || task.originalStartTime;
              
              // ƒê·∫£m b·∫£o task ti·∫øp theo lu√¥n n·ªëi ti·∫øp v·ªõi task tr∆∞·ªõc
              if (currentEndTime) {
                actualStartTime = currentEndTime;
              }
              
              // ∆Øu ti√™n s·ª≠ d·ª•ng end_time t·ª´ JSON n·∫øu c√≥ v√† task kh√¥ng b·ªã ƒëi·ªÅu ch·ªânh b·ªüi task tr∆∞·ªõc
              let endTime;
              const isUsingOriginalStart = actualStartTime.equals(task.originalStartTime);
              if (task.providedEndTime && isUsingOriginalStart) {
                // Ch·ªâ s·ª≠ d·ª•ng end_time t·ª´ JSON n·∫øu task kh√¥ng b·ªã ƒëi·ªÅu ch·ªânh b·ªüi task tr∆∞·ªõc
                // ƒê·∫£m b·∫£o end_time kh√¥ng nh·ªè h∆°n start_time
                endTime = task.providedEndTime > actualStartTime ? task.providedEndTime : calculateEndTime(actualStartTime, task.points);
              } else {
                // T√≠nh end time d·ª±a tr√™n gi·ªù l√†m vi·ªác
                endTime = calculateEndTime(actualStartTime, task.points);
              }
              
              rows.push({
                order: task.originalIndex + 1,
                assignee: task.assignee,
                start: actualStartTime,
                end: endTime,
                points: task.points,
                originalStart: task.originalStartTime,
                task_code: task.task_code || '',
                task_name: task.task_name || '',
              });
              
              segments.push({
                assignee: task.assignee,
                start: actualStartTime,
                end: endTime,
                points: task.points,
                order: task.originalIndex + 1,
                originalStart: task.originalStartTime,
                task_code: task.task_code || '',
                task_name: task.task_name || '',
              });
              
              // C·∫≠p nh·∫≠t currentEndTime cho task ti·∫øp theo
              currentEndTime = endTime;
            });
          });
          
          rows.sort((a, b) => a.order - b.order);
          segments.sort((a, b) => a.order - b.order);
          
          return { rows, segments };
        }

        function getDateRange(segments) {
          if (segments.length === 0) return [];
          
          const dates = segments.map(seg => seg.start.startOf('day').toMillis());
          const minDate = Math.min(...dates);
          const maxDate = Math.max(...dates);
          
          const dateRange = [];
          let current = DateTime.fromMillis(minDate, { zone: ZONE }).startOf('day');
          const end = DateTime.fromMillis(maxDate, { zone: ZONE }).startOf('day');
          
          while (current <= end) {
            const weekdays = ['CN', 'Th 2', 'Th 3', 'Th 4', 'Th 5', 'Th 6', 'Th 7'];
            const weekdayIndex = current.weekday === 7 ? 0 : current.weekday;
            const weekday = weekdays[weekdayIndex];
            
            dateRange.push({
              date: current.toFormat('dd/MM'),
              weekday: weekday,
              fullDate: `${weekday}, ${current.toFormat('dd/MM')}`,
              dateObj: current,
            });
            
            current = current.plus({ days: 1 });
          }
          
          return dateRange;
        }

        function getCurrentTimePosition(dateRange) {
          const now = DateTime.now().setZone(ZONE);
          const startDateObj = dateRange[0].dateObj;
          const endDateObj = dateRange[dateRange.length - 1].dateObj;
          
          // N·∫øu th·ªùi ƒëi·ªÉm hi·ªán t·∫°i n·∫±m ngo√†i ph·∫°m vi dateRange, kh√¥ng hi·ªÉn th·ªã
          if (now < startDateObj.startOf('day') || now > endDateObj.endOf('day')) {
            return null;
          }
          
          const currentDate = now.startOf('day');
          const dayIndex = Math.floor(currentDate.diff(startDateObj, 'days').days);
          
          const currentHour = now.hour;
          const currentMin = now.minute;
          const currentMinutes = currentHour * 60 + currentMin;
          
          const dayStartMinutes = 8 * 60;
          const dayEndMinutes = 17 * 60;
          const lunchStartMinutes = 12 * 60 + 30;
          const lunchEndMinutes = 13 * 60 + 30;
          
          const morningMinutes = lunchStartMinutes - dayStartMinutes; // 270 ph√∫t
          const afternoonMinutes = dayEndMinutes - lunchEndMinutes; // 210 ph√∫t
          const totalWorkingMinutes = morningMinutes + afternoonMinutes; // 480 ph√∫t = 8 gi·ªù
          
          const dayWidth = 100 / dateRange.length;
          
          // T√≠nh offset trong ng√†y hi·ªán t·∫°i
          let normalizedCurrent = Math.max(dayStartMinutes, Math.min(dayEndMinutes, currentMinutes));
          if (normalizedCurrent >= lunchStartMinutes && normalizedCurrent < lunchEndMinutes) {
            normalizedCurrent = lunchEndMinutes;
          }
          
          let currentOffset = 0;
          if (normalizedCurrent < lunchStartMinutes) {
            currentOffset = normalizedCurrent - dayStartMinutes;
          } else {
            currentOffset = morningMinutes + (normalizedCurrent - lunchEndMinutes);
          }
          
          // T√≠nh left position
          const left = dayIndex * dayWidth + (currentOffset / totalWorkingMinutes) * dayWidth;
          
          return { left: Math.max(0, Math.min(100, left)) };
        }

        function getTaskPosition(segment, dateRange) {
          const startDate = segment.start.startOf('day');
          const endDate = segment.end.startOf('day');
          const startDateObj = dateRange[0].dateObj;
          
          const startDayIndex = Math.floor(startDate.diff(startDateObj, 'days').days);
          const endDayIndex = Math.floor(endDate.diff(startDateObj, 'days').days);
          
          const startHour = segment.start.hour;
          const startMin = segment.start.minute;
          const endHour = segment.end.hour;
          const endMin = segment.end.minute;
          
          const startMinutes = startHour * 60 + startMin;
          const endMinutes = endHour * 60 + endMin;
          
          const dayStartMinutes = 8 * 60;
          const dayEndMinutes = 17 * 60;
          const lunchStartMinutes = 12 * 60 + 30;
          const lunchEndMinutes = 13 * 60 + 30;
          
          const morningMinutes = lunchStartMinutes - dayStartMinutes; // 270 ph√∫t
          const afternoonMinutes = dayEndMinutes - lunchEndMinutes; // 210 ph√∫t
          const totalWorkingMinutes = morningMinutes + afternoonMinutes; // 480 ph√∫t = 8 gi·ªù
          
          const dayWidth = 100 / dateRange.length;
          
          // T√≠nh offset trong ng√†y ƒë·∫ßu ti√™n
          let normalizedStart = Math.max(dayStartMinutes, Math.min(dayEndMinutes, startMinutes));
          if (normalizedStart >= lunchStartMinutes && normalizedStart < lunchEndMinutes) {
            normalizedStart = lunchEndMinutes;
          }
          
          let startOffset = 0;
          if (normalizedStart < lunchStartMinutes) {
            startOffset = normalizedStart - dayStartMinutes;
          } else {
            startOffset = morningMinutes + (normalizedStart - lunchEndMinutes);
          }
          
          // T√≠nh offset trong ng√†y cu·ªëi c√πng
          let normalizedEnd = Math.max(dayStartMinutes, Math.min(dayEndMinutes, endMinutes));
          if (normalizedEnd > lunchStartMinutes && normalizedEnd <= lunchEndMinutes) {
            normalizedEnd = lunchStartMinutes;
          }
          
          let endOffset = 0;
          if (normalizedEnd <= lunchStartMinutes) {
            endOffset = normalizedEnd - dayStartMinutes;
          } else {
            endOffset = morningMinutes + (normalizedEnd - lunchEndMinutes);
          }
          
          // T√≠nh left position
          const left = startDayIndex * dayWidth + (startOffset / totalWorkingMinutes) * dayWidth;
          
          // T√≠nh right position (v·ªã tr√≠ k·∫øt th√∫c)
          const right = endDayIndex * dayWidth + (endOffset / totalWorkingMinutes) * dayWidth;
          
          // Width = kho·∫£ng c√°ch t·ª´ left ƒë·∫øn right
          const width = right - left;
          
          // ƒê·∫£m b·∫£o width kh√¥ng nh·ªè h∆°n minimum ƒë·ªÉ hi·ªÉn th·ªã r√µ r√†ng
          const minWidth = 0.5;
          
          return { left: Math.max(0, left), width: Math.max(minWidth, width) };
        }

        function renderTaskList(rows, filterValue) {
          const filtered = filterValue === 'all' ? rows : rows.filter((row) => row.assignee === filterValue);
          
          const tasksByAssignee = {};
          filtered.forEach((row, index) => {
            if (!tasksByAssignee[row.assignee]) {
              tasksByAssignee[row.assignee] = [];
            }
            const taskId = `f4-task-${row.assignee}-${row.start.toMillis()}-${row.end.toMillis()}-${index}`;
            tasksByAssignee[row.assignee].push({
              ...row,
              taskId: taskId,
            });
          });

          taskList.innerHTML = '';

          Object.keys(tasksByAssignee).forEach((assignee) => {
            const tasks = tasksByAssignee[assignee];
            const isExpanded = expandedCategories.has(assignee);
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-1';
            
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between px-3 py-2 bg-gray-50 hover:bg-gray-100 cursor-pointer rounded transition';
            header.onclick = () => {
              if (expandedCategories.has(assignee)) {
                expandedCategories.delete(assignee);
              } else {
                expandedCategories.add(assignee);
              }
              renderTaskList(scheduleRows, filterValue);
            };
            
            const color = getColorForAssignee(assignee);
            header.innerHTML = `
              <div class="flex items-center gap-2 flex-1">
                <svg class="w-4 h-4 text-gray-500 transition-transform ${isExpanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span class="h-3 w-3 rounded-full" style="background-color: ${color}"></span>
                <span class="text-sm font-semibold text-gray-700">${assignee}</span>
                <span class="text-xs text-gray-500">(${tasks.length})</span>
              </div>
            `;
            
            categoryDiv.appendChild(header);
            
            if (isExpanded) {
              const tasksContainer = document.createElement('div');
              tasksContainer.className = 'bg-white';
              tasks.forEach((task) => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item px-6 py-2 border-b border-gray-100 hover:bg-blue-50 transition text-sm cursor-pointer';
                taskItem.setAttribute('data-task-id', task.taskId);
                
                taskItem.innerHTML = `
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">${task.task_name || task.task_code || `Task #${task.order}`}</div>
                      <div class="text-xs text-gray-500 mt-1">
                        ${formatDateTime(task.start)} ‚Üí ${formatDateTime(task.end)}
                      </div>
                    </div>
                    <div class="text-xs font-semibold text-gray-600 ml-4">
                      ${task.points.toFixed(1)}h
                    </div>
                  </div>
                `;
                tasksContainer.appendChild(taskItem);
              });
              categoryDiv.appendChild(tasksContainer);
            }
            
            taskList.appendChild(categoryDiv);
          });

          recordCounter.textContent = `${filtered.length} t√°c v·ª•`;
        }

        function updateChart(allSegments, filterValue) {
          console.log('[Form4] updateChart ƒë∆∞·ª£c g·ªçi, s·ªë thanh ph·ª•:', subBars.length, subBars);
          const filtered = filterValue === 'all' ? allSegments : allSegments.filter((segment) => segment.assignee === filterValue);

          const uniqueAssignees = Array.from(new Set(filtered.map((segment) => segment.assignee)));
          
          if (legendContainer) {
            legendContainer.innerHTML = '';
            uniqueAssignees.forEach((assignee) => {
              const legendItem = document.createElement('span');
              legendItem.className = 'flex items-center gap-2 rounded-lg bg-white border border-brand-200 px-3 py-1.5 text-xs font-semibold text-brand-700 shadow-sm hover:shadow-md transition-shadow';
              legendItem.innerHTML = `
                <span class="h-3 w-3 rounded-full shadow-sm" style="background-color: ${getColorForAssignee(assignee)}"></span>
                <span>${assignee}</span>
              `;
              legendContainer.appendChild(legendItem);
            });
          }

          if (!filtered.length) {
            chartWrapper.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-sm font-medium text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu cho b·ªô l·ªçc hi·ªán t·∫°i.</p></div>';
            return;
          }

          const dateRange = getDateRange(filtered);
          const height = Math.max(400, uniqueAssignees.length * 80 + 120);
          chartWrapper.style.height = `${height}px`;
          
          // T√≠nh v·ªã tr√≠ th·ªùi ƒëi·ªÉm hi·ªán t·∫°i
          const currentTimePos = getCurrentTimePosition(dateRange);
          const now = DateTime.now().setZone(ZONE);
          const currentTimeLabel = now.toFormat('HH:mm');
          
          const colors = [
            'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(245, 158, 11, 0.8)',
            'rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(6, 182, 212, 0.8)', 'rgba(132, 204, 22, 0.8)',
          ];
          
          let html = `
            <div class="w-full h-full">
              <div class="flex border-b-2 border-gray-300 mb-5 pb-3 sticky top-0 bg-white z-10 relative">
                <div class="w-48 flex-shrink-0 pr-5">
                  <h3 class="text-lg font-semibold text-gray-800">Nh√¢n vi√™n</h3>
                </div>
                <div class="flex-1 flex min-w-[${dateRange.length * 120}px] relative">
                  ${dateRange.map(dateInfo => `
                    <div class="flex-1 text-center border-l border-gray-200 px-1">
                      <div class="text-sm font-semibold text-gray-800">${dateInfo.weekday}</div>
                      <div class="text-xs text-gray-500">${dateInfo.date}</div>
                    </div>
                  `).join('')}
                  ${currentTimePos ? `
                    <div 
                      class="current-time-indicator-header absolute top-0 bottom-0 z-30 pointer-events-none"
                      style="left: ${currentTimePos.left}%; width: 2px; background-color: #ef4444; box-shadow: 0 0 4px rgba(239, 68, 68, 0.6);"
                    >
                      <div 
                        class="absolute top-full left-1/2 -translate-x-1/2 mt-1 px-1.5 py-0.5 bg-red-500 text-white text-xs font-semibold rounded shadow-lg whitespace-nowrap"
                      >
                        ${currentTimeLabel}
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>

              <div>
                ${uniqueAssignees.map((assignee, assigneeIndex) => {
                  const assigneeSegments = filtered.filter(seg => seg.assignee === assignee);
                  const assigneeColor = colors[assigneeIndex % colors.length];
                  const totalHours = assigneeSegments.reduce((sum, seg) => sum + seg.points, 0);
                  
                  return `
                    <div class="flex items-center mb-4 min-h-[80px] border-b border-gray-100 pb-4">
                      <div class="w-48 flex-shrink-0 pr-5">
                        <div class="text-base font-semibold text-gray-800 mb-1">${assignee}</div>
                        <div class="text-xs text-gray-500">${assigneeSegments.length} t√°c v·ª• ‚Ä¢ ${totalHours.toFixed(1)}h</div>
                      </div>
                      
                      ${(() => {
                        // T√≠nh s·ªë l·ªõp t·ªëi ƒëa c·ªßa thanh ph·ª• cho assignee n√†y
                        const assigneeSubBars = assigneeSegments
                          .map(seg => subBars.find(sb => sb.task_code === seg.task_code))
                          .filter(sb => sb && sb.form_start && sb.form_end);
                        
                        const subBarLayers = new Map();
                        const subBarPositions = new Map();
                        
                        assigneeSubBars.forEach((matchingSubBar, idx) => {
                          const segment = assigneeSegments.find(seg => seg.task_code === matchingSubBar.task_code);
                          if (segment) {
                            const subBarSegment = {
                              start: matchingSubBar.form_start,
                              end: matchingSubBar.form_end,
                            };
                            const subBarPos = getTaskPosition(subBarSegment, dateRange);
                            subBarPositions.set(segment.task_code, {
                              left: subBarPos.left,
                              width: subBarPos.width,
                              start: matchingSubBar.form_start,
                              end: matchingSubBar.form_end
                            });
                          }
                        });
                        
                        const doOverlap = (bar1, bar2) => {
                          if (!bar1.start || !bar1.end || !bar2.start || !bar2.end) return false;
                          return bar1.start < bar2.end && bar1.end > bar2.start;
                        };
                        
                        // S·∫Øp x·∫øp c√°c thanh ph·ª• theo th·ªùi gian b·∫Øt ƒë·∫ßu ƒë·ªÉ g√°n l·ªõp ch√≠nh x√°c
                        const sortedSubBars = Array.from(subBarPositions.entries())
                          .map(([taskCode, pos]) => ({ taskCode, ...pos }))
                          .sort((a, b) => {
                            if (!a.start || !b.start) return 0;
                            return a.start.toMillis() - b.start.toMillis();
                          });
                        
                        // G√°n l·ªõp cho t·ª´ng thanh ph·ª• b·∫±ng thu·∫≠t to√°n greedy - t√¨m l·ªõp nh·ªè nh·∫•t kh√¥ng overlap
                        sortedSubBars.forEach((bar1) => {
                          let layer = 0;
                          let foundLayer = false;
                          
                          // T√¨m l·ªõp nh·ªè nh·∫•t m√† thanh ph·ª• n√†y c√≥ th·ªÉ ƒë·∫∑t v√†o m√† kh√¥ng overlap v·ªõi c√°c thanh ph·ª• kh√°c trong l·ªõp ƒë√≥
                          while (!foundLayer) {
                            foundLayer = true;
                            // Ki·ªÉm tra v·ªõi t·∫•t c·∫£ c√°c thanh ph·ª• ƒë√£ ƒë∆∞·ª£c g√°n l·ªõp hi·ªán t·∫°i
                            subBarLayers.forEach((existingLayer, taskCode2) => {
                              if (existingLayer === layer) {
                                const bar2 = subBarPositions.get(taskCode2);
                                if (bar2 && doOverlap(bar1, bar2)) {
                                  // N·∫øu overlap v·ªõi thanh ph·ª• trong l·ªõp n√†y, kh√¥ng th·ªÉ ƒë·∫∑t v√†o l·ªõp n√†y
                                  foundLayer = false;
                                }
                              }
                            });
                            
                            if (!foundLayer) {
                              layer++; // Th·ª≠ l·ªõp ti·∫øp theo
                            }
                          }
                          
                          subBarLayers.set(bar1.taskCode, layer);
                        });
                        
                        const maxLayer = subBarLayers.size > 0 ? Math.max(...Array.from(subBarLayers.values())) : -1;
                        const containerHeight = Math.max(80, 40 + (maxLayer + 1) * 28 + 8);
                        return `<div class="flex-1 relative bg-gray-50 rounded-md min-w-[${dateRange.length * 120}px]" style="position: relative; min-height: ${containerHeight}px;">`;
                      })()}
                        ${dateRange.map((_, index) => `
                          <div class="absolute left-[${(index / dateRange.length) * 100}%] top-0 bottom-0 border-l border-gray-200 opacity-50"></div>
                        `).join('')}
                        
                        ${dateRange.map((_, index) => {
                          const morningMinutes = 4.5 * 60;
                          const totalWorkingMinutes = 8 * 60;
                          const lunchStartPercent = (morningMinutes / totalWorkingMinutes) * 100;
                          const lunchWidthPercent = (60 / totalWorkingMinutes) * 100;
                          const dayWidthPercent = 100 / dateRange.length;
                          const dayLeft = index * dayWidthPercent;
                          const lunchLeftInDay = lunchStartPercent * dayWidthPercent / 100;
                          const lunchLeft = dayLeft + lunchLeftInDay;
                          const lunchWidth = lunchWidthPercent * dayWidthPercent / 100;
                          
                          return `
                            <div 
                              class="absolute top-0 bottom-0 bg-gray-200 opacity-60 border-l border-r border-gray-300"
                              style="left: ${lunchLeft}%; width: ${lunchWidth}%;"
                              title="Ngh·ªâ tr∆∞a 12:30 - 13:30"
                            ></div>
                          `;
                        }).join('')}
                        
                        ${(() => {
                          // T√≠nh to√°n l·ªõp (layer) cho c√°c thanh ph·ª• ƒë·ªÉ tr√°nh ch·ªìng l√™n nhau
                          // S·ª≠ d·ª•ng index l√†m key ƒë·ªÉ h·ªó tr·ª£ nhi·ªÅu thanh ph·ª• c√πng task_code
                          const subBarLayers = new Map(); // Map<index, layer>
                          const subBarList = []; // Array<{taskCode, left, width, start, end, index}>
                          
                          // Thu th·∫≠p t·∫•t c·∫£ c√°c thanh ph·ª• cho assignee n√†y (c√≥ th·ªÉ c√≥ nhi·ªÅu thanh ph·ª• c√πng task_code)
                          let subBarIndex = 0;
                          assigneeSegments.forEach((segment) => {
                            const matchingSubBars = subBars.filter((subBar) => subBar.task_code === segment.task_code);
                            matchingSubBars.forEach((matchingSubBar) => {
                              if (matchingSubBar && matchingSubBar.form_start && matchingSubBar.form_end) {
                                const subBarSegment = {
                                  start: matchingSubBar.form_start,
                                  end: matchingSubBar.form_end,
                                };
                                const subBarPos = getTaskPosition(subBarSegment, dateRange);
                                subBarList.push({
                                  taskCode: segment.task_code,
                                  index: subBarIndex++,
                                  left: subBarPos.left,
                                  width: subBarPos.width,
                                  start: matchingSubBar.form_start,
                                  end: matchingSubBar.form_end,
                                  matchingSubBar: matchingSubBar
                                });
                              }
                            });
                          });
                          
                          // H√†m ki·ªÉm tra overlap gi·ªØa hai thanh ph·ª• d·ª±a tr√™n th·ªùi gian
                          const doOverlap = (bar1, bar2) => {
                            // Ki·ªÉm tra overlap d·ª±a tr√™n th·ªùi gian th·ª±c t·∫ø
                            if (!bar1.start || !bar1.end || !bar2.start || !bar2.end) return false;
                            // Overlap n·∫øu: bar1.start < bar2.end && bar1.end > bar2.start
                            return bar1.start < bar2.end && bar1.end > bar2.start;
                          };
                          
                          // S·∫Øp x·∫øp c√°c thanh ph·ª• theo th·ªùi gian b·∫Øt ƒë·∫ßu ƒë·ªÉ g√°n l·ªõp ch√≠nh x√°c
                          const sortedSubBars = subBarList.slice().sort((a, b) => {
                            if (!a.start || !b.start) return 0;
                            return a.start.toMillis() - b.start.toMillis();
                          });
                          
                          // G√°n l·ªõp cho t·ª´ng thanh ph·ª• b·∫±ng thu·∫≠t to√°n greedy - t√¨m l·ªõp nh·ªè nh·∫•t kh√¥ng overlap
                          sortedSubBars.forEach((bar1) => {
                            let layer = 0;
                            let foundLayer = false;
                            
                            // T√¨m l·ªõp nh·ªè nh·∫•t m√† thanh ph·ª• n√†y c√≥ th·ªÉ ƒë·∫∑t v√†o m√† kh√¥ng overlap v·ªõi c√°c thanh ph·ª• kh√°c trong l·ªõp ƒë√≥
                            while (!foundLayer) {
                              foundLayer = true;
                              // Ki·ªÉm tra v·ªõi t·∫•t c·∫£ c√°c thanh ph·ª• ƒë√£ ƒë∆∞·ª£c g√°n l·ªõp hi·ªán t·∫°i
                              subBarLayers.forEach((existingLayer, index2) => {
                                if (existingLayer === layer) {
                                  const bar2 = subBarList.find(b => b.index === index2);
                                  if (bar2 && doOverlap(bar1, bar2)) {
                                    // N·∫øu overlap v·ªõi thanh ph·ª• trong l·ªõp n√†y, kh√¥ng th·ªÉ ƒë·∫∑t v√†o l·ªõp n√†y
                                    foundLayer = false;
                                  }
                                }
                              });
                              
                              if (!foundLayer) {
                                layer++; // Th·ª≠ l·ªõp ti·∫øp theo
                              }
                            }
                            
                            subBarLayers.set(bar1.index, layer);
                          });
                          
                          // T√≠nh s·ªë l·ªõp t·ªëi ƒëa ƒë·ªÉ ƒëi·ªÅu ch·ªânh chi·ªÅu cao container
                          const maxLayer = subBarLayers.size > 0 ? Math.max(...Array.from(subBarLayers.values())) : -1;
                          const containerHeight = Math.max(80, 40 + (maxLayer + 1) * 28 + 8); // T·ªëi thi·ªÉu 80px, m·ªói l·ªõp th√™m 28px
                          
                          return assigneeSegments.map((segment, taskIndex) => {
                            const pos = getTaskPosition(segment, dateRange);
                            const taskColor = assigneeColor;
                            const taskId = `f4-task-${segment.order}`;
                            
                            const startTime = segment.start.toFormat('HH:mm');
                            const endTime = segment.end.toFormat('HH:mm');
                            const duration = segment.points.toFixed(1);
                            const displayName = segment.task_name || segment.task_code || `Task #${segment.order}`;
                            
                            // T√¨m t·∫•t c·∫£ thanh ph·ª• t∆∞∆°ng ·ª©ng v·ªõi task_code v√† render ch√∫ng
                            const matchingSubBars = subBarList.filter((sb) => sb.taskCode === segment.task_code);
                            
                            let subBarHtml = '';
                            matchingSubBars.forEach((subBarData) => {
                              const matchingSubBar = subBarData.matchingSubBar;
                              if (matchingSubBar && matchingSubBar.form_start && matchingSubBar.form_end) {
                                // T√≠nh v·ªã tr√≠ thanh ph·ª•
                                const subBarSegment = {
                                  start: matchingSubBar.form_start,
                                  end: matchingSubBar.form_end,
                                };
                                const subBarPos = getTaskPosition(subBarSegment, dateRange);
                                const subBarStartTime = matchingSubBar.form_start.toFormat('HH:mm');
                                const subBarEndTime = matchingSubBar.form_end.toFormat('HH:mm');
                                const subBarStartDate = formatDateTime(matchingSubBar.form_start);
                                const subBarEndDate = formatDateTime(matchingSubBar.form_end);
                                const subBarDuration = matchingSubBar.form_end.diff(matchingSubBar.form_start, 'hours').hours.toFixed(1);
                                
                                // L·∫•y l·ªõp (layer) cho thanh ph·ª• n√†y d·ª±a tr√™n index
                                const layer = subBarLayers.get(subBarData.index) || 0;
                                const subBarTop = 40 + (layer * 28); // M·ªói l·ªõp c√°ch nhau 28px
                              
                              // Hi·ªÉn th·ªã task_name, fallback v·ªÅ task_code n·∫øu kh√¥ng c√≥
                              // ∆Øu ti√™n task_name n·∫øu c√≥ v√† kh√¥ng r·ªóng
                              let displayName = '';
                              if (matchingSubBar.task_name && String(matchingSubBar.task_name).trim() !== '') {
                                displayName = String(matchingSubBar.task_name).trim();
                              } else {
                                displayName = matchingSubBar.task_code || segment.task_code;
                              }
                              
                              // Escape HTML ƒë·ªÉ tr√°nh XSS v√† ƒë·∫£m b·∫£o hi·ªÉn th·ªã ƒë√∫ng
                              const escapeHtml = (text) => {
                                if (!text) return '';
                                const div = document.createElement('div');
                                div.textContent = text;
                                return div.innerHTML;
                              };
                              
                              // M√†u thanh ph·ª• (x√°m nh·∫°t v·ªõi border ƒë·ª©t n√©t)
                              const subBarColor = 'rgba(107, 114, 128, 0.6)'; // gray-500 v·ªõi opacity
                              
                              // Tooltip hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß task_name, form_start v√† form_end khi hover
                              let tooltipParts = [];
                              // Th√™m task_name n·∫øu c√≥
                              if (matchingSubBar.task_name && String(matchingSubBar.task_name).trim() !== '') {
                                tooltipParts.push(`Task: ${matchingSubBar.task_name}`);
                              } else {
                                tooltipParts.push(`Task code: ${matchingSubBar.task_code || segment.task_code}`);
                              }
                              // Th√™m form_start v√† form_end
                              tooltipParts.push(`Form start: ${subBarStartDate}`);
                              tooltipParts.push(`Form end: ${subBarEndDate}`);
                              
                                const tooltipText = tooltipParts.join('\n');
                                
                                subBarHtml += `
                                  <div 
                                    id="f4-subbar-${segment.task_code}-${subBarData.index}"
                                    class="timeline-subbar absolute cursor-pointer rounded flex items-center px-2 text-gray-700 text-xs font-medium overflow-hidden shadow-sm transition-all duration-200 hover:shadow-md hover:-translate-y-0.5 border-2 border-dashed"
                                    style="left: ${subBarPos.left}%; width: ${subBarPos.width}%; top: ${subBarTop}px; height: 24px; background-color: ${subBarColor}; border-color: rgba(107, 114, 128, 0.8);"
                                    title="${escapeHtml(tooltipText)}"
                                  >
                                    <span class="whitespace-nowrap overflow-hidden text-ellipsis text-gray-800">${escapeHtml(displayName)}</span>
                                  </div>
                                `;
                              }
                            });
                            
                            return `
                              <div 
                                id="${taskId}"
                                class="timeline-bar absolute cursor-pointer rounded flex items-center px-2 text-white text-xs font-semibold overflow-hidden shadow-sm transition-all duration-200 hover:shadow-md hover:-translate-y-0.5"
                                style="left: ${pos.left}%; width: ${pos.width}%; top: 4px; height: 32px; background-color: ${taskColor}; border: 2px solid ${taskColor};"
                                data-task-index="${taskIndex}"
                                data-segment-order="${segment.order}"
                                title="${displayName} - ${startTime} ‚Üí ${endTime} (${duration}h)"
                              >
                                <span class="whitespace-nowrap overflow-hidden text-ellipsis">${displayName}</span>
                              </div>
                              ${subBarHtml}
                            `;
                          }).join('');
                        })()}
                        
                        ${currentTimePos ? `
                          <div 
                            class="current-time-indicator absolute top-0 bottom-0 z-20 pointer-events-none"
                            style="left: ${currentTimePos.left}%; width: 2px; background-color: #ef4444; box-shadow: 0 0 4px rgba(239, 68, 68, 0.6);"
                            title="Th·ªùi ƒëi·ªÉm hi·ªán t·∫°i: ${currentTimeLabel}"
                          ></div>
                        ` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>

              <div class="flex mt-5 pt-3 border-t border-gray-200">
                <div class="w-48 flex-shrink-0 pr-5">
                  <div class="text-xs text-gray-500">Thang th·ªùi gian</div>
                </div>
                <div class="flex-1 flex min-w-[${dateRange.length * 120}px]">
                  ${dateRange.map(() => {
                    const morningMinutes = 4.5 * 60;
                    const totalWorkingMinutes = 8 * 60;
                    const lunchStartPercent = (morningMinutes / totalWorkingMinutes) * 100;
                    
                    return `
                      <div class="flex-1 relative border-l border-gray-200 px-1 text-xs text-gray-500">
                        <span class="absolute left-0">8h</span>
                        <span class="absolute left-[${lunchStartPercent}%] -translate-x-1/2">12h30</span>
                        <span class="absolute left-[${lunchStartPercent}%] -translate-x-1/2" style="top: 16px;">13h30</span>
                        <span class="absolute right-0">17h</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          `;
          
          chartWrapper.innerHTML = html;
        }

        function renderTable(rows, filterValue) {
          const filtered = filterValue === 'all' ? rows : rows.filter((row) => row.assignee === filterValue);
          tableBody.innerHTML = '';
          filtered.forEach((row) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-brand-50/60 transition';
            tr.innerHTML = `
              <td class="px-4 py-3 font-semibold text-brand-600">${row.order}</td>
              <td class="px-4 py-3">${row.assignee}</td>
              <td class="px-4 py-3">${formatDateTime(row.start)}</td>
              <td class="px-4 py-3">${formatDateTime(row.end)}</td>
              <td class="px-4 py-3 text-right font-semibold text-slate-700">${row.points.toFixed(2)}h</td>
            `;
            tableBody.appendChild(tr);
          });
        }

        function populateFilterOptions(rows) {
          const names = Array.from(new Set(rows.map((row) => row.assignee)));
          assigneeFilter.innerHTML = '<option value="all">T·∫•t c·∫£ nh√¢n s·ª±</option>';
          names.forEach((name) => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            assigneeFilter.appendChild(option);
            expandedCategories.add(name);
          });
        }

        function refreshView() {
          const filterValue = assigneeFilter.value || 'all';
          renderTaskList(scheduleRows, filterValue);
          renderTable(scheduleRows, filterValue);
          updateChart(segments, filterValue);
        }

        async function loadSubBars() {
          try {
            // Load d·ªØ li·ªáu thanh ph·ª• t·ª´ webhook ri√™ng (JSON ƒë·ªôc l·∫≠p)
            // Webhook tr·∫£ v·ªÅ m·∫£ng c√°c object: [{task_code, form_start, form_end}, ...]
            console.log('[Form4] ƒêang load thanh ph·ª• t·ª´:', SUBBARS_WEBHOOK_URL);
            const response = await fetch(SUBBARS_WEBHOOK_URL);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const apiData = await response.json();
            console.log('[Form4] D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c t·ª´ webhook thanh ph·ª•:', apiData);
            
            // X·ª≠ l√Ω nhi·ªÅu tr∆∞·ªùng h·ª£p: m·∫£ng tr·ª±c ti·∫øp, object c√≥ key, ho·∫∑c object ƒë∆°n l·∫ª
            let dataArray = [];
            if (Array.isArray(apiData)) {
              dataArray = apiData;
            } else if (apiData && typeof apiData === 'object') {
              // N·∫øu l√† object, ki·ªÉm tra c√°c key ph·ªï bi·∫øn
              if (apiData.data && Array.isArray(apiData.data)) {
                dataArray = apiData.data;
              } else if (apiData.subBars && Array.isArray(apiData.subBars)) {
                dataArray = apiData.subBars;
              } else if (apiData.items && Array.isArray(apiData.items)) {
                dataArray = apiData.items;
              } else if (apiData.task_code) {
                // Object ƒë∆°n l·∫ª
                dataArray = [apiData];
              }
            }
            
            // Ki·ªÉm tra n·∫øu l√† d·ªØ li·ªáu thanh ph·ª• (c√≥ task_code)
            if (dataArray.length > 0) {
              const firstItem = dataArray[0];
              if (firstItem.task_code) {
                console.log('[Form4] Ph√°t hi·ªán d·ªØ li·ªáu thanh ph·ª•, s·ªë l∆∞·ª£ng:', dataArray.length);
                // Log m·ªôt v√†i items ƒë·∫ßu ƒë·ªÉ ki·ªÉm tra c·∫•u tr√∫c
                if (dataArray.length > 0) {
                  console.log('[Form4] M·∫´u d·ªØ li·ªáu ƒë·∫ßu ti√™n:', JSON.stringify(dataArray[0], null, 2));
                }
                // Parse v√† validate - ch·ªâ gi·ªØ l·∫°i nh·ªØng items c√≥ c·∫£ form_start v√† form_end h·ª£p l·ªá (kh√¥ng r·ªóng)
                const parsedSubBars = dataArray
                  .filter((subBar) => {
                    // Ch·ªâ x·ª≠ l√Ω nh·ªØng items c√≥ c·∫£ form_start v√† form_end kh√¥ng r·ªóng
                    const hasStart = subBar.form_start && String(subBar.form_start).trim() !== '';
                    const hasEnd = subBar.form_end && String(subBar.form_end).trim() !== '';
                    return hasStart && hasEnd;
                  })
                  .map((subBar) => {
                    const formStart = parseDateInput(subBar.form_start);
                    const formEnd = parseDateInput(subBar.form_end);
                    // ƒê·∫£m b·∫£o task_name ƒë∆∞·ª£c l∆∞u ƒë√∫ng, k·ªÉ c·∫£ khi l√† null/undefined
                    const taskName = (subBar.task_name !== null && subBar.task_name !== undefined) 
                      ? String(subBar.task_name).trim() 
                      : '';
                    console.log('[Form4] Parse item:', {
                      task_code: subBar.task_code,
                      task_name_raw: subBar.task_name,
                      task_name_parsed: taskName,
                      has_task_name: subBar.hasOwnProperty('task_name')
                    });
                    return {
                      task_code: subBar.task_code || '',
                      task_name: taskName,
                      form_start: formStart,
                      form_end: formEnd,
                    };
                  })
                  .filter((subBar) => {
                    const isValid = subBar.form_start && subBar.form_start.isValid && subBar.form_end && subBar.form_end.isValid;
                    if (!isValid) {
                      console.warn('[Form4] B·ªè qua thanh ph·ª• kh√¥ng h·ª£p l·ªá:', subBar.task_code);
                    }
                    return isValid;
                  });
                
                console.log('[Form4] ƒê√£ parse ƒë∆∞·ª£c', parsedSubBars.length, 'thanh ph·ª• h·ª£p l·ªá t·ª´', dataArray.length, 'items');
                return parsedSubBars;
              } else {
                console.log('[Form4] D·ªØ li·ªáu kh√¥ng ph·∫£i thanh ph·ª• (thi·∫øu task_code)');
              }
            } else {
              console.log('[Form4] Kh√¥ng t√¨m th·∫•y m·∫£ng d·ªØ li·ªáu trong response');
            }
            
            // N·∫øu kh√¥ng ph·∫£i d·ªØ li·ªáu thanh ph·ª•, tr·∫£ v·ªÅ m·∫£ng r·ªóng
            return [];
          } catch (error) {
            console.error('[Form4] L·ªói khi t·∫£i d·ªØ li·ªáu thanh ph·ª•:', error);
            return [];
          }
        }

        // H√†m helper ƒë·ªÉ set d·ªØ li·ªáu thanh ph·ª• t·ª´ b√™n ngo√†i
        function setSubBarsData(subBarsData) {
          try {
            if (!Array.isArray(subBarsData)) {
              console.error('D·ªØ li·ªáu thanh ph·ª• ph·∫£i l√† m·∫£ng');
              return;
            }
            
            subBars = subBarsData.map((subBar) => {
              const formStart = parseDateInput(subBar.form_start);
              const formEnd = parseDateInput(subBar.form_end);
              return {
                task_code: subBar.task_code || '',
                task_name: subBar.task_name || '',
                form_start: formStart,
                form_end: formEnd,
              };
            }).filter((subBar) => subBar.form_start && subBar.form_start.isValid && subBar.form_end && subBar.form_end.isValid);
            
            // Refresh view ƒë·ªÉ hi·ªÉn th·ªã thanh ph·ª•
            refreshView();
            
            console.log(`ƒê√£ set ${subBars.length} thanh ph·ª•`);
          } catch (error) {
            console.error('L·ªói khi set d·ªØ li·ªáu thanh ph·ª•:', error);
          }
        }
        
        // Expose h√†m setSubBarsData ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ console ho·∫∑c code kh√°c
        window.setForm4SubBars = setSubBarsData;

        async function loadData() {
          if (statusText) statusText.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
          try {
            const response = await fetch('https://iatzhxxuk.tino.page/webhook/Dashboard1form4');
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const apiData = await response.json();
            
            let flattenedData = [];
            let subBarsData = [];
            
            if (Array.isArray(apiData)) {
              apiData.forEach((item) => {
                // X·ª≠ l√Ω d·ªØ li·ªáu thanh ch√≠nh
                if (item.tasks && Array.isArray(item.tasks)) {
                  item.tasks.forEach((task) => {
                    flattenedData.push({
                      assignee: task.assignee || item.assignee,
                      task_code: task.task_code || '',
                      task_name: task.task_name || '',
                      start_time: task.start_time || '',
                      end_time: task.end_time || '',
                      points: task.work_points || task.points || 0,
                    });
                  });
                }
                // X·ª≠ l√Ω d·ªØ li·ªáu thanh ph·ª• (n·∫øu c√≥ trong response)
                if (item.subBars && Array.isArray(item.subBars)) {
                  subBarsData.push(...item.subBars);
                }
              });
            } else {
              flattenedData = Array.isArray(apiData) ? apiData : [];
              // Ki·ªÉm tra n·∫øu apiData c√≥ tr∆∞·ªùng subBars
              if (apiData.subBars && Array.isArray(apiData.subBars)) {
                subBarsData = apiData.subBars;
              }
            }
            
            // Parse d·ªØ li·ªáu thanh ph·ª• t·ª´ webhook ch√≠nh (n·∫øu c√≥)
            const subBarsFromMain = subBarsData.map((subBar) => {
              const formStart = parseDateInput(subBar.form_start);
              const formEnd = parseDateInput(subBar.form_end);
              return {
                task_code: subBar.task_code || '',
                task_name: subBar.task_name || '',
                form_start: formStart,
                form_end: formEnd,
              };
            }).filter((subBar) => subBar.form_start && subBar.form_start.isValid && subBar.form_end && subBar.form_end.isValid);
            
            rawData = flattenedData;
            
            // Load d·ªØ li·ªáu thanh ph·ª• t·ª´ webhook ri√™ng TR∆Ø·ªöC KHI render
            let subBarsFromWebhook = [];
            try {
              subBarsFromWebhook = await loadSubBars();
              console.log('[Form4] K·∫øt qu·∫£ loadSubBars:', subBarsFromWebhook);
            } catch (subBarError) {
              console.warn('[Form4] Kh√¥ng th·ªÉ load thanh ph·ª• t·ª´ webhook ri√™ng:', subBarError);
            }
            
            // Merge d·ªØ li·ªáu thanh ph·ª• t·ª´ c·∫£ hai ngu·ªìn
            subBars = [...subBarsFromMain, ...subBarsFromWebhook];
            console.log(`[Form4] T·ªïng h·ª£p thanh ph·ª•: ${subBarsFromMain.length} t·ª´ webhook ch√≠nh + ${subBarsFromWebhook.length} t·ª´ webhook ri√™ng = ${subBars.length} t·ªïng c·ªông`);
            
            if (statusText) statusText.textContent = `ƒê√£ t·∫£i ${flattenedData.length} t√°c v·ª•${subBars.length > 0 ? `, ${subBars.length} thanh ph·ª•` : ''}`;
            
            colorCache.clear();
            const { rows, segments: timeline } = createSimpleSchedule(rawData);
            scheduleRows = rows;
            segments = timeline;
            populateFilterOptions(rows);
            assigneeFilter.value = 'all';
            
            // G·ªçi refreshView() SAU KHI ƒë√£ c√≥ ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu (c·∫£ thanh ch√≠nh v√† thanh ph·ª•)
            refreshView();
          } catch (error) {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            if (statusText) statusText.textContent = `L·ªói: ${error.message}`;
          }
        }

        // Initialize
        if (typeof luxon === 'undefined') {
          console.error('Luxon is not loaded');
          if (statusText) statusText.textContent = 'L·ªói: Luxon ch∆∞a ƒë∆∞·ª£c t·∫£i.';
          return;
        }

        if (reloadButton) {
          reloadButton.addEventListener('click', loadData);
        }
        if (assigneeFilter) {
          assigneeFilter.addEventListener('change', refreshView);
        }
        if (closeDetailBtn) {
          closeDetailBtn.addEventListener('click', () => {
            detailSection.classList.add('hidden');
          });
        }

        // Expose initForm4 globally
        window.initForm4 = function() {
          loadData();
        };

        // Auto-load on first init
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          setTimeout(() => {
            const form4Section = document.getElementById('form4');
            if (form4Section && !form4Section.classList.contains('hidden')) {
              loadData();
            }
          }, 100);
        }
      })();
    </script>
      </div>
    </main>
    </div>
    <script>
      // ƒê·∫£m b·∫£o layout ƒë∆∞·ª£c √°p d·ª•ng ngay c·∫£ khi Tailwind ch∆∞a load
      (function() {
        // Ki·ªÉm tra v√† √°p d·ª•ng CSS fallback n·∫øu c·∫ßn
        function ensureLayout() {
          const container = document.querySelector('body > div.flex');
          if (container && container.classList.contains('h-screen')) {
            const computedStyle = window.getComputedStyle(container);
            if (computedStyle.display !== 'flex') {
              container.style.display = 'flex';
              container.style.height = '100vh';
              container.style.width = '100%';
              container.style.overflow = 'hidden';
            }
          }
          
          const sidebar = document.getElementById('sidebar-nav');
          if (sidebar) {
            const computedStyle = window.getComputedStyle(sidebar);
            if (computedStyle.display !== 'flex') {
              sidebar.style.display = 'flex';
              sidebar.style.height = '100%';
              sidebar.style.width = '16rem';
              sidebar.style.flexShrink = '0';
              sidebar.style.flexDirection = 'column';
              sidebar.style.justifyContent = 'space-between';
            }
          }
          
          const main = document.querySelector('main.flex-1');
          if (main) {
            const computedStyle = window.getComputedStyle(main);
            if (computedStyle.flex !== '1 1 0%') {
              main.style.flex = '1 1 0%';
              main.style.display = 'flex';
              main.style.flexDirection = 'column';
              main.style.overflowY = 'auto';
            }
          }
        }
        
        // Ch·∫°y ngay l·∫≠p t·ª©c
        ensureLayout();
        
        // Ch·∫°y l·∫°i sau khi DOM ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', ensureLayout);
        }
        
        // Ch·∫°y l·∫°i sau m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o
        setTimeout(ensureLayout, 100);
        setTimeout(ensureLayout, 500);
      })();
    </script>
  </body>
  </html>



